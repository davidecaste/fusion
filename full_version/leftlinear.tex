% !TeX root = ./fusione.tex

\chapter{Independence in rewriting}

In this chapter we discuss the notion of independence between two
consecutive rewriting steps, a fundamental ingredient of the rewriting
theory, which comes into play when viewing a sequence of steps as a
concurrent computation. We observe that moving from linear to
left-linear rules leads to the failure of various basic properties of
the classical notion of independence used in the linear setting and we
single out a framework in which these can be re-established, possibly
in a weakened form.

\section{Sequentially independent and switchable derivations }\label{subsec:switch}

Sequential independence is the canonical notion of independence in the DPO approach.

\begin{definition}[Sequential independence]
	\label{de:sequential-independence}
	Let $\X$ be an $\mathcal{M}$-adhesive category 
	and $(\X, \R)$ a left-linear rewriting system. 
	Let also
	$\der{D}=\{\dder{D}_i\}_{i=0}^1$ be a derivation of length $2$, with
	$\dder{D}_i$ using rule $\rho_i = (l_i,r_i)$.  We say that $\dder{D}_0$ and
	$\dder{D}_1$ are
	\emph{sequentially independent}
	if there is a pair of arrows
	$i_0\colon R_0\to D_1$ and $i_1\colon L_1\to D_0$ such that the
	following diagram commutes. In this case $(i_0,i_1)$ is called an  \emph{independence
		pair}.
	\[\xymatrix@R=20pt@C=20pt{L_0 \ar[d]_{m_0}&& K_0
		\ar[d]_{k_0}\ar@{>->}[ll]_{l_0} \ar[r]^{r_0} & R_0
		\ar@{.>}@/^.25cm/[drrr]|(.32)\hole_(.4){i_0}
		\ar[dr]|(.33)\hole_{h_0} && L_1 \ar@{.>}@/_.25cm/[dlll]^(.4){i_1}
		\ar[dl]|(.33)\hole^{m_1}& K_1 \ar[d]^{k_1}\ar@{>->}[l]_{l_1}
		\ar[rr]^{r_1} && R_1 \ar[d]^{h_1}\\G_0 && \ar@{>->}[ll]^{f_0}
		D_0 \ar[rr]_{g_0}&& G_1 && \ar@{>->}[ll]^{f_1} D_1
		\ar[rr]_{g_1}&& G_2}
	\]
\end{definition}

\begin{remark}\label{rem:seqabs}
Let $\{\phi_X\}_{X\in \Deltamin(\der{D})}$ be an abstraction equivalence between $\der{D}=\{\dder{D}_i\}_{i=0}^1$ and $\der{D}'=\{\dder{D}'_i\}_{i=0}^1$. If there is an independence pair between $(i_0, i_1)$ between $\dder{D}_0$ and $\dder{D}_1$, then $(\phi_{D_1}\circ i_0, \phi_{D_0}\circ i_1)$ is an independence pair between $\dder{D}'_0$ and $\dder{D}'_1$. Indeed we have
\[\begin{split}
g'_0\circ \phi_{D_0}\circ i_1&=\phi_{G_1}\circ g_0\circ i_1\\&=\phi_{G_1}\circ m_1\\&= m'_1
\end{split}\qquad \begin{split}
f'_1\circ \phi_{D_1}\circ i_0&=\phi_{G_1}\circ f_1\circ i_0\\&=\phi_{G_1}\circ h_0\\&= h'_1
\end{split}\]
\end{remark}

\begin{remark}\label{rem:uni}
	It is worth mentioning that if $(\X, \R)$ is a linear rewriting system then two derivations $\dder{D}_0$ and $\dder{D}_1$ can have at most one independence pair. Indeed if $(i_0,i_1)$ and $(i'_0, i'_1)$ are independence pairs, then
	\[g_0\circ i_1 = g_0\circ i'_1 \qquad f_1\circ i_0=f_1\circ i'_0\]
	But in linear systems $g_0$ and $f_1$ are both monos, entailing $i_0=i'_0$ and $i_1=i'_1$.
\end{remark}

Intuitively, the existence of the independence pair
captures the possibility of switching the application of the two rules:
$f_0 \circ i_1$ is a match for $\rho_1$ in $G_0$ and the
existence of $i_0 : R_0 \to D_1$ means that $\rho_1$ does not delete
items in the image of $K_0$, thus $\rho_0$ can be applied after
$\rho_1$. The following definition formalise what it means for a derivation to be the switch of another.

\begin{definition}[Pre-switch] \label{def:switch}
	Let $\X$ be an $\mathcal{M}$-adhesive category 
	and $(\X, \R)$ a left-linear rewriting system. 
	Let also
	$\der{D}=\{\dder{D}_i\}_{i=0}^1$ be a derivation made
	of two sequentially independent derivations $\dder{D}_0$,
	$\dder{D}_1$ with independence pair $(i_0, i_1)$, as in the following diagram. 
		\[\xymatrix@R=20pt@C=20pt{L_0 \ar[d]_{m_0}&& K_0
		\ar[d]_{k_0}\ar@{>->}[ll]_{l_0} \ar[r]^{r_0} & R_0
		\ar@{>}@/^.25cm/[drrr]|(.32)\hole_(.4){i_0}
		\ar[dr]|(.33)\hole_{h_0} && L_1 \ar@{>}@/_.25cm/[dlll]^(.4){i_1}
		\ar[dl]|(.33)\hole^{m_1}& K_1 \ar[d]^{k_1}\ar@{>->}[l]_{l_1}
		\ar[rr]^{r_1} && R_1 \ar[d]^{h_1}\\G_0 && \ar@{>->}[ll]^{f_0}
		D_0 \ar[rr]_{g_0}&& G_1 && \ar@{>->}[ll]^{f_1} D_1
		\ar[rr]_{g_1}&& G_2}
	\]
	
	
	A \emph{pre-switch} of $\der{D}$ along $(i_0,i_1)$ is
	a derivation $\der{E}=\{\dder{E}_i\}_{i=0}^1$, between the same objects and using the same rules
	in reverse order, as in the diagram on the right below
	\[
	\xymatrix@R=20pt@C=20pt{
		{L_1} \ar[d]_{m_0'}
		&&  {K_1} \ar@{>->}[ll]_{l_1} \ar[r]^{r_1} \ar[d]_{k_0'}
		&  {R_1} \ar[dr]|(.33)\hole_{h_0'}  \ar@/^.25cm/@{.>}_(.4){i_0'}|(.32)\hole[drrr]
		& & 
		{L_0}\ar[dl]|(.33)\hole^{m_1'} \ar@/_.25cm/@{.>}^(.4){i_1'}[dlll] 
		&  {K_0} \ar@{>->}[l]_{l_0} \ar[rr]^{r_0} \ar[d]^{k_1'}
		& & {R_0} \ar[d]^{h_1'} \\		
		{G_0}
		& & {D_0'} \ar@{>->}[ll]^{f_0'} \ar[rr]_{g_0'}
		& &  {G'_1} 
		& &  {D_1'} \ar@{>->}[ll]^{f_1'} \ar[rr]_{g_1'}
		& & {G_2}  }
	\]
	such that there is an independence pair $(i_0', i_1')$ between
	$\dder{E}_0$ and $\dder{E}_1$ and 
\[
	m_0=f_0' \circ i_1' \qquad 
	h_1=g_1' \circ i_0' 
		\qquad m_0'= f_0 \circ i_1
		\qquad h_1'= g_{1}\circ i_0\]
	

\end{definition}

\begin{example}	\label{ex:seq-ind}
	Consider the rewriting system  $(\cat{Graph}, \R)$ and the derivation $\der{D}$ introduced in \Cref{ex:1}.	Steps $\dder{D}_1$ and $\dder{D}_2$ are clearly sequential
	independent via the arrows $R_1 \to D_2$, $L_2 \to D_1$
	mapping nodes according to their numbering.
	
	A pre-switch of $\der{D}$ along such independence pair is the derivation
	$\der{E}$ depicted below. Instead,  the first two
	steps $\dder{D}_0$ and $\dder{D}_1$ are not sequential independent. Intuitively, this happens because $\rho_1$ uses the node generated by $\rho_0$ to produce a self-loop.
\begin{center}
	\begin{tikzpicture}[node distance=2mm, font=\small,  baseline=(current bounding box.center)]      
		\node (L1) at (0,2) {
			\begin{tikzpicture}
				% 
				\node at (0,0.53) {};
				\node at (0,0) [node, label=below:$1$] (1) {} ;
				% 
				\pgfBox
			\end{tikzpicture} 
		};
		\node [right=of L1] (K1) {
			\begin{tikzpicture}
				% 
				\node at (0,0.53) {}; 
				\node at (0,0) [node, label=below:$1$] (1) {};
				% 
				\pgfBox
			\end{tikzpicture} 
		};
		%     \node [above=of K1] {$\rho_0$};
		\node [above] at (K1.north) {$\rho_0$};
		\node [right=of K1](R1) {
			\begin{tikzpicture}
				\node at (0,0.53) {}; 
				\node at (0,0) [node, label=below:$1$] (1) {};
				\node at (.5,0) [node, label=below:$2$] (2) {}; 
				\draw[coloredge] (1) to[out=20, in=160] (2);
				% 
				\pgfBox
			\end{tikzpicture}
		};
		\path (K1) edge[->] node[trans, above] {} (L1);
		\path (K1) edge[->] node[trans, above] {} (R1);
		
		
		\node at (4,2) (L3) {
			\begin{tikzpicture}
				% 
				\node at (0,0.53) {}; 
				\node at (0,0) [node, label=below:$1$] (1) {} ;
				\node at (0.5,0) [node, label=below:$2$] (2) {} ;
				% 
				\pgfBox
			\end{tikzpicture} 
		};
		\node [right=of L3] (K3) {
			\begin{tikzpicture}
				% 
				\node at (0,0.53) {}; 
				\node at (0,0) [node, label=below:$1$] (1) {} ;
				\node at (0.5,0) [node, label=below:$2$] (2) {} ;
				% 
				\pgfBox
			\end{tikzpicture} 
		};
		%     \node [above=of K3] {$\rho_2$};
		\node [above] at (K3.north) {$\rho_2$};
		\node [right=of K3] (R3) {
			\begin{tikzpicture}
				\node at (0,0.53) {}; 
				\node at (0,0) [node, label=below:$12$] (12) {};
				% 
				\pgfBox
			\end{tikzpicture}
		};
		\path (K3) edge[->] node[trans, above] {} (L3);
		\path (K3) edge[->] node[trans, above] {} (R3);
		
		\node at (8,2) (L2) {
			\begin{tikzpicture}
				% 
				\node at (0,0.53) {}; 
				\node at (0,0) [node, label=below:$2$] (1) {} ;
				% 
				\pgfBox
			\end{tikzpicture} 
		};
		\node [right=of L2] (K2) {
			\begin{tikzpicture}
				% 
				\node at (0,0.53) {}; 
				\node at (0,0) [node, label=below:$2$] (1) {};
				% 
				\pgfBox
			\end{tikzpicture} 
		};
		%     \node [above=of K2] {$\rho_1$};
		\node [above] at (K2.north) {$\rho_1$};
		
		\node [right=of K2] (R2) {
			\begin{tikzpicture}
				\node at (0,0) [node, label=below:$2$] (1) {}
				edge [in=55, out=85, loop] ();
				% 
				\pgfBox
			\end{tikzpicture}
		};
		\path (K2) edge[->] node[trans, above] {} (L2);
		\path (K2) edge[->] node[trans, above] {} (R2);
		
		
		%%%%%% second row
		\node at (0,0) (G1) {
			\begin{tikzpicture}
				% 
				\node at (0,0.53) {};
				\node at (0,0) [node, label=below:$1$] (1) {} ;
				% 
				\pgfBox
			\end{tikzpicture} 
		};
		\node [right=of G1] (D1) {
			\begin{tikzpicture}
				% 
				\node at (0,0.53) {}; 
				\node at (0,0) [node, label=below:$1$] (1) {};
				% 
				\pgfBox
			\end{tikzpicture} 
		};
		\node at (3,0) (G2) {
			\begin{tikzpicture}
				% 
				\node at (0,0.53) {}; 
				\node at (0,0) [node, label=below:$1$] (1) {} ;
				\node at (0.5,0) [node, label=below:$2$] (2) {} ;
				\draw[coloredge] (1) to[out=20, in=160] (2);
				% 
				\pgfBox
			\end{tikzpicture} 
		};
		\path (D1) edge[->] node[trans, above] {} (G1);
		\path (D1) edge[->] node[trans, above] {} (G2);
		\path (L1) edge[->] node[trans, above] {} (G1);
		\path (K1) edge[->] node[trans, above] {} (D1);
		\path (R1) edge[->] node[trans, above] {} (G2);
		
		\node at (5.5,0) (D2) {
			\begin{tikzpicture}
				% 
				\node at (0,0.53) {};
				\node at (0,0) [node, label=below:$1$] (1) {} ;
				\node at (0.5,0) [node, label=below:$2$] (2) {} ;
				\draw[coloredge] (1) to[out=20, in=160] (2);
				% 
				\pgfBox
			\end{tikzpicture} 
		};
		\node at (7.4,0) (G3) {
			\begin{tikzpicture}
				% 
				\node at (0,0.53) {}; 
				\node at (0,0) [node, label=below:$12$] (12) {}
				edge [in=125, out=155, colorloop] ();
				% 
				\pgfBox
			\end{tikzpicture} 
		};
		
		\path (D2) edge[->] node[trans, above] {} (G2);
		\path (D2) edge[->] node[trans, above] {} (G3);
		\path (L3) edge[->] node[trans, above] {} (G2);
		\path (K3) edge[->] node[trans, above] {} (D2);
		\path (R3) edge[->] node[trans, above] {} (G3);
		
		\node at (9.1,0) (D3) {
			\begin{tikzpicture}
				% 
				\node at (0,0.53) {}; 
				\node at (0,0) [node, label=below:$12$] (12) {}
				edge [in=125, out=155, colorloop] ();
				% 
				\pgfBox
			\end{tikzpicture} 
		};
		\node [right=of D3] (G4) {
			\begin{tikzpicture}
				% 
				\node at (0,0) [node, label=below:$12$] (12) {}
				edge [in=55, out=85, loop] ()
				edge [in=125, out=155, colorloop] ();
				% 
				\pgfBox
			\end{tikzpicture} 
		};
		
		\node[font=\scriptsize, below] at (G1.south) {$G_0$};
		\node[font=\scriptsize, below] at (D1.south) {$D_0$};      
		\node[font=\scriptsize, below] at (G2.south) {$G_1$};
		\node[font=\scriptsize, below] at (D2.south) {$D_1'$};      
		\node[font=\scriptsize, below] at (G3.south) {$G_2'$};
		\node[font=\scriptsize, below] at (D3.south) {$D_2'$};      
		\node[font=\scriptsize, below] at (G4.south) {$G_3$};      
		
		\path (D3) edge[->] node[trans, above] {} (G3);
		\path (D3) edge[->] node[trans, above] {} (G4);
		\path (L2) edge[->] node[trans, above] {} (G3);
		\path (K2) edge[->] node[trans, above] {} (D3);
		\path (R2) edge[->] node[trans, above] {} (G4);
	\end{tikzpicture}
	%
\end{center}
	\end{example}

\begin{remark}\label{rem:switch}

Let $\der{E}=\{\dder{E}_i\}_{i=0}^1$ be a pre-switch for $\dder{D}_0$
and $\dder{D}_1$ along an independence pair $(i_0, i_1)$, then by definition we have an independence pair $(i'_0, i'_1)$ between $\dder{E}_0$ and $\dder{E}_1$ such that
\[
m_0=f_0' \circ i_1'
\quad h_1=g_1' \circ i_0'
\quad m_0'= f_0 \circ i_1
\quad h_1'= g_{1}\circ i_0\]

 The derivation $\der{D}$ uses the same rule of $\der{E}$ in reverse order, thus it is a switch for $\der{E}$ along $(i_0', i_1')$.   Moreover, the same argument shows that if $(\der{E}, \alpha, \omega)$ is a decorated switch for $(\der{D}, \alpha, \omega)$ along $(i_0, i_1)$, then the latter is a decorated switch for the former along $(i'_0, i'_1)$.
\end{remark}

We start by examining how pre-switches interact with abstraction equivalence. A first property that we can establish in that direction is uniqueness of pre-switches up to abstraction equivalence.

\begin{lemma}[Uniqueness of pre-switches]
	\label{thm:switch_uni}
	Let $\der{D}=\{\dder{D}_{i}\}_{i=0}^1$ be a derivation and suppose
	that both $\der{E}=\{\dder{E}_i\}_{i=0}^1$ and
	$\der{F}=\{\dder{F}_i\}_{i=0}^1$ are pre-switches of $\dder{D}_0$ and
	$\dder{D}_1$ along the same independence pair $(i_0, i_1)$. Then there is a unique abstraction equivalence $\{\phi_X\}_{X\in \Deltamin(\der{E})}$ between $\der{E}$ and $\der{F}$, whose first component is $\id{G_0}$. Moreover, 
	\[\phi_{D_{\der{E}, 0}}\circ j_1=a_1 \qquad \phi_{D_{\der{E}, 1}}\circ j_0=a_0\]
\end{lemma}

\begin{proof}
	By definition of pre-switch $\der{E}_0$ and $\der{F}_0$ have the same match $f_0\circ i_1$ and that $\der{E}_1$ and $\der{F}_1$ have the same comatch $g_1\circ i_0$. Thus we get the solid part of the diagram below. If we are able to construct the dotted arrow and prove that they are isomorphism we are done.
	\[\xymatrix@C=22pt{G_{0} && \ar@{>->}[ll]_{f_{\der{F},0}} D_{\der{F},0} \ar[rr]^{g_{\der{F},0}}&& G_{\der{F},1} && \ar@{>->}[ll]_{f_{\der{F},1}} D_{\der{F},1} \ar[rr]^{g_{\der{F},1}}&& G_{2}\\L_1 \ar[d]^{f_0\circ i_1} \ar[u]_{f_0\circ i_1}&& K_{1} \ar[d]^{k_{\der{E},0}} \ar[u]_{k_{\der{F},0}}\ar@{>->}[ll]_{l_1} \ar[r]^{r_1} & R_{1} \ar@/^.35cm/[drrr]|(.315)\hole_(.4){j_0} \ar[dr]|(.3)\hole_{h_{\der{E},0}} \ar@/_.35cm/[urrr]|(.315)\hole^(.4){a_0} \ar[ur]|(.3)\hole^{h_{\der{F},0}}& &L_{0} \ar@/_.35cm/[dlll]^(.4){j_1} \ar[dl]|(.3)\hole^{m_{\der{E},1}} \ar@/^.35cm/[ulll]_(.4){a_1} \ar[ul]|(.3)\hole_{m_{\der{F},1}}& K_{0} \ar[d]_{k_{\der{E},1}} \ar[u]^{k_{\der{F},1}}\ar@{>->}[l]_{l_{0}} \ar[rr]^{r_0} && R_{0} \ar[d]_{g_1\circ i_0} \ar[u]^{g_1\circ i_0}\\ \ar@/^.5cm/[uu]^{\id{G_0}} G_{0} && \ar[ll]^{f_{\der{E},0}} D_{\der{E},0} \ar@{.>}@/^.5cm/[uu]^(.33){\phi_{0}}|\hole \ar[rr]_{g_{\der{E},0}}&& G_{\der{E},1} \ar@{.>}[uu]^(.76){\psi_1}|(.45)\hole |(.55)\hole&& \ar@{>->}[ll]^{f_{\der{E},1}} D_{\der{E},1} \ar@{.>}@/_.5cm/[uu]_(.33){\phi_{1}}|\hole\ar[rr]_{g_{\der{E},1}}&& G_{2}\ar@{.>}@/_.5cm/[uu]_{\psi_2}}\]
	
	Now, by \Cref{prop:unique} we know that there are two unique isomorphisms $\phi_0\colon D_{\der{E},0}\to D_{\der{F},0}$ and $\psi_1 \colon G_{\der{E},1}\to G_{\der{F},1}$ such that the diagram below commutes.
	\[\xymatrix{G_{0} & \ar@{>->}[l]_{f_{\der{F},0}} D_{\der{F},0} \ar[r]^{g_{\der{F},0}}& G_{\der{F},1} \\L_1 \ar[d]^{f_0\circ i_1} \ar[u]_{f_0\circ i_1}& K_{1} \ar[d]^{k_{\der{E},0}} \ar[u]_{k_{\der{F},0}}\ar[l]_{l_1} \ar[r]^{r_1} & R_{1}  \ar[d]_{h_{\der{E},0}}  \ar[u]^{h_{\der{F},0}}\\ \ar@/^.5cm/[uu]^{\id{G_0}} G_{0} & \ar@{>->}[l]^{f_{\der{E},0}} D_{\der{E},0} \ar@/^.5cm/[uu]^(.33){\phi_{0}}|\hole \ar[r]_{g_{\der{E},0}}& G_{\der{E},1} \ar@/_.5cm/[uu]_{\psi_1}}\]
	
	But then we have
	\begin{align*}
		f_{\der{F},0}\circ \phi_0\circ j_1&=f_{\der{E},0} \circ j_1\\&=m_0\\&=f_{\der{F},0}\circ a_1 \end{align*}
	which, since $f_{\der{D},0}$ is mono, entails $a_1= \phi_0\circ j_1$.	This equality, in turn, gives us that
	\begin{align*}
		\psi_1\circ m_{\der{E},1}&=\psi_1 \circ g_{\der{E},0}\circ j_1\\&=g_{\der{F},0}\circ \phi_0\circ j_1\\&=g_{\der{F},0}\circ a_1\\&=m_{\der{F},1}
	\end{align*}
	
	Since $\psi_1$ is an isomorphism, the square below is a pushout. 
	\[\xymatrix@C=35pt{K_0 \ar[d]_{k_{\der{E},1}} \ar@{>->}[r]^{l_0}& L_0 \ar[d]^{\psi_1\circ m_{\der{E},1}}\\D_{\der{E},1} \ar@{>->}[r]_{\psi_1\circ f_{\der{E},1}}& G_{\der{F}, 1}}\]
	
	Moreover, we have already shown that $\psi_1\circ m_{\der{E},1}=m_{\der{F},1}$. Thus, again by \Cref{prop:unique} there are the dotted isomorphisms $\phi_1\colon D_{\der{E},1}\to D_{\der{F},1}$ and $\psi_2\colon G_2\to G_2$ in the diagram below and such arrows are unique.
	\[\xymatrix{G_{\der{F},1} & \ar@{>->}[l]_{f_{\der{F},1}} D_{\der{F},1} \ar[r]^{g_{\der{F},1}}& G_2 \\L_0 \ar[d]^{m_{\der{E},1}} \ar[u]_{m_{\der{F},1}}& K_{0} \ar[d]^{k_{\der{E},1}} \ar[u]_{k_{\der{F},1}}\ar@{>->}[l]_{l_1} \ar[r]^{r_1} & R_{0}  \ar[d]_{g_1\circ i_0}  \ar[u]^{g_1\circ i_0}\\ \ar@/^.5cm/[uu]^{\psi_1} G_{\der{E},1} & \ar@{>->}[l]^{f_{\der{E},1}} D_{\der{E},1} \ar@{.>}@/^.5cm/[uu]^(.33){\phi_{1}}|\hole \ar[r]_{g_{\der{E},1}}& G_2 \ar@{.>}@/_.5cm/[uu]_{\psi_2}}\]
	
	To conclude, it is now enough to notice that
	\begin{align*}
		f_{\der{F},1} \circ \phi_1\circ j_0&=\psi_1\circ f_{\der{E},1}\circ j_0\\&=\psi_1\circ h_{\der{E,0}}\\&=h_{\der{F},0}\\&=f_{\der{F},1}\circ a_0
	\end{align*}
	allowing us to deduce $ \phi_1\circ j_0=a_0$.
\end{proof}


\begin{example}\label{ex:abs}
	Let $\X$ be the category of $\Set$ and, besides the terminal obect $1$, take the sets
	\[2=\{0,1\} \qquad 3=\{0,1,2\} \qquad 4=\{0,1,2,3\}\]
	
Let us consider the DPO-rewriting system given by the (linear) rules below.
		\[\xymatrix{1 & 1\ar@{>->}[l]_{\id{1}} \ar@{>->}[r]^{\id{1}} & 1 & 1 & 1\ar@{>->}[r]^{\delta^2_0} \ar@{>->}[l]_{\id{1}} & 2}\]

We then have the derivation $\der{D}$ below, composed by two sequentially independent steps.
		\[\xymatrix@R=20pt@C=20pt{1 \ar@{>->}[d]_{\delta^3_0}&& 1
	\ar@{>->}[d]_{\delta^3_0}\ar@{>->}[ll]_{\id{1}} \ar@{>->}[r]^{\id{1}} & 1
	\ar@{>->}@/^.25cm/[drrr]|(.32)\hole_(.4){\delta^3_0}
	\ar[dr]|(.33)\hole_{\delta^3_0} && 1 \ar@{>->}@/_.25cm/[dlll]^(.4){\delta^3_0}
	\ar@{>->}[dl]|(.33)\hole^{\delta^3_0}& 1 \ar@{>->}[d]^{\delta^3_0}\ar@{>->}[l]_{\id{1}}
	\ar@{>->}[rr]^{\delta^2_0} && 2 \ar@{>->}[d]^{i_2}\\3 && \ar@{>->}[ll]^{\id{3}}
	3 \ar@{>->}[rr]_{\id{3}}&& 3 && \ar@{>->}[ll]^{\id{3}} 3
	\ar@{>->}[rr]_{i_3}&& 4}
\]
where $i_3\colon 3\mto 4$ is the obvious inclusion, while $i_2\colon 2\mto 4$ sends $0$ to $0$ and $1$ to $3$.	 Now, we can construct two pre-switches for $\dder{D}_0$ and $\dder{D}_1$ along $(\delta_0, \delta_0)$. Indeed, on the one hand we can consider  $\der{E}:=\{\dder{E}_i\}_{i=0}^1$ as
		\[\xymatrix@R=20pt@C=20pt{1 \ar@{>->}[d]_{\delta^3_0}&& 1
	\ar@{>->}[d]_{\delta^3_0}\ar@{>->}[ll]_{\id{1}} \ar@{>->}[r]^{\delta^2_0} & 2
	\ar@{>->}@/^.25cm/[drrr]|(.32)\hole_(.4){i_2}
	\ar[dr]|(.33)\hole_{i_2} && 1 \ar@{>->}@/_.25cm/[dlll]^(.4){\delta^3_0}
	\ar@{>->}[dl]|(.33)\hole^{\delta^4_0}& 1 \ar@{>->}[d]^{\delta^4_0}\ar@{>->}[l]_{\id{1}}
	\ar@{>->}[rr]^{\id{1}} && 1 \ar@{>->}[d]^{\delta^4_0}\\3 && \ar@{>->}[ll]^{\id{3}}
	3 \ar@{>->}[rr]_{i_{3}}&& 4 && \ar@{>->}[ll]^{\id{4}} 4
	\ar@{>->}[rr]_{\id{4}}&& 4}
\]
and we have
\[
\delta^3_0=\id{3} \circ \delta^3_0
\qquad i_2=\id{4} \circ i_2
\qquad \delta^3_0= \id{3} \circ \delta^3_0
\qquad \delta^4_0= i_3\circ \delta^3_0\]

On the other hand, there is an isomorphism $t\colon 4\mto 4$ be the isomorphism which swap $1$ with $2$ and fix the other elements of $4$. Then we can also construct $\der{F}:=\{\dder{F}_i\}_{i=0}^1$ as below:
		\[\xymatrix@R=20pt@C=20pt{1 \ar@{>->}[d]_{\delta^3_0}&& 1
		\ar@{>->}[d]_{\delta^3_0}\ar@{>->}[ll]_{\id{1}} \ar@{>->}[r]^{\delta^2_0} & 2
		\ar@{>->}@/^.25cm/[drrr]|(.32)\hole_(.4){i_2}
		\ar[dr]|(.33)\hole_{i_2} && 1 \ar@{>->}@/_.25cm/[dlll]^(.4){\delta^3_0}
		\ar@{>->}[dl]|(.33)\hole^{\delta^4_0}& 1 \ar@{>->}[d]^{\delta^4_0}\ar@{>->}[l]_{\id{1}}
		\ar@{>->}[rr]^{\id{1}} && 1 \ar@{>->}[d]^{\delta^4_0}\\3 && \ar@{>->}[ll]^{\id{3}}
		3 \ar@{>->}[rr]_{i_{3}}&& 4 && \ar@{>->}[ll]^{\id{4}} 4
		\ar@{>->}[rr]_{t}&& 4}
	\]
	and also in this case we get a pre-switch since
	\[
	\delta^3_0=\id{3} \circ \delta^3_0
	\qquad i_2=t\circ i_2
	\qquad \delta^3_0= \id{3} \circ \delta^3_0
	\qquad \delta^4_0= i_3\circ \delta^3_0\]
	
	Now, by \Cref{thm:switch_uni} we get an abstraction equivalence fitting in the diagram below.
	\[\xymatrix@C=30pt@R=25pt{3 && \ar@{>->}[ll]_{\id{3}} 3 \ar@{>->}[rr]^{i_3}&& 4 && \ar@{>->}[ll]_{\id{4}} 4 \ar@{>->}[rr]^{\id{4}}&& 4\\1 \ar@{>->}[d]^{\delta^3_0} \ar@{>->}[u]_{\delta^3_0}&& 1 \ar@{>->}[d]^{\delta^3_0} \ar@{>->}[u]_{\delta^3_0}\ar@{>->}[ll]_{\id{1}} \ar@{>->}[r]^{\delta^2_0} & 2 \ar@{>->}@/^.35cm/[drrr]|(.315)\hole_(.4){i_2} \ar@{>->}[dr]|(.3)\hole_{i_2} \ar@{>->}@/_.35cm/[urrr]|(.315)\hole^(.4){i_2} \ar@{>->}[ur]|(.3)\hole^{i_2}& &1 \ar@{>->}@/_.35cm/[dlll]^(.4){\delta^3_0} \ar@{>->}[dl]|(.3)\hole^{\delta^4_0} \ar@{>->}@/^.35cm/[ulll]_(.4){\delta^3_0} \ar@{>->}[ul]|(.3)\hole_{\delta^4_0}& 1 \ar@{>->}[d]_{\delta^4_0} \ar@{>->}[u]^{\delta^4_0}\ar@{>->}[l]_{\id{1}} \ar@{>->}[rr]^{\id{1}} && 1 \ar@{>->}[d]_{\delta^4_0} \ar@{>->}[u]^{\delta^4_0}\\ \ar@/^.5cm/[uu]^{\id{3}} 3 && \ar[ll]^{\id{3}} 3 \ar@{>}@/^.5cm/[uu]^(.33){\phi_0}|\hole \ar[rr]_{i_3}&& 4 \ar@{>}[uu]_(.76){\psi_1}|(.45)\hole |(.55)\hole&& \ar@{>->}[ll]^{\id{4}} 4 \ar@{>}@/_.5cm/[uu]_(.33){\phi_1}|\hole\ar[rr]_{t}&& 4\ar@{>}@/_.5cm/[uu]_{\psi_2}}\]
	But then there is only one component of this abstraction equivalence different from the identity, namely the last one, which must coincide with $t$.
\end{example}


Another useful facts that we can establish is that being a pre-switch is invariant under abstraction equivalence, as made precise by the following lemma.

\begin{lemma}\label{lem:abs}
	Let $\der{D}=\{\dder{D}_i\}_{i=0}^1$ be the following derivation:
	
	\[\xymatrix@R=20pt@C=20pt{L_0 \ar[d]_{m_0}&& K_0
		\ar[d]_{k_0}\ar@{>->}[ll]_{l_0} \ar[r]^{r_0} & R_0
		\ar@{>}@/^.25cm/[drrr]|(.32)\hole_(.4){i_0}
		\ar[dr]|(.33)\hole_{h_0} && L_1 \ar@{>}@/_.25cm/[dlll]^(.4){i_1}
		\ar[dl]|(.33)\hole^{m_1}& K_1 \ar[d]^{k_1}\ar@{>->}[l]_{l_1}
		\ar[rr]^{r_1} && R_1 \ar[d]^{h_1}\\G_0 && \ar@{>->}[ll]^{f_0}
		D_0 \ar[rr]_{g_0}&& G_1 && \ar@{>->}[ll]^{f_1} D_1
		\ar[rr]_{g_1}&& G_2}
	\]
	and suppose that the derivation $\der{E}$ below is a pre-switch for $\der{D}$ along $(i_0,i_1)$.
	\[
	\xymatrix@R=20pt@C=20pt{
		{L_1} \ar[d]_{m_0'}
		&&  {K_1} \ar@{>->}[ll]_{l_1} \ar[r]^{r_1} \ar[d]_{k_0'}
		&  {R_1} \ar[dr]|(.33)\hole_{h_0'}  \ar@/^.25cm/@{>}_(.4){i_0'}|(.32)\hole[drrr]
		& & 
		{L_0}\ar[dl]|(.33)\hole^{m_1'} \ar@/_.25cm/@{>}^(.4){i_1'}[dlll] 
		&  {K_0} \ar@{>->}[l]_{l_0} \ar[rr]^{r_0} \ar[d]^{k_1'}
		& & {R_0} \ar[d]^{h_1'} \\		
		{G_0}
		& & {D_0'} \ar@{>->}[ll]^{f_0'} \ar[rr]_{g_0'}
		& &  {G'_1} 
		& &  {D_1'} \ar@{>->}[ll]^{f_1'} \ar[rr]_{g_1'}
		& & {G_2}  }
	\]
	
	Then the following hold true:
	\begin{enumerate}
		\item if $\{\phi_X\}_{X\in \Deltamin(\der{D})}$ is an abstraction equivalence between $\der{D}$ and another derivation $\der{F}=\{\dder{F}_i\}_{i=0}^1$, then $\phi^{-1}_{G_0}*\der{E}*\phi_{G_2}$ is a pre-switch for $\der{F}$ along $(\phi_{D_1}\circ i_0, \phi_{D_0}\circ i_1 )$;
		\item if $\{\psi_X\}_{X\in \Deltamin(\der{E})}$ is an abstraction equivalence between $\der{E}$ and $\der{G}=\{\dder{G}_{i}\}_{i=0}^1$, then $\psi_{G_0}*\der{G}*\psi^{-1}_{G_2}$ is a pre-switch for $\der{D}$ along $(i_0, i_1)$.
	\end{enumerate}
	\begin{remark}Recall that, by \Cref{rem:seqabs}, $(\phi_{D_1}\circ i_0, \phi_{D_0}\circ i_1 )$ is an independence pair between $\dder{F}_0$ and $\dder{F}_1$.
	\end{remark}
\end{lemma}
\begin{proof}\begin{enumerate}
		\item To prove this, it is enough to compute:
		\[\begin{split}
			m_{\der{F},0}=&\phi_{G_0}\circ m_0\\=&\phi_{G_0}\circ f'_0\circ i'_1\\\phi_{G_0}\circ	m'_0=&\phi_{G_0}\circ f_0\circ i_1\\=&f_{\der{F},0}\circ \phi_{D_{0}}\circ i_1
		\end{split} \quad \begin{split}
	h_{\der{F},1}=&\phi_{G_2}\circ h_1\\=&\phi_{G_2}\circ g_1' \circ i_0' \\	\phi_{G_2}\circ h'_1=&\phi_{G_2}\circ g_1\circ i_0\\=&g_{\der{F}, 1}\circ \phi_{D_1}\circ i_0\end{split} 
	\]
		
		
		\item
		
		And we can conclude. \qedhere 
	\end{enumerate}
\end{proof}


Given two sequentially independent direct derivations, it is not necessarily true that a pre-switch for them exists, as shown by the following example. 

\begin{example}\label{ex:diff1}
	Consider the poset $(P, \sqsubseteq)$ depicted below, where
	$P = \mathbb{N} \cup \{a,b,c\}$ and $\sqsubseteq$ is defined by
	$m \sqsubseteq n$ if $m \geq n$, $a \sqsubseteq x$ for all $x \in P$
	and $b, c \sqsubseteq n$ for all $n \in \mathbb{N}$.
	\[\xymatrix@C=16pt@R=1pt{
		& 0 \ar@{-}[dd] \ar@{-}[ddddddl] \ar@{-}[ddddddr] &  \\
		&  & \\
		& 1 \ar@{-}[dd] \ar@{-}[ddddl]  \ar@{-}[ddddr]   &  \\
		&  & \\
		& 2 \ar@{.}[d] \ar@{-}[ddl]   \ar@{-}[ddr]     &  \\
		&  \ar@{.}[dl]   \ar@{.}[dr] & \\
		b \ar@{-}[dr] & & c \ar@{-}[dl]\\
		& a} \]
		
	Let $\X$ be the  
	category associated with this order, which by \Cref{rem:iso} is
	$\mathsf{I(\X)}$-adhesive. Consider a rewriting
	system whose set of rules contains the following 
	\[\xymatrix{a & a \ar[r]^{\sqsubseteq} \ar@{>->}[l]_{\id{a}} & 0 & a & a
		\ar[r]^{\sqsubseteq} \ar@{>->}[l]_{\id{a}} & b }\]
	We can then consider the  following derivation
	$\der{D}=\{\dder{D}_i\}_{i=0}^1$.
	 \[
   \xymatrix@C=25pt{a \ar[d]_{(a,c)}&& \ar@{>->}[d]_{k_0}\ar[ll]_{\id{a}}
		    \ar[r]^{(a,0)} & 0 \ar@/^.35cm/[drrr]|(.315)\hole_(.45){\id{0}}
		    \ar[dr]|(.3)\hole_{\id{0}} && a \ar@/_.35cm/[dlll]^(.45){\hspace{5pt}(a,c)}
		     \ar[dl]|(.3)\hole^{(a,0)}& a \ar[d]^{(a,0)}\ar@{>->}[l]_{\id{a}}
		     \ar[rr]^{(a,b)} && b \ar[d]^{(b,0)}\\c &&
		     \ar@{>->}[ll]^{\id{c}} c \ar[rr]_{(c,0)}&& 0 &&
		     \ar@{>->}[ll]^{\id{0}} 0 \ar[rr]_{\id{0}}&& 0}\]

	Note that the two direct derivations are sequential
	independent. However there is no pre-switch since the rule applied by
	$\dder{D}_1$ cannot be applied to $c$. In fact, there is a unique morphism
	$a\to c$, yielding the diagram
	\[	\xymatrix{a \ar[d]_{(a,c)}& a
		\ar[d]^{(a,c)}\ar@{>->}[l]_{\id{a}} \ar[r]^{(a,b)}& b \\c & c
		\ar@{>->}[l]^{\id{c}}
	}\]
	
	Since $b$ and $c$ do not have a supremum in the poset underlying $\X$, the arrows
	$a\to b$ and $a\to c$ do not have a pushout. Hence we do not get a direct derivation from $c$.
\end{example}

Before proceeding further we need to prove some other properties of independence pairs.

\begin{proposition}
	\label{prop:tec}
	Let $(\X,\R)$ be a left-linear rewriting system and
	$(i_0, i_1)$ an independence pair between two direct
	derivations $\dder{D}_0$ and $\dder{D}_1$. Consider the pullback of
	$f_1\colon D_1\mto G_1$ along $g_0\colon D_0\to G_1$ (first
	square below), then there exist the arrows
	$u_1\colon K_1\to P$ and $u_0\colon K_0\to P$ fitting in the
	central and right square. Moreover, the right square is a pullback.
	\[\xymatrix{P \ar@{>->}[r]^{p_0} \ar[d]_{p_1} & D_0
		\ar[d]^{g_0}& K_0 \ar[r]^{r_0} \ar@{.>}[d]_{u_0}& R_0
		\ar[d]^{i_0} & K_1 \ar@{>->}[r]^{l_1} \ar@{.>}[d]_{u_1}&
		L_1 \ar[d]^{i_1}\\ D_1 \ar@{>->}[r]_{f_1} &G_1 &P
		\ar[r]_{p_1} & D_1 &P \ar[r]_{p_0} & D_0}
	\]
\end{proposition}

\begin{proof}
	We start noticing that
	\[\begin{split}
		f_1\circ i_0\circ r_0&=h_0\circ r_0\\&=g_0\circ k_0	\end{split}
	\qquad\begin{split}
		g_0\circ i_1\circ l_1&=m_1\circ l_1\\&= f_1 \circ k_1
	\end{split}
	\]
	Thus there exists the dotted $u_0\colon K_0\to P$,
	$u_1\colon K_1\to P$ in the diagram
	\[\xymatrix{K_0 \ar[d]_{r_0}
		\ar@{.>}[r]_{u_0}\ar@/^.4cm/[rr]^{k_0} &P
		\ar@{>->}[r]_{p_0} \ar[d]_{p_1}& D_0 \ar[d]^{g_0}&K_1
		\ar@{>->}[d]_{l_1}
		\ar@{.>}[r]_{u_1}\ar@/^.4cm/[rr]^{k_1} &P \ar[r]_{p_1}
		\ar@{>->}[d]_{p_0}& D_1 \ar@{>->}[d]^{f_1}\\R_0
		\ar@/_.4cm/[rr]_{h_0}\ar[r]^{i_0}& D_1
		\ar@{>->}[r]^{f_1}& G_1&L_1
		\ar@/_.4cm/[rr]_{m_1}\ar[r]^{i_1}& D_0 \ar[r]^{g_0}&
		G_1}\]		
		
The outer diagram given by the second rectangle is an $\mathcal{M}$-pushout, thus we can deduce from \Cref{prop:pbpoad} and \Cref{lem:pb1} that its left half is a pullback.
\end{proof}

\begin{corollary}\label{lem:cose}Let
	$\der{D}=\{\dder{D}_i\}_{i=0}^1$ be a derivation and suppose
	that $(i_0, i_1)$ is an independence pair between $\dder{D}_0$
	and $\der{D}_1$.  If $\der{E}=\{\dder{E}_i\}_{i=0}^1$ is a
	pre-switch of $\der{D}$ along $(i_0, i_1)$, then there is an arrow
	$z_0\colon P\to D_{\der{E},0}$ in $\mathcal{M}$ fitting in the square below.
	\[\xymatrix{P \ar@{.>}[r]^-{z_0}  \ar@{>->}[d]_{p_0}& D_{\der{E}, 0} \ar@{>->}[d]^{f_{\der{E},0}} \\ D_0 \ar@{>->}[r]_{f_0} & G_0 }\]
\end{corollary}
\begin{proof}
	Consider the arrow $u_1\colon K_1\to P$ obtained using
	\Cref{prop:tec}. It fits in the big square on the left
	\[		\xymatrix{K_1 \ar[r]^{u_1} \ar@{>->}[d]_{l_1}&P
		\ar[r]^{\id{P}}\ar@{>->}[d]_{p_0}& P\ar@{>->}[d]^{p_0}\\L_1
		\ar[d]_{\id{L_1}}\ar[r]^{i_1}&D_0 \ar[r]^{\id{D_0}}
		\ar[d]_{\id{D_0}}& D_{0} \ar@{>->}[d]^{f_0}&K_1 \ar@{>->}[d]_{l_1}\ar[r]^{k_{\der{E},0}}&
		D_{\der{E},0} \ar@{>->}[d]^{f_{\der{E},0}} & K_1 \ar[r]^{u_1}
		\ar@{>->}[d]_{l_1}& P \ar@{>->}[d]^{f_0\circ
			p_0}\\
		L_1\ar[r]^{i_1} \ar@/_.4cm/[rr]_{m_{\der{E},0}}&D_0
		\ar@{>->}[r]^{f_0}&G_0 & L_1\ar[r]_{m_{\der{E},0}}&G_0 &L_1
		\ar[r]_{m_{\der{E},0}}&G_0}\]
	
	Since $f_0$ is a monomorphism, all the inner squares of the left diagram are pullbacks, thus the whole big square is a pullback too.
	Now the thesis follows applying \Cref{lem:radj} to the pair of squares on the right.
	\end{proof}
	

\begin{example}\label{ex:abs2}
Let $\der{D}$ be the derivation of \Cref{ex:abs} and consider the pre-switch $\der{F}$. Then we can build the diagram belo
	\[\xymatrix@C=20pt@R=20pt{&&1 \ar@{>->}@/_.9cm/[ddrr]_(.2){\delta^3_0}|(.72)\hole
	\ar@{>->}[dr]^{\delta^3_0}&& 1\ar@{>->}@/^.9cm/[ddll]^(.2){\delta^3_0}
	\ar@{>->}[dl]_{\delta^3_0}\\
	&1\ar@{>->}[dr]^{\delta^3_0}\ar@{>->}[dl]_{\id{1}}
	\ar@{>->}@/_.7cm/[ddrr]|(.38)\hole^(.7){\delta^3_0}\ar@{>->}[ur]^{\id{1}}&& 3 &&
	1
	\ar@{>->}@/^.7cm/[ddll]|(.38)\hole_(.7){\delta^3_0}\ar@{>->}[dl]_{\delta^3_0}\ar@{>->}[lu]_{\delta^3_0}
	\ar@{>->}[dr]^{\delta^2_0}\\
	1 \ar@/_.7cm/[ddrr]_(.2){\delta^3_0}|(.325)\hole|(.81)\hole
	\ar@{>->}[dr]^(.35){\delta^3_0}|(.6)\hole && 3
	\ar@{>->}[dl]|(.4)\hole^(.65){\id{3}}\ar@{>->}[ur]|(.5)\hole^(.7){\id{3} }&&3
	\ar@{>->}[dr]|(.4)\hole_(.65){i_3}
	\ar@{>->}[ul]|(.475)\hole_(.7){\id{3}}&&2\ar@{>->}@/^.7cm/[ddll]^(.2){i_2}|(.325)\hole|(.81)\hole\ar@{>->}[dl]_(.35){i_2}|(.6)\hole\\
	&3 &&3	\ar@{>->}[dl]^{\id{3}}\ar@{>->}[ur]^{\id{3}}\ar@{>->}[ul]_{\id{3}}&&4\\
	1	\ar@{>->}@/^.7cm/[uurr]^(.2){\delta^3_0} \ar@{>->}[ur]_(.35){\delta^3_0}|(.61)\hole && 3	\ar@{>->}[ul]|(.4)\hole_(.65){\id{3}}\ar@{>->}[dr]|(.5)\hole_(.65){i_3}	&&4\ar@{>->}[ur]|(.4)\hole^(.65){t} \ar@{>->}[dl]|(.5)\hole^(.65){\id{4}}	&& 1\ar[ul]^(.35){\delta^4_0}|(.61)\hole\ar@/_.7cm/[uull]_(.2){\delta^3_0}\\ 
	&1	\ar@{>->}[ur]_{\delta^3_0} \ar@{>->}[dr]_{i_2}	\ar@{>->}[ul]^{\id{1}}\ar@/^.7cm/[uurr]_(.65){\delta^3_0}&&4&& 1\ar@{>->}[ur]_{\id{1}} \ar@{>->}[ul]^{\delta^4_0} \ar@{>->}[dl]^{\id{1}} \ar@{>->}@/_.7cm/[uull]^(.65){\delta^3_0}\\&& 2	\ar@{>->}[ur]_{i_2}\ar@{>->}@/^.9cm/[uurr]^(.2){i_2}&& 1 \ar@{>->}[ul]^{\delta^4_0} \ar@{>->}@/_.9cm/[uull]_(.2){\delta^3_0} |(.72)\hole }\] 

Notice that there is no arrow $f\colon 3\to 4$ such that 
\[t\circ f=i_3\circ \id{3} \qquad \id{4}\circ f=i_3\circ \id{3}\]

Indeed, if $f$ satisfies the first equation then $f=t\circ i_3$, while the second one entails $f=i_3$, but $t\circ i_3$ and $i_3$ are different.
\end{example}

The definition of pre-switch raises some issues. First of all we do not have sufficient conditions guaranteeing the existence of a pre-switch, moreover the fact that, as shown by \Cref{ex:abs}, the abstraction equivalence between two pre-switches does not necessarily have the identity as last component is somewhat unfortunate. Finally, \Cref{ex:abs2}, shows that this notion  is somewhat asymmetric in nature.  We will now tackle this last defect, while a solution to the first two is deferred to the next section.

\begin{definition}[Switch] 	Let $(\X, \R)$ be a left-linear rewriting system, with $\X$ an $\mathcal{M}$-adhesive category.
	Let also $\der{D}=\{\dder{D}_i\}_{i=0}^1$ be a derivation made
	of two sequentially independent derivations $\dder{D}_0$,
	$\dder{D}_1$ with independence pair $(i_0, i_1)$, as in the diagram below, where the cone with vertex $P$ is a pullback and $u_0\colon K_0\to P$ and $u_1\colon K_1\to P$ are the arrows built in \Cref{prop:tec}.
	\[\xymatrix@R=20pt@C=20pt{L_0 \ar[d]_{m_0}&& K_0 \ar @/^.35cm/[ddrr]_(.2){u_0}
		\ar[d]_{k_0}\ar@{>->}[ll]_{l_0} \ar[r]^{r_0} & R_0
		\ar@{>}@/^.25cm/[drrr]|(.32)\hole_(.4){i_0}|(.68)\hole
		\ar[dr]|(.33)\hole_{h_0} && L_1 \ar@{>}@/_.25cm/[dlll]^(.4){i_1}|(.68)\hole 
		\ar[dl]|(.33)\hole^{m_1}& K_1 \ar[d]^{k_1}\ar@{>->}[l]_{l_1} \ar @/_.35cm/[ddll]^(.2){u_1}
		\ar[rr]^{r_1} && R_1 \ar[d]^{h_1}\\G_0 && \ar@{>->}[ll]^{f_0}
		D_0 \ar[rr]_{g_0}|(.7)\hole&& G_1 && \ar@{>->}[ll]^{f_1}|(.7)\hole D_1
		\ar[rr]_{g_1}&& G_2 \\ & & & & P \ar[urr]_{p_1} \ar@{>->}[ull]^{p_0}}
	\]
	
	Let $\der{E}=\{\dder{E}_i\}_{i=0}^1$, depicted below, be a pre-switch for $\der{D}$ along $(i_0,i_1)$.
	\[
	\xymatrix@R=20pt@C=20pt{
		{L_1} \ar[d]_{m_0'}
		&&  {K_1} \ar@{>->}[ll]_{l_1} \ar[r]^{r_1} \ar[d]_{k_0'}
		&  {R_1} \ar[dr]|(.33)\hole_{h_0'}  \ar@/^.25cm/@{>}_(.4){i_0'}|(.32)\hole[drrr]
		& & 
		{L_0}\ar[dl]|(.33)\hole^{m_1'} \ar@/_.25cm/@{>}^(.4){i_1'}[dlll] 
		&  {K_0} \ar@{>->}[l]_{l_0} \ar[rr]^{r_0} \ar[d]^{k_1'}
		& & {R_0} \ar[d]^{h_1'} \\		
		{G_0}
		& & {D_0'} \ar@{>->}[ll]^{f_0'} \ar[rr]_{g_0'}
		& &  {G'_1} 
		& &  {D_1'} \ar@{>->}[ll]^{f_1'} \ar[rr]_{g_1'}
		& & {G_2}  }
	\]
	
	We say that $\der{E}$ is a \emph{switch} for $\der{D}$ along $(i_0, i_1)$ if there is an arrow $z_1\colon P\to D'_1$ fitting in the diagram below, where $z_0\colon P\to D'_0$ is the arrow constructed in \Cref{lem:cose}.
	\[\xymatrix@R=18pt{D'_0  \ar[d]_{g'_0}& P \ar[r]^{p_1} \ar[l]_{z_0} \ar@{.>}[d]^{z_1} & D_1 \ar[d]^{g_1}\\ G'_1 & D'_1 \ar[r]_{g'_1} \ar@{>->}[l]^{f'_1} & G_2}\]
	
	If a switch of $\dder{D}_0$ and $\dder{D}_1$ exists we say that they are \emph{switchable}. If $(\der{D}, \alpha, \omega)$ is a decorated derivation of length $2$, and $(i_0, i_1)$ an independence pair between $\dder{D}_0$ and $\dder{D}_1$, a \emph{decorated switch} of $(\der{D}, \alpha, \omega)$ along $(i_0, i_1)$ is $(\der{E}, \alpha, \omega)$, where $\der{E}$ is a switch for $\der{D}$ along $(i_0, i_1)$.
\end{definition}


\begin{remark}\label{rem:quadrati}
Let $\der{D}$ be a derivation made by two sequentially independence direct derivations with independence pair $(i_0, i_1)$. Suppose that $\der{E}$ is a pre-switch for $\der{D}$ along $(i_0, i_1)$. Then we have the solid part of the diagram below. If, moreover $\der{E}$ is a switch, then we can complete it with the dotted arrow $z_1\colon P\to D'_1$. 
		\[\xymatrix@C=15pt@R=15pt{&&R_0 \ar@/_.8cm/[ddrr]_(.2){i_0}|(.7)\hole
		\ar[dr]^{h_0}&& L_1\ar@/^.8cm/[ddll]^(.2){i_1}
		\ar[dl]_{m_1}\\&K_0\ar[dr]^{k_0}\ar@{>->}[dl]_{l_0}
		\ar@/_.6cm/[ddrr]|(.36)\hole^(.65){u_0}\ar[ur]^{r_0}&& G_1 &&
		K_1
		\ar@/^.6cm/[ddll]|(.36)\hole_(.65){u_1}\ar[dl]_{k_1}\ar@{>->}[lu]_{l_1}
		\ar[dr]^{r_1}\\L_0
		\ar@/_.6cm/[ddrr]_(.2){i'_1}|(.31)\hole|(.81)\hole
		\ar[dr]^(.4){m_0}|(.61)\hole && D_0
		\ar@{>->}[dl]|(.4)\hole_(.65){f_0}\ar[ur]|(.5)\hole^(.7){g_0}&&D_1
		\ar[dr]|(.4)\hole^(.65){g_1}
		\ar@{>->}[ul]|(.5)\hole_(.65){f_1}&&R_1\ar@/^.6cm/[ddll]^(.2){i'_0}|(.31)\hole|(.81)\hole\ar[dl]_{h_1}|(.6)\hole\\&G_0
		&&P\ar@{.>}[dr]_{z_1}	\ar@{>}[dl]^{z_0}\ar[ur]^(.4){p_1}\ar@{>->}[ul]_(.4){p_0}&&G_2\\L_1	\ar@/^.6cm/[uurr]^(.2){i_1} \ar[ur]_(.35){m'_0}|(.61)\hole && D'_0	\ar@{>->}[ul]|(.4)\hole_(.65){f'_0}\ar[dr]|(.5)\hole_(.65){g'_0}	&&D'_1\ar[ur]|(.4)\hole^(.65){g'_1} \ar@{>->}[dl]|(.5)\hole^(.65){f'_1}	&& R_0 \ar[ul]^(.35){h'_1}|(.61)\hole\ar@/_.6cm/[uull]_(.2){i_0}\\ &K_1	\ar[ur]_{k'_0} \ar[dr]_{r_1}	\ar@{>->}[ul]^{l_1}\ar@/^.6cm/[uurr]_(.65){u_1}&&G'_1&& K_0\ar[ur]_{r_0} \ar[ul]^{k'_1} \ar@{>->}[dl]^{l_0} \ar@/_.6cm/[uull]^(.65){u_0}\\&& R_1	\ar[ur]_{h'_0}\ar@/^.8cm/[uurr]^(.2){i'_0}&& L_0 \ar[ul]^{m'_1} \ar@/_.8cm/[uull]_(.2){i'_1} |(.69)\hole }\] 
\end{remark} 


\begin{lemma}
Let $\der{D}=\{\dder{D}_{i}\}_{i=0}^1$ be a derivation of length $2$ and $(i_0, i_1)$ an independence pair between $\dder{D}_0$ and $\dder{D}_1$. Given a pre-switch $\der{E}=\{\dder{E}_{i}\}_{i=0}^1$ for $\der{D}$ along $(i_0, i_1)$, the following are equivalent:
	\begin{enumerate}
		\item $\der{E}$ is a switch;
		\item if $(P, \{p_i\}_{i=0}^1)$ is a pullback for $f_{\der{D},1}$ along $g_{\der{D},0}$, then $\iota_{\der{E}, G_2} \circ g_1\circ p_1=\iota_{\der{E}, G'_1}\circ g'_0\circ z_0$.
	\end{enumerate}
\end{lemma}
\begin{proof}$(1 \Rightarrow 2)$. If $\der{E}$ is a switch then we have
	\begin{align*}
		\iota_{\der{E}, G_2} \circ g_1\circ p_1&=\iota_{\der{E}, G_2} \circ g'_1\circ z_1\\&=\iota_{\der{E}, D'_1}\circ z_1\\&=\iota_{\der{E}, G'_1}\circ f'_1\circ z_1\\&=\iota_{\der{E}, G'_1}\circ g'_0\circ z_0
	\end{align*}
	
	\smallskip \noindent $(2\Rightarrow 1)$. By hypothesis the solid part of the diagram below commutes.
	\[\xymatrix@C=30pt{P \ar[r]^{z_0} \ar@{.>}[dr]^{z_1}\ar[d]_{p_1} & D'_0 \ar[r]^{g'_0} & G'_1 \ar@{>->}[dr]^{\iota'_{1, G'_1}}\\ D_1 \ar[dr]_{g'_1}& D'_1 \ar[d]^{g'_1}\ar@{>->}[r]^{f'_1} &G'_1 \ar@{>->}[r]^{\iota'_{1, G'_1}} &\lpro \dder{E}_0 \rpro 	\ar@{>->}[d]^{p_1} \\ & G'_1 	\ar[rr]_{\iota_{\der{E}, G_2}}&& \tpro{E} }\]
	
	By \Cref{rem:zero1} the inner square is a pullback, proving that the dotted arrow $z_1\colon P\to D'_1$ exists.  Since, by \Cref{lem:colim} $\iota'_{1, G'_1}$ is in $\mathcal{M}$, we conclude that $f'\circ z_1=g'\circ z_0$ as wanted.
\end{proof}

We end this section showing that, if a switch exists, then any pre-switch can be turned into one composing it with an isomorphism.

\begin{proposition}\label{prop:pretosw} 	Let $\der{D}=\{\dder{D}_{i}\}_{i=0}^1$ be a derivation and suppose
	that both $\der{E}=\{\dder{E}_i\}_{i=0}^1$ and
	$\der{F}=\{\dder{F}_i\}_{i=0}^1$ are pre-switches of $\dder{D}_0$ and
	$\dder{D}_1$ along the same independence pair $(i_0, i_1)$. Let $\{\phi_X\}_{X\in \Deltamin(\der{E})}$ be the abstraction equivalence built in \Cref{thm:switch_uni}. If $\der{F}$ is a switch then also $\der{E}*\phi_{G_2}$ is one.
\end{proposition}
\begin{proof}
Suppose that $\der{D}$ is given by the following derivation.
	
	By \Cref{thm:switch_uni} we have a diagram as the one below.
	\[\xymatrix@C=22pt{G_{0} && \ar@{>->}[ll]_{f_{\der{F},0}} D_{\der{F},0} \ar[rr]^{g_{\der{F},0}}&& G_{\der{F},1} && \ar@{>->}[ll]_{f_{\der{F},1}} D_{\der{F},1} \ar[rr]^{g_{\der{F},1}}&& G_{2}\\L_1 \ar[d]^{f_0\circ i_1} \ar[u]_{f_0\circ i_1}&& K_{1} \ar[d]^{k_{\der{E},0}} \ar[u]_{k_{\der{F},0}}\ar@{>->}[ll]_{l_1} \ar[r]^{r_1} & R_{1} \ar@/^.35cm/[drrr]|(.315)\hole_(.4){j_0} \ar[dr]|(.3)\hole_{h_{\der{E},0}} \ar@/_.35cm/[urrr]|(.315)\hole^(.4){a_0} \ar[ur]|(.3)\hole^{h_{\der{F},0}}& &L_{0} \ar@/_.35cm/[dlll]^(.4){j_1} \ar[dl]|(.3)\hole^{m_{\der{E},1}} \ar@/^.35cm/[ulll]_(.4){a_1} \ar@/_.3cm/[ul]|(.252)\hole_(.4){m_{\der{F},1}}& K_{0} \ar[d]_{k_{\der{E},1}} \ar[u]^{k_{\der{F},1}}\ar@{>->}[l]_{l_{0}} \ar[rr]^{r_0} && R_{0} \ar[d]_{g_1\circ i_0} \ar[u]^{g_1\circ i_0}\\ \ar@/^.5cm/[uu]^{\id{G_0}} G_{0} && \ar[ll]^{f_{\der{E},0}} D_{\der{E},0} \ar@{>}@/^.5cm/[uu]^(.33){\phi_{D_{\der{E},0}}}|\hole \ar[rr]_{g_{\der{E},0}}&& G_{\der{E},1} \ar@{>}[uu]_(.76){\phi_{G_{\der{E}, 1}}}|(.45)\hole |(.55)\hole&& \ar@{>->}[ll]^{f_{\der{E},1}} D_{\der{E},1} \ar@{>}@/_.5cm/[uu]_(.33){\phi_{D_{\der{E},1}}}|\hole\ar[rr]_{g_{\der{E},1}}&& G_{2}\ar@{>}@/_.5cm/[uu]_{\phi_{G_2}}}\]
	
	Moreover, by definition $\der{E}*\phi_{G_2}$
	
	\end{proof}


\subsection{Strong-enforcing and well-switching rewriting systems}

\Cref{ex:diff1} show that sequential independence it does not suffice, in general, to guarantee the existence of a switch.  Inspired by the notion of of \emph{canonical filler}
\cite{heindel2009category}, we build on the last results of the previous section to give some conditions guaranteeing the existence of a switch. 




We are now ready to introduce the fundamental concept of this section.

\begin{definition}[Strong independence pair]
	\label{def:strong}
	Let $\X$ be an $\mathcal{M}$-adhesive category 
	and $(\X, \R)$ a left-linear rewriting system. 
	Let also $(i_0, i_1)$ be an independence pair between two direct
	derivations $\dder{D}_0$, $\dder{D}_1$
	as in the solid part of the diagram below
	\[\xymatrix@R=20pt@C=20pt{L_0 \ar[d]_{m_0}&& K_0
	\ar[d]_{k_0}\ar@{>->}[ll]_{l_0} \ar[r]^{r_0} & R_0
	\ar@/^.25cm/[drrr]|(.32)\hole_(.4){i_0}
	\ar[dr]|(.33)\hole_{h_0} && L_1 \ar@/_.25cm/[dlll]^(.4){i_1}
	\ar[dl]|(.33)\hole^{m_1}& K_1 \ar[d]^{k_1}\ar@{>->}[l]_{l_1}
	\ar[rr]^{r_1} && R_1 \ar[d]^{h_1}\\G_0 && \ar@{>->}[ll]^{f_0}
	D_0 \ar[rr]_{g_0}&& G_1 && \ar@{>->}[ll]^{f_1} D_1
	\ar[rr]_{g_1}&& G_2}
\]
	
	We say that $(i_0, i_1)$ is a \emph{strong independence pair} if
	the first two squares depicted  
	below are pushouts and if the pushout of $r_1 : K_1 \to R_1$ along $u_1 : K_1 \to P$ exists.
	\[
	\xymatrix{
		K_0 \ar[r]^{r_0} \ar[d]_{u_0}& R_0 \ar[d]^{i_0} & K_1
		\ar@{>->}[r]^{l_1} \ar[d]_{u_1}& L_1 \ar[d]^{i_1}
		&K_1 \ar[r]^{r_1} \ar[d]_{u_1}& R_1\ar@{.>}[d]^{j_0}
		\\
		%
		P \ar[r]_{p_1} & D_1 &P \ar[r]_{p_0} & D_0
		& P \ar@{.>}[r]_{q_1} & Q_1
	}
	\]
\end{definition}

\begin{remark}\label{rem:deco} 
	Let $(i_0, i_1)$ be a strong
	independence pair between the direct derivations $\dder{D}_0$ and
	$\dder{D}_1$. We can then build the solid part of the diagram
	below
	\[\xymatrix@C=15pt@R=15pt{&&R_0 \ar@/_.8cm/[ddrr]_(.2){i_0}|(.7)\hole
		\ar[dr]^{h_0}&& L_1\ar@/^.8cm/[ddll]^(.2){i_1}
		\ar[dl]_{m_1}\\&K_0\ar[dr]^{k_0}\ar@{>->}[dl]_{l_0}
		\ar@/_.6cm/[ddrr]_(.65){u_0}\ar[ur]^{r_0}&& G_1 && K_1
		\ar@/^.6cm/[ddll]^(.65){u_1}\ar[dl]_{k_1}\ar@{>->}[lu]_{l_1}
		\ar[dr]^{r_1}\\L_0 \ar[dr]^{m_0}
		\ar@{.>}@/_.6cm/[ddrr]_{j_1}&& D_0
		\ar@{>->}[dl]|(.42)\hole_(.64){f_0}\ar[ur]|(.48)\hole^(.7){g_1}&&D_1
		\ar[dr]|(.42)\hole^(.65){g_1}
		\ar@{>->}[ul]|(.48)\hole_(.7){f_1}&&R_1\ar@/^.6cm/[ddll]^{j_0}\ar[dl]^{h_1}\\&G_0
		&&P\ar[dr]^{q_1}
		\ar@{>.>}[dl]_{q_0}\ar[ur]^(.4){p_1}\ar@{>->}[ul]_(.4){p_0}&&G_2\\&&Q_0
		\ar@{>->}@{>.>}[ul]_{a_0} &&Q_1\ar@{.>}[ur]^{b_1}}
	\]
	
	Let us complete this diagram defining the dotted arrows. To get
	$j_1\colon L_0\to Q_0$ and $q_0\colon P\to Q_0$ it is enough to
	take a pushout of $l_0$ along $u_0$, which exists since
	$l_0\in \mathcal{M}$. Moreover, the existence of the wanted
	$a_0\colon Q_0\to G_0$ and $b_1\colon Q_1\to G_2$ follows from
	\[\begin{split}
	f_0\circ p_0 \circ u_0 &= f_0\circ k_0 \\&= m_0\circ l_0
	\end{split}
	 \qquad\begin{split}
	 	g_1\circ p_1\circ u_1 &= g_1\circ k_1\\&=h_1\circ r_1
	 \end{split}
	\]
	We can prove some other properties of
		the arrows appearing in the diagram above. The four rectangles
		below are pushouts and their left halves are pushouts
		too. Therefore, by \Cref{lem:po1} also their right halves are
		pushouts.  Moreover, $q_0$ and $a_0$ are pushouts of
		respectively $l_0$ and $p_0$, thus they are elements of
		$\mathcal{M}$. By \Cref{prop:pbpoad} the left halves of the
		second and third rectangles are pullbacks too.
		
		\[\xymatrix{K_0 \ar@/^.4cm/[rr]^{k_0}\ar[d]_{r_0}\ar[r]_{u_0}
			&P\ar[d]^{p_1} \ar@{>->}[r]_{p_0} & D_0 \ar[d]^{g_0}&K_1
			\ar@/^.4cm/[rr]^{k_1}\ar@{>->}[d]_{l_1}\ar[r]_{u_1}
			&P\ar@{>->}[d]^{p_0} \ar[r]_{p_1} & D_1 \ar@{>->}[d]^{f_1}\\
			R_0 \ar@/_.4cm/[rr]_{h_0} \ar[r]^{i_0}&D_1 \ar@{>->}[r]^{f_1}
			& G_1&L_1 \ar@/_.4cm/[rr]_{m_1} \ar[r]^{i_1}&D_0\ar[r]^{g_0} &
			G_1}\]
			\[\xymatrix{K_0
			\ar@/^.4cm/[rr]^{k_0}\ar@{>->}[d]_{l_0}\ar[r]_{u_0}
			&P\ar@{>->}[d]^{q_0} \ar@{>->}[r]_{p_0} & D_0
			\ar@{>->}[d]^{f_0}&K_1
			\ar@/^.4cm/[rr]^{k_1}\ar[d]_{r_1}\ar[r]_{u_1}
			&P\ar[d]^{q_1} \ar[r]_{p_1} & D_1 \ar[d]^{g_1}\\
			L_0 \ar@/_.4cm/[rr]_{m_0} \ar[r]^{j_1}&Q_0 \ar@{>->}[r]^{a_0}
			& G_0&R_1 \ar@/_.4cm/[rr]_{h_1} \ar[r]^{j_0}&Q_1 \ar[r]^{b_1}
			& G_2}\]
\end{remark}

So equipped we can now prove a version of the Local Church-Rosser Theorem for strong independence pairs in ledt-linear DPO rewriting systems.

\begin{theorem}[Local Church-Rosser Theorem]\label{prChurch} Let $\X$ be an $\mathcal{M}$-adhesive category and $(\X, \R)$ a left-linear DPO rewriting system on it. If $(i_0, i_1)$ is a strong independence pair
	between $\dder{D}_0$ and $\dder{D}_1$, then there exists a switch of $\dder{D}_0$ and $\dder{D}_1$ along it.
\end{theorem}
\begin{proof}
	Let us begin considering the diagram
	built in \Cref{rem:deco}
	\[\xymatrix@C=15pt@R=15pt{&&R_0
		\ar@/_.8cm/[ddrr]_(.2){i_0}|(.7)\hole \ar[dr]^{h_0}&&
		L_1\ar@/^.8cm/[ddll]^(.2){i_1}
		\ar[dl]_{m_1}\\&K_0\ar[dr]^{k_0}\ar@{>->}[dl]_{l_0}
		\ar@/_.6cm/[ddrr]_(.65){u_0}\ar[ur]^{r_0}&& G_1 && K_1
		\ar@/^.6cm/[ddll]^(.65){u_1}\ar[dl]_{k_1}\ar@{>->}[lu]_{l_1}
		\ar[dr]^{r_1}\\L_0 \ar[dr]^{m_0} \ar@{>}@/_.6cm/[ddrr]_{j_1}&& D_0
		\ar@{>->}[dl]|(.42)\hole_(.64){f_0}\ar[ur]|(.48)\hole^(.7){g_1}&&D_1
		\ar[dr]|(.42)\hole^(.65){g_1}
		\ar@{>->}[ul]|(.48)\hole_(.7){f_1}&&R_1\ar@/^.6cm/[ddll]^{j_0}\ar[dl]_{h_1}\\&G_0
		&&P\ar[dr]^{q_1}
		\ar@{>->}[dl]_{q_0}\ar[ur]^(.4){p_1}\ar@{>->}[ul]_(.4){p_0}&&G_2\\&&Q_0
		\ar@{>->}@{>->}[ul]_{a_0} \ar@{.>}[dr]_{b_0} &&Q_1\ar[ur]^{b_1}
		\ar@{>.>}[dl]^{a_1} \\ &&&H_1 }\] 
		
		Since $q_0\colon P\to Q_0$ is in
	$\mathcal{M}$, we can take its pushout along $q_1$ to get the dotted
	arrows $a_1\colon Q_1\mto H_1$ and $q_0\colon Q_0\to H_1$. But then,
	since the composite of two pushout squares is a pushout, the diagram
	below is a derivation
	\[\xymatrix{L_1 \ar[d]_{f_0 \circ i_1}&& K_1
		\ar[d]_{q_0\circ u_1}\ar@{>->}[ll]_{l_1} \ar[r]^{r_1} & R_1
		\ar@/^.35cm/[drrr]|(.31)\hole_(.4){j_0} \ar[dr]|(.3)\hole_{a_1\circ
			j_0} && L_0 \ar@/_.35cm/[dlll]^(.4){j_1} \ar[dl]|(.3)\hole^{b_0\circ
			j_1}& K_0 \ar[d]^{q_1\circ u_0}\ar@{>->}[l]_{l_0} \ar[rr]^{r_0} && R_0
		\ar[d]^{g_1\circ i_0} \\G_0 && \ar@{>->}[ll]^{a_0} Q_0 \ar[rr]_{b_0}&&
		H_1 && \ar@{>->}[ll]^{a_1} Q_1 \ar[rr]_{b_1}&& G_2}\] 
		
		The thesis now follows at once since, by construction, the derivation above is a switch of $\dder{D}_0$ and $\dder{D}_1$ along	$(i_0, i_1)$.
\end{proof}

The previous theorem not only assures about the existence of a switch along a strong independence pair, but it provides us with an explicit description of it. In turn this, using \Cref{thm:switch_uni}, allows us to deduce some property common to all switches along strong independence pairs.  

\begin{lemma}\label{cor:strongip}
	Let $(\X, \R)$ be a left-linear DPO rewriting system and consider the following derivation $\der{D}={\dder{D}_{i}}_{i=0}^i$ and suppose that $(i_0, i_1)$ is a strong independence pair.
	\[\xymatrix@R=20pt@C=20pt{L_0 \ar[d]_{m_0}&& K_0
		\ar[d]_{k_0}\ar@{>->}[ll]_{l_0} \ar[r]^{r_0} & R_0
		\ar@{.>}@/^.25cm/[drrr]|(.32)\hole_(.4){i_0}
		\ar[dr]|(.33)\hole_{h_0} && L_1 \ar@{.>}@/_.25cm/[dlll]^(.4){i_1}
		\ar[dl]|(.33)\hole^{m_1}& K_1 \ar[d]^{k_1}\ar@{>->}[l]_{l_1}
		\ar[rr]^{r_1} && R_1 \ar[d]^{h_1}\\G_0 && \ar@{>->}[ll]^{f_0}
		D_0 \ar[rr]_{g_0}&& G_1 && \ar@{>->}[ll]^{f_1} D_1
		\ar[rr]_{g_1}&& G_2}
	\]
	
	Suppose, moreover, that the following diagram defines a switch for $\dder{D}_0$ and $\dder{D}_1$ along $(i_0, i_1)$. 	
	\[
	\xymatrix@R=20pt@C=20pt{
		{L_1} \ar[d]_{m_0'}
		&&  {K_1} \ar@{>->}[ll]_{l_1} \ar[r]^{r_1} \ar[d]_{k_0'}
		&  {R_1} \ar[dr]|(.33)\hole_{h_0'}  \ar@/^.25cm/@{.>}_(.4){i_0'}|(.32)\hole[drrr]
		& & 
		{L_0}\ar[dl]|(.33)\hole^{m_1'} \ar@/_.25cm/@{.>}^(.4){i_1'}[dlll] 
		&  {K_0} \ar@{>->}[l]_{l_0} \ar[rr]^{r_0} \ar[d]^{k_1'}
		& & {R_0} \ar[d]^{h_1'} \\		
		{G_0}
		& & {D_0'} \ar@{>->}[ll]^{f_0'} \ar[rr]_{g_0'}
		& &  {G'_1} 
		& &  {D_1'} \ar@{>->}[ll]^{f_1'} \ar[rr]_{g_1'}
		& & {G_2}  }
	\]
and define $T$, with the arrows $t_0\colon T\mto D'_0$ and $t_1\colon T\to D'_1$ as the pullback of $f'_1$ along $g'_0$.


Finally, consider the derivation $\der{F}$ below, constructed in the proof of \Cref{prChurch}. 
\[\xymatrix{L_1 \ar[d]_{f_0 \circ i_1}&& K_1
	\ar[d]_{q_0\circ u_1}\ar@{>->}[ll]_{l_1} \ar[r]^{r_1} & R_1
	\ar@/^.35cm/[drrr]|(.31)\hole_(.4){j_0} \ar[dr]|(.3)\hole_{a_1\circ
		j_0} && L_0 \ar@/_.35cm/[dlll]^(.4){j_1} \ar[dl]|(.3)\hole^{b_0\circ
		j_1}& K_0\ar[d]^{q_1\circ u_0}\ar@{>->}[l]_{l_0} \ar[rr]^{r_0} && R_0
	\ar[d]^{g_1\circ i_0} \\G_0 && \ar@{>->}[ll]^{a_0} Q_0 \ar[rr]_{b_0}&&
	H_1 && \ar@{>->}[ll]^{a_1} Q_1 \ar[rr]_{b_1}&& G_2}\]
and let $\{\phi_{X}\}_{X\in \Deltamin(\der{F})}$ be the abstraction equivalence built in \Cref{thm:switch_uni}.

	Then the following hold true:
	\begin{enumerate}
		\item consider the following two squares, the first of which is a pullback and the second an $\mathcal{M}$-pushout,
		\[\xymatrix{P \ar[r]^{p_1} \ar@{>->}[d]_{p_0} & D_1 \ar@{>->}[d]^{f_1}& P \ar[r]^{q_1} \ar@{>->}[d]_{q_0} & Q_1 \ar@{>->}[d]^{a_1}\\ D_0 \ar[r]_{g_0} & G_1&Q_0 \ar[r]_{b_0} & H_1}\]
		then there exists an isomorphism $v\colon P\to T$ fitting in the diagram below:
		\[\xymatrix{ P \ar@{.>}[dr]^{v} \ar[rrr]^{q_1} \ar@{>->}[ddd]_{q_0}&&& Q_1 \ar@{>->}[ddd]^{a_1} \ar[dl]_{\phi_{Q_1}}\\&T \ar@{>->}[d]_{t_0}\ar[r]^{t_1}& D'_1 \ar@{>->}[d]^{f'_1} \\ & D'_0\ar[r]_{g'_0} & G'_1\\Q_0 \ar[rrr]_{b_0} \ar[ur]_{\phi_{Q_0}}&&& H_1 \ar[ul]^{\phi_{H_1}}}\]
		
		\item consider the diagram below, in which the inner square is a pullback and the dotted arrows are constructed as in \Cref{rem:deco}:
		\[\xymatrix{K_1 \ar[r]^{r_1} \ar@/_.3cm/[ddr]_{k'_0} \ar@{.>}[dr]^{e_0}& R_1  \ar[dr]^{i'_0}  && K_0 \ar@{>->}[r]^{l_0} \ar@/_.3cm/[ddr]_{k'_1} \ar@{.>}[dr]^{e_1}& L_1  \ar[dr]^{i'_1} \\& T\ar@{>->}[d]_{t_0} \ar[r]^{t_1}& D'_1  \ar@{>->}[d]^{f'_1} && T \ar@{>->}[r]^{t_0} \ar[d]_{t_1}& D'_0 \ar[d]^{g'_0}\\&D'_0 \ar[r]_{g'_0} & G'_1 && D'_1\ar@{>->}[r]_{f'_1} & G'_1}\]
		then $v\circ u_1=e_0$, $v\circ u_0=e_1$ and the two squares below are pushouts;
		\[\xymatrix{K_1  \ar[d]_{e_0} \ar[r]^{r_1} & R_1 \ar[d]^{i'_0} & K_0 \ar@{>->}[r]^{l_0} \ar[d]_{e_1}& L_0 \ar[d]^{i'_1}\\ T \ar[r]_{t_1}  & D'_1 & T \ar@{>->}[r]_{t_0} & D'_0 }\]
				
	\item $(i'_0, i'_1)$ is a strong independence pair;
	
	\item there exists a commutative diagram the one below.
	
	\[\xymatrix@C=15pt@R=15pt{&&R_0 \ar@/_.8cm/[ddrr]_(.2){i_0}|(.7)\hole
		\ar[dr]^{h_0}&& L_1\ar@/^.8cm/[ddll]^(.2){i_1}
		\ar[dl]_{m_1}\\&K_0\ar[dr]^{k_0}\ar@{>->}[dl]_{l_0}
		\ar@/_.6cm/[ddrr]|(.36)\hole^(.65){u_0}\ar[ur]^{r_0}&& G_1 &&
		K_1
		\ar@/^.6cm/[ddll]|(.36)\hole_(.65){u_1}\ar[dl]_{k_1}\ar@{>->}[lu]_{l_1}
		\ar[dr]^{r_1}\\L_0
		\ar@/_.6cm/[ddrr]_(.2){i'_1}|(.31)\hole|(.81)\hole
		\ar[dr]^(.4){m_0}|(.61)\hole && D_0
		\ar@{>->}[dl]|(.4)\hole_(.65){f_0}\ar[ur]|(.5)\hole^(.7){g_0}&&D_1
		\ar[dr]|(.4)\hole^(.65){g_1}
		\ar@{>->}[ul]|(.5)\hole_(.65){f_1}&&R_1\ar@/^.6cm/[ddll]^(.2){i'_0}|(.31)\hole|(.81)\hole\ar[dl]_{h_1}|(.6)\hole\\&G_0
		&&P\ar@{.>}[dr]_{z_1}	\ar@{>.>}[dl]^{z_0}\ar[ur]^(.4){p_1}\ar@{>->}[ul]_(.4){p_0}&&G_2\\L_1	\ar@/^.6cm/[uurr]^(.2){i_1} \ar[ur]_(.35){m'_0}|(.61)\hole && D'_0	\ar@{>->}[ul]|(.4)\hole_(.65){f'_0}\ar[dr]|(.5)\hole_(.65){g'_0}	&&D'_1\ar[ur]|(.4)\hole^(.65){g'_1} \ar@{>->}[dl]|(.5)\hole^(.65){f'_1}	&& R_0 \ar[ul]^(.35){h'_1}|(.61)\hole\ar@/_.6cm/[uull]_(.2){i_0}\\ &K_1	\ar[ur]_{k'_0} \ar[dr]_{r_1}	\ar@{>->}[ul]^{l_1}\ar@/^.6cm/[uurr]_(.65){u_1}&&G'_1&& K_0\ar[ur]_{r_0} \ar[ul]^{k'_1} \ar@{>->}[dl]^{l_0} \ar@/_.6cm/[uull]^(.65){u_0}\\&& R_1	\ar[ur]_{h'_0}\ar@/^.8cm/[uurr]^(.2){i'_0}&& L_0 \ar[ul]^{m'_1} \ar@/_.8cm/[uull]_(.2){i'_1} |(.69)\hole }\] 
	in which the following four squares are all pushouts, while the first three are also pullbacks.
	\[\xymatrix{P \ar@{>->}[r]^{p_0} \ar@{>->}[d]_{p_1}& D_0 \ar@{>->}[d]^{g_0}  & P \ar@{>->}[r]^{z_0} \ar@{>->}[d]_{p_0}& D'_0 \ar@{>->}[d]^{f'_0} &  P \ar@{>->}[d]_{z_0} \ar[r]^{z_1} & D'_1 \ar@{>->}[d]^{f'_1} & P\ar[r]^{z_1} \ar[d]_{p_1}&D'_1 \ar[d]^{g'_1}\\ D_1 \ar@{>->}[r]_{f_1} & G_1  & D_0 \ar@{>->}[r]_{f_0} & G_0 & D'_0 \ar[r]_{g'_0}& G'_1 & D_1 \ar[r]_{g_1}& G_2}\]	
	\end{enumerate}
\end{lemma}
\begin{proof}
	\begin{enumerate}
		\item  By \Cref{prop:pbpoad}, the square below is also a pullback.
			\[\xymatrix{P \ar[r]^{q_1} \ar@{>->}[d]_{q_0} & Q_1 \ar@{>->}[d]^{a_1}\\ Q_0 \ar[r]_{b_0} & H_1}\]
			Thus by the universal property of pullbacks  we get the dotted arrows $v\colon P\to T$ and $w\colon T\to P$ in the following diagrams.
		\[\xymatrix{ P \ar@{.>}[dr]^{v} \ar[rrr]^{q_1} \ar@{>->}[ddd]_{q_0}&&& Q_1 \ar@{>->}[ddd]^{a_1} \ar[dl]_{\phi_{Q_1}}& T\ar@{.>}[dr]^{w}  \ar[rrr]^{t_1} \ar@{>->}[ddd]_{t_0}&&& D'_1 \ar[dl]_{\phi^{-1}_{Q_1}} \ar@{>->}[ddd]^{f'_1}\\&T \ar@{>->}[d]_{t_0}\ar[r]^{t_1}& D'_1 \ar@{>->}[d]^{f'_1} &&& P \ar@{>->}[d]_{q_0}\ar[r]^{q_1}& Q_1\ar@{>->}[d]^{a_1}\\ & D'_0\ar[r]_{g'_0} & G'_1 &&& Q_0 \ar[r]_{b_0}& H_1 \\Q_0 \ar[rrr]_{b_0} \ar[ur]_{\phi_{Q_0}}&&& H_1 \ar[ul]^{\phi_{H_1}} & D'_0 \ar[rrr]_{g'_0} \ar[ur]_{\phi^{-1}_{Q_0}}&&&G'_1 \ar[ul]^{\phi^{-1}_{H_1}}}\]

To see that they are one the inverse of the other it is then enough to compute.
		\[\begin{split}
		t_0\circ v\circ w &=\phi_{Q_0}\circ q_0\circ w\\&=\phi_{Q_0}\circ \phi^{-1}_{Q_0} \circ t_0\\&=t_0\\q_0\circ w\circ v&=\phi^{-1}_{Q_0}	\circ t_0\circ v\\&=\phi^{-1}_{Q_0} \circ \phi_{Q_0}\circ q_0\\&=q_0 	\end{split}\qquad \begin{split}
		t_1\circ v\circ w &=\phi_{Q_1}\circ q_1\circ w\\&=\phi_{Q_1}\circ \phi^{-1}_{Q_1} \circ t_1\\&=t_1\\q_1\circ w\circ v&=\phi^{-1}_{Q_1}	\circ t_1\circ v\\&=\phi^{-1}_{Q_1} \circ \phi_{Q_1}\circ q_1\\&=q_1
		\end{split}\]
		
	\item By \Cref{thm:switch_uni}, we know that $\phi_{G_0}=\id{G_0}$, so that $a_0=f'_0\circ \phi_{Q_0}$, moreover, by the same theorem we have 
	\[\phi_{Q_1}\circ j_0=i'_0 \qquad  \phi_{Q_0}\circ j_1=i'_1\] 
		
		We can now use the previous equalities to get
		\[\begin{split}
			t_0\circ v\circ u_0&=\phi_{Q_0} \circ q_0\circ u_0\\&=\phi_{Q_0}\circ j_1\circ l_0\\&=i'_1\circ l_0\\&=t_0\circ e_1\\	t_0\circ v\circ u_1&=\phi_{Q_0} \circ q_0\circ u_1\\&=k'_0\\&= t_0\circ e_0
		\end{split} \qquad \begin{split}
			t_1\circ v\circ u_1&=\phi_{Q_1} \circ q_1\circ u_1\\&=\phi_{Q_1}\circ j_0\circ r_1\\&=i'_0\circ r_1\\&= t_1\circ e_0 \\ t_1\circ v\circ u_0&=\phi_{Q_1} \circ q_1\circ u_0\\&=k'_1\\&=t_1\circ e_1
		\end{split}\]
		
	So that $v\circ u_1=e_0$ and $v\circ u_0=e_1$. The thesis now follows from the two diagrams below, since their left halves are pushouts by construction.		
		\[\xymatrix{K_1  \ar@/^.4cm/[rr]^{e_0}\ar[r]_{u_1} \ar[d]_{r_1}& P \ar[r]_{v} \ar[d]_{q_1} & T \ar[d]^{t_1} & K_0 \ar@/^.4cm/[rr]^{e_1} \ar@{>->}[d]_{l_0}\ar[r]_{u_0} & P \ar[r]_{v}  \ar@{>->}[d]_{q_0}& T \ar@{>->}[d]^{t_0}\\ R_1 \ar@/_.4cm/[rr]_{i'_0} \ar[r]^{j_0}& Q_1 \ar[r]^{\phi_{Q_1}} & D'_1 & L_0 \ar@/_.4cm/[rr]_{i'_1} \ar[r]^{j_0} & Q_0 \ar[r]^{\phi_{Q_0}} & D'_0 }\]
		
	
		\item Given the results of the previous point, it is now enough to show that the pushout of $r_0\colon K_0\to R_0$ along $e_1\colon K_0\to T$ exists. We can consider the diagram below
		\[\xymatrix{K_0 \ar@/^.4cm/[rr]^{u_0} \ar[d]_{r_0} \ar[r]_{e_1}& T  \ar[d]_{p_1\circ w}\ar[r]_{w} & P \ar[d]^{p_1}\\ R_0 \ar[r]_{i_0}& D_1 \ar[r]_{\id{D_1}}& D_1}\]
		But the outer diagram is a pushout since $(i_0, i_1)$ is strong and we can conclude. 
		
		
		
		\item Let $z_0\colon P\mto D'_0$ and $z_1\colon P\to D_1$ be, respectively, $t_0\circ v$ and $t_1\circ v$. Then we have
		
		\[\begin{split}
		g'_0\circ z_0&=g'_0\circ t_0\circ v\\&=f'_1\circ t_1\circ v\\&=f'_1\circ z_1
		\end{split}\quad \begin{split}
		z_0\circ u_1&=t_0\circ v\circ u_1\\&=\phi_{Q_0}\circ q_0\circ u_1\\&=k'_0
		\end{split} \quad \begin{split}
		z_1\circ u_0&=t_1\circ v\circ u_0\\&=\phi_{Q_1}\circ q_1\circ u_0\\&=k'_1
		\end{split}\]
		
		Moreover
		\[\begin{split}
			f'_0\circ z_0&=f'_0\circ t_0\circ v\\&=f'_0\circ \phi_{Q_0}\circ q_0\\&=a_0\circ q_0\\&=f_0\circ p_0
		\end{split} \qquad \begin{split}
		g'_1\circ z_1&=g'_1\circ t_1\circ v\\&=g'_1\circ \phi_{Q_1}\circ q_1\\&=\phi_{G_2}\circ b_1 \circ q_1\\&=\phi_{G_2}\circ g_1\circ p_1\\&=f_0\circ p_0
		\end{split} \]
		
		
		Therefore the $z_0$ and $z_1$ fit in the diagram above.
		
		To conclude, notice that the the four rectangles below and their halves, by construction and by point $3$, are pushouts, thus by \Cref{lem:po1} also their right halves are
		pushouts. 
		
		\[\xymatrix{K_0 \ar@/^.4cm/[rr]^{k_0}\ar[d]_{r_0}\ar[r]_{u_0}
			&P\ar[d]^{p_1} \ar@{>->}[r]_{p_0} & D_0 \ar[d]^{g_0}&K_0
			\ar@/^.4cm/[rr]^{k'_1}\ar@{>->}[d]_{l_0}\ar[r]_{u_0}
			&P\ar@{>->}[d]^{z_0} \ar[r]_{z_1} & D'_1 \ar@{>->}[d]^{f'_1}\\
			R_0 \ar@/_.4cm/[rr]_{h_0} \ar[r]^{i'_1}&D_1 \ar@{>->}[r]^{f_1}
			& G_1&L_1 \ar@/_.4cm/[rr]_{m'_1} \ar[r]^{i_1}&D'_0\ar[r]^{g'_0} &
			G'_1}\]
		\[\xymatrix{K_0
			\ar@/^.4cm/[rr]^{k_0}\ar@{>->}[d]_{l_0}\ar[r]_{u_0}
			&P\ar@{>->}[d]^{z_0} \ar@{>->}[r]_{p_0} & D_0
			\ar@{>->}[d]^{f_0}&K_1
			\ar@/^.4cm/[rr]^{k_1}\ar[d]_{r_1}\ar[r]_{u_1}
			&P\ar[d]^{z_1} \ar[r]_{p_1} & D_1 \ar[d]^{g_1}\\
			L_0 \ar@/_.4cm/[rr]_{m_0} \ar[r]^{i'_1}&D'_0 \ar@{>->}[r]^{f'_0}
			& G_0&R_1 \ar@/_.4cm/[rr]_{h_1} \ar[r]^{i'_0}&D'_1 \ar[r]^{b_1}
			& G_2}\]
			
			We conclude by \Cref{prop:pbpoad}. \qedhere 
	\end{enumerate}
\end{proof}


We can now turn to prove the fundamental property that we need to rely upon:  any decorated switch along a strong independence pair induces a consistent permutation.

\begin{lemma}\label{lem:switchtoperm}
	Let $(\der{D}, \alpha, \omega)$ be a decorated derivations of length $2$ and suppose that $(\der{E}, \alpha, \omega)$ is a decorated switch for it along the independence pair $(i_0, i_1)$. Then there exists an arrow $\kappa\colon G_1\to \tpro{E}$ such that 
		\[\kappa \circ g_{0} = \iota_{\der{E}, G_0}\circ f_{0} \qquad \kappa\circ h_{0}= \iota_{\der{E}, R_0}\]
		
		Moreover, if $(i_0, i_1)$ is strong, also the following facts are true:
		\begin{enumerate}
		\item there exists an arrow $\phi\colon \tpro{D}\to \tpro{E}$ such that
		\[\phi \circ \iota_{\der{D}, G_0}=\iota_{\der{E}, G_0} \qquad \phi \circ \iota_{\der{D}, G_1}=\kappa \qquad \phi \circ \iota_{\der{D}, G_2}=\iota_{\der{E}, G_2}\]
		\item the $2$-cycle $\tau_{0,1}\colon [0,1]\to [0,1]$ is a consistent permutation between $(\der{D}, \alpha, \omega)$ and $(\der{E}, \alpha, \omega)$.
	\end{enumerate}
\end{lemma}
\begin{proof}
	To fix the notation let $\der{D}$ be given by the first diagram below and $\der{E}$ by the second one.
	\[\xymatrix@R=20pt@C=20pt{L_0 \ar[d]_{m_0}&& K_0
		\ar[d]_{k_0}\ar@{>->}[ll]_{l_0} \ar[r]^{r_0} & R_0
		\ar@{>}@/^.25cm/[drrr]|(.32)\hole_(.4){i_0}
		\ar[dr]|(.33)\hole_{h_0} && L_1 \ar@{>}@/_.25cm/[dlll]^(.4){i_1}
		\ar[dl]|(.33)\hole^{m_1}& K_1 \ar[d]^{k_1}\ar@{>->}[l]_{l_1}
		\ar[rr]^{r_1} && R_1 \ar[d]^{h_1}\\G_0 && \ar@{>->}[ll]^{f_0}
		D_0 \ar[rr]_{g_0}&& G_1 && \ar@{>->}[ll]^{f_1} D_1
		\ar[rr]_{g_1}&& G_2}
	\]
	\[
	\xymatrix@R=20pt@C=20pt{
		{L_1} \ar[d]_{m_0'}
		&&  {K_1} \ar@{>->}[ll]_{l_1} \ar[r]^{r_1} \ar[d]_{k_0'}
		&  {R_1} \ar[dr]|(.33)\hole_{h_0'}  \ar@/^.25cm/@{>}_(.4){i_0'}|(.32)\hole[drrr]
		& & 
		{L_0}\ar[dl]|(.33)\hole^{m_1'} \ar@/_.25cm/@{>}^(.4){i_1'}[dlll] 
		&  {K_0} \ar@{>->}[l]_{l_0} \ar[rr]^{r_0} \ar[d]^{k_1'}
		& & {R_0} \ar[d]^{h_1'} \\		
		{G_0}
		& & {D_0'} \ar@{>->}[ll]^{f_0'} \ar[rr]_{g_0'}
		& &  {G'_1} 
		& &  {D_1'} \ar@{>->}[ll]^{f_1'} \ar[rr]_{g_1'}
		& & {G_2}  }
	\]
	
 $G_1$ is obtained as the pushout of $k_0$ along $r_0$m thus get the wanted arrow $\kappa\colon G_1\to \tpro{E}$ it is now enough to compute:
	\begin{align*}
		\iota_{\der{E}, G_0}\circ f_{0}\circ  k_{0}&= \iota_{\der{E}, G_0}\circ m_{0} \circ l_{ 0}\\&=\iota_{\der{E}, G_0}\circ  f'_{0} \circ i'_1 \circ l_0\\&=\iota_{\der{E}, D'_0}\circ i'_1 \circ l_0\\&=\iota_{\der{E}, G'_1} \circ g'_0\circ m'_1 \circ l_0\\&=\iota_{\der{E}, G'_1}\circ m'_1\circ l_0	\\&=\iota_{\der{E}, G'_1} \circ f'_1\circ k'_1\\&=\iota_{\der{E}, D'_1}\circ k'_1\\&=\iota_{\der{E}, K'_0}\\&= \iota_{\der{E}, R_0} \circ r_0
	\end{align*}
	
	Let us now suppose that $(i_0,i_1)$ is a strong independence pair. We can then consider the following two squares, the first of which is a pullback and the second one, by strongness, a  pushout.
	
			\[\xymatrix{P \ar[r]^{p_1}  \ar@{>->}[d]_{p_0} & D_1 \ar@{>->}[d]^{f_1} & K_0 \ar[r]^{r_0}  \ar[d]_{u_0} & R_0 \ar[d]^{i_0}\\ D_0\ar[r]_{g_0} & G_1 & P\ar[r]_{p_1} & D_1}\]

	\begin{enumerate}
		\item   Consider the arrow $\kappa\colon G_1\to \tpro{E}$ built in the previous point, then we have
		\begin{align*}
			\kappa \circ f_1\circ i_0&=\kappa\circ h_0\\&=\iota_{\der{E},R_0}\\&=\iota_{\der{E}{G_2}}\circ h'_1\\&=\iota_{\der{E}{G_2}}\circ g_1\circ i_0
		\end{align*}
		
		\begin{align*}
			\kappa\circ f_1\circ p_1&=\kappa \circ g_0\circ p_0\\&=\iota_{\der{E},G_0}\circ f_0\circ p_0
		\end{align*}
		\item 
		\qedhere 
	\end{enumerate}
\end{proof}

\Cref{prChurch} and \Cref{lem:switchtoperm} guarantees some basic but fundamental properties of switches whithout which developing a theory of concurrency seems hopeless, we are thus lead to the following definition.

\begin{definition}
A left-linear DPO rewriting system $(\X, \R)$ is \emph{strong enforcing} if every independence pair is strong.
\end{definition}

The notion of strong enforcing DPO rewriting system encompasses that of linear one.


\begin{proposition}\label{prop:linstrong}
	Every linear rewriting system $(\X, \R)$ is strong enforcing.
\end{proposition}
\begin{proof}
	Suppose that $\X$ is $\mathcal{M}$-adhesive and let $(i_0, i_1)$ be
	an independence pair as below
	\[
	\xymatrix@C=15pt{L_0 \ar[d]_{m_0}&& K_0
		\ar[d]_{k_0}\ar@{>->}[ll]_{l_0} \ar@{>->}[r]^{r_0} & R_0
		\ar@/^.35cm/[drrr]|(.3)\hole_(.4){i_0} \ar[dr]|(.3)\hole_{h_0}
		&& L_1 \ar@/_.35cm/[dlll]^(.4){i_1} \ar[dl]|(.3)\hole^{m_1}& K_1
		\ar[d]^{k_1}\ar@{>->}[l]_{l_1} \ar@{>->}[rr]^{r_1} && R_1
		\ar[d]^{h_1} \\G_0 && \ar@{>->}[ll]^{f_0} D_0
		\ar@{>->}[rr]_{g_0}&& G_1 && \ar@{>->}[ll]^{f_1} D_1
		\ar@{>->}[rr]_{g_1}&& G_2}\]
	
	Since $(\X, \R)$ is linear, then $r_1\colon K_1\to R_1$ belongs to
	$\mathcal{M}$, thus it admits a pushout along $u_1\colon K_1\to P$,
	as desired. Moreover, let us consider the two rectangles below
	\[
	\xymatrix{K_0 \ar@/^.4cm/[rr]^{k_0}\ar@{>->}[d]_{r_0}\ar[r]_{u_0}
		&P\ar@{>->}[d]^{p_1} \ar@{>->}[r]_{p_0} & D_0
		\ar@{>->}[d]^{f_0}& K_1
		\ar@/^.4cm/[rr]^{k_1}\ar@{>->}[d]_{l_1}\ar[r]_{u_1}
		&P\ar@{>->}[d]^{p_0} \ar@{>->}[r]_{p_1} & D_1
		\ar@{>->}[d]^{f_1}\\ R_0 \ar@/_.4cm/[rr]_{h_0} \ar[r]^{i_0}&D_1
		\ar@{>->}[r]^{f_1} & G_1& L_1 \ar@/_.4cm/[rr]_{m_1}
		\ar[r]^{i_1}&D_0 \ar@{>->}[r]^{g_0} & G_1} \] By hypothesis
	$r_0$ and $l_1$ are in $\mathcal{M}$, thus $f_1$ and $g_0$ belong to
	it too. The first point of \Cref{lem:popb} yields the thesis.
\end{proof}

We can easily 

\begin{lemma}
Let $(P, \{p_0, p_1\})$ be the pullback of $f_1$ along $g_1$, then there exists $z_0\colon P\mto D'_0$ and $z_1\colon P\to D'_1$ making the following diagram commutative
\[\xymatrix@C=15pt@R=15pt{&&R_0 \ar@/_.8cm/[ddrr]_(.2){i_0}|(.7)\hole
	\ar[dr]^{h_0}&& L_1\ar@/^.8cm/[ddll]^(.2){i_1}
	\ar[dl]_{m_1}\\&K_0\ar[dr]^{k_0}\ar@{>->}[dl]_{l_0}
	\ar@/_.6cm/[ddrr]|(.36)\hole^(.65){u_0}\ar[ur]^{r_0}&& G_1 &&
	K_1
	\ar@/^.6cm/[ddll]|(.36)\hole_(.65){u_1}\ar[dl]_{k_1}\ar@{>->}[lu]_{l_1}
	\ar[dr]^{r_1}\\L_0
	\ar@/_.6cm/[ddrr]_(.2){i'_1}|(.31)\hole|(.81)\hole
	\ar[dr]^(.4){m_0}|(.61)\hole && D_0
	\ar@{>->}[dl]|(.4)\hole_(.65){f_0}\ar[ur]|(.5)\hole^(.7){g_0}&&D_1
	\ar[dr]|(.4)\hole^(.65){g_1}
	\ar@{>->}[ul]|(.5)\hole_(.65){f_1}&&R_1\ar@/^.6cm/[ddll]^(.2){i'_0}|(.31)\hole|(.81)\hole\ar[dl]_{h_1}|(.6)\hole\\&G_0
	&&P\ar@{.>}[dr]_{z_1}	\ar@{>.>}[dl]^{z_0}\ar[ur]^(.4){p_1}\ar@{>->}[ul]_(.4){p_0}&&G_2\\L_1	\ar@/^.6cm/[uurr]^(.2){i_1} \ar[ur]_(.35){m'_0}|(.61)\hole && D'_0	\ar@{>->}[ul]|(.4)\hole_(.65){f'_0}\ar[dr]|(.5)\hole_(.65){g'_0}	&&D'_1\ar[ur]|(.4)\hole^(.65){g'_1} \ar@{>->}[dl]|(.5)\hole^(.65){f'_1}	&& R_0 \ar[ul]^(.35){h'_1}|(.61)\hole\ar@/_.6cm/[uull]_(.2){i_0}\\ &K_1	\ar[ur]_{k'_0} \ar[dr]_{r_1}	\ar@{>->}[ul]^{l_1}\ar@/^.6cm/[uurr]_(.65){u_1}&&G'_1&& K_0\ar[ur]_{r_0} \ar[ul]^{k'_1} \ar@{>->}[dl]^{l_0} \ar@/_.6cm/[uull]^(.65){u_0}\\&& R_1	\ar[ur]_{h'_0}\ar@/^.8cm/[uurr]^(.2){i'_0}&& L_0 \ar[ul]^{m'_1} \ar@/_.8cm/[uull]_(.2){i'_1} |(.69)\hole }\] 
moreover, the following squares are all pushouts, moreover the first two are also pullbacks.
\[\xymatrix{P \ar@{>->}[r]^{z_0} \ar@{>->}[d]_{p_0}& D'_0 \ar@{>->}[d]^{f'_0} &  P \ar@{>->}[d]_{z_0} \ar[r]^{z_1} & D'_1 \ar@{>->}[d]^{f'_1} & P\ar[r]^{z_1} \ar[d]_{p_1}&D'_1 \ar[d]^{g'_1}\\ D_0 \ar@{>->}[r]_{f_0} & G_0 & D'_0 \ar[r]_{g'_0}& G'_1 & D_1 \ar[r]_{g_1}& G_2}\]
\end{lemma}
\begin{proof}
	Define $z_0$ and $z_1$ to be, respectively, $t_0\circ v$ and $t_1\circ v$. To prove the commutativity of the diagram in the thesis, first of all we can notice that
	\begin{align*}
		g'_0\circ z_0\\&= g'_0\circ t_0\circ v\\&=f'_1\circ t_1\circ v\\&=f'_1\circ z_1
	\end{align*}
	To prove the other identities, it is enough to compute and use the identities obtained in the previous point. On the one hand we have
	\[	\begin{split}f'_0\circ z_0&=f'_0\circ t_0\circ v\\&=f'_0\circ \phi_{Q_0}\circ q_0\\&=a_0\circ q_0\\&=f_0\circ p_0 
	\end{split} \qquad \begin{split}
		g'_1\circ z_1&=g'_1\circ t_1\circ v\\&=g'_1\circ \phi_{Q_1}\circ q_1\\&=\phi_{G_2}\circ b_1\circ q_1\\\phi_{G_2}\circ g_1\circ p_1\\&=
	\end{split}\]
	
	\[\begin{split}
		z_0\circ u_0&= t_0\circ v \circ u_0\\&=t_0\circ e_1\\&=i'_1\circ l_0\\ 	f'_0\circ z_0&=f'_0\circ t_0\circ v\\&=f'_0\circ \phi_{Q_0}\circ q_0\\&=a_0\circ q_0\\&=f_0\circ p_0
	\end{split}\quad \begin{split}
		z_1\circ u_1&=t_1\circ v\circ u_1\\&=t_1\circ e_1\\&=i'_0\circ r_1
	\end{split} \quad \begin{split}
	aaa	
	\end{split}\]
	
\end{proof}






\subsection{Well-switching rewriting systems}

\subsection{Abstract switches}
We can now prove some properties relating switching and abstraction equivalence. As a first step we can show that switches along the same independence paire are unique up to abstraction equivalence.

\todo{Unicit}

\todo{switchabilit}


\begin{definition}
	contenuto...
\end{definition}


\begin{corollary}[Uniqueness of switches]\label{cor:switch}
	\todo{switches}
\end{corollary}



Another useful property of switches is that they can be performed back and forth, giving back the original derivation. This is the content of the following two results. 

\todo{switch di switch}


\begin{proposition}
	contenuto...
\end{proposition}
\begin{proof}
	contenuto...
\end{proof}

\begin{corollary}
	contenuto...
\end{corollary}





The fact that sequential independence implies switchability always
holds for linear rules (see \Cref{prop:equi}). The result is so
indispensable that typically, in the literature, it is not even
stated, in the sense that switchability is not introduced
axiomatically as in Definition~\ref{def:switch}, but it is based on
the explicit construction of a switch.

For left-linear rewriting systems
sequential independence does not imply switchability (while the
converse implication clearly holds), as shown by the next example.

\begin{figure}
	
	\begin{subfigure}{0.58\textwidth}
		\xymatrix@C=20pt{
			a \ar[d]_{\sqsubseteq} & a \ar[d]_{\sqsubseteq} \ar@{>->}[l]_{\id{a}} \ar[r]^{\sqsubseteq} & 
			0 \ar@{>->}@/^.35cm/[drrr]|(.3)\hole^(.75){\id{0}}
			\ar@{>->}[dr]|(.3)\hole_{\id{0}} &  &
			a \ar@/_.35cm/[dlll]_(.75){\sqsubseteq}
			\ar[dl]|(.3)\hole^{\sqsubseteq} & 
			a \ar[d]^{\sqsubseteq}\ar@{>->}[l]_{\id{a}} \ar[r]^{\sqsubseteq} &
			b \ar[d]_{\sqsubseteq}\\
			c &
			\ar@{>->}[l]^{\id{c}} c \ar[rr]_{\sqsubseteq}& &  0 &&
			\ar@{>->}[ll]^{\id{0}} 0 \ar@{>->}[r]_{\id{0}}& 0
		}
		\caption{Two rewriting steps}
		\label{fig:diff1:rew}
	\end{subfigure}
	\begin{subfigure}{0.20\textwidth}
	
		\caption{No rewriting step}
		\label{ex:diff1:no-step}
	\end{subfigure}
	\caption{Sequential independence does not imply switchability}
	\label{fig:diff1} 
\end{figure}




The conditions guaranteeing switchability are inspired
by the notion of \emph{canonical filler}
\cite{heindel2009category}.

\begin{definition}[Strong independence pair]
	\label{def:filler}
	Let $\X$ be an $\mathcal{M}$-adhesive category 
	and $(\X, \R)$ a left-linear rewriting system. 
	Let also $(i_0, i_1)$ be an independence pair between two direct
	derivations $\dder{D}_0$, $\dder{D}_1$
	as in the solid part of the diagram below
	\[
	\xymatrix@C=18pt@R=17pt{L_0 \ar[d]_{m_0}&& K_0
		\ar[d]_{k_0}\ar@{>->}[ll]_{l_0} \ar[r]^{r_0} \ar@{.>}@/^.20cm/[ddrr]|(.32)\hole|(.57)\hole_(.7){u_0} & R_0
		\ar@/^.35cm/[drrr]|(.3)\hole^(.2){i_0} \ar[dr]|(.3)\hole_{h_0}
		&& L_1 \ar@/_.35cm/[dlll]_(.2){i_1} \ar[dl]|(.3)\hole^{m_1}& K_1
		\ar[d]^{k_1}\ar@{>->}[l]_{l_1} \ar[rr]^{r_1} \ar@{.>}@/_.20cm/[ddll]|(.32)\hole|(.57)\hole^(.7){u_1} && R_1 \ar[d]^{h_1} \\
		%
		G_0 &&
		\ar@{>->}[ll]^{f_0} D_0 \ar[rr]_(.3){g_0}&& G_1 &&
		\ar@{>->}[ll]^(.3){f_1} D_1 \ar[rr]_{g_1}&& G_2\\
		%
		& & & & P \ar@/^.3cm/@{>.>}[ull]^{p_0} \ar@/_.3cm/@{.>}[urr]_{p_1}
	}
	\]
	
	Consider the pullback of $g_0$ and $f_1$, which yields $p_i : P \to D_i$
	for $i \in \{0,1\}$ and the mediating arrows $u_i\colon K_i\to P$ 
	for $i \in \{0,1\}$ 
	into the pullback object (see \Cref{prop:tec} for details). 
	We say that $(i_0, i_1)$ is a \emph{strong independence pair} if
	the first two squares depicted  
	below are pushouts and if the pushout of $r_1 : K_1 \to R_1$ and $u_1 : K_1 \to P$ exists
	\[
	\xymatrix@R=16pt{
		K_0 \ar[r]^{r_0} \ar[d]_{u_0}& R_0 \ar[d]^{i_0} & K_1
		\ar@{>->}[r]^{l_1} \ar[d]_{u_1}& L_1 \ar[d]^{i_1}
		&K_1 \ar[r]^{r_1} \ar[d]_{u_1}& R_1\ar@{.>}[d]^{j_0}
		\\
		P \ar[r]_{p_1} & D_1 &P \ar[r]_{p_0} & D_0
		& P \ar@{.>}[r]_{q_1} & Q_1
	}
	\]
\end{definition}

We can now prove a Local Church-Rosser Theorem for strong independence pairs.

\begin{proposition}	\label{pr:church}
	Let $(i_0, i_1)$ be a strong independence pair
	between $\dder{D}_0$ and $\dder{D}_1$. Then $\dder{D}_0$ and
	$\dder{D}_1$ are switchable.
\end{proposition}

The correspondence between sequential independence and switchability
is fundamental. We name the class of rewriting systems where this property holds.

\begin{definition}[Strong enforcing rewriting systems]
	A left-linear rewriting system is \emph{strong enforcing} if
	every independence pair between two direct derivations is strong.
\end{definition}

We can identify a large class of adhesive categories such that all
left-linear rewriting systems over such categories are strong
enforcing. This class includes $\cat{Set}$ and it is closed
under comma and functor category constructions.  As such, it includes
essentially all categories (e.g., presheaves over set) that are
typically considered for modelling purposes. Notably, it contains the
category $\cat{Graph}$ of directed graphs.
This is a natural generalisation from adhesive to $\mathcal{M}$-adhesive categories of a class studied in \cite{baldan2011adhesivity} (see \Cref{app:fill} for details).

Still, there are $\mathcal{M}$-adhesive rewriting systems that are not strong enforcing.

\begin{example}[Non-strong enforcing left-linear rewriting system]
	\label{ex:diff2}
	In light of \Cref{pr:church}, \Cref{ex:diff1} provides an example of
	an independence pair that is not strong. This gives an example of a
	left-linear rewriting system in a $\mathcal{M}$-adhesive category that is quite
	pathological since $\mathcal{M}=\mathsf{I(\X)}$. However, this is expected, 
	since all natural examples seem to belong to the well-behaved class mentioned above. 
\end{example}

\begin{remark}
	By \Cref{pr:church} the existence of a strong independence pair
	entails switchability, which in turn entails sequential
	independence by construction. Strong enforcing rewriting systems are exactly
	those rewriting systems in which these three notions coincide.
\end{remark}

Consistency with the theory of linear rewriting systems is ensured by the fact that all linear rewriting systems are strong enforcing (see \cref{prop:equi}).



Even if we work in strong enforcing rewriting systems where sequential
independence ensures switchability, when dealing with left-linear
rules there is a further, possibly more serious issue, 
namely that there can be more than one independence pair between
the same derivations (cfr. \Cref{rem:uni}). This hinders the very idea of using
sequential independence as a basis of a theory of concurrency for
rewriting systems, since exchanges performed using different
independence pairs may lead to derivations that are not abstraction
equivalent, thus equating computations that should
definitively be taken apart, as shown in the example below.

\begin{example}
	Consider the derivation $\der{E}$ from Example~\ref{ex:seq-ind} (see Fig.~\ref{fi:derE}).
	The last two steps are sequential independent, but one easily sees
	that there are two distinct independence pairs, as the left-hand side
	of $\rho_1$ can be mapped either to node $1$ or to node
	$2$ in $D_1'$. Correspondingly, there
	are two switches of $\der{E}$: one is the derivation $\der{D}$ in
	Fig.~\ref{fi:derD} we started from, the other is the derivation
	$\der{D}'$ in Fig.~\ref{fi:derD1}.
	
	\begin{figure}
%		\input{Figure/derD1.tex}
		\caption{The derivation $\der{D}'$.}
		\label{fi:derD1}
	\end{figure}
	
	As a consequence, $\der{D}$ and $\der{D}'$ would be switch
	equivalent, but this is not acceptable when viewing equivalence
	classes of derivations as concurrent computations: in $\der{D}$ the
	first two steps are not sequential independent, while in $\der{D}'$
	they are, intuitively because in $\der{D}$ rule $\rho_1$ uses the
	node generated by $\rho_0$ (adding a self-loop to it), while in
	$\der{D}'$ rule $\rho_1$ uses the node that was in the initial
	graph. Also observe that the graphs $G_2$ and $G_2'$ produced after
	two steps in $\der{D}$ and $\der{D'}$ are not isomorphic. From the
	technical point of view, the property of being switch equivalent is
	not closed by prefix, and this prevents deriving a sensible
	concurrent semantics: In fact
	$\der{D} = \dder{D}_0\cdot \dder{D}_1 \cdot \dder{D}_2$ and
	$\der{D}' = \dder{D}_0'\cdot \dder{D}_1' \cdot \dder{D}_2'$ are
	switch equivalent, while if we consider the first two steps,
	derivations $\dder{D}_0 \cdot \dder{D}_1$ and
	$\dder{D}_0' \cdot \dder{D}_1'$ are not switch equivalent.
\end{example} 

Moreover, limiting sequential independence to the case in which the independence
	pair is unique (as suggested in~\cite{baldan2017domains}) brings to the same problems.

For these reasons we believe a theory of rewriting for
left-linear rules in adhesive categories should be developed for
systems where the uniqueness of the independence pair is ensured.

\begin{definition}[Well-switching rewriting systems]
	A left-linear rewriting system $(\X, \R)$ is \emph{well-switching} if it is strong enforcing and, for every derivation $\der{D}:=\{\dder{D}_{i}\}_{i=0}^1$, there is at most one independence pair between $\dder{D}_0$ and $\dder{D}_1$.
\end{definition}


Clearly, linear rewriting systems are well-switching (see Proposition~\ref{pr:weak}).
Moreover, we next observe that various classes of rewriting systems,
comprising all the ones used in modelling the applications to the
encoding of process calculi or of bio and chemical systems mentioned
in the introduction, are actually well-switching.

\subsubsection{Some examples of well-switching rewriting systems}

\todo{Questa sezione  da riscrivere bene}

A first class consists of those rewriting systems over
possibly hierarchical graphical structures obtained as algebras of
suitable signatures where rules are constrained not to merge elements
of top level sorts in the hierarchy (for graphs, nodes can be
merged while edges cannot). The idea here is to consider graph
structures as presheaves on categories in which there are objects that play 
the role of \emph{roots}, i.e.~objects that are not the codomain of 
any arrow besides the identity. 

\begin{definition}[Root-preserving graphical rewriting systems]
	Let $\X$ be a category, an object $X\in \X$ is a \emph{root} if the only arrow with codomain $X$ is $\id{X}$.
	The category $\gph{X}$ of \emph{$\X$-graphs} is the category
	$\Set^{\X}$. A
	\emph{root-preserving graphical rewriting system} is a left-linear
	rewriting system $(\gph{X}, \R)$ such that for each rule
	$(l\colon K\to L, r\colon K\to R)$ in $\R$ it holds
	\begin{enumerate}
		\item for every $X\in \X$ and $x\in L(X)$, there exists a root $Y$
		and an arrow $f\colon Y\to X$ such that $x$ belongs to the image of
		$L(f)\colon L(Y)\to L(X)$;
		\item $r\colon K\to R$ is mono on the roots, i.e.~for every root $X\in \X$ the component $r_X:K(X)\to R(X)$ is injective.
	\end{enumerate}
\end{definition}

For instance, the category $\cat{Graph}$ can be obtained
by taking as $\X$ the category generated by $E \rightrightarrows V$. In this case $E$ is the only root, hence, condition $1$ asks that in the left-hand side of each rule
there are no isolated nodes, while condition $2$ asks that the
morphism $r: K \to R$ is injective on edges, i.e.~it can only merge nodes.

\begin{lemma}{lemma}{lemVTame}
	\label{bono}
	All root-preserving graphical rewriting systems are well-switching.
\end{lemma}

Another interesting class of well-switching rewriting systems is given by e-graphs.

\begin{example}[E-graphs]
	Consider the category $\cat{EGraphs}$, where objects are (directed)
	graphs endowed with an equivalence over nodes, and arrows are graph
	morphisms that preserve the equivalence, as considered
	in~\cite{BaldanGM06}, closely related to e-graphs~\cite{WNW:egg}. 
	Formally, $\cat{EGraphs}$ can be seen as the
	subcategory of the presheaf
	$[E \rightrightarrows V \to Q, \cat{Set}]$ where objects are
	constrained to have the component $V \to Q$ surjective. 
	
	Explicitly, an
	e-graph $G$ is a triple $\langle s_G, t_G, q_G \rangle$ where
	$s_G, t_G: E_G \rightrightarrows V_G$ provides the graphical
	structure, while the surjective function $q_G : V_G \to Q_G$ maps
	each node to the corresponding equivalence class. 
	Notice that the inclusion functor into  $[E \rightrightarrows V \to Q, \cat{Set}]$ 
	creates pullbacks and pushouts \cite{mac2013categories}, so that they are computed component-wise.
	
	A morphism in $\cat{EGraph}$ is mono if the components over $E$
	and $V$ are mono, i.e.~if it is mono as a morphism in
	$\cat{Graph}$. It is regular mono if also the component on
	$Q$ is mono, i.e.~if it reflects equivalence classes besides
	preserving them. This characterisation of regular monos and the fact that pullbacks and pushouts are computed component-wise allows us to prove quasi-adhesivity of $\cat{EGraphs}$ at once. Moreover, one can deduce that every rewriting system $(\X, \R)$ that is left-linear with respect to $\reg(\cat{EGraphs})$ is strong enforcing: this is done exploiting again the inclusion functor into $[E \rightrightarrows V \to Q, \cat{Set}]$.
	
	Left-linear rewriting systems with respect to $\reg(\cat{EGraphs})$ are well-switching. They have been used in~\cite{BaldanGM06} for the graphical implementation of nominal calculi, where,
	differently from~\cite{Gad07}, as a result of name passing the received name is not merged with a local one, but put in the same equivalence class, better tracing the causal dependencies among reductions.
\end{example}


\section{Switch equivalence and concatenable traces}
\todo{intro}


As we mentioned, for linear rewriting systems
it is canonical to identify
derivations that are equal ``up to switching'', i.e.~that differ
only in the order of independent steps. The same notion can be given
for left-linear rewriting systems by relying on the notion of switch.

We  recall some notations on permutations.  A \emph{permutation} on
$\interval[0]{n}$ is a bijection
$\sigma : \interval[0]{n} \to \interval[0]{n}$. It is a
\emph{transposition} $\nu$ if there are $i, j \in \interval{n}$,
$i \neq j$ such that $\sigma(i)=j$, $\sigma(j) = i$, and
$\sigma(k) = k$ otherwise; it is denoted as $\transp{i}[j]$. Given a permutation $\perm$, 
an \emph{inversion} for $\sigma$ is a pair $(i,j)$ such that $i<j$ and
$\sigma(j)< \sigma(i)$; $\inv{\sigma}$ denotes the set of
inversions of $\perm$.

Switch equivalence is now defined as the equivalence relating derivations that 
can be obtained one from another by a sequence of switches. Moreover, intermediate graphs can be taken up to isomorphism according to abstraction equivalence.

\begin{definition}[Switching sequence]
	\label{de:switch-equivalence}
	Let $(\X, \R)$ be a left-linear rewriting system.  Let also
	$\der{D}, \der{E} : G \Mapsto H$ be derivations with the same
	length, $\der{D}=\{\dder{D}_{i}\}_{i=0}^n$ and
	$\der{E}=\{\dder{E}_{i}\}_{i=0}^n$. If
	$\dder{D}_i \cdot \dder{D}_{i+1}$ is a switch of
	$\dder{E}_i \cdot \dder{E}_{i+1}$ for some $i \in [0,n-1]$ and  $\dder{D}_j = \dder{E}_j$ for each $j \not \in \{i,i+1\}$ then we write
	$\der{D} \shift{\transp{i}} \der{E}$. 
	A \emph{switching sequence} is a sequence $\{\der{D}_{k}\}_{k=0}^m$
	of derivations such that
	$\der{D}_0 \shift{\nu_1} \der{D}_1 \shift{\nu_2} \ldots
	\shift{\nu_m} \der{D}_m$  with $\nu_{k} = \transp{i_k}$.
	
	Let us denote by $\nu_{k,h}$ the composition
	$\nu_h \circ \nu_{h-1} \circ \ldots \nu_k$. We say that the
	switching sequence \emph{consists of inversions} if for all
	$k \in \interval[0]{m}$ the transposition $\nu_k$ is an inversion
	for $\nu_{1,m}$.
	
	Two derivations $\der{D}, \der{E}:G\Mapsto H$ are \emph{switch
		equivalent}, written $\der{D}\equiv^{sh} \der{E}$, if there is a
	switching sequence $\{\der{D}_{k}\}_{k=0}^m$ such that
	$\der{D}\equiv_a \der{D}_0 \shift{\nu_1} \der{D}_1 \shift{\nu_2}
	\ldots \shift{\nu_m} \der{D}_m \equiv _a \der{E}$.   
	To point out a chosen permutation of rewriting steps, we will also write $\der{D}\equiv^{sh}_{\sigma} \der{E}$, 
	where $\sigma$ is the composition of the transposition appearing in a chosen switching sequence. 
\end{definition}

\todo{Consistent permutations from switchings}

\subsection{A canonical form for switching sequences} 

As a beginning step in our analysis of switch equivalence, we will establish three lemmas  dealing with derivations of length $3$. 


\begin{lemma}[Forward $3$-steps Lemma]\label{lem:primo}
Let $(\X,\R)$ be a left-linear DPO-rewriting system. Consider a derivation $\der{D}=\{\dder{D}_i\}_{i=0}^2$ and suppose that $(i_0,i_1)$ is a good independence pair between $\dder{D}_0$ and $\dder{D}_1$, $(a_0,a_1)$ one between $\dder{D}_1$ and $\dder{D}_2$ and $(e_0, e_1)$ one between $\dder{D}_0$ and $S_{a_0,a_1}(\dder{D}_2)$.
\end{lemma}
\begin{proof}
	contenuto...
\end{proof}


\begin{lemma}[Backward $3$-steps Lemma]\label{lem:secondo}
	contenuto...
\end{lemma}
\begin{proof}
	contenuto...
\end{proof}



\begin{lemma}[Third $3$-steps Lemma]\label{lem:terzo}
	contenuto...
\end{lemma}
\begin{proof}
	contenuto...
\end{proof}


\todo{dividere in due il lemma dopo. devono venire tre lemmi}
\begin{lemma}[Three steps Lemma]\label{lem:iig1}Let $(\X,\R)$ be a left-linear DPO-rewriting system with $\X$ an $\mathcal{M}$-adhesive category. Consider a derivation $\der{D}=\{\dder{D}_i\}_{i=0}^2$ and suppose that $(i_0,i_1)$ is a good independence pair between $\dder{D}_0$ and $\dder{D}_1$, $(a_0,a_1)$ one between $\dder{D}_1$ and $\dder{D}_2$ and $(e_0, e_1)$ one between $\dder{D}_0$ and $S_{a_0,a_1}(\dder{D}_2)$. Then the following properties hold true.
	\begin{enumerate}
		\item $S_{e_0,e_1}(\dder{D}_0)$ and $S_{a_0,a_1}(\dder{D}_1)$ are weakly sequentially independent.
		\item If $S_{i_0, i_1}(\dder{D}_0)\updownarrow_! \dder{D}_2$ with a good independence pair $(\alpha_0, \alpha_1)$, then  $S_{i_0,i_1}(\dder{D}_1)$ and $S_{\alpha_0, \alpha_1}(\dder{D}_2)$ are weakly sequentially independent.
	\end{enumerate}
	
\end{lemma}
\begin{proof}  As a preliminary step, we are going to use \Cref{def:filler,def:switch} to get some diagrams.  First of all, let $(v,v')$ be the filler between $\dder{D}_0$ and $\dder{D}_1$ associated to $(i_0, i_1)$, then we have
	\[\xymatrix{&&R_0 \ar@/_1cm/[ddrr]_(.35){i_0}|(.7)\hole \ar[dr]^{h_0}&& L_1\ar@/^1cm/[ddll]^(.35){i_1}  \ar[dl]_{m_1}\\&K_0\ar[dr]^{k_0}\ar[dl]_{l_0} \ar@/_.8cm/[ddrr]|(.36)\hole^(.65){v}\ar[ur]^{r_0}&& G_1 && K_1 \ar@/^.8cm/[ddll]|(.36)\hole_(.65){v'}\ar[dl]_{k_1}\ar[lu]_{l_1} \ar[dr]^{r_1}\\L_0 \ar@/_.8cm/[ddrr]_(.2){j_0}|(.31)\hole|(.81)\hole \ar[dr]^(.4){m_0}|(.61)\hole && D_0 \ar[dl]|(.4)\hole_(.65){f_0}\ar[ur]|(.5)\hole^(.7){g_0}&&D_1 \ar[dr]|(.4)\hole^(.65){g_1} \ar[ul]|(.5)\hole_(.65){f_1}&&R_1\ar@/^.8cm/[ddll]^(.2){j_1}|(.31)\hole|(.81)\hole\ar[dl]_{h_1}|(.6)\hole\\&G_0 &&P_1\ar[dr]_{q_1} \ar[dl]^{q_0}\ar[ur]^(.4){p_1}\ar[ul]_(.4){p_0}&&G_2\\L_1 \ar@/^.8cm/[uurr]^(.2){i_1} \ar[ur]_(.35){f_0\circ i_1}|(.61)\hole&&Q_0 \ar[ul]|(.4)\hole_(.65){s_0}\ar[dr]|(.5)\hole^(.65){t_0} &&Q_1\ar[ur]|(.4)\hole^(.65){t_1} \ar[dl]|(.5)\hole_(.65){s_1} && R_0  \ar[ul]^(.35){g_1\circ i_0}|(.61)\hole\ar@/_.8cm/[uull]_(.2){i_0}\\&K_1 \ar[ur]_{q_0\circ v'} \ar[dr]_{r_1} \ar[ul]^{l_1}\ar@/^.8cm/[uurr]_(.65){v'}&&H'_1&& K_0 \ar[ur]_{r_0} \ar[ul]^{q_1\circ v} \ar[dl]^{l_0} \ar@/_.8cm/[uull]^(.65){v}\\&& R_1 \ar[ur]_{\hspace{-5pt}s_1\circ j_1}\ar@/^1cm/[uurr]^(.25){j_1}&& L_0 \ar[ul]^{t_0\circ j_0\hspace{-5pt}} \ar@/_1cm/[uull]_(.25){j_0} |(.69)\hole }\]
	
	Secondly, the filler $(u,u')$ induced by $(a_0, a_1)$ between $\dder{D}_1$ and $\dder{D}_2$ yields:
	\[
	\xymatrix{&&R_1 \ar@/_1cm/[ddrr]_(.35){a_0}|(.7)\hole \ar[dr]^{h_1}&& L_2\ar@/^1cm/[ddll]^(.35){a_1}  \ar[dl]_{m_2}\\&K_1\ar[dr]^{k_1}\ar[dl]_{l_1} \ar@/_.8cm/[ddrr]|(.36)\hole^(.65){u}\ar[ur]^{r_1}&& G_2 && K_2 \ar@/^.8cm/[ddll]|(.36)\hole_(.65){u'}\ar[dl]_{k_2}\ar[lu]_{l_2} \ar[dr]^{r_2}\\L_1 \ar@/_.8cm/[ddrr]_(.2){b_0}|(.31)\hole|(.81)\hole \ar[dr]^(.4){m_1}|(.61)\hole && D_1 \ar[dl]|(.4)\hole_(.65){f_1}\ar[ur]|(.5)\hole^(.7){g_1}&&D_2 \ar[dr]|(.4)\hole^(.65){g_2} \ar[ul]|(.5)\hole_(.65){f_2}&&R_2\ar@/^.8cm/[ddll]^(.2){b_1}|(.31)\hole|(.81)\hole\ar[dl]_{h_2}\\&G_1 &&P_2\ar[dr]_{d_1} \ar[dl]^{d_0}\ar[ur]^(.4){c_1}\ar[ul]_(.4){c_0}&&G_3\\L_2 \ar@/^.8cm/[uurr]^(.2){a_1} \ar[ur]_(.35){f_1\circ a_1}|(.61)\hole&&Q_2 \ar[ul]|(.4)\hole_(.65){x_1}\ar[dr]|(.5)\hole^(.65){y_1} &&Q_3\ar[ur]|(.4)\hole^(.65){y_2} \ar[dl]|(.5)\hole_(.65){x_2} && R_1  \ar[ul]^(.35){g_2\circ a_0}|(.61)\hole\ar@/_.8cm/[uull]_(.2){a_0}\\&K_2 \ar[ur]_{d_0\circ u'} \ar[dr]_{r_2} \ar[ul]^{l_2}\ar@/^.8cm/[uurr]_(.65){u'}&&G'_2&& K_1 \ar[ur]_{r_1} \ar[ul]^{d_1\circ u} \ar[dl]^{l_1} \ar@/_.8cm/[uull]^(.65){u}\\&& R_2 \ar[ur]_{\hspace{-5pt}x_2\circ b_1}\ar@/^1cm/[uurr]^(.25){b_1}&& L_1 \ar[ul]^{y_1\circ b_0\hspace{-5pt}} \ar@/_1cm/[uull]_(.25){b_0} |(.69)\hole }\]


	Finally, the filler $(w,w')$  between $\dder{D}_0$ and $S_{a_0,a_1}(\dder{D}_2)$ given by $(e_0, e_1)$ provides us with:
\[\xymatrix{&&R_0 \ar@/_1cm/[ddrr]_(.35){e_0}|(.7)\hole \ar[dr]^{h_0}&& L_2\ar@/^1cm/[ddll]^(.35){e_1}  \ar[dl]_{f_1\circ a_1}\\&K_0\ar[dr]^{k_0}\ar[dl]_{l_0} \ar@/_.8cm/[ddrr]|(.36)\hole^(.65){w}\ar[ur]^{r_0}&& G_1 && K_2 \ar@/^.8cm/[ddll]|(.36)\hole_(.65){w'}\ar[dl]_{d_0\circ u'\hspace{-5pt}}\ar[lu]_{l_2} \ar[dr]^{r_2}\\L_0 \ar@/_.8cm/[ddrr]_(.2){o_0}|(.31)\hole|(.81)\hole \ar[dr]^(.4){m_0}|(.61)\hole && D_0 \ar[dl]|(.4)\hole_(.65){f_0}\ar[ur]|(.5)\hole^(.7){g_0}&&Q_2 \ar[dr]|(.4)\hole^(.65){y_1} \ar[ul]|(.5)\hole_(.65){x_1}&&R_2\ar@/^.8cm/[ddll]^(.2){o_1}|(.31)\hole|(.81)\hole\ar[dl]_(.35){x_2\circ b_1}\\&G_0 &&P_3\ar[dr]_{n_1} \ar[dl]^{n_0}\ar[ur]^(.4){u_1}\ar[ul]_(.4){u_0}&&G'_2\\L_2 \ar@/^.8cm/[uurr]^(.2){e_1} \ar[ur]_(.35){f_0\circ e_1}|(.61)\hole&&Q_4 \ar[ul]|(.4)\hole_(.65){z_0}\ar[dr]|(.5)\hole^(.65){z'_0} &&Q_5\ar[ur]|(.4)\hole^(.65){z'_1} \ar[dl]|(.5)\hole_(.65){z_1} && R_0  \ar[ul]^(.35){y_1\circ e_0}|(.61)\hole\ar@/_.8cm/[uull]_(.2){e_0}\\&K_2 \ar[ur]_{n_0\circ w'} \ar[dr]_{r_2} \ar[ul]^{l_2}\ar@/^.8cm/[uurr]_(.65){w'}&&G'_1&& K_0 \ar[ur]_{r_0} \ar[ul]^{n_1\circ w} \ar[dl]^{l_0} \ar@/_.8cm/[uull]^(.65){w}\\&& R_2 \ar[ur]_{\hspace{-4pt}z_1\circ o_1}\ar@/^1cm/[uurr]^(.25){o_1}&& L_0 \ar[ul]^{z'_0\circ o_0\hspace{-5pt}} \ar@/_1cm/[uull]_(.25){o_0} |(.69)\hole }\]	
So equipped we can turn to the prove of our claims.	
	\begin{enumerate}
		\item We have to construct the two dotted arrows in the diagram below.
			\[\xymatrix@C=15pt{L_0 \ar[d]_{z'_0\circ o_0}&& K_0 \ar[d]_{n_1\circ w}\ar[ll]_{l_0} \ar[r]^{r_0} & R_0 \ar@{.>}@/^.35cm/[drrr]_(.4){\beta_0}|(.285)\hole \ar[dr]|(.28)\hole_{y_1\circ e_0} && L_1 \ar@{.>}@/_.35cm/[dlll]^(.4){\beta_1} \ar[dl]|(.28)\hole^{y_1\circ b_0}& K_1 \ar[d]^{d_1\circ u}\ar[l]_{l_1} \ar[rr]^{r_1} && R_1 \ar[d]^{g_2\circ a_1}\\G'_1 && \ar[ll]^{z_1} Q_5 \ar[rr]_{z'_1}&& G'_2  && \ar[ll]^{x_2} Q_3 \ar[rr]_{y_2}&& G_3}\]
			
		Consider the arrows $i_0\colon R_0\to D_1$ and $e_0\colon R_0\to Q_2$. An easy computation shows that
			\begin{align*}
				f_1\circ i_0&= h_0\\&=x_1\circ e_0
			\end{align*}
			entailing the existence of  the dotted $\beta'_0\colon R_0\to P_2$ in the diagram
			\[\xymatrix{R_0 \ar@{.>}[dr]^{\beta'_0} \ar@/^.3cm/[drr]^{i_0} \ar@/_.3cm/[ddr]_{e_0}\\ &P_2 \ar[r]^{c_1} \ar[d]_{d_0}& D_1 \ar[d]^{f_1}\\ &Q_2\ar[r]_{x_1} & G_1}\]
			If we define $\beta_0\colon R_0\to Q_3$ as $d_1\circ \beta'_1$, then we easily get that 
		\begin{align*}
			x_2\circ \beta_0&=x_2\circ d_2\circ \beta'_0\\&= y_1\circ d_0\circ \beta'_0\\&=y_1\circ e_0
		\end{align*}
		
		To define $\beta_1$, we proceed similarly. First consider  $i_1\colon L_1\to D_0$ and $b_0\colon L_1 \to Q_2$ and notice that
		\begin{align*}
			g_0\circ i_1&= m_1 \\&= x_1 \circ b_0
		\end{align*}
			implying the existence of $\beta'_1\colon L_1\to P_3$ fitting in the diagram below.
			\[\xymatrix{L_1 \ar@{.>}[dr]^{\beta'_1} \ar@/^.3cm/[drr]^{i_1} \ar@/_.3cm/[ddr]_{b_0}\\ &P_3 \ar[r]^{u_0} \ar[d]_{u_1}& D_0 \ar[d]^{g_0}\\ &Q_2\ar[r]_{x_1} & G_1}\] 
			Let $\beta_1\colon L_1\to Q_5$ be $n_1\circ \beta'_1$, then
			\begin{align*}
				z'_1 \circ \beta_1 & = z'_1 \circ n_1\circ \beta'_1\\&=y_1\circ u_1\circ \beta'_1\\&=y_1\circ b_0
			\end{align*}
		Therefore, $(\beta_0, \beta_1)$ is the wanted independence pair.
			
\item  In addition to the three diagram above, we have a fourth one given by the filler $(\varphi_0, \varphi_1)$ associated to $(\alpha_0, \alpha_1)$. 
\[\xymatrix{&&R_0 \ar@/_1cm/[ddrr]_(.35){\alpha_0}|(.7)\hole \ar[dr]^{g_1\circ i_0}&& L_2\ar@/^1cm/[ddll]^(.35){\alpha_1}  \ar[dl]_{m_2}\\
&K_0\ar[dr]^{\hspace{-4pt}q_1\circ v}\ar[dl]_{l_0} \ar@/_.8cm/[ddrr]|(.36)\hole^(.65){\varphi}\ar[ur]^{r_0}&& G_2 && K_2 \ar@/^.8cm/[ddll]|(.36)\hole_(.65){\varphi'}\ar[dl]_{k_2}\ar[lu]_{l_2} \ar[dr]^{r_2}\\
L_0 \ar@/_.8cm/[ddrr]_(.2){\gamma_0}|(.31)\hole|(.81)\hole \ar[dr]^(.4){\hspace{-4pt}t_0\circ j_0}|(.61)\hole && Q_1 \ar[dl]|(.4)\hole_(.65){s_1}\ar[ur]|(.5)\hole^(.7){t_1}&&D_2 \ar[dr]|(.4)\hole^(.65){g_2} \ar[ul]|(.5)\hole_(.65){f_2}&&R_2\ar@/^.8cm/[ddll]^(.2){\gamma_1}|(.31)\hole|(.81)\hole\ar[dl]_(.35){h_2}\\&H'_1 &&P_4\ar[dr]_{\lambda_1} \ar[dl]^{\lambda_0}\ar[ur]^(.4){\zeta_1}\ar[ul]_(.4){\zeta_0}&&G_3\\
L_2 \ar@/^.8cm/[uurr]^(.2){\alpha_1} \ar[ur]_(.35){s_1\circ \alpha_1}|(.61)\hole&&Q_6 \ar[ul]|(.4)\hole_(.65){\xi_0}\ar[dr]|(.5)\hole^(.65){\xi'_0} &&Q_7\ar[ur]|(.4)\hole^(.65){\xi'_1} \ar[dl]|(.5)\hole_(.65){\xi_1} && R_0  \ar[ul]^(.35){g_2\circ \alpha_0}|(.61)\hole\ar@/_.8cm/[uull]_(.2){\alpha_0}\\&K_2 \ar[ur]_{\lambda_0\circ \phi'} \ar[dr]_{r_2} \ar[ul]^{l_2}\ar@/^.8cm/[uurr]_(.65){\phi'}&&H'_2&& K_0 \ar[ur]_{r_0} \ar[ul]^{\lambda_1\circ \phi} \ar[dl]^{l_0} \ar@/_.8cm/[uull]^(.65){\phi}\\&& R_2 \ar[ur]_{\hspace{-4pt}\xi_1\circ \gamma_1}\ar@/^1cm/[uurr]^(.25){\gamma_1}&& L_0 \ar[ul]^{\xi'_0\circ \gamma_0\hspace{-5pt}} \ar@/_1cm/[uull]_(.25){\gamma_0} |(.69)\hole }\]	

Our aim is to construct the dotted arrow in the following diagram.
		\[\xymatrix@C=15pt{L_1 \ar[d]_{f_0\circ i_0}&& K_1 \ar[d]_{q_0\circ v'}\ar[ll]_{l_1} \ar[r]^{r_1} & R_1 \ar@{.>}@/^.35cm/[drrr]_(.4){\epsilon_0}|(.285)\hole \ar[dr]|(.28)\hole_{s_1\circ j_1} && L_2 \ar@{.>}@/_.35cm/[dlll]^(.4){\epsilon_1} \ar[dl]|(.28)\hole^{s_1\circ \alpha_1}& K_2 \ar[d]^{\lambda_0\circ \phi'}\ar[l]_{l_2} \ar[rr]^{r_2} && R_2 \ar[d]^{\xi_1\circ \gamma_1}\\G_0 && \ar[ll]^{s_0} Q_0 \ar[rr]_{t_0}&& H'_1  && \ar[ll]^{\xi_0} Q_6 \ar[rr]_{\xi'_0}&& H'_2}\]

Let us start considering $j_1\colon R_1\to Q_1$ and $a_0\colon R_1\to D_2$. We have
\begin{align*}
	f_2\circ a_0&=h_1\\&=t_1\circ j_1
\end{align*}
and thus we get an arrow $\epsilon'_0\colon R_1\to P_4$ which makes the diagram below commutative.
			\[\xymatrix{R_1 \ar@{.>}[dr]^{\epsilon'_0} \ar@/^.3cm/[drr]^{j_1} \ar@/_.3cm/[ddr]_{a_0}\\ &P_4 \ar[r]^{\zeta_0} \ar[d]_{\zeta_1}& Q_1 \ar[d]^{t_1}\\ &D_2\ar[r]_{f_2} & G_2}\] 
We can then define $\epsilon_0\colon R_1\to Q_6$ to be $\lambda_0\circ \epsilon'_0$. For such an arrow we have a chain of identities:
\begin{align*}
	\xi_0\circ \epsilon_0&=\xi_0\circ \lambda_0\circ \epsilon'_0\\&=s_1\circ \zeta_0 \circ \epsilon'_0\\&=s_1\circ j_1
\end{align*}

Next, to define $\epsilon_1\colon L_2\to Q_0$ we take $e_1\colon L_2 \to D_0$ and $a_1\colon L_2\to D_1$. By definition we have $	g_0\circ e_1=f_1\circ a_1$, giving us the dotted arrow below
	\[\xymatrix{L_2 \ar@{.>}[dr]^{\epsilon'_1} \ar@/^.3cm/[drr]^{a_1} \ar@/_.3cm/[ddr]_{e_0}\\ &P_1 \ar[r]^{p_1} \ar[d]_{p_0}& D_1 \ar[d]^{f_1}\\ &D_0\ar[r]_{g_0} & G_1}\] 
Now, notice that 
\begin{align*}
	t_1\circ q_1\circ \epsilon'_1&=g_1\circ p_1\circ \epsilon'_1&=g_1\circ a_1\\&=m_2
\end{align*}
Hence $(\alpha_0, q_1\circ \epsilon'_1)$ is an independence pair for $S_{i_0, i_1}(\dder{D}_0)$ and $\dder{D}_2$. By hypothesis $S_{i_0, i_1}(\dder{D}_0)\updownarrow_! \dder{D}_2$ and thus $q_1\circ \epsilon'_1$ must coincide with $\alpha_1$. Now, let $\epsilon_1\colon L_2\to Q_0$ be $q_0\circ \epsilon'_1$. Computing we get
\begin{align*}
t_0\circ \epsilon_1&= t_0\circ q_0\circ \epsilon'_1\\&=s_1\circ q_1\circ \epsilon'_1\\&=s_1\circ \alpha_1
\end{align*}
Allowing us to conclude that  $S_{i_0,i_1}(\dder{D}_1)\updownarrow S_{\alpha_0, \alpha_1}(\dder{D}_2)$.
\qedhere 
			\end{enumerate}
\end{proof}

\subsubsection{Inversions and switch equivalence}
\todo{richiamare cosa sono le inversioni}

\begin{lemma}[Fundamental Lemma] Let $(\der{D}, \alpha, \omega)$ and $(\der{D'}, \alpha, \omega)$ be two decorated derivations and suppose that there exists a non-empty sequence $\{\der{D}_i\}_{i=0}^n$ a of derivations witnessing $\der{D}\equiv^s \der{D}'$. For every $i\in [0,n-1]$, let $\nu_i\colon [0, \lgh(\der{D})-1]\to [0, \lgh(\der{D})-1]$ be the $2$-cycle associated to the switch between $\der{D}_i$ and $\der{D}_{i+1}$, let also $\sigma$ be the associated consistent permutation between $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$. Define $k$ as the maximum of the set
\[M_\sigma:=\{j\in [0, \lgh(\der{D}-1] \mid \sigma(j+1) < \sigma(j) \}\]
If every $\nu_i$ is an inversion for $\sigma$, then there exists a family $\{\nu'_i\}_{i=0}^n$ of inversions for $\sigma$ such that jj\todo{capire come scriverlo meglio, l} $\nu'_0=(k, k+1)$.
\end{lemma}
\begin{remark}
	Since $\{\der{D}_i\}_{i=0}^n$ is non-empty, then $\sigma$ must be different from $\id{[0, \lgh(\der{D}-1)]}$ and $M_{\sigma}\neq \emptyset$.
\end{remark}
\begin{proof}
	We proceed by induction on $n$.
	
	\smallskip\noindent $n=1$. In this case there is nothing to prove.
	
	\smallskip \noindent $n>1$. Then...
\end{proof}

\begin{corollary}
	contenuto...
\end{corollary}
\begin{proof}
	contenuto...
\end{proof}


\begin{corollary}
	contenuto...
\end{corollary}
\begin{proof}
	contenuto...
\end{proof}



\begin{corollary}
	contenuto...
\end{corollary}
\begin{proof}
	contenuto...
\end{proof}


\begin{corollary}[No need for useless shifts]
	contenuto...
\end{corollary}
\begin{proof}
	contenuto...
\end{proof}
\newpage


NOTES ON THE FUNDAMENTAL LEMMA WE NEED\todo{da integrare sopra}

Everything is very tame, so that sequential independence coincides with switchability and we do not have ambiguity in the choice of an independence pair


We start with the following situation.
	\[\xymatrix@C=15pt{L_0\ar[d]_{m_0}&& K_0 \ar[d]_{k_0}\ar[ll]_{l_0} \ar[r]^{r_0} & R_0 \ar@/^.35cm/[drrr]_(.4){i_0}|(.285)\hole \ar[dr]|(.28)\hole_{h_0} && L_1 \ar@/_.35cm/[dlll]^(.4){i_1} \ar[dl]|(.28)\hole^{m_1}& K_1 \ar[d]^{k_1}\ar[l]_{l_1} \ar[r]^{r_1} & R_1 \ar[dr]|(.28)\hole_{h_1} \ar@/^.35cm/[drrr]_(.4){j_0}|(.285)\hole  && L_2 \ar@/_.35cm/[dlll]^(.4){j_1} \ar[dl]|(.28)\hole^{m_2}& K_2 \ar[d]^{k_2}\ar[l]_{l_2} \ar[rr]^{r_2} && R_2 \ar[d]^{h_2} \\G_0 && \ar[ll]^{f_0} D_0 \ar[rr]_{g_0}&& G_1  && \ar[ll]^{f_1} D_1 \ar[rr]_{g_1}&& G_2 && \ar[ll]^{f_2} D_2 \ar[rr]_{g_2}&& G_3 }\]
	
	We can do two things:
	
	FIRST SEQUENCE OF SWITCHINGS:
	
	Switch the first two
	

	\[\xymatrix@C=15pt{L_1\ar[d]_{f_0\circ i_1}&& K_1 \ar[d]_{k'_1}\ar[ll]_{l_1} \ar[r]^{r_1} & R_1 \ar@/^.35cm/[drrr]_(.4){a_0}|(.285)\hole \ar[dr]|(.28)\hole_{h'_1} && L_0 \ar@/_.35cm/[dlll]^(.4){a_1} \ar[dl]|(.28)\hole^{m'_0}& K_0 \ar[d]^{k'_0}\ar[l]_{l_0} \ar[r]^{r_0} & R_0 \ar[dr]|(.28)\hole_{g_1\circ j_0} \ar@/^.35cm/[drrr]_(.4){b_0}|(.285)\hole  && L_2 \ar@/_.35cm/[dlll]^(.4){b_1} \ar[dl]|(.28)\hole^{m_2}& K_2 \ar[d]^{k_2}\ar[l]_{l_2} \ar[rr]^{r_2} && R_2 \ar[d]^{h_2} \\G_0 && \ar[ll]^{f'_0} D'_0 \ar[rr]_{g'_0}&& G'_1  && \ar[ll]^{f'_1} D'_1 \ar[rr]_{g'_1}&& G_2 && \ar[ll]^{f_2} D_2 \ar[rr]_{g_2}&& G_3 }\]
	
	Moreover, we know that
	\[m_0=f'_0\circ a_1 \qquad h_1=g'_1\circ a_0\]
	
	Switch second and third 
	\[\xymatrix@C=15pt{L_1\ar[d]_{f_0\circ i_1}&& K_1 \ar[d]_{k'_1}\ar[ll]_{l_1} \ar[r]^{r_1} & R_1 \ar@/^.35cm/[drrr]_(.4){c_0}|(.285)\hole \ar[dr]|(.28)\hole_{h'_1} && L_2 \ar@/_.35cm/[dlll]^(.4){c_1} \ar[dl]|(.28)\hole^{f'_1\circ b_1}& K_2 \ar[d]^{k'_2}\ar[l]_{l_2} \ar[r]^{r_2} & R_2 \ar[dr]|(.28)\hole_{h'_2} \ar@/^.35cm/[drrr]_(.4){d_0}|(.285)\hole  && L_0 \ar@/_.35cm/[dlll]^(.4){d_1} \ar[dl]|(.28)\hole^{\hat{m}_0}& K_0 \ar[d]^{\hat{k}_0}\ar[l]_{l_0} \ar[rr]^{r_0} && R_0 \ar[d]^{g_2\circ b_0} \\G_0 && \ar[ll]^{f'_0} D'_0 \ar[rr]_{g'_0}&& G'_1  && \ar[ll]^{\hat{f}_1} \hat{D}_1 \ar[rr]_{\hat{g}_1}&& G'_2 && \ar[ll]^{f'_2} D'_2 \ar[rr]_{g'_2}&& G_3 }\]
	And we know that
	\[m'_0=\hat{f}_1\circ d_1 \qquad h_2=g'_2\circ d_0\]
	\todo{qua abbiamo usato il secondo lemma dei tre passi (quello condizionale)}Since the rewriting system is very tame and using the three steps lemmas we can characterize $c_0\colon R_1\to \hat{D}_1$ and $c_1\colon L_2\to D'_0$ as the unique arrows fitting in the diagrams
\[\xymatrix@R=15pt@C=15pt{&&R_1 \ar@/_1.2cm/[dddl]_(.4){a_0}|(.63)\hole\ar[dl]^{j_0}\ar[dd]^{c'_0} \ar@{.>}[dr]^{c_0}\\&D_2 \ar[dl]^(.4){f_2}&&\hat{D}_1 \ar[dr]^{\hat{g}_1}\\G_2 && P\ar[dr]_{p_4} \ar[ur]_{p_3}\ar[dl]^{p_1} \ar[ul]^{p_2}&&G'_2\\& D'_1 \ar[ul]^{g'_1}&&D'_2 \ar[ur]_{f'_2}}\]

\[\xymatrix@R=15pt@C=15pt{&&L_2 \ar[dl]^{j_1} \ar@/_1.2cm/[dddl]_(.4){z_1}|(.63)\hole\ar[dd]^{c'_1} \ar@{.>}[dr]^{c_1}\\&D_1 \ar[dl]^(.4){f_1}&&D'_0 \ar[dr]^{g'_0}\\G_1 && Q\ar[dr]_{q_4} \ar[ur]_{q_3}\ar[dl]^{q_1} \ar[ul]_{q_2}&&G'_1\\& D_0 \ar[ul]^{g_0}&&D'_1 \ar[ur]_{f'_1}}\]
	
	
	Switch first and second 
	\[\xymatrix@C=15pt{L_2\ar[d]_{f'_0\circ c_1}&& K_2 \ar[d]_{\hat{k}_2}\ar[ll]_{l_2} \ar[r]^{r_2} & R_2 \ar@/^.35cm/[drrr]_(.4){e_0}|(.285)\hole \ar[dr]|(.28)\hole_{\hat{h}_2} && L_1 \ar@/_.35cm/[dlll]^(.4){e_1} \ar[dl]|(.28)\hole^{\hat{m}_1}& K_1 \ar[d]^{\hat{k}_1}\ar[l]_{l_1} \ar[r]^{r_1} & R_1 \ar@/^.35cm/[drrr]_(.4){t_0} \ar[dr]|(.28)\hole_{\hat{g}_1\circ c_0}   && L_0  \ar[dl]|(.28)\hole^{\hat{m}_0} \ar@/_.35cm/[dlll]^(.4){t_1}& K_0 \ar[d]^{\hat{k}_0}\ar[l]_{l_0} \ar[rr]^{r_0} && R_0 \ar[d]^{g_2\circ b_0} \\G_0 && \ar[ll]^{\hat{f}_0} \hat{D}_0 \ar[rr]_{\hat{g}_0}&& \hat{G}_1  && \ar[ll]^{\tilde{f}_1} \tilde{D}_1 \ar[rr]_{\tilde{g}_1}&& G'_2 && \ar[ll]^{f'_2} D'_2 \ar[rr]_{g'_2}&& G_3 }\]
	Moreover
	\[f_0\circ i_1=\hat{f}_0\circ e_1 \qquad h'_2=\tilde{g}_1\circ e_0\]
	and $(t_0, t_1)$ is characterized using again very tameness and the first $3$-steps Lemma as the unique arrows fitting in:
	\[\xymatrix{&R_1 \ar[dl]_{a_0} \ar@{.>}[dr]^{t_0} \ar@/^.4cm/[dd]|\hole^(.6){c_0}\ar[d]_{t'_0}\\ D'_1 \ar[d]_{g'_1}&P\ar[d]_{p_3} \ar[r]^{p_4} \ar[l]_{p_1}&D'_2\ar[d]^{f'_2}\\G'_1&\hat{D}_1 \ar[l]^{\hat{f}_1}\ar[r]_{\hat{g}_1}& G'_2}\]
	
	
	
	\[\xymatrix@R=15pt@C=15pt{&&L_ 0\ar[dl]^{a_1} \ar@/_1.2cm/[dddl]_(.4){d_1}|(.63)\hole\ar[dd]^{t'_1} \ar@{.>}[dr]^{t_1}\\&D'_0 \ar[dl]^(.4){g'_0}&&\tilde{D}_1 \ar[dr]^{\tilde{f}_1}\\G'_1 && S\ar[dr]_{s_4} \ar[ur]_{s_3}\ar[dl]^{s_1} \ar[ul]_{s_2}&&\hat{G}_1\\& \hat{D}_1 \ar[ul]^{\hat{f}_1}&&\hat{D}_0 \ar[ur]_{\hat{g}_0}}\]
	

	SECOND SEQUENCE OF SWITCHINGS:

	Switch third and second
	
	
	\[\xymatrix@C=15pt{L_0\ar[d]_{m_0}&& K_0 \ar[d]_{k_0}\ar[ll]_{l_0} \ar[r]^{r_0} & R_0 \ar@/^.35cm/[drrr]_(.4){z_0}|(.285)\hole \ar[dr]|(.28)\hole_{h_0} && L_2 \ar@/_.35cm/[dlll]^(.4){z_1} \ar[dl]|(.28)\hole^{f_1\circ j_1}& K_2 \ar[d]^{\check{k}_2}\ar[l]_{l_2} \ar[r]^{r_2} & R_2 \ar[dr]|(.28)\hole_{\check{h}_2} \ar@/^.35cm/[drrr]_(.4){w_0}|(.285)\hole  && L_1 \ar@/_.35cm/[dlll]^(.4){w_1} \ar[dl]|(.28)\hole^{\check{m}_1}& K_1 \ar[d]^{\check{k}_1}\ar[l]_{l_1} \ar[rr]^{r_1} && R_1\ar[d]^{g_2\circ j_0} \\G_0 && \ar[ll]^{f_0} D_0 \ar[rr]_{g_0}&& G_1  && \ar[ll]^{\check{f}_1} \check{D}_1 \ar[rr]_{\check{g}_1}&& \check{G}_2 && \ar[ll]^{\check{f}_2} \check{D}_2 \ar[rr]_{\check{g}_2}&& G_3 }\]
	Moreover
	\[m_1=\check{f}_1\circ w_1 \qquad h_2=\check{g}_2\circ w_0\]
	
	Switch second and first
		\[\xymatrix@C=15pt{L_2\ar[d]_{f_0\circ z_1}&& K_2 \ar[d]_{\mathring{k}_2}\ar[ll]_{l_2} \ar[r]^{r_2} & R_2 \ar@/^.35cm/[drrr]_(.4){y_0}|(.285)\hole \ar[dr]|(.28)\hole_{\mathring{h}_2} && L_0 \ar@/_.35cm/[dlll]^(.4){y_1} \ar[dl]|(.28)\hole^{\check{m}_0}& K_0 \ar[d]^{\check{k}_0}\ar[l]_{l_0} \ar[r]^{r_0} & R_0 \ar[dr]|(.28)\hole_{\check{g}_1\circ z_0} \ar@/^.35cm/[drrr]_(.4){x_0}|(.285)\hole  && L_1 \ar@/_.35cm/[dlll]^(.4){x_1} \ar[dl]|(.28)\hole^{\check{m}_1}& K_1 \ar[d]^{\check{k}_1}\ar[l]_{l_1} \ar[rr]^{r_1} && R_1\ar[d]^{g_2\circ j_0} \\G_0 && \ar[ll]^{\check{f}_0} \check{D}_0 \ar[rr]_{\check{g}_0}&& \check{G}_1  && \ar[ll]^{\mathring{f}_1} \mathring{D}_1 \ar[rr]_{\mathring{g}_1}&& \check{G}_2 && \ar[ll]^{\check{f}_2} \check{D}_2 \ar[rr]_{\check{g}_2}&& G_3 }\]
	As before we have
	\[m_0=\check{f}_0\circ y_1 \qquad \check{h}_2=\mathring{g}_1\circ y_0\]
	The really important thing to notice is that, by very tameness we have
	\begin{align*}
		f_0'\circ c_1&=f'_0\circ q_3\circ c'_1\\&=f_0\circ q_1\circ c'_1\\&=f_0\circ z_1
	\end{align*}
	
	\todo{GOOD! i primi match sono uguali, ora giochiamoci il primo lemma dei tre passi}
	
	Switch second and third
\[\xymatrix@C=15pt{L_2\ar[d]_{f_0\circ z_1}&& K_2 \ar[d]_{\mathring{k}_2}\ar[ll]_{l_2} \ar[r]^{r_2} & R_2 \ar@/^.35cm/[drrr]_(.4){v_0}|(.285)\hole \ar[dr]|(.28)\hole_{\mathring{h}_2} && L_1 \ar@/_.35cm/[dlll]^(.4){v_1} \ar[dl]|(.28)\hole^{\mathring{f}_1 \circ x_1}& K_1 \ar[d]^{\mathring{k}_1}\ar[l]_{l_1} \ar[r]^{r_1} & R_1 \ar@/^.35cm/[drrr]_(.4){u_0}|(.285)\hole\ar[dr]_{\check{h}_1}   && L_0 \ar@/_.35cm/[dlll]^(.4){u_1} \ar[dl]^{\mathring{m}_0}& K_0 \ar[d]^{\mathring{k}_0}\ar[l]_{l_0} \ar[rr]^{r_0} && R_0\ar[d]^{\check{g}_2\circ x_0} \\G_0 && \ar[ll]^{\check{f}_0} \check{D}_0 \ar[rr]_{\check{g}_0}&& \check{G}_1  && \ar[ll]^{\bar{f}_1} \bar{D}_1 \ar[rr]_{\bar{g}_1}&& \bar{G}_2 && \ar[ll]^{\bar{f}_2} \bar{D}_2 \ar[rr]_{\bar{g}_2}&& G_3 }\]

\[\xymatrix@R=15pt@C=15pt{&&R_1 \ar@/_1.2cm/[dddl]_(.4){a_0}|(.63)\hole\ar[dl]^{j_0}\ar[dd]^{c'_0} \ar@{.>}[dr]^{c_0}\\&D_2 \ar[dl]^(.4){f_2}&&\hat{D}_1 \ar[dr]^{\hat{g}_1}\\G_2 && P\ar[dr]_{p_4} \ar[ur]_{p_3}\ar[dl]^{p_1} \ar[ul]^{p_2}&&G'_2\\& D'_1 \ar[ul]^{g'_1}&&D'_2 \ar[ur]_{f'_2}}\]

\[\xymatrix@R=15pt@C=15pt{&&L_1 \ar[dl]^{w_1} \ar@/_1.2cm/[dddl]_(.4){i_1}|(.63)\hole\ar[dd]^{v'_1} \ar@{.>}[dr]^{v_1}\\&\check{D}_1 \ar[dl]^(.4){\check{f}_1}&&\check{D}_0 \ar[dr]^{g'_0}\\G_1 && \check{Q}\ar[dr]_{\check{q}_4} \ar[ur]_{\check{q}_3}\ar[dl]^{\check{q}_1} \ar[ul]_{\check{q}_2}&&\check{G}_1\\& D_0 \ar[ul]^{g_0}&&\mathring{D}_1 \ar[ur]_{\check{f}_1}}\]




HUGE DIAGRAMF


\[\xymatrix@C=15pt{
  & K_1 \ar[d]^{\hat{k}_1}\ar[l]_{l_1} \ar[r]^{r_1} & R_1 \ar@/^.35cm/[drrr]_(.4){t_0} \ar[dr]|(.28)\hole_{\hat{g}_1\circ c_0}   && L_0  \ar[dl]|(.28)\hole^{\hat{m}_0} \ar@/_.35cm/[dlll]^(.4){t_1}& K_0 \ar[d]^{\hat{k}_0}\ar[l]_{l_0} \ar[rr]^{r_0} && R_0 \ar[d]^{g_2\circ b_0} \\G_0 && \ar[ll]^{\hat{f}_0} \hat{D}_0 \ar[rr]_{\hat{g}_0}&& \hat{G}_1  && \ar[ll]^{\tilde{f}_1} \tilde{D}_1 \ar[rr]_{\tilde{g}_1}&& G'_2 && \ar[ll]^{f'_2} D'_2 \ar[rr]_{g'_2}&& G_3 \\
	L_2\ar[d]_{f_0\circ z_1} \ar[u]^{f'_0\circ c_1}&& K_2 \ar[d]_{\mathring{k}_2}\ar[ll]_{l_2} \ar[r]^{r_2} & R_2 \ar@/_.35cm/[urrr]^(.4){e_0}|(.285)\hole \ar[ur]|(.28)\hole^{\hat{h}_2} \ar@/^.35cm/[drrr]_(.4){v_0}|(.285)\hole \ar[dr]|(.28)\hole_{\mathring{h}_2} && L_1 \ar@/^.35cm/[ulll]_(.4){e_1} \ar[ul]|(.28)\hole_{\hat{m}_1} \ar@/_.35cm/[dlll]^(.4){v_1} \ar[dl]|(.28)\hole^{\mathring{f}_1 \circ x_1}& K_1 \ar[d]^{\mathring{k}_1}\ar[l]_{l_1} \ar[r]^{r_1} & R_1 \ar@/^.35cm/[drrr]_(.4){u_0}|(.285)\hole\ar[dr]_{\check{h}_1}   && L_0 \ar@/_.35cm/[dlll]^(.4){u_1} \ar[dl]^{\mathring{m}_0}& K_0 \ar[d]^{\mathring{k}_0}\ar[l]_{l_0} \ar[rr]^{r_0} && R_0\ar[d]^{\check{g}_2\circ x_0} \\G_0 && \ar[ll]^{\check{f}_0} \check{D}_0 \ar[rr]_{\check{g}_0}&& \check{G}_1  && \ar[ll]^{\bar{f}_1} \bar{D}_1 \ar[rr]_{\bar{g}_1}&& \bar{G}_2 && \ar[ll]^{\bar{f}_2} \bar{D}_2 \ar[rr]_{\bar{g}_2}&& G_3 }\]

Now, by determinism we have isomorphisms $\phi_{\check{D}_0}\colon \check{D}_0\to \hat{D}_0$ $\phi_{\check{G}_1}\colon \check{G}_1\to \hat{G}_1$
Notice that
\begin{align*}
	\hat{f}_0\circ \phi_{\check{D}_0}\circ v_1&= \check{f}_0\circ v_1\\&=\check{f}_0\circ \check{q}_3\circ v'_1\\&=f_0\circ \check{q}_1\circ v'_1\\&=f_0\circ i_1\\&=\hat{f}_0\circ e_1
\end{align*}

GOOD: $\phi_{\check{D}_0}$ sends $v_1$ to $e_1$, thus it respects the match of $L_1$. Automatically it sends $v_0$ to $e_0$.

CHECK THAT $\check{g}_2\circ x_0=g_2\circ j_0$

USO IL PRIMO LEMMA DEI TRE PASSI:

	\[\xymatrix{&R_0 \ar[dl]_{i_0} \ar@{.>}[dr]^{x_0} \ar@/^.4cm/[dd]|\hole^(.6){j_0}\ar[d]_{x'_0}\\ D_1 \ar[d]_{g_1}&P'\ar[d]_{p'_3} \ar[r]^{p'_4} \ar[l]_{p'_1}&\check{D}_2\ar[d]^{\check{g}_2}\\G_2&D_2 \ar[l]^{f_2}\ar[r]_{g_2}& G_3}\]



\[\xymatrix@R=15pt@C=15pt{&&L_ 0\ar[dl]^{I_1} \ar@/_1.2cm/[dddl]_(.4){d_1}|(.63)\hole\ar[dd]^{t'_1} \ar@{.>}[dr]^{t_1}\\&D'_0 \ar[dl]^(.4){g'_0}&&\tilde{D}_1 \ar[dr]^{\tilde{f}_1}\\G'_1 && S\ar[dr]_{s_4} \ar[ur]_{s_3}\ar[dl]^{s_1} \ar[ul]_{s_2}&&\hat{G}_1\\& \hat{D}_1 \ar[ul]^{\hat{f}_1}&&\hat{D}_0 \ar[ur]_{\hat{g}_0}}\]

\section{Switch equivalence and concatenable traces}

\begin{lemma}
	\todo{abstract equivalence and switch }
\end{lemma}
\begin{proof}
	contenuto...
\end{proof}
\begin{definition}
	\todo{tracce}
\end{definition}

Before moving forward, we will prove some other useful properties of the switch equivalence relation.

\begin{lemma}
	\todo{lemma 19}
\end{lemma}
\begin{proof}
	contenuto...
\end{proof}


\begin{theorem}
	\todo{preordine}
\end{theorem}
\begin{proof}
	contenuto...
\end{proof}




\section{A class of well-behaved left-linear DPO rewriting systems}
