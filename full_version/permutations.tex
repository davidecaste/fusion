\chapter{DPO-rewriting and derivations}

$\mathcal{M}$-adhesive categories are the right context in which to perform abstract rewriting using the so-called ``douple pushout approach'' (DPO). We will recall the basic definitions and properties of this approach to abstract rewriting. 

\section{Left-linear DPO-rewriting systems}
We are now going to study rewriting systems in $\mathcal{M}$-adhesive categories.

\begin{definition}[\cite{habel2012mathcal,heindel2009category}]
	Let $\X$ be an $\mathcal{M}$-adhesive category, a  \emph{left $\mathcal{M}$-linear} rule $\rho$ is a pair $(l,r)$ of arrows with the same domain, such that $l$ belongs to $\mathcal{M}$.  The rule $\rho$ is said to be \emph{$\mathcal{M}$-linear} if $r\in \mathcal{M}$ too. A rule $\rho$ is said to be \emph{consuming} if $l$ is not an isomorphism. We will represent a rule $\rho$ as a span 
	\[\xymatrix{L & K\ar[l]_{l} \ar[r]^{r} & R}\]
$L$ is the \emph{left-hand side}, $R$ is the \emph{right-hand side} and $K$ the \emph{glueing object}. 


A \emph{left-linear DPO-rewriting system} is a pair $(\X, \R)$ where $\X$ is a $\mathcal{M}$-adhesive category and $R$ is a set of left $\mathcal{M}$-linear rules. $(\X, \R)$ will be called \emph{linear} if every rule in $R$ is $\mathcal{M}$-linear. Similarly, a \emph{consuming} left-linear DPO-rewriting system is one in which every rule is consuming.

Given  two objects $G$ and $H$ and a rule $\rho=(l,r)$ in $\R$, a \emph{direct derivation $\mathscr{D}$ from $G$ to $H$ applying the rule $\rho$}, is a diagram as the one below, in which both squares are pushouts. 
	\[\xymatrix{L \ar[d]_{n}& K \ar[d]^{k}\ar[l]_{l} \ar[r]^{r} & R \ar[d]^{h}\\G & \ar[l]^{f} D \ar[r]_{g}& H}\]
	The arrow $n$ is called the \emph{match} of the derivation, while $h$ is its \emph{back-match}.
	We will denote a direct derivation $\dder{D}$ between $G$ and $H$ as $\dder{D}\colon G\Mapsto H$. 
\end{definition}

\begin{example}\todo{
esempi di	derivazione}
\end{example}

\begin{remark}\label{exa:conc} Let  $\dder{D}\colon G\Mapsto H$ be the direct derivation 
		\[\xymatrix{L \ar[d]_{n}& K \ar[d]^{k}\ar[l]_{l} \ar[r]^{r} & R \ar[d]^{h}\\G & \ar[l]^{f} D \ar[r]_{g}& H}\]
	If $\phi\colon G'\to G$ and $\psi\colon H\to H'$ are two isomorphisms, 	we can consider the direct derivation	$\phi * \dder{D}*\psi \colon G'\Mapsto H'$ given by the following diagram.
	\[\xymatrix{L \ar[d]_{\phi^{-1} \circ n}& K \ar[d]^{k}\ar[l]_{l} \ar[r]^{r} & R \ar[d]^{\psi \circ h}\\G' & \ar[l]^{\phi^{-1} \circ f} D \ar[r]_{\psi \circ g}& H'}\]
	
	In particular, we will use $\phi*\dder{D}$ and $\dder{D}*\psi$  to denote $\phi*\dder{D}*\id{H}$ and $\id{G}*\dder{D}*\psi$.
\end{remark}

$\mathcal{M}$-adhesivity of $\X$ guarantes the essential uniqueness of the result obtained rewriting an object, as shown by the next proposition.

\begin{proposition}\label{prop:unique} Let $\X$  be a $\mathcal{M}$-adhesive category. Suppose that the two direct derivations $\mathscr{D}$ and $\mathscr{D'}$ below, with the same match and applying the same left $\mathcal{M}$-linear rule $\rho$ are given.
	\[\xymatrix{L \ar[d]_{m}& K \ar[d]^{k}\ar@{>->}[l]_{l} \ar[r]^{r} & R \ar[d]^{h} & L \ar[d]_{m}& K \ar[d]^{k'}\ar@{>->}[l]_{l} \ar[r]^{r} & R \ar[d]^{h'}\\G & \ar@{>->}[l]^{f} D \ar[r]_{g}& H & G & \ar@{>->}[l]^{f'} D' \ar[r]_{g'}& H'}\]
Then there exist isomorphisms $t\colon D\to D'$ and $s\colon H\to H'$ as in the following diagram.
\[\xymatrix@C=40pt{&&D' \ar[r]^{g'} \ar@{>->}@/_.45cm/[dll]_{f'}&H'\\G & L \ar[l]_{m} & K \ar[u]_{k'} \ar[d]^{k}\ar[r]^{r} \ar@{>->}[l]_{l} &R\ar[u]^{h'} \ar[d]_{h}\\&&D\ar@{>->}@/^.45cm/[ull]^{f}\ar@/^.4cm/@{.>}[uu]^(.4){t}|\hole \ar[r]_{g}&H\ar@/_.4cm/@{.>}[uu]_{s}}\]
\end{proposition}
\begin{proof}
	By construction, the pairs $(k, f)$ and $(k', f')$ are pushout complements of $l$ and $n$. Thus, the existence of the isomorphism $t\colon D\to D'$ follows from \Cref{lem:pocomp}. Now, computing we have
	\begin{align*}
		g'\circ t \circ k &= g' \circ k'\\&=h'\circ r
	\end{align*}
	Hence, we have the wanted $s\colon H\to H'$. To see that $s$ is an isomorphism, consider the diagram 
	\[\xymatrix{K  \ar@/^.4cm/[rr]^{k'}\ar[d]_{r} \ar[r]_{k}& \ar[r]_{t} D \ar[d]^{g}& D' \ar[d]^{g'}\\ R \ar@/_.4cm/[rr]_{h'} \ar[r]^{h}& H \ar[r]^{s}& H'}\]
	By hypothesis the whole rectangle and its left half are pushouts, therefore, by \Cref{lem:po1} its right square is a pushout too. The claim now follows from the fact that the pushout of an isomorphism is an isomorphism.
\end{proof}

If we look to direct derivations as transitions, it is natural to consider them as edges in a direct graph. Taking objects as vertices objects led us to the following definition \cite{heindel2009category}.

\begin{definition}
	Let $(\X, \R)$ be a left-linear DPO-rewrityng system, with $\X$ $\mathcal{M}$-adhesive. The \emph{DPO-derivation graph} of $(\X, \R)$ is the (large)  directed graph $\gpo$ having as vertices the objects of $\X$ and in which an edge between $G$ and $H$ is a direct derivation $\dder{D}\colon G\Mapsto H$.	A \emph{derivation} $\der{D}$ between two objects $G$ and $H$ is a path between them in $\gpo$. The \emph{source} and \emph{target} of $\der{D}$ are, respectively, $G$ and $H$.
\end{definition}

\begin{remark}
We can spell out more explicitly what  a derivation $\dder{D}$ is.  An \emph{empty derivation} starting and ending in $G$ is just $G$ itself.  A \emph{non-empty derivation} $\dder{D}$ is a sequence $\{\dder{D}_i\}_{i=0}^n$ of direct derivations such that:
\begin{enumerate}
	\item for every index $i$, $\dder{D}_i$ is a direct derivation $G_i \Mapsto G_{i+1}$;
	\item $G_0=G$ and $G_{n+1}=H$.
\end{enumerate}

We will call the number $n+1$ the \emph{length} of the derivation, denoted by $\lgh(\der{D})$. We will also say that an empty derivation has length $0$. 

Moreover,  if every $\dder{D}_i$ applies the rule $\rho_i\in R$, then we can define an associated sequence of rules as $r(\der{D})$ as $\{\rho_i\}_{i=0}^n$.
\end{remark}

\begin{remark}\label{rem:func}
	Consider a derivation $\der{D}$ in a left-linear DPO-rewriting system $(\X, \R)$. We can take the subcategory $\Delta(\der{D})$ of $\X$ given by the arrows appearing in $\der{D}$. This subcategory comes equipped with an inclusion functor $I(\der{D})\colon \Delta(\der{D})\to \X$. Moreover, we can further define $\Deltamin(\der{D})$ as the subcategory of $\Delta(\der{D})$ containing only the bottom row of the derivation.
\end{remark}
	
\begin{notation}Let $\der{D}=\{\dder{D}_i\}_{i=0}^n$ be a derivation. We will depict the $i^\text{th}$ element $\dder{D}_i$ of $\der{D}$ as in the following diagram.  
	\[\xymatrix{L_i \ar[d]_{m_i}& K_i \ar[d]^{k_i}\ar[l]_{l_i} \ar[r]^{r_i} & R_i \ar[d]^{h_i} \\G_{i} & \ar[l]^{f_{i}} D_{i} \ar[r]_{g_{i}}& G_{i+1} }\]
	Notice that, in particular, if $\der{D}\colon G\to H$, then $G_0=G$ and $G_{n+1}=H$. When $\der{D}$ has length $1$ we will suppress the indexes. In such case, we will also identify $\der{D}$ with its only element. 
\end{notation} 

\begin{example}\todo{esempi di derivazione}
\end{example}

\begin{definition}
	The \emph{DPO-derivation category} $\dpo$ of a left-linear DPO-rewriting system $(\X, \R)$ is the category in which arrows between $G$ and $H$ are given by, possibly empty, derivations. Composition is concatenation of paths in $\gpo$ and identities are given by empty derivations.
\end{definition} 	
\begin{remark}
	More explicitly, given $\der{D}=\{\dder{D}\}_{i=0}^n$ between $G$ and $H$ and $\der{D}'=\{\dder{D}'_i\}_{i=0}^m$, their concatenation $\der{D}\cdot\der{D}'$ is the derivation $\{\dder{E}_i\}_{i=0}^{m+n+1}$ in which
	\[\dder{E}_i:=\begin{cases}
		\dder{D}_i & i \leq n\\
		\dder{D}'_{i-(n+1)} & n< i 
	\end{cases}\]	

Notice, moreover that, $\der{D}\cdot \der{D'}$ is equal to $\der{D}'$ if $\der{D}$ is empty, while it coincides with $\der{D}$ if $\der{D}'$ has length zero.
\end{remark}

 \Cref{exa:conc} allows us to compose derivations with isomorphisms.

\begin{definition} Let $(\X, \R)$ be a a left-linear DPO-rewriting system. Given a derivation $\der{D}=\{\dder{D}_{i}\}_{i=0}^n$ between $G$ and $H$ and isomorphisms $\phi\colon G\to G'$, $\psi\colon H\to H'$, the derivations  $\phi*\der{D}$ and $\der{D}*\psi$ are defined as
	\[\phi *\der{D} := \begin{cases}
		G' & \lgh(\der{D})=0\\ 
		\{\phi* \dder{D}_0\}\cdot \{\dder{D}_i\}_{i=1}^{n}  & \lgh(\der{D})\neq 0
	\end{cases} \qquad \der{D}*\psi := \begin{cases}
	H' & \lgh(\der{D})=0\\ 
	\{\dder{D}_i\}_{i=0}^{n-1} \cdot \{\dder{D}_n*\psi\} & \lgh(\der{D})\neq 0
	\end{cases}\] 

	Moreover, if $\lgh(\der{D})>0$,  we define the derivation $\phi *\der{D} * \psi$ as
	\[\phi *\der{D} * \psi = \{\phi* \dder{D}_0\}\cdot \{\dder{D}_i\}_{i=1}^{n-1} \cdot \{\dder{D}_n*\psi\}\] 
\end{definition}

\begin{remark}
When $\der{D}$ consists only in the direct derivation $\dder{D}$, then $\phi*\der{D}*\psi$ is the derivation of length one whose unique element is $\phi*\dder{D}*\psi$.
\end{remark}

\subsection{Decorations and abstraction equivalence}
We are often interested in an object of $\X$ only up to isomorphism. It is therefore useful to consider a version of $\gpo$ in which vertices are classes of isomorphism of object of $\X$. In order to do so, some preliminary work is needed.

\begin{definition}\cite{mac2013categories}
Let $\X$ be a category, we say that  $\X$ is \emph{skeletal} if, for every two objects $X$ and $Y$, the existence of an isomorphism $\phi\colon X\to Y$ entails $X=Y$. A \emph{skeleton} for a category $\X$ is a full subcategory $\ske$ which is skeletal and such that the inclusion functor $\ske\to \X$ is an equivalence. 
\end{definition}

\begin{remark}
By definition the inclusion $\ske \to \X$ is an equivalence. In particular, this mean that, for every objects $X$ of $\X$ there exists $\pi(X)$ in $\ske$ and an isomorphism $\phi_X\colon \pi(X) \to X$.
\end{remark}

\begin{proposition}\label{prop:ske}
	Every category $\X$ has a skeleton. 
\end{proposition}
\begin{proof}
	For every object $X\in \X$, pick a single representative $\pi(X)$ of its isomorphism class. Let $\ske$ be the full subcategory given by these objects. By definition $\ske$ is skeletal and the inclusion functor is full, faithful and essentially surjective.\qedhere 
\end{proof}
\begin{remark}
	The proof of \Cref{prop:ske} relies on the axiom of choice for classes.
	\end{remark}
\begin{remark}
	It is possible to proof that every two skeleta of a given category $\X$ are isomorphic (not only equivalent). For the remaining of this paper we assume that a skeleton $\ske$ of $\X$ and a functor $\pi\colon \X\to \ske$ are chosen once and for all.
\end{remark}

\begin{definition}
	Let $(\X, \R)$ be a left-linear DPO-rewriting system, a \emph{decorated derivation} between two objects $G$ and $H$ is a triple $(\der{D}, \alpha, \omega)$, where $\der{D}$ is a derivation between $G$ and $H$, and $\alpha\colon \pi(G)\to G$ and $\omega\colon \pi(H)\to H$ are isomorphisms.
\end{definition}

\begin{notation}
	We will extend the use of the words length, source and target to decorated derivations in the obvious way, forgetting the decorations $\alpha$ and $\omega$.
\end{notation}

\begin{example}A decorated derivation $(\der{D}, \alpha, \omega)$ with $\der{D}$ empty is just a span
	\[\xymatrix{G & \pi(G) \ar[r]^-{\omega} \ar[l]_-{\alpha} & G}\]
	in which both $\omega$ and $\alpha$ are isomorphisms.
\end{example}

As we are interested in objects only up to isomorphism, so we are interested in (decorated) derivations only up to some notion of coherent isomorphism between them. This is done with the help of \Cref{rem:func}.

\begin{definition}Let $(\X, \R)$ be a left-linear DPO-rewriting system,  an \emph{abstraction equivalence} between two derivations $\der{D}$ and $\der{D'}$ with the same length and such that $r(\der{D})=r(\der{D}')$, is a family of isomorphisms $\{\phi_X\}_{X\in \Deltamin(\der{D})}$ such that, for every $i\in [0, \lgh(\der{D})]$ the following diagram commutes
	\[\xymatrix@C=40pt{G'_i&D'_i \ar[r]^{g'_i} \ar[l]_{f'_i}&G'_{i+1}\\  L_i \ar[u]^{n'_i} \ar[d]_{n_i}& K_i \ar[u]^{k'_i} \ar[d]_{k_i} \ar[r]^{r_i} \ar[l]_{l_i} &R\ar[u]^{h'_i} \ar[d]_{h_i}\\G_i \ar@/_.45cm/[uu]_(.35){\phi_{G_i}}|\hole&D_i\ar[l]^{f_i}\ar@/_.45cm/[uu]_(.35){\phi_{D_i}}|\hole \ar[r]_{g_i}&G_{i+1}\ar@/_.45cm/[uu]_{\phi_{H_i}}}\]

Given two decorated derivations $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$, we say that they are \emph{abstraction equivalent}, if $\lgh(\der{D})=\lgh(\der{D}')$, $r(\der{D})=r(\der{D'})$, and there exists an of abstraction equivalence between $\der{D}$ and  $\der{D}$ such that the triangles below commute.
\[\xymatrix@C=15pt{&\pi(G_0) \ar[dr]^{\alpha'} \ar[dl]_{\alpha}&&& \pi(G_{n+1}) \ar[dr]^{\omega'} \ar[dl]_{\omega}\\ G_0 \ar[rr]_{\phi_{G_0}} && G'_0 &G_{n+1} \ar[rr]_{\phi_{G_{n+1}}} && G'_{n+1} } \]
We will use $\equiv^a$ to denote the resulting relation.
\end{definition}

\begin{remark}\label{rem:equi}
	It is immediate to see that $\equiv^a$ is an equivalence relation. Indeed $(\der{D}, \alpha, \omega)$ is abstract equivalent to itself via the abstract equivalence with the identities as components. Furthermore, if  $\{\phi_X\}_{X\in \Deltamin(\der{D})}$  witnesses $(\der{D}, \alpha, \omega)\equiv_a (\der{D}', \alpha', \omega')$, then considering $\{\phi^{-1}_X\}_{X\in \Deltamin(\der{D})}$ shows $(\der{D}', \alpha', \omega)\equiv_a (\der{D}, \alpha, \omega)$. Finally, transitivity is assured composing abstract equivalences. 
	
	We will denote by $[\der{D}, \alpha, \omega]_a$ is just the equivalence class of  $(\der{D}, \alpha, \omega)$.
	 Such equivalence classes will be called  \emph{abstract decorated derivation}.  
\end{remark}

\begin{example}\label{rem:empty}
Let $(\der{D},\alpha, \omega)$ be an empty derivation from an object $G$ and  $(\der{D}',\alpha', \omega')$ a another empty one from $G'$.  If $(\der{D},\alpha, \omega)\equiv_a(\der{D}',\alpha', \omega')$ then an abstraction equivalence between $\der{D}$ and $\der{D}'$ is just an isomorphism $\phi\colon G\to G'$, so that $\pi(G)=\pi(G')$. Moreover, such isomorphism must fit in the diagrams below.
\[\xymatrix@C=15pt{&\pi(G) \ar[dr]^{\alpha'} \ar[dl]_{\alpha}&&& \pi(G) \ar[dr]^{\omega'} \ar[dl]_{\omega}\\ G\ar[rr]_{\phi} && G' &G \ar[rr]_{\phi} && G' } \]
In particular, these two triangles imply that
\begin{align*}
	\alpha'\circ \alpha^{-1}&=\phi \\&=\omega'\circ \omega^{-1}
\end{align*}
\end{example}

\begin{remark}\label{rem:res} \Cref{prop:unique} can be restated as saying that, given two direct derivations $\dder{D}$ and $\dder{D'}$ with the same match, there exists an abstract equivalence between them whose first component is an identity.
\end{remark}

\begin{remark}\label{rem:absequi}
	Let $\der{D}$ be a derivation with source $G$ and target $H$. Let also $\phi\colon G'\to G$ and $\psi\colon H\to H'$ be two isomorphisms. Then for every $X\in \Deltamin(\der{D})$ we can define 
	\[\varphi_X:=\begin{cases}
		\phi^{-1} & X=G\\
		\id{X} & \text{otherwise}
	\end{cases} \qquad \varphi'_X:=\begin{cases}
	\psi & X=H\\
	\id{X} & \text{otherwise}
	\end{cases}\]
It is immediate to see that the family $\{\varphi_X\}_{X\in \Deltamin(\der{D})}$ is an abstraction equivalence between $\der{D}$ and $\phi *\der{D}$, while $\{\varphi'_X\}_{X\in \Deltamin(\der{D})}$ is one between $\der{D}$ and $\der{D}*\psi$.
\end{remark}

\begin{definition}\label{def:conc}
Let $(\der{D}, \alpha, \omega)$ be a decorated derivation between $G$ and $H$ and $(\der{D}', \alpha', \omega')$ one between $H'$ and $K$. If $H$ and $H'$ are isomorphic, so that $\pi(H)=\pi(H')$, we define the  \emph{composite decorated derivation} putting
\[(\der{D}, \alpha, \omega)\cdot (\der{D}', \alpha', \omega'):=\begin{cases}
(\der{D}', \alpha'\circ \omega^{-1}\circ \alpha, \omega')	&\lgh(\der{D})=0 \\
	(\der{D}, \alpha, \omega \circ (\alpha')^{-1}\circ \omega')&\lgh(\der{D}')=0 \text{ and } \lgh(\der{D})\neq 0\\
(\der{D}*\omega^{-1}\cdot \alpha'*\der{D'}, \alpha, \omega')	&\text{otherwise}
\end{cases}\]
\end{definition}


\begin{remark}\label{rem:lgt}
	Let $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ two composable decorated derivations   such that $\lgh(\der{D})=n$ and $\lgh(\der{D}')=m$.	 Then $(\der{D}*\omega^{-1}\cdot \alpha'*\der{D'}, \alpha, \omega')$ has length $n+m$.
\end{remark}

The next proposition justifies the use of decorations, guaranteeing that concatenation of abstract decorated derivations is well-defined.
\begin{lemma}\label{lem:conc}
	Given a decorated derivation $(\der{D}, \alpha, \omega)$  between $G$ and $H$ and  another one $(\der{E}, \beta, \xi)$ between $E$ and $K$ with $\pi(H)=\pi(E)$. If  $(\der{D}', \alpha', \omega')$ and $(\der{E}', \beta', \xi')$ are two other decorated derivations such that
	\[[\der{D}, \alpha, \omega]_a = [\der{D}', \alpha', \omega']_a \qquad [\der{D}, \beta, \xi]_a=[\der{E}', \beta', \xi']_a\]
	Then
	\[[(\der{D}, \alpha, \omega)\cdot (\der{E}, \beta, \xi)]_a=[(\der{D}', \alpha', \omega')\cdot (\der{E}', \beta', \xi')]_a\]
\end{lemma}

\begin{proof} Take two abstraction equivalences $\{\phi_X\}_{X\in \Deltamin(\der{D})}$ and $\{\varphi_X\}_{X\in \Deltamin(\der{D})}$ between $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ and between $(\der{E}, \beta, \xi)$ and $(\der{E}', \beta', \xi')$, respectively. To fix the notation, suppose that goes from $G'$ to $H'$ and $(\der{E}', \beta', \xi')$ from $E'$ to $K'$. We have three cases.
	
\begin{itemize}
	\item $\lgh(\der{D})=0$. Then, $\lgh(\der{D}')$ is $0$ too. By \Cref{def:conc} we have
	\begin{align*}
	(\der{D}, \alpha, \omega)\cdot (\der{E}, \beta, \xi)&=(\der{E}, \beta\circ \omega^{-1}\circ \alpha, \xi)\\
		(\der{D}', \alpha', \omega')\cdot (\der{E}', \beta', \xi')&=(\der{E}', \beta'\circ (\omega')^{-1}\circ \alpha', \xi')
	\end{align*}
 Now, notice that $G$ and $H$ must coincide. Moreover, by \Cref{rem:empty} we also know that $\pi(G)=\pi(G')$ too. The same \Cref{rem:empty} entails that the inner squares of the following diagram are commutative, so that the whole rectangle commutes too.
 \[\xymatrix@C=35pt{\pi(G) \ar[r]^{\alpha} \ar[d]_{\id{\pi(G)}}& G  \ar[d]_{\phi_G}\ar[r]^-{\omega^{-1}} & \pi(G) \ar[d]_{\id{\pi(G)}} \ar[r]^{\beta}& E \ar[d]^{\varphi_E}\\\pi(G') \ar[r]_{\alpha'}& G' \ar[r]_-{(\omega')^{-1}} & \pi(G') \ar[r]_{\beta'} & E'}\]
 
 We can  then conclude that $\{\varphi_X\}_{X\in \Deltamin(\der{D})}$ witnesses the fact that $(\der{E}, \beta\circ \omega^{-1}\circ \alpha, \xi)$ is abstraction equivalent to $(\der{E}', \beta'\circ (\omega')^{-1}\circ \alpha', \xi')$.

\item $\lgh(\der{D})\neq 0$ and $\lgh(\der{E})= 0$. As in the point above, we get that also $\der{E}'$  is an empty derivation, thus we have
\begin{align*}
	(\der{D}, \alpha, \omega)\cdot (\der{E}, \beta, \xi)&=(\der{D},  \alpha, \omega \circ \beta^{-1}\circ \xi)\\
	(\der{D}', \alpha', \omega')\cdot (\der{E}', \beta', \xi')&=(\der{D}',  \alpha', \omega' \circ (\beta')^{-1}\circ \xi')
\end{align*}
In this case we have that $E=K$ and that $\pi(E)=\pi(E')$. From \Cref{rem:empty} we deduce that the diagram below commutes.
\[\xymatrix@C=35pt{\pi(E) \ar[r]^{\xi} \ar[d]_{\id{\pi(E)}}& E  \ar[d]_{\varphi_E}\ar[r]^-{\beta^{-1}} & \pi(E) \ar[d]_{\id{\pi(E)}} \ar[r]^{\omega}& H \ar[d]^{\phi_H}\\\pi(E') \ar[r]_{\xi'}& E' \ar[r]_-{(\beta')^{-1}} & \pi(E') \ar[r]_{\omega'} & H'}\]
The thesis now follows at once.
	\item $\lgh(\der{D})\neq 0$ and $\lgh(\der{E})\neq 0$. In this case we have
	\begin{align*}
		(\der{D}, \alpha, \omega)\cdot (\der{E}, \beta, \xi)&=(\der{D}*\omega^{-1}\cdot \beta*\der{E}, \alpha, \xi)\\
		(\der{D}', \alpha', \omega')\cdot (\der{E}', \beta', \xi')&=(\der{D}'*(\omega')^{-1}\cdot \beta'*\der{E'}, \alpha', \xi')
	\end{align*}
 To fix the notation, suppose that $\der{D}$, $\der{D}'$, $\der{E}$ and $\der{E}'$ are given by
	\[\der{D}=\{\dder{D}_i\}_{i=0}^n \quad \der{D}'=\{\dder{D}'_i\}_{i=0}^n \quad \der{E}=\{\dder{E}_i\}_{i=0}^t \quad \der{E}'=\{\dder{E}'_i\}_{i=0}^t\]
	Moreover, noticing that the rule applied by $\dder{D}_i$ and the one applied in $\mathcal{E}_i$  must coincide with, respectively, the one applied in $\dder{D}'_i$ and the one applied $\dder{E}'_i$. We will also assume that $\dder{D}_i$, $\dder{D}'_i$, $\dder{E}_i$ and $\dder{E}'_i$ are given, respectively, by the following four diagrams. 
	\[\xymatrix{L_{\der{D},i} \ar[d]_{m_{\der{D}, i}}& K_{\der{D},i} \ar[d]_{k_{\der{D}, i}} \ar[r]^{r_{\der{D},i}} \ar[l]_{l_{\der{D},i}} & R_{\der{D},i}\ar[d]^{h_{\der{D}, i}} &L_{\der{E},i} \ar[d]_{m_{\der{E}, i}}& K_{\der{E},i} \ar[d]_{k_{\der{E}, i}} \ar[r]^{r_{\der{E},i}} \ar[l]_{l_{\der{E},i}} & R_{\der{E},i}\ar[d]^{h_{\der{E}, i}} \\G_i & D_i \ar[r]_{g_{\der{D},i}} \ar[l]^{f_{\der{D},i}} & G_{i+1} & E_i & F_i\ar[r]_{g_{\der{E},i}} \ar[l]^{f_{\der{E},i}}  & E_{i+1}}\]
	\[\xymatrix{L_{\der{D},i} \ar[d]_{m_{\der{D}', i}}& K_{\der{D},i} \ar[d]_{k_{\der{D}', i}} \ar[r]^{r_{\der{D},i}} \ar[l]_{l_{\der{D},i}} & R_{\der{D},i}\ar[d]^{h_{\der{D}', i}} &L_{\der{E},i} \ar[d]_{m_{\der{E}', i}}& K_{\der{E},i} \ar[d]_{k_{\der{E}', i}} \ar[r]^{r_{\der{E},i}} \ar[l]_{l_{\der{E},i}} & R_{\der{E},i}\ar[d]^{h_{\der{E}', i}} \\G'_i & D'_i \ar[r]_{g_{\der{D}',i}} \ar[l]^{f_{\der{D}',i}} & G'_{i+1} & E'_i & F'_i\ar[r]_{g_{\der{E}',i}} \ar[l]^{f_{\der{E}',i}}  & E'_{i+1}}\]
	
Now, for every $X\in \Deltamin(\der{D}*\omega^{-1}\cdot \beta*\der{E})$ we can define
\[\psi_X:=\begin{cases}
	\phi_X & X\in  \Deltamin(\der{D})\text{ and } X\neq H\\\varphi_X & X\in  \Deltamin(\der{E}) \text{ and } X\neq E\\\id{\pi(H)}& X=\pi(H)\end{cases}\]
Notice that, since $\psi_G=\phi_G$ and $\psi_K=\varphi_K$ we have at once  the commutativity of the triangles
\[\xymatrix@C=15pt{&\pi(G) \ar[dr]^{\alpha'} \ar[dl]_{\alpha}&&& \pi(K) \ar[dr]^{\xi'} \ar[dl]_{\xi}\\ G\ar[rr]_{\psi_G} && G' &K \ar[rr]_{\psi_K} && K' } \]


To show that $\{\psi_X\}_{\Deltamin(\der{D}*\omega^{-1}\cdot \beta*\der{E})}$ is an abstraction equivalence, it is now enough to prove the commutativity of the diagrams
	\[\xymatrix@C=45pt@R=15pt{G'_n&D'_n \ar[r]^-{(\omega')^{-1}\circ g_{\der{D}',n}} \ar@/_.2cm/[dr]_(.6){g_{\der{D}',n}} \ar[l]_{f_{\der{D}',n}}&\pi(H') \\&&H' \ar[u]^{(\omega')^{-1}}\\  L_{\der{D}, n} \ar[uu]^{m_{\der{D}',n}} \ar[dd]_{m_{\der{D},n}}& K_{\der{D}, n} \ar[uu]^{k_{\der{D}',n}} \ar[dd]_{k_{\der{D},n}} \ar[r]^{r_{\der{D},n}} \ar[l]_{l_{\der{D},n}} &R_{\der{D}, n}\ar[u]^{h_{\der{D}',n}} \ar[d]_{h_{\der{D},n}}\\&&H \ar[d]_{\omega^{-1}}\\G_n \ar@/_.7cm/[uuuu]_(.35){\phi_{G_n}}|\hole&D_n\ar[l]^{f_{\der{D},n}}\ar@/_.7cm/[uuuu]_(.35){\phi_{D_n}}|\hole \ar@/^.2cm/[ur]^(.6){g_{\der{D},n}}\ar[r]_{\omega^{-1}\circ g_{\der{D},n}}&\pi(H)\ar@/_.7cm/[uuuu]_{\id{\pi(H)}}\\ \pi(E')&F'_0 \ar[l]_-{(\beta')^{-1}\circ f_{\der{E}',0}} \ar@/^.2cm/[dl]^(.6){f_{\der{E}',0}} \ar[r]^{g_{\der{E}',0}}&E'_1 \\E' \ar[u]_{(\beta')^{-1}}&& \\  L_{\der{E}, 0} \ar[u]_{m_{\der{E}', 0}} \ar[d]^{m_{\der{E}, 0}}& K_{\der{E}, 0} \ar[uu]_{k_{\der{E}', 0}} \ar[dd]^{k_{\der{E}, i}} \ar[r]^{r_{\der{E},0}} \ar[l]_{l_{\der{E},0}} &R_{\der{E}, 0}\ar[uu]_{h_{\der{E}',0}} \ar[dd]^{h_{\der{E},0}}\\E \ar[d]^{\beta^{-1}}&& \\\pi(E) \ar@/^.7cm/[uuuu]^{\id{\pi(E)}}&F_0\ar[l]^{\beta^{-1}\circ f_{\der{E},0}}\ar@/^.7cm/[uuuu]^(.35){\varphi_{F_0}}|\hole \ar@/_.2cm/[ul]_(.6){f_{\der{E},0}}\ar[r]_{g_{\der{E},0}}&E_1\ar@/^.7cm/[uuuu]^(.35){\varphi_{E_1}}|\hole}\]
		
To see this, in turn, it is enough to show that	the squares
\[\xymatrix{R_{\der{D}, n} \ar[d]_{h_{\der{D}, n}}\ar[r]^{h_{\der{D}', n}} & H' \ar[d]_{(\omega')^{-1}} &L_{\der{E}, 0} \ar[d]^{m_{\der{E}, 0}}\ar[r]^{m_{\der{E}', 0}}& E' \ar[d]^{(\beta')^{-1}}\\H\ar[r]_{\omega^{-1}} &\pi(H)&E \ar[r]_{\beta^{-1}} & \pi(E)}\]
\[\xymatrix{D_n \ar[rr]^{\phi_{D_n}} \ar[d]_{g_{\der{D}, n}}&&D'_n \ar[d]_{g_{\der{D}', n}}&F_0 \ar[d]^{f_{\der{E}, 0}} \ar[rr]^{\varphi_{F_0}} && F_0' \ar[d]^{f_{\der{E}', 0}}\\H \ar[r]_-{\omega^{-1}} &\pi(H)&H' \ar[l]^-{(\omega')^{-1}}  &E \ar[r]_-{\beta^{-1}} & \pi(E) & E' \ar[l]^-{(\beta')^{-1}}}\]
are commutative. For the first ones, we have
\[
\begin{split} 
	\omega^{-1} \circ h_{\der{D}, n}&=\id{\pi(H)}\circ \omega^{-1} \circ h_{\der{D}, n} \\&=(\omega')^{-1}\circ \phi_H \circ \omega \circ \omega^{-1} \circ h_{\der{D}, n}\\&=(\omega')^{-1}\circ \phi_H  \circ h_{\der{D}, n}\\&=(\omega')^{-1}  \circ h_{\der{D}', n}
\end{split} \qquad  	\begin{split} 
\beta^{-1} \circ m_{\der{E}, 0}&=\id{\pi(E)}\circ \beta^{-1} \circ m_{\der{E}, 0}\\&=(\beta')^{-1}\circ \varphi_{E} \circ \beta \circ \beta^{-1} \circ m_{\der{E}, 0}\\&=(\beta')^{-1}\circ \varphi_{E}  \circ m_{\der{E}, 0}\\&=(\beta')^{-1}  \circ m_{\der{E}', 0}
\end{split}  \]

Similarly, the commutativity of the second row of diagrams can be deduced from
\[\begin{split}
\omega^{-1} \circ g_{\der{D}, n}&=\id{\pi(H)}\circ \omega^{-1} \circ g_{\der{D}, n}\\&=(\omega')^{-1}\circ \phi_H \circ \omega\circ \omega^{-1} \circ g_{\der{D}, n}\\&=(\omega')^{-1}\circ \phi_H  \circ g_{\der{D}, n}\\&= (\omega')^{-1} \circ g_{\der{D}', n}\circ \phi_{D_n}
\end{split}\qquad \begin{split}\beta^{-1} \circ f_{\der{E}, 0}&=\id{\pi(E)}\circ \beta^{-1} \circ f_{\der{E}, 0}\\&=(\beta')^{-1}\circ \varphi_E \circ \beta\circ \beta^{-1} \circ f_{\der{E}, 0}\\&=(\beta')^{-1}\circ \varphi_E  \circ f_{\der{E}, 0}\\&= (\beta')^{-1} \circ f_{\der{E}', n}\circ \varphi_{F_0}
\end{split}\]

 The thesis now follows.	\qedhere 
\end{itemize}	
\end{proof}

\begin{definition}
	Let $(\X, \R)$ be a left-linear DPO-rewrityng system, with $\X$ an $\mathcal{M}$-adhesive category. The  category $\dpi$ is defined as follows:
	\begin{itemize}
		\item objects are isomorphism classes of objects of $\X$;
		\item an arrow $[G]\to [H]$ is an equivalence class $[\der{D}, \alpha, \omega]_a$ of a decorated derivation between $G'$ and $H'$ for some $G'$ and $H'$ such that $\pi(G')=G$ and $\pi(H')=H$;
		\item composition is concatenation of abstract decorated derivations;
		\item the identity on $[G]$ is $[G, \alpha, \alpha]_a$, where $\alpha$ is any isomorphism $\pi(G)\to G$.	\end{itemize}
\end{definition}



\section{A theory of processes for left-linear DPO-rewriting systems} 

Given a DPO-rewriting system $(\X, \R)$,  we have already noted in \Cref{rem:func} that a derivation $\der{D}$  determines a diagram $\Delta(\der{D})$ in $\X$. We can then wonder if such a diagram has a colimit. Clearly if $\der{D}$ is the empty derivation $G$ then a colimit for $\Delta(\der{D})$ is simply the object $G$. More generally, we have the following result.

\begin{lemma}\label{lem:colim}
	Let $\X$ be an $\mathcal{M}$-adhesive category and $(\X, \R)$ a left-linear DPO-rewriting system over it. The following properties hold true:
	\begin{enumerate}
		\item  for eevery derivation $\der{D}$ is a derivation from $G$ to $H$, then the diagram $\Delta(\der{D})$ has a colimit $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D})})$ such that $\iota_H$ belongs to $\mathcal{M}$.
		\item Let $\der{D}$ be the concatenation $\der{D}_1\cdot \der{D}_2$ of two derivations $\der{D}_1=\{\dder{D}_{1,i}\}_{i=0}^{n_1}$ between $G$ and $H$ and $\der{D}_2=\{\dder{D}_{2,j}\}_{j=0}^{n_2}$ between $H$ and $T$,  then the colimiting cocone $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D})})$ exists too and there is a pushout square
		\[\xymatrix{H\ar[r]^-{\iota_{2, H}} \ar@{>->}[d]_-{\iota_{1, H}} & \tproi{D}{2} \ar[d]^{p_2}\\  \tproi{D}{1} \ar[r]_{p_1}& \tpro{D}}\]
		where $(\tproi{D}{1}, \{\iota_{1, X}\}_{X\in \Delta(\der{D}_1)})$ and $(\tproi{D}{2}, \{\iota_{2, X}\}_{X\in \Delta(\der{D}_2)})$ are the colimiting cocone for $\Delta(\der{D}_1)$ and $\Delta(\der{D}_2)$, respectively.
	\end{enumerate}
\end{lemma}
\begin{remark}\label{rem:cof}
Let $I:\Deltamin(\dder{D})\to \Delta(\dder{D})$ be the inclusion functor. It is immediate to see that such functor is \emph{final} \cite{mac2013categories}. This means that for every functor $F\colon \Delta(\dder{D})\to \Y$ we have:
\begin{enumerate}
	\item if  $(C, \{c_X\}_{X\in \Deltamin(\dder{D})})$ is colimiting for $F\circ I$, then there exists a colimiting cocone $(D, \{d_X\}_{X\in \Delta(\dder{D})})$ for $F$;
	\item $(C, \{c_X\}_{X\in \Deltamin(\dder{D})})$ and $(D, \{d_X\}_{X\in \Delta(\dder{D})})$ are colimiting for, repsectively, $F\circ I$ and $F$, then the canonical arrow $\phi\colon C\to D$ induced by $(D, \{d_X\}_{X\in \Deltamin(\dder{D})})$ is an isomorphism.
\end{enumerate}
\end{remark}

\begin{proof}\begin{enumerate}
		\item Let us proceed by induction on the length of $\der{D}$.

	
	\smallskip \noindent $\lgh(\dder{D})=0$. then the $\tpro{\dder{D}}$ is simply $(G, \{\id{G}\})$ and $\id{G}\in \mathcal{M}$.
	
	\smallskip \noindent$\lgh(\dder{D})=1$. Suppose that $\dder{D}$ has as its single component the derivation
			\[\xymatrix{L \ar[d]_{m}& K \ar[d]^{k}\ar@{>->}[l]_{l} \ar[r]^{r} & R \ar[d]^{h} \\G& \ar@{>->}[l]^{f} D \ar[r]_{g}& H  \\}\]
			The arrow $f$ is  the pushout of $l$ and so it is in in $\mathcal{M}$. We can thus consider the $\mathcal{M}$-pushout square
			\[\xymatrix{D \ar@{>->}[d]_{f} \ar[r]^{g} & H \ar@{>->}[d]^{p} \\G \ar[r]_{q}& P }\]
			Since $p\in \mathcal{M}$, the thesis follows immediately from \Cref{rem:cof}. 
	
	\smallskip \noindent$\lgh(\dder{D})\geq 2$. Let $\der{D}$ be $\{\dder{D}_i\}_{i=0}^n$ with $n\geq 1$. Let also $\der{D}'$ be $\{\dder{D}_i\}^{n-1}_{i=0}$ and $\rho_n=(l_n, r_n)$ be the rule applied in $\dder{D}_n$. The arrow $f_n\colon D_n\to G_n$, being a pushout of $l_n$ is an element $\mathcal{M}$. By inductive hypothesis, $\iota_{G_{n}}\colon G_{n}\to \lpro \der{D}'\rpro$ is in $\mathcal{M}$ too, thus, we can consider the diagram below, having a pushout as its lower half.
			\[\xymatrix{L_n \ar[d]_{m_{n}}& K_{n} \ar[d]^{k_{n}}\ar@{>->}[l]_{l_{n}} \ar[r]^{r_{n}} & R_{n} \ar[d]^{h_n} \\G_{n} \ar@{>->}[d]_{\iota'_{G_{n}}}& \ar@{>->}[l]^{f_n} D_n \ar[r]_{g_n}& H  \ar@{>->}[d]^{q}\\ \lpro \der{D}' \ar[rr]_{p}\rpro && P}\] 
			Notice that, as in the point above, the arrow $q\colon H\to P$ is the pushout of an element in $\mathcal{M}$, therefore it is enough to show that the diagram so constructed provides a colimiting cocone for $\Delta(\der{D})$.
			
			Let $(C, \{c_X\}_{X\in \Delta(\der{D})})$ be a cocone, since $\Delta(\der{D}')$ is a subdiagram of $\Delta(\der{D})$, we get another cocone $(C, \{c_X\}_{X\in \Delta(\der{D}')})$ which induces an arrow $c'\colon \lpro \der{D}' \rpro \to C$ such that
			\begin{align*}
				c'\circ \iota_{G_n} \circ f_n &=c_{G_n} \circ f_n\\&= c_{D_n}\\&= c_{H}\circ g_n
			\end{align*}
			Therefore the arrows $c'$ and $c_H$ induce a morphism $c\colon P\to C$ and the thesis now follows at once.
		
		\item  As a first step, notice that $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D}_1)})$ and $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D}_2)})$ are cocone on, respectively, $\Delta(\der{D}_1)$ and $\Delta(\der{D}_2)$. Hence, there exist two arrows $p_1\colon \tproi{D}{1}\to \tpro{D}$, $p_2\colon \tproi{D}{2}\to \tpro{D}$ such that, for every $X\in  \Delta(\der{D}_1)$ and $Y\in  \Delta(\der{D}_2)$
		\[p_1\circ \iota_{1, X} = \iota_X \qquad p_2\circ \iota_{2, Y}=\iota_{2,Y}\]
		In particular, this entails the commutativity of the square
				\[\xymatrix{H \ar[dr]^{\iota_H} \ar[r]^-{\iota_{2, H}} \ar@{>->}[d]_-{\iota_{1, H}} & \tproi{D}{2} \ar[d]^{p_2}\\  \tproi{D}{1} \ar[r]_{p_1}& \tpro{D}}\]
		
	Let us now show that the square above is a pushout. Take two arrows $a\colon \tproi{D}{1}\to C$, $b\colon \tproi{D}{2}\to C$ such that $a\circ \iota_{1, H}=b\circ \iota_{2, H}$. We can use the previous equality to define a cocone $(C, \{c_X\}_{X\in \Delta(\der{D})})$ putting:
	\[c_X:=\begin{cases}
		a\circ \iota_{1, X} & X\in \Delta(\der{D}_1)\\
		b\circ \iota_{2, X} & X\in \Delta(\der{D}_2)
	\end{cases}\]
From this, we can deduce at once the existence of a unique $c\colon \tpro{D}\to C$ such that $c\circ \iota_X = c_X$. By construction, for every $X\in  \Delta(\der{D}_1)$ and $Y\in  \Delta(\der{D}_2)$ we have
\[\begin{split}
	c\circ p_1 \circ \iota_{1,X}&=c\circ \iota_{X}\\&=c_X \\&=a\circ \iota_{1,X}\\&=a\circ p_1\circ \iota_{1,X}
\end{split}\qquad \begin{split}
	c\circ p_2 \circ \iota_{2,Y}&=c\circ \iota_{Y}\\&=c_Y \\&=b\circ \iota_{2,Y}\\&=b\circ p_2\circ \iota_{2,Y}
\end{split}\]
Therefore we get that $c\circ p_1=a$ and $c\circ p_2 = b$.

	For uniqueness, suppose that $c'\colon \tpro{D}\to C$ is such that $c'\circ p_1=a$ and  $c'\circ p_2 = b$. Then, for every $X\in \Delta(\der{D})$ we have
\begin{align*}
	c'\circ \iota_X &= \begin{cases}
	c'\circ p_1\circ \iota_{1, X} & X\in \Delta(\der{D}_1)\\
	c'\circ p_2\circ \iota_{2, X} & X\in \Delta(\der{D}_2)
	\end{cases}\\&=\begin{cases}
a\circ \iota_{1, X} & X\in \Delta(\der{D}_1)\\
b\circ \iota_{2, X} & X\in \Delta(\der{D}_2)
	\end{cases}\\&=c_X\\&=c\circ \iota_X
\end{align*}
showing that $c'=c$ as wanted.	 \qedhere 
	\end{enumerate}
\end{proof}

\begin{corollary}\label{cor:colim}
Let $\der{D}=\{\dder{D}_i\}_{i=0}^n$ a derivation of length $n+1$ and fix an index $j\in[0,n]$. Define
\[\der{D}^j_1:=\{\dder{D}_i\}_{i=0}^{j-1} \qquad  \der{D}^j_2=\{\dder{D}_j\} \qquad \der{D}^j_3:=\{\dder{D}_i\}_{i=j+1}^n\]
with the convention that $\der{D}^0_1$ and $\der{D}^n_3$ are the empty derivation on, respectively, $G_0$ and $G_n$. Then the square below is a pushout and a pullback
\[\xymatrix@C=30pt{D_{j} \ar[ddrr]^{\iota_{D_j}} \ar[r]^{g_j}\ar@{>->}[d]_{f_j}& G_{j+1} \ar[ddr]^{\iota_{G_{j+1}}} \ar[r]^-{\iota_{3, G_{j+1}}} & \lpro \der{D}^j_3\rpro \ar[dd]^{p_2} \\ G_j\ar[drr]_{\iota_{G_{j}}} \ar@{>->}[d]_{\iota_{1,G_j}}\\ \lpro \der{D}^j_1 \rpro \ar[rr]_{p_1}  &&\tpro{D} }\] 
Where the two arrows $p_1\colon \lpro\der{D}^j_1 \rpro\to \tpro{D}$, $p_2\colon \lpro \der{D}^j_3\rpro \to \tpro{D}$ are induced by the cocones $(\tpro{D}, \{\iota_{X}\}_{X\in \Delta(\der{D}^j_1)})$ and $(\tpro{D}, \{\iota_{X}\}_{X\in \Delta(\der{D}^j_3)})$, respectively.
\end{corollary}
\begin{remark}
If $\der{D}$ is empty then $\der{D}^j_1, \der{D}^j_2$ and $\der{D}^j_3$ are empty too.
\end{remark}
\begin{proof}
We can notice that $\der{D}=\der{D}^j_1\cdot \der{D}^j_2 \cdot \der{D}^j_3$. By the first and the second point of \Cref{lem:colim} then we get the following diagram, in which all squares are $\mathcal{M}$-pushouts.

\[\xymatrix@C=30pt{D_{j}  \ar[r]^{g_j}\ar@{>->}[d]_{f_j}& G_{j+1}  \ar[r]^-{\iota_{3,G_{j+1}}} \ar[d]_{\iota_{2, G_{j+1}}}  \ar@/^.5cm/[dd]^{\iota_{1,2, G_{j+1}}}& \lpro \der{D}^j_3\rpro \ar[dd]^{p_2} \\ G_j \ar[r]^{\iota_{2, G_j}}\ar@{>->}[d]_{\iota_{1,G_j}} & \lpro \der{D}^j_2\rpro \ar[d]_a\\ \lpro \der{D}^j_1 \rpro \ar@/_.4cm/[rr]_{p_1} \ar[r]^b &\lpro \der{D}^j_1\cdot \der{D}^j_2 \rpro \ar[r]^c&\tpro{D} }\] 
Applying \Cref{lem:po1} twice we get that the whole square is an $\mathcal{M}$-pushout. Then the thesis follows from \Cref{prop:pbpoad}.
\end{proof}

\begin{remark}\label{rem:zero1} In particular, considering $j=0$ or $j=n$, we get that the following two squares are $\mathcal{M}$-pushouts and, thus, pullbacks.
	\[\xymatrix{D_0 \ar[r]^-{\iota_{3, D_0}} \ar@{>->}[d]_{f_0}& \lpro \der{D}^0_3 \rpro \ar@{>->}[d]^{p_2} &D_n \ar@{>->}[d]_{\iota_{1, D_n}}\ar[r]^{g_n}& G_n \ar@{>->}[d]^{\iota_{G_n}}\\ G \ar[r]_{\iota_G}& \tpro{D} & \lpro \der{D}^n_1 \rpro \ar[r]_{p_1}  & \tpro{D}}\]
\end{remark}

\begin{corollary}\label{cor:ele}
	Let $\der{D}=\{\dder{D}_{i}\}_{i=0}^n$ be a derivation between $G$ and $H$. Let $j$ and $k$ be two indexes less or equal than $n+1$ and suppose that $j< k$.  Consider two arrows $a\colon T\to G_j$, $b\colon T\to G_k$. If $\iota_{G_j}\circ a = \iota_{G_k}\circ b$, 
	then  there exist a unique arrow $c\colon T\to D_j $  such that \[f_j\circ c = a\qquad \iota_{D_j}\circ c =\iota_{G_k}\circ b\]
	\end{corollary}
\begin{proof} Consider the diagram
			\[\xymatrix@C=34pt{T  \ar@/_.6cm/[dd]_{a}\ar@{.>}[d]^{c}\ar[rr]^{b}&& G_k \ar[d]_{\iota_{3, G_k}} \ar@/^.6cm/[ddd]^{\iota_{G_k}}\\D_{j} \ar[r]^{g_j} \ar[ddrr]^{\iota_{D_j}}\ar@{>->}[d]^{f_j}& G_{j+1} \ar[r]^-{\iota_{3,G_{j+1}}} \ar[ddr]^{\iota_{G_{j+1}}} & \lpro \der{D}^j_3\rpro \ar[dd]_(.6){p_2} \\ G_j \ar@{>->}[d]_{\iota_{1,G_j}} \ar[drr]_{\iota_{G_j}}\\ \lpro \der{D}^j_1 \rpro \ar[rr]_{p_1}  &&\tpro{D} }\] 
			Thanks to \Cref{cor:colim} we know that the bottom right rectangle in the diagram above is a pullback and the thesis follows at once.
\end{proof}	

\subsection{Semi-consistent and consistent permutations}
	
Equipped with the theory developed so far, we can introduce the notions of \emph{semi-consistent} and \emph{consistent} permutation.

\begin{definition}[(Semi)-consistent permutation]\label{def:permcon}
	Let $\X$ be an $\mathcal{M}$-adhesive category and consider a left-linear DPO-rewriting system $(\X, \R)$ on it.  Consider two decorated derivations $(\der{D}, \alpha, \omega)$ and  $(\der{D}', \alpha', \omega')$ with the same length $l$ and with isomorphic sources and targets. Let also $r(\der{D})=\{\rho_i\}_{i=0}^{l-1}$ and $r(\der{D}')=\{\rho'_i\}_{i=0}^{l-1}$	be sequences of rules associated to the two derivations.
	
	A \emph{semi-consistent permutation} between  $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ is a permutation $\sigma\colon [0,l-1]\to [0,l-1]$  such that, for every $i\in [0,l-1]$, $\rho_i=\rho'_{\sigma(i)}$ and, moreover, there exists a \emph{mediating isomorphism} $\xi_\sigma\colon \tpro{D} \to \lpro \der{D}' \rpro$ fitting in the following diagrams, where $m_i, m'_i, h_i$ and $h'_i$ are, respectively, the matches and back-matches of $\dder{D}_i$ and $\dder{D}'_i$.
	\[\xymatrix@C=30pt{\pi(G_0)\ar[r]^{\alpha} \ar[d]_{\alpha'} & G_0 \ar[r]^{\iota_{G_0}} &\tpro{D} \ar[d]^{\xi_\sigma}\\ G'_0 \ar[rr]_{\iota'_{G'_0}} & &\lpro \der{D}' \rpro}\]
	\[\xymatrix@C=30pt{L_i \ar[r]^{m_i} \ar[d]_{m'_{\sigma(i)}}& G_i \ar[r]^{\iota_{G_i}} &\tpro{D} \ar[d]^{\xi_\sigma} & R_i \ar[r]^{h_i} \ar[d]_{h'_{\sigma(i)}}& G_{i+1} \ar[r]^{\iota_{G_{i+1}}} &\tpro{D} \ar[d]^{\xi_\sigma} \\G'_{\sigma(i)} \ar[rr]_{\iota'_{G'_{\sigma(i)}}}&& \lpro \der{D}' \rpro& G'_{\sigma(i)+1} \ar[rr]_{\iota'_{G'_{\sigma(i)+1}}}&& \lpro \der{D}' \rpro}\]
	
	A semi-consistent permutation is \emph{consistent} if the following square commutes too.
	\[\xymatrix@C=30pt{ \pi(G_{l}) \ar[r]^{\omega} \ar[d]_{\omega'} & G_{l} \ar@{>->}[r]^{\iota_{G_{l}}} &\tpro{D} \ar[d]^{\xi_\sigma} \\  G'_{l} \ar@{>->}[rr]_{\iota'_{G'_{l}}} & &\lpro \der{D}' \rpro}\]
\end{definition}

\begin{remark}\label{rem:inversa}
	Let $\sigma\colon [0,n]\to [0,n]$ be a consistent permutation between $(\der{D},\alpha, \omega)$ and $(\der{D}', \alpha', \omega')$, then its inverse $\sigma^{-1}$ is a consistent permutation between $(\der{D}', \alpha', \omega')$ and $(\der{D},\alpha, \omega)$. Indeed, it is enough to consider, as mediating isomorphism, the inverse $\xi^{-1}_\sigma$ of $\xi_\sigma$.
\end{remark}

\begin{example}\label{rem:empty2}
	Let $(\{G\}, \alpha, \omega)$ and $(\{G'\}, \alpha', \omega')$ be two derivations of length $0$. Then $\id{\emptyset}$ is a consistent permutations between them if and only if there exists an isomorphism $\phi\colon G_0\to G'_0$ fitting in the diagrams below
	\[\xymatrix@C=15pt{&\pi(G) \ar[dr]^{\alpha'} \ar[dl]_{\alpha}&&& \pi(G) \ar[dr]^{\omega'} \ar[dl]_{\omega}\\ G\ar[rr]_{\phi} && G' &G \ar[rr]_{\phi} && G' } \]
	That is, by \Cref{rem:empty} if and only if they are abstract equivalent decorated derivations.
\end{example}

\begin{remark} Notice that if $\sigma$ is a semi-consistent permutation between two derivations  $\der{D}$ and $\der{D}'$ of length $l$, then for every  $i\in [0,l-1]$ the diagram below commutes.
	\[\xymatrix@C=40pt{G_i\ar@/^1cm/[rrr]^{\iota_{G_{i}}}&D_i\ar@/^.4cm/[rr]^(.35){\iota_{D_i}} \ar[r]_{g_i} \ar@{>->}[l]^{f_i}&G_{i+1} \ar[r]_{\iota_{G_{i+1}}}&\tpro{D} \ar[dd]^{\xi_\sigma}\\  L_i \ar[u]^{n_i} \ar[d]_{n'_{\sigma(i)}}& K_i \ar[d]^{k'_{\sigma(i)}} \ar[u]_{k_i} \ar[r]^{r_i} \ar@{>->}[l]_{l_i} &R\ar[u]^{h_i} \ar[d]_{h'_{\sigma(i)}}\\G'_{\sigma(i)}\ar@/_1cm/[rrr]_{\iota'_{G'_{\sigma(i)}}} &D'_{\sigma(i)}\ar@{>->}[l]_{f'_{\sigma(i)}} \ar[r]^{g'_i} \ar@/_.4cm/[rr]_(.35){\iota'_{D'_{\sigma(i)}}}&G'_{\sigma(i)+1} \ar[r]^{\iota'_{G'_{\sigma(i)+1}}}& \lpro\der{D}' \rpro }\]
	
	This follows at once from the following chain of identities:
	\begin{align*}
		\xi_\sigma \circ \iota_{D_i}\circ k_i&=\xi_\sigma \circ \iota_{G_{i}} \circ f_i\\&= \xi_\sigma \circ \iota_{G_{i}}\circ m_i \circ l_i\\&=\iota_{G'_{\sigma(i)}}\circ m'_i\circ l_i\\&=\iota_{G'_{\sigma(i)}}\circ f'_{\sigma(i)}\circ k'_i\\&=\iota_{D'_\sigma(i)}\circ k_i'
	\end{align*}
\end{remark}

\begin{remark}\label{rem:coproj}
	Notice that, in particular, the previous diagram entails
	\[\xi_\sigma \circ \iota_{L_i}=\iota'_{L_{\sigma(i)}} \quad \xi_\sigma \circ \iota_{K_i}=\iota'_{K_{\sigma(i)}} \quad \xi_\sigma \circ \iota_{R_i}=\iota'_{R_{\sigma(i)}} \]
\end{remark}

The previous remark allows us to prove the following.

\begin{lemma}\label{prop:isouno} For every semi-consistent permutation $\sigma$ between  $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$, the mediating isomorphism $\xi_\sigma\colon \tpro{D}\to \lpro \der{D}'\rpro$ is unique.
\end{lemma}
\begin{proof} Let $\xi'_\sigma$ be another mediating isomorphism, then by \Cref{rem:coproj} we have
	\[\begin{split}
		\xi_\sigma \circ \iota_{L_i}&=\iota'_{L_{\sigma(i)}}\\&=\xi'_\sigma\circ \iota_{L_i}
	\end{split} \qquad \begin{split}
		\xi_\sigma \circ \iota_{K_i}&=\iota'_{K_{\sigma(i)}}\\&=\xi'_\sigma\circ \iota_{K_i}
	\end{split} \qquad \begin{split}
		\xi_\sigma \circ \iota_{R_i}&=\iota'_{R_{\sigma(i)}}\\&=\xi'_\sigma\circ \iota_{R_i}
	\end{split}\]
	
	Now, notice that 
	\begin{align*}
		\xi_\sigma \circ \iota_{G_0}&=\iota'_{G'_0}\circ \alpha'\circ \alpha^{-1}\\&=\xi'_\sigma \circ \iota_{G_0}
	\end{align*}
	
	If $\lgh(\der{D})=0$ this is enough to conclude, otherwise we are going to prove by induction that, for every $i\in [0, \lgh(\der{D})-1]$, $\xi_\sigma \circ \iota_{G_i}=\xi'_\sigma\circ \iota_{G_i}$.
	
	\smallskip \noindent $i=0$. This is simply the result obtained before.
	
	\smallskip \noindent $i >0$. If $i>0$, we know that there is a pushout square
	\[\xymatrix{K_{i-1}\ar[r]^{r_{i-1}} \ar[d]_{k_{i-1}}& R_{i-1} \ar[d]^{h_{i-1}}\\ D_{i-1} \ar[r]_{g_{i-1}}& G_i}\] 
	By \Cref{rem:coproj} and the induction hypothesis we know that
	\[\begin{split}
		\xi_\sigma \circ \iota_{G_i}\circ h_{i-1}&=  \xi_\sigma\circ \iota_{R_{i-1}}\\&=\iota'_{R_{\sigma(i-1)}}\\&=\xi'_{\sigma}\circ \iota_{R_{i-1}}\\&=\xi'_{\sigma} \circ \iota_{G_i}\circ h_{i-1}\\&
	\end{split} \qquad
	\begin{split}
		\xi_\sigma \circ \iota_{G_i}\circ g_{i-1}&=\xi_{\sigma}\circ \iota_{D_{i-1}}\\&=\xi_{\sigma}\circ \iota_{G_{i-1}} \circ f_{i-1}\\&=\xi'_{\sigma}\circ \iota_{G_{i-1}} \circ f_{i-1}\\&=\xi'_{\sigma}\circ \iota_{D_{i-1}} \\&=\xi'_{\sigma}\circ \iota_{G_{i}} \circ g_{i-1}
	\end{split}
	\]
	
	Since $\xi_\sigma \circ \iota_{D_i}$ must be $\xi_\sigma \circ \iota_{G_i}\circ f_i$, we also have
	$\xi_\sigma \circ \iota_{D_i}=\xi'_\sigma \circ \iota_{D_i}$
	and the thesis follows.
\end{proof}


As a next step, we will show that the existence of abstraction equivalences satisfying certain coherence conditions is enough to guarantee the (semi-)consistency of the identical permutation.

\begin{proposition}\label{rem:abscons}
	Let $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ be two decorated derivations in an left-linear rewriting system $(\X, \R)$ of length $l$. Let also $\{\phi_X\}_{X\in \Deltamin(\der{D})}$ be an abstraction equivalence between $\der{D}$ and $\der{D}'$. If $\alpha'\circ \phi_{G_0}=\alpha$ then the the identity $\id{[0,l-1]}$ is a semi-consistent permutation. If, moreover, $\omega'\circ \phi_{G_{l}}=\omega$, then $\id{[0,l-1]}$ is a consistent one.
\end{proposition}
\begin{proof}
	For every $X\in \Deltamin(\der{D}) $, let $X'$ the codomain of $\phi_X$. Then we can define $\xi_{\id{[0,l-1]}}\colon \tpro{D}\to \lpro \der{D}'\rpro$ as the unique morphism such that, for every $X\in \Deltamin(\der{D})$, 
	\[\xi_{\id{[0,l-1]}} \circ \iota_{X}= \iota'_{X'}\circ \phi_X\]

As a first step we can notice that $\xi_{\id{[0,l-1]}}$ is an isomorphism: indeed we can define $\Theta\colon \lpro\der{D}'\rpro \to \tpro{D}$ as the unique arrow satisfying, for every $X'\in \Deltamin(\der{D}')$
\[\Theta \circ \iota'_{X'}= \iota_{X}\circ \phi^{-1}_X\]

From the following two computations we can derive that $\Theta$ is the inverse of $\xi_{\id{[0,l-1]}}$.
\[\begin{split}
	\Theta \circ \xi_{\id{[0,l-1]}}\circ \iota_{X}&=\Theta \circ\iota'_{X'}\circ \phi_X\\&=\iota_{X}\circ \phi^{-1}_X\circ \phi_X\\&=\iota_X 
\end{split}\qquad \begin{split}
\xi_{\id{[0,l-1]}}\circ \Theta \circ \iota'_{X'}&=\xi_{\id{[0,l-1]}}\circ \iota_X\circ \phi^{-1}_{X}\\&=\iota'_{X'}\circ \phi_X\circ \phi^{-1}_{X}\\&=\iota'_{X'}
\end{split}\]

To conclude, let us observe that all the internal subdiagrams of the following diagrams commutes, guaranteeing the commutativity of the full ones.
\[\xymatrix@C=30pt{\pi(G_0)\ar[r]^{\alpha} \ar[d]_{\alpha'} & G_0 \ar[dl]^{\phi_{G_0}} \ar[r]^{\iota_{G_0}} &\tpro{D} \ar[d]^{\xi_{\id{[0, l-1]}}}\\ G'_0 \ar[rr]_{\iota'_{G'_0}} & &\lpro \der{D}' \rpro}\]
\[\xymatrix@C=30pt{L_i \ar[r]^{m_i} \ar[d]_{m'_{\sigma(i)}}& G_i \ar[dl]^{\phi_{G_i}} \ar[r]^{\iota_{G_i}} &\tpro{D} \ar[d]^{\xi_{\id{[0, l-1]}}} & R_i \ar[r]^{h_i} \ar[d]_{h'_{i}}& G_{i+1} \ar[dl]^{\phi_{G_{i+1}}}\ar[r]^{\iota_{G_{i+1}}} &\tpro{D} \ar[d]^{\xi_{\id{[0, l-1]}}} \\G'_{i} \ar[rr]_{\iota'_{G'_{i}}}&& \lpro \der{D}' \rpro& G'_{i+1} \ar[rr]_{\iota'_{G'_{i+1}}}&& \lpro \der{D}' \rpro}\]

For the last half of the thesis, we can reason similarly. Indeed, the diagram below commutes.
\[\xymatrix@C=30pt{\pi(G_l)\ar[r]^{\omega} \ar[d]_{\omega'} & G_l \ar[dl]^{\phi_{G_l}} \ar[r]^{\iota_{G_l}} &\tpro{D} \ar[d]^{\xi_{\id{[l, l-1]}}}\\ G'_l \ar[rr]_{\iota'_{G'_l}} & &\lpro \der{D}' \rpro}\]
This clearly entails the thesis.
\end{proof}

The previous proposition, in turn, gives us a technical but quite useful result.

\begin{corollary}\label{cor:fromsemitocons}
			Let $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ be two decorated derivations in an left-linear rewriting system $(\X, \R)$ of length $l$. Let also $\{\phi_X\}_{X\in \Deltamin(\der{D})}$ be an abstraction equivalence between $\der{D}$ and $\der{D}'$ such that  $\alpha'\circ \phi_{G_0}=\alpha$. If  the identity $\id{[0,l-1]}$ is a consistent permutation, then $\omega'\circ \phi_{G_l}=\omega$, so that $(\der{D}, \alpha, \omega) \equiv_a (\der{D}', \alpha', \omega')$.
\end{corollary}
\begin{proof}
	Let $\xi_{\id{[0, l-1]}}$ be the isomorphism $\tpro{D}\to \lpro\der{D}'\rpro$ witnessing the consistency of $\id{[0, l-1]}$. By \Cref{prop:isouno} and \Cref{rem:abscons}, we know that $\xi_{\id{[0,l-1]}} \circ \iota_{X}= \iota'_{X'}\circ \phi_X$ for every object $X\in \Deltamin(\der{D})$. Then we have
	\begin{align*}
		\iota'_{ G'_{l}}\circ \phi_{G_l}\circ \omega&=\xi_{\id{[0, l-1]}}\circ \iota_{G_l}\circ \omega\\&=\iota'_{G'_l}\circ \omega'
	\end{align*}
	
	By the first point of \Cref{lem:colim}, $\iota'_{ G'_{l}}$ is mono and we can conclude.
\end{proof}

\begin{remark}\label{rem:abscons2}
	In particular, given a decorated derivation $(\der{D}, \alpha, \omega)$ with source $G$ and target $H$ and two isomorphisms, $\phi\colon G'\to G$ $\psi\colon H\to H'$ be two isomorphisms, we know, by \Cref{rem:absequi}, that \[(\der{D}, \alpha, \omega)\equiv_a (\phi*\der{D}, \phi^{-1}\circ \alpha, \omega ) \qquad (\der{D}, \alpha, \omega)\equiv_a (\der{D}*\psi, \alpha, \psi \circ \omega )\]
	In these cases, if the cocones $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D})})$, $(\lpro \phi *\der{D} \rpro, \{\iota'_X\}_{X\in \Delta(\phi *\der{D})})$ and $(\lpro \der{D}*\psi \rpro, \{\iota'_X\}_{X\in \Delta(\der{D}*\psi)})$ are colimiting, we can take as mediating isomorphisms, respectively, the unique arrows $\Gamma^{\phi} \colon \tpro{D}\to \lpro \phi*\der{D} \rpro$ and $\Gamma_\psi\colon \tpro{D}\to \lpro \der{D}*\psi \rpro$  such that, for every $X\in \Deltamin(\der{D})$:
	\[\Gamma^\phi \circ \iota_X:=\begin{cases}
		\iota'_{G'}\circ \phi^{-1}  & X=G\\
		\iota'_X & \text{otherwise}
	\end{cases} \qquad \Gamma_\psi \circ \iota_X:=\begin{cases}
		\hat{\iota}_{H'}\circ \psi  & X=H\\
		\hat{\iota}_X & \text{otherwise}
	\end{cases}\]
\end{remark}


\begin{example}\todo{identita consistente non implica astrazione}Notice that, in general, there cannot, in general, be generalized to non-empty derivations. A counterexample is the following one.
\end{example}



We can also observe that (semi-)consistent permutations can be composed, as shown by the next proposition.

\begin{proposition}\label{rem:comp}  Let $(\der{D}, \alpha, \omega)$, $(\der{D}', \alpha', \omega')$ and $(\der{\hat{D}}, \hat{\alpha}, \hat{\omega})$ be three decorated derivations of length $l$. Let $\sigma$ be a consistent permutation between the first two and $\tau$ one between the second and the third, then $\tau \circ \sigma$ is a semi-consistent permutations between the first and the third. If, moreover, $\sigma$ and $\tau$ are consistent, then $\tau \circ \sigma$ is consistent too.
\end{proposition} 	

\begin{proof} Let $l$ be the length of the three given derivations.  By hypothesis each subdiagram of the following ones commutes, thus the whole diagrams commute too, proving that $\tau\circ \sigma$ is a semi-consistent permutation with mediating isomorphism given by $\xi_{\tau} \circ \xi_\sigma$.
		\[\xymatrix@C=18pt{ & G_0 \ar[rr]^{\iota_{G_0}} &&\tpro{D} \ar[d]^{\xi_\sigma} \\ \pi(G_0) \ar@/_.2cm/[dr]_{\hat{\alpha}}\ar@/^.2cm/[ur]^{\alpha} \ar[r]^{\alpha'} &G'_0 \ar[rr]^{\iota'_{G'_0}}  &&\lpro \der{D}'  \rpro \ar[d]^{\xi_{\tau}}\\ &\hat{G}_0  \ar[rr]_{\hat{\iota}_{\hat{G}_0}}&& \lpro \hat{\der{D}}\rpro }\]  
		\[\xymatrix@C=18pt{& G_i \ar[rr]^{\iota_{G_i}} &&\tpro{D} \ar[d]^{\xi_\sigma}&  &  G_{i+1} \ar[rr]^{\iota_{G_{i+1}}} &&\tpro{D} \ar[d]^{\xi_\sigma} \\ L_i \ar@/_.2cm/[dr]_{\hat{m}_{\tau(\sigma(i))}}\ar@/^.2cm/[ur]^{m_i} \ar[r]^{m'_{\sigma(i)}} &G'_{\sigma(i)} \ar[rr]^{\iota'_{G'_{\sigma(i)}}}  &&\lpro \der{D}'  \rpro \ar[d]^{\xi_{\tau}}&R_i \ar@/_.2cm/[dr]_{\hat{h}_{\tau(\sigma(i))}}\ar@/^.2cm/[ur]^{h_i} \ar[r]^{h'_{\sigma(i)}} & G'_{\sigma(i)+1} \ar[rr]^{\iota'_{G'_{\sigma(i)+1}}} && \lpro \der{D}' \rpro \ar[d]^{\xi_{\tau}}\\ &\hat{G}_{\tau(\sigma(i))}  \ar[rr]_-{\hat{\iota}_{\hat{G}_{\tau(\sigma(i))}}}&& \lpro \hat{\der{D}}\rpro  && \hat{G}_{\tau(\sigma(i))+1} \ar[rr]_-{\hat{\iota}_{\hat{G}_{\tau(\sigma(i))+1}}}&& \lpro \hat{\der{D}} \rpro	}\]
	
	If, in addition, $\sigma$ and $\tau$ are consistent then we also have the commutativity of the following additional diagram.
	\[\xymatrix@C=18pt{&   G_{l} \ar@{>->}[rr]^{\iota_{ G_{l}}} &&\tpro{D} \ar[d]^{\xi_\sigma}\\ \pi({ G_{l}})\ar@/_.2cm/[dr]_{\hat{\omega}}\ar@/^.2cm/[ur]^{\omega} \ar[r]^{\omega'} & { G'_{l}} \ar@{>->}[rr]^{\iota'_{{ G'_{l}}}} && \lpro \der{D}' \rpro \ar[d]^{\xi_{\tau}}\\& \hat{G}_l \ar@{>->}[rr]_{\hat{\iota}_{\hat{G}_l}}&& \lpro \hat{\der{D}} \rpro}\]
	
	Again this proves that $\xi_\tau \circ \xi_\sigma$ witnesses the constistency of $\tau\circ \sigma$.
\end{proof}
	

\subsubsection{Restricting  consistent permutations}
Now that we have established some initial facts about consistent permutations, we are going to embark in a, quite long, voyage to explore how to restrict them to suitable subderivations. 


\begin{lemma}\label{rem:dett}
	Let $(\der{D}, \alpha, \omega)$ be the composite $(\der{D}_1, \alpha_1, \omega_1)\cdot (\der{D}_2, \alpha_2, \omega_2)$ of two derivation of length $l_1$ and $l_2$. Suppose that:
\[r(\der{D}_1)=\{\rho_{1,i}\}_{i=0}^{l_1-1} \quad r(\der{D}_2)=\{\rho_{2,i}\}_{i=0}^{l_2-1} \quad  r(\der{D})=\{\rho_{i}\}_{i=0}^{l_1+l_2-1}\]
and let  $G_{1,0}, G_{2,0}$ and $G_{0}$ be the sources of $\der{D}_1$, $\der{D}_2$,  and $\der{D}$. Similary, denote, by $G_{1,i+1}, G_{2,i+1}$ and $G_{i+1}$ the results of the application of, respectively, $\rho_{1,i}, \rho_{2,i}, \rho_i$ to $G_{1,i}, G_{2,i}$ and $G_{i}$  in the corresponding derivation. Then there are arrows $q_1\colon \lpro \der{D}_1\rpro \to \tpro{D}$, $q_2\colon \lpro \der{D}_2\rpro \to \tpro{D}$ such that
\[q_1\circ \iota_{G_{1,0}}\circ \alpha_1 = \iota_{G_{0}}\circ \alpha \qquad q_2\circ \iota_{G_{2,l_2}}\circ \omega_2 = \iota_{G_{l_1+l_2}}\circ \omega \]
and, for every $i\in [0, l_1-1]$, $j\in [l_1+1, l_1+l_2]$
	\[q_1\circ \iota_{1, G_{1,i}}=\iota_{G_{i}}\qquad q_2\circ \iota_{2, G_{2,j}}=\iota_{G_{j+l_1}} \]
\end{lemma}
\begin{proof}According to \Cref{def:conc}, we have three cases.
\begin{itemize}
	\item $\lgh(\der{D}_1)=0$. Then  $(\der{D}, \alpha, \omega)$ is $(\der{D}_2, \alpha_2\circ \omega_1^{-1}\circ \alpha_1, \omega_2)$ thus we can take as $q_2$ the identity on $\lpro \der{D}_2\rpro$. Moreover, in this case $\iota_{1,G_{1,0}}$ is an isomorphism, so that we can take as $q_1$ the composition $\iota_{G_0}\circ \alpha_2\circ \omega^{-1}_1 \circ \iota^{-1}_{1,G_{1,0}}$.
	\item $\lgh(\der{D}_1)\neq 0$ and $\lgh(\der{D}_2)=0$ . Hence  $(\der{D}, \alpha, \omega)$ is $(\der{D}_1, \alpha_1, \omega_1 \circ \alpha^{-1}_2\circ \omega_2)$. We can then define $q_1$ as $\id{\lpro \der{D}_1\rpro}$.  Since $\iota_{2,G_{2,0}}$ is an isomorphism, $q_2$ can be taken as  $\iota_{G_{l_1+l_2}}\circ  \omega_1  \circ \alpha^{-1}_2 \circ \iota^{-1}_{2,G_{2,0}}$.
	\item  $\lgh(\der{D}_1)\neq 0$ and $\lgh(\der{D}_2)\neq 0$. In this case we have that $(\der{D}, \alpha, \omega)$  is $(\der{D}_1*\omega_1^{-1}\cdot \alpha_2*\der{D}_2, \alpha_1, \omega_2)$. By second point of \Cref{lem:colim} and by \Cref{rem:abscons2} we can build the following diagram.
	\[\xymatrix@C=40pt{&&G_{2,0}  \ar@/_.3cm/[dl]_{\alpha^{-1}_2} \ar@/^.3cm/[dr]^{\iota_{2, G_{2,0}}}\\&\pi(G_{2,0}) \ar[dr]^{\iota_{G_{l_1}}}\ar[r]^-{\iota'_{2, \pi(G_{2,0})}} \ar@{>->}[d]_-{\iota'_{1, \pi(G_{1,l_1})}} & \lpro \alpha_2*\der{D}_2 \rpro \ar@{>->}[d]^{p_2} &\tproi{D}{2} \ar[l]_-{\Gamma^{\alpha_2}} \ar@{>.>}@/^.2cm/[dl]^{q_2}\\ G_{1,l_1}  \ar@/^.3cm/[ur]^{\omega^{-1}_1}  \ar@{>->}@/_.3cm/[dr]_{\iota_{1, G_{1, l_1}}}& \lpro \der{D}_1*\omega_1^{-1} \rpro  \ar[r]_{p_1}& \tpro{D} \\ &\tproi{D}{1} \ar[u]^{\Gamma_{\omega^{-1}_1}}  \ar@{.>}@/_.2cm/[ur]_{q_1}}\]

	Let us define $q_1$ as $p_1\circ \Gamma_{\omega^{-1}_1}$ and $q_2$ as $p_2\circ \Gamma^{\alpha_2}$. Then, for every $i\in [0,l_1-1]$ and $j\in [l_1+1, l_1+l_2]$
	\[\begin{split}
		q_1\circ \iota_{1, G_{1,i}}&=p_1\circ \Gamma_{\omega^{-1}_1}\circ \iota_{1, G_{1,i}}\\&=p_1\circ \iota'_{1, G_{1,i}} \\&=\iota_{G_{i}}
	\end{split} \qquad \begin{split}
		q_2\circ \iota_{2, G_{2,j}}&=p_2\circ \Gamma^{\alpha_2}\circ \iota_{2, G_{2,j}}\\&=p_2\circ \iota'_{2, G_{2,j}} \\&=\iota_{G_{j+l_1}}
	\end{split}\]
	Moreover, we also have:
	\[
	\begin{split}
		q_1\circ \iota_{G_{1,0}}\circ \alpha_1&= p_1\circ \Gamma_{\omega^{-1}_1}\circ \iota_{G_{1,0}}\circ \alpha_1 \\&=p_1\circ \iota'_{1, G_{1,0}} \circ \alpha_1 \\&= \iota_{G_{0}}\circ \alpha
	\end{split}\qquad 
	\begin{split}
	q_2\circ \iota_{G_{2,l_2}}\circ \omega_2&= p_2\circ \Gamma^{\alpha_2}\circ \iota_{G_{2,l_2}}\circ \omega_2 \\&=p_2\circ \iota'_{1, G_{2,l_2}} \circ \omega_2 \\&= \iota_{G_{l_1+l_2}}\circ \omega
	\end{split} \] 
	
	This concludes the proof. \qedhere
\end{itemize}	
\end{proof}
 
	
\begin{remark}\label{rem:dett2}
It is worth noticing that, for every $i\in [0,l_1-1]$ and $j\in [l_1+1, l_1+l_2]$ the previous equalities also entail that,
\[\begin{split}q_1\circ \iota_{1, D_{1,i}}&=\iota_{D_{i}}\\q_2\circ \iota_{2, D_{2,j}}&=\iota_{D_{j+l_1}} 	\\q_1\circ \iota_{1, R_{1,i-1}}&=\iota_{R_{i-1}} \\
	q_2\circ \iota_{2, R_{2,j-1}}&=\iota_{R_{j+l_1-1}}
\end{split} \qquad 
\begin{split}    	q_1\circ \iota_{1, L_{1,i}}&=\iota_{L_{i}} \\q_2\circ \iota_{2, L_{2,j}}&=\iota_{L_{j+l_1}}\\ q_1\circ \iota_{1, K_{1,i}}&=\iota_{K_{i}}\\q_2\circ \iota_{2, K_{2,j}}&=\iota_{K_{j+l_1}}\end{split}\]
\end{remark}

We can now turn our attention to the case in which a consistent permutation between two composite derivations is given.

\begin{lemma}[Restriction Lemma]\label{prop:uniqu}
	Let $\sigma\colon [0,n]\to [0,n]$ be a consistent permutations between $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ and suppose that 
	\[(\der{D}, \alpha, \omega)=(\der{D}_1, \alpha_1, \omega_1) \cdot (\der{D}_2, \alpha_2, \omega_2) \qquad (\der{D}', \alpha', \omega')=(\der{D}'_1, \alpha'_1, \omega'_1) \cdot (\der{D}'_2, \alpha'_2, \omega'_2) \]
	
	 Let $l_1$ be the length of $\der{D}_1$, and suppose that there exists a consistent permutation $\tau:[0,l_1-1]\to [0, l_1-1]$.  If $q_1\colon \lpro \der{D}_1\rpro \to \lpro \der{D}\rpro$  and $q'_1\colon \lpro \der{D}'_1\rpro \to \lpro \der{D}'\rpro$ are the canonical arrows defined in \Cref{rem:dett}, then the following hold true:
	\begin{enumerate}
	\item  if $l_1=0$, then the following diagram commutes:
		\[\xymatrix{\lpro \der{D}_1\rpro \ar[r]^{\xi_\tau} \ar[d]_{q_1}& \lpro \der{D}'_1 \ar[d]^{q'_1}\rpro\\ \lpro \der{D}\rpro \ar[r]_{\xi_\sigma} & \lpro \der{D}'\rpro } \]
	%\[\xi_\sigma \circ q_1 \circ \iota_{1, G_{1,0}} = q'_1\circ \xi_{\tau} \circ  \iota_{1, G_{1,0}}\]
	\item if $l_1\neq 0$, so that $G_{1,0}=G_0$, then $\xi_\sigma \circ \iota_{G_0} = q'_1\circ \xi_{\tau} \circ  \iota_{1, G_{1,0}}$.
	\end{enumerate}
	
	Moreover, define the set $E_{\sigma, \tau}$ as
	\[E_{\sigma, \tau}:=\{i\in  [0, l_1-1] \mid \sigma(j)=\tau(j) \text{ for every } j \leq i \}\]
	then also the following hold true:
	\begin{enumerate}
		\setcounter{enumi}{2}
	\item  if $E_{\sigma, \tau}\neq \emptyset$,  for every index $i\in [0, \max(E_{\sigma, \tau})]$ we have 
	$\xi_\sigma \circ \iota_{G_i}=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_i}$;
	\item if $l_1-1\in E_{\sigma, \tau}$ and $l_2=0$ so that  $G_{l_1}=G_{1, l_1}$, then 
	$\xi_\sigma \circ \iota_{G_{l_1}}=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}}$;
	\item if $l_1-1\in E_{\sigma, \tau}$ and $l_2\neq 0$, so that $G_{l_1}=\pi(G_{2,0})$, then 
	$\xi_\sigma \circ \iota_{G_{l_1}}=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}}\circ \omega_1$;
	\item if $l_1-1\in E_{\sigma, \tau}$, then the following diagram commutes:
	\[\xymatrix{\lpro \der{D}_1\rpro \ar[r]^{\xi_\tau} \ar[d]_{q_1}& \lpro \der{D}'_1 \ar[d]^{q'_1}\rpro\\ \lpro \der{D}\rpro \ar[r]_{\xi_\sigma} & \lpro \der{D}'\rpro } \]
	\end{enumerate}
\end{lemma}
\begin{proof}\begin{enumerate}
		\item Recall that, in this case \[q_1=\iota_{G_0}\circ \alpha_2\circ \omega^{-1}_1 \circ \iota^{-1}_{1,G_{1,0}} \qquad q'_1=\iota'_{G'_0}\circ \alpha'_2\circ (\omega'_1)^{-1} \circ (\iota'_{1,G'_{1,0}})^{-1}\]
		
		If we compute we have
		\begin{align*}
	\xi_\sigma \circ q_1 &=\xi_\sigma \circ \iota_{G_0}\circ \alpha_2\circ \omega^{-1}_1 \circ \iota^{-1}_{1,G_{1,0}} \\&=\iota'_{G'_0}\circ \alpha'\circ \alpha^{-1}\circ \alpha_2\circ \omega^{-1}_1\circ \iota^{-1}_{1,G_{1,0}}
		\end{align*}
		Now, since $l_1=0$ we also have that 
		\[\alpha=\alpha_2\circ \omega_1^{-1}\circ \alpha_1 \qquad \alpha'=\alpha'_2\circ (\omega'_1)^{-1}\circ \alpha'_1\]
		
		Therefore, using \Cref{rem:empty}, we get:
		\begin{align*}
	\alpha'\circ \alpha^{-1}&=\alpha'_2\circ (\omega'_1)^{-1}\circ \alpha'_1\circ \alpha^{-1}_1\circ \omega_1\circ \alpha^{-1}_2\\&=\alpha'_2\circ (\omega'_1)^{-1}\circ \omega'_1\circ \omega^{-1}_1\circ \omega_1\circ \alpha^{-1}_2\\&=\alpha'_2\circ \alpha^{-1}_2
		\end{align*}
	Hence, again by \Cref{rem:empty} we obtain:
				\begin{align*}
			\xi_\sigma \circ q_1 &=\iota'_{G'_0}\circ \alpha'\circ \alpha^{-1}\circ \alpha_2\circ \omega^{-1}_1\circ \iota^{-1}_{1,G_{1,0}}\\&=\iota'_{G'_0}\circ \alpha'_2\circ \alpha^{-1}_2\circ \alpha_2\circ \omega^{-1}_1\circ \iota^{-1}_{1,G_{1,0}}\\&=\iota'_{G'_0}\circ \alpha'_2\circ \omega^{-1}_1\circ \iota^{-1}_{1,G_{1,0}}\\&=\iota'_{G'_0}\circ \alpha'_2\circ (\omega'_1)^{-1} \circ  \omega'_1\circ \omega^{-1}_1\circ \iota^{-1}_{1,G_{1,0}}\\&=\iota'_{G_0}\circ \alpha'_2\circ (\omega'_1)^{-1} \circ \alpha'_1\circ \alpha^{-1}_1\circ \iota^{-1}_{1,G_{1,0}}\\&=\iota'_{G'_0}\circ \alpha'_2\circ (\omega'_1)^{-1} \circ (\iota'_{1,G_{1,0}})^{-1}\circ \iota'_{1,G'_{1,0}}\circ \alpha'_1\circ \alpha^{-1}_1\circ \iota^{-1}_{1,G_{1,0}}\\&=q'_1\circ \iota'_{1,G'_{1,0}}\circ \alpha'_1\circ \alpha^{-1}_1\circ \iota^{-1}_{1,G_{1,0}}\\&=q'_1\circ \xi_{\tau}
		\end{align*}


		
		\item We can start noticing that
		\[\xi_\sigma \circ \iota_{G_0}=\iota'_{G'_0}\circ \alpha'\circ \alpha^{-1} \qquad \xi_{\tau} \circ \iota_{1,G_{1,0}}= \iota'_{1, G'_{1,0}} \circ \alpha'_1\circ \alpha^{-1}_1\] 
		Therefore:
		\begin{align*}
		q'_1\circ \xi_{\tau} \circ \iota_{1, G_{1,0}}&=q'_1 \circ \iota'_{1, G'_{1,0}} \circ \alpha'_1\circ \alpha^{-1}_1\\ &= \iota'_{G'_{0}}\circ \alpha' \circ \alpha^{-1}_1
		\end{align*}
		By hypothesis $\lgh(\der{D}_1) \neq 0$, thus $\alpha_1=\alpha$ and we can conclude.
		
		\item  From $E_{\sigma, \tau}\neq \emptyset$ we deduce that $l_1\neq 0$ and that $0\in E_{\sigma, \tau}$.   We proceed by induction on $i\in [0,\max(E_{\sigma, \tau})]$. 

\smallskip \noindent  If $i=0$ the thesis follows from point $1$.

\smallskip \noindent If $i>0$, we proceed as in the proof of \Cref{prop:isouno} considering the pushout square
			\[\xymatrix{K_{i-1}\ar[r]^{r_{i-1}} \ar[d]_{k_{i-1}}& R_{i-1} \ar[d]^{h_{i-1}}\\ D_{i-1} \ar[r]_{g_{i-1}}& G_i}\] 
		Since $i$ belongs to $E_{\sigma, \tau}$, then $i-1\in E_{\sigma, \tau}$ too. By definition, $i\leq l_1-1$, so that, using \Cref{rem:coproj}, \Cref{rem:dett} and the induction hypothesis we have
			\[\begin{split}
				\xi_\sigma \circ \iota_{G_i}\circ h_{i-1}&=  \xi_\sigma\circ \iota_{R_{i-1}}\\&=\iota'_{R'_{\sigma(i-1)}}\\&=\iota'_{R'_{\tau(i-1)}}\\&=q'_1\circ \iota'_{1, R'_{1,\tau(i-1)}}\\&=q'_1\circ \xi_{\tau}\circ \iota_{1, R_{i-1}}\\&=q'_1\circ \xi_{\tau} \circ \iota_{1, G_{1,i}}\circ h_{1, i-1}\\&=q'_1\circ \xi_\tau \circ \iota_{1, G_i} \circ h_{i-1}
			\end{split} \qquad  \begin{split}
			\xi_\sigma \circ \iota_{G_i}\circ g_{i-1}&=\xi_{\sigma}\circ \iota_{D_{i-1}}\\&=\xi_{\sigma}\circ \iota_{G_{i-1}} \circ f_{i-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{i-1}} \circ f_{i-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{i-1}} \circ f_{1, i-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, D_{i-1}}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_i}\circ g_{1, i-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_i}\circ g_{i-1}
			\end{split}\]
	
	From which the thesis follows.
	
			\item Since $l_1-1\in E_{\sigma, \tau}$ we have $l_1\neq 0$ and $E_{\sigma, \tau}=[0,l_1-1]$.  We can start with the pushout
			\[\xymatrix{K_{l_1-1}\ar[r]^{r_{l_1-1}} \ar[d]_{k_{l_1-1}}& R_{i-1} \ar[d]^{h_{l_1-1}}\\ D_{l_1-1} \ar[r]_{g_{l_1-1}}& G_{l_1}}\] 
			By \Cref{def:conc}, we have $h_{l_1-1}=h_{1, l_1}$ and $g_{l_1-1}=g_{1,l_1}$. Since $q'_1=\id{\lpro \der{D}'_1\rpro}$ these two equalities imply that $	\iota'_{R_{\tau(l_1-1)}}=q'_1\circ \iota'_{1, R'_{1,\tau(l_1-1)}}$. 			
			
			Moreover, by hypothesis $l_1-1\in E_{\sigma, \tau}$, so that point $3$ of this lemma entails that
			\[\xi_\sigma \circ \iota_{G_{l_1-1}}=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1-1}}\]
			
			We can thus repeat the same argument of the previous point:
			\[\begin{split}
				\xi_\sigma \circ \iota_{G_{l_1}}\circ h_{l_1-1}&=  \xi_\sigma\circ \iota_{R_{l_1-1}}\\&=\iota'_{R'_{\sigma(l_1-1)}}\\&=\iota'_{R'_{\tau(l_1-1)}}\\&=q'_1\circ \iota'_{1, R'_{1,\tau(l_1-1)}}\\&=q'_1\circ \xi_{\tau}\circ \iota_{1, R_{l_1-1}}\\&=q'_1\circ \xi_{\tau} \circ \iota_{1, G_{1,l_1}}\circ h_{1, l_1-1}\\&=q'_1\circ \xi_\tau \circ \iota_{1, G_{l_1}} \circ h_{l_1-1}			\end{split} 
			\qquad  \begin{split}
				\xi_\sigma \circ \iota_{G_{l_1}}\circ g_{l_1-1}&=\xi_{\sigma}\circ \iota_{D_{l_1-1}}\\&=\xi_{\sigma}\circ \iota_{G_{l_1-1}} \circ f_{l_1-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1-1}} \circ f_{l_1-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}-1} \circ f_{1, l_1-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, D_{l_1-1}}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}}\circ g_{1, l_1-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}}\circ g_{l_1-1}
			\end{split}\]
		
		And again this implies the thesis.
			
			\item In this case, we can consider the following diagram, in which the inner rectangle and the outer border are pushouts
		\[\xymatrix@C=35pt{K_{1,l_1-1}\ar[r]^{r_{1,l_1-1}} \ar[d]_{k_{1,l_1-1}}& R_{i-1} \ar[d]_{h_{1,l_1-1}} \ar@/^.3cm/[ddr]^{h_{l_1-1}}\\ D_{1,l_1-1} \ar[r]_{g_{1,l_1-1}} \ar@/_.3cm/[drr]_{g_{l_1-1}}& G_{1,l_1} \ar[dr]^{\omega_1^{-1}}\\ &&\pi(G_{2,0})}\] 
		
		\iffalse 
	\[	\xi_\sigma \circ \iota_{G_{l_1}}=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}}\circ \omega_1\]
	\fi 
		We can start noticing that, by the proof of  the third point of \Cref{rem:dett}, we know that  $q'_1\circ \iota'_{1, G'_{1,l_1}}=\iota'_{G'_{l_1}} \circ \omega_1^{-1}$. Therefore
		\begin{align*}q'_1\circ \iota'_{1, R'_{1,l_1}}&=q'_1\circ \iota'_{1, G'_{1,l_1}}\circ  h'_{1, l_1}\\&=q'_1\circ \iota'_{1, G'_{1,l_1}}\circ \omega_1 \circ  h'_{ l_1}\\&= \iota'_{G'_{l_1}}\circ h'_{l_1}\\&=\iota'_{R'_{l_1-1}}
		\end{align*}
		
		The argument now proceeds almost verbatim like the one of the previous two point. Indeed, using the third point of this lemma we get:
		\[\begin{split}
			\xi_\sigma \circ \iota_{G_{l_1}}\circ h_{l_1-1}&=  \xi_\sigma\circ \iota_{R_{l_1-1}}\\&=\iota'_{R'_{\sigma(l_1-1)}}\\&=\iota'_{R'_{\tau(l_1-1)}}\\&=q'_1\circ \iota'_{1, R'_{1,\tau(l_1-1)}}\\&=q'_1\circ \xi_{\tau}\circ \iota_{1, R_{l_1-1}}\\&=q'_1\circ \xi_{\tau} \circ \iota_{1, G_{1,l_1}}\circ h_{1, l_1-1}\\&=q'_1\circ \xi_\tau \circ \iota_{1, G_{1, l_1}} \circ \omega_1 \circ  h_{l_1-1}			\end{split}  \qquad  		\begin{split}
			\xi_\sigma \circ \iota_{G_{l_1}}\circ g_{l_1-1}&=\xi_{\sigma}\circ \iota_{D_{l_1-1}}\\&=\xi_{\sigma}\circ \iota_{G_{l_1-1}} \circ f_{l_1-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}} \circ f_{l_1-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}} \circ f_{1, {l_1}-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, D_{{l_1}-1}}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}}\circ g_{1, l_1-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}}\circ \omega_1\circ g_{l_1-1}
			\end{split}\]
			
			\item  The thesis follows from points $3$ and $4$ if $l_2=0$, from $3$ and $5$ if $l_2\neq 0$.	\qedhere
	\end{enumerate}
\end{proof}

We are now ready to prove the central result of this section: the uniqueness of a consistency permutation between two decorated derivations in a consuming rewriting system.
 
\begin{lemma}\label{lem:impo}
	Let $(\X,R)$ be a left-linear DPO-rewriting system and let also $(\der{D}_1, \alpha_1, \omega_1)$, $(\der{D}_2, \alpha_2, \omega_2)$ be two composable decorated derivations of length, respectively, $l_1$ and $l_2$. Suppose that $\sigma:[0, l_1+l_2-1]\to [0, l_1+l_2-1]$ is a consistent permutation between $(\der{D}_1, \alpha_1, \omega_1)\cdot (\der{D}_2, \alpha_2, \omega_2)$ and $(\der{D}'_1, \alpha'_1, \omega'_1)\cdot (\der{D}'_2, \alpha'_2, \omega'_2)$ for some other two composable decorated derivations $(\der{D}_1, \alpha_1, \omega_1)$ and $(\der{D}_2, \alpha_2, \omega_2)$.  If $\tau:[0,l_1-1]\to [0, l_1-1]$ is a consistent permutation between $(\der{D}_1, \alpha_1, \omega_1)$ and $(\der{D}'_1, \alpha'_1, \omega'_1)$. Suppose that  the set 
	\[D_{\sigma, \tau}:=\{i\in [0, l_1-1]\mid \sigma(i)\neq \tau(i)\}\]
	is non-empty and let $j$ be its minimum. Let also $r(\der{D}_1)$ be $\{\rho_i\}_{i=0}^{l_1-1}$. Then the following hold true:
	\begin{enumerate}
		\item if $j=0$, then the rule $\rho_0$ is not consuming;
		\item if $j\neq 0$ then the rule $\rho_{j-1}$ is not consuming.
	\end{enumerate}
\end{lemma}
\begin{remark}\label{rem:minmax}It is worth to notice that the hypothesis $D_{\sigma, \tau} \neq \emptyset$ entails $l_1\neq 0$. Moreover, if $j\neq 0$, then $j-1$ is the maximum of $E_{\sigma, \tau}$.
\end{remark}
\begin{proof}
	\begin{enumerate}
		\item Let $k$ be $\sigma^{-1}(\tau(0))$ and notice that, since $\sigma(0)\neq \tau(0)$, then $0< k$.  By  the second point of  \Cref{prop:uniqu} we can consider the diagram
		\[\xymatrix@C=40pt{G_{0} \ar[drrr]_(.4){\iota_{G_0}}|(.675)\hole \ar[d]_{\iota_{1,G_{1,0}}}& L_0 \ar[r]_{m'_{\tau(0)}} \ar@/^.4cm/[rr]^{m_{k}} \ar[l]_{m_{0}} &G'_{\tau(0)} \ar[d]^(.45){\iota'_{G'_{\tau(0)}}} & G_{k} \ar[d]^{\iota_{G_k}}\\ \lpro\der{D}_1 \rpro \ar[r]_{\xi_{\tau}} &\lpro \der{D}'_1\rpro \ar[r]_{q'_1} & \lpro \der{D'}\rpro & \tpro{D} \ar[l]^{\xi_{\sigma}}}\]
		From \Cref{cor:ele}, we can conclude that there exists $c\colon L_0\to D_0$ such that $f_0\circ c=m_0$. We thus have the solid part of the commutative diagram below.
		\[\xymatrix{L_0 \ar@/^.3cm/[drr]^{\id{L_0}} \ar@{.>}[dr]_{t} \ar@/_.3cm/[ddr]_{c}\\ & K_0 \ar[d]_{k_0}\ar@{>->}[r]^{l_0}& L_0 \ar[d]^{m_0} \\& D_0 \ar@{>->}[r]_{f_0} & G_0} \]
		The internal square is an $\mathcal{M}$-pushout and thus a pullback, by \Cref{prop:pbpoad}, so that we have the existence of the dotted $t\colon L_0\to K_0$. Therefore $\id{L_0}=l_0\circ t$, proving that $l_0$ is an epimorphism. The thesis now follows from \Cref{cor:rego}. 
		\item  Let $k$ be $\sigma^{-1}(\tau(j-1))$ and notice that $\rho_{j-1}=\rho_k$. We have already noticed in \Cref{rem:minmax} that $j-1$ is the maximum of $E_{\sigma, \tau}$.  Hence, by the third point of \Cref{prop:uniqu} we have
		\[\xymatrix@C=40pt{G_{1,{j-1}} \ar[drrr]_(.4){\iota_{G_{j-1}}}|(.675)\hole \ar[d]_{\iota_{1,G_{1,j-1}}}& L_{j-1} \ar[r]_{m'_{\tau({j-1})}} \ar@/^.4cm/[rr]^{m_{k}} \ar[l]_{m_{{j-1}}} &G'_{\tau({j-1})} \ar[d]^{\iota'_{G'_{\tau({j-1})}}} & G_{k} \ar[d]^{\iota_{G_k}}\\ \lpro\der{D}_1 \rpro \ar[r]_{\xi_{\tau}} &\lpro \der{D}'_1\rpro \ar[r]_{q'_1} & \lpro \der{D'}\rpro & \tpro{D} \ar[l]^{\xi_{\sigma}}}\]
		Let $a$ be $\min(j-1, k)$, by \Cref{cor:ele},  there exists $c\colon L_{j-1}\to D_a$ such that $f_a\circ c=m_a$. As before this yields the solid part of the following diagram, in which the square is an $\mathcal{M}$-pushout.
		\[\xymatrix{L_{j-1} \ar@/^.3cm/[drr]^{\id{L_{j-1}}} \ar@{.>}[dr]_{t} \ar@/_.3cm/[ddr]_{c}\\ & K_{j-1} \ar[d]_{k_a}\ar@{>->}[r]^{l_{j-1}}& L_{j-1} \ar[d]^{m_a} \\& D_a \ar@{>->}[r]_{f_a} & G_a} \]
		The existence of the dotted $t\colon L_{j-1}\to K_{j-1}$ follows from  \Cref{prop:pbpoad} and we can conclude. \qedhere
	\end{enumerate}
\end{proof}


\begin{corollary}[Uniqueness of consistent permutation]\label{cor:unique}
Let $(\X,\R)$ be a consuming left-linear DPO-rewriting system. Then, for every two decorated derivations $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$, there exists at most one consistent permutation between them.
\end{corollary}
\begin{proof}
Let $\sigma, \tau: [0, \lgh(\der{D})-1]\rightrightarrows [0, \lgh(\der{D})-1]$ be two consistent permutations. Let $H$  and $H'$ be, respectively, the target of $\der{D}$ and $\der{D}'$. Take two isomorphisms $\gamma:\pi(H)\to \gamma$, $\gamma':\pi(H')\to H'$, then, according to \Cref{def:conc}:
\begin{align*}(\der{D}, \alpha, \omega)&=(\der{D}, \alpha, \omega)\cdot (\der{D}_2, \gamma, \gamma) \\(\der{D}', \alpha', \omega')&=(\der{D}', \alpha', \omega')\cdot (\der{D}'_2, \gamma', \gamma') 
\end{align*} 
where $\der{D}_2$ and $\der{D}'_2$ are the empty derivation on $H$ and $H'$. Since $(\X, \R)$ is consuming, then \Cref{lem:impo} entails $D_{\sigma, \tau}=\emptyset$, from which the thesis follows.
\end{proof}



\begin{lemma}[Corestriction Lemma]\label{lem:presuffix} Let $(\X, \R)$ be a consuming left-linear DPO-rewriting system.  Let also $(\der{D}_1, \alpha_1, \omega_1)$, $(\der{D}_2, \alpha_2, \omega_2)$ be two composable decorated derivations of length, respectively, $l_1$ and $l_2$. Suppose that $\sigma\colon [0, l_1+l_2-1]\to [0, l_1+l_2-1]$ is a consistent permutation between $(\der{D}_1, \alpha_1, \omega_1)\cdot (\der{D}_2, \alpha_2, \omega_2)$ and $(\der{D}'_1, \alpha'_1, \omega'_1)\cdot (\der{D}'_2, \alpha'_2, \omega'_2)$ for some other two composable decorated derivations $(\der{D}_1, \alpha_1, \omega_1)$ and $(\der{D}_2, \alpha_2, \omega_2)$.  If $\tau\colon [0,l_1-1]\to [0, l_1-1]$ is a consistent permutation between $(\der{D_1}, \alpha_1, \omega_1)$ and $(\der{D}'_1, \alpha'_1, \omega'_1)$. Then the following hold true:
	\begin{enumerate}
		\item suppose that $l_1$ and $l_2$ are different from $0$ and consider the following two pushout squares given by \Cref{rem:dett}:
		\[\xymatrix@C=45pt@R=30pt{\pi(G_{2,0}) \ar@{>->}[d]_{\iota_{1, G_{1,n+1}} \circ \omega_1}\ar[r]^{\iota_{2, G_{2,0}} \circ \alpha_2}& \lpro \der{D}_2 \rpro \ar@{>->}[d]^{q_2} &  \pi(G'_{2,0}) \ar@{>->}[d]_{\iota'_{1, G'_{1,n+1}} \circ \omega'_1} \ar[r]^{\iota'_{2, G'_{2,0}} \circ \alpha'_2}& \lpro \der{D}'_2 \rpro \ar@{>->}[d]^{q'_2} \\ \lpro \der{D}_1 \rpro  \ar[r]_{q_1} & \tpro{D} & \lpro \der{D}'_1\rpro \ar[r]_{q'_1} & \lpro \der{D}'\rpro  }\]
		then, for every $i\in [0, l_2]$ there exists a unique $\zeta_i\colon G_{2,i}\to \lpro \der{D}_2\rpro $ fitting in the diagram below
		\[\xymatrix@R=35pt{G_{2,i} \ar[r]^{\iota_{2,G_{2,i}}} \ar@{.>}[d]_{\zeta_i}&\lpro \der{D}_2 \rpro \ar@{>->}[r]^{q_2}& \tpro{D} \ar[d]^{\xi_{\sigma}} \\
			\lpro \der{D}'_2 \rpro \ar@{>->}[rr]_{q'_2}&& \lpro \der{D}'\rpro }\]
		\item the permutation
		\[\varrho\colon [0,l_2-1]\to [0, l_2-1] \qquad i \mapsto \sigma(i+l_1)-l_1\]
		is a consistent one.
	\end{enumerate}
\end{lemma}
\begin{proof}\begin{enumerate}
		\item We can start noticing that  by \Cref{lem:impo}, $\sigma(i)=\tau(i)$ for every $i\in  [0, l_1-1]$. By the second point of \Cref{prop:uniqu} we can deduce that
		\[\xi_\sigma \circ \iota_{G_{i}}=\]Let us prove the existence of $\zeta_i$ by induction on $i\in [0, l_2]$.
		
		\smallskip \noindent $i=0$. We already know that $G_{l_1}$ and $G'_{l_1}$ are both equal to $\pi(G_{2,0})$.  Moreover, we also know that
		\begin{align*}
		q_2\circ \iota_{2, G_{2,0}}=\iota_{G_{l_1}} \circ \alpha^{-1}_2 \qquad
		\end{align*}

		Thus we have a diagram
		\[\xymatrix{&G_{2,0} \\
		G_{l_1} \\
		G'_{2,0}&}\]
		
	Moreover, $\pi(mj$
		\begin{align*}
			\xi_\sigma \circ p_2\circ \iota_{2, G_{2,0}}&=\xi_\sigma \circ \iota_{G_{n+1}}\circ \alpha^{-1}_2\\&g
		\end{align*}

		\smallskip \noindent $i>0$.
		
		
		The uniqueness half of the thesis follows at once since $p'_2$ is in $\mathcal{M}$. 
		
		\item Let us split the cases.
		
		\smallskip \noindent $l_1=0$. then $\varrho=\sigma$ and there is nothing to proof. 
		
		\smallskip \noindent $l_2=0$ and $l_1\neq0$. Then $\varrho=\id{\emptyset}$ and
		
		\smallskip \noindent $l_1\neq0$ and $l_2\neq 0$. 
		\[\xymatrix{xy code}\]
		
		
		
		Consistency now follows at once. \qedhere 
	\end{enumerate}
\end{proof}


Finally, we  end this section showing that consistent permutations between composable abstract derivations yield a consistent permutation between the composites.

\begin{lemma}\label{lem:sum} Let $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ be two abstract decorated derivations such that
	\[(\der{D}, \alpha, \omega)=(\der{D}_1, \alpha_1, \omega_1)\cdot (\der{D}_2, \alpha_2, \omega_2) \qquad (\der{D}', \alpha', \omega')=(\der{D}'_1, \alpha'_1, \omega'_1)\cdot (\der{D}'_2, \alpha'_2, \omega'_2)\]
	Given a consistent permutation $\sigma\colon [0, \lgh(\der{D}_1)-1]\to [0, \lgh(\der{D}_1)-1]$ between  $(\der{D}_1, \alpha_1, \omega_1)$ and $(\der{D}'_1, \alpha'_1, \omega'_1)$ and another $\tau\colon [0, \lgh(\der{D}_2)-1]\to [0, \lgh(\der{D}_2)-1]$ between $(\der{D}_2, \alpha_2, \omega_2)$ and $(\der{D}'_2, \alpha'_2, \omega'_2)$, then 
	\[\sigma+\tau\colon[0, \lgh(\der{D})-1]\to[0, \lgh(\der{D})-1] \quad i \mapsto \begin{cases}
		\sigma(i) & i < \lgh(\der{D}_1)\\
		\lgh(\der{D}_1)+\tau(i-\lgh(\der{D}_1)) &   i\geq \lgh(\der{D}_1) 
	\end{cases}\]
	is a consistent permutation between $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$.
\end{lemma}


\begin{notation}
Given $X_1\in \Delta(\der{D}_1)$, $X_2\in \Delta(\der{D}_2)$, $X'_1\in \Delta(\der{D}'_1)$, $X'_2\in \Delta(\der{D}'_2)$, we will denote their coprojections into, respectively, $\lpro \der{D}_1\rpro$, $\lpro \der{D}'_2\rpro$, $\lpro \der{D}'_1\rpro$, $\lpro \der{D}'_2\rpro$ by
$\iota_{1, X_1}\colon X_1\to \lpro\der{D}_1\rpro$, $\iota_{1, X_2}\colon X_2\to \lpro\der{D}_1\rpro$, $\iota'_{1, X'_1}\colon X'_1\to \lpro\der{D}'_1\rpro$ and $\iota'_{2, X'_2}\colon X'_2\to \lpro\der{D}_1\rpro$. Similarly, given $X\in \Delta(\der{D})$ and $X'\in \Delta(\der{D}')$ we will use $\iota_X\colon X\to \tpro{D}$ and $\iota'_{X'}\colon X'\to \lpro \der{D}' \rpro$ for the coprojections.
\end{notation}

\begin{proof}
We split the proof in three cases, according to \Cref{def:conc}.
	\begin{itemize}
	\item $\lgh(\der{D}_1)=0$. Thus $\lgh(\der{D}'_1)=0$ too  and we have
	\[
	(\der{D}, \alpha, \omega)=(\der{D}_2, \alpha_2\circ \omega_1^{-1}\circ \alpha_1, \omega_2) \qquad  (\der{D}', \alpha', \omega')=(\der{D}'_2, \alpha'_2\circ (\omega'_1)^{-1}\circ \alpha'_1, \omega'_2)\]

	Moreover, in this case $\sigma$ must be $\id{\emptyset}$ and $\sigma+\tau$ must be equal to $\tau$. The thesis now follows from the commutativity of the following diagram.
	\[\xymatrix@C=35pt{& G_{1,0}\ar[dd]^{\xi_{\id{\emptyset}}} \ar[dr]^{\omega^{-1}_1}&&G_{2,0}\ar[r]^-{\iota_{2, G_{2,0}}} & \lpro \der{D}_2\rpro \ar[dd]^{\xi_{\tau}}\\\pi(G_{1,0})  \ar[ur]^{\alpha_1} \ar[dr]_{\alpha'_1}&& \pi(G_{2,0}) \ar[ur]^{\alpha_2} \ar[dr]_{\alpha'_2}\\& G'_{1,0} \ar[ur]_{(\omega'_1)^{-1}}&&G'_{2,0} \ar[r]_-{\iota'_{2, G_{2,0}}}& \lpro \der{D}'_2\rpro}\]
	
\item $\lgh(\der{D}_2)=0$.  As before this implies that also $\lgh(\der{D}'_2)$ is $0$.  Applying \Cref{def:conc} we get 
\[
(\der{D}, \alpha, \omega)=(\der{D}_1, \alpha_1, \omega_1 \circ (\alpha_2)^{-1}\circ \omega_2) \qquad (\der{D}', \alpha', \omega')=(\der{D}'_1, \alpha'_1, \omega'_1 \circ (\alpha'_2)^{-1}\circ \omega'_2)\]
	
	Since $\der{D}_2$ is empty, then $\tau=\id{\emptyset}$ and $\sigma+\tau=\sigma$. Let $n$ be $\lgh(\der{D}_1)$, as before the thesis follows from the diagram below.
	\[\xymatrix@C=35pt{& G_{2,0}\ar[dd]^{\xi_{\id{\emptyset}}} \ar[dr]^{\alpha^{-1}_2}&&G_{1,n}\ar@{>->}[r]^-{\iota_{1, G_{1,n}}} & \lpro \der{D}_2\rpro \ar[dd]^{\xi_{\sigma}}\\\pi(G_{2,0})  \ar[ur]^{\omega_2} \ar[dr]_{\omega'_2}&& \pi(G_{1,n}) \ar[ur]^{\omega_1} \ar[dr]_{\omega'_1}\\& G'_{2,0} \ar[ur]_{(\alpha'_1)^{-1}}&&G'_{1,n} \ar@{>->}[r]_-{\iota'_{1, G_{1,n}}}& \lpro \der{D}'_2\rpro}\]
	
\item  $\lgh(\der{D}_1)\neq0$ and $\lgh(\der{D}_2)\neq 0$. Thus $\der{D}'_1$ and $\der{D}'_2$ are non-empty too. In this case we have
\[	(\der{D}, \alpha, \omega)=(\der{D}_1*\omega_1^{-1}\cdot \alpha_2*\der{D}_2, \alpha_1, \omega_2)\qquad
(\der{D}', \alpha', \omega')=(\der{D}'_1*(\omega'_1)^{-1}\cdot \alpha'_2*\der{D}'_2, \alpha'_1, \omega'_2)\]

Let us assume that $\der{D}_1$, $\der{D}'_1$, $\der{D}_2$ and $\der{D}'_2$ are given by
\[\der{D}_1=\{\dder{D}_{1,i}\}_{i=0}^n \quad \der{D}'_1=\{\dder{D}'_{1,i}\}_{i=0}^n \quad \der{D}_2=\{\dder{D}_{2,i}\}_{i=0}^t \quad \der{D}_2'=\{\dder{D}'_{2,i}\}_{i=0}^t\]
By definition of consistent permutation, the rule applied by $\dder{D}_{1,i}$ and the one applied in $\dder{D}_{2,i}$  must coincide with, respectively, the one applied in $\dder{D}'_{1,i}$ and the one applied $\dder{D}'_{2,1}$. Let $\dder{D}_{1,i}$, $\dder{D}'_{1,i}$, $\dder{D}_{2,i}$ and $\dder{D}'_{2,i}$ be given, by the following four diagrams. 
\[\xymatrix{L_{1,i} \ar[d]_{m_{1, i}}& K_{1,i} \ar[d]_{k_{1, i}} \ar[r]^{r_{1,i}} \ar@{>->}[l]_{l_{1,i}} & R_{1,i}\ar[d]^{h_{1, i}} &L_{1,i} \ar[d]_{m'_{1, i}}& K_{1,i} \ar[d]_{k'_{1, i}} \ar[r]^{r_{1,i}} \ar@{>->}[l]_{l_{1,i}} & R_{1,i}\ar[d]^{h'_{1, i}} \\G_{1,i} & D_{1,i} \ar[r]_{g_{1,i}} \ar@{>->}[l]^{f_{1,i}} & G_{1,i+1} & G'_{1,i} & D'_{1,i}\ar[r]_{g'_{1,i}} \ar@{>->}[l]^{f'_{1,i}}  & G'_{1,i+1}}\]		
\[\xymatrix{L_{2,i} \ar[d]_{m_{2, i}}& K_{2,i} \ar[d]_{k_{2, i}} \ar[r]^{r_{2,i}} \ar@{>->}[l]_{l_{2,i}} & R_{2,i}\ar[d]^{h_{2, i}} &L_{2,i} \ar[d]_{m'_{2, i}}& K_{2,i} \ar[d]_{k'_{2, i}} \ar[r]^{r_{2,i}} \ar@{>->}[l]_{l_{2,i}} & R_{2,i}\ar[d]^{h'_{2, i}} \\G_{2,i} & D_{2,i} \ar[r]_{g_{2,i}} \ar@{>->}[l]^{f_{2,i}} & G_{2,i+1} & G'_{2,i} & D'_{2,i}\ar[r]_{g'_{2,i}} \ar@{>->}[l]^{f'_{2,i}}  & G'_{2,i+1}}\] 

%Let $(\lpro \der{D}_1*(\omega_1)^{-1}\rpro, \{j_X\}_{X\in \Delta( \der{D}_1*(\omega_1)^{-1})})$, $(\lpro \der{D}'_1*(\omega'_1)^{-1}\rpro, \{j'_X\}_{X\in \Delta( \der{D}'_1*(\omega'_1)^{-1})})$, $(\lpro \der{D}_1*(\omega_1)^{-1}\rpro, \{j_X\}_{X\in \Delta( \der{D}_1*(\omega_1)^{-1})})$ and $(\lpro \der{D}'_1*(\omega'_1)^{-1}\rpro, \{j'_X\}_{X\in \Delta( \der{D}'_1*(\omega'_1)^{-1})})$ be colimiting cocones. 
By \Cref{rem:dett} we get the following diagram, in which the two solid squares are pushouts:
\[\xymatrix@C=45pt@R=30pt{\pi(G_{2,0}) \ar@/^.4cm/[rrr]^{\id{\pi(G_{2,0})}}\ar@{>->}[d]_{\iota_{1, G_{1,n+1}} \circ \omega_1}\ar[r]_{\iota_{2, G_{2,0}} \circ \alpha_2}& \lpro \der{D}_2 \rpro \ar@{>->}[d]^{q_2}\ar[r]_{\xi_\tau} & \lpro \der{D}'_2 \rpro \ar@{>->}[d]_{q'_2} &\pi(G'_{2,0}) \ar@{>->}[d]^{\iota'_{1, G'_{1,n+1}} \circ \omega'_1} \ar[l]^{\iota'_{2, G'_{2,0}} \circ \alpha'_2}\\ \lpro \der{D}_1 \rpro \ar@/_.4cm/[rrr]_{\xi_\sigma} \ar[r]^{q_1} & \tpro{D} \ar@{.>}[r]^{\xi_{\sigma+\tau}} & \lpro \der{D}'\rpro & \lpro \der{D}'_1\rpro  \ar[l]_{q'_1}}\]

Moreover, we can point out that, for every index $i\in [0,n+t+2]$ we have

\[\iota_{G_i}=\begin{cases}q_1\circ \iota_{1, G_{1,i}} & i \leq n\\
	q_1\circ \iota_{1, G_{1, i}}\circ \omega_1& i=n+1\\
	q_2\circ \iota_{2, G_{2,i-(n+1)}} & i > n+1 
\end{cases} \qquad \iota'_{G'_i}=\begin{cases}q'_1\circ \iota'_{1, G'_{1,i}} & i \leq n\\
	q'_1\circ \iota'_{1, G'_{1, i}}\circ \omega'_1& i=n+1\\
	q'_2\circ \iota'_{2, G'_{2,i-(n+1)}} & i > n+1 
\end{cases}\]

Now, on the one hand, the existence of the dotted arrow $\xi_{\sigma+\tau}\colon \tpro{D}\to \lpro \der{D}'\rpro$ in the diagram above follows from the following computation:
\begin{align*}
	q'_1\circ \xi_\sigma \circ \iota_{1, G_{1,n+1}} \circ \omega_1&=q'_1\circ \iota'_{1,G'_{1, n+1}} \circ \omega'_1\\&= q'_2 \circ \iota'_{2, G'_{2,0}} \circ \alpha'_2\\&=q'_2\circ \xi_\tau \circ \iota_{2, G_{2,0}} \circ \alpha_2
\end{align*} 
On the other hand, we can repeat the same computation for $\xi^{-1}_\sigma$ and $\xi^{-1}_\tau$ to get
\begin{align*}
	q_1\circ \xi^{-1}_\sigma \circ \iota'_{1, G'_{1,n+1}} \circ \omega'_1&=q_1\circ \iota_{1,G_{1, n+1}} \circ \omega_1\\&= q_2 \circ \iota_{2, G_{2,0}} \circ \alpha_2\\&=q_2\circ \xi^{-1}_\tau \circ \iota'_{2, G'_{2,0}} \circ \alpha'_2
\end{align*} 
Hence there exists a $\psi\colon \lpro \der{D}'\rpro \to \tpro{D}$ such that:
\[\psi \circ q'_1=q_1\circ \xi^{-1}_\sigma \qquad \psi \circ q'_2=q_2\circ \xi^{-1}_\tau\]

Furthermore, the computations below show that $\psi$ is the inverse of $\xi_{\sigma+\tau}$.
\[\begin{split}
	\psi \circ \xi_{\sigma+\tau}\circ  q_1&=\psi \circ q'_1\circ \xi_\sigma \\&=q_1\circ \xi^{-1}_{\sigma}\circ \xi_\sigma\\&=q_1\\\\
	\xi_{\sigma+\tau}\circ \psi \circ q'_1&=\xi_{\sigma+\tau}\circ q_1\circ \xi^{-1}_\sigma \\&=q'_1\circ \xi_{\sigma}\circ \xi^{-1}_\sigma\\&=q'_1
\end{split}\qquad \begin{split}
	\psi \circ \xi_{\sigma+\tau}\circ  q_2&=\psi \circ q'_2\circ \xi_\tau \\&=q_2\circ \xi^{-1}_{\tau}\circ \xi_\tau\\&=q_2\\ \\ 	\xi_{\sigma+\tau}\circ \psi \circ q'_2&=\xi_{\sigma+\tau}\circ q_2\circ \xi^{-1}_\tau \\&=q'_2\circ \xi_{\tau}\circ \xi^{-1}_\tau\\&=q'_2
\end{split}\]
To conclude we have to show that $\xi_{\sigma+\tau}$ fits in the diagrams of \Cref{def:permcon}.  For the ones involving the decorations we have:
\[\begin{split}
	\xi_{\sigma+\tau} \circ \iota_{G_{0}}\circ \alpha&=\xi_{\sigma+\tau} \circ q_1 \circ \iota_{1,G_{1,0}}\circ \alpha_1\\&=q_1'\circ \xi_\sigma \circ  \iota_{1,G_{1,0}} \alpha_1\\&=q'_1\circ \iota'_{1, G'_{1,0}}\circ \alpha'_1\\&=\iota'_{G'_0}\circ \alpha'
\end{split}  \qquad 
\begin{split}
\xi_{\sigma+\tau} \circ \iota_{G_{n+t+2}}\circ \omega&=\xi_{\sigma+\tau} \circ q_2 \circ \iota_{2,G_{2,t+1}}\circ \omega_2\\&=q'_2\circ \xi_\tau \circ  \iota_{2,G_{2,t+1}} \omega_2\\&=q'_2\circ \iota'_{2, G'_{2,t+1}}\circ \omega'_2\\&=\iota'_{G'_{n+t+2}}\circ \omega'
\end{split}  \]

Let now $i$ be an index in $[0, n+t+1]$, we proceed splitting the cases.
\begin{itemize}
	\item $i$ is in $[0,n]$. Then we have
	\begin{align*}
		\xi_{\sigma+\tau}\circ \iota_{G_i} \circ m_i &= \xi_{\sigma+\tau} \circ q_1\circ \iota_{1, G_{1,i}}\circ m_{1,i}\\&=q'_1 \circ \xi_\sigma \circ \iota_{1, G_{1,i}}\circ m_{1,i}\\&= q'_1\circ \iota'_{1, G'_{1,\sigma(i)}}\circ m'_{1,\sigma(i)}\\&=\iota'_{G'_{\sigma(i)}}\circ m'_{\sigma(i)}
	\end{align*}
	Now, suppose that $i\neq n$, then 
	\begin{align*}
		\xi_{\sigma+\tau}\circ \iota_{G_{i+1}} \circ h_i &= \xi_{\sigma+\tau} \circ q_1\circ \iota_{1, G_{1,{i+1}}}\circ h_{1,i}\\&=q'_1\circ \xi_\sigma \circ \iota_{1, G_{1,{i+1}}}\circ h_{1,i}\\&= q'_1\circ \iota'_{1, G'_{1,\sigma(i)+1}}\circ h'_{1,\sigma(i)}
	\end{align*}
	and we have two subcases. If $\sigma(i)\neq n$, then \[h'_{1, \sigma(i)}=h'_{\sigma(i)} \qquad q'_1\circ \iota'_{1, G'_{1,\sigma(i)+1}}=
	\iota'_{G'_{\sigma(i)+1}}\] 
	and we can conclude. Otherwise, we have
	\begin{align*}q'_1\circ \iota'_{1, G'_{1,n+1}}\circ h'_{1,n}&=q'_1 \circ \iota'_{1,G'_{1,n+1}} \circ \omega'_1\circ (\omega')^{-1}_1 \circ h'_{1,n}\\&=\iota'_{G'_{n+1}}\circ h'_n
	\end{align*}
	yielding again the wanted equality
	\[\xi_{\sigma+\tau}\circ \iota_{G_{i+1}} \circ h_i=\iota'_{G'_{\sigma(i)+1}}\circ h'_{\sigma(i)}\]
	Finally, if $i=n$ we get
	\begin{align*}
		\xi_{\sigma+\tau}\circ \iota_{G_{n+1}} \circ h_n &= \xi_{\sigma+\tau} \circ \iota_{\pi(G_{1,n+1})} \circ \omega^{-1}_1\circ h_{1,n}\\&= \xi_{\sigma+\tau} \circ q_1\circ \iota_{1, G_{1,n+1}} \circ \omega_1 \circ \omega^{-1}_1 \circ h_{1,n}\\&=q'_1 \circ \xi_\sigma \circ \iota_{1, G_{1,n+1}} \circ h_{1,n}\\&=q'_1\circ \iota'_{1, G_{1,\sigma(n)+1}} \circ h'_{1,\sigma(n)}
	\end{align*}
	We have again two cases. If $\sigma(n)\neq n$ then we can conclude at once since 
	\[h'_{1, \sigma(n)}=h'_{\sigma(n)} \qquad q'_1\circ \iota'_{1, G'_{1,\sigma(n)+1}}=
	\iota'_{G'_{\sigma(n)+1}}\] 
	While, if $\sigma(n)=n$, then we can use the identities
	\[(\omega'_1)^{-1}\circ h'_{1, n}=h'_{n} \qquad q'_1\circ \iota'_{1, G'_{1, n+1}}=
	\iota'_{G'_{n+1}}\circ (\omega'_1)^{-1}\] 
	to get
	\begin{align*}
		\xi_{\sigma+\tau}\circ \iota_{G_{n+1}} \circ h_n &= q'_1\circ \iota'_{1, G_{1,n+1}} \circ h'_{1,n}\\&=\iota'_{G'_{n+1}}\circ (\omega'_1)^{-1}\circ h'_{1,n}\\&=\iota'_{G'_{n+1}} h'_{n}
	\end{align*}
	\item $i$ is in $[n+1, n+t+1]$- We proceed  similarly to the point above. First of all we have
	\begin{align*}
		\xi_{\sigma+\tau}\circ \iota_{G_{i+1}} \circ h_i &= \xi_{\sigma+\tau} \circ q_2\circ \iota_{1, G_{2,i-n}}\circ h_{2,i-(n+1)}\\&=q'_2 \circ \xi_\tau \circ \iota_{2, G_{2,i-n}}\circ h_{2,i-(n+1)}\\&= q'_2\circ \iota'_{2, G'_{2,\tau(i-n)}}\circ h'_{2,\tau(i-(n+1))}\\&=\iota'_{G'_{\tau(i-n)}}\circ h'_{n+1+\tau(i-(n+1))}
	\end{align*}
	Next, supposing that $i\neq n+1$:	
	\begin{align*}
		\xi_{\sigma+\tau}\circ \iota_{G_{i}} \circ m_i &= \xi_{\sigma+\tau} \circ q_2\circ \iota_{2, G_{2,i-(n+1)}}\circ m_{2,i-(n+1)}\\&=q'_2\circ \xi_\tau \circ \iota_{2, G_{2,{i-(n+1)}}}\circ m_{2,i-(n+1)}\\&= q'_2\circ \iota'_{2, G'_{2,\tau(i-(n+1))}}\circ m'_{2,\tau(i-(n+1))}
	\end{align*}
	and we have again two possibilities. If $\tau(i-(n+1))\neq 0$, then the thesis follows from the equalities \[m'_{2, \tau(i-(n+1))}=m'_{(\sigma+\tau)(i)} \qquad q'_2\circ \iota'_{2, G'_{2,\tau(i-(n+1))}}=
	\iota'_{G'_{(\sigma+\tau)(i)}}\] 
	Suppose, instead, that $\tau(i-(n+1))= 0$, then we have
	\begin{align*} q'_2\circ \iota'_{2, G'_{2,0}}\circ m'_{2,0}&=q'_2 \circ \iota'_{2,G'_{2,0}} \circ \alpha'_2 \circ \alpha'^{-1}_2 \circ m'_{2,0}\\&=q'_1\circ \iota'_{1, G'_{1, n+1}}\circ \omega'_1\circ \alpha'^{-1}_2 \circ m'_{2,0}\\&=\iota'_{G'_{n+1}}\circ m'_{n+1}
	\end{align*}
	allowing us to conclude again.	
	
	We are left with the case $i=n+1$. Let us compute
	\begin{align*}
		\xi_{\sigma+\tau}\circ \iota_{G_{n+1}} \circ m_{n+1} &= \xi_{\sigma+\tau} \circ \iota_{\pi(G_{2,0})} \circ (\alpha'_2)^{-1}\circ m_{2,0}\\&=\xi_{\sigma+\tau} \circ q_1\circ \iota_{1, G_{1,n+1}} \circ \omega_1 \circ (\alpha'_2)^{-1}\circ m_{2,0}\\&=\xi_{\sigma+\tau} \circ q'_2 \circ \iota'_{2,G'_{2,0}} \circ \alpha'_2 \circ (\alpha'_2)^{-1}\circ m_{2,0} \\&=q'_2 \circ \xi_\tau \circ \iota_{2, G_{2,0}} \circ m_{2,0}\\&=q'_2\circ \iota'_{2, G_{2,\tau(0)}} \circ m'_{2,\tau(0)}
	\end{align*}
	We have again two cases. If $\tau(0)\neq 0$ then $(\sigma+\tau)(i)\neq n+1$ and we can conclude at once since 
	\[m'_{2, \tau(0)}=m'_{(\sigma+\tau)(n+1)} \qquad q'_2\circ \iota'_{2, G'_{2,\tau(0)}}=
	\iota'_{G'_{(\sigma+\tau)(0)}}\] 
	If $\tau(0)=0$, so that  $(\sigma+\tau)(0)= n+1$ we appeal to the equalities
	\[(\alpha')^{-1}_2\circ m'_{2, 0}=m'_{n+1} \qquad q'_2\circ \iota'_{2, G'_{2, 0}}=
	\iota'_{G'_{n+1}}\circ (\alpha'_2)^{-1}\] 
	to get
	\begin{align*}
		\xi_{\sigma+\tau}\circ \iota_{G_{n+1}} \circ m_{n+1} &= q'_2\circ \iota'_{2, G_{2,\tau(0)}} \circ m'_{2,\tau(0)}\\&=	\iota'_{G'_{n+1}}\circ (\alpha'_2)^{-1}\circ m'_{2,0}\\&=\iota'_{G'_{n+1}}\circ  m'_{n+1}
	\end{align*}
\end{itemize}
The thesis now follows at once.	 \qedhere 
\end{itemize} \end{proof}








\section{Independence in rewriting}
\todo{A VERY NICE INTRO}


\subsection{Sequentially independent and switchable derivations }
\todo{this is an attempt to rewrite in a better way the following section. Hopefully this will spare us the use of fillers}
\todo{A VERY NICE INTRO}

\begin{definition}[Sequential independence]
  \label{de:sequential-independence}
  Let $(\X, \R)$ be a left-linear DPO-rewriting system with $\X$ an $\mathcal{M}$-adhesive category. Let also $\dder{D}\colon G\Mapsto H$ and $\dder{D'}\colon H\Mapsto T$ be the two direct derivations depicted below.
	
	\[\xymatrix{L \ar[d]_{m}& K \ar[d]^{k}\ar[l]_{l} \ar[r]^{r} & R \ar[d]^{h} & L' \ar[d]_{m'}& K' \ar[d]^{k'}\ar[l]_{l'} \ar[r]^{r'} & R' \ar[d]^{h'}\\G & \ar[l]^{f} D \ar[r]_{g}& H & H & \ar[l]^{f'} D' \ar[r]_{g'}& T}\]
	
	An \emph{independence pair} between $\dder{D}$ and $\dder{D'}$, is a pair of  arrows $i_1\colon R\to D'$ and $i_2\colon L'\to D$ such that the following diagram commutes.
	
	\[\xymatrix@C=15pt{L \ar[d]_{m}&& K \ar[d]_{k}\ar[ll]_{l} \ar[r]^{r} & R \ar@/^.35cm/@{.>}[drrr]|(.3)\hole_(.4){i_0} \ar[dr]|(.3)\hole_{h} && L' \ar@/_.35cm/@{.>}[dlll]^(.4){i_1} \ar[dl]|(.3)\hole^{m'}& K' \ar[d]^{k'}\ar[l]_{l'} \ar[rr]^{r'} && R' \ar[d]^{h'}\\G && \ar[ll]^{f} D \ar[rr]_{g}&& H  && \ar[ll]^{f'} D' \ar[rr]_{g'}&& T}\]
	We will say that $\dder{D}$ and $\dder{D'}$ are \emph{weakly sequentially independent} if an independence pair exists. If such independence pair is unique we will say that $\dder{D}$ and $\dder{D'}$ are \emph{sequentially independent}.
\end{definition}

\begin{example}
	\todo{sequential independence}
\end{example}
\begin{example}
	\todo{sequential independence che serva anche per es successivo}
\end{example}


 Let $(i_0, i_1)$ and $(i'_0, i'_1)$ be independence pairs for the direct derivations $\dder{D}$ and $\dder{D'}$. Notice that, by definition, we have
	\begin{align*}f'\circ i_0&=h\\&=f'\circ i'_0
	\end{align*}
	On the other hand, 
	$f'\colon D'\to H$ is  the pushout of $l'\colon K'\to L'$ and so it is in $\mathcal{M}$, implying $i_0=i'_0$. If, moreover, we suppose that the rule $\rho$ applied in $\dder{D}$ is linear, then $g\colon D\to H$ is in $\mathcal{M}$ too, hence, from the equation
	\begin{align*}
		g\circ i_1&=h \\&= g\circ i'_1
	\end{align*}
	we can deduce that $i'_0=i'_1$, too. Summing up, we have just proved the following.
	
	\begin{proposition}\label{rem:weak}
	Let $(\X, \R)$ be a linear DPO-rewriting system, then two direct derivations $\dder{D}$ and $\dder{D}'$ are weakly sequential independet if and only if they are sequential independent. 
\end{proposition}


We want to be able to exchange to switch the application of two rules used by two consecutive weakly independent direct derivations. This leads us to the following definition.

\begin{definition}[Switch]
  \label{de:switch}
 Let $(\X, \R)$ be a left-linear DPO-rewriting system with $\X$ an $\mathcal{M}$-adhesive category and suppose that $\der{D}=\{\dder{D}_i\}_{i=0}^1$  is a derivation of length $2$ made by the following two weakly sequentially independent derivations $\dder{D}_0$, $\der{D}_1$, with independence pair $(i_0, i_1)$:
 	\[\xymatrix@C=15pt{L_0 \ar[d]_{m_0}&& K_0 \ar[d]_{k_0}\ar[ll]_{l_0} \ar[r]^{r_0} & R_0 \ar@/^.35cm/[drrr]|(.3)\hole_(.4){i_0} \ar[dr]|(.3)\hole_{h_0} && L_1 \ar@/_.35cm/[dlll]^(.4){i_1} \ar[dl]|(.3)\hole^{m_1}& K_1 \ar[d]^{k_1}\ar[l]_{l_1} \ar[rr]^{r_1} && R_1 \ar[d]^{h_1}\\G_0 && \ar[ll]^{f_0} D_0 \ar[rr]_{g_0}&& G_1  && \ar[ll]^{f_1} D_1 \ar[rr]_{g_1}&& G_2}\]
 	
 	Take another derivation $\der{E}=\{\dder{E}_i\}_{i=0}^1$ with source $G_0$ and target $G_2$ and in which $\der{E}_0$, $\der{E}_1$ are
\[\xymatrix{L_{\der{E},0} \ar[d]_{m_{\der{E},0}}& K_{\der{E},0} \ar[d]^{k_{\der{E},0}}\ar[l]_{l_{\der{E},0}} \ar[r]^{r_{\der{E},0}} & R_{\der{E},0} \ar[d]^{h_{\der{E},0}} & L_{\der{E},1} \ar[d]_{m_{\der{E},1}}& K_{\der{E},1} \ar[d]^{k_{\der{E},1}}\ar[l]_{l_{\der{E},1}} \ar[r]^{r_{\der{E},1}} & R_{\der{E},1} \ar[d]^{h_{\der{E},1}}\\G_{0} & \ar[l]^{f_{\der{E},0}} D_{\der{E},0} \ar[r]_{g_{\der{E},0}}& G_{\der{E},1} & G_{\der{E},1} & \ar[l]^{f_{\der{E},1}} D_{\der{E},1} \ar[r]_{g_{\der{E},1}}& G_{2}}\]
 	We say that $\der{E}$ is a
 	 	 \emph{switch} of $\der{D}$ along $(i_1, i_2)$ if
 	\begin{enumerate}
 		\item $\dder{E}_0$ applies the rule used by $\dder{D}_1$ and $\dder{E}_1$ the one used by $\dder{D}_0$, so that
 		\[(l_{\der{E},0}, r_{\der{E},0})=(l_1,r_1)  \qquad (l_{\der{E},1}, r_{\der{E},1})=(l_0,r_0)\]
 		\item there exists an independence pair $(j_0, j_1)$ between $\dder{E}_0$ and $\dder{E}_1$ such that
 		\[ m_0=f_{\der{E},0} \circ j_1 \qquad h_1=g_{\der{E},1} \circ j_0\]
 		\item $m_{\der{E},0}= f_0\circ i_1$ and $h_{\der{E},1}= g_{1}\circ i_0$.
 	\end{enumerate}
\end{definition}

\begin{remark}\label{rem:fact}
	Notice that, since $f_{\der{E}, 0}$ is in $\mathcal{M}$, there is at most one $j_1\colon L_0\to D_{\der{E},0}$ such that $m_0=f_{\der{E}, 0} \circ j_1$. Moreover, we already know that there is at most one $j_0\colon R_1\to D_{\der{E},1}$ such that $m_{\der{E},1}=f_{\der{E},1}\circ j_0$, therefore, the independence pair $(j_0,j_1)$ between the component of a switch is uniquely determined.
\end{remark}

Our first result about switches is their uniqueness up to abstraction equivalence.

\begin{theorem}[Uniqueness of switches]\label{thm:switch_uni} Let $\der{D}=\{\dder{D}_i\}_{i=0}^1$  
	
\end{theorem}

\begin{lemma}\label{lem:cose} Let $(\der{D}, \alpha, \omega)$ be a decorated derivation with $\der{D}=\{\dder{D}_i\}_{i=0}^1$,  and suppose that $(i_0, i_1)$ is an independence pair between $\dder{D}_0$  and $\der{D}_1$. If $\der{E}=\{\dder{E}_i\}_{i=0}^1$ is a switch of $\der{D}$ along $(i_0, i_1)$, then the following hold true:
	\begin{enumerate}
			\item the pullback square below is an $\mathcal{M}$-pushout;
			\[\xymatrix{P \ar[r]^{p_1} \ar@{>->}[d]_{p_0}& D_1 \ar@{>->}[d]^{f_1}\\ D_0 \ar[r]_{g_1}& G_1}\]
			\item there exist $q_0\colon P\to D_{\der{E},0}$, $q_1\colon P\to D_{\der{E},1}$ making the squares 
			\[\xymatrix{}\]
			commutative, moreover, they are all pushouts;
			\[\xymatrix{}\]
 		\item there exists an arrow $j_0\colon R_1\to D_{\der{E},1}$ such that 
 		\[h_{\der{E},0}=f_{\der{E},1}\circ j_0 \qquad h_1=g_{\der{E},1} \circ j_0\]
	\end{enumerate}
\end{lemma}
\begin{proof}
	Before starting with the proof of our claims, it is worth noticing that the definition of switchin gives us the following diagram:
			\[\xymatrix@R=28pt{&&R_0 \ar@/_1.15cm/[ddrr]_(.8){i_0}|(.68)\hole \ar[dr]^{h_0}&& L_1\ar@/^1.15cm/[ddll]^(.8){i_1}  \ar[dl]_{m_1}\\&K_0\ar[dr]^{k_0}\ar[dl]_{l_0} \ar[ur]^{r_0}&& G_1 && K_1 \ar[dl]_{k_1}\ar[lu]_{l_1} \ar[dr]^{r_1}\\L_0 \ar@/_.94cm/[ddrr]_(.8){j_1}|(.31)\hole \ar[dr]^(.35){m_0}|(.6)\hole && D_0 \ar[dl]^{f_0}\ar[ur]|(.5)\hole^(.7){g_0}&&D_1 \ar[dr]_{g_1} \ar[ul]|(.5)\hole_(.65){f_1}&&R_1\ar[dl]^(.35){h_1}|(.6)\hole\\&G_0 &&&&G_2\\L_1 \ar@/^.94cm/[uurr]^(.8){i_1} \ar[ur]_(.35){m_{\der{E},0}}|(.61)\hole&&D_{\der{E},0} \ar[ul]_{f_{\der{E},0}}\ar[dr]^{g_{\der{E},0}} &&D_{\der{E},1}\ar[ur]^{g_{\der{E},1}} \ar[dl]|(.5)\hole^(.7){f_{\der{E},1}} && R_0  \ar@/_.94cm/[uull]_(.8){j_1} \ar[ul]^{h_{\der{E},1}}\\&K_1 \ar[ur]_{k_{\der{E},0}} \ar[dr]_{r_1} \ar[ul]^{l_1}&&G_{\der{E},1}&& K_0 \ar[ur]_{r_0} \ar[ul]^{k_{\der{E},1}} \ar[dl]^{l_0} \\&& R_1 \ar[ur]_{h_{\der{E},0}}&& L_0 \ar[ul]^{m_{\der{E},1}} \ar@/_1.15cm/[uull]_(.6){j_1} }\]
			
			Let us turn to our statements.
	\begin{enumerate}
		\item We start noticing that 
		\begin{align*}
			g_0\circ i_1\circ l_1&=m_1\circ l_1\\&=k_1\circ f_1
		\end{align*}
		Thus there exists the dotted $u\colon K_1\to P$ in the diagram
		\[\]
		The thesis now follows applyin \Cref{lem:popb} to
		
		

		\item 
		\item  We already have an arrow $j_1\colon L_0\to D_{\der{E},0}$ such that
		\[m_{\der{E},1}=g_{\der{E},0}\circ j_1\]
		Therefore the thesis follows at once from the previous point.

	
	
	\item 
		
		\item \qedhere 
	\end{enumerate}
\end{proof}

\todo{ $\dder{E}_0$ and $\dder{E}_1$ are weak sequentially independent;

if $\der{E}'=\{\dder{E}'_i\}_{i=0}^1$ is another switching of $\der{D}$ along $(i_0, i_1)$, then there exist arrows.... such that the following diagram commutes:
}
In particular [...]
\begin{definition}\todo{switch}
	contenuto...
\end{definition}
\begin{remark}
Canonico
\end{remark}
\begin{corollary}\todo{inversione}
\end{corollary}
\begin{proof}
	contenuto...
\end{proof}

\begin{lemma}
	\todo{permutazione}
\end{lemma}
\begin{proof}
	contenuto...
\end{proof}


\begin{lemma}\label{lem:swfill}
\todo{equi}
\end{lemma}
\begin{remark}
	\todo{tobias}
\end{remark}
\begin{remark}
	contenuto...
\end{remark}
\begin{proof}
	contenuto...
\end{proof}




When working with linear rewriting systems, (weakly) sequential independent direct derivations can be switched, producing two new (weakly) sequential independent direct derivations between the same objects \cite[Thm.~$7.7$]{lack2005adhesive} . This is no more the case if the rules are only left-linear, as shown by the next example.

\begin{example}\label{ex:difficile}
	\todo{pensare ad un esempio in cui l'indipendenza non basta }
\end{example}



\subsection{Sequentially independent and switchable derivations}
\todo{A VERY NICE INTRO}


\begin{definition}  Let $(\X, \R)$ be a left-linear DPO-rewriting system with $\X$ an $\mathcal{M}$-adhesive category. Let also $\dder{D}\colon G\Mapsto H$ and $\dder{D'}\colon H\Mapsto T$ be the two direct derivations depicted below.
	
	\[\xymatrix{L \ar[d]_{n}& K \ar[d]^{k}\ar[l]_{l} \ar[r]^{r} & R \ar[d]^{h} & L' \ar[d]_{n'}& K' \ar[d]^{k'}\ar[l]_{l'} \ar[r]^{r'} & R' \ar[d]^{h'}\\G & \ar[l]^{f} D \ar[r]_{g}& H & H & \ar[l]^{f'} D' \ar[r]_{g'}& T}\]
	
	An \emph{independence pair} between $\dder{D}$ and $\dder{D'}$, is a pair of  arrows $i_1\colon R\to D'$ and $i_2\colon L'\to D$ such that the following diagram commutes.
	
	\[\xymatrix@C=15pt{L \ar[d]_{n}&& K \ar[d]_{k}\ar[ll]_{l} \ar[r]^{r} & R \ar@/^.35cm/@{.>}[drrr]|(.3)\hole_(.4){i_1} \ar[dr]|(.3)\hole_{h} && L' \ar@/_.35cm/@{.>}[dlll]^(.4){i_2} \ar[dl]|(.3)\hole^{n'}& K' \ar[d]^{k'}\ar[l]_{l'} \ar[rr]^{r'} && R' \ar[d]^{h'}\\G && \ar[ll]^{f} D \ar[rr]_{g}&& H  && \ar[ll]^{f'} D' \ar[rr]_{g'}&& T}\]
	We will say that $\dder{D}$ and $\dder{D'}$ are \emph{weakly sequentially independent} if an independence pair exists. If such independence pair is unique we will say that $\dder{D}$ and $\dder{D'}$ are \emph{sequentially independent}.
\end{definition}

\begin{example}
	\todo{sequential independence}
\end{example}
\begin{example}
	\todo{sequential independence che serva anche per es successivo}
\end{example}

\begin{remark}\label{rem:weak} Let $(i_1, i_2)$ and $(j_1, j_2)$ be independence pairs for the direct derivations $\dder{D}$ and $\dder{D'}$. Notice that, by definition, we have
	\begin{align*}f'\circ i_1&=h\\&=f'\circ j_1
	\end{align*}
	On the other hand, 
	$f'\colon D'\to H$ is  the pushout of $l'\colon K'\to L'$ and so it is in $\mathcal{M}$, implying $j_1=i_1$. If, moreover, we suppose that the rule $\rho$ applied in $\dder{D}$ is linear, then $g\colon D\to H$ is in $\mathcal{M}$ too, hence, from the equation
	\begin{align*}
		g\circ i_2&=h \\&= g\circ j_2
	\end{align*}
	we can deduce that $i_2=j_2$, too.
	
	Summing up, if $(\X, \R)$ is a linear DPO-rewriting system, then sequential independence and weak sequential independence coincide. 
\end{remark}


We want to be able to exchange to switch the application of two rules used by two consecutive weakly independent direct derivations
\begin{definition}
	contenuto...
\end{definition}

\begin{proposition}
	\todo{equi}
\end{proposition}
\begin{remark}
	contenuto...
\end{remark}
\begin{proof}
	contenuto...
\end{proof}




When working with linear rewriting systems, (weakly) sequential independent direct derivations can be switched, producing two new (weakly) sequential independent direct derivations between the same objects \cite[Thm.~$7.7$]{lack2005adhesive} . This is no more the case if the rules are only left-linear, as shown by the next example.

\begin{example}\label{ex:difficile}
	\todo{pensare ad un esempio in cui l'indipendenza non basta }
\end{example}

To fix this problem, we adapt the notion of \emph{canonical filler} from \cite{heindel2009category}.






\begin{definition}\label{def:filler}
Let $(\X, \R)$ be a left-linear DPO-rewriting system with $\X$ $\mathcal{M}$-adhesive. Let also $\dder{D}\colon G\Mapsto H$ and $\dder{D}'\colon H\Mapsto T$ be the two derivations depicted below.
\[\xymatrix{L \ar[d]_{n}& K \ar[d]^{k}\ar[l]_{l} \ar[r]^{r} & R \ar[d]^{h} & L' \ar[d]_{n'}& K' \ar[d]^{k'}\ar[l]_{l'} \ar[r]^{r'} & R' \ar[d]^{h'}\\G & \ar[l]^{f} D \ar[r]_{g}& H & H & \ar[l]^{f'} D' \ar[r]_{g'}& T}\]
Since $f'$ is in $\mathcal{M}$, we can moreover consider a pullback square
\[\xymatrix{P \ar[r]^{p} \ar[d]_{p'}& D\ar[d]^{g} \\ D' \ar[r]_{f'} & H}\]

A \emph{filler} between $\dder{D}$ and $\dder{D}'$ is  given by a pair of arrows $u\colon K\to P$ and $u'\colon K'\to P$ satisfying the following conditions
\begin{enumerate}
	\item $p\circ u = k$, $p'\circ u' = k'$ and there exists a pushout square
\[\xymatrix{K' \ar[r]^{r'} \ar[d]_{u'}& R'\ar@{.>}[d]^{j'} \\ P \ar@{.>}[r]_{q'} & Q'}\]
	\item  there exist arrows $i_1\colon R\to D'$, $i_2\colon L'\to D$ satisfying $f'\circ i_1=h$, $g\circ i_2=n'$ and such that the following squares are pushouts
\[\xymatrix{K \ar[r]^{r} \ar[d]_{u}& R \ar@{.>}[d]^{i_1} &K' \ar[r]^{l'} \ar[d]_{u'}& L'\ar@{.>}[d]^{i_2} \\P \ar[r]_{p'}& D' & P \ar[r]_{p} & D}\]
\end{enumerate}
\end{definition}

\begin{remark}\label{rem:deco} Let $\dder{D}$ and $\dder{D'}$ be two switchable direct derivations. Then the existence of a filler allows us to build the solid part of the diagram below.
	\[\xymatrix{&&R \ar@/_1cm/[ddrr]_(.35){i_1}|(.7)\hole  \ar[dr]^{h}&& L'\ar@/^1cm/[ddll]^(.35){i_2}  \ar[dl]_{n'}\\&K\ar[dr]^{k}\ar[dl]_{l} \ar@/_.8cm/[ddrr]^(.65){u}\ar[ur]^{r}&& H && K' \ar@/^.8cm/[ddll]_(.65){u'}\ar[dl]_{k'}\ar[lu]_{l'} \ar[dr]^{r'}\\L \ar[dr]_{n} \ar@{.>}@/_.8cm/[ddrr]_{j}&& D \ar[dl]|(.42)\hole_(.64){f}\ar[ur]|(.48)\hole^(.7){g}&&D' \ar[dr]|(.42)\hole^(.65){g'} \ar[ul]|(.48)\hole_(.7){f'}&&R'\ar@/^.8cm/[ddll]^{j'}\ar[dl]^{h'}\\&G &&P\ar[dr]^{q'} \ar@{.>}[dl]_{q}\ar[ur]^(.4){p'}\ar[ul]_(.4){p}&&T\\&&Q \ar@{.>}[ul]_{s} &&Q'\ar@{.>}[ur]^{t}}\]
	
	Let us complete this diagram defining the dotted arrows. We can start noticing that, since $l\in \mathcal{M}$, there exists a pushout square 
	\[\xymatrix{K \ar[r]^{l} \ar[d]_{u}& L\ar[d]^{j} \\ P \ar[r]_{q} & Q}\]
	Moreover, the existence of the wanted $s\colon Q\to G$ and $t\colon Q'\to T$ follows from the following equalities
	\[\begin{split}
		f\circ p \circ u &= f\circ k \\&= n\circ l
	\end{split} \qquad \begin{split}
		g'\circ p'\circ u' &= g'\circ k'\\&=h'\circ r'
	\end{split}\]
	
	We can prove some other properties of the arrows appearing in the diagram above. The three rectangles below are pushouts and their left halves are pushouts too. Therefore, by \Cref{lem:po1}, also their right halves are pushouts.
	\[\xymatrix{K \ar@/^.4cm/[rr]^{u}\ar[d]_{r}\ar[r]_{u} &P\ar[d]^{p'} \ar[r]_{p} & D \ar[d]^{g}&K' \ar@/^.4cm/[rr]^{k'}\ar[d]_{l'}\ar[r]_{u'} &P\ar[d]^{p} \ar[r]_{p'} & D' \ar[d]^{f'}\\  R \ar@/_.4cm/[rr]_{h} \ar[r]^{i_1}&D' \ar[r]^{f'} & H&L' \ar@/_.4cm/[rr]_{n'} \ar[r]^{i_2}&D \ar[r]^{g} & H}\]
	\[ \xymatrix{K \ar@/^.4cm/[rr]^{k}\ar[d]_{l}\ar[r]_{u} &P\ar[d]^{q} \ar[r]_{p} & D \ar[d]^{f}&K' \ar@/^.4cm/[rr]^{k'}\ar[d]_{r'}\ar[r]_{u'} &P\ar[d]^{q'} \ar[r]_{p'} & D' \ar[d]^{g'}\\ L \ar@/_.4cm/[rr]_{n} \ar[r]^{j}&Q \ar[r]^{s} & G&R' \ar@/_.4cm/[rr]_{h'} \ar[r]^{j'}&Q' \ar[r]^{t} & T}\]
	
	Notice, moreover, that $p, q$ are the pushouts of $l'$ and $l$, respectively, thus they  are elements of $\mathcal{M}$. By \Cref{prop:pbpoad} the squares
	\[\xymatrix{P\ar[r]^{p} \ar[d]_{p'} & D \ar[d]^{g}& P \ar[r]^{p} \ar[d]_{q} &D\ar[d]^{f}\\ D' \ar[r]_{f'} & H & Q \ar[r]_{s}& G}\]
	are pullbacks too.
\end{remark}


Notice that if there is a filler between  $\dder{D}$ and $\dder{D}'$ are switchable, then they are weakly sequentially independent: indeed, if a filler between them exists, then $(i_1, i_2)$ is an independence pair. On the other hand, \Cref{ex:difficile} shows that not every independence pair arises in this way.

\begin{definition}
  \label{de:good-switchable}
  Let $\dder{D}\colon H\Mapsto H$, $\dder{D}'\colon H\Mapsto T$ be two
  direct derivations in a left-linear DPO-rewriting system $(\X,
  \R)$. An independence pair $(i_1, i_2)$ between $\dder{D}$ and
  $\dder{D}'$ is \emph{good} if there exists a filler $(u,u')$ between
  them such that the squares below are
  pushouts.\[\xymatrix{K \ar[r]^{r} \ar[d]_{u}& R \ar[d]^{i_1} &K'
      \ar[r]^{l'} \ar[d]_{u'}& L'\ar[d]^{i_2} \\P \ar[r]_{p'}& D' & P
      \ar[r]_{p} & D}\]
	
We will say that $\dder{D}$ and $\dder{D}'$ are \emph{switchable} if a good independence pair between them exists. If such a pair is unique, we will say that $\dder{D}$ and $\dder{D}'$ are \emph{uniquely switchable}. We will use the notation $\dder{D}\updownarrow \dder{D'}$ to mean that $\dder{D}$ and $\dder{D}'$ are switchable, while $\dder{D}\updownarrow_! \dder{D'}$ will denote that they are uniquely so.


If every independence pair is good we will say that $(\X, \R)$ is \emph{tame}.
\end{definition}

\begin{remark}\label{rem:unic} Given a good independence pair $(i_1, i_2)$ between $\dder{D}$ and $\dder{D}'$, there is a unique filler  such that $(u,u')$ such that 
	\[\xymatrix{K \ar[r]^{r} \ar[d]_{u}& R \ar[d]^{i_1} &K' \ar[r]^{l'} \ar[d]_{u'}& L'\ar[d]^{i_2} \\P \ar[r]_{p'}& D' & P \ar[r]_{p} & D}\]
	are pushouts. Indeed, for every other filler $(v,v')$, it must be that
	\[\begin{split}
		p\circ u &=k \\&= p\circ v
	\end{split}\qquad \begin{split}
	p\circ u' &= i_2\circ l' \\&= p\circ v'
	\end{split}\]
	Since the arrow $p\colon P\to D$, which is the pullback of $f'$, is in $\mathcal{M}$ we conclude that $(u,u')=(v,v')$.
\end{remark}

\begin{remark}
  Clearly in a tame left-linear DPO-rewriting system two direct derivations are sequentially independent if and only if they are unquely switchable.
\end{remark}

A source of tame left-linear DPO-rewriting systems is given by the linear ones, as shown by the following proposition.

\begin{proposition}\label{prop:equi}Every linear DPO-rewriting system $(\X, \R)$ is tame.
 \end{proposition}
\begin{proof} Suppose that $\X$ is $\mathcal{M}$-adhesive and let $(i_1, i_2)$ be an independence pair between $\dder{D}\colon G\Mapsto H$ and $\dder{D}'\colon H\Mapsto T$. We have a diagram
	\[\xymatrix@C=15pt{L \ar[d]_{n}&& K \ar[d]_{k}\ar[ll]_{l} \ar[r]^{r} & R \ar@/^.35cm/[drrr]|(.3)\hole_(.4){i_1} \ar[dr]|(.3)\hole_{h} && L' \ar@/_.35cm/[dlll]^(.4){i_2} \ar[dl]|(.3)\hole^{n'}& K' \ar[d]^{k'}\ar[l]_{l'} \ar[rr]^{r'} && R' \ar[d]^{h'}\\G && \ar[ll]^{f} D \ar[rr]_{g}&& H  && \ar[ll]^{f'} D' \ar[rr]_{g'}&& T}\]
Pulling back $g$ along $f'$, we get another diagram 
	\[\xymatrix{&&R \ar@/_1cm/[ddrr]_(.35){i_1}|(.7)\hole \ar[dr]^{h}&& L'\ar@/^1cm/[ddll]^(.35){i_2}  \ar[dl]_{n'}\\&K\ar[dr]^{k}\ar[dl]_{l} \ar@{.>}@/_.8cm/[ddrr]^(.65){u}\ar[ur]^{r}&& H && K' \ar@{.>}@/^.8cm/[ddll]_(.65){u'}\ar[dl]_{k'}\ar[lu]_{l'} \ar[dr]^{r'}\\L \ar[dr]_{n} && D \ar[dl]|(.42)\hole_(.64){f}\ar[ur]|(.48)\hole^(.7){g}&&D' \ar[dr]|(.42)\hole^(.65){g'} \ar[ul]|(.48)\hole_(.7){f'}&&R'\ar[dl]^{h'}\\&G &&P\ar[ur]^(.4){p'}\ar[ul]_(.4){p}&&T}\] 
Now, if we compute we get
\[\begin{split}
	f'\circ i_1\circ r &= h\circ r \\&= g\circ k
\end{split}\qquad \begin{split}
g\circ i_2\circ l' &= n'\circ l'\\&=f'\circ k'
\end{split}\]
Therefore the two dotted arrows $u\colon K\to P$ and $u'\colon K'\to P$ exist. We have to show that they satisfy the two conditions in the definition of a filler. 
\begin{enumerate}
	\item  By construction $p\circ u = k$ and $p'\circ u'=k'$. Since $(\X, \R)$ is linear, then $r'\colon K'\to R'$ belongs to $\mathcal{M}$, thus it admits a pushout along $u'\colon K'\to P$, as wanted.
	\item Take the following two rectangles
\[\xymatrix{K \ar@/^.4cm/[rr]^{u}\ar[d]_{r}\ar[r]_{u} &P\ar[d]^{p'} \ar[r]_{p} & D \ar[d]^{f}&K' \ar@/^.4cm/[rr]^{k'}\ar[d]_{l'}\ar[r]_{u'} &P\ar[d]^{p} \ar[r]_{p'} & D' \ar[d]^{f'}\\  R \ar@/_.4cm/[rr]_{h} \ar[r]^{i_1}&D' \ar[r]^{f'} & H&L' \ar@/_.4cm/[rr]_{n'} \ar[r]^{i_2}&D \ar[r]^{g} & H}\]
	By hypothesis $r$ and $l'$ are in $\mathcal{M}$, thus $f'$ and $g$ belong to it too. The first point of \Cref{lem:popb}  yields the thesis. \qedhere 
\end{enumerate}
\end{proof}

\begin{remark} \cite{baldan2011adhesivity} identifies a large class of (quasi)adhesive categories with the property that every left linear DPO-rewriting system on them is tame. We adapt these results to our context in \Cref{app:fill}. 
\end{remark}
\begin{definition}[Very tameneness]
	\todo{very tame}
\end{definition}

\begin{remark}
	\todo{tutto coincide con tutto}
\end{remark}


We are now going to justify the choice of the name for the relation $\updownarrow$, showing that two switchable direct derivations $\dder{D}$ and $\dder{D'}$ can be actually switched. 

Let $(i_1, i_2)$ be a good independence pair and consider the following diagram: the solid part exists by the definition of a filler, while the two new dotted arrows $v\colon Q\to J$ and $v'\colon Q'\to J$ are obtained  as the pushout of $q\colon P\to Q$, which is in $\mathcal{M}$ by \Cref{rem:deco}, along $q'\colon P\to Q'$.
	\[\xymatrix{&&R \ar@/_1cm/[ddrr]_(.35){i_1}|(.7)\hole \ar[dr]^{h}&& L'\ar@/^1cm/[ddll]^(.35){i_2}  \ar[dl]_{n'}\\&K\ar[dr]^{k}\ar[dl]_{l} \ar@/_.8cm/[ddrr]^(.65){u}\ar[ur]^{r}&& H && K' \ar@/^.8cm/[ddll]_(.65){u'}\ar[dl]_{k'}\ar[lu]_{l'} \ar[dr]^{r'}\\L \ar[dr]_{n} \ar@/_.8cm/[ddrr]_{j}&& D \ar[dl]|(.42)\hole_(.64){f}\ar[ur]|(.48)\hole^(.7){g}&&D' \ar[dr]|(.42)\hole^(.65){g'} \ar[ul]|(.48)\hole_(.7){f'}&&R'\ar@/^.8cm/[ddll]^{j'}\ar[dl]^{h'}\\&G &&P\ar[dr]^{q'} \ar[dl]_{q}\ar[ur]^(.4){p'}\ar[ul]_(.4){p}&&T\\&&Q \ar[ul]_{s}\ar@{.>}[dr]_{v} &&Q'\ar[ur]^{t} \ar@{.>}[dl]^{v'}\\&&&J}\]
	
	Since, by \Cref{rem:deco}, all the curved rectangles are pushouts, as well as the bottom square, we can state the following definition.
\begin{definition}\label{def:switch}
	Let $(\X,R)$ be a left-linear DPO-rewriting system and suppose that $\X$ is $\mathcal{M}$-adhesive. Given a good independence pair $(i_1, i_2)$ between $\dder{D}\colon G\Mapsto H$ and $\dder{D}'\colon H\Mapsto T$, if $(u,u')$ is the associate filler, we define other two direct derivations $S_{i_1,i_2}(\dder{D}')\colon G\Mapsto J$ and $S_{i_1,i_2}(\dder{D})\colon J\Mapsto T$ as follows:
		\[\xymatrix{L' \ar[d]_{f\circ i_2}& \ar[l]_{l'}K'\ar[d]_{q\circ u'} \ar[r]^{r'} & R' \ar[d]_{v'\circ j'} & L \ar[d]_{v\circ j} & \ar[l]_{l}K \ar[d]^{q'\circ u}\ar[r]^{r}& R \ar[d]^{g'\circ i_1}\\
		G &\ar[l]^{s} Q \ar[r]_{v}& J&J & \ar[l]^{v'}Q' \ar[r]_{t} & T}\]
	The \emph{switching} $\sder{D}{D'}$ of $\dder{D}$ and $\dder{D'}$ is the derivation $S_{i_1,i_2}(\dder{D}')\cdot S_{i_1,i_2}(\dder{D})$.
\end{definition}

\begin{remark}\label{rem:indip}Notice that $(j', j)$ is an independence pair for $S_{i_1,i_2}(\dder{D}')$ and $S_{i_1,i_2}(\dder{D})$. This is witnessed by the following diagram, commutative by construction.
	\[\xymatrix@C=15pt{L' \ar[d]_{f\circ i_2}&& K' \ar[d]_{q\circ u'}\ar[ll]_{l'} \ar[r]^{r'} & R' \ar@/^.35cm/[drrr]_(.4){j'}|(.285)\hole \ar[dr]|(.28)\hole_{v'\circ j'} && L \ar@/_.35cm/[dlll]^(.4){j} \ar[dl]|(.28)\hole^{v\circ j}& K \ar[d]^{q'\circ u}\ar[l]_{l} \ar[rr]^{r} && R \ar[d]^{g'\circ i_1}\\G && \ar[ll]^{s} Q \ar[rr]_{v}&& J  && \ar[ll]^{v'} Q' \ar[rr]_{t}&& T}\]
\end{remark} 
 
\begin{theorem}[Local Church-Rosser Theorem]\label{prop:fil}Let $(\X, \R)$ be a left-linear DPO-rewriting system with $\X$ an $\mathcal{M}$-adhesive category. Then every filler between two direct derivations $\dder{D}\colon G\Mapsto H$ and $\dder{D}'\colon H\Mapsto T$ is a filler also for $S_{u,u'}(\dder{D'})\colon G\Mapsto J$ and $S_{u,u'}(\dder{D})\colon J\Mapsto H$. In particular, if $\dder{D}\updownarrow \dder{D}'$, then $S_{u,u'}(\dder{D}')\updownarrow S_{u,u'}(\dder{D})$.
\end{theorem}
\begin{proof}By definition of filler, we have two pushout square
		\[\xymatrix{K \ar[r]^{l} \ar[d]_{u}& L \ar[d]^{j} & K' \ar[r]^{r'} \ar[d]_{u'} & R' \ar[d]^{j'}\\ P \ar[r]_q & Q & P \ar[r]_{q'} & Q'}\]
		In particular, $q$ is an arrow of $\mathcal{M}$, therefore, by \Cref{prop:pbpoad}, the square below is a pullback.
		\[\xymatrix{P \ar[r]^{q} \ar[d]_{q'}& Q\ar[d]^{v}\\ Q' \ar[r]_{v'} & J}\]
		To prove our claim, it is now enough to show that $(u',u)$ is a filler between $S_{u,u'}(\dder{D}')$ and $S_{u, u'}(\dder{D})$.
		\begin{enumerate}
			\item As for the first  point of \Cref{def:filler}, the only non obvious part is the existence of a pushout of $u$ along $r$. But, since $(u,u')$ is a filler between $\dder{D}$ and $\dder{D'}$, we know that such a pushout exists: it is enough to take the square
			\[\xymatrix{K \ar[r]^{r} \ar[d]_{u}& R \ar[d]^{i_1} \\P \ar[r]_{p'}& D'}\]
			\item For the second point, notice that the arrows $j$ and $j'$ fit in the squares
	\[\xymatrix{K' \ar[r]^{r'} \ar[d]_{u'}& R' \ar[d]^{j'} &K \ar[r]^{l} \ar[d]_{u}& L\ar[d]^{j} \\P \ar[r]_{q}& Q& P \ar[r]_{q'} & Q'}\] 
		\end{enumerate}
		
By \Cref{rem:indip} we know that $(j,j')$ is an independence pair. The results above now implies that $(j,j')$ is good.
\end{proof}

The previous remark allow us to further switch the direct derivation $S_{i_1,i_2}(\dder{D})$ and $S_{i_2,i_2}(\dder{D}')$. The following lemma guarantees us that, in this way, we get back a derivation which is abstraction equivalent to $\dder{D}\cdot \dder{D}'$.

\todo{introdurre decorazione}

\begin{lemma}\label{lem:rev}
	Let $\dder{D}\colon G\Mapsto H$ and $\dder{D}'\colon H\Mapsto T$ be two direct derivations in a left-linear DPO-rewriting system $(\X, \R)$ and let $(i_1,i_2)$ be a good independence pair between them. Then $S_{j',j}(S_{i_1,i_2}(\dder{D}, \dder{D'}))$ is abstraction equivalent to $\dder{D}\cdot \dder{D}'$. 
\end{lemma}
\begin{proof}Let $(u,u')$ be the filler associated to $(i_1, i_2)$. By \Cref{prop:fil}, $(u', u)$ is a filler between $S_{i_1,i_2}(\dder{D}')$ and $S_{i_1,i_2}(\dder{D})$. Thus we have a diagram as the one below.
		\[\xymatrix{&&R' \ar@/_1cm/[ddrr]_(.35){j'}|(.7)\hole \ar[dr]^{v'\circ j'}&& L \ar@/^1cm/[ddll]^(.35){j}  \ar[dl]_{v\circ j}\\&K'\ar[dr]^{q\circ u'}\ar[dl]_{l'} \ar@/_.8cm/[ddrr]^(.65){u'}\ar[ur]^{r'}&& J && K \ar@/^.8cm/[ddll]_(.65){u}\ar[dl]_{q'\circ u}\ar[lu]_{l} \ar[dr]^{r}\\L' \ar[dr]^{f\circ i_2} \ar@/_.8cm/[ddrr]_{c_2}&& Q \ar[dl]|(.42)\hole_(.64){s}\ar[ur]|(.48)\hole^(.7){v}&&Q' \ar[dr]|(.42)\hole_(.65){t} \ar[ul]|(.48)\hole_(.7){v'}&&R\ar@/^.8cm/[ddll]^{c_1}\ar[dl]_{g'\circ i_1}\\&G &&P\ar[dr]^{e} \ar[dl]_{e'}\ar[ur]^(.4){q'}\ar[ul]_(.4){q}&&T\\&&E' \ar[ul]_{a}\ar[dr]_{w'} &&E\ar[ur]^{b} \ar[dl]^{w}\\&&&F}\]
	
	Now, to ease the notation, let $S_{j',j}(S_{i_1,i_2}(\dder{D}, \dder{D'}))$ be $\dder{E}_0\cdot \dder{E}_1$, then $\dder{E}_0$ and $\dder{E}_1$ are the direct derivations given by the diagrams
	\[\xymatrix{L \ar[d]_{s\circ j}& K\ar[l]_{l} \ar[r]^{r} \ar[d]_{e'\circ u} & R \ar[d]_{w\circ c_1} & L' \ar[d]^{w'\circ c_2}& K' \ar[d]^{e\circ u'} \ar[r]^{r'} \ar[l]_{l'}& R' \ar[d]^{t\circ j'}\\G & E' \ar[l]^{a}  \ar[r]_{w'}& F & F & E \ar[l]^{w} \ar[r]_{b} & R}\]
	
	Notice, moreover, that, since the squares
	\[\xymatrix{K' \ar[d]_{u'} \ar[r]^{l'}& L' \ar[d]^{c_2} & K \ar[r]^{r}\ar[d]_{u} & R \ar[d]^{c_1}\\ P \ar[r]_{e'} & E' & P\ar[r]_e & E}\]
	are pushouts, we have isomorphisms  $\phi'\colon D\to E'$, $\phi\colon D'\to E$ making the following diagrams commutative.
	\[\xymatrix{K' \ar[d]_{u'} \ar[r]^{l'}& L'\ar[d]^{i_2}  \ar@/^.2cm/[dr]^{c_2} & &K \ar[r]^{r}\ar[d]_{u} & R \ar[d]^{i_1} \ar@/^.2cm/[dr]^{c_1}\\ P \ar@/_.4cm/[rr]_{e'}\ar[r]^{p} & D\ar@{.>}[r]^{\phi'} &E'& P\ar@/_.4cm/[rr]_{e}\ar[r]^{p'} & D'\ar@{.>}[r]^{\phi}& E}\]
	In particular, we have
	\[\begin{split}
		a\circ \phi' \circ i_2&=a \circ c_2\\&=f\circ i_2\\&
	\end{split}\quad \begin{split}
	a\circ \phi' \circ p'&=a \circ e'\\&=s\circ q\\&=f\circ p
	\end{split}\quad \begin{split}
	b\circ \phi \circ i_1&=b \circ c_1\\&=g'\circ i_1\\&
	\end{split}\quad \begin{split}
	b\circ \phi \circ p&=b \circ e\\&=t\circ q'\\&=g'\circ p'
	\end{split} \]
	and this shows that 
	\[a\circ \phi'=f \qquad b\circ \phi = g'\]
	Now, since $\phi'$ is an isomorphism and by \Cref{prop:pbpoad}, the two halves of the rectangle
	\[\xymatrix{K\ar[r]^{\id{K}} \ar[d]_{(\phi')^{-1} \circ e' \circ u}&K\ar[d]_{e'\circ u} \ar[r]^{l} & L \ar[d]^{s\circ j} \\D\ar[r]_{\phi'} & E' \ar[r]_{a}&G}\]
	are pullbacks. Thus the whole diagram is a pullback. But, by construction $s\circ j =n$ and we have already proved that $a\circ \phi'=f$. We then conclude that ther exists an isomorphism $\zeta\colon K\to K$ which makes the diagram below commutative
	\[\xymatrix{K \ar@{.>}[r]_{\zeta}\ar@/^.4cm/[rr]^{l}  \ar@/_.5cm/[dr]_{(\phi')^{-1} \circ e' \circ u}& K \ar[r]_{l} \ar[d]_{n} & L \ar[d]^{n} \\ & D \ar[r]_{f} & G}\]
	The commutativity of the upper triangle entails $l\circ \zeta=l$. Since $l$ is an element of $\mathcal{M}$  we can deduce that. $\zeta=\id{K}$. From this, we conclude that
	\[e'\circ u = \phi' \circ k\]
	
	As a next step, notice the existence of $\phi$ and $\phi'$, together with \Cref{rem:deco}, entails  the existence of a third isomorphism $\psi\colon H\to F$ fitting in the diagram below.
	\[\xymatrix{P  \ar[d]^{p'}\ar@/_.4cm/[dd]_{e}\ar@/^.4cm/[rr]^{e'} \ar[r]_{p} & D \ar[d]^{g} \ar[r]_{\phi'} & E'\ar[d]^{w'}\\D' \ar[d]^{\phi} \ar[r]_{f'} & H\ar@{.>}[r]^{\psi} & F \\E \ar@/_.4cm/[urr]_{w}}\]
Now, if we compute, we get
\begin{align*}
	\psi^{-1}\circ w\circ c_1&=f'\circ \phi^{-1}\circ c_1\\&=f'\circ i_1\\&=h
\end{align*}
	Summing up, we have just build the diagram below.	
	\[\xymatrix@C=40pt@R=10pt{ &&&R\ar[dddr]^{w\circ c_1} \ar[dddl]_{h}|(.67)\hole\\&&K \ar[dl]_{l} \ar[ur]^{r}\ar[dddr]^{e'\circ u} \ar[dddl]_{k}|(.67)\hole\\&L\ar[dddr]^(.4){s\circ j} \ar[dddl]_(.4){n}\\&&H \ar[rr]^{\psi} && F\\ & D \ar[ur]_(.7){g} \ar[rr]^{\phi'} \ar[dl]_{f}&& E' \ar[ur]_{w'}\ar[dl]^{a}\\ G \ar[rr]_{\id{G}} && G}\]

Next, we already know that
\[t\circ j'= h' \quad w\circ \phi = \psi \circ f' \quad b\circ \phi = g'\]
If we compute further, we also get
\[\begin{split}
	\psi^{-1}\circ w'\circ c_2 &= g\circ (\phi')^{-1}\circ c_2\\&=g\circ i_2\\&=n'
\end{split}\qquad \begin{split}
\phi^{-1}\circ e \circ u'&=p'\circ u'\\&= k'\\&
\end{split}\]
These equations allow us to conclude that the following diagram commutes.
	\[\xymatrix@C=40pt@R=10pt{ &&&R'\ar[dddr]^{t\circ j'} \ar[dddl]_{h'}|(.67)\hole\\&&K' \ar[dl]_{l'} \ar[ur]^{r}\ar[dddr]^{e\circ u'} \ar[dddl]_{k}|(.67)\hole\\&L'\ar[dddr]^(.4){w'\circ c_2} \ar[dddl]_(.4){n'}\\&&T \ar[rr]^{\id{T}} && T\\ & D' \ar[ur]_(.7){g'} \ar[rr]^{\phi} \ar[dl]_{f'}&& E \ar[ur]_{b}\ar[dl]^{w}\\ H \ar[rr]_{\psi} && F}\]

Putting together the two diagrams above we get the thesis. \qedhere 
\end{proof}


Our next step is to relate derivations which are equal ``up to switching''.

\begin{definition}
  \label{de:switchable}
  Let $(\X, \R)$ be a left-linear DPO-rewriting system. Given two
  direct derivations $\dder{D}\colon G\Mapsto H$ and
  $\dder{D}'\colon H\Mapsto T$, we say that $\dder{D}$ and $\dder{D}'$
  are \emph{properly switchable} if $\dder{D}\updownarrow_! \dder{D'}$
  and $S_{i_1,i_2}(\dder{D}')\updownarrow_!S_{i_1,i_2}(\dder{D})$,
  where $(i_2,i_2)$ is a good independence pair betwwen $\dder{D}$ and
  $\dder{D}'$. In such a case, we will write
  $\dder{D}\Updownarrow\dder{D}'$.
	
Take two derivations $\der{D}=\{\dder{D}_{i}\}_{i=0}^n$ and $\der{D}'=\{\dder{D}'_{i}\}_{i=0}^n$ with the same length and between the same $G_0$ and $G_n$. We say that $\der{D}'$ is \emph{obtained by a proper switch from $\der{D}$} if there exists an index $j < n$ such that
	\begin{enumerate}
\item for every $i\notin \{j, j+1\} $, $\dder{D}_i=\dder{D}'_i$;
\item $\dder{D}_j \Updownarrow \dder{D}_{j+1}$;		
\item $\dder{D}'_j\cdot \dder{D}'_{j+1} = S_{i_1,i_2}(\dder{D}, \dder{D}')$.
	\end{enumerate}
	In such a case, we will write $\der{D}\rightsquigarrow_j \der{D}'$ to denote that $\der{D}'$ is obtained by a proper switch between $\dder{D}_j$ and $\dder{D}_{j+1}$. 
	
	We will say that $\der{D}$ is \emph{switch equivalent} to $\der{D}'$, if there exists a sequence, $\{\der{D}_i\}_{i=0}^n$ of derivations such that
	\begin{enumerate}
		\item $\der{D}_0=\der{D}$ and $\der{D}_n=\der{D}'$;
		\item for every $i< n$, $\der{D}_{i+1}$ is obtained by a proper switch from $\der{D}_i$.
	\end{enumerate}
	
	We will write $\der{D} \equiv^s \der{D}'$ to denote that $\der{D}$ is switch equivalent to $\der{D}'$.
\end{definition}


\begin{example}
	\todo{il punto due sopra  necessario}
\end{example}

We can now prove some properties of switch equivalence.
\begin{lemma}\todo{Def. 3 della bozza di Andrea }Let $(\X, \R)$ be a left-linear DPO-rewriting system. Then the following hold true: 
	\begin{enumerate}
		\item 
		\item 
		\item 
		\item 
	\end{enumerate}
\end{lemma}
\begin{proof}\begin{enumerate}
		\item 
		\item 
		\item 
		\item \qedhere 
	\end{enumerate}
\end{proof}


\begin{example}\todo{esempio sul perch weakly independence non  invertibile}
\end{example}



\begin{lemma}\label{lem:consperm} Let $(\X, \R)$ be a left-linear DPO-rewriting system $(\X, \R)$. Then the following hold true
	\begin{enumerate}
		\item If $\dder{D}$ and $\dder{D'}$ are two direct derivations such that $\dder{D}\updownarrow \dder{D'}$, then for every filler $(u,u')$ between them, the function
		\[\tau\colon 2\to2 \qquad x \mapsto \begin{cases}
			1 & x=0\\
			0 & x=1
		\end{cases}\]
		defines a consistent permutation between $\dder{D}\cdot \dder{D}'$ and $\sder{D}{D'}$;
		\item if $\der{D}$ and $\der{D}'$ are two switch equivalent derivation, then there exists a consistent permutation between them.
	\end{enumerate}
\end{lemma}
\begin{proof}
	\begin{enumerate}
		\item 
		\item \qedhere 
	\end{enumerate}
\end{proof}
 This, together with ???
\begin{corollary}
	\todo{unicit}
\end{corollary}

\begin{example}\label{ex:contro}\todo{permutazione consistente non implica scambiabilit}
\end{example}



\subsubsection{Graphical rewriting systems}\label{subsubsec:graphical}


\todo{ci sono un sacco di sistemi very tame}
\subsection{Switch equivalence}
\todo{intro}

\subsubsection{The $3$-steps lemmas} 

As a beginning step in our analysis of switch equivalence, we will establish three lemmas  dealing with derivations of length $3$. 


\begin{lemma}[First $3$-steps Lemma]\label{lem:primo}
Let $(\X,\R)$ be a left-linear DPO-rewriting system. Consider a derivation $\der{D}=\{\dder{D}_i\}_{i=0}^2$ and suppose that $(i_0,i_1)$ is a good independence pair between $\dder{D}_0$ and $\dder{D}_1$, $(a_0,a_1)$ one between $\dder{D}_1$ and $\dder{D}_2$ and $(e_0, e_1)$ one between $\dder{D}_0$ and $S_{a_0,a_1}(\dder{D}_2)$.
\end{lemma}
\begin{proof}
	contenuto...
\end{proof}


\begin{lemma}[Second $3$-steps Lemma]\label{lem:secondo}
	contenuto...
\end{lemma}
\begin{proof}
	contenuto...
\end{proof}



\begin{lemma}[Third $3$-steps Lemma]\label{lem:terzo}
	contenuto...
\end{lemma}
\begin{proof}
	contenuto...
\end{proof}


\todo{dividere in due il lemma dopo. devono venire tre lemmi}
\begin{lemma}[Three steps Lemma]\label{lem:iig1}Let $(\X,\R)$ be a left-linear DPO-rewriting system with $\X$ an $\mathcal{M}$-adhesive category. Consider a derivation $\der{D}=\{\dder{D}_i\}_{i=0}^2$ and suppose that $(i_0,i_1)$ is a good independence pair between $\dder{D}_0$ and $\dder{D}_1$, $(a_0,a_1)$ one between $\dder{D}_1$ and $\dder{D}_2$ and $(e_0, e_1)$ one between $\dder{D}_0$ and $S_{a_0,a_1}(\dder{D}_2)$. Then the following properties hold true.
	\begin{enumerate}
		\item $S_{e_0,e_1}(\dder{D}_0)$ and $S_{a_0,a_1}(\dder{D}_1)$ are weakly sequentially independent.
		\item If $S_{i_0, i_1}(\dder{D}_0)\updownarrow_! \dder{D}_2$ with a good independence pair $(\alpha_0, \alpha_1)$, then  $S_{i_0,i_1}(\dder{D}_1)$ and $S_{\alpha_0, \alpha_1}(\dder{D}_2)$ are weakly sequentially independent.
	\end{enumerate}
	
\end{lemma}
\begin{proof}  As a preliminary step, we are going to use \Cref{def:filler,def:switch} to get some diagrams.  First of all, let $(v,v')$ be the filler between $\dder{D}_0$ and $\dder{D}_1$ associated to $(i_0, i_1)$, then we have
	\[\xymatrix{&&R_0 \ar@/_1cm/[ddrr]_(.35){i_0}|(.7)\hole \ar[dr]^{h_0}&& L_1\ar@/^1cm/[ddll]^(.35){i_1}  \ar[dl]_{m_1}\\&K_0\ar[dr]^{k_0}\ar[dl]_{l_0} \ar@/_.8cm/[ddrr]|(.36)\hole^(.65){v}\ar[ur]^{r_0}&& G_1 && K_1 \ar@/^.8cm/[ddll]|(.36)\hole_(.65){v'}\ar[dl]_{k_1}\ar[lu]_{l_1} \ar[dr]^{r_1}\\L_0 \ar@/_.8cm/[ddrr]_(.2){j_0}|(.31)\hole|(.81)\hole \ar[dr]^(.4){m_0}|(.61)\hole && D_0 \ar[dl]|(.4)\hole_(.65){f_0}\ar[ur]|(.5)\hole^(.7){g_0}&&D_1 \ar[dr]|(.4)\hole^(.65){g_1} \ar[ul]|(.5)\hole_(.65){f_1}&&R_1\ar@/^.8cm/[ddll]^(.2){j_1}|(.31)\hole|(.81)\hole\ar[dl]_{h_1}|(.6)\hole\\&G_0 &&P_1\ar[dr]_{q_1} \ar[dl]^{q_0}\ar[ur]^(.4){p_1}\ar[ul]_(.4){p_0}&&G_2\\L_1 \ar@/^.8cm/[uurr]^(.2){i_1} \ar[ur]_(.35){f_0\circ i_1}|(.61)\hole&&Q_0 \ar[ul]|(.4)\hole_(.65){s_0}\ar[dr]|(.5)\hole^(.65){t_0} &&Q_1\ar[ur]|(.4)\hole^(.65){t_1} \ar[dl]|(.5)\hole_(.65){s_1} && R_0  \ar[ul]^(.35){g_1\circ i_0}|(.61)\hole\ar@/_.8cm/[uull]_(.2){i_0}\\&K_1 \ar[ur]_{q_0\circ v'} \ar[dr]_{r_1} \ar[ul]^{l_1}\ar@/^.8cm/[uurr]_(.65){v'}&&H'_1&& K_0 \ar[ur]_{r_0} \ar[ul]^{q_1\circ v} \ar[dl]^{l_0} \ar@/_.8cm/[uull]^(.65){v}\\&& R_1 \ar[ur]_{\hspace{-5pt}s_1\circ j_1}\ar@/^1cm/[uurr]^(.25){j_1}&& L_0 \ar[ul]^{t_0\circ j_0\hspace{-5pt}} \ar@/_1cm/[uull]_(.25){j_0} |(.69)\hole }\]
	
	Secondly, the filler $(u,u')$ induced by $(a_0, a_1)$ between $\dder{D}_1$ and $\dder{D}_2$ yields:
	\[
	\xymatrix{&&R_1 \ar@/_1cm/[ddrr]_(.35){a_0}|(.7)\hole \ar[dr]^{h_1}&& L_2\ar@/^1cm/[ddll]^(.35){a_1}  \ar[dl]_{m_2}\\&K_1\ar[dr]^{k_1}\ar[dl]_{l_1} \ar@/_.8cm/[ddrr]|(.36)\hole^(.65){u}\ar[ur]^{r_1}&& G_2 && K_2 \ar@/^.8cm/[ddll]|(.36)\hole_(.65){u'}\ar[dl]_{k_2}\ar[lu]_{l_2} \ar[dr]^{r_2}\\L_1 \ar@/_.8cm/[ddrr]_(.2){b_0}|(.31)\hole|(.81)\hole \ar[dr]^(.4){m_1}|(.61)\hole && D_1 \ar[dl]|(.4)\hole_(.65){f_1}\ar[ur]|(.5)\hole^(.7){g_1}&&D_2 \ar[dr]|(.4)\hole^(.65){g_2} \ar[ul]|(.5)\hole_(.65){f_2}&&R_2\ar@/^.8cm/[ddll]^(.2){b_1}|(.31)\hole|(.81)\hole\ar[dl]_{h_2}\\&G_1 &&P_2\ar[dr]_{d_1} \ar[dl]^{d_0}\ar[ur]^(.4){c_1}\ar[ul]_(.4){c_0}&&G_3\\L_2 \ar@/^.8cm/[uurr]^(.2){a_1} \ar[ur]_(.35){f_1\circ a_1}|(.61)\hole&&Q_2 \ar[ul]|(.4)\hole_(.65){x_1}\ar[dr]|(.5)\hole^(.65){y_1} &&Q_3\ar[ur]|(.4)\hole^(.65){y_2} \ar[dl]|(.5)\hole_(.65){x_2} && R_1  \ar[ul]^(.35){g_2\circ a_0}|(.61)\hole\ar@/_.8cm/[uull]_(.2){a_0}\\&K_2 \ar[ur]_{d_0\circ u'} \ar[dr]_{r_2} \ar[ul]^{l_2}\ar@/^.8cm/[uurr]_(.65){u'}&&G'_2&& K_1 \ar[ur]_{r_1} \ar[ul]^{d_1\circ u} \ar[dl]^{l_1} \ar@/_.8cm/[uull]^(.65){u}\\&& R_2 \ar[ur]_{\hspace{-5pt}x_2\circ b_1}\ar@/^1cm/[uurr]^(.25){b_1}&& L_1 \ar[ul]^{y_1\circ b_0\hspace{-5pt}} \ar@/_1cm/[uull]_(.25){b_0} |(.69)\hole }\]


	Finally, the filler $(w,w')$  between $\dder{D}_0$ and $S_{a_0,a_1}(\dder{D}_2)$ given by $(e_0, e_1)$ provides us with:
\[\xymatrix{&&R_0 \ar@/_1cm/[ddrr]_(.35){e_0}|(.7)\hole \ar[dr]^{h_0}&& L_2\ar@/^1cm/[ddll]^(.35){e_1}  \ar[dl]_{f_1\circ a_1}\\&K_0\ar[dr]^{k_0}\ar[dl]_{l_0} \ar@/_.8cm/[ddrr]|(.36)\hole^(.65){w}\ar[ur]^{r_0}&& G_1 && K_2 \ar@/^.8cm/[ddll]|(.36)\hole_(.65){w'}\ar[dl]_{d_0\circ u'\hspace{-5pt}}\ar[lu]_{l_2} \ar[dr]^{r_2}\\L_0 \ar@/_.8cm/[ddrr]_(.2){o_0}|(.31)\hole|(.81)\hole \ar[dr]^(.4){m_0}|(.61)\hole && D_0 \ar[dl]|(.4)\hole_(.65){f_0}\ar[ur]|(.5)\hole^(.7){g_0}&&Q_2 \ar[dr]|(.4)\hole^(.65){y_1} \ar[ul]|(.5)\hole_(.65){x_1}&&R_2\ar@/^.8cm/[ddll]^(.2){o_1}|(.31)\hole|(.81)\hole\ar[dl]_(.35){x_2\circ b_1}\\&G_0 &&P_3\ar[dr]_{n_1} \ar[dl]^{n_0}\ar[ur]^(.4){u_1}\ar[ul]_(.4){u_0}&&G'_2\\L_2 \ar@/^.8cm/[uurr]^(.2){e_1} \ar[ur]_(.35){f_0\circ e_1}|(.61)\hole&&Q_4 \ar[ul]|(.4)\hole_(.65){z_0}\ar[dr]|(.5)\hole^(.65){z'_0} &&Q_5\ar[ur]|(.4)\hole^(.65){z'_1} \ar[dl]|(.5)\hole_(.65){z_1} && R_0  \ar[ul]^(.35){y_1\circ e_0}|(.61)\hole\ar@/_.8cm/[uull]_(.2){e_0}\\&K_2 \ar[ur]_{n_0\circ w'} \ar[dr]_{r_2} \ar[ul]^{l_2}\ar@/^.8cm/[uurr]_(.65){w'}&&G'_1&& K_0 \ar[ur]_{r_0} \ar[ul]^{n_1\circ w} \ar[dl]^{l_0} \ar@/_.8cm/[uull]^(.65){w}\\&& R_2 \ar[ur]_{\hspace{-4pt}z_1\circ o_1}\ar@/^1cm/[uurr]^(.25){o_1}&& L_0 \ar[ul]^{z'_0\circ o_0\hspace{-5pt}} \ar@/_1cm/[uull]_(.25){o_0} |(.69)\hole }\]	
So equipped we can turn to the prove of our claims.	
	\begin{enumerate}
		\item We have to construct the two dotted arrows in the diagram below.
			\[\xymatrix@C=15pt{L_0 \ar[d]_{z'_0\circ o_0}&& K_0 \ar[d]_{n_1\circ w}\ar[ll]_{l_0} \ar[r]^{r_0} & R_0 \ar@{.>}@/^.35cm/[drrr]_(.4){\beta_0}|(.285)\hole \ar[dr]|(.28)\hole_{y_1\circ e_0} && L_1 \ar@{.>}@/_.35cm/[dlll]^(.4){\beta_1} \ar[dl]|(.28)\hole^{y_1\circ b_0}& K_1 \ar[d]^{d_1\circ u}\ar[l]_{l_1} \ar[rr]^{r_1} && R_1 \ar[d]^{g_2\circ a_1}\\G'_1 && \ar[ll]^{z_1} Q_5 \ar[rr]_{z'_1}&& G'_2  && \ar[ll]^{x_2} Q_3 \ar[rr]_{y_2}&& G_3}\]
			
		Consider the arrows $i_0\colon R_0\to D_1$ and $e_0\colon R_0\to Q_2$. An easy computation shows that
			\begin{align*}
				f_1\circ i_0&= h_0\\&=x_1\circ e_0
			\end{align*}
			entailing the existence of  the dotted $\beta'_0\colon R_0\to P_2$ in the diagram
			\[\xymatrix{R_0 \ar@{.>}[dr]^{\beta'_0} \ar@/^.3cm/[drr]^{i_0} \ar@/_.3cm/[ddr]_{e_0}\\ &P_2 \ar[r]^{c_1} \ar[d]_{d_0}& D_1 \ar[d]^{f_1}\\ &Q_2\ar[r]_{x_1} & G_1}\]
			If we define $\beta_0\colon R_0\to Q_3$ as $d_1\circ \beta'_1$, then we easily get that 
		\begin{align*}
			x_2\circ \beta_0&=x_2\circ d_2\circ \beta'_0\\&= y_1\circ d_0\circ \beta'_0\\&=y_1\circ e_0
		\end{align*}
		
		To define $\beta_1$, we proceed similarly. First consider  $i_1\colon L_1\to D_0$ and $b_0\colon L_1 \to Q_2$ and notice that
		\begin{align*}
			g_0\circ i_1&= m_1 \\&= x_1 \circ b_0
		\end{align*}
			implying the existence of $\beta'_1\colon L_1\to P_3$ fitting in the diagram below.
			\[\xymatrix{L_1 \ar@{.>}[dr]^{\beta'_1} \ar@/^.3cm/[drr]^{i_1} \ar@/_.3cm/[ddr]_{b_0}\\ &P_3 \ar[r]^{u_0} \ar[d]_{u_1}& D_0 \ar[d]^{g_0}\\ &Q_2\ar[r]_{x_1} & G_1}\] 
			Let $\beta_1\colon L_1\to Q_5$ be $n_1\circ \beta'_1$, then
			\begin{align*}
				z'_1 \circ \beta_1 & = z'_1 \circ n_1\circ \beta'_1\\&=y_1\circ u_1\circ \beta'_1\\&=y_1\circ b_0
			\end{align*}
		Therefore, $(\beta_0, \beta_1)$ is the wanted independence pair.
			
\item  In addition to the three diagram above, we have a fourth one given by the filler $(\varphi_0, \varphi_1)$ associated to $(\alpha_0, \alpha_1)$. 
\[\xymatrix{&&R_0 \ar@/_1cm/[ddrr]_(.35){\alpha_0}|(.7)\hole \ar[dr]^{g_1\circ i_0}&& L_2\ar@/^1cm/[ddll]^(.35){\alpha_1}  \ar[dl]_{m_2}\\
&K_0\ar[dr]^{\hspace{-4pt}q_1\circ v}\ar[dl]_{l_0} \ar@/_.8cm/[ddrr]|(.36)\hole^(.65){\varphi}\ar[ur]^{r_0}&& G_2 && K_2 \ar@/^.8cm/[ddll]|(.36)\hole_(.65){\varphi'}\ar[dl]_{k_2}\ar[lu]_{l_2} \ar[dr]^{r_2}\\
L_0 \ar@/_.8cm/[ddrr]_(.2){\gamma_0}|(.31)\hole|(.81)\hole \ar[dr]^(.4){\hspace{-4pt}t_0\circ j_0}|(.61)\hole && Q_1 \ar[dl]|(.4)\hole_(.65){s_1}\ar[ur]|(.5)\hole^(.7){t_1}&&D_2 \ar[dr]|(.4)\hole^(.65){g_2} \ar[ul]|(.5)\hole_(.65){f_2}&&R_2\ar@/^.8cm/[ddll]^(.2){\gamma_1}|(.31)\hole|(.81)\hole\ar[dl]_(.35){h_2}\\&H'_1 &&P_4\ar[dr]_{\lambda_1} \ar[dl]^{\lambda_0}\ar[ur]^(.4){\zeta_1}\ar[ul]_(.4){\zeta_0}&&G_3\\
L_2 \ar@/^.8cm/[uurr]^(.2){\alpha_1} \ar[ur]_(.35){s_1\circ \alpha_1}|(.61)\hole&&Q_6 \ar[ul]|(.4)\hole_(.65){\xi_0}\ar[dr]|(.5)\hole^(.65){\xi'_0} &&Q_7\ar[ur]|(.4)\hole^(.65){\xi'_1} \ar[dl]|(.5)\hole_(.65){\xi_1} && R_0  \ar[ul]^(.35){g_2\circ \alpha_0}|(.61)\hole\ar@/_.8cm/[uull]_(.2){\alpha_0}\\&K_2 \ar[ur]_{\lambda_0\circ \phi'} \ar[dr]_{r_2} \ar[ul]^{l_2}\ar@/^.8cm/[uurr]_(.65){\phi'}&&H'_2&& K_0 \ar[ur]_{r_0} \ar[ul]^{\lambda_1\circ \phi} \ar[dl]^{l_0} \ar@/_.8cm/[uull]^(.65){\phi}\\&& R_2 \ar[ur]_{\hspace{-4pt}\xi_1\circ \gamma_1}\ar@/^1cm/[uurr]^(.25){\gamma_1}&& L_0 \ar[ul]^{\xi'_0\circ \gamma_0\hspace{-5pt}} \ar@/_1cm/[uull]_(.25){\gamma_0} |(.69)\hole }\]	

Our aim is to construct the dotted arrow in the following diagram.
		\[\xymatrix@C=15pt{L_1 \ar[d]_{f_0\circ i_0}&& K_1 \ar[d]_{q_0\circ v'}\ar[ll]_{l_1} \ar[r]^{r_1} & R_1 \ar@{.>}@/^.35cm/[drrr]_(.4){\epsilon_0}|(.285)\hole \ar[dr]|(.28)\hole_{s_1\circ j_1} && L_2 \ar@{.>}@/_.35cm/[dlll]^(.4){\epsilon_1} \ar[dl]|(.28)\hole^{s_1\circ \alpha_1}& K_2 \ar[d]^{\lambda_0\circ \phi'}\ar[l]_{l_2} \ar[rr]^{r_2} && R_2 \ar[d]^{\xi_1\circ \gamma_1}\\G_0 && \ar[ll]^{s_0} Q_0 \ar[rr]_{t_0}&& H'_1  && \ar[ll]^{\xi_0} Q_6 \ar[rr]_{\xi'_0}&& H'_2}\]

Let us start considering $j_1\colon R_1\to Q_1$ and $a_0\colon R_1\to D_2$. We have
\begin{align*}
	f_2\circ a_0&=h_1\\&=t_1\circ j_1
\end{align*}
and thus we get an arrow $\epsilon'_0\colon R_1\to P_4$ which makes the diagram below commutative.
			\[\xymatrix{R_1 \ar@{.>}[dr]^{\epsilon'_0} \ar@/^.3cm/[drr]^{j_1} \ar@/_.3cm/[ddr]_{a_0}\\ &P_4 \ar[r]^{\zeta_0} \ar[d]_{\zeta_1}& Q_1 \ar[d]^{t_1}\\ &D_2\ar[r]_{f_2} & G_2}\] 
We can then define $\epsilon_0\colon R_1\to Q_6$ to be $\lambda_0\circ \epsilon'_0$. For such an arrow we have a chain of identities:
\begin{align*}
	\xi_0\circ \epsilon_0&=\xi_0\circ \lambda_0\circ \epsilon'_0\\&=s_1\circ \zeta_0 \circ \epsilon'_0\\&=s_1\circ j_1
\end{align*}

Next, to define $\epsilon_1\colon L_2\to Q_0$ we take $e_1\colon L_2 \to D_0$ and $a_1\colon L_2\to D_1$. By definition we have $	g_0\circ e_1=f_1\circ a_1$, giving us the dotted arrow below
	\[\xymatrix{L_2 \ar@{.>}[dr]^{\epsilon'_1} \ar@/^.3cm/[drr]^{a_1} \ar@/_.3cm/[ddr]_{e_0}\\ &P_1 \ar[r]^{p_1} \ar[d]_{p_0}& D_1 \ar[d]^{f_1}\\ &D_0\ar[r]_{g_0} & G_1}\] 
Now, notice that 
\begin{align*}
	t_1\circ q_1\circ \epsilon'_1&=g_1\circ p_1\circ \epsilon'_1&=g_1\circ a_1\\&=m_2
\end{align*}
Hence $(\alpha_0, q_1\circ \epsilon'_1)$ is an independence pair for $S_{i_0, i_1}(\dder{D}_0)$ and $\dder{D}_2$. By hypothesis $S_{i_0, i_1}(\dder{D}_0)\updownarrow_! \dder{D}_2$ and thus $q_1\circ \epsilon'_1$ must coincide with $\alpha_1$. Now, let $\epsilon_1\colon L_2\to Q_0$ be $q_0\circ \epsilon'_1$. Computing we get
\begin{align*}
t_0\circ \epsilon_1&= t_0\circ q_0\circ \epsilon'_1\\&=s_1\circ q_1\circ \epsilon'_1\\&=s_1\circ \alpha_1
\end{align*}
Allowing us to conclude that  $S_{i_0,i_1}(\dder{D}_1)\updownarrow S_{\alpha_0, \alpha_1}(\dder{D}_2)$.
\qedhere 
			\end{enumerate}
\end{proof}

\subsubsection{Inversions and switch equivalence}
\todo{richiamare cosa sono le inversioni}

\begin{lemma}[Fundamental Lemma] Let $(\der{D}, \alpha, \omega)$ and $(\der{D'}, \alpha, \omega)$ be two decorated derivations and suppose that there exists a non-empty sequence $\{\der{D}_i\}_{i=0}^n$ a of derivations witnessing $\der{D}\equiv^s \der{D}'$. For every $i\in [0,n-1]$, let $\nu_i\colon [0, \lgh(\der{D})-1]\to [0, \lgh(\der{D})-1]$ be the $2$-cycle associated to the switch between $\der{D}_i$ and $\der{D}_{i+1}$, let also $\sigma$ be the associated consistent permutation between $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$. Define $k$ as the maximum of the set
\[M_\sigma:=\{j\in [0, \lgh(\der{D}-1] \mid \sigma(j+1) < \sigma(j) \}\]
If every $\nu_i$ is an inversion for $\sigma$, then there exists a family $\{\nu'_i\}_{i=0}^n$ of inversions for $\sigma$ such that jj\todo{capire come scriverlo meglio, l} $\nu'_0=(k, k+1)$.
\end{lemma}
\begin{remark}
	Since $\{\der{D}_i\}_{i=0}^n$ is non-empty, then $\sigma$ must be different from $\id{[0, \lgh(\der{D}-1)]}$ and $M_{\sigma}\neq \emptyset$.
\end{remark}
\begin{proof}
	We proceed by induction on $n$.
	
	\smallskip\noindent $n=1$. In this case there is nothing to prove.
	
	\smallskip \noindent $n>1$. Then...
\end{proof}

\begin{corollary}
	contenuto...
\end{corollary}
\begin{proof}
	contenuto...
\end{proof}


\begin{corollary}
	contenuto...
\end{corollary}
\begin{proof}
	contenuto...
\end{proof}



\begin{corollary}
	contenuto...
\end{corollary}
\begin{proof}
	contenuto...
\end{proof}


\begin{corollary}[No need for useless shifts]
	contenuto...
\end{corollary}
\begin{proof}
	contenuto...
\end{proof}
\newpage


NOTES ON THE FUNDAMENTAL LEMMA WE NEED\todo{da integrare sopra}

Everything is very tame, so that sequential independence coincides with switchability and we do not have ambiguity in the choice of an independence pair


We start with the following situation.
	\[\xymatrix@C=15pt{L_0\ar[d]_{m_0}&& K_0 \ar[d]_{k_0}\ar[ll]_{l_0} \ar[r]^{r_0} & R_0 \ar@/^.35cm/[drrr]_(.4){i_0}|(.285)\hole \ar[dr]|(.28)\hole_{h_0} && L_1 \ar@/_.35cm/[dlll]^(.4){i_1} \ar[dl]|(.28)\hole^{m_1}& K_1 \ar[d]^{k_1}\ar[l]_{l_1} \ar[r]^{r_1} & R_1 \ar[dr]|(.28)\hole_{h_1} \ar@/^.35cm/[drrr]_(.4){j_0}|(.285)\hole  && L_2 \ar@/_.35cm/[dlll]^(.4){j_1} \ar[dl]|(.28)\hole^{m_2}& K_2 \ar[d]^{k_2}\ar[l]_{l_2} \ar[rr]^{r_2} && R_2 \ar[d]^{h_2} \\G_0 && \ar[ll]^{f_0} D_0 \ar[rr]_{g_0}&& G_1  && \ar[ll]^{f_1} D_1 \ar[rr]_{g_1}&& G_2 && \ar[ll]^{f_2} D_2 \ar[rr]_{g_2}&& G_3 }\]
	
	We can do two things:
	
	FIRST SEQUENCE OF SWITCHINGS:
	
	Switch the first two
	

	\[\xymatrix@C=15pt{L_1\ar[d]_{f_0\circ i_1}&& K_1 \ar[d]_{k'_1}\ar[ll]_{l_1} \ar[r]^{r_1} & R_1 \ar@/^.35cm/[drrr]_(.4){a_0}|(.285)\hole \ar[dr]|(.28)\hole_{h'_1} && L_0 \ar@/_.35cm/[dlll]^(.4){a_1} \ar[dl]|(.28)\hole^{m'_0}& K_0 \ar[d]^{k'_0}\ar[l]_{l_0} \ar[r]^{r_0} & R_0 \ar[dr]|(.28)\hole_{g_1\circ j_0} \ar@/^.35cm/[drrr]_(.4){b_0}|(.285)\hole  && L_2 \ar@/_.35cm/[dlll]^(.4){b_1} \ar[dl]|(.28)\hole^{m_2}& K_2 \ar[d]^{k_2}\ar[l]_{l_2} \ar[rr]^{r_2} && R_2 \ar[d]^{h_2} \\G_0 && \ar[ll]^{f'_0} D'_0 \ar[rr]_{g'_0}&& G'_1  && \ar[ll]^{f'_1} D'_1 \ar[rr]_{g'_1}&& G_2 && \ar[ll]^{f_2} D_2 \ar[rr]_{g_2}&& G_3 }\]
	
	Moreover, we know that
	\[m_0=f'_0\circ a_1 \qquad h_1=g'_1\circ a_0\]
	
	Switch second and third 
	\[\xymatrix@C=15pt{L_1\ar[d]_{f_0\circ i_1}&& K_1 \ar[d]_{k'_1}\ar[ll]_{l_1} \ar[r]^{r_1} & R_1 \ar@/^.35cm/[drrr]_(.4){c_0}|(.285)\hole \ar[dr]|(.28)\hole_{h'_1} && L_2 \ar@/_.35cm/[dlll]^(.4){c_1} \ar[dl]|(.28)\hole^{f'_1\circ b_1}& K_2 \ar[d]^{k'_2}\ar[l]_{l_2} \ar[r]^{r_2} & R_2 \ar[dr]|(.28)\hole_{h'_2} \ar@/^.35cm/[drrr]_(.4){d_0}|(.285)\hole  && L_0 \ar@/_.35cm/[dlll]^(.4){d_1} \ar[dl]|(.28)\hole^{\hat{m}_0}& K_0 \ar[d]^{\hat{k}_0}\ar[l]_{l_0} \ar[rr]^{r_0} && R_0 \ar[d]^{g_2\circ b_0} \\G_0 && \ar[ll]^{f'_0} D'_0 \ar[rr]_{g'_0}&& G'_1  && \ar[ll]^{\hat{f}_1} \hat{D}_1 \ar[rr]_{\hat{g}_1}&& G'_2 && \ar[ll]^{f'_2} D'_2 \ar[rr]_{g'_2}&& G_3 }\]
	And we know that
	\[m'_0=\hat{f}_1\circ d_1 \qquad h_2=g'_2\circ d_0\]
	\todo{qua abbiamo usato il secondo lemma dei tre passi (quello condizionale)}Since the rewriting system is very tame and using the three steps lemmas we can characterize $c_0\colon R_1\to \hat{D}_1$ and $c_1\colon L_2\to D'_0$ as the unique arrows fitting in the diagrams
\[\xymatrix@R=15pt@C=15pt{&&R_1 \ar@/_1.2cm/[dddl]_(.4){a_0}|(.63)\hole\ar[dl]^{j_0}\ar[dd]^{c'_0} \ar@{.>}[dr]^{c_0}\\&D_2 \ar[dl]^(.4){f_2}&&\hat{D}_1 \ar[dr]^{\hat{g}_1}\\G_2 && P\ar[dr]_{p_4} \ar[ur]_{p_3}\ar[dl]^{p_1} \ar[ul]^{p_2}&&G'_2\\& D'_1 \ar[ul]^{g'_1}&&D'_2 \ar[ur]_{f'_2}}\]

\[\xymatrix@R=15pt@C=15pt{&&L_2 \ar[dl]^{j_1} \ar@/_1.2cm/[dddl]_(.4){z_1}|(.63)\hole\ar[dd]^{c'_1} \ar@{.>}[dr]^{c_1}\\&D_1 \ar[dl]^(.4){f_1}&&D'_0 \ar[dr]^{g'_0}\\G_1 && Q\ar[dr]_{q_4} \ar[ur]_{q_3}\ar[dl]^{q_1} \ar[ul]_{q_2}&&G'_1\\& D_0 \ar[ul]^{g_0}&&D'_1 \ar[ur]_{f'_1}}\]
	
	
	Switch first and second 
	\[\xymatrix@C=15pt{L_2\ar[d]_{f'_0\circ c_1}&& K_2 \ar[d]_{\hat{k}_2}\ar[ll]_{l_2} \ar[r]^{r_2} & R_2 \ar@/^.35cm/[drrr]_(.4){e_0}|(.285)\hole \ar[dr]|(.28)\hole_{\hat{h}_2} && L_1 \ar@/_.35cm/[dlll]^(.4){e_1} \ar[dl]|(.28)\hole^{\hat{m}_1}& K_1 \ar[d]^{\hat{k}_1}\ar[l]_{l_1} \ar[r]^{r_1} & R_1 \ar@/^.35cm/[drrr]_(.4){t_0} \ar[dr]|(.28)\hole_{\hat{g}_1\circ c_0}   && L_0  \ar[dl]|(.28)\hole^{\hat{m}_0} \ar@/_.35cm/[dlll]^(.4){t_1}& K_0 \ar[d]^{\hat{k}_0}\ar[l]_{l_0} \ar[rr]^{r_0} && R_0 \ar[d]^{g_2\circ b_0} \\G_0 && \ar[ll]^{\hat{f}_0} \hat{D}_0 \ar[rr]_{\hat{g}_0}&& \hat{G}_1  && \ar[ll]^{\tilde{f}_1} \tilde{D}_1 \ar[rr]_{\tilde{g}_1}&& G'_2 && \ar[ll]^{f'_2} D'_2 \ar[rr]_{g'_2}&& G_3 }\]
	Moreover
	\[f_0\circ i_1=\hat{f}_0\circ e_1 \qquad h'_2=\tilde{g}_1\circ e_0\]
	and $(t_0, t_1)$ is characterized using again very tameness and the first $3$-steps Lemma as the unique arrows fitting in:
	\[\xymatrix{&R_1 \ar[dl]_{a_0} \ar@{.>}[dr]^{t_0} \ar@/^.4cm/[dd]|\hole^(.6){c_0}\ar[d]_{t'_0}\\ D'_1 \ar[d]_{g'_1}&P\ar[d]_{p_3} \ar[r]^{p_4} \ar[l]_{p_1}&D'_2\ar[d]^{f'_2}\\G'_1&\hat{D}_1 \ar[l]^{\hat{f}_1}\ar[r]_{\hat{g}_1}& G'_2}\]
	
	
	
	\[\xymatrix@R=15pt@C=15pt{&&L_ 0\ar[dl]^{a_1} \ar@/_1.2cm/[dddl]_(.4){d_1}|(.63)\hole\ar[dd]^{t'_1} \ar@{.>}[dr]^{t_1}\\&D'_0 \ar[dl]^(.4){g'_0}&&\tilde{D}_1 \ar[dr]^{\tilde{f}_1}\\G'_1 && S\ar[dr]_{s_4} \ar[ur]_{s_3}\ar[dl]^{s_1} \ar[ul]_{s_2}&&\hat{G}_1\\& \hat{D}_1 \ar[ul]^{\hat{f}_1}&&\hat{D}_0 \ar[ur]_{\hat{g}_0}}\]
	

	SECOND SEQUENCE OF SWITCHINGS:

	Switch third and second
	
	
	\[\xymatrix@C=15pt{L_0\ar[d]_{m_0}&& K_0 \ar[d]_{k_0}\ar[ll]_{l_0} \ar[r]^{r_0} & R_0 \ar@/^.35cm/[drrr]_(.4){z_0}|(.285)\hole \ar[dr]|(.28)\hole_{h_0} && L_2 \ar@/_.35cm/[dlll]^(.4){z_1} \ar[dl]|(.28)\hole^{f_1\circ j_1}& K_2 \ar[d]^{\check{k}_2}\ar[l]_{l_2} \ar[r]^{r_2} & R_2 \ar[dr]|(.28)\hole_{\check{h}_2} \ar@/^.35cm/[drrr]_(.4){w_0}|(.285)\hole  && L_1 \ar@/_.35cm/[dlll]^(.4){w_1} \ar[dl]|(.28)\hole^{\check{m}_1}& K_1 \ar[d]^{\check{k}_1}\ar[l]_{l_1} \ar[rr]^{r_1} && R_1\ar[d]^{g_2\circ j_0} \\G_0 && \ar[ll]^{f_0} D_0 \ar[rr]_{g_0}&& G_1  && \ar[ll]^{\check{f}_1} \check{D}_1 \ar[rr]_{\check{g}_1}&& \check{G}_2 && \ar[ll]^{\check{f}_2} \check{D}_2 \ar[rr]_{\check{g}_2}&& G_3 }\]
	Moreover
	\[m_1=\check{f}_1\circ w_1 \qquad h_2=\check{g}_2\circ w_0\]
	
	Switch second and first
		\[\xymatrix@C=15pt{L_2\ar[d]_{f_0\circ z_1}&& K_2 \ar[d]_{\mathring{k}_2}\ar[ll]_{l_2} \ar[r]^{r_2} & R_2 \ar@/^.35cm/[drrr]_(.4){y_0}|(.285)\hole \ar[dr]|(.28)\hole_{\mathring{h}_2} && L_0 \ar@/_.35cm/[dlll]^(.4){y_1} \ar[dl]|(.28)\hole^{\check{m}_0}& K_0 \ar[d]^{\check{k}_0}\ar[l]_{l_0} \ar[r]^{r_0} & R_0 \ar[dr]|(.28)\hole_{\check{g}_1\circ z_0} \ar@/^.35cm/[drrr]_(.4){x_0}|(.285)\hole  && L_1 \ar@/_.35cm/[dlll]^(.4){x_1} \ar[dl]|(.28)\hole^{\check{m}_1}& K_1 \ar[d]^{\check{k}_1}\ar[l]_{l_1} \ar[rr]^{r_1} && R_1\ar[d]^{g_2\circ j_0} \\G_0 && \ar[ll]^{\check{f}_0} \check{D}_0 \ar[rr]_{\check{g}_0}&& \check{G}_1  && \ar[ll]^{\mathring{f}_1} \mathring{D}_1 \ar[rr]_{\mathring{g}_1}&& \check{G}_2 && \ar[ll]^{\check{f}_2} \check{D}_2 \ar[rr]_{\check{g}_2}&& G_3 }\]
	As before we have
	\[m_0=\check{f}_0\circ y_1 \qquad \check{h}_2=\mathring{g}_1\circ y_0\]
	The really important thing to notice is that, by very tameness we have
	\begin{align*}
		f_0'\circ c_1&=f'_0\circ q_3\circ c'_1\\&=f_0\circ q_1\circ c'_1\\&=f_0\circ z_1
	\end{align*}
	
	\todo{GOOD! i primi match sono uguali, ora giochiamoci il primo lemma dei tre passi}
	
	Switch second and third
\[\xymatrix@C=15pt{L_2\ar[d]_{f_0\circ z_1}&& K_2 \ar[d]_{\mathring{k}_2}\ar[ll]_{l_2} \ar[r]^{r_2} & R_2 \ar@/^.35cm/[drrr]_(.4){v_0}|(.285)\hole \ar[dr]|(.28)\hole_{\mathring{h}_2} && L_1 \ar@/_.35cm/[dlll]^(.4){v_1} \ar[dl]|(.28)\hole^{\mathring{f}_1 \circ x_1}& K_1 \ar[d]^{\mathring{k}_1}\ar[l]_{l_1} \ar[r]^{r_1} & R_1 \ar@/^.35cm/[drrr]_(.4){u_0}|(.285)\hole\ar[dr]_{\check{h}_1}   && L_0 \ar@/_.35cm/[dlll]^(.4){u_1} \ar[dl]^{\mathring{m}_0}& K_0 \ar[d]^{\mathring{k}_0}\ar[l]_{l_0} \ar[rr]^{r_0} && R_0\ar[d]^{\check{g}_2\circ x_0} \\G_0 && \ar[ll]^{\check{f}_0} \check{D}_0 \ar[rr]_{\check{g}_0}&& \check{G}_1  && \ar[ll]^{\bar{f}_1} \bar{D}_1 \ar[rr]_{\bar{g}_1}&& \bar{G}_2 && \ar[ll]^{\bar{f}_2} \bar{D}_2 \ar[rr]_{\bar{g}_2}&& G_3 }\]

\[\xymatrix@R=15pt@C=15pt{&&R_1 \ar@/_1.2cm/[dddl]_(.4){a_0}|(.63)\hole\ar[dl]^{j_0}\ar[dd]^{c'_0} \ar@{.>}[dr]^{c_0}\\&D_2 \ar[dl]^(.4){f_2}&&\hat{D}_1 \ar[dr]^{\hat{g}_1}\\G_2 && P\ar[dr]_{p_4} \ar[ur]_{p_3}\ar[dl]^{p_1} \ar[ul]^{p_2}&&G'_2\\& D'_1 \ar[ul]^{g'_1}&&D'_2 \ar[ur]_{f'_2}}\]

\[\xymatrix@R=15pt@C=15pt{&&L_1 \ar[dl]^{w_1} \ar@/_1.2cm/[dddl]_(.4){i_1}|(.63)\hole\ar[dd]^{v'_1} \ar@{.>}[dr]^{v_1}\\&\check{D}_1 \ar[dl]^(.4){\check{f}_1}&&\check{D}_0 \ar[dr]^{g'_0}\\G_1 && \check{Q}\ar[dr]_{\check{q}_4} \ar[ur]_{\check{q}_3}\ar[dl]^{\check{q}_1} \ar[ul]_{\check{q}_2}&&\check{G}_1\\& D_0 \ar[ul]^{g_0}&&\mathring{D}_1 \ar[ur]_{\check{f}_1}}\]




HUGE DIAGRAM


\[\xymatrix@C=15pt{
  & K_1 \ar[d]^{\hat{k}_1}\ar[l]_{l_1} \ar[r]^{r_1} & R_1 \ar@/^.35cm/[drrr]_(.4){t_0} \ar[dr]|(.28)\hole_{\hat{g}_1\circ c_0}   && L_0  \ar[dl]|(.28)\hole^{\hat{m}_0} \ar@/_.35cm/[dlll]^(.4){t_1}& K_0 \ar[d]^{\hat{k}_0}\ar[l]_{l_0} \ar[rr]^{r_0} && R_0 \ar[d]^{g_2\circ b_0} \\G_0 && \ar[ll]^{\hat{f}_0} \hat{D}_0 \ar[rr]_{\hat{g}_0}&& \hat{G}_1  && \ar[ll]^{\tilde{f}_1} \tilde{D}_1 \ar[rr]_{\tilde{g}_1}&& G'_2 && \ar[ll]^{f'_2} D'_2 \ar[rr]_{g'_2}&& G_3 \\
	L_2\ar[d]_{f_0\circ z_1} \ar[u]^{f'_0\circ c_1}&& K_2 \ar[d]_{\mathring{k}_2}\ar[ll]_{l_2} \ar[r]^{r_2} & R_2 \ar@/_.35cm/[urrr]^(.4){e_0}|(.285)\hole \ar[ur]|(.28)\hole^{\hat{h}_2} \ar@/^.35cm/[drrr]_(.4){v_0}|(.285)\hole \ar[dr]|(.28)\hole_{\mathring{h}_2} && L_1 \ar@/^.35cm/[ulll]_(.4){e_1} \ar[ul]|(.28)\hole_{\hat{m}_1} \ar@/_.35cm/[dlll]^(.4){v_1} \ar[dl]|(.28)\hole^{\mathring{f}_1 \circ x_1}& K_1 \ar[d]^{\mathring{k}_1}\ar[l]_{l_1} \ar[r]^{r_1} & R_1 \ar@/^.35cm/[drrr]_(.4){u_0}|(.285)\hole\ar[dr]_{\check{h}_1}   && L_0 \ar@/_.35cm/[dlll]^(.4){u_1} \ar[dl]^{\mathring{m}_0}& K_0 \ar[d]^{\mathring{k}_0}\ar[l]_{l_0} \ar[rr]^{r_0} && R_0\ar[d]^{\check{g}_2\circ x_0} \\G_0 && \ar[ll]^{\check{f}_0} \check{D}_0 \ar[rr]_{\check{g}_0}&& \check{G}_1  && \ar[ll]^{\bar{f}_1} \bar{D}_1 \ar[rr]_{\bar{g}_1}&& \bar{G}_2 && \ar[ll]^{\bar{f}_2} \bar{D}_2 \ar[rr]_{\bar{g}_2}&& G_3 }\]

Now, by determinism we have isomorphisms $\phi_{\check{D}_0}\colon \check{D}_0\to \hat{D}_0$ $\phi_{\check{G}_1}\colon \check{G}_1\to \hat{G}_1$
Notice that
\begin{align*}
	\hat{f}_0\circ \phi_{\check{D}_0}\circ v_1&= \check{f}_0\circ v_1\\&=\check{f}_0\circ \check{q}_3\circ v'_1\\&=f_0\circ \check{q}_1\circ v'_1\\&=f_0\circ i_1\\&=\hat{f}_0\circ e_1
\end{align*}

GOOD: $\phi_{\check{D}_0}$ sends $v_1$ to $e_1$, thus it respects the match of $L_1$. Automatically it sends $v_0$ to $e_0$.

CHECK THAT $\check{g}_2\circ x_0=g_2\circ j_0$

USO IL PRIMO LEMMA DEI TRE PASSI:

	\[\xymatrix{&R_0 \ar[dl]_{i_0} \ar@{.>}[dr]^{x_0} \ar@/^.4cm/[dd]|\hole^(.6){j_0}\ar[d]_{x'_0}\\ D_1 \ar[d]_{g_1}&P'\ar[d]_{p'_3} \ar[r]^{p'_4} \ar[l]_{p'_1}&\check{D}_2\ar[d]^{\check{g}_2}\\G_2&D_2 \ar[l]^{f_2}\ar[r]_{g_2}& G_3}\]



\[\xymatrix@R=15pt@C=15pt{&&L_ 0\ar[dl]^{I_1} \ar@/_1.2cm/[dddl]_(.4){d_1}|(.63)\hole\ar[dd]^{t'_1} \ar@{.>}[dr]^{t_1}\\&D'_0 \ar[dl]^(.4){g'_0}&&\tilde{D}_1 \ar[dr]^{\tilde{f}_1}\\G'_1 && S\ar[dr]_{s_4} \ar[ur]_{s_3}\ar[dl]^{s_1} \ar[ul]_{s_2}&&\hat{G}_1\\& \hat{D}_1 \ar[ul]^{\hat{f}_1}&&\hat{D}_0 \ar[ur]_{\hat{g}_0}}\]







\subsection{Concatenable traces}
\begin{lemma}
	\todo{abstract equivalence and switch }
\end{lemma}
\begin{proof}
	contenuto...
\end{proof}
\begin{definition}
	\todo{tracce}
\end{definition}

Before moving forward, we will prove some other useful properties of the switch equivalence relation.

\begin{lemma}
	\todo{lemma 19}
\end{lemma}
\begin{proof}
	contenuto...
\end{proof}


\begin{theorem}
	\todo{preordine}
\end{theorem}
\begin{proof}
	contenuto...
\end{proof}




\section{A class of well-behaved left-linear DPO-rewriting systems}