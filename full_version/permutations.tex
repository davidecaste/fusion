\chapter{Left-linear DPO-rewriting systems}

$\mathcal{M}$-adhesive categories are the right context in which to perform abstract rewriting using the so-called ``douple pushout approach'' (DPO). We will recall the basic definitions and properties of this approach to abstract rewriting. 
\section{First definitions and properties}
We are now going to study rewriting systems in $\mathcal{M}$-adhesive categories.

\begin{definition}[\cite{habel2012mathcal,heindel2009category}]
	Let $\X$ be an $\mathcal{M}$-adhesive category, a  \emph{left $\mathcal{M}$-linear} rule $\rho$ is a pair $(l,r)$ of arrows with the same domain, such that $l$ belongs to $\mathcal{M}$.  The rule $\rho$ is said to be \emph{$\mathcal{M}$-linear} if $r\in \mathcal{M}$ too. A rule $\rho$ is said to be \emph{consuming} if $l$ is not an isomorphism. We will represent a rule $\rho$ as a span 
	\[\xymatrix{L & K\ar@{>->}[l]_{l} \ar[r]^{r} & R}\]
	$L$ is the \emph{left-hand side}, $R$ is the \emph{right-hand side} and $K$ the \emph{glueing object}. 
	
	
	A \emph{left-linear DPO-rewriting system} is a pair $(\X, \R)$ where $\X$ is a $\mathcal{M}$-adhesive category and $R$ is a set of left $\mathcal{M}$-linear rules. $(\X, \R)$ will be called \emph{linear} if every rule in $R$ is $\mathcal{M}$-linear. Similarly, a \emph{consuming} left-linear DPO-rewriting system is one in which every rule is consuming.
	
	Given  two objects $G$ and $H$ and a rule $\rho=(l,r)$ in $\R$, a \emph{direct derivation $\mathscr{D}$ from $G$ to $H$ applying the rule $\rho$}, is a diagram as the one below, in which both squares are pushouts. 
	\[\xymatrix{L \ar[d]_{n}& K \ar[d]^{k}\ar@{>->}[l]_{l} \ar[r]^{r} & R \ar[d]^{h}\\G & \ar@{>->}[l]^{f} D \ar[r]_{g}& H}\]
	The arrow $n$ is called the \emph{match} of the derivation, while $h$ is its \emph{back-match}.
	We will denote a direct derivation $\dder{D}$ between $G$ and $H$ as $\dder{D}\colon G\Mapsto H$. 
\end{definition}


\begin{remark}\label{exa:conc} Let  $\dder{D}\colon G\Mapsto H$ be the direct derivation 
	\[\xymatrix{L \ar[d]_{n}& K \ar[d]^{k}\ar@{>->}[l]_{l} \ar[r]^{r} & R \ar[d]^{h}\\G & \ar@{>->}[l]^{f} D \ar[r]_{g}& H}\]
	If $\phi\colon G'\to G$ and $\psi\colon H\to H'$ are two isomorphisms, 	we can consider the direct derivation	$\phi * \dder{D}*\psi \colon G'\Mapsto H'$ given by the following diagram.
	\[\xymatrix{L \ar[d]_{\phi^{-1} \circ n}& K \ar[d]^{k}\ar@{>->}[l]_{l} \ar[r]^{r} & R \ar[d]^{\psi \circ h}\\G' & \ar@{>->}[l]^{\phi^{-1} \circ f} D \ar[r]_{\psi \circ g}& H'}\]
	
	In particular, we will use $\phi*\dder{D}$ and $\dder{D}*\psi$  to denote $\phi*\dder{D}*\id{H}$ and $\id{G}*\dder{D}*\psi$.
\end{remark}

\begin{example}\label{ex:1}
	Let us consider the category of $\cat{Graph}$ of all graphs and graph morphisms, which is adhesive (see, for instance \cite{lack2005adhesive,lack2006toposes}).   We can endow $\cat{Graph}$ with a set of left-linear rules, for instance taking the following ones.  Here numbers are used to represent the
	morphisms from the interface to the left- and right-hand
	sides. Rules $\rho_0$ and $\rho_1$ are linear: $\rho_0$ generates a
	new node and a new edge, while $\rho_1$ creates a self-loop edge. Instead,
	$\rho_2$ is left-linear but not linear, as it ``merges'' two nodes.
	\begin{center}
		\begin{tikzpicture}[node distance=2mm, font=\small]
			%, baseline=(current bounding box.center), font=\small]
			\node (l) {
				\begin{tikzpicture}
					%
					\node at (0,0.53) {};
					\node at (0,0) [node, label=below:$1$] (1) {} ;        
					%
					\pgfBox
				\end{tikzpicture} 
			};
			\node[font=\scriptsize, above] at (l.north) {$L_0$};
			\node [right=of l] (k) {
				\begin{tikzpicture}
					%
					\node at (0,0.53) {}; 
					\node at (0,0) [node, label=below:$1$] (1) {};
					%
					\pgfBox
				\end{tikzpicture} 
			};
			\node[font=\scriptsize, above] at (k.north) {$K_0$};
			\node[below] at (k.south) {$\rho_0$};
			\node  [right=of k] (r) {
				\begin{tikzpicture}
					\node at (0,0.53) {}; 
					\node at (0,0) [node, label=below:$1$] (1) {};
					\node at (.5,0) [node, label=below:$2$] (2) {};
					\draw[->] (1) to[out=20, in=160] (2);
					%
					\pgfBox
				\end{tikzpicture}
			};
			\node[font=\scriptsize, above] at (r.north) {$R_0$};
			\path (k) edge[->] node[trans, above] {} (l);
			\path (k) edge[->] node[trans, above] {} (r);    
		\end{tikzpicture}
		%  }
	%
	\hspace{1cm}
	%  \hfill
	%
	%  \subcaptionbox*{}{
		% RULE P1
		%
		\begin{tikzpicture}[node distance=2mm, font=\small]
			\node (l) {
				\begin{tikzpicture}
					%
					\node at (0,0.53) {}; 
					\node at (0,0) [node, label=below:$1$] (1) {} ;
					% 
					\pgfBox
				\end{tikzpicture} 
			};
			\node[font=\scriptsize, above] at (l.north) {$L_1$};
			\node [right=of l] (k) {
				\begin{tikzpicture}
					%
					\node at (0,0.53) {}; 
					\node at (0,0) [node, label=below:$1$] (1) {};
					% 
					\pgfBox
				\end{tikzpicture} 
			};
			\node[font=\scriptsize, above] at (k.north) {$K_1$};
			\node[below] at (k.south) {$\rho_1$};
			\node  [right=of k] (r) {
				\begin{tikzpicture}
					\node at (0,0) [node, label=below:$1$] (1) {}
					edge [in=55, out=85, loop] ();
					%
					\pgfBox
				\end{tikzpicture}
			};
			\node[font=\scriptsize, above] at (r.north) {$R_1$};
			\path (k) edge[->] node[trans, above] {} (l);
			\path (k) edge[->] node[trans, above] {} (r);
		\end{tikzpicture}
		%  }
	% 
	\hspace{1cm}
	%\hfill
	%
	%    \subcaptionbox*{}{
		% RULE P2
		%
		\begin{tikzpicture}[node distance=2mm, font=\small]
			\node (l) {
				\begin{tikzpicture}
					%
					\node at (0,0.53) {}; 
					\node at (0,0) [node, label=below:$1$] (1) {} ;
					\node at (0.5,0) [node, label=below:$2$] (2) {} ;
					%
					\pgfBox
				\end{tikzpicture} 
			};
			\node[font=\scriptsize, above] at (l.north) {$L_2$};
			\node [right=of l] (k) {
				\begin{tikzpicture}
					%
					\node at (0,0.53) {}; 
					\node at (0,0) [node, label=below:$1$] (1) {} ;
					\node at (0.5,0) [node, label=below:$2$] (2) {} ;
					%
					\pgfBox
				\end{tikzpicture} 
			};
			\node[font=\scriptsize, above] at (k.north) {$K_2$};
			\node[below] at (k.south) {$\rho_2$};
			\node  [right=of k] (r) {
				\begin{tikzpicture}
					\node at (0,0.53) {}; 
					\node at (0,0) [node, label=below:$12$] (12) {};
					%
					\pgfBox
				\end{tikzpicture}
			};
			\node[font=\scriptsize, above] at (r.north) {$R_2$};
			\path (k) edge[->] node[trans, above] {} (l);
			\path (k) edge[->] node[trans, above] {} (r);
		\end{tikzpicture}
	\end{center}
	
	We can also give an example of derivation as follows, where the colors are used to avoid ambiguity in the edges. Note that the numbers in $\rho_1$ were changed consistently to represent the vertical morphisms.
	
	\begin{center}
		\begin{tikzpicture}[node distance=2mm, font=\small, baseline=(current bounding box.center)]      
			\node (L0) at (0,2) {
				\begin{tikzpicture}
					% 
					\node at (0,0.53) {};
					\node at (0,0) [node, label=below:$1$] (1) {} ;
					% 
					\pgfBox
				\end{tikzpicture} 
			};
			\node [right=of L0] (K0) {
				\begin{tikzpicture}
					% 
					\node at (0,0.53) {}; 
					\node at (0,0) [node, label=below:$1$] (1) {};
					% 
					\pgfBox
				\end{tikzpicture} 
			};
			\node [above] at (K0.north) {$\rho_0$};
			%     \node [above=of K1] {$\rho_0$};
			\node [right=of K0](R0) {
				\begin{tikzpicture}
					\node at (0,0.53) {}; 
					\node at (0,0) [node, label=below:$1$] (1) {};
					\node at (.5,0) [node, label=below:$2$] (2) {};
					\draw[coloredge] (1) to[out=20, in=160] (2);
					% 
					\pgfBox
				\end{tikzpicture}
			};
			\path (K0) edge[->] node[trans, above] {} (L0);
			\path (K0) edge[->] node[trans, above] {} (R0);
			
			\node at (4,2) (L1) {
				\begin{tikzpicture}
					% 
					\node at (0,0.53) {}; 
					\node at (0,0) [node, label=below:$2$] (2) {} ;
					% 
					\pgfBox
				\end{tikzpicture} 
			};
			\node [right=of L1] (K1) {
				\begin{tikzpicture}
					% 
					\node at (0,0.53) {}; 
					\node at (0,0) [node, label=below:$2$] (2) {};
					% 
					\pgfBox
				\end{tikzpicture} 
			};
			%     \node [above=of K1] {$\rho_1$};
			\node [above] at (K1.north) {$\rho_1$};
			\node [right=of K1] (R1) {
				\begin{tikzpicture}
					\node at (0,0) [node, label=below:$2$] (2) {}
					edge [in=55, out=85, loop] ();        
					% 
					\pgfBox
				\end{tikzpicture}
			};
			\path (K1) edge[->] node[trans, above] {} (L1);
			\path (K1) edge[->] node[trans, above] {} (R1);
			
			\node at (8,2) (L2) {
				\begin{tikzpicture}
					% 
					\node at (0,0.53) {}; 
					\node at (0,0) [node, label=below:$1$] (1) {} ;
					\node at (0.5,0) [node, label=below:$2$] (2) {} ;
					% 
					\pgfBox
				\end{tikzpicture} 
			};
			\node [right=of L2] (K2) {
				\begin{tikzpicture}
					% 
					\node at (0,0.53) {}; 
					\node at (0,0) [node, label=below:$1$] (1) {} ;
					\node at (0.5,0) [node, label=below:$2$] (2) {} ;
					% 
					\pgfBox
				\end{tikzpicture} 
			};
			%      \node [above=of K2] {$\rho_2$};
			\node [above] at (K2.north) {$\rho_2$};
			\node [right=of K2] (R2) {
				\begin{tikzpicture}
					\node at (0,0.53) {}; 
					\node at (0,0) [node, label=below:$12$] (12) {};
					% 
					\pgfBox
				\end{tikzpicture}
			};
			\path (K2) edge[->] node[trans, above] {} (L2);
			\path (K2) edge[->] node[trans, above] {} (R2);
			
			%%%%%% second row
			\node at (0,0) (G0) {
				\begin{tikzpicture}
					% 
					\node at (0,0.53) {};
					\node at (0,0) [node, label=below:$1$] (1) {} ;
					% 
					\pgfBox
				\end{tikzpicture} 
			};
			\node [right=of G0] (D0) {
				\begin{tikzpicture}
					% 
					\node at (0,0.53) {}; 
					\node at (0,0) [node, label=below:$1$] (1) {};
					% 
					\pgfBox
				\end{tikzpicture} 
			};
			\node at (3,0) (G1) {
				\begin{tikzpicture}
					% 
					\node at (0,0.53) {}; 
					\node at (0,0) [node, label=below:$1$] (1) {} ;
					\node at (0.5,0) [node, label=below:$2$] (2) {} ;
					\draw[coloredge] (1) to[out=20, in=160] (2);
					% 
					\pgfBox
				\end{tikzpicture} 
			};
			\path (D0) edge[->] node[trans, above] {} (G0);
			\path (D0) edge[->] node[trans, above] {} (G1);
			\path (L0) edge[->] node[trans, above] {} (G0);
			\path (K0) edge[->] node[trans, above] {} (D0);
			\path (R0) edge[->] node[trans, above] {} (G1);
			
			\node at (5,0) (D1) {
				\begin{tikzpicture}
					% 
					\node at (0,0.53) {};
					\node at (0,0) [node, label=below:$1$] (1) {} ;
					\node at (0.5,0) [node, label=below:$2$] (2) {} ;
					\draw[coloredge] (1) to[out=20, in=160] (2);
					% 
					\pgfBox
				\end{tikzpicture} 
			};
			\node at (7,0) (G2) {
				\begin{tikzpicture}
					% 
					\node at (0,0.53) {}; 
					\node at (0,0) [node, label=below:$1$] (1) {};
					\node at (0.5,0) [node, label=below:$2$] (2) {}
					edge [in=55, out=85, loop] (); 
					\draw[coloredge] (1) to[out=20, in=160] (2);
					% 
					\pgfBox
				\end{tikzpicture} 
			};
			
			\path (D1) edge[->] node[trans, above] {} (G1);
			\path (D1) edge[->] node[trans, above] {} (G2);
			\path (L1) edge[->] node[trans, above] {} (G1);
			\path (K1) edge[->] node[trans, above] {} (D1);
			\path (R1) edge[->] node[trans, above] {} (G2);
			
			\node at (9.46,0) (D2) {
				\begin{tikzpicture}
					% 
					\node at (0,0) [node, label=below:$1$] (1) {};
					\node at (0.5,0) [node, label=below:$2$] (2) {}
					edge [in=55, out=85, loop] ();
					\draw[coloredge] (1) to[out=20, in=160] (2);
					% 
					\pgfBox
				\end{tikzpicture} 
			};
			\node [right=of D2] (G3) {
				\begin{tikzpicture}
					% 
					\node at (0,0) [node, label=below:$12$] (12) {}
					edge [in=55, out=85, loop] ()
					edge [in=125, out=155, colorloop] ();
					% 
					\pgfBox
				\end{tikzpicture} 
			};
			\node[font=\scriptsize, below] at (G0.south) {$G_0$};
			\node[font=\scriptsize, below] at (D0.south) {$D_0$};      
			\node[font=\scriptsize, below] at (G1.south) {$G_1$};
			\node[font=\scriptsize, below] at (D1.south) {$D_1$};      
			\node[font=\scriptsize, below] at (G2.south) {$G_2$};
			\node[font=\scriptsize, below] at (D2.south) {$D_2$};      
			\node[font=\scriptsize, below] at (G3.south) {$G_3$};      
			\path (D2) edge[->] node[trans, above] {} (G2);
			\path (D2) edge[->] node[trans, above] {} (G3);
			\path (L2) edge[->] node[trans, above] {} (G2);
			\path (K2) edge[->] node[trans, above] {} (D2);
			\path (R2) edge[->] node[trans, above] {} (G3);
		\end{tikzpicture}
		%
	\end{center}
	
\end{example}

$\mathcal{M}$-adhesivity of $\X$ guarantes the essential uniqueness of the result obtained rewriting an object, as shown by the next proposition.

\begin{proposition}\label{prop:unique} Let $\X$  be a $\mathcal{M}$-adhesive category. Suppose that the two direct derivations $\mathscr{D}$ and $\mathscr{D'}$ below, with the same match and applying the same left $\mathcal{M}$-linear rule $\rho$ are given.
	\[\xymatrix{L \ar[d]_{m}& K \ar[d]^{k}\ar@{>->}[l]_{l} \ar[r]^{r} & R \ar[d]^{h} & L \ar[d]_{m}& K \ar[d]^{k'}\ar@{>->}[l]_{l} \ar[r]^{r} & R \ar[d]^{h'}\\G & \ar@{>->}[l]^{f} D \ar[r]_{g}& H & G & \ar@{>->}[l]^{f'} D' \ar[r]_{g'}& H'}\]
	Then there exist isomorphisms $t\colon D\to D'$ and $s\colon H\to H'$ as in the following diagram.
	\[\xymatrix@C=40pt{&&D' \ar[r]^{g'} \ar@{>->}@/_.45cm/[dll]_{f'}&H'\\G & L \ar[l]_{m} & K \ar[u]_{k'} \ar[d]^{k}\ar[r]^{r} \ar@{>->}[l]_{l} &R\ar[u]^{h'} \ar[d]_{h}\\&&D\ar@{>->}@/^.45cm/[ull]^{f}\ar@/^.4cm/@{.>}[uu]^(.4){t}|\hole \ar[r]_{g}&H\ar@/_.4cm/@{.>}[uu]_{s}}\]
\end{proposition}
\begin{proof}
	By construction, the pairs $(k, f)$ and $(k', f')$ are pushout complements of $l$ and $n$. Thus, the existence of the isomorphism $t\colon D\to D'$ follows from the second point of \Cref{lem:radj}. Now, computing we have
	\begin{align*}
		g'\circ t \circ k &= g' \circ k'\\&=h'\circ r
	\end{align*}
	Hence, we have the wanted $s\colon H\to H'$. To see that $s$ is an isomorphism, consider the diagram 
	\[\xymatrix{K  \ar@/^.4cm/[rr]^{k'}\ar[d]_{r} \ar[r]_{k}& \ar[r]_{t} D \ar[d]^{g}& D' \ar[d]^{g'}\\ R \ar@/_.4cm/[rr]_{h'} \ar[r]^{h}& H \ar[r]^{s}& H'}\]
	By hypothesis the whole rectangle and its left half are pushouts, therefore, by \Cref{lem:po1} its right square is a pushout too. The claim now follows from the fact that the pushout of an isomorphism is an isomorphism.
\end{proof}

If we look to direct derivations as transitions, it is natural to consider them as edges in a direct graph. Taking objects as vertices objects led us to the following definition \cite{heindel2009category}.

\begin{definition}
	Let $(\X, \R)$ be a left-linear DPO-rewrityng system, with $\X$ $\mathcal{M}$-adhesive. The \emph{DPO-derivation graph} of $(\X, \R)$ is the (large)  directed graph $\gpo$ having as vertices the objects of $\X$ and in which an edge between $G$ and $H$ is a direct derivation $\dder{D}\colon G\Mapsto H$.	A \emph{derivation} $\der{D}$ between two objects $G$ and $H$ is a path between them in $\gpo$. The \emph{source} and \emph{target} of $\der{D}$ are, respectively, $G$ and $H$.
\end{definition}

\begin{remark}
	We can spell out more explicitly what  a derivation $\dder{D}$ is.  An \emph{empty derivation} starting and ending in $G$ is just $G$ itself.  A \emph{non-empty derivation} $\dder{D}$ is a sequence $\{\dder{D}_i\}_{i=0}^n$ of direct derivations such that:
	\begin{enumerate}
		\item for every index $i$, $\dder{D}_i$ is a direct derivation $G_i \Mapsto G_{i+1}$;
		\item $G_0=G$ and $G_{n+1}=H$.
	\end{enumerate}
	
	We will call the number $n+1$ the \emph{length} of the derivation, denoted by $\lgh(\der{D})$. We will also say that an empty derivation has length $0$. 
	
	Moreover,  if every $\dder{D}_i$ applies the rule $\rho_i\in R$, then we can define an associated sequence of rules as $r(\der{D})$ as $\{\rho_i\}_{i=0}^n$.
\end{remark}

\begin{remark}\label{rem:func}
	Consider a derivation $\der{D}$ in a left-linear DPO-rewriting system $(\X, \R)$. We can take the subcategory $\Delta(\der{D})$ of $\X$ given by the arrows appearing in $\der{D}$. This subcategory comes equipped with an inclusion functor $I(\der{D})\colon \Delta(\der{D})\to \X$. Moreover, we can further define $\Deltamin(\der{D})$ as the subcategory of $\Delta(\der{D})$ containing only the bottom row of the derivation.
\end{remark}

\begin{notation}Let $\der{D}=\{\dder{D}_i\}_{i=0}^n$ be a derivation. We will depict the $i^\text{th}$ element $\dder{D}_i$ of $\der{D}$ as in the following diagram.  
	\[\xymatrix{L_i \ar[d]_{m_i}& K_i \ar[d]^{k_i}\ar@{>->}[l]_{l_i} \ar[r]^{r_i} & R_i \ar[d]^{h_i} \\G_{i} & \ar@{>->}[l]^{f_{i}} D_{i} \ar[r]_{g_{i}}& G_{i+1} }\]
	Notice that, in particular, if $\der{D}\colon G\to H$, then $G_0=G$ and $G_{n+1}=H$. When $\der{D}$ has length $1$ we will suppress the indexes. In such case, we will also identify $\der{D}$ with its only element. 
\end{notation} 

\begin{example}\todo{esempi di derivazione}
\end{example}

\begin{definition}
	The \emph{DPO-derivation category} $\dpo$ of a left-linear DPO-rewriting system $(\X, \R)$ is the category in which arrows between $G$ and $H$ are given by, possibly empty, derivations. Composition is concatenation of paths in $\gpo$ and identities are given by empty derivations.
\end{definition} 	
\begin{remark}
	More explicitly, given $\der{D}=\{\dder{D}\}_{i=0}^n$ between $G$ and $H$ and $\der{D}'=\{\dder{D}'_i\}_{i=0}^m$, their concatenation $\der{D}\cdot\der{D}'$ is the derivation $\{\dder{E}_i\}_{i=0}^{m+n+1}$ in which
	\[\dder{E}_i:=\begin{cases}
		\dder{D}_i & i \leq n\\
		\dder{D}'_{i-(n+1)} & n< i 
	\end{cases}\]	
	
	Notice, moreover that, $\der{D}\cdot \der{D'}$ is equal to $\der{D}'$ if $\der{D}$ is empty, while it coincides with $\der{D}$ if $\der{D}'$ has length zero.
\end{remark}

\Cref{exa:conc} allows us to compose derivations with isomorphisms.

\begin{definition} Let $(\X, \R)$ be a a left-linear DPO-rewriting system. Given a derivation $\der{D}=\{\dder{D}_{i}\}_{i=0}^n$ between $G$ and $H$ and isomorphisms $\phi\colon G'\to G$, $\psi\colon H\to H'$, the derivations  $\phi*\der{D}$ and $\der{D}*\psi$ are defined as
	\[\phi *\der{D} := \begin{cases}
		G' & \lgh(\der{D})=0\\ 
		\{\phi* \dder{D}_0\}\cdot \{\dder{D}_i\}_{i=1}^{n}  & \lgh(\der{D})\neq 0
	\end{cases} \qquad \der{D}*\psi := \begin{cases}
		H' & \lgh(\der{D})=0\\ 
		\{\dder{D}_i\}_{i=0}^{n-1} \cdot \{\dder{D}_n*\psi\} & \lgh(\der{D})\neq 0
	\end{cases}\] 
	
	Moreover, if $\lgh(\der{D})>0$,  we define the derivation $\phi *\der{D} * \psi$ as
	\[\phi *\der{D} * \psi = \{\phi* \dder{D}_0\}\cdot \{\dder{D}_i\}_{i=1}^{n-1} \cdot \{\dder{D}_n*\psi\}\] 
\end{definition}

\begin{remark}
	When $\der{D}$ consists only in the direct derivation $\dder{D}$, then $\phi*\der{D}*\psi$ is the derivation of length one whose unique element is $\phi*\dder{D}*\psi$.
\end{remark}

\subsection{Decorations and abstraction equivalence}
We are often interested in an object of $\X$ only up to isomorphism. It is therefore useful to consider a version of $\gpo$ in which vertices are classes of isomorphism of object of $\X$. In order to do so, some preliminary work is needed.

\begin{definition}\cite{mac2013categories}
	Let $\X$ be a category, we say that  $\X$ is \emph{skeletal} if, for every two objects $X$ and $Y$, the existence of an isomorphism $\phi\colon X\to Y$ entails $X=Y$. A \emph{skeleton} for a category $\X$ is a full subcategory $\ske$ which is skeletal and such that the inclusion functor $\ske\to \X$ is an equivalence. 
\end{definition}

\begin{remark}
	By definition the inclusion $\ske \to \X$ is an equivalence. In particular, this mean that, for every objects $X$ of $\X$ there exists $\pi(X)$ in $\ske$ and an isomorphism $\phi_X\colon \pi(X) \to X$.
\end{remark}

\begin{proposition}\label{prop:ske}
	Every category $\X$ has a skeleton. 
\end{proposition}
\begin{proof}
	For every object $X\in \X$, pick a single representative $\pi(X)$ of its isomorphism class. Let $\ske$ be the full subcategory given by these objects. By definition $\ske$ is skeletal and the inclusion functor is full, faithful and essentially surjective.\qedhere 
\end{proof}
\begin{remark}
	The proof of \Cref{prop:ske} relies on the axiom of choice for classes.
\end{remark}
\begin{remark}
	It is possible to proof that every two skeleta of a given category $\X$ are isomorphic (not only equivalent). For the remaining of this paper we assume that a skeleton $\ske$ of $\X$ and a functor $\pi\colon \X\to \ske$ are chosen once and for all.
\end{remark}

\begin{definition}
	Let $(\X, \R)$ be a left-linear DPO-rewriting system, a \emph{decorated derivation} between two objects $G$ and $H$ is a triple $(\der{D}, \alpha, \omega)$, where $\der{D}$ is a derivation between $G$ and $H$, and $\alpha\colon \pi(G)\to G$ and $\omega\colon \pi(H)\to H$ are isomorphisms.
\end{definition}

\begin{notation}
	We will extend the use of the words length, source and target to decorated derivations in the obvious way, forgetting the decorations $\alpha$ and $\omega$.
\end{notation}

\begin{example}A decorated derivation $(\der{D}, \alpha, \omega)$ with $\der{D}$ empty is just a span
	\[\xymatrix{G & \pi(G) \ar[r]^-{\omega} \ar[l]_-{\alpha} & G}\]
	in which both $\omega$ and $\alpha$ are isomorphisms.
\end{example}

As we are interested in objects only up to isomorphism, so we are interested in (decorated) derivations only up to some notion of coherent isomorphism between them. This is done with the help of \Cref{rem:func}.

\begin{definition}Let $(\X, \R)$ be a left-linear DPO-rewriting system,  an \emph{abstraction equivalence} between two derivations $\der{D}$ and $\der{D'}$ with the same length and such that $r(\der{D})=r(\der{D}')$, is a family of isomorphisms $\{\phi_X\}_{X\in \Deltamin(\der{D})}$ such that, for every $i\in [0, \lgh(\der{D})]$ the following diagram commutes
	\[\xymatrix@C=40pt{G'_i&D'_i \ar[r]^{g'_i} \ar@{>->}[l]_{f'_i}&G'_{i+1}\\  L_i \ar[u]^{n'_i} \ar[d]_{n_i}& K_i \ar[u]^{k'_i} \ar[d]_{k_i} \ar[r]^{r_i} \ar@{>->}[l]_{l_i} &R\ar[u]^{h'_i} \ar[d]_{h_i}\\G_i \ar@/_.45cm/[uu]_(.35){\phi_{G_i}}|\hole&D_i\ar@{>->}[l]^{f_i}\ar@/_.45cm/[uu]_(.35){\phi_{D_i}}|\hole \ar[r]_{g_i}&G_{i+1}\ar@/_.45cm/[uu]_{\phi_{H_i}}}\]
	
	Given two decorated derivations $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$, we say that they are \emph{abstraction equivalent}, if $\lgh(\der{D})=\lgh(\der{D}')$, $r(\der{D})=r(\der{D'})$, and there exists an of abstraction equivalence between $\der{D}$ and  $\der{D}$ such that the triangles below commute.
	\[\xymatrix@C=15pt{&\pi(G_0) \ar[dr]^{\alpha'} \ar[dl]_{\alpha}&&& \pi(G_{n+1}) \ar[dr]^{\omega'} \ar[dl]_{\omega}\\ G_0 \ar[rr]_{\phi_{G_0}} && G'_0 &G_{n+1} \ar[rr]_{\phi_{G_{n+1}}} && G'_{n+1} } \]
	We will use $\equiv^a$ to denote the resulting relation.
\end{definition}

\begin{remark}\label{rem:equi}
	It is immediate to see that $\equiv^a$ is an equivalence relation. Indeed $(\der{D}, \alpha, \omega)$ is abstract equivalent to itself via the abstract equivalence with the identities as components. Furthermore, if  $\{\phi_X\}_{X\in \Deltamin(\der{D})}$  witnesses $(\der{D}, \alpha, \omega)\equiv^a (\der{D}', \alpha', \omega')$, then considering $\{\phi^{-1}_X\}_{X\in \Deltamin(\der{D})}$ shows $(\der{D}', \alpha', \omega)\equiv^a (\der{D}, \alpha, \omega)$. Finally, transitivity is assured composing abstract equivalences. 
	
	We will denote by $[\der{D}, \alpha, \omega]_a$ is just the equivalence class of  $(\der{D}, \alpha, \omega)$.
	Such equivalence classes will be called  \emph{abstract decorated derivation}.  
\end{remark}

\begin{example}\label{rem:empty}
	Let $(\der{D},\alpha, \omega)$ be an empty derivation from an object $G$ and  $(\der{D}',\alpha', \omega')$ a another empty one from $G'$.  If $(\der{D},\alpha, \omega)\equiv^a(\der{D}',\alpha', \omega')$ then an abstraction equivalence between $\der{D}$ and $\der{D}'$ is just an isomorphism $\phi\colon G\to G'$, so that $\pi(G)=\pi(G')$. Moreover, such isomorphism must fit in the diagrams below.
	\[\xymatrix@C=15pt{&\pi(G) \ar[dr]^{\alpha'} \ar[dl]_{\alpha}&&& \pi(G) \ar[dr]^{\omega'} \ar[dl]_{\omega}\\ G\ar[rr]_{\phi} && G' &G \ar[rr]_{\phi} && G' } \]
	In particular, these two triangles imply that
	\begin{align*}
		\alpha'\circ \alpha^{-1}&=\phi \\&=\omega'\circ \omega^{-1}
	\end{align*}
\end{example}

\begin{remark}\label{rem:res} \Cref{prop:unique} can be restated as saying that, given two direct derivations $\dder{D}$ and $\dder{D'}$ with the same match, there exists an abstract equivalence between them whose first component is an identity.
\end{remark}

\begin{remark}\label{rem:absequi}
	Let $\der{D}$ be a derivation with source $G$ and target $H$. Let also $\phi\colon G'\to G$ and $\psi\colon H\to H'$ be two isomorphisms. Then for every $X\in \Deltamin(\der{D})$ we can define 
	\[\varphi_X:=\begin{cases}
		\phi^{-1} & X=G\\
		\id{X} & \text{otherwise}
	\end{cases} \qquad \varphi'_X:=\begin{cases}
		\psi & X=H\\
		\id{X} & \text{otherwise}
	\end{cases}\]
	It is immediate to see that the family $\{\varphi_X\}_{X\in \Deltamin(\der{D})}$ is an abstraction equivalence between $\der{D}$ and $\phi *\der{D}$, while $\{\varphi'_X\}_{X\in \Deltamin(\der{D})}$ is one between $\der{D}$ and $\der{D}*\psi$.  
	
	Taking in account the decorations, we also have that $\{\phi_X\}_{X\in \Deltamin(\der{D})}$ and  $\{\phi'_X\}_{X\in \Deltamin(\der{D})}$ witness, respectively, that 
	\[(\der{D}, \alpha, \omega) \equiv^a (\phi * \der{D}, \phi^{-1}\circ \alpha,   \varphi^{-1}_{H} \circ \omega) \qquad (\der{D}, \alpha, \omega) \equiv^a ( \der{D}*\psi, \varphi'_{G} \circ \alpha, \psi \circ \omega )\]

Notice, moreover, that if $\der{D}$ is not empty, then the previous equations become
\[(\der{D}, \alpha, \omega) \equiv^a (\phi * \der{D}, \phi^{-1}\circ \alpha,   \omega) \qquad (\der{D}, \alpha, \omega) \equiv^a ( \der{D}*\psi, \alpha, \psi \circ \omega )\]
\end{remark}

\begin{definition}\label{def:conc}
	Let $(\der{D}, \alpha, \omega)$ be a decorated derivation between $G$ and $H$ and $(\der{D}', \alpha', \omega')$ one between $H'$ and $K$. If $H$ and $H'$ are isomorphic, so that $\pi(H)=\pi(H')$, we define the  \emph{composite decorated derivation} putting
	\[(\der{D}, \alpha, \omega)\cdot (\der{D}', \alpha', \omega'):=\begin{cases}
		(\der{D}', \alpha'\circ \omega^{-1}\circ \alpha, \omega')	&\lgh(\der{D})=0 \\
		(\der{D}, \alpha, \omega \circ (\alpha')^{-1}\circ \omega')&\lgh(\der{D}')=0 \text{ and } \lgh(\der{D})\neq 0\\
		(\der{D}*\omega^{-1}\cdot \alpha'*\der{D'}, \alpha, \omega')	&\text{otherwise}
	\end{cases}\]
\end{definition}


\begin{remark}\label{rem:lgt}
	Let $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ two composable decorated derivations   such that $\lgh(\der{D})=n$ and $\lgh(\der{D}')=m$.	 Then $(\der{D}*\omega^{-1}\cdot \alpha'*\der{D'}, \alpha, \omega')$ has length $n+m$.
\end{remark}

The next proposition justifies the use of decorations, guaranteeing that concatenation of abstract decorated derivations is well-defined.
\begin{lemma}\label{lem:conc}
	Given a decorated derivation $(\der{D}, \alpha, \omega)$  between $G$ and $H$ and  another one $(\der{E}, \beta, \xi)$ between $E$ and $K$ with $\pi(H)=\pi(E)$. If  $(\der{D}', \alpha', \omega')$ and $(\der{E}', \beta', \xi')$ are two other decorated derivations such that
	\[[\der{D}, \alpha, \omega]_a = [\der{D}', \alpha', \omega']_a \qquad [\der{D}, \beta, \xi]_a=[\der{E}', \beta', \xi']_a\]
	Then
	\[[(\der{D}, \alpha, \omega)\cdot (\der{E}, \beta, \xi)]_a=[(\der{D}', \alpha', \omega')\cdot (\der{E}', \beta', \xi')]_a\]
\end{lemma}

\begin{proof} Take two abstraction equivalences $\{\phi_X\}_{X\in \Deltamin(\der{D})}$ and $\{\varphi_X\}_{X\in \Deltamin(\der{D})}$ between $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ and between $(\der{E}, \beta, \xi)$ and $(\der{E}', \beta', \xi')$, respectively. To fix the notation, suppose that goes from $G'$ to $H'$ and $(\der{E}', \beta', \xi')$ from $E'$ to $K'$. We have three cases.
	
	\begin{itemize}
		\item $\lgh(\der{D})=0$. Then, $\lgh(\der{D}')$ is $0$ too. By \Cref{def:conc} we have
		\begin{align*}
			(\der{D}, \alpha, \omega)\cdot (\der{E}, \beta, \xi)&=(\der{E}, \beta\circ \omega^{-1}\circ \alpha, \xi)\\
			(\der{D}', \alpha', \omega')\cdot (\der{E}', \beta', \xi')&=(\der{E}', \beta'\circ (\omega')^{-1}\circ \alpha', \xi')
		\end{align*}
		Now, notice that $G$ and $H$ must coincide. Moreover, by \Cref{rem:empty} we also know that $\pi(G)=\pi(G')$ too. The same \Cref{rem:empty} entails that the inner squares of the following diagram are commutative, so that the whole rectangle commutes too.
		\[\xymatrix@C=35pt{\pi(G) \ar[r]^{\alpha} \ar[d]_{\id{\pi(G)}}& G  \ar[d]_{\phi_G}\ar[r]^-{\omega^{-1}} & \pi(G) \ar[d]_{\id{\pi(G)}} \ar[r]^{\beta}& E \ar[d]^{\varphi_E}\\\pi(G') \ar[r]_{\alpha'}& G' \ar[r]_-{(\omega')^{-1}} & \pi(G') \ar[r]_{\beta'} & E'}\]
		
		We can  then conclude that $\{\varphi_X\}_{X\in \Deltamin(\der{D})}$ witnesses the fact that $(\der{E}, \beta\circ \omega^{-1}\circ \alpha, \xi)$ is abstraction equivalent to $(\der{E}', \beta'\circ (\omega')^{-1}\circ \alpha', \xi')$.
		
		\item $\lgh(\der{D})\neq 0$ and $\lgh(\der{E})= 0$. As in the point above, we get that also $\der{E}'$  is an empty derivation, thus we have
		\begin{align*}
			(\der{D}, \alpha, \omega)\cdot (\der{E}, \beta, \xi)&=(\der{D},  \alpha, \omega \circ \beta^{-1}\circ \xi)\\
			(\der{D}', \alpha', \omega')\cdot (\der{E}', \beta', \xi')&=(\der{D}',  \alpha', \omega' \circ (\beta')^{-1}\circ \xi')
		\end{align*}
		In this case we have that $E=K$ and that $\pi(E)=\pi(E')$. From \Cref{rem:empty} we deduce that the diagram below commutes.
		\[\xymatrix@C=35pt{\pi(E) \ar[r]^{\xi} \ar[d]_{\id{\pi(E)}}& E  \ar[d]_{\varphi_E}\ar[r]^-{\beta^{-1}} & \pi(E) \ar[d]_{\id{\pi(E)}} \ar[r]^{\omega}& H \ar[d]^{\phi_H}\\\pi(E') \ar[r]_{\xi'}& E' \ar[r]_-{(\beta')^{-1}} & \pi(E') \ar[r]_{\omega'} & H'}\]
		The thesis now follows at once.
		\item $\lgh(\der{D})\neq 0$ and $\lgh(\der{E})\neq 0$. In this case we have
		\begin{align*}
			(\der{D}, \alpha, \omega)\cdot (\der{E}, \beta, \xi)&=(\der{D}*\omega^{-1}\cdot \beta*\der{E}, \alpha, \xi)\\
			(\der{D}', \alpha', \omega')\cdot (\der{E}', \beta', \xi')&=(\der{D}'*(\omega')^{-1}\cdot \beta'*\der{E'}, \alpha', \xi')
		\end{align*}
		To fix the notation, suppose that $\der{D}$, $\der{D}'$, $\der{E}$ and $\der{E}'$ are given by
		\[\der{D}=\{\dder{D}_i\}_{i=0}^n \quad \der{D}'=\{\dder{D}'_i\}_{i=0}^n \quad \der{E}=\{\dder{E}_i\}_{i=0}^t \quad \der{E}'=\{\dder{E}'_i\}_{i=0}^t\]
		Moreover, noticing that the rule applied by $\dder{D}_i$ and the one applied in $\mathcal{E}_i$  must coincide with, respectively, the one applied in $\dder{D}'_i$ and the one applied $\dder{E}'_i$. We will also assume that $\dder{D}_i$, $\dder{D}'_i$, $\dder{E}_i$ and $\dder{E}'_i$ are given, respectively, by the following four diagrams. 
		\[\xymatrix{L_{\der{D},i} \ar[d]_{m_{\der{D}, i}}& K_{\der{D},i} \ar[d]_{k_{\der{D}, i}} \ar[r]^{r_{\der{D},i}} \ar@{>->}[l]_{l_{\der{D},i}} & R_{\der{D},i}\ar[d]^{h_{\der{D}, i}} &L_{\der{E},i} \ar[d]_{m_{\der{E}, i}}& K_{\der{E},i} \ar[d]_{k_{\der{E}, i}} \ar[r]^{r_{\der{E},i}} \ar@{>->}[l]_{l_{\der{E},i}} & R_{\der{E},i}\ar[d]^{h_{\der{E}, i}} \\G_i & D_i \ar[r]_{g_{\der{D},i}} \ar@{>->}[l]^{f_{\der{D},i}} & G_{i+1} & E_i & F_i\ar[r]_{g_{\der{E},i}} \ar@{>->}[l]^{f_{\der{E},i}}  & E_{i+1}}\]
		\[\xymatrix{L_{\der{D},i} \ar[d]_{m_{\der{D}', i}}& K_{\der{D},i} \ar[d]_{k_{\der{D}', i}} \ar[r]^{r_{\der{D},i}} \ar@{>->}[l]_{l_{\der{D},i}} & R_{\der{D},i}\ar[d]^{h_{\der{D}', i}} &L_{\der{E},i} \ar[d]_{m_{\der{E}', i}}& K_{\der{E},i} \ar[d]_{k_{\der{E}', i}} \ar[r]^{r_{\der{E},i}} \ar@{>->}[l]_{l_{\der{E},i}} & R_{\der{E},i}\ar[d]^{h_{\der{E}', i}} \\G'_i & D'_i \ar[r]_{g_{\der{D}',i}} \ar@{>->}[l]^{f_{\der{D}',i}} & G'_{i+1} & E'_i & F'_i\ar[r]_{g_{\der{E}',i}} \ar@{>->}[l]^{f_{\der{E}',i}}  & E'_{i+1}}\]
		
		Now, for every $X\in \Deltamin(\der{D}*\omega^{-1}\cdot \beta*\der{E})$ we can define
		\[\psi_X:=\begin{cases}
			\phi_X & X\in  \Deltamin(\der{D})\text{ and } X\neq H\\\varphi_X & X\in  \Deltamin(\der{E}) \text{ and } X\neq E\\\id{\pi(H)}& X=\pi(H)\end{cases}\]
		Notice that, since $\psi_G=\phi_G$ and $\psi_K=\varphi_K$ we have at once  the commutativity of the triangles
		\[\xymatrix@C=15pt{&\pi(G) \ar[dr]^{\alpha'} \ar[dl]_{\alpha}&&& \pi(K) \ar[dr]^{\xi'} \ar[dl]_{\xi}\\ G\ar[rr]_{\psi_G} && G' &K \ar[rr]_{\psi_K} && K' } \]
		
		
		To show that $\{\psi_X\}_{\Deltamin(\der{D}*\omega^{-1}\cdot \beta*\der{E})}$ is an abstraction equivalence, it is now enough to prove the commutativity of the diagrams below.
		\[\xymatrix@R=15pt@C=22pt{\pi(E')&&F'_0 \ar@{>->}[ll]_-{(\beta')^{-1}\circ f_{\der{E}',0}} \ar@{>->}@/^.2cm/[dll]^(.6){f_{\der{E}',0}} \ar[r]^{g_{\der{E}',0}}&E'_1 &G'_n&D'_n \ar[rr]^-{(\omega')^{-1}\circ g_{\der{D}',n}} \ar@/_.2cm/[drr]_(.6){g_{\der{D}',n}} \ar@{>->}[l]_{f_{\der{D}',n}}&&\pi(H')
			\\E' \ar[u]_{(\beta')^{-1}} &&&&&&&H' \ar[u]^{(\omega')^{-1}}
			\\  L_{\der{E}, 0} \ar[u]_{m_{\der{E}', 0}} \ar[d]^{m_{\der{E}, 0}}&& K_{\der{E}, 0} \ar[uu]_{k_{\der{E}', 0}} \ar[dd]^{k_{\der{E}, i}} \ar[r]^(.4){r_{\der{E},0}} \ar@{>->}[ll]_{l_{\der{E},0}} &R_{\der{E}, 0}\ar[uu]_{h_{\der{E}',0}} \ar[dd]^{h_{\der{E},0}} & L_{\der{D}, n} \ar[uu]^{m_{\der{D}',n}} \ar[dd]_{m_{\der{D},n}}& K_{\der{D}, n} \ar[uu]^{k_{\der{D}',n}} \ar[dd]_{k_{\der{D},n}} \ar[rr]^{r_{\der{D},n}} \ar@{>->}[l]_(.4){l_{\der{D},n}} &&R_{\der{D}, n}\ar[u]^{h_{\der{D}',n}} \ar[d]_{h_{\der{D},n}}
			\\E \ar[d]^{\beta^{-1}}&&&&&&&H \ar[d]_{\omega^{-1}}
			\\\pi(E) \ar@/^.7cm/[uuuu]^(.2){\id{\pi(E)}}&&F_0\ar@{>->}[ll]^{\beta^{-1}\circ f_{\der{E},0}}\ar@/^.7cm/[uuuu]^(.35){\varphi_{F_0}}|\hole \ar@{>->}@/_.2cm/[ull]_(.6){f_{\der{E},0}}\ar[r]_{g_{\der{E},0}}&E_1\ar@/^.7cm/[uuuu]^(.35){\varphi_{E_1}}|\hole&G_n \ar@/_.7cm/[uuuu]_(.35){\phi_{G_n}}|\hole&D_n\ar@{>->}[l]^{f_{\der{D},n}}\ar@/_.7cm/[uuuu]_(.35){\phi_{D_n}}|\hole \ar@/^.2cm/[urr]^(.6){g_{\der{D},n}}\ar[rr]_{\omega^{-1}\circ g_{\der{D},n}}&&\pi(H)\ar@/_.7cm/[uuuu]_(.2){\id{\pi(H)}}} \]
		
		To see this, in turn, it is enough to show that	the following squares are commutative.
		\[\xymatrix{R_{\der{D}, n} \ar[d]_{h_{\der{D}, n}}\ar[r]^{h_{\der{D}', n}} & H' \ar[d]_{(\omega')^{-1}} &L_{\der{E}, 0} \ar[d]^{m_{\der{E}, 0}}\ar[r]^{m_{\der{E}', 0}}& E' \ar[d]^{(\beta')^{-1}}\\H\ar[r]_{\omega^{-1}} &\pi(H)&E \ar[r]_{\beta^{-1}} & \pi(E)}\]
		\[\xymatrix{D_n \ar[rr]^{\phi_{D_n}} \ar[d]_{g_{\der{D}, n}}&&D'_n \ar[d]_{g_{\der{D}', n}}&F_0 \ar@{>->}[d]^{f_{\der{E}, 0}} \ar[rr]^{\varphi_{F_0}} && F_0' \ar@{>->}[d]^{f_{\der{E}', 0}}\\H \ar[r]_-{\omega^{-1}} &\pi(H)&H' \ar[l]^-{(\omega')^{-1}}  &E \ar[r]_-{\beta^{-1}} & \pi(E) & E' \ar[l]^-{(\beta')^{-1}}}\]
		
		For the first ones, we have
		\[
		\begin{split} 
			\omega^{-1} \circ h_{\der{D}, n}&=\id{\pi(H)}\circ \omega^{-1} \circ h_{\der{D}, n} \\&=(\omega')^{-1}\circ \phi_H \circ \omega \circ \omega^{-1} \circ h_{\der{D}, n}\\&=(\omega')^{-1}\circ \phi_H  \circ h_{\der{D}, n}\\&=(\omega')^{-1}  \circ h_{\der{D}', n}
		\end{split} \qquad  	\begin{split} 
			\beta^{-1} \circ m_{\der{E}, 0}&=\id{\pi(E)}\circ \beta^{-1} \circ m_{\der{E}, 0}\\&=(\beta')^{-1}\circ \varphi_{E} \circ \beta \circ \beta^{-1} \circ m_{\der{E}, 0}\\&=(\beta')^{-1}\circ \varphi_{E}  \circ m_{\der{E}, 0}\\&=(\beta')^{-1}  \circ m_{\der{E}', 0}
		\end{split}  \]
		
		Similarly, the commutativity of the second row of diagrams can be deduced from
		\[\begin{split}
			\omega^{-1} \circ g_{\der{D}, n}&=\id{\pi(H)}\circ \omega^{-1} \circ g_{\der{D}, n}\\&=(\omega')^{-1}\circ \phi_H \circ \omega\circ \omega^{-1} \circ g_{\der{D}, n}\\&=(\omega')^{-1}\circ \phi_H  \circ g_{\der{D}, n}\\&= (\omega')^{-1} \circ g_{\der{D}', n}\circ \phi_{D_n}
		\end{split}\qquad \begin{split}\beta^{-1} \circ f_{\der{E}, 0}&=\id{\pi(E)}\circ \beta^{-1} \circ f_{\der{E}, 0}\\&=(\beta')^{-1}\circ \varphi_E \circ \beta\circ \beta^{-1} \circ f_{\der{E}, 0}\\&=(\beta')^{-1}\circ \varphi_E  \circ f_{\der{E}, 0}\\&= (\beta')^{-1} \circ f_{\der{E}', n}\circ \varphi_{F_0}
		\end{split}\]
		
		The thesis now follows.	\qedhere 
	\end{itemize}	
\end{proof}

\begin{definition}
	Let $(\X, \R)$ be a left-linear DPO-rewrityng system, with $\X$ an $\mathcal{M}$-adhesive category. The  category $\dpi$ is defined as follows:
	\begin{itemize}
		\item objects are isomorphism classes of objects of $\X$;
		\item an arrow $[G]\to [H]$ is an equivalence class $[\der{D}, \alpha, \omega]_a$ of a decorated derivation between $G'$ and $H'$ for some $G'$ and $H'$ such that $\pi(G')=G$ and $\pi(H')=H$;
		\item composition is concatenation of abstract decorated derivations;
		\item the identity on $[G]$ is $[G, \alpha, \alpha]_a$, where $\alpha$ is any isomorphism $\pi(G)\to G$.	\end{itemize}
\end{definition}




\subsection{Colimits of derivations}
Given a DPO-rewriting system $(\X, \R)$,  we have already noted in \Cref{rem:func} that a derivation $\der{D}$  determines a diagram $\Delta(\der{D})$ in $\X$. We can then wonder if such a diagram has a colimit. Clearly if $\der{D}$ is the empty derivation $G$ then a colimit for $\Delta(\der{D})$ is simply the object $G$. More generally, we have the following result.

\begin{lemma}\label{lem:colim}
	Let $\X$ be an $\mathcal{M}$-adhesive category and $(\X, \R)$ a left-linear DPO-rewriting system over it. The following properties hold true:
	\begin{enumerate}
		\item  for eevery derivation $\der{D}$ is a derivation from $G$ to $H$, then the diagram $\Delta(\der{D})$ has a colimit $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D})})$ such that $\iota_H$ belongs to $\mathcal{M}$.
		\item Let $\der{D}$ be the concatenation $\der{D}_1\cdot \der{D}_2$ of two derivations $\der{D}_1=\{\dder{D}_{1,i}\}_{i=0}^{n_1}$ between $G$ and $H$ and $\der{D}_2=\{\dder{D}_{2,j}\}_{j=0}^{n_2}$ between $H$ and $T$,  then the colimiting cocone $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D})})$ exists too and there is a pushout square
		\[\xymatrix{H\ar[r]^-{\iota_{2, H}} \ar@{>->}[d]_-{\iota_{1, H}} & \tproi{D}{2} \ar[d]^{p_2}\\  \tproi{D}{1} \ar[r]_{p_1}& \tpro{D}}\]
		where $(\tproi{D}{1}, \{\iota_{1, X}\}_{X\in \Delta(\der{D}_1)})$ and $(\tproi{D}{2}, \{\iota_{2, X}\}_{X\in \Delta(\der{D}_2)})$ are the colimiting cocone for $\Delta(\der{D}_1)$ and $\Delta(\der{D}_2)$, respectively.
	\end{enumerate}
\end{lemma}
\begin{remark}\label{rem:cof}
Let $I:\Deltamin(\dder{D})\to \Delta(\dder{D})$ be the inclusion functor. It is immediate to see that such functor is \emph{final} \cite{mac2013categories}. This means that for every functor $F\colon \Delta(\dder{D})\to \Y$ we have:
\begin{enumerate}
	\item if  $(C, \{c_X\}_{X\in \Deltamin(\dder{D})})$ is colimiting for $F\circ I$, then there exists a colimiting cocone $(D, \{d_X\}_{X\in \Delta(\dder{D})})$ for $F$;
	\item $(C, \{c_X\}_{X\in \Deltamin(\dder{D})})$ and $(D, \{d_X\}_{X\in \Delta(\dder{D})})$ are colimiting for, repsectively, $F\circ I$ and $F$, then the canonical arrow $\phi\colon C\to D$ induced by $(D, \{d_X\}_{X\in \Deltamin(\dder{D})})$ is an isomorphism.
\end{enumerate}
\end{remark}

\begin{proof}\begin{enumerate}
		\item Let us proceed by induction on the length of $\der{D}$.

	
	\smallskip \noindent $\lgh(\dder{D})=0$. then the $\tpro{\dder{D}}$ is simply $(G, \{\id{G}\})$ and $\id{G}\in \mathcal{M}$.
	
	\smallskip \noindent$\lgh(\dder{D})=1$. Suppose that $\dder{D}$ has as its single component the derivation
			\[\xymatrix{L \ar[d]_{m}& K \ar[d]^{k}\ar@{>->}[l]_{l} \ar[r]^{r} & R \ar[d]^{h} \\G& \ar@{>->}[l]^{f} D \ar[r]_{g}& H  \\}\]
			The arrow $f$ is  the pushout of $l$ and so it is in in $\mathcal{M}$. We can thus consider the following $\mathcal{M}$-pushout square.
			\[\xymatrix{D \ar@{>->}[d]_{f} \ar[r]^{g} & H \ar@{>->}[d]^{p} \\G \ar[r]_{q}& P }\]
			Since $p\in \mathcal{M}$, the thesis follows immediately from \Cref{rem:cof}. 
	
	\smallskip \noindent$\lgh(\dder{D})\geq 2$. Let $\der{D}$ be $\{\dder{D}_i\}_{i=0}^n$ with $n\geq 1$. Let also $\der{D}'$ be $\{\dder{D}_i\}^{n-1}_{i=0}$ and $\rho_n=(l_n, r_n)$ be the rule applied in $\dder{D}_n$. The arrow $f_n\colon D_n\to G_n$, being a pushout of $l_n$ is an element $\mathcal{M}$. By inductive hypothesis, $\iota_{G_{n}}\colon G_{n}\to \lpro \der{D}'\rpro$ is in $\mathcal{M}$ too, thus, we can consider the diagram below, having a pushout as its lower half.
			\[\xymatrix{L_n \ar[d]_{m_{n}}& K_{n} \ar[d]^{k_{n}}\ar@{>->}[l]_{l_{n}} \ar[r]^{r_{n}} & R_{n} \ar[d]^{h_n} \\G_{n} \ar@{>->}[d]_{\iota'_{G_{n}}}& \ar@{>->}[l]^{f_n} D_n \ar[r]_{g_n}& H  \ar@{>->}[d]^{q}\\ \lpro \der{D}' \ar[rr]_{p}\rpro && P}\] 
			Notice that, as in the point above, the arrow $q\colon H\to P$ is the pushout of an element in $\mathcal{M}$, therefore it is enough to show that the diagram so constructed provides a colimiting cocone for $\Delta(\der{D})$.
			
			Let $(C, \{c_X\}_{X\in \Delta(\der{D})})$ be a cocone, since $\Delta(\der{D}')$ is a subdiagram of $\Delta(\der{D})$, we get another cocone $(C, \{c_X\}_{X\in \Delta(\der{D}')})$ which induces an arrow $c'\colon \lpro \der{D}' \rpro \to C$ such that
			\begin{align*}
				c'\circ \iota_{G_n} \circ f_n &=c_{G_n} \circ f_n\\&= c_{D_n}\\&= c_{H}\circ g_n
			\end{align*}
			Therefore the arrows $c'$ and $c_H$ induce a morphism $c\colon P\to C$ and the thesis now follows at once.
		
		\item  As a first step, notice that $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D}_1)})$ and $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D}_2)})$ are cocone on, respectively, $\Delta(\der{D}_1)$ and $\Delta(\der{D}_2)$. Hence, there exist two arrows $p_1\colon \tproi{D}{1}\to \tpro{D}$, $p_2\colon \tproi{D}{2}\to \tpro{D}$ such that, for every $X\in  \Delta(\der{D}_1)$ and $Y\in  \Delta(\der{D}_2)$
		\[p_1\circ \iota_{1, X} = \iota_X \qquad p_2\circ \iota_{2, Y}=\iota_{2,Y}\]
		In particular, this entails the commutativity of the square
				\[\xymatrix{H \ar[dr]^{\iota_H} \ar[r]^-{\iota_{2, H}} \ar@{>->}[d]_-{\iota_{1, H}} & \tproi{D}{2} \ar[d]^{p_2}\\  \tproi{D}{1} \ar[r]_{p_1}& \tpro{D}}\]
		
	Let us now show that the square above is a pushout. Take two arrows $a\colon \tproi{D}{1}\to C$, $b\colon \tproi{D}{2}\to C$ such that $a\circ \iota_{1, H}=b\circ \iota_{2, H}$. We can use the previous equality to define a cocone $(C, \{c_X\}_{X\in \Delta(\der{D})})$ putting:
	\[c_X:=\begin{cases}
		a\circ \iota_{1, X} & X\in \Delta(\der{D}_1)\\
		b\circ \iota_{2, X} & X\in \Delta(\der{D}_2)
	\end{cases}\]
From this, we can deduce at once the existence of a unique $c\colon \tpro{D}\to C$ such that $c\circ \iota_X = c_X$. By construction, for every $X\in  \Delta(\der{D}_1)$ and $Y\in  \Delta(\der{D}_2)$ we have
\[\begin{split}
	c\circ p_1 \circ \iota_{1,X}&=c\circ \iota_{X}\\&=c_X \\&=a\circ \iota_{1,X}\\&=a\circ p_1\circ \iota_{1,X}
\end{split}\qquad \begin{split}
	c\circ p_2 \circ \iota_{2,Y}&=c\circ \iota_{Y}\\&=c_Y \\&=b\circ \iota_{2,Y}\\&=b\circ p_2\circ \iota_{2,Y}
\end{split}\]
Therefore we get that $c\circ p_1=a$ and $c\circ p_2 = b$.

	For uniqueness, suppose that $c'\colon \tpro{D}\to C$ is such that $c'\circ p_1=a$ and  $c'\circ p_2 = b$. Then, for every $X\in \Delta(\der{D})$ we have
\begin{align*}
	c'\circ \iota_X &= \begin{cases}
	c'\circ p_1\circ \iota_{1, X} & X\in \Delta(\der{D}_1)\\
	c'\circ p_2\circ \iota_{2, X} & X\in \Delta(\der{D}_2)
	\end{cases}\\&=\begin{cases}
a\circ \iota_{1, X} & X\in \Delta(\der{D}_1)\\
b\circ \iota_{2, X} & X\in \Delta(\der{D}_2)
	\end{cases}\\&=c_X\\&=c\circ \iota_X
\end{align*}
showing that $c'=c$ as wanted.	 \qedhere 
	\end{enumerate}
\end{proof}

\begin{corollary}\label{cor:colim}
Let $\der{D}=\{\dder{D}_i\}_{i=0}^n$ a derivation of length $n+1$ and fix an index $j\in[0,n]$. Define
\[\der{D}^j_1:=\{\dder{D}_i\}_{i=0}^{j-1} \qquad  \der{D}^j_2=\{\dder{D}_j\} \qquad \der{D}^j_3:=\{\dder{D}_i\}_{i=j+1}^n\]
with the convention that $\der{D}^0_1$ and $\der{D}^n_3$ are the empty derivation on, respectively, $G_0$ and $G_n$. Then the square below is a pushout and a pullback
\[\xymatrix@C=30pt{D_{j} \ar[ddrr]^{\iota_{D_j}} \ar[r]^{g_j}\ar@{>->}[d]_{f_j}& G_{j+1} \ar[ddr]^{\iota_{G_{j+1}}} \ar[r]^-{\iota_{3, G_{j+1}}} & \lpro \der{D}^j_3\rpro \ar[dd]^{p_2} \\ G_j\ar[drr]_{\iota_{G_{j}}} \ar@{>->}[d]_{\iota_{1,G_j}}\\ \lpro \der{D}^j_1 \rpro \ar[rr]_{p_1}  &&\tpro{D} }\] 
Where the two arrows $p_1\colon \lpro\der{D}^j_1 \rpro\to \tpro{D}$, $p_2\colon \lpro \der{D}^j_3\rpro \to \tpro{D}$ are induced by the cocones $(\tpro{D}, \{\iota_{X}\}_{X\in \Delta(\der{D}^j_1)})$ and $(\tpro{D}, \{\iota_{X}\}_{X\in \Delta(\der{D}^j_3)})$, respectively.
\end{corollary}
\begin{remark}
If $\der{D}$ is empty then $\der{D}^j_1, \der{D}^j_2$ and $\der{D}^j_3$ are empty too.
\end{remark}
\begin{proof}
We can notice that $\der{D}=\der{D}^j_1\cdot \der{D}^j_2 \cdot \der{D}^j_3$. By the first and the second point of \Cref{lem:colim} then we get the following diagram, in which all squares are $\mathcal{M}$-pushouts.

\[\xymatrix@C=30pt{D_{j}  \ar[r]^{g_j}\ar@{>->}[d]_{f_j}& G_{j+1}  \ar[r]^-{\iota_{3,G_{j+1}}} \ar[d]_{\iota_{2, G_{j+1}}}  \ar@/^.5cm/[dd]^{\iota_{1,2, G_{j+1}}}& \lpro \der{D}^j_3\rpro \ar[dd]^{p_2} \\ G_j \ar[r]^{\iota_{2, G_j}}\ar@{>->}[d]_{\iota_{1,G_j}} & \lpro \der{D}^j_2\rpro \ar[d]_a\\ \lpro \der{D}^j_1 \rpro \ar@/_.4cm/[rr]_{p_1} \ar[r]^b &\lpro \der{D}^j_1\cdot \der{D}^j_2 \rpro \ar[r]^c&\tpro{D} }\] 
Applying \Cref{lem:po1} twice we get that the whole square is an $\mathcal{M}$-pushout. Then the thesis follows from \Cref{prop:pbpoad}.
\end{proof}

\begin{remark}\label{rem:zero1} In particular, considering $j=0$ or $j=n$, we get that the following two squares are $\mathcal{M}$-pushouts and, thus, pullbacks.
	\[\xymatrix{D_0 \ar[r]^-{\iota_{3, D_0}} \ar@{>->}[d]_{f_0}& \lpro \der{D}^0_3 \rpro \ar@{>->}[d]^{p_2} &D_n \ar@{>->}[d]_{\iota_{1, D_n}}\ar[r]^{g_n}& G_n \ar@{>->}[d]^{\iota_{G_n}}\\ G \ar[r]_{\iota_G}& \tpro{D} & \lpro \der{D}^n_1 \rpro \ar[r]_{p_1}  & \tpro{D}}\]
\end{remark}

\begin{corollary}\label{cor:ele}
	Let $\der{D}=\{\dder{D}_{i}\}_{i=0}^n$ be a derivation between $G$ and $H$. Let $j$ and $k$ be two indexes less or equal than $n+1$ and suppose that $j< k$.  Consider two arrows $a\colon T\to G_j$, $b\colon T\to G_k$. If $\iota_{G_j}\circ a = \iota_{G_k}\circ b$, 
	then  there exist a unique arrow $c\colon T\to D_j $  such that \[f_j\circ c = a\qquad \iota_{D_j}\circ c =\iota_{G_k}\circ b\]
	\end{corollary}
\begin{proof} Consider the diagram
			\[\xymatrix@C=34pt{T  \ar@/_.6cm/[dd]_{a}\ar@{.>}[d]^{c}\ar[rr]^{b}&& G_k \ar[d]_{\iota_{3, G_k}} \ar@/^.6cm/[ddd]^{\iota_{G_k}}\\D_{j} \ar[r]^{g_j} \ar[ddrr]^{\iota_{D_j}}\ar@{>->}[d]^{f_j}& G_{j+1} \ar[r]^-{\iota_{3,G_{j+1}}} \ar[ddr]^{\iota_{G_{j+1}}} & \lpro \der{D}^j_3\rpro \ar[dd]_(.6){p_2} \\ G_j \ar@{>->}[d]_{\iota_{1,G_j}} \ar[drr]_{\iota_{G_j}}\\ \lpro \der{D}^j_1 \rpro \ar[rr]_{p_1}  &&\tpro{D} }\] 
			Thanks to \Cref{cor:colim} we know that the bottom right rectangle in the diagram above is a pullback and the thesis follows at once.
\end{proof}	

\section{Semi-consistent and consistent permutations}
	
Equipped with the theory developed so far, we can introduce the notions of \emph{semi-consistent} and \emph{consistent} permutation.

\begin{definition}[(Semi)-consistent permutation]\label{def:permcon}
	Let $\X$ be an $\mathcal{M}$-adhesive category and consider a left-linear DPO-rewriting system $(\X, \R)$ on it.  Consider two decorated derivations $(\der{D}, \alpha, \omega)$ and  $(\der{D}', \alpha', \omega')$ with the same length $l$ and with isomorphic sources and targets. Let also $r(\der{D})=\{\rho_i\}_{i=0}^{l-1}$ and $r(\der{D}')=\{\rho'_i\}_{i=0}^{l-1}$	be sequences of rules associated to the two derivations.
	
	A \emph{semi-consistent permutation} between  $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ is a permutation $\sigma\colon [0,l-1]\to [0,l-1]$  such that, for every $i\in [0,l-1]$, $\rho_i=\rho'_{\sigma(i)}$ and, moreover, there exists a \emph{mediating isomorphism} $\xi_\sigma\colon \tpro{D} \to \lpro \der{D}' \rpro$ fitting in the following diagrams, where $m_i, m'_i, h_i$ and $h'_i$ are, respectively, the matches and back-matches of $\dder{D}_i$ and $\dder{D}'_i$.
	\[\xymatrix@C=30pt{\pi(G_0)\ar[r]^{\alpha} \ar[d]_{\alpha'} & G_0 \ar[r]^{\iota_{G_0}} &\tpro{D} \ar[d]^{\xi_\sigma}\\ G'_0 \ar[rr]_{\iota'_{G'_0}} & &\lpro \der{D}' \rpro}\]
	\[\xymatrix@C=30pt{L_i \ar[r]^{m_i} \ar[d]_{m'_{\sigma(i)}}& G_i \ar[r]^{\iota_{G_i}} &\tpro{D} \ar[d]^{\xi_\sigma} & R_i \ar[r]^{h_i} \ar[d]_{h'_{\sigma(i)}}& G_{i+1} \ar[r]^{\iota_{G_{i+1}}} &\tpro{D} \ar[d]^{\xi_\sigma} \\G'_{\sigma(i)} \ar[rr]_{\iota'_{G'_{\sigma(i)}}}&& \lpro \der{D}' \rpro& G'_{\sigma(i)+1} \ar[rr]_{\iota'_{G'_{\sigma(i)+1}}}&& \lpro \der{D}' \rpro}\]
	
	A semi-consistent permutation is \emph{consistent} if the following square commutes too.
	\[\xymatrix@C=30pt{ \pi(G_{l}) \ar[r]^{\omega} \ar[d]_{\omega'} & G_{l} \ar@{>->}[r]^{\iota_{G_{l}}} &\tpro{D} \ar[d]^{\xi_\sigma} \\  G'_{l} \ar@{>->}[rr]_{\iota'_{G'_{l}}} & &\lpro \der{D}' \rpro}\]
\end{definition}

\begin{remark}\label{rem:inversa}
	Let  $(\der{D},\alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ be two decorated derivations and $\sigma\colon [0,n]\to [0,n]$ be a consistent permutation between them.  Then its inverse $\sigma^{-1}$ is a consistent permutation between $(\der{D}', \alpha', \omega')$ and $(\der{D},\alpha, \omega)$. Indeed, it is enough to consider, as mediating isomorphism, the inverse $\xi^{-1}_\sigma$ of $\xi_\sigma$.
\end{remark}

\begin{example}\label{rem:empty2}
	Let $(\{G\}, \alpha, \omega)$ and $(\{G'\}, \alpha', \omega')$ be two derivations of length $0$. Then $\id{\emptyset}$ is a consistent permutations between them if and only if there exists an isomorphism $\phi\colon G_0\to G'_0$ fitting in the diagrams below
	\[\xymatrix@C=15pt{&\pi(G) \ar[dr]^{\alpha'} \ar[dl]_{\alpha}&&& \pi(G) \ar[dr]^{\omega'} \ar[dl]_{\omega}\\ G\ar[rr]_{\phi} && G' &G \ar[rr]_{\phi} && G' } \]
	That is, by \Cref{rem:empty} if and only if they are abstract equivalent decorated derivations.
\end{example}

\begin{remark} \label{rem:coproj} Notice that if $\sigma$ is a semi-consistent permutation between two derivations  $\der{D}$ and $\der{D}'$ of length $l$, then for every  $i\in [0,l-1]$ the diagram below commutes.
	\[\xymatrix@C=40pt{G_i\ar@/^1cm/[rrr]^{\iota_{G_{i}}}&D_i\ar@/^.4cm/[rr]^(.35){\iota_{D_i}} \ar[r]_{g_i} \ar@{>->}[l]^{f_i}&G_{i+1} \ar[r]_{\iota_{G_{i+1}}}&\tpro{D} \ar[dd]^{\xi_\sigma}\\  L_i \ar[u]^{n_i} \ar[d]_{n'_{\sigma(i)}}& K_i \ar[d]^{k'_{\sigma(i)}} \ar[u]_{k_i} \ar[r]^{r_i} \ar@{>->}[l]_{l_i} &R\ar[u]^{h_i} \ar[d]_{h'_{\sigma(i)}}\\G'_{\sigma(i)}\ar@/_1cm/[rrr]_{\iota'_{G'_{\sigma(i)}}} &D'_{\sigma(i)}\ar@{>->}[l]_{f'_{\sigma(i)}} \ar[r]^{g'_i} \ar@/_.4cm/[rr]_(.35){\iota'_{D'_{\sigma(i)}}}&G'_{\sigma(i)+1} \ar[r]^{\iota'_{G'_{\sigma(i)+1}}}& \lpro\der{D}' \rpro }\]
	
	This follows at once from the following chain of identities:
	\begin{align*}
		\xi_\sigma \circ \iota_{D_i}\circ k_i&=\xi_\sigma \circ \iota_{G_{i}} \circ f_i\\&= \xi_\sigma \circ \iota_{G_{i}}\circ m_i \circ l_i\\&=\iota_{G'_{\sigma(i)}}\circ m'_i\circ l_i\\&=\iota_{G'_{\sigma(i)}}\circ f'_{\sigma(i)}\circ k'_i\\&=\iota_{D'_\sigma(i)}\circ k_i'
	\end{align*}
	
	In particular, the previous diagram entails the following identities.
	\[\xi_\sigma \circ \iota_{L_i}=\iota'_{L_{\sigma(i)}} \quad \xi_\sigma \circ \iota_{K_i}=\iota'_{K_{\sigma(i)}} \quad \xi_\sigma \circ \iota_{R_i}=\iota'_{R_{\sigma(i)}} \]
\end{remark}

The previous remark allows us to prove the following.

\begin{lemma}\label{prop:isouno} For every semi-consistent permutation $\sigma$ between  $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$, the mediating isomorphism $\xi_\sigma\colon \tpro{D}\to \lpro \der{D}'\rpro$ is unique.
\end{lemma}
\begin{proof} Let $\xi'_\sigma$ be another mediating isomorphism, then by \Cref{rem:coproj} we have
	\[\begin{split}
		\xi_\sigma \circ \iota_{L_i}&=\iota'_{L_{\sigma(i)}}\\&=\xi'_\sigma\circ \iota_{L_i}
	\end{split} \qquad \begin{split}
		\xi_\sigma \circ \iota_{K_i}&=\iota'_{K_{\sigma(i)}}\\&=\xi'_\sigma\circ \iota_{K_i}
	\end{split} \qquad \begin{split}
		\xi_\sigma \circ \iota_{R_i}&=\iota'_{R_{\sigma(i)}}\\&=\xi'_\sigma\circ \iota_{R_i}
	\end{split}\]
	
	Now, notice that 
	\begin{align*}
		\xi_\sigma \circ \iota_{G_0}&=\iota'_{G'_0}\circ \alpha'\circ \alpha^{-1}\\&=\xi'_\sigma \circ \iota_{G_0}
	\end{align*}
	
	If $\lgh(\der{D})=0$ this is enough to conclude, otherwise we are going to prove by induction that, for every $i\in [0, \lgh(\der{D})-1]$, $\xi_\sigma \circ \iota_{G_i}=\xi'_\sigma\circ \iota_{G_i}$.
	
	\smallskip \noindent $i=0$. This is simply the result obtained before.
	
	\smallskip \noindent $i >0$. If $i>0$, we know that there is a pushout square
	\[\xymatrix{K_{i-1}\ar[r]^{r_{i-1}} \ar[d]_{k_{i-1}}& R_{i-1} \ar[d]^{h_{i-1}}\\ D_{i-1} \ar[r]_{g_{i-1}}& G_i}\] 
	By \Cref{rem:coproj} and the induction hypothesis we know that
	\[\begin{split}
		\xi_\sigma \circ \iota_{G_i}\circ h_{i-1}&=  \xi_\sigma\circ \iota_{R_{i-1}}\\&=\iota'_{R_{\sigma(i-1)}}\\&=\xi'_{\sigma}\circ \iota_{R_{i-1}}\\&=\xi'_{\sigma} \circ \iota_{G_i}\circ h_{i-1}\\&
	\end{split} \qquad
	\begin{split}
		\xi_\sigma \circ \iota_{G_i}\circ g_{i-1}&=\xi_{\sigma}\circ \iota_{D_{i-1}}\\&=\xi_{\sigma}\circ \iota_{G_{i-1}} \circ f_{i-1}\\&=\xi'_{\sigma}\circ \iota_{G_{i-1}} \circ f_{i-1}\\&=\xi'_{\sigma}\circ \iota_{D_{i-1}} \\&=\xi'_{\sigma}\circ \iota_{G_{i}} \circ g_{i-1}
	\end{split}
	\]
	
	Since $\xi_\sigma \circ \iota_{D_i}$ must be $\xi_\sigma \circ \iota_{G_i}\circ f_i$, we also have
	$\xi_\sigma \circ \iota_{D_i}=\xi'_\sigma \circ \iota_{D_i}$
	and the thesis follows.
\end{proof}


As a next step, we will show that the existence of abstraction equivalences satisfying certain coherence conditions is enough to guarantee the (semi-)consistency of the identical permutation.

\begin{proposition}\label{rem:abscons}
	Let $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ be two decorated derivations in an left-linear rewriting system $(\X, \R)$ of length $l$. Let also $\{\phi_X\}_{X\in \Deltamin(\der{D})}$ be an abstraction equivalence between $\der{D}$ and $\der{D}'$. If $\alpha'\circ \phi_{G_0}=\alpha$ then the the identity $\id{[0,l-1]}$ is a semi-consistent permutation. If, moreover, $\omega'\circ \phi_{G_{l}}=\omega$, then $\id{[0,l-1]}$ is a consistent one.
\end{proposition}
\begin{proof}
	For every $X\in \Deltamin(\der{D}) $, let $X'$ the codomain of $\phi_X$. Then we can define $\xi_{\id{[0,l-1]}}\colon \tpro{D}\to \lpro \der{D}'\rpro$ as the unique morphism such that, for every $X\in \Deltamin(\der{D})$, 
	\[\xi_{\id{[0,l-1]}} \circ \iota_{X}= \iota'_{X'}\circ \phi_X\]

As a first step we can notice that $\xi_{\id{[0,l-1]}}$ is an isomorphism: indeed we can define $\Theta\colon \lpro\der{D}'\rpro \to \tpro{D}$ as the unique arrow satisfying, for every $X'\in \Deltamin(\der{D}')$
\[\Theta \circ \iota'_{X'}= \iota_{X}\circ \phi^{-1}_X\]

From the following two computations we can derive that $\Theta$ is the inverse of $\xi_{\id{[0,l-1]}}$.
\[\begin{split}
	\Theta \circ \xi_{\id{[0,l-1]}}\circ \iota_{X}&=\Theta \circ\iota'_{X'}\circ \phi_X\\&=\iota_{X}\circ \phi^{-1}_X\circ \phi_X\\&=\iota_X 
\end{split}\qquad \begin{split}
\xi_{\id{[0,l-1]}}\circ \Theta \circ \iota'_{X'}&=\xi_{\id{[0,l-1]}}\circ \iota_X\circ \phi^{-1}_{X}\\&=\iota'_{X'}\circ \phi_X\circ \phi^{-1}_{X}\\&=\iota'_{X'}
\end{split}\]

To conclude, let us observe that all the internal subdiagrams of the following diagrams commutes, guaranteeing the commutativity of the full ones.
\[\xymatrix@C=30pt{\pi(G_0)\ar[r]^{\alpha} \ar[d]_{\alpha'} & G_0 \ar[dl]^{\phi_{G_0}} \ar[r]^{\iota_{G_0}} &\tpro{D} \ar[d]^{\xi_{\id{[0, l-1]}}}\\ G'_0 \ar[rr]_{\iota'_{G'_0}} & &\lpro \der{D}' \rpro}\]
\[\xymatrix@C=30pt{L_i \ar[r]^{m_i} \ar[d]_{m'_{\sigma(i)}}& G_i \ar[dl]^{\phi_{G_i}} \ar[r]^{\iota_{G_i}} &\tpro{D} \ar[d]^{\xi_{\id{[0, l-1]}}} & R_i \ar[r]^{h_i} \ar[d]_{h'_{i}}& G_{i+1} \ar[dl]^{\phi_{G_{i+1}}}\ar[r]^{\iota_{G_{i+1}}} &\tpro{D} \ar[d]^{\xi_{\id{[0, l-1]}}} \\G'_{i} \ar[rr]_{\iota'_{G'_{i}}}&& \lpro \der{D}' \rpro& G'_{i+1} \ar[rr]_{\iota'_{G'_{i+1}}}&& \lpro \der{D}' \rpro}\]

For the last half of the thesis, we can reason similarly. Indeed, the diagram below commutes.
\[\xymatrix@C=30pt{\pi(G_l)\ar[r]^{\omega} \ar[d]_{\omega'} & G_l \ar[dl]^{\phi_{G_l}} \ar@{>->}[r]^{\iota_{G_l}} &\tpro{D} \ar[d]^{\xi_{\id{[0, l-1]}}}\\ G'_l \ar@{>->}[rr]_{\iota'_{G'_l}} & &\lpro \der{D}' \rpro}\]
This clearly entails the thesis.
\end{proof}

The previous proposition, in turn, gives us a technical but quite useful result.

\begin{corollary}\label{cor:fromsemitocons}
			Let $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ be two decorated derivations in an left-linear rewriting system $(\X, \R)$ of length $l$. Let also $\{\phi_X\}_{X\in \Deltamin(\der{D})}$ be an abstraction equivalence between $\der{D}$ and $\der{D}'$ such that  $\alpha'\circ \phi_{G_0}=\alpha$. If  the identity $\id{[0,l-1]}$ is a consistent permutation, then $\omega'\circ \phi_{G_l}=\omega$, so that $(\der{D}, \alpha, \omega) \equiv^a (\der{D}', \alpha', \omega')$.
\end{corollary}
\begin{proof}
	Let $\xi_{\id{[0, l-1]}}$ be the isomorphism $\tpro{D}\to \lpro\der{D}'\rpro$ witnessing the consistency of $\id{[0, l-1]}$. By \Cref{prop:isouno} and \Cref{rem:abscons}, we know that $\xi_{\id{[0,l-1]}} \circ \iota_{X}= \iota'_{X'}\circ \phi_X$ for every object $X\in \Deltamin(\der{D})$. Then we have
	\begin{align*}
		\iota'_{ G'_{l}}\circ \phi_{G_l}\circ \omega&=\xi_{\id{[0, l-1]}}\circ \iota_{G_l}\circ \omega\\&=\iota'_{G'_l}\circ \omega'
	\end{align*}
	
	By the first point of \Cref{lem:colim}, $\iota'_{ G'_{l}}$ is mono and we can conclude.
\end{proof}


\begin{remark}\label{rem:abscons2}
	In particular, given a decorated derivation $(\der{D}, \alpha, \omega)$ with source $G$ and target $H$ and two isomorphisms $\phi\colon G'\to G$, $\psi\colon H\to H'$, we know, by \Cref{rem:absequi}, that 
	\[(\der{D}, \alpha, \omega) \equiv^a (\phi * \der{D}, \phi^{-1}\circ \alpha,   \varphi^{-1}_{H} \circ \omega) \qquad (\der{D}, \alpha, \omega) \equiv^a ( \der{D}*\psi, \varphi'_{G} \circ \alpha, \psi \circ \omega )\]
	
	Now, denoting by $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D})})$, $(\lpro \phi *\der{D} \rpro, \{\iota'_X\}_{X\in \Delta(\phi *\der{D})})$ and $(\lpro \der{D}*\psi \rpro, \{\hat{\iota}_X\}_{X\in \Delta(\der{D}*\psi)})$ the colimiting cocones, in this case we have that the, unique, mediating isomorphisms witnessing the consistency of $\id{[0, \lgh(\der{D})-1]}$ are given by the arrows $\Gamma^{\phi} \colon \tpro{D}\to \lpro \phi*\der{D} \rpro$ and $\Gamma_\psi\colon \tpro{D}\to \lpro \der{D}*\psi \rpro$  such that, for every $X\in \Deltamin(\der{D})$:
	\[\Gamma^\phi \circ \iota_X:=\begin{cases}
		\iota'_{G'}\circ \phi^{-1}  & X=G\\
		\iota'_X & \text{otherwise}
	\end{cases} \qquad \Gamma_\psi \circ \iota_X:=\begin{cases}
		\hat{\iota}_{H'}\circ \psi  & X=H\\
		\hat{\iota}_X & \text{otherwise}
	\end{cases}\]
\end{remark}


\begin{example}\todo{identita consistente non implica astrazione}Notice that, in general, there cannot, in general, be generalized to non-empty derivations. A counterexample is the following one.
\end{example}



We can also observe that (semi-)consistent permutations can be composed, as shown by the next proposition.

\begin{proposition}\label{rem:comp}  Let $(\der{D}, \alpha, \omega)$, $(\der{D}', \alpha', \omega')$ and $(\der{\hat{D}}, \hat{\alpha}, \hat{\omega})$ be three decorated derivations of length $l$. Let $\sigma$ be a consistent permutation between the first two and $\tau$ one between the second and the third, then $\tau \circ \sigma$ is a semi-consistent permutations between the first and the third. If, moreover, $\sigma$ and $\tau$ are consistent, then $\tau \circ \sigma$ is consistent too.
\end{proposition} 	

\begin{proof} Let $l$ be the length of the three given derivations.  By hypothesis each subdiagram of the following ones commutes, thus the whole diagrams commute too, proving that $\tau\circ \sigma$ is a semi-consistent permutation with mediating isomorphism given by $\xi_{\tau} \circ \xi_\sigma$.
		\[\xymatrix@C=18pt{ & G_0 \ar[rr]^{\iota_{G_0}} &&\tpro{D} \ar[d]^{\xi_\sigma} \\ \pi(G_0) \ar@/_.2cm/[dr]_{\hat{\alpha}}\ar@/^.2cm/[ur]^{\alpha} \ar[r]^{\alpha'} &G'_0 \ar[rr]^{\iota'_{G'_0}}  &&\lpro \der{D}'  \rpro \ar[d]^{\xi_{\tau}}\\ &\hat{G}_0  \ar[rr]_{\hat{\iota}_{\hat{G}_0}}&& \lpro \hat{\der{D}}\rpro }\]  
		\[\xymatrix@C=18pt{& G_i \ar[rr]^{\iota_{G_i}} &&\tpro{D} \ar[d]^{\xi_\sigma}&  &  G_{i+1} \ar[rr]^{\iota_{G_{i+1}}} &&\tpro{D} \ar[d]^{\xi_\sigma} \\ L_i \ar@/_.2cm/[dr]_{\hat{m}_{\tau(\sigma(i))}}\ar@/^.2cm/[ur]^{m_i} \ar[r]^{m'_{\sigma(i)}} &G'_{\sigma(i)} \ar[rr]^{\iota'_{G'_{\sigma(i)}}}  &&\lpro \der{D}'  \rpro \ar[d]^{\xi_{\tau}}&R_i \ar@/_.2cm/[dr]_{\hat{h}_{\tau(\sigma(i))}}\ar@/^.2cm/[ur]^{h_i} \ar[r]^{h'_{\sigma(i)}} & G'_{\sigma(i)+1} \ar[rr]^{\iota'_{G'_{\sigma(i)+1}}} && \lpro \der{D}' \rpro \ar[d]^{\xi_{\tau}}\\ &\hat{G}_{\tau(\sigma(i))}  \ar[rr]_-{\hat{\iota}_{\hat{G}_{\tau(\sigma(i))}}}&& \lpro \hat{\der{D}}\rpro  && \hat{G}_{\tau(\sigma(i))+1} \ar[rr]_-{\hat{\iota}_{\hat{G}_{\tau(\sigma(i))+1}}}&& \lpro \hat{\der{D}} \rpro	}\]
	
	If, in addition, $\sigma$ and $\tau$ are consistent then we also have the commutativity of the following additional diagram.
	\[\xymatrix@C=18pt{&   G_{l} \ar@{>->}[rr]^{\iota_{ G_{l}}} &&\tpro{D} \ar[d]^{\xi_\sigma}\\ \pi({ G_{l}})\ar@/_.2cm/[dr]_{\hat{\omega}}\ar@/^.2cm/[ur]^{\omega} \ar[r]^{\omega'} & { G'_{l}} \ar@{>->}[rr]^{\iota'_{{ G'_{l}}}} && \lpro \der{D}' \rpro \ar[d]^{\xi_{\tau}}\\& \hat{G}_l \ar@{>->}[rr]_{\hat{\iota}_{\hat{G}_l}}&& \lpro \hat{\der{D}} \rpro}\]
	
	Again this proves that $\xi_\tau \circ \xi_\sigma$ witnesses the constistency of $\tau\circ \sigma$.
\end{proof}
	

\section{Composing and decomposing consistent permutations}
Now that we have established some initial facts about consistent permutations, we are going to embark in a, quite long, voyage to explore how to restrict them to suitable subderivations. 


\begin{lemma}\label{rem:dett}
	Let $(\der{D}, \alpha, \omega)$ be the composite $(\der{D}_1, \alpha_1, \omega_1)\cdot (\der{D}_2, \alpha_2, \omega_2)$ of two derivation of length $l_1$ and $l_2$. Suppose that:
\[r(\der{D}_1)=\{\rho_{1,i}\}_{i=0}^{l_1-1} \quad r(\der{D}_2)=\{\rho_{2,i}\}_{i=0}^{l_2-1} \quad  r(\der{D})=\{\rho_{i}\}_{i=0}^{l_1+l_2-1}\]
and let  $G_{1,0}, G_{2,0}$ and $G_{0}$ be the sources of $\der{D}_1$, $\der{D}_2$,  and $\der{D}$. Similary, denote, by $G_{1,i+1}, G_{2,i+1}$ and $G_{i+1}$ the results of the application of, respectively, $\rho_{1,i}, \rho_{2,i}, \rho_i$ to $G_{1,i}, G_{2,i}$ and $G_{i}$  in the corresponding derivation. Then there are arrows $q_1\colon \lpro \der{D}_1\rpro \to \tpro{D}$, $q_2\colon \lpro \der{D}_2\rpro \to \tpro{D}$ such that
\[q_1\circ \iota_{G_{1,0}}\circ \alpha_1 = \iota_{G_{0}}\circ \alpha \qquad q_2\circ \iota_{G_{2,l_2}}\circ \omega_2 = \iota_{G_{l_1+l_2}}\circ \omega \]
and, for every $i\in [0, l_1-1]$, $j\in [l_1+1, l_1+l_2]$
	\[q_1\circ \iota_{1, G_{1,i}}=\iota_{G_{i}}\qquad q_2\circ \iota_{2, G_{2,j}}=\iota_{G_{j+l_1}} \]
\end{lemma}
\begin{proof}According to \Cref{def:conc}, we have three cases.
\begin{itemize}
	\item $\lgh(\der{D}_1)=0$. Then  $(\der{D}, \alpha, \omega)$ is $(\der{D}_2, \alpha_2\circ \omega_1^{-1}\circ \alpha_1, \omega_2)$ thus we can take as $q_2$ the identity on $\lpro \der{D}_2\rpro$. Moreover, in this case $\iota_{1,G_{1,0}}$ is an isomorphism, so that we can take as $q_1$ the composition $\iota_{G_0}\circ \alpha_2\circ \omega^{-1}_1 \circ \iota^{-1}_{1,G_{1,0}}$.
	\item $\lgh(\der{D}_1)\neq 0$ and $\lgh(\der{D}_2)=0$ . Hence  $(\der{D}, \alpha, \omega)$ is $(\der{D}_1, \alpha_1, \omega_1 \circ \alpha^{-1}_2\circ \omega_2)$. We can then define $q_1$ as $\id{\lpro \der{D}_1\rpro}$.  Since $\iota_{2,G_{2,0}}$ is an isomorphism, $q_2$ can be taken as  $\iota_{G_{l_1+l_2}}\circ  \omega_1  \circ \alpha^{-1}_2 \circ \iota^{-1}_{2,G_{2,0}}$.
	\item  $\lgh(\der{D}_1)\neq 0$ and $\lgh(\der{D}_2)\neq 0$. In this case we have that $(\der{D}, \alpha, \omega)$  is $(\der{D}_1*\omega_1^{-1}\cdot \alpha_2*\der{D}_2, \alpha_1, \omega_2)$. By second point of \Cref{lem:colim} and by \Cref{rem:abscons2} we can build the following diagram.
	\[\xymatrix@C=40pt{&&G_{2,0}  \ar@/_.3cm/[dl]_{\alpha^{-1}_2} \ar@/^.3cm/[dr]^{\iota_{2, G_{2,0}}}\\&\pi(G_{2,0}) \ar[dr]^{\iota_{G_{l_1}}}\ar[r]^-{\iota'_{2, \pi(G_{2,0})}} \ar@{>->}[d]_-{\iota'_{1, \pi(G_{1,l_1})}} & \lpro \alpha_2*\der{D}_2 \rpro \ar@{>->}[d]^{p_2} &\tproi{D}{2} \ar[l]_-{\Gamma^{\alpha_2}} \ar@{>.>}@/^.2cm/[dl]^{q_2}\\ G_{1,l_1}  \ar@/^.3cm/[ur]^{\omega^{-1}_1}  \ar@{>->}@/_.3cm/[dr]_{\iota_{1, G_{1, l_1}}}& \lpro \der{D}_1*\omega_1^{-1} \rpro  \ar[r]_{p_1}& \tpro{D} \\ &\tproi{D}{1} \ar[u]^{\Gamma_{\omega^{-1}_1}}  \ar@{.>}@/_.2cm/[ur]_{q_1}}\]

	Let us define $q_1$ as $p_1\circ \Gamma_{\omega^{-1}_1}$ and $q_2$ as $p_2\circ \Gamma^{\alpha_2}$. Then, for every $i\in [0,l_1-1]$ and $j\in [l_1+1, l_1+l_2]$
	\[\begin{split}
		q_1\circ \iota_{1, G_{1,i}}&=p_1\circ \Gamma_{\omega^{-1}_1}\circ \iota_{1, G_{1,i}}\\&=p_1\circ \iota'_{1, G_{1,i}} \\&=\iota_{G_{i}}
	\end{split} \qquad \begin{split}
		q_2\circ \iota_{2, G_{2,j}}&=p_2\circ \Gamma^{\alpha_2}\circ \iota_{2, G_{2,j}}\\&=p_2\circ \iota'_{2, G_{2,j}} \\&=\iota_{G_{j+l_1}}
	\end{split}\]
	Moreover, we also have:
	\[
	\begin{split}
		q_1\circ \iota_{G_{1,0}}\circ \alpha_1&= p_1\circ \Gamma_{\omega^{-1}_1}\circ \iota_{G_{1,0}}\circ \alpha_1 \\&=p_1\circ \iota'_{1, G_{1,0}} \circ \alpha_1 \\&= \iota_{G_{0}}\circ \alpha
	\end{split}\qquad 
	\begin{split}
	q_2\circ \iota_{G_{2,l_2}}\circ \omega_2&= p_2\circ \Gamma^{\alpha_2}\circ \iota_{G_{2,l_2}}\circ \omega_2 \\&=p_2\circ \iota'_{1, G_{2,l_2}} \circ \omega_2 \\&= \iota_{G_{l_1+l_2}}\circ \omega
	\end{split} \] 
	
	This concludes the proof. \qedhere
\end{itemize}	
\end{proof}
 
	
\begin{remark}\label{rem:dett2}
It is worth noticing that, for every $i\in [0,l_1-1]$ and $j\in [l_1+1, l_1+l_2]$ the previous equalities also entail that,
\[\begin{split}q_1\circ \iota_{1, D_{1,i}}&=\iota_{D_{i}}\\q_2\circ \iota_{2, D_{2,j}}&=\iota_{D_{j+l_1}} 	\\q_1\circ \iota_{1, R_{1,i-1}}&=\iota_{R_{i-1}} \\
	q_2\circ \iota_{2, R_{2,j-1}}&=\iota_{R_{j+l_1-1}}
\end{split} \qquad 
\begin{split}    	q_1\circ \iota_{1, L_{1,i}}&=\iota_{L_{i}} \\q_2\circ \iota_{2, L_{2,j}}&=\iota_{L_{j+l_1}}\\ q_1\circ \iota_{1, K_{1,i}}&=\iota_{K_{i}}\\q_2\circ \iota_{2, K_{2,j}}&=\iota_{K_{j+l_1}}\end{split}\]
\end{remark}

We can now turn our attention to the case in which a consistent permutation between two composite derivations is given. As a first step we need to prove some technicalities.

\begin{lemma}\label{prop:uniqu}
	Let $\sigma\colon [0,n]\to [0,n]$ be a consistent permutations between $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ and suppose that 
	\[(\der{D}, \alpha, \omega)=(\der{D}_1, \alpha_1, \omega_1) \cdot (\der{D}_2, \alpha_2, \omega_2) \qquad (\der{D}', \alpha', \omega')=(\der{D}'_1, \alpha'_1, \omega'_1) \cdot (\der{D}'_2, \alpha'_2, \omega'_2) \]
	
	 Let $l_1$ be the length of $\der{D}_1$, and suppose that there exists a consistent permutation $\tau:[0,l_1-1]\to [0, l_1-1]$.  If $q_1\colon \lpro \der{D}_1\rpro \to \lpro \der{D}\rpro$  and $q'_1\colon \lpro \der{D}'_1\rpro \to \lpro \der{D}'\rpro$ are the canonical arrows defined in \Cref{rem:dett}, then the following hold true:
	\begin{enumerate}
	\item  if $l_1=0$, then the following diagram commutes:
		\[\xymatrix{\lpro \der{D}_1\rpro \ar[r]^{\xi_\tau} \ar[d]_{q_1}& \lpro \der{D}'_1 \ar[d]^{q'_1}\rpro\\ \lpro \der{D}\rpro \ar[r]_{\xi_\sigma} & \lpro \der{D}'\rpro } \]
	%\[\xi_\sigma \circ q_1 \circ \iota_{1, G_{1,0}} = q'_1\circ \xi_{\tau} \circ  \iota_{1, G_{1,0}}\]
	\item if $l_1\neq 0$, so that $G_{1,0}=G_0$, then $\xi_\sigma \circ \iota_{G_0} = q'_1\circ \xi_{\tau} \circ  \iota_{1, G_{1,0}}$.
	\end{enumerate}
	
	Moreover, define the set $E_{\sigma, \tau}$ as
	\[E_{\sigma, \tau}:=\{i\in  [0, l_1-1] \mid \sigma(j)=\tau(j) \text{ for every } j \leq i \}\]
	then also the following hold true:
	\begin{enumerate}
		\setcounter{enumi}{2}
	\item  if $E_{\sigma, \tau}\neq \emptyset$,  for every index $i\in [0, \max(E_{\sigma, \tau})]$ we have 
	$\xi_\sigma \circ \iota_{G_i}=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_i}$;
	\item if $l_1-1\in E_{\sigma, \tau}$ and $l_2=0$ so that  $G_{l_1}=G_{1, l_1}$, then 
	$\xi_\sigma \circ \iota_{G_{l_1}}=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}}$;
	\item if $l_1-1\in E_{\sigma, \tau}$ and $l_2\neq 0$, so that $G_{l_1}=\pi(G_{2,0})$, then 
	$\xi_\sigma \circ \iota_{G_{l_1}}=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}}\circ \omega_1$;
	\item if $l_1-1\in E_{\sigma, \tau}$, then the following diagram commutes:
	\[\xymatrix{\lpro \der{D}_1\rpro \ar[r]^{\xi_\tau} \ar[d]_{q_1}& \lpro \der{D}'_1 \ar[d]^{q'_1}\rpro\\ \lpro \der{D}\rpro \ar[r]_{\xi_\sigma} & \lpro \der{D}'\rpro } \]
	\end{enumerate}
\end{lemma}
\begin{proof}\begin{enumerate}
		\item Recall that, in this case \[q_1=\iota_{G_0}\circ \alpha_2\circ \omega^{-1}_1 \circ \iota^{-1}_{1,G_{1,0}} \qquad q'_1=\iota'_{G'_0}\circ \alpha'_2\circ (\omega'_1)^{-1} \circ (\iota'_{1,G'_{1,0}})^{-1}\]
		
		If we compute we have
		\begin{align*}
	\xi_\sigma \circ q_1 &=\xi_\sigma \circ \iota_{G_0}\circ \alpha_2\circ \omega^{-1}_1 \circ \iota^{-1}_{1,G_{1,0}} \\&=\iota'_{G'_0}\circ \alpha'\circ \alpha^{-1}\circ \alpha_2\circ \omega^{-1}_1\circ \iota^{-1}_{1,G_{1,0}}
		\end{align*}
		Now, since $l_1=0$ we also have that 
		\[\alpha=\alpha_2\circ \omega_1^{-1}\circ \alpha_1 \qquad \alpha'=\alpha'_2\circ (\omega'_1)^{-1}\circ \alpha'_1\]
		
		Therefore, using \Cref{rem:empty}, we get:
		\begin{align*}
	\alpha'\circ \alpha^{-1}&=\alpha'_2\circ (\omega'_1)^{-1}\circ \alpha'_1\circ \alpha^{-1}_1\circ \omega_1\circ \alpha^{-1}_2\\&=\alpha'_2\circ (\omega'_1)^{-1}\circ \omega'_1\circ \omega^{-1}_1\circ \omega_1\circ \alpha^{-1}_2\\&=\alpha'_2\circ \alpha^{-1}_2
		\end{align*}
	Hence, again by \Cref{rem:empty} we obtain:
				\begin{align*}
			\xi_\sigma \circ q_1 &=\iota'_{G'_0}\circ \alpha'\circ \alpha^{-1}\circ \alpha_2\circ \omega^{-1}_1\circ \iota^{-1}_{1,G_{1,0}}\\&=\iota'_{G'_0}\circ \alpha'_2\circ \alpha^{-1}_2\circ \alpha_2\circ \omega^{-1}_1\circ \iota^{-1}_{1,G_{1,0}}\\&=\iota'_{G'_0}\circ \alpha'_2\circ \omega^{-1}_1\circ \iota^{-1}_{1,G_{1,0}}\\&=\iota'_{G'_0}\circ \alpha'_2\circ (\omega'_1)^{-1} \circ  \omega'_1\circ \omega^{-1}_1\circ \iota^{-1}_{1,G_{1,0}}\\&=\iota'_{G_0}\circ \alpha'_2\circ (\omega'_1)^{-1} \circ \alpha'_1\circ \alpha^{-1}_1\circ \iota^{-1}_{1,G_{1,0}}\\&=\iota'_{G'_0}\circ \alpha'_2\circ (\omega'_1)^{-1} \circ (\iota'_{1,G_{1,0}})^{-1}\circ \iota'_{1,G'_{1,0}}\circ \alpha'_1\circ \alpha^{-1}_1\circ \iota^{-1}_{1,G_{1,0}}\\&=q'_1\circ \iota'_{1,G'_{1,0}}\circ \alpha'_1\circ \alpha^{-1}_1\circ \iota^{-1}_{1,G_{1,0}}\\&=q'_1\circ \xi_{\tau}
		\end{align*}


		
		\item We can start noticing that
		\[\xi_\sigma \circ \iota_{G_0}=\iota'_{G'_0}\circ \alpha'\circ \alpha^{-1} \qquad \xi_{\tau} \circ \iota_{1,G_{1,0}}= \iota'_{1, G'_{1,0}} \circ \alpha'_1\circ \alpha^{-1}_1\] 
		Therefore:
		\begin{align*}
		q'_1\circ \xi_{\tau} \circ \iota_{1, G_{1,0}}&=q'_1 \circ \iota'_{1, G'_{1,0}} \circ \alpha'_1\circ \alpha^{-1}_1\\ &= \iota'_{G'_{0}}\circ \alpha' \circ \alpha^{-1}_1
		\end{align*}
		By hypothesis $\lgh(\der{D}_1) \neq 0$, thus $\alpha_1=\alpha$ and we can conclude.
		
		\item  From $E_{\sigma, \tau}\neq \emptyset$ we deduce that $l_1\neq 0$ and that $0\in E_{\sigma, \tau}$.   We proceed by induction on $i\in [0,\max(E_{\sigma, \tau})]$. 

\smallskip \noindent  If $i=0$ the thesis follows from point $1$.

\smallskip \noindent If $i>0$, we proceed as in the proof of \Cref{prop:isouno} considering the pushout square
			\[\xymatrix{K_{i-1}\ar[r]^{r_{i-1}} \ar[d]_{k_{i-1}}& R_{i-1} \ar[d]^{h_{i-1}}\\ D_{i-1} \ar[r]_{g_{i-1}}& G_i}\] 
		Since $i$ belongs to $E_{\sigma, \tau}$, then $i-1\in E_{\sigma, \tau}$ too. By definition, $i\leq l_1-1$, so that, using \Cref{rem:coproj}, \Cref{rem:dett} and the induction hypothesis we have
			\[\begin{split}
				\xi_\sigma \circ \iota_{G_i}\circ h_{i-1}&=  \xi_\sigma\circ \iota_{R_{i-1}}\\&=\iota'_{R'_{\sigma(i-1)}}\\&=\iota'_{R'_{\tau(i-1)}}\\&=q'_1\circ \iota'_{1, R'_{1,\tau(i-1)}}\\&=q'_1\circ \xi_{\tau}\circ \iota_{1, R_{i-1}}\\&=q'_1\circ \xi_{\tau} \circ \iota_{1, G_{1,i}}\circ h_{1, i-1}\\&=q'_1\circ \xi_\tau \circ \iota_{1, G_i} \circ h_{i-1}
			\end{split} \qquad  \begin{split}
			\xi_\sigma \circ \iota_{G_i}\circ g_{i-1}&=\xi_{\sigma}\circ \iota_{D_{i-1}}\\&=\xi_{\sigma}\circ \iota_{G_{i-1}} \circ f_{i-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{i-1}} \circ f_{i-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{i-1}} \circ f_{1, i-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, D_{i-1}}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_i}\circ g_{1, i-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_i}\circ g_{i-1}
			\end{split}\]
	
	From which the thesis follows.
	
			\item Since $l_1-1\in E_{\sigma, \tau}$ we have $l_1\neq 0$ and $E_{\sigma, \tau}=[0,l_1-1]$.  We can start with the pushout
			\[\xymatrix{K_{l_1-1}\ar[r]^{r_{l_1-1}} \ar[d]_{k_{l_1-1}}& R_{i-1} \ar[d]^{h_{l_1-1}}\\ D_{l_1-1} \ar[r]_{g_{l_1-1}}& G_{l_1}}\] 
			By \Cref{def:conc}, we have $h_{l_1-1}=h_{1, l_1}$ and $g_{l_1-1}=g_{1,l_1}$. Since $q'_1=\id{\lpro \der{D}'_1\rpro}$ these two equalities imply that $	\iota'_{R_{\tau(l_1-1)}}=q'_1\circ \iota'_{1, R'_{1,\tau(l_1-1)}}$. 			
			
			Moreover, by hypothesis $l_1-1\in E_{\sigma, \tau}$, so that point $3$ of this lemma entails that
			\[\xi_\sigma \circ \iota_{G_{l_1-1}}=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1-1}}\]
			
			We can thus repeat the same argument of the previous point:
			\[\begin{split}
				\xi_\sigma \circ \iota_{G_{l_1}}\circ h_{l_1-1}&=  \xi_\sigma\circ \iota_{R_{l_1-1}}\\&=\iota'_{R'_{\sigma(l_1-1)}}\\&=\iota'_{R'_{\tau(l_1-1)}}\\&=q'_1\circ \iota'_{1, R'_{1,\tau(l_1-1)}}\\&=q'_1\circ \xi_{\tau}\circ \iota_{1, R_{l_1-1}}\\&=q'_1\circ \xi_{\tau} \circ \iota_{1, G_{1,l_1}}\circ h_{1, l_1-1}\\&=q'_1\circ \xi_\tau \circ \iota_{1, G_{l_1}} \circ h_{l_1-1}			\end{split} 
			\qquad  \begin{split}
				\xi_\sigma \circ \iota_{G_{l_1}}\circ g_{l_1-1}&=\xi_{\sigma}\circ \iota_{D_{l_1-1}}\\&=\xi_{\sigma}\circ \iota_{G_{l_1-1}} \circ f_{l_1-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1-1}} \circ f_{l_1-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}-1} \circ f_{1, l_1-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, D_{l_1-1}}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}}\circ g_{1, l_1-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}}\circ g_{l_1-1}
			\end{split}\]
		
		And again this implies the thesis.
			
			\item In this case, we can consider the following diagram, in which the inner rectangle and the outer border are pushouts
		\[\xymatrix@C=35pt{K_{1,l_1-1}\ar[r]^{r_{1,l_1-1}} \ar[d]_{k_{1,l_1-1}}& R_{i-1} \ar[d]_{h_{1,l_1-1}} \ar@/^.3cm/[ddr]^{h_{l_1-1}}\\ D_{1,l_1-1} \ar[r]_{g_{1,l_1-1}} \ar@/_.3cm/[drr]_{g_{l_1-1}}& G_{1,l_1} \ar[dr]^{\omega_1^{-1}}\\ &&\pi(G_{2,0})}\] 
		
		\iffalse 
	\[	\xi_\sigma \circ \iota_{G_{l_1}}=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}}\circ \omega_1\]
	\fi 
		We can start noticing that, by the proof of  the third point of \Cref{rem:dett}, we know that  $q'_1\circ \iota'_{1, G'_{1,l_1}}=\iota'_{G'_{l_1}} \circ \omega_1^{-1}$. Therefore
		\begin{align*}q'_1\circ \iota'_{1, R'_{1,l_1}}&=q'_1\circ \iota'_{1, G'_{1,l_1}}\circ  h'_{1, l_1}\\&=q'_1\circ \iota'_{1, G'_{1,l_1}}\circ \omega_1 \circ  h'_{ l_1}\\&= \iota'_{G'_{l_1}}\circ h'_{l_1}\\&=\iota'_{R'_{l_1-1}}
		\end{align*}
		
		The argument now proceeds almost verbatim like the one of the previous two point. Indeed, using the third point of this lemma we get:
		\[\begin{split}
			\xi_\sigma \circ \iota_{G_{l_1}}\circ h_{l_1-1}&=  \xi_\sigma\circ \iota_{R_{l_1-1}}\\&=\iota'_{R'_{\sigma(l_1-1)}}\\&=\iota'_{R'_{\tau(l_1-1)}}\\&=q'_1\circ \iota'_{1, R'_{1,\tau(l_1-1)}}\\&=q'_1\circ \xi_{\tau}\circ \iota_{1, R_{l_1-1}}\\&=q'_1\circ \xi_{\tau} \circ \iota_{1, G_{1,l_1}}\circ h_{1, l_1-1}\\&=q'_1\circ \xi_\tau \circ \iota_{1, G_{1, l_1}} \circ \omega_1 \circ  h_{l_1-1}			\end{split}  \qquad  		\begin{split}
			\xi_\sigma \circ \iota_{G_{l_1}}\circ g_{l_1-1}&=\xi_{\sigma}\circ \iota_{D_{l_1-1}}\\&=\xi_{\sigma}\circ \iota_{G_{l_1-1}} \circ f_{l_1-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}} \circ f_{l_1-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}} \circ f_{1, {l_1}-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, D_{{l_1}-1}}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}}\circ g_{1, l_1-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}}\circ \omega_1\circ g_{l_1-1}
			\end{split}\]
			
			\item  The thesis follows from points $3$ and $4$ if $l_2=0$, from $3$ and $5$ if $l_2\neq 0$.	\qedhere
	\end{enumerate}
\end{proof}

We are now ready to prove the central result of this section: the uniqueness of a consistency permutation between two decorated derivations in a consuming rewriting system.
 
\begin{lemma}\label{lem:impo}
	Let $(\X,R)$ be a left-linear DPO-rewriting system and let also $(\der{D}_1, \alpha_1, \omega_1)$, $(\der{D}_2, \alpha_2, \omega_2)$ be two composable decorated derivations of length, respectively, $l_1$ and $l_2$. Suppose that $\sigma:[0, l_1+l_2-1]\to [0, l_1+l_2-1]$ is a consistent permutation between $(\der{D}_1, \alpha_1, \omega_1)\cdot (\der{D}_2, \alpha_2, \omega_2)$ and $(\der{D}'_1, \alpha'_1, \omega'_1)\cdot (\der{D}'_2, \alpha'_2, \omega'_2)$ for some other two composable decorated derivations $(\der{D}_1, \alpha_1, \omega_1)$ and $(\der{D}_2, \alpha_2, \omega_2)$.  Let, moreover, $\tau:[0,l_1-1]\to [0, l_1-1]$ be a consistent permutation between $(\der{D}_1, \alpha_1, \omega_1)$ and $(\der{D}'_1, \alpha'_1, \omega'_1)$. Suppose, finally, that  the set 
	\[D_{\sigma, \tau}:=\{i\in [0, l_1-1]\mid \sigma(i)\neq \tau(i)\}\]
	is non-empty and let $j$ be its minimum. If $r(\der{D}_1)$ is $\{\rho_i\}_{i=0}^{l_1-1}$ then the following hold true:
	\begin{enumerate}
		\item if $j=0$, then the rule $\rho_0$ is not consuming;
		\item if $j\neq 0$ then the rule $\rho_{j-1}$ is not consuming.
	\end{enumerate}
\end{lemma}
\begin{remark}\label{rem:minmax}It is worth to notice that the hypothesis $D_{\sigma, \tau} \neq \emptyset$ entails $l_1\neq 0$. Moreover, if $j\neq 0$, then $j-1$ is the maximum of $E_{\sigma, \tau}$.
\end{remark}
\begin{proof}
	\begin{enumerate}
		\item Let $k$ be $\sigma^{-1}(\tau(0))$ and notice that, since $\sigma(0)\neq \tau(0)$, then $0< k$.  By  the second point of  \Cref{prop:uniqu} we can consider the diagram
		\[\xymatrix@C=40pt{G_{0} \ar[drrr]_(.4){\iota_{G_0}}|(.675)\hole \ar[d]_{\iota_{1,G_{1,0}}}& L_0 \ar[r]_{m'_{\tau(0)}} \ar@/^.4cm/[rr]^{m_{k}} \ar[l]_{m_{0}} &G'_{\tau(0)} \ar[d]^(.45){\iota'_{G'_{\tau(0)}}} & G_{k} \ar[d]^{\iota_{G_k}}\\ \lpro\der{D}_1 \rpro \ar[r]_{\xi_{\tau}} &\lpro \der{D}'_1\rpro \ar[r]_{q'_1} & \lpro \der{D'}\rpro & \tpro{D} \ar[l]^{\xi_{\sigma}}}\]
		From \Cref{cor:ele}, we can conclude that there exists $c\colon L_0\to D_0$ such that $f_0\circ c=m_0$. We thus have the solid part of the commutative diagram below.
		\[\xymatrix{L_0 \ar@/^.3cm/[drr]^{\id{L_0}} \ar@{.>}[dr]_{t} \ar@/_.3cm/[ddr]_{c}\\ & K_0 \ar[d]_{k_0}\ar@{>->}[r]^{l_0}& L_0 \ar[d]^{m_0} \\& D_0 \ar@{>->}[r]_{f_0} & G_0} \]
		The internal square is an $\mathcal{M}$-pushout and thus a pullback, by \Cref{prop:pbpoad}, so that we have the existence of the dotted $t\colon L_0\to K_0$. Therefore $\id{L_0}=l_0\circ t$, proving that $l_0$ is an epimorphism. The thesis now follows from \Cref{cor:rego}. 
		\item  Let $k$ be $\sigma^{-1}(\tau(j-1))$ and notice that $\rho_{j-1}=\rho_k$. We have already noticed in \Cref{rem:minmax} that $j-1$ is the maximum of $E_{\sigma, \tau}$.  Hence, by the third point of \Cref{prop:uniqu} we have
		\[\xymatrix@C=40pt{G_{1,{j-1}} \ar[drrr]_(.4){\iota_{G_{j-1}}}|(.675)\hole \ar[d]_{\iota_{1,G_{1,j-1}}}& L_{j-1} \ar[r]_{m'_{\tau({j-1})}} \ar@/^.4cm/[rr]^{m_{k}} \ar[l]_{m_{{j-1}}} &G'_{\tau({j-1})} \ar[d]^{\iota'_{G'_{\tau({j-1})}}} & G_{k} \ar[d]^{\iota_{G_k}}\\ \lpro\der{D}_1 \rpro \ar[r]_{\xi_{\tau}} &\lpro \der{D}'_1\rpro \ar[r]_{q'_1} & \lpro \der{D'}\rpro & \tpro{D} \ar[l]^{\xi_{\sigma}}}\]
		Let $a$ be $\min(j-1, k)$, by \Cref{cor:ele},  there exists $c\colon L_{j-1}\to D_a$ such that $f_a\circ c=m_a$. As before this yields the solid part of the following diagram, in which the square is an $\mathcal{M}$-pushout.
		\[\xymatrix{L_{j-1} \ar@/^.3cm/[drr]^{\id{L_{j-1}}} \ar@{.>}[dr]_{t} \ar@/_.3cm/[ddr]_{c}\\ & K_{j-1} \ar[d]_{k_a}\ar@{>->}[r]^{l_{j-1}}& L_{j-1} \ar[d]^{m_a} \\& D_a \ar@{>->}[r]_{f_a} & G_a} \]
		The existence of the dotted $t\colon L_{j-1}\to K_{j-1}$ follows from  \Cref{prop:pbpoad} and we can conclude. \qedhere
	\end{enumerate}
\end{proof}


\begin{corollary}[Uniqueness of consistent permutation]\label{cor:unique}
Let $(\X,\R)$ be a consuming left-linear DPO-rewriting system. Then, for every two decorated derivations $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$, there exists at most one consistent permutation between them.
\end{corollary}
\begin{proof}
Let $\sigma, \tau: [0, \lgh(\der{D})-1]\rightrightarrows [0, \lgh(\der{D})-1]$ be two consistent permutations. Let $H$  and $H'$ be, respectively, the target of $\der{D}$ and $\der{D}'$. Take two isomorphisms $\gamma:\pi(H)\to \gamma$, $\gamma':\pi(H')\to H'$, then, according to \Cref{def:conc}:
\begin{align*}(\der{D}, \alpha, \omega)&=(\der{D}, \alpha, \omega)\cdot (\der{D}_2, \gamma, \gamma) \\(\der{D}', \alpha', \omega')&=(\der{D}', \alpha', \omega')\cdot (\der{D}'_2, \gamma', \gamma') 
\end{align*} 
where $\der{D}_2$ and $\der{D}'_2$ are the empty derivation on $H$ and $H'$. Since $(\X, \R)$ is consuming, then \Cref{lem:impo} entails $D_{\sigma, \tau}=\emptyset$, from which the thesis follows.
\end{proof}



\begin{lemma}[Restriction Lemma]\label{lem:presuffix} Let $(\X, \R)$ be a consuming left-linear DPO-rewriting system.  Let also $(\der{D}_1, \alpha_1, \omega_1)$, $(\der{D}_2, \alpha_2, \omega_2)$ be two composable decorated derivations of length, respectively, $l_1$ and $l_2$. Suppose that $\sigma\colon [0, l_1+l_2-1]\to [0, l_1+l_2-1]$ is a consistent permutation between $(\der{D}_1, \alpha_1, \omega_1)\cdot (\der{D}_2, \alpha_2, \omega_2)$ and $(\der{D}'_1, \alpha'_1, \omega'_1)\cdot (\der{D}'_2, \alpha'_2, \omega'_2)$ for some other two composable decorated derivations $(\der{D}_1, \alpha_1, \omega_1)$ and $(\der{D}_2, \alpha_2, \omega_2)$.  If $\tau\colon [0,l_1-1]\to [0, l_1-1]$ is a consistent permutation between $(\der{D_1}, \alpha_1, \omega_1)$ and $(\der{D}'_1, \alpha'_1, \omega'_1)$. Then the following hold true:
	\begin{enumerate}
		\item suppose that $l_1$ and $l_2$ are different from $0$ and consider the following two pushout squares given by \Cref{rem:dett}:
		\[\xymatrix@C=45pt@R=30pt{\pi(G_{2,0}) \ar@{>->}[d]_{\iota_{1, G_{1,n+1}} \circ \omega_1}\ar[r]^{\iota_{2, G_{2,0}} \circ \alpha_2}& \lpro \der{D}_2 \rpro \ar@{>->}[d]^{q_2} &  \pi(G'_{2,0}) \ar@{>->}[d]_{\iota'_{1, G'_{1,n+1}} \circ \omega'_1} \ar[r]^{\iota'_{2, G'_{2,0}} \circ \alpha'_2}& \lpro \der{D}'_2 \rpro \ar@{>->}[d]^{q'_2} \\ \lpro \der{D}_1 \rpro  \ar[r]_{q_1} & \tpro{D} & \lpro \der{D}'_1\rpro \ar[r]_{q'_1} & \lpro \der{D}'\rpro  }\]
		then, for every $i\in [0, l_2]$ there exists a unique $\zeta_i\colon G_{2,i}\to \lpro \der{D}_2\rpro $ fitting in the diagram below
		\[\xymatrix@R=35pt{G_{2,i} \ar[r]^{\iota_{2,G_{2,i}}} \ar@{.>}[d]_{\zeta_i}&\lpro \der{D}_2 \rpro \ar@{>->}[r]^{q_2}& \tpro{D} \ar[d]^{\xi_{\sigma}} \\
			\lpro \der{D}'_2 \rpro \ar@{>->}[rr]_{q'_2}&& \lpro \der{D}'\rpro }\]
		\item the permutation
		\[\varrho\colon [0,l_2-1]\to [0, l_2-1] \qquad i \mapsto \sigma(i+l_1)-l_1\]
		is a consistent one.
	\end{enumerate}
\end{lemma}
\begin{proof}\begin{enumerate}
		\item We can start noticing that  by \Cref{lem:impo}, $\sigma(i)=\tau(i)$ for every $i\in  [0, l_1-1]$. By the second point of \Cref{prop:uniqu} we can deduce that
		\[\xi_\sigma \circ \iota_{G_{i}}=\]Let us prove the existence of $\zeta_i$ by induction on $i\in [0, l_2]$.
		
		\smallskip \noindent $i=0$. We already know that $G_{l_1}$ and $G'_{l_1}$ are both equal to $\pi(G_{2,0})$.  Moreover, we also know that
		\begin{align*}
		q_2\circ \iota_{2, G_{2,0}}=\iota_{G_{l_1}} \circ \alpha^{-1}_2 \qquad
		\end{align*}

		Thus we have a diagram
		\[\xymatrix{&G_{2,0} \\
		G_{l_1} \\
		G'_{2,0}&}\]
		
	Moreover, $\pi(mj$
		\begin{align*}
			\xi_\sigma \circ p_2\circ \iota_{2, G_{2,0}}&=\xi_\sigma \circ \iota_{G_{n+1}}\circ \alpha^{-1}_2\\&g
		\end{align*}

		\smallskip \noindent $i>0$.
		
		
		The uniqueness half of the thesis follows at once since $p'_2$ is in $\mathcal{M}$. 
		
		\item Let us split the cases.
		
		\smallskip \noindent $l_1=0$. then $\varrho=\sigma$ and there is nothing to proof. 
		
		\smallskip \noindent $l_2=0$ and $l_1\neq0$. Then $\varrho=\id{\emptyset}$ and
		
		\smallskip \noindent $l_1\neq0$ and $l_2\neq 0$. 
		\[\xymatrix{xy code}\]
		
		
		
		Consistency now follows at once. \qedhere 
	\end{enumerate}
\end{proof}


Finally, we  end this section showing that consistent permutations between composable abstract derivations yield a consistent permutation between the composites.

\begin{lemma}[Composition lemma]\label{lem:sum} Let $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ be two abstract decorated derivations such that:
	\[(\der{D}, \alpha, \omega)=(\der{D}_1, \alpha_1, \omega_1)\cdot (\der{D}_2, \alpha_2, \omega_2) \qquad (\der{D}', \alpha', \omega')=(\der{D}'_1, \alpha'_1, \omega'_1)\cdot (\der{D}'_2, \alpha'_2, \omega'_2)\]
	
	Given a consistent permutation $\sigma\colon [0, \lgh(\der{D}_1)-1]\to [0, \lgh(\der{D}_1)-1]$ between  $(\der{D}_1, \alpha_1, \omega_1)$ and $(\der{D}'_1, \alpha'_1, \omega'_1)$ and another $\tau\colon [0, \lgh(\der{D}_2)-1]\to [0, \lgh(\der{D}_2)-1]$ between $(\der{D}_2, \alpha_2, \omega_2)$ and $(\der{D}'_2, \alpha'_2, \omega'_2)$, then:
	\[\sigma+\tau\colon[0, \lgh(\der{D})-1]\to[0, \lgh(\der{D})-1] \quad i \mapsto \begin{cases}
		\sigma(i) & i < \lgh(\der{D}_1)\\
		\lgh(\der{D}_1)+\tau(i-\lgh(\der{D}_1)) &   i\geq \lgh(\der{D}_1) 
	\end{cases}\]
	is a consistent permutation between $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$.
\end{lemma}


\begin{notation}
Given $X_1\in \Delta(\der{D}_1)$, $X_2\in \Delta(\der{D}_2)$, $X'_1\in \Delta(\der{D}'_1)$, $X'_2\in \Delta(\der{D}'_2)$, we will denote their coprojections into, respectively, $\lpro \der{D}_1\rpro$, $\lpro \der{D}'_2\rpro$, $\lpro \der{D}'_1\rpro$, $\lpro \der{D}'_2\rpro$ by
$\iota_{1, X_1}\colon X_1\to \lpro\der{D}_1\rpro$, $\iota_{1, X_2}\colon X_2\to \lpro\der{D}_1\rpro$, $\iota'_{1, X'_1}\colon X'_1\to \lpro\der{D}'_1\rpro$ and $\iota'_{2, X'_2}\colon X'_2\to \lpro\der{D}_1\rpro$. Similarly, given $X\in \Delta(\der{D})$ and $X'\in \Delta(\der{D}')$ we will use $\iota_X\colon X\to \tpro{D}$ and $\iota'_{X'}\colon X'\to \lpro \der{D}' \rpro$ for the coprojections.
\end{notation}

\begin{proof}
We split the proof in three cases, according to \Cref{def:conc}.
	\begin{itemize}
	\item $\lgh(\der{D}_1)=0$. Thus $\lgh(\der{D}'_1)=0$ too  and we have
	\[
	(\der{D}, \alpha, \omega)=(\der{D}_2, \alpha_2\circ \omega_1^{-1}\circ \alpha_1, \omega_2) \qquad  (\der{D}', \alpha', \omega')=(\der{D}'_2, \alpha'_2\circ (\omega'_1)^{-1}\circ \alpha'_1, \omega'_2)\]

	Moreover, in this case $\sigma$ must be $\id{\emptyset}$ and $\sigma+\tau$ must be equal to $\tau$. The thesis now follows from the commutativity of the following diagram.
	\[\xymatrix@C=35pt{& G_{1,0}\ar[dd]^{\xi_{\id{\emptyset}}} \ar[dr]^{\omega^{-1}_1}&&G_{2,0}\ar[r]^-{\iota_{2, G_{2,0}}} & \lpro \der{D}_2\rpro \ar[dd]^{\xi_{\tau}}\\\pi(G_{1,0})  \ar[ur]^{\alpha_1} \ar[dr]_{\alpha'_1}&& \pi(G_{2,0}) \ar[ur]^{\alpha_2} \ar[dr]_{\alpha'_2}\\& G'_{1,0} \ar[ur]_{(\omega'_1)^{-1}}&&G'_{2,0} \ar[r]_-{\iota'_{2, G_{2,0}}}& \lpro \der{D}'_2\rpro}\]
	
\item $\lgh(\der{D}_2)=0$.  As before this implies that also $\lgh(\der{D}'_2)$ is $0$.  Applying \Cref{def:conc} we get 
\[
(\der{D}, \alpha, \omega)=(\der{D}_1, \alpha_1, \omega_1 \circ (\alpha_2)^{-1}\circ \omega_2) \qquad (\der{D}', \alpha', \omega')=(\der{D}'_1, \alpha'_1, \omega'_1 \circ (\alpha'_2)^{-1}\circ \omega'_2)\]
	
	Since $\der{D}_2$ is empty, then $\tau=\id{\emptyset}$ and $\sigma+\tau=\sigma$. Let $n$ be $\lgh(\der{D}_1)$, as before the thesis follows from the diagram below.
	\[\xymatrix@C=35pt{& G_{2,0}\ar[dd]^{\xi_{\id{\emptyset}}} \ar[dr]^{\alpha^{-1}_2}&&G_{1,n}\ar@{>->}[r]^-{\iota_{1, G_{1,n}}} & \lpro \der{D}_2\rpro \ar[dd]^{\xi_{\sigma}}\\\pi(G_{2,0})  \ar[ur]^{\omega_2} \ar[dr]_{\omega'_2}&& \pi(G_{1,n}) \ar[ur]^{\omega_1} \ar[dr]_{\omega'_1}\\& G'_{2,0} \ar[ur]_{(\alpha'_1)^{-1}}&&G'_{1,n} \ar@{>->}[r]_-{\iota'_{1, G_{1,n}}}& \lpro \der{D}'_2\rpro}\]
	
\item  $\lgh(\der{D}_1)\neq0$ and $\lgh(\der{D}_2)\neq 0$. Thus $\der{D}'_1$ and $\der{D}'_2$ are non-empty too. In this case we have
\[	(\der{D}, \alpha, \omega)=(\der{D}_1*\omega_1^{-1}\cdot \alpha_2*\der{D}_2, \alpha_1, \omega_2)\qquad
(\der{D}', \alpha', \omega')=(\der{D}'_1*(\omega'_1)^{-1}\cdot \alpha'_2*\der{D}'_2, \alpha'_1, \omega'_2)\]

Let us assume that $\der{D}_1$, $\der{D}'_1$, $\der{D}_2$ and $\der{D}'_2$ are given by
\[\der{D}_1=\{\dder{D}_{1,i}\}_{i=0}^n \quad \der{D}'_1=\{\dder{D}'_{1,i}\}_{i=0}^n \quad \der{D}_2=\{\dder{D}_{2,i}\}_{i=0}^t \quad \der{D}_2'=\{\dder{D}'_{2,i}\}_{i=0}^t\]
By definition of consistent permutation, the rule applied by $\dder{D}_{1,i}$ and the one applied in $\dder{D}_{2,i}$  must coincide with, respectively, the one applied in $\dder{D}'_{1,i}$ and the one applied $\dder{D}'_{2,1}$. Let $\dder{D}_{1,i}$, $\dder{D}'_{1,i}$, $\dder{D}_{2,i}$ and $\dder{D}'_{2,i}$ be given, by the following four diagrams. 
\[\xymatrix{L_{1,i} \ar[d]_{m_{1, i}}& K_{1,i} \ar[d]_{k_{1, i}} \ar[r]^{r_{1,i}} \ar@{>->}[l]_{l_{1,i}} & R_{1,i}\ar[d]^{h_{1, i}} &L_{1,i} \ar[d]_{m'_{1, i}}& K_{1,i} \ar[d]_{k'_{1, i}} \ar[r]^{r_{1,i}} \ar@{>->}[l]_{l_{1,i}} & R_{1,i}\ar[d]^{h'_{1, i}} \\G_{1,i} & D_{1,i} \ar[r]_{g_{1,i}} \ar@{>->}[l]^{f_{1,i}} & G_{1,i+1} & G'_{1,i} & D'_{1,i}\ar[r]_{g'_{1,i}} \ar@{>->}[l]^{f'_{1,i}}  & G'_{1,i+1}}\]		
\[\xymatrix{L_{2,i} \ar[d]_{m_{2, i}}& K_{2,i} \ar[d]_{k_{2, i}} \ar[r]^{r_{2,i}} \ar@{>->}[l]_{l_{2,i}} & R_{2,i}\ar[d]^{h_{2, i}} &L_{2,i} \ar[d]_{m'_{2, i}}& K_{2,i} \ar[d]_{k'_{2, i}} \ar[r]^{r_{2,i}} \ar@{>->}[l]_{l_{2,i}} & R_{2,i}\ar[d]^{h'_{2, i}} \\G_{2,i} & D_{2,i} \ar[r]_{g_{2,i}} \ar@{>->}[l]^{f_{2,i}} & G_{2,i+1} & G'_{2,i} & D'_{2,i}\ar[r]_{g'_{2,i}} \ar@{>->}[l]^{f'_{2,i}}  & G'_{2,i+1}}\] 

%Let $(\lpro \der{D}_1*(\omega_1)^{-1}\rpro, \{j_X\}_{X\in \Delta( \der{D}_1*(\omega_1)^{-1})})$, $(\lpro \der{D}'_1*(\omega'_1)^{-1}\rpro, \{j'_X\}_{X\in \Delta( \der{D}'_1*(\omega'_1)^{-1})})$, $(\lpro \der{D}_1*(\omega_1)^{-1}\rpro, \{j_X\}_{X\in \Delta( \der{D}_1*(\omega_1)^{-1})})$ and $(\lpro \der{D}'_1*(\omega'_1)^{-1}\rpro, \{j'_X\}_{X\in \Delta( \der{D}'_1*(\omega'_1)^{-1})})$ be colimiting cocones. 
By \Cref{rem:dett} we get the following diagram, in which the two solid squares are pushouts:
\[\xymatrix@C=45pt@R=30pt{\pi(G_{2,0}) \ar@/^.4cm/[rrr]^{\id{\pi(G_{2,0})}}\ar@{>->}[d]_{\iota_{1, G_{1,n+1}} \circ \omega_1}\ar[r]_{\iota_{2, G_{2,0}} \circ \alpha_2}& \lpro \der{D}_2 \rpro \ar@{>->}[d]^{q_2}\ar[r]_{\xi_\tau} & \lpro \der{D}'_2 \rpro \ar@{>->}[d]_{q'_2} &\pi(G'_{2,0}) \ar@{>->}[d]^{\iota'_{1, G'_{1,n+1}} \circ \omega'_1} \ar[l]^{\iota'_{2, G'_{2,0}} \circ \alpha'_2}\\ \lpro \der{D}_1 \rpro \ar@/_.4cm/[rrr]_{\xi_\sigma} \ar[r]^{q_1} & \tpro{D} \ar@{.>}[r]^{\xi_{\sigma+\tau}} & \lpro \der{D}'\rpro & \lpro \der{D}'_1\rpro  \ar[l]_{q'_1}}\]

Moreover, we can point out that, for every index $i\in [0,n+t+2]$ we have

\[\iota_{G_i}=\begin{cases}q_1\circ \iota_{1, G_{1,i}} & i \leq n\\
	q_1\circ \iota_{1, G_{1, i}}\circ \omega_1& i=n+1\\
	q_2\circ \iota_{2, G_{2,i-(n+1)}} & i > n+1 
\end{cases} \qquad \iota'_{G'_i}=\begin{cases}q'_1\circ \iota'_{1, G'_{1,i}} & i \leq n\\
	q'_1\circ \iota'_{1, G'_{1, i}}\circ \omega'_1& i=n+1\\
	q'_2\circ \iota'_{2, G'_{2,i-(n+1)}} & i > n+1 
\end{cases}\]

Now, on the one hand, the existence of the dotted arrow $\xi_{\sigma+\tau}\colon \tpro{D}\to \lpro \der{D}'\rpro$ in the diagram above follows from the following computation:
\begin{align*}
	q'_1\circ \xi_\sigma \circ \iota_{1, G_{1,n+1}} \circ \omega_1&=q'_1\circ \iota'_{1,G'_{1, n+1}} \circ \omega'_1\\&= q'_2 \circ \iota'_{2, G'_{2,0}} \circ \alpha'_2\\&=q'_2\circ \xi_\tau \circ \iota_{2, G_{2,0}} \circ \alpha_2
\end{align*} 
On the other hand, we can repeat the same computation for $\xi^{-1}_\sigma$ and $\xi^{-1}_\tau$ to get
\begin{align*}
	q_1\circ \xi^{-1}_\sigma \circ \iota'_{1, G'_{1,n+1}} \circ \omega'_1&=q_1\circ \iota_{1,G_{1, n+1}} \circ \omega_1\\&= q_2 \circ \iota_{2, G_{2,0}} \circ \alpha_2\\&=q_2\circ \xi^{-1}_\tau \circ \iota'_{2, G'_{2,0}} \circ \alpha'_2
\end{align*} 
Hence there exists a $\psi\colon \lpro \der{D}'\rpro \to \tpro{D}$ such that:
\[\psi \circ q'_1=q_1\circ \xi^{-1}_\sigma \qquad \psi \circ q'_2=q_2\circ \xi^{-1}_\tau\]

Furthermore, the computations below show that $\psi$ is the inverse of $\xi_{\sigma+\tau}$.
\[\begin{split}
	\psi \circ \xi_{\sigma+\tau}\circ  q_1&=\psi \circ q'_1\circ \xi_\sigma \\&=q_1\circ \xi^{-1}_{\sigma}\circ \xi_\sigma\\&=q_1\\\\
	\xi_{\sigma+\tau}\circ \psi \circ q'_1&=\xi_{\sigma+\tau}\circ q_1\circ \xi^{-1}_\sigma \\&=q'_1\circ \xi_{\sigma}\circ \xi^{-1}_\sigma\\&=q'_1
\end{split}\qquad \begin{split}
	\psi \circ \xi_{\sigma+\tau}\circ  q_2&=\psi \circ q'_2\circ \xi_\tau \\&=q_2\circ \xi^{-1}_{\tau}\circ \xi_\tau\\&=q_2\\ \\ 	\xi_{\sigma+\tau}\circ \psi \circ q'_2&=\xi_{\sigma+\tau}\circ q_2\circ \xi^{-1}_\tau \\&=q'_2\circ \xi_{\tau}\circ \xi^{-1}_\tau\\&=q'_2
\end{split}\]
To conclude we have to show that $\xi_{\sigma+\tau}$ fits in the diagrams of \Cref{def:permcon}.  For the ones involving the decorations we have:
\[\begin{split}
	\xi_{\sigma+\tau} \circ \iota_{G_{0}}\circ \alpha&=\xi_{\sigma+\tau} \circ q_1 \circ \iota_{1,G_{1,0}}\circ \alpha_1\\&=q_1'\circ \xi_\sigma \circ  \iota_{1,G_{1,0}} \alpha_1\\&=q'_1\circ \iota'_{1, G'_{1,0}}\circ \alpha'_1\\&=\iota'_{G'_0}\circ \alpha'
\end{split}  \qquad 
\begin{split}
\xi_{\sigma+\tau} \circ \iota_{G_{n+t+2}}\circ \omega&=\xi_{\sigma+\tau} \circ q_2 \circ \iota_{2,G_{2,t+1}}\circ \omega_2\\&=q'_2\circ \xi_\tau \circ  \iota_{2,G_{2,t+1}} \omega_2\\&=q'_2\circ \iota'_{2, G'_{2,t+1}}\circ \omega'_2\\&=\iota'_{G'_{n+t+2}}\circ \omega'
\end{split}  \]

Let now $i$ be an index in $[0, n+t+1]$, we proceed splitting the cases.
\begin{itemize}
	\item $i$ is in $[0,n]$. Then we have
	\begin{align*}
		\xi_{\sigma+\tau}\circ \iota_{G_i} \circ m_i &= \xi_{\sigma+\tau} \circ q_1\circ \iota_{1, G_{1,i}}\circ m_{1,i}\\&=q'_1 \circ \xi_\sigma \circ \iota_{1, G_{1,i}}\circ m_{1,i}\\&= q'_1\circ \iota'_{1, G'_{1,\sigma(i)}}\circ m'_{1,\sigma(i)}\\&=\iota'_{G'_{\sigma(i)}}\circ m'_{\sigma(i)}
	\end{align*}
	Now, suppose that $i\neq n$, then 
	\begin{align*}
		\xi_{\sigma+\tau}\circ \iota_{G_{i+1}} \circ h_i &= \xi_{\sigma+\tau} \circ q_1\circ \iota_{1, G_{1,{i+1}}}\circ h_{1,i}\\&=q'_1\circ \xi_\sigma \circ \iota_{1, G_{1,{i+1}}}\circ h_{1,i}\\&= q'_1\circ \iota'_{1, G'_{1,\sigma(i)+1}}\circ h'_{1,\sigma(i)}
	\end{align*}
	and we have two subcases. If $\sigma(i)\neq n$, then \[h'_{1, \sigma(i)}=h'_{\sigma(i)} \qquad q'_1\circ \iota'_{1, G'_{1,\sigma(i)+1}}=
	\iota'_{G'_{\sigma(i)+1}}\] 
	and we can conclude. Otherwise, we have
	\begin{align*}q'_1\circ \iota'_{1, G'_{1,n+1}}\circ h'_{1,n}&=q'_1 \circ \iota'_{1,G'_{1,n+1}} \circ \omega'_1\circ (\omega')^{-1}_1 \circ h'_{1,n}\\&=\iota'_{G'_{n+1}}\circ h'_n
	\end{align*}
	yielding again the wanted equality
	\[\xi_{\sigma+\tau}\circ \iota_{G_{i+1}} \circ h_i=\iota'_{G'_{\sigma(i)+1}}\circ h'_{\sigma(i)}\]
	Finally, if $i=n$ we get
	\begin{align*}
		\xi_{\sigma+\tau}\circ \iota_{G_{n+1}} \circ h_n &= \xi_{\sigma+\tau} \circ \iota_{\pi(G_{1,n+1})} \circ \omega^{-1}_1\circ h_{1,n}\\&= \xi_{\sigma+\tau} \circ q_1\circ \iota_{1, G_{1,n+1}} \circ \omega_1 \circ \omega^{-1}_1 \circ h_{1,n}\\&=q'_1 \circ \xi_\sigma \circ \iota_{1, G_{1,n+1}} \circ h_{1,n}\\&=q'_1\circ \iota'_{1, G_{1,\sigma(n)+1}} \circ h'_{1,\sigma(n)}
	\end{align*}
	We have again two cases. If $\sigma(n)\neq n$ then we can conclude at once since 
	\[h'_{1, \sigma(n)}=h'_{\sigma(n)} \qquad q'_1\circ \iota'_{1, G'_{1,\sigma(n)+1}}=
	\iota'_{G'_{\sigma(n)+1}}\] 
	While, if $\sigma(n)=n$, then we can use the identities
	\[(\omega'_1)^{-1}\circ h'_{1, n}=h'_{n} \qquad q'_1\circ \iota'_{1, G'_{1, n+1}}=
	\iota'_{G'_{n+1}}\circ (\omega'_1)^{-1}\] 
	to get
	\begin{align*}
		\xi_{\sigma+\tau}\circ \iota_{G_{n+1}} \circ h_n &= q'_1\circ \iota'_{1, G_{1,n+1}} \circ h'_{1,n}\\&=\iota'_{G'_{n+1}}\circ (\omega'_1)^{-1}\circ h'_{1,n}\\&=\iota'_{G'_{n+1}} h'_{n}
	\end{align*}
	\item $i$ is in $[n+1, n+t+1]$- We proceed  similarly to the point above. First of all we have
	\begin{align*}
		\xi_{\sigma+\tau}\circ \iota_{G_{i+1}} \circ h_i &= \xi_{\sigma+\tau} \circ q_2\circ \iota_{1, G_{2,i-n}}\circ h_{2,i-(n+1)}\\&=q'_2 \circ \xi_\tau \circ \iota_{2, G_{2,i-n}}\circ h_{2,i-(n+1)}\\&= q'_2\circ \iota'_{2, G'_{2,\tau(i-n)}}\circ h'_{2,\tau(i-(n+1))}\\&=\iota'_{G'_{\tau(i-n)}}\circ h'_{n+1+\tau(i-(n+1))}
	\end{align*}
	Next, supposing that $i\neq n+1$:	
	\begin{align*}
		\xi_{\sigma+\tau}\circ \iota_{G_{i}} \circ m_i &= \xi_{\sigma+\tau} \circ q_2\circ \iota_{2, G_{2,i-(n+1)}}\circ m_{2,i-(n+1)}\\&=q'_2\circ \xi_\tau \circ \iota_{2, G_{2,{i-(n+1)}}}\circ m_{2,i-(n+1)}\\&= q'_2\circ \iota'_{2, G'_{2,\tau(i-(n+1))}}\circ m'_{2,\tau(i-(n+1))}
	\end{align*}
	and we have again two possibilities. If $\tau(i-(n+1))\neq 0$, then the thesis follows from the equalities \[m'_{2, \tau(i-(n+1))}=m'_{(\sigma+\tau)(i)} \qquad q'_2\circ \iota'_{2, G'_{2,\tau(i-(n+1))}}=
	\iota'_{G'_{(\sigma+\tau)(i)}}\] 
	Suppose, instead, that $\tau(i-(n+1))= 0$, then we have
	\begin{align*} q'_2\circ \iota'_{2, G'_{2,0}}\circ m'_{2,0}&=q'_2 \circ \iota'_{2,G'_{2,0}} \circ \alpha'_2 \circ \alpha'^{-1}_2 \circ m'_{2,0}\\&=q'_1\circ \iota'_{1, G'_{1, n+1}}\circ \omega'_1\circ \alpha'^{-1}_2 \circ m'_{2,0}\\&=\iota'_{G'_{n+1}}\circ m'_{n+1}
	\end{align*}
	allowing us to conclude again.	
	
	We are left with the case $i=n+1$. Let us compute
	\begin{align*}
		\xi_{\sigma+\tau}\circ \iota_{G_{n+1}} \circ m_{n+1} &= \xi_{\sigma+\tau} \circ \iota_{\pi(G_{2,0})} \circ (\alpha'_2)^{-1}\circ m_{2,0}\\&=\xi_{\sigma+\tau} \circ q_1\circ \iota_{1, G_{1,n+1}} \circ \omega_1 \circ (\alpha'_2)^{-1}\circ m_{2,0}\\&=\xi_{\sigma+\tau} \circ q'_2 \circ \iota'_{2,G'_{2,0}} \circ \alpha'_2 \circ (\alpha'_2)^{-1}\circ m_{2,0} \\&=q'_2 \circ \xi_\tau \circ \iota_{2, G_{2,0}} \circ m_{2,0}\\&=q'_2\circ \iota'_{2, G_{2,\tau(0)}} \circ m'_{2,\tau(0)}
	\end{align*}
	We have again two cases. If $\tau(0)\neq 0$ then $(\sigma+\tau)(i)\neq n+1$ and we can conclude at once since 
	\[m'_{2, \tau(0)}=m'_{(\sigma+\tau)(n+1)} \qquad q'_2\circ \iota'_{2, G'_{2,\tau(0)}}=
	\iota'_{G'_{(\sigma+\tau)(0)}}\] 
	If $\tau(0)=0$, so that  $(\sigma+\tau)(0)= n+1$ we appeal to the equalities
	\[(\alpha')^{-1}_2\circ m'_{2, 0}=m'_{n+1} \qquad q'_2\circ \iota'_{2, G'_{2, 0}}=
	\iota'_{G'_{n+1}}\circ (\alpha'_2)^{-1}\] 
	to get
	\begin{align*}
		\xi_{\sigma+\tau}\circ \iota_{G_{n+1}} \circ m_{n+1} &= q'_2\circ \iota'_{2, G_{2,\tau(0)}} \circ m'_{2,\tau(0)}\\&=	\iota'_{G'_{n+1}}\circ (\alpha'_2)^{-1}\circ m'_{2,0}\\&=\iota'_{G'_{n+1}}\circ  m'_{n+1}
	\end{align*}
\end{itemize}
The thesis now follows at once.	 \qedhere 
\end{itemize} \end{proof}



