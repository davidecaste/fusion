\documentclass[a4paper,UKenglish,cleveref,pdftex,thm-restate,numberwithinsect,anonymous]{lipics}
\newif\ifreport
\reporttrue
%\reportfalse
   
% full includes some additional material
\newif\iffull
%\fulltrue
\fullfalse

% additional text
\iffull
\newcommand{\full}[1]{{color{blue}#1}}
%\newcommand{\short}[1]{}
\else 
\newcommand{\full}[1]{}
%\newcommand{\short}[1]{#1}
\fi



\ifreport
\nolinenumbers %uncomment to disable line numbering
\hideLIPIcs  %uncomment to remove references to LIPIcs series (logo, DOI, ...), e.g. when preparing a pre-final version to be uploaded to arXiv or another public repository
\else
%\relatedversion{An extended version is available at \url{https://arxiv.org/abs/2007.04213}.} %optional, e.g. full version hosted on arXiv, HAL, or other respository/website
%\relatedversion{A full version of the paper is available at \url{...}.}
\fi

\bibliographystyle{abbrv}% the mandatory bibstyle



\usepackage{hyperref}
\usepackage[textsize=tiny]{todonotes}
%\usepackage{etex}
\usepackage[all]{xy}
\SelectTips{cm}{}
% derivations and labels
\usepackage{proof}
\newcommand{\lab}[1]{\ensuremath{\mathsf{{#1}}}}
\newcommand{\slab}[1]{\ensuremath{\scriptstyle{\mathsf{{#1}}}}}
\usepackage{wrapfig}


%frecce
\newcommand{\mor}{\mathsf{Mor}}
\newcommand{\mon}{\mathsf{Mono}}
\newcommand{\reg}{\mathsf{Reg}}

% ``boxed'' \infer command
\newcommand{\binfer}[3][]{
  \mbox{\infer[#1]{#2}{#3}}}

% Command for labels on the left side of the rule
%       \inferL{<name>}{<post>}{<pre>}
% generates:
%             <pre>
%      <name> ------
%             <post>
%
\newlength{\myheight}
\newcommand{\inferL}[3]
  {\settoheight{\myheight}{\mbox{${#2}$}}
   \raisebox{\myheight}{{#1}}
   \makebox[1mm]{}
   \mbox{\infer{#2}{#3}}
}

\usepackage{amssymb,graphicx,epsfig,color}
%\usepackage[scriptsize]{subfigure}
\usepackage{subcaption}
\usepackage{wrapfig}

% re-stating 
%\usepackage{thm-restate}

% showing labels
%\usepackage[inline]{showlabels}
 
\usepackage{pgf}
\usepackage{tikz}
\usepackage{tikz-cd}
\usetikzlibrary{arrows,shapes,snakes,automata,backgrounds,petri,fit,positioning}
\tikzstyle{node}=[circle, draw=black, minimum size=1mm]
\tikzstyle{trans}=[font=\scriptsize]
\tikzstyle{lab}=[font=\small]



\newcommand{\pgfBox}{
  \begin{pgfonlayer}{background} 
    \fill[blue!2,thick,draw=black!50,rounded corners,inner sep=3mm] ([xshift=-1.5pt,yshift=-1.5pt]current bounding box.south west) rectangle ([xshift=1.5pt,yshift=1.5pt]current bounding box.north east);
  \end{pgfonlayer}
}
\usepackage{scalerel}
\newcommand{\smallmin}{\scaleobj{0.6}{-}}
\newcommand{\Deltamin}{\Delta^{\hspace{-1pt}\downarrow\hspace{-1pt}}}
\newcommand{\Rrel}[1]   {\stackrel{{#1}}{\Longrightarrow}}
\newcommand{\oa}{\overline a}
\newcommand{\ob}{\overline b}
\newcommand{\oc}{\overline c}
\newcommand{\od}{\overline d}
\newcommand{\rec}{\emph{rec}}
\newcommand{\fn}[1]{{\mathtt{fn}}(#1)}
%\usepackage{latexsym}
\usepackage{stmaryrd}
\def\encodep#1{\llfloor#1\rrfloor}

\newcommand{\cat}[1]{\ensuremath{\mathbf{#1}}}

\newcommand{\dpo}{\textsc{dpo}}

% base classes of categories for adhesive and quasi adhesive case
\newcommand{\bAdh}{\ensuremath{\mathbb{B}}}
\newcommand{\bQAdh}{\ensuremath{\mathbb{QB}}}

%from pawel
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{enumerate}
\usepackage{xspace}
\usepackage{amsfonts}
\usepackage{mathrsfs}
\usepackage{cite}
\usepackage{float}
\usepackage{fancybox}
\usepackage{proof-at-the-end}
\usepackage{cleveref}


%\spnewtheorem*{notation}{Notation}{\bfseries}{\rmfamily}

%%%%%%%% MATHEMATICAL NOTATION %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%symbol for natural numbers
\newcommand{\nat}{\ensuremath{\mathbb{N}}}

% finite subset
\newcommand{\sfin}{\ensuremath{\subseteq_{\mathit{fin}}}}

% flattening of a multiset
\newcommand{\flt}[1]{\ensuremath{[\![{#1}]\!]}}

% compact elements
\newcommand{\compact}[1]{\ensuremath{\mathop{\mathsf{K}({#1})}}}

% principal ideal
\newcommand{\principal}[1]{\ensuremath{\mathop{\downarrow\!{#1}}}}

% ideal completion
\newcommand{\ideal}[1]{\ensuremath{\mathsf{Idl}({#1})}}

% complete prime elements
\newcommand{\pr}[1]{\ensuremath{\mathop{\mathit{pr}({#1})}}}
\newcommand{\wpr}[1]{\ensuremath{\mathop{\mathit{wpr}({#1})}}}

% irreducible elements
\newcommand{\ir}[1]{\ensuremath{\mathop{\mathit{ir}({#1})}}}

% difference of irreducible elements
\newcommand{\diff}[2]{\ensuremath{\delta({#1},{#2})}}

% immediate precedence

% abbreviation for event structure
% \newcommand{\esabbr}{event structure}
\newcommand{\esabbr}{\textsc{es}}
\newcommand{\esnabbr}{\textsc{esnb}}
\newcommand{\esnmabbr}{\textsc{esn}}
\newcommand{\eseqabbr}{\textsc{epes}}

% predecessor of an irreducible
\newcommand{\pred}[1]{\ensuremath{\mathit{p}({#1})}}

% irreducible elements in es domains
\newcommand{\esir}[2]{\ensuremath{\langle{#1}, {#2}\rangle}}

% equivalence classes [of irreducibles]
\newcommand{\eqclass}[2][]{\ensuremath{[{#2}]_{\scriptscriptstyle {#1}}}}
% union of the equivalence classes of the elements in a set
\newcommand{\eqclasscup}[2]{\ensuremath{{#2}_{\scriptscriptstyle {#1}}}}

\newcommand{\eqclassir}[1]{\ensuremath{\eqclass[\leftrightarrow^*]{#1}}}

% quotient of set wrt a relation
\newcommand{\quotient}[2]{\ensuremath{{#1}_{\scriptscriptstyle {#2}}}}

% category of event structures 
\newcommand{\es}{\ensuremath{\mathsf{ES}}}
% category of stable event structures 
\newcommand{\ses}{\ensuremath{\mathsf{sES}}}
% category of prime event structures 
\newcommand{\pes}{\ensuremath{\mathsf{pES}}}
% category of prime event structures with equivalence
\newcommand{\epes}{\ensuremath{\mathsf{epES}}}

% category of connected event structures 
\newcommand{\ces}{\ensuremath{\mathsf{cES}}}

% category of weak prime algebraic domains domains 
\newcommand{\WDom}{\ensuremath{\mathsf{wDom}}}
% category of domains
\newcommand{\Dom}{\ensuremath{\mathsf{Dom}}}
% category of prime algebraic domains
\newcommand{\PDom}{\ensuremath{\mathsf{pDom}}}


%%%%% NON BINARY CONFLICT

% category of event structures 
\newcommand{\esn}{\ensuremath{\mathsf{ES_{nb}}}}
% category of stable event structures 
\newcommand{\sesn}{\ensuremath{\mathsf{sES_n}}}

% category of connected event structures 
\newcommand{\cesn}{\ensuremath{\mathsf{cES_{nb}}}}

% category of prime event structures 
\newcommand{\pesn}{\ensuremath{\mathsf{pES_n}}}

% category of fusion domains 
\newcommand{\WDomb}{\ensuremath{\mathsf{wDom_b}}}
% category of domains
\newcommand{\Domb}{\ensuremath{\mathsf{Dom_b}}}
% category of prime algebraic domains
\newcommand{\PDomb}{\ensuremath{\mathsf{pDom_b}}}

%%%%% END NON BINARY CONFLICT


% slice category
\newcommand{\slice}[2]{\ensuremath{({#1} \downarrow {#2})}}


% event structure for a domain
\newcommand{\zev}[0]{\ensuremath{\mathcal{E}}}
\newcommand{\ev}[1]{\ensuremath{\zev({#1})}}

% from general to connected event structures
\newcommand{\zconnes}[0]{\ensuremath{\mathcal{C}}}
\newcommand{\connes}[1]{\ensuremath{\zconnes({#1})}}
% and inclusion
\newcommand{\zinces}[0]{\ensuremath{\mathcal{I}}}
\newcommand{\inces}[1]{\ensuremath{\zinces({#1})}}


% stable version
\newcommand{\zsev}[0]{\ensuremath{\mathcal{E}_S}}
\newcommand{\sev}[1]{\ensuremath{\zsev({#1})}}

% with equivalence
\newcommand{\zeveq}[0]{\ensuremath{\mathcal{E}_{eq}}}
\newcommand{\eveq}[1]{\ensuremath{\zeveq({#1})}}

% es with equivalence to es and vice
\newcommand{\zfuse}[0]{\ensuremath{\mathcal{M}}}
\newcommand{\fuse}[1]{\ensuremath{\zfuse({#1})}}
\newcommand{\zunf}[0]{\ensuremath{\zunf}}
\newcommand{\unf}[1]{\ensuremath{\mathcal{U}({#1})}}



% Winskel/Droste version
\newcommand{\zevwd}[0]{\ensuremath{\mathcal{E}_{wd}}}
\newcommand{\evwd}[1]{\ensuremath{\zevwd({#1})}}




% configurations of an event structure
\newcommand{\conf}[1]{\ensuremath{\mathit{Conf}({#1})}}
% finite configurations
\newcommand{\conff}[1]{\ensuremath{\mathit{Conf_F}({#1})}}

% product of the sets of minimal enablinsg
\newcommand{\pmin}[1]{\ensuremath{U_{#1}}}

% connectectedness of minimal enablinsg
\newcommand{\conn}[1]{\ensuremath{\stackrel{#1}{\frown}}}


% domain for an event structure or graph grammar
\newcommand{\zdom}[0]{\ensuremath{\mathcal{D}}}
\newcommand{\dom}[1]{\ensuremath{\zdom({#1})}}


\newcommand{\zdomeq}[0]{\ensuremath{\mathcal{D}_{eq}}}
\newcommand{\domeq}[1]{\ensuremath{\zdomeq({#1})}}


% partial order for a graph grammar
\newcommand{\poset}[1]{\ensuremath{\mathcal{P}({#1})}}

% stable version
\newcommand{\pdom}[1]{\ensuremath{\mathcal{D}_S({#1})}}
\newcommand{\ppdom}[0]{\ensuremath{\mathcal{D}_S}}


% powerset
\newcommand{\Pow}[1]{\ensuremath{\mathbf{2}^{#1}}}

% powerset of finite subsets
\newcommand{\Powfin}[1]{\ensuremath{\mathbf{2}_\mathit{fin}^{#1}}}

% powerset of subsets of cardinality <= 1
\newcommand{\Powone}[1]{\ensuremath{\mathbf{2}_1^{#1}}}

% integer interval
\newcommand{\interval}[2][1]{\ensuremath{[{#1},{#2}]}}

% domain interval
\newcommand{\dint}[2]{\ensuremath{[{#1},{#2}]}}

% set of intervals
\newcommand{\IntSet}[1]{\ensuremath{\mathop{\mathit{Int}({#1})}}}

% intervals to irreducibles and vice
\newcommand{\inir}{\ensuremath{\mathop{\mathit{\zeta}}}}
\newcommand{\irin}{\ensuremath{\mathop{\mathit{\iota}}}}

% permutations
\newcommand{\perm}{\sigma}

% causes
\newcommand{\causes}[1]{\ensuremath{\lfloor {#1})}}

%%% GRAPH GRAMMARS


\newcommand{\Abs}[1]{\ensuremath{\mathsf{Abs}({#1})}}
\newcommand{\tr}[1]{\ensuremath{\mathsf{Tr}({#1})}}
% fusion safe traces
\newcommand{\trs}[1]{\ensuremath{\mathsf{Tr}_s({#1})}}
%\newcommand{\graph}{\ensuremath{\mathsf{Graph}}}
\newcommand{\tgraph}[1]{\ensuremath{\mathsf{Graph}_{#1}}}
\newcommand{\can}[1]{\ensuremath{\mathsf{C}({#1})}}
% source and target of a derivation
\newcommand{\source}[1]{\ensuremath{\mathsf{s}({#1})}}
\newcommand{\target}[1]{\ensuremath{\mathsf{t}({#1})}}
\newcommand{\col}[1]{\ensuremath{\mathsf{col}({#1})}}

% left decorated trace
\newcommand{\ltrace}[1]{\ensuremath{\langle {#1}\rangle_c}}

\newcommand{\bx}[1]{\phantom{\big(}#1{\phantom{\big)}}}
\newcommand{\bxx}[1]{\,#1\,}
\newcommand{\cycl}[1]{\ensuremath{\mbox{\textcircled{\scriptsize{$#1$}}}}}
\renewcommand{\iff}{\ensuremath{\Leftrightarrow}}

%%%%GENERAL CATEGORICAL NOTATION

\newcommand{\gph}[1]{\mathcal{G}\textbf{\textup{-Graph}}}

\newcommand{\dph}{\mathsf{dph}}
%identitÃ 
\newcommand{\id}[1]{\mathsf{id}_{#1}}
%codominio
\newcommand{\cod}[1]{\mathsf{cod}({#1})}
	%Variabili categorie
\def\A{\textbf {\textup{A}}}
%mono
\newcommand{\mto}[0]{\scalebox{1}{$\rightarrowtail$}}


\newcommand{\sk}{\mathsf{sk}_{\X}}


\def\R{\mathsf{R}}
\def\B{\textbf {\textup{B}}}
\def\C{\textbf {\textup{C}}}
\def\D{\textbf {\textup{D}}}
\def\X{\textbf {\textup{X}}}
\def\Y{\textbf {\textup{Y}}}
\def\G{\textbf {\textup{G}}}

\newcommand{\ske}{\mathsf{sk}(\X)}
\renewcommand{\P}{\textbf {\textup{P}}}

%\derivazioni

\newcommand{\dder}[1]{\mathscr{#1}}
\newcommand{\sder}[2]{S_{i_1,i_2}(\mathscr{#1}, \mathscr{#2})}
\newcommand{\der}[1]{\underline{\dder{#1}}}
\def\dpo{\mathsf{C}^{\X}_R}
\def\gpo{\mathsf{G}^{\X}_R}
\def\dpi{[\mathsf{C}]^{\X}_R}
\def\gpi{[\mathsf{G}]^{\X}_R}

\newcommand{\ider}[1]{\mathscr{I}_{#1}}

%categorie
\def\Set{\textbf {\textup{Set}}}

%comma
\newcommand{\comma}[2]{#1\hspace{1pt} {\downarrow}\hspace{1pt} #2}
\newcommand{\cma}[2]{\mathcal{#1}\hspace{1pt} {\downarrow}\hspace{1pt} \mathcal{#2}}

%derivazioni
\newcommand{\lpro}{\langle \hspace{-1.85pt}[}
\newcommand{\rpro}{]\hspace{-1.85pt}\rangle}
\newcommand{\tpro}[1]{\lpro \der{#1}\rpro}
\newcommand{\tproi}[2]{\lpro \der{#1}_{#2}\rpro}
\newcommand{\lgh}[0]{\mathsf{lg}}

%%% NEW

\usepackage{xparse}

% inversions
\newcommand{\inv}[1]{\mathsf{inv}({#1})}

% sequential independence
\newcommand{\seqind}{\ensuremath{\updownarrow}}


% direct shift
\newcommand{\shift}[1]{\ensuremath{\mathrel{{\leftrightsquigarrow}_{#1}}}}

% shift equivalence
\newcommand{\shifteq}[1][]{\ensuremath{\mathrel{{\equiv}^\mathit{sh}_{#1}}}}

% transp{source}[target]: if target not specified source+1
\NewDocumentCommand{\transp}{m o}{%
  \ensuremath{({#1},%
  \IfNoValueTF{#2}%
    {{#1}+1}%
    {#2}%
    )}
}

\NewDocumentCommand{\mycommand}{o}{%
  % <code>
  \IfNoValueTF{#1}
    {code when no optional argument is passed}
    {code when the optional argument #1 is present}%
  % <code>
}
% interchange
\newcommand{\IC}[1]{\ensuremath{\mathit{IC}({#1})}}

%%%%% Ambienti matematici  %%%%%%
%\newtheorem{theorem}{Theorem}[section]
%\newtheorem{proposition}[theorem]{Proposition}
%\newtheorem{lemma}[theorem]{Lemma}
%\newtheorem{corollary}[theorem]{Corollary}

%\theoremstyle{definition}
%\newtheorem{definition}[theorem]{Definition}
\newtheorem*{notation}{Notation}
%\newtheorem{remark}[theorem]{Remark}
%\newtheorem{example}[theorem]{Example}


% commands for restructuring
\newcommand{\rem}[2]{{\color{blue}#1}{\color{red}#2}}
\renewcommand{\rem}[2]{}


\title{Left-linear rules in adhesive categories}

% fake author for anonymous submission
\author{Alan Turing} 
{Department of Mathematics, Somewhere}
{alan@turing.com}{}{}


% \author{Paolo Baldan} 
% {Department of Mathematics, University of Padova, Italy}
% {baldan@math.unipd.it}{}{}
% \author{Davide Castelnovo}
% {Department of Mathematics, University of Padova, Italy}
% {davide.castelnovo@math.unipd.it}{}{}
% \author{Andrea Corradini}
% {Department of Computer Science, University of Pisa, Italy}
% {andrea.corradini@unipi.it}{}{}

% \author{Fabio Gadducci}
% {Department of Computer Science, University of Pisa, Italy}
% {fabio.gadducci@unipi.it}{}{}


\authorrunning{P.~Baldan, D.~Castelnovo, A.~Corradini, F.~Gadducci}
%
\Copyright{Paolo Baldan, Davide Castelnovo, Andrea Corradini and Fabio Gadducci}
%
\ccsdesc[500]{Theory of Computation~Models of computation}
%
\keywords{
Adhesive categories, double-pushout rewriting, left-linear rules, switch equivalence, local Church-Rosser property.
}

\begin{document}
\maketitle


\begin{abstract}
%  When two sequences of steps executed by a computational device can
%  be considered equivalent?  This is a relevant question if one
%  considers concurrent and distributed systems, since the independence
%  of two steps means that they could be executed in any order, and
%  potentially in parallel.
  When can two sequential steps performed by a computing device be considered (causally) independent? 
  This is a relevant question for concurrent and distributed systems, since independence
  means that they could be executed in any order, and potentially in parallel.
  % 
  We investigate the issue in the context of adhesive categories, a
  very general instance of the DPO approach to rewriting. More
  precisely, we focus on left-linear rules, which not only consume,
  preserve and generate entities, as linear rules do, but may
  ``merge'' parts of the state.
  % 
  An apparently minimal, yet technically hard enhancement, 
  % 
  % We refine the established notion of sequential independence
  % between steps, and ...
  since the canonical notion of independence used for linear rewriting
  systems does not work out of the box, but it requires the
  restriction to well-behaved classes of left-linear rules.
  %
  Moreover, a standard characterisation of independence that -- in the
  linear case -- allows one to derive a number of properties,
  essential in the development of a theory of concurrency, no longer
  holds.
  %and this requires a substantial revision of the theory.
  %
  The paper performs an in-depth study of the notion of independence
  for left-linear rules: it introduces a novel characterisation of
  independence, identifies well-behaved classes of left-linear
  rewriting systems and provides some fundamental results including a
  Church-Rosser property and the existence of canonical equivalence
  proofs for concurrent computations. These results properly extends
  the class of formalisms that can be modelled in the adhesive
  framework.
\end{abstract}


\tableofcontents

\iffalse
\section*{Summary (with dependencies)}

\subsection*{REWRITING}
\begin{itemize}
\item DPO Rewriting in $\mathcal{M}$-adhesive categories, with left-$\mathcal{M}$-linear rules (from now on shortened in ``linear'')\\
  Observe that rewriting is deterministic (by uniqueness of
  PO-complement Corollary~\ref{lem:radj})
  
\item Category of abstract derivation for DPO rewriting system $(\X, \R)$
  \begin{itemize}
  \item \emph{DPO-derivation category} $\dpo$: objects are graphs,
    arrows between possibly empty, derivations.
  \item \emph{DPO-abstract decorated derivation category} $\dpi$
  \end{itemize}
  
  
  
\item \emph{Consistent permutations} (Definition~\ref{def:permcon}):
  permutation on the steps of two abstract decorated derivations and
  isomorphism between the colimits such that arrows into the colimits
  ``commutes''.
  \begin{enumerate}
  \item It is unique for consuming
    rewriting systems (Corollary~\ref{cor:unique})
  \item They can be composed
    (Lemma~\ref{lem:sum})
  \end{enumerate}
\item
  
  
\item Notions of independence\\ We have several
  possibile notions of independence for two direct derivations $\dder{D}
  ; \dder{D'}$
  \begin{enumerate}
    
  \item \emph{Existence of a filler} There
is a filler for $\dder{D} ; \dder{D'}$ (Definition~\ref{def:filler})

\item \emph{Switchable} There is
  $\dder{D}_1' ; \dder{D}_1$ which is a \emph{switch} of $\dder{D} ;
  \dder{D'}$ (Definition~\ref{de:switch}, being a switch is defined
  axiomatically) [actually, Definition~\ref{de:good-switchable} provides
  a definition of switchable which looks different to me, I would avoid
  this, to be checked]
  
\item \emph{(Weakly) Sequential
    independent} There is an \emph{independence pair}
  (Definition~\ref{de:sequential-independence}) They are called
  \emph{strongly sequential independent} if the independence pair is
  unique.
\end{enumerate}

We have that $(1) \Rightarrow (2)$ (Theorem~\ref{prop:fil}) and
$(2) \Rightarrow (3)$ while we expect that in general
$(3) \not\Rightarrow (1)$ (but no counterexample). This is instead
known to hold for linear rules.


Some terminology (Definition~\ref{de:good-switchable})
\begin{itemize}
  
  
\item \emph{Strong Enforcing rewriting systems}\\ An
  independence pairs induced by a filler is called \emph{strong} A
  rewriting system where all indepedence pairs are strong is called
  \emph{strong enforcing}

  NOTE: the categories in which
  condition $B$ from~\cite{baldan2011adhesivity} identifies a large
  class of (quasi)adhesive categories where left-linear systems are all
  strong enforcing. Adapted here to M-adhesivity.
  
\item \emph{Well Switching rewriting
    systems}\\ Strong Enforcing and existing indepence pairs are unique (hence
  switching is unique) (see later for examples)
\end{itemize}


\item \emph{Switch equivalent derivations}
  (concrete)\\
  Definition~\ref{de:switchable}
  
  THEOREM: Two switch equivalent derivations admit a consistent
  permutation (Lemma~\ref{lem:consperm} ??).
  
  A consequence of this used for proving that the slice of traces is a
  pre-order.
  
  The converse holds only when rules are linear [proof clear, but not
  written]  
\end{itemize}

\subsection*{CONCURRENCY}

This part is dealt with for well switching rewriting systems and depends on this assumption. Note that
\begin{itemize}
\item Linear rewriting systems on adhesive categories are well switching
\item Left-linear rewritint systems on graph-like categories with generalisation of (i) no isolated nodes in $L$ and (ii) right leg injective on nodes is well switching
\item Graphs with equivalences (Egg) with left-leg regular mono, right leg mono is well switching
\end{itemize}

We show
\begin{itemize}
  

\item Three-steps lemma (Lemma~\ref{lem:indep-global-left}), which is a weakened version of ``indepedence is global''.
  \begin{itemize}
    
  \item If in $abc$ I have that $ab$ are independent and $c$ is anticipated, they remain independent.
  \item  If in $abc$ I have that $bc$ are independent and $a$ is moved to the end, they remain independent only if there is an additional condition (essentially requiring that $a$ was not a cause of $c$)
  \end{itemize}

  
  
\item No need of useless switchs (if two derivations are switch equivalent I can obtain one from another applying only inversions)
  
\item weak prime domain e connected es semantics
\end{itemize}
\fi

\section{Introduction}

%\todo{A VERY NICE INTRODUCTION}
%
%SOME IDEAS (BADLY WRITTEN, JUST TO START TO PUT IDEAS IN ORDER)

One of the key pay-off of concurrency theory is the idea that the behaviour of 
a computational device can be modelled by abstracting its sequences of steps
%performed by the device 
via a suitable equivalence. Intuitively, the equivalence 
captures when 
%sequential 
steps are causally unrelated and thus could be executed in any 
order, and possibly in parallel. 
%
Two seminal contributions to this line of research have been
Mazurkiewicz's traces~\cite{Mazurkiewicz86} and Winskel's event structures~\cite{NPW:PNES}.
%
Concerning formalisms based on the rewriting paradigm, i.e. where the
behaviour is dictated by a set of rules that have to be instantiated with
the system at hand, concurrency often boils down to having a notion of 
independence between two consecutive steps.
%thus viewing a sequence of steps as a concurrent computation. 
Noteworthy examples are
interchange law~\cite{Mes92} in term rewriting and permutation 
equivalence~\cite{JJL80} in $\lambda$-calculi. 

Among rewriting-based formalisms, those manipulating graph-like structures
proved useful in many settings for representing the dynamics of distributed systems: the 
graph serves to represent the entities and their relations within states, while 
rewriting steps, modifying the graph, model computation steps that result 
in changes to the system state. The DPO (double-pushout) approach~\cite{CMREHL:AAGT} 
is nowadays considered the standard one for these structures, thanks to its locality 
(rule application has a local effect on a state, differently e.g. from the SqPO 
approach~\cite{CorradiniHHK06}) and most importantly to its flexibility: the rules allow to 
specify that,  in a rewriting step, some entities in the current state are removed, 
some others are needed for the rewriting step to occur but remain unaltered and 
some new entities can be generated. Concerning concurrency, the chosen notion 
is shift equivalence, and independence is formally captured by what is called the
Church-Rosser theorem of DPO rewriting~\cite[Section~xxx]{CMREHL:AAGT}.

A noteworthy advantage is that DPO rewriting can be formulated over
adhesive categories and their variants~\cite{lack2005adhesive,ehrig2006weak}. 
%
Operating within the framework of adhesive categories allows one to devise 
the foundations of a rewriting theory that can be subsequently instantiated 
to the context of interest, thus avoiding the need of repeatedly proving
similar ad-hoc results for each specific setting. In fact, the framework is
so general that it allowed to recast in the DPO approach many additional formalisms,
ranging from toposes~\cite{johnstone2007quasitoposes} to string diagrams~\cite{bonchi2022string}.

So far, most of the theoretical results focussed on what are called \emph{linear rules}: 
intuitively, a step is required only to consume, preserve and generate entities. 
However, in some situations it is also necessary to ``merge'' parts of the state. 
This happens already in the context of string diagram mentioned above, but also 
in graphical implementations of nominal calculi where, as a result of name passing, 
the received name is identified with a local one at the
receiver~\cite{CVY:ESSPE,Gad07} or in the visual modelling of bonding in
biological/chemical processes~\cite{PUY:MBPE}. A similar mechanisms is
at the core of e-graphs (equality graphs), recently used for
rewrite-driven compiler optimisations~\cite{WNW:egg}: rather than
explicitly merging nodes corresponding to equal expression, the idea
here -- conceptually and, as we will see, also mathematically similar --
is to maintain an equivalence %\todo{P: more precisely a congruence}
over the nodes.  
%\todo{P: la sequenza di lavori su questo \`e ampia,
%vedere se c'\`e qualcosa d'altro}


Technically, to acquire the expressiveness needed for capturing
fusions, i.e. the merge of some elements in the state, requires to
move from linear to left-linear rewriting rules. While left-linear
rules have been considered in various instances (mainly in categories
of graphs) and some results concerning the corresponding rewriting
theory have been put forward, to the best of our knowledge the
phenomena arising when devising a theory of indepedence and
concurrency for rewriting with left-linear rules in the general
setting of adhesive and quasi-adhesive categories
%(which capture most ``applications'') 
have not been systematically
explored~\cite{Ehrig1976,EHP:BRfTToHLRS,baldan2011adhesivity} \todo{P: see also \cite{HMP:DPORADD,BHK:CTNL} ... verificare e aggiungere}

Here we perform this exploration working at the level of $\mathcal{M}$-adhesive categories, 
%i.e.such that adhesivity holds only for a class $\mathcal{M}$ of arrows, 
which encompass a large family of DPO-based formalisms adopted by pratictioners~\cite{xxx}. 

As an initial step, % in performing this exploration, 
we observe that for
left-linear rules a number of fundamental properties that play a role
in the concurrency theory of linear rewriting need to be deeply revised, or
plainly do not hold.
%
Firstly, the notion of sequential independence and Church Rosser
theorem, ensuring that sequential independent steps can be performed
in reverse order, does not hold out of the box. Even worse, given two
independent steps it might be possible to switch them in several
different ways. As we will observe, this might prevent the development
of a sensible theory of concurrency as switches are used as a basis
for equating sequences of rewriting steps that differs only for the order of independent
steps.

We single out a class of left-linear rewriting
systems, referred to as \emph{well-switching rewriting systems}, where sequential independence ensures existence and uniqueness of the
switch, and argue that this is the right setting for dealing with
left-linear rewriting systems.


On the one hand, they capture most categories of
interest for rewriting. In particular, we single out a class of
left-linear rewriting systems on graph-like structures that are
well-switching and we show that rewriting systems on graphs with
equivalences are so. 
As a sanity check, we prove that linear rewriting systems on
$\mathcal{M}$-adhesive categories are well-switching.

On the other hand, we show that a concurrency theory of rewriting can
be developed for well-switching rewriting systems, recovering, sometimes in
weakened form, results which hold in the linear case.  Specifically, 
the Church-Rosser theorem is fully recovered.
%for well-switchable rewriting systems.


There is, however, a further problem.  For linear
rewriting systems, switch equivalence can be characterised in terms of the
existence of what is called a consistent permutation~\cite{xxx}.
%(roughly, an isomorphism between their colimits). 
This result, which
is folklore for various categories of graphs, is explicitly proved
here for $\mathcal{M}$-adhesive categories.
%
The characterisation of switch equivalence based on consistent
permutations is the key to derive some
properties for linear rewriting systems, namely
\begin{enumerate}
\item \emph{consistency of switching}: when transforming
  sequences of rewriting steps into equivalent ones by switching independent steps, the
  result not depends on the order in which switchings are applied, but
  only on the resulting permutation;
\item \emph{globality of independence}: if two independent steps are
  moved forward or backward due to the application of switchings to a
  derivation, they remain independent.
\end{enumerate}
Properties (1) and (2) allow one to deduce a canonical form for equivalence proofs 
between sequences of rewriting steps seen as concurrent computations.

Unfortunately, for left-linear rewriting systems the characterisation
of switch equivalence based on consistent permutations fails: the
existence of a consistent permutation is only necessary but not
sufficient, hence it cannot be used for proving (1) and (2).
%
This leads to the question asking whether the properties above hold.
We show that actually much of the theory can be retained: consistency
of switching still holds, while globality of independence holds in a
weak form, conceptually linked to the fact that fusions introduce a
form of disjunctive causality. Finally, a canonical form for switching
sequences can also be recovered.



% \todo[inline]{
% This fails for left-linear rules where, as observed
% in~\cite{baldan2017domains}, for graph rewriting, the possibility of
% merging parts of the state leads to a sort of disjunctive causality,
% i.e., a rewriting step, say $r_c$ can be enabled by two different
% rewriting steps $r_a$ and $r_b$, in a way that in a derivation
% $r_a r_b r_c$ steps $r_b$ and $r_c$ are independent since the presence
% of $r_a$ in the past is sufficient for enabling $r_a$, while in
% $r_b r_c r_a$ , the steps $r_b$ and $r_c$ are not independent.
% }

% \todo[inline]{
% DA RIUSARE\\
% Firstly, Church-Rosser theorem does not work out of the box. In
% particular, sequential independence between rewriting steps~\cite{}
% expressed in terms of the existence of a so-called independence pair
% is a canonical and well-understood notion of independence in the
% linear case. \todo{P: Too technical? Forse qui e' piu' esplicativo un
%   esempio} Whenever two steps are sequential independent
% \begin{itemize}
% \item they can be switched and 
% \item the result of the switch is uniquely determined.
% \end{itemize}
% Here we observe that, in general, both property can fail: sequential
% independent steps could be not switchable and different independent
% pairs could exist leading to different switches of the same rewriting
% steps.  A refined notion of independence needs to be considered to ensure
% that independent rewriting steps can be switched, which is based in the concept
% of fillers. The problem was identified
% in~\cite{baldan2011adhesivity}, where a subclass of adhesive
% categories was identified where independence as induced by a filler
% coincides with sequential independence (as induced by an independence
% pair). Here it is extended to $\mathcal{M}$-adhesive categories.
% }

%   First of all, we will provide a refined notion of independence,
%   which is based in the concept of fillers.

% Then, we move to restrict the class of admissible left-linear rewriting systems,
% always working at the level of $\mathcal{M}$-adhesive categories.
% Unfortunately, the most natural idea, put forward in~\cite{baldan2017domains}, 
% of limiting sequential independence to those cases in which the switch is possible
% and uniquely determined does fall short.





\section{$\mathcal{M}$-adhesive categories and DPO rewriting systems}\label{sec:ade}

This first section recalls definitions and basic theory of \emph{$\mathcal{M}$-adhesive categories} \cite{azzi2019essence,ehrig2012,ehrig2014adhesive,lack2005adhesive,heindel2009category}.

\begin{notation}
  We stipulate some notational conventions that will be used
  throughout the paper.
  \begin{itemize}
  \item
    Given a category $\X$ we will not distinguish notationally
    between $\X$ and its class of objects: so that ``$X\in \X$'' means
    that $X$ belongs to the class of objects of $\X$.

  \item
    If $1$ is a terminal object in $\X$, the unique
    arrow $X\to 1$ from an object $X$ will be denoted by
    $!_X$. Similarly, if $0$ is initial in $\X$ then $?_X$ will denote
    the unique arrow $0\to
    X$. %When $\X$ is $\Set$ and $1$ is a singleton, $\delta_x$ will denote the arrow $1\to X$ with value $x\in X$.

  \item $\mor(\X)$, $\mon(\X)$ and $\reg(\X)$ will denote the class of
    all arrows, monos and regular monos of $\X$, respectively.

  \item Given an integer $n\in \mathbb{Z}$, $[0,n]$ will denote the
    set of natural numbers less than or equal to $n$, assuming that
    $[0,n]=\emptyset$ whenever $n<0$.
  \end{itemize}
\end{notation}


\subsection{$\mathcal{M}$-adhesivity}\label{subsec:ade}
The key property that $\mathcal{M}$-adhesive categories enjoy is given
by the so-called \emph{Van Kampen condition}
\cite{brown1997van,johnstone2007quasitoposes,lack2005adhesive}. We
will recall it and examine some of its consequences. First of all, we
need to recall some terminology and facts regarding subclasses of
$\mor(\X)$.

\begin{definition}
  Let $\X$ be a category and $\mathcal{A}$ a subclass of
  $\mor(\X)$. We say that $\mathcal{A}$ is
  \begin{itemize}
    \parbox{11cm}{\item
      \emph{stable under pushouts (pullbacks)} if for every pushout (pullbacks) square as the one on the right, 	if $m \in \mathcal{A}$ ($n\in \mathcal{A}$) then $n \in \mathcal{A}$ ($m \in \mathcal{A}$);
    \item \emph{closed under composition} if $g, f\in \mathcal{A}$ implies $g\circ f\in \mathcal{A}$ whenever $g$ and $f$ are composable.{\tiny }}\hfill
    \parbox{2cm}{$\xymatrix{A\ar[r]^f  \ar[d]_{m}& B \ar[d]^n \\ C \ar[r]_g & D}$}
    \parbox{11cm}{}\hfill
  \end{itemize}
\end{definition}

So equipped, we can introduce the notion of \emph{$\mathcal{A}$-Van Kampen square}.

\noindent
\parbox{10cm}{
  \begin{definition}[Van Kampen property]
    Let $\X$ be a category and consider the two diagrams aside.
 %   
%    \hspace{15pt}
    Given  a class of arrows $\mathcal{A}\subseteq \mor(\X)$, we say that the bottom square
    % \emph{has the Van Kampen property relatively to $\mathcal{A}$}, or that it
    is an \emph{$\mathcal{A}$-Van Kampen square} if
    \begin{enumerate}
    \item it is a pushout square;
    \item 	whenever the cube above has pullbacks as back and left faces and the vertical arrows belong to $\mathcal{A}$, then its top face is a pushout 
    if and only if the front and right faces are pullbacks.
    \end{enumerate}
    Pushout squares which enjoy the ``if'' half of item (2) above are called \emph{$\mathcal{A}$-stable}.
    
    We will call a $\mor(\X)$-Van Kampen ($\mor(\X)$-stable) square simply a \emph{Van Kampen} (\emph{stable}) square.
  \end{definition}}
\parbox{2cm}{$\xymatrix@C=10pt@R=10pt{&A'\ar[dd]|\hole_(.65){a}\ar[rr]^{f'} \ar[dl]_{m'} && B' \ar[dd]^{b} \ar[dl]_{n'} \\ C'  \ar[dd]_{c}\ar[rr]^(.7){g'} & & D' \ar[dd]_(.3){d}\\&A\ar[rr]|\hole^(.65){f} \ar[dl]^{m} && B \ar[dl]^{n} \\C \ar[rr]_{g} & & D \\A \ar[dd]_{m}\ar[rr]^{f}&&B\ar[dd]^{n}\\ \\C\ar[rr]_{g} &&D}$ }


We can now define $\mathcal{M}$-adhesive categories.

\begin{definition}[$\mathcal{M}$-adhesive category]
  Let $\X$ be a category and $\mathcal{M}$ a subclass of
  $\mon(\X)$
  % \begin{enumerate}
  % \item $\mathcal{M}$
  including  all isomorphisms, closed under composition,
  % \item $\mathcal{M}$
  and stable under pullbacks and pushouts.
  % \end{enumerate} 
  The category
  % 
  $\X$ is said to be \emph{$\mathcal{M}$-adhesive} if
  \begin{enumerate}
  \item it has \emph{$\mathcal{M}$-pullbacks}, i.e. pullbacks along arrows of $\mathcal{M}$;
  \item it has \emph{$\mathcal{M}$-pushouts}, i.e. pushouts along arrows of $\mathcal{M}$;
  \item  $\mathcal{M}$-pushouts are $\mathcal{M}$-Van Kampen squares.
  \end{enumerate}
  
  A category $\X$ is said to be \emph{strictly $\mathcal{M}$-adhesive}
  if $\mathcal{M}$-pushouts are Van Kampen squares.
\end{definition}

We will use $m\colon X\mto Y$ to denote that an arrow $m\colon X\to Y$ belongs to $\mathcal{M}$.

\begin{remark}
  \label{rem:salva}
  \emph{Adhesivity} and \emph{quasiadhesivity} 
  \cite{lack2005adhesive,garner2012axioms} coincide with strict
  $\mon(\X) $-adhesivity and strict $\reg(\X)$-adhesivity,
  respectively.
  % for $\reg(\X)$ the class of regular monos.
\end{remark}

\begin{example}
  \label{rem:iso}
  Let $\mathsf{Iso(\X)}$ be the class of 
  isomorphisms. Any category $\X$ is $\mathsf{Iso(\X)}$-adhesive.
\end{example}

%\todo{P: qui probabilmente si puo' compattare tenendo solo cio' che si usa}
%\todo{Si usa tutto per la classe B+ [DC]}
%$\mathcal{M}$-adhesivity is well-behaved with respect to  the comma construction \cite{mac2013categories}, as shown by the following theorem.
%\begin{theorem}[\cite{ehrig2006fundamentals,lack2005adhesive}]\label{lem:comma}
  %Let $\A$ and $\B$ be respectively an $\mathcal{M}$-adhesive and an
  %$\mathcal{M}'$-adhesive category. Let also $L:\A\rightarrow \C$ be a
  %functor that preserves $\mathcal{M}$-pushouts, and
  %$R:\B\rightarrow \C$ be a functor which preserves pullbacks.Then
 % $\comma{L}{R}$ is $\cma{M}{M'}$-adhesive, where
  %\[
    %\cma{M}{M}':=\{(h,k)\in \mathcal{A}(\comma{L}{R}) \mid h\in
    %\mathcal{M}, k\in \mathcal{M}'\}\]
%\end{theorem}
$\mathcal{M}$-adhesivity is well-behaved with respect to  the construction of slice and functor caregories \cite{mac2013categories}, as shown by the following theorems \cite{ehrig2006fundamentals,lack2005adhesive}.

%\begin{theorem}
%[\cite{ehrig2006fundamentals,lack2005adhesive}]
%\label{lem:comma}
  %Let $\A$ and $\B$ be respectively an $\mathcal{M}$-adhesive and an
 % $\mathcal{M}'$-adhesive category. Let also $L:\A\rightarrow \C$ be a
  %functor that preserves $\mathcal{M}$-pushouts, and
  %$R:\B\rightarrow \C$ a functor that preserves pullbacks.Then
  %$\comma{L}{R}$ is $\cma{M}{M'}$-adhesive, where
  %\[
    %\cma{M}{M}':=\{(h,k)\in \mathcal{A}(\comma{L}{R}) \mid h\in
   % \mathcal{M}, k\in \mathcal{M}'\}\]
%\end{theorem}

\begin{theorem}\label{cor:slice}
  Let $X$ be an object of an $\mathcal{M}$-adhesive category
  $\X$. Then $\X/X$ and $X/\X$ are, respectively, $\mathcal{M}/X$-
  and $X/\mathcal{M}$-adhesive, where
  \[\mathcal{M}/X:=\{m\in \mathcal{A}(\X/X) \mid m\in \mathcal{M} \}
    \qquad X/\mathcal{M}:=\{m\in \mathcal{A}(X/\X) \mid m\in
    \mathcal{M} \}
  \]
\end{theorem}


\begin{theorem}
  \label{thm:functors}
  Let $\X$ be an $\mathcal{M}$-adhesive category. Then for every small
  category $\Y$, the category $\X^\Y$ of functors $\Y\to \X$ is
  $\mathcal{M}^{\Y}$-adhesive, where
  \[\mathcal{M}^{\Y}:=\{\eta \in \mathcal{A}(\X^\Y) \mid \eta_Y \in
    \mathcal{M} \text{ for every } Y\in \Y\}\]
\end{theorem}

We can list various examples of $\mathcal{M}$-adhesive categories (see
\cite{castelnovo2023thesis,CastelnovoGM22,lack2006toposes}).


\begin{example}
  \label{ex:adhesive}
  Every topos is adhesive~\cite{lack2006toposes}, thus in particular
  $\cat{Set}$ is adhesive. By the closure properties recalled before,
  every presheaf $[\cat{X},\cat{Set}]$ is adhesive and in particular
  the category $\cat{Graph} = [ E \rightrightarrows V, \cat{Set}]$ is
  adhesive where $E \rightrightarrows {V}$ is the two object category
  with two morphisms $s,t \colon{E} \to {V}$. In a similar way,
  various categories of hypergraphs can be shown to be adhesive, 
  such as term graphs and hierarchical graphs~\cite{CastelnovoGM24},
  as well as the category $\cat{sGraphs}$ of simple graphs, i.e. graphs without
  parallel edges, is $\reg{(\cat{sGraphs})}$-adhesive~\cite{xxx}
.%\todo{Add reference for simple graphs, add
 %   hierarchical graphs and term
 %   graphs\cite{castelnovo2023thesis,CastelnovoGM22}).}
\end{example}


A number of properties of adhesive categories that play a role in the
theory of rewriting generalise to $\mathcal{M}$-adhesive
categories. These include $\mathcal{M}$-pushout-pullback decomposition
and uniqueness of pushouts complements (details and proofs are in
\Cref{app:ade}).

\subsection{DPO rewriting systems derivations}\label{subsec:DPO}

$\mathcal{M}$-adhesive categories are the right context in which to
perform abstract rewriting using what is called the ``double pushout
approach'' (DPO). We will recall the basic definitions and properties
of this approach to abstract rewriting.


\begin{definition}[\!\!\cite{habel2012mathcal,heindel2009category}]
  Let $\X$ be an $\mathcal{M}$-adhesive category. A \emph{left
    $\mathcal{M}$-linear} rule $\rho$ is a pair $\rho = (l,r)$ of
  arrows with $l: K \to L$ and $r: K \to R$, such that $l$ belongs to
  $\mathcal{M}$.  The rule $\rho$ is \emph{$\mathcal{M}$-linear} if
  $r\in \mathcal{M}$ too.
  %
  \full{A rule $\rho$ is said to be
    \emph{consuming} if $l$ is not an isomorphism.}%
  %
  The object $L$ is
  the \emph{left-hand side}, $R$ is the \emph{right-hand side}, and
  $K$ the \emph{interface}. 
  % \emph{glueing object}.   AC: sempre chiamato interface

  A \emph{left-linear DPO rewriting system} is a pair $(\X, \R)$ where
  $\X$ is an $\mathcal{M}$-adhesive category and $\R$ is a set of left
  $\mathcal{M}$-linear rules. The rewriting system $(\X, \R)$ is
  called \emph{linear}
  %
  \full{\emph{(consuming)}}
  %
  if every rule in $\R$ is
  $\mathcal{M}$-linear.
  \full{(consuming)}

  \noindent
  \parbox{10cm}{\hspace{15pt}Given two objects $G$ and $H$ and a rule
    $\rho=(l,r)$ in $\R$, a \emph{direct derivation $\mathscr{D}$ from
      $G$ to $H$ applying the rule $\rho$} is a diagram as the one
    aside, in which both squares are pushouts. The arrow $m$ is called
    the \emph{match} of the derivation, while $h$ is its
    \emph{back-match}.  We will denote a direct derivation $\dder{D}$
    between $G$ and $H$ as $\dder{D}\colon G\Mapsto H$. }
  \parbox{3cm}{$\xymatrix{L \ar[d]_{m}& K \ar[d]^{k}\ar@{>->}[l]_{l}
      \ar[r]^{r} & R \ar[d]^{h}\\G & \ar@{>->}[l]^{f} D \ar[r]_{g}&
      H}$}
\end{definition}


\full{
  %
  If we look at direct derivations as
  transitions, it is natural to consider them as edges in a direct
  graph. Taking objects as vertices leads us to the following
  definition \cite{heindel2009category}.

  \begin{definition}
    Let  $\X$ be an $\mathcal{M}$-adhesive category and 
    $(\X, \R)$ a left-linear DPO rewriting system. 
    The \emph{DPO-derivation graph} of
    $(\X, \R)$ is the (large) directed graph $\gpo$ having as vertices
    the objects of $\X$ and in which an edge between $G$ and $H$ is a
    direct derivation $\dder{D}\colon G\Mapsto H$. A \emph{derivation}
    $\der{D}$ between two objects $G$ and $H$ is a path between them
    in $\gpo$. The \emph{source} and \emph{target} of $\der{D}$ are,
    respectively, $G$ and $H$.
  \end{definition}
}

A derivation can now be defined simply as a sequence of direct derivations.

\begin{definition}[Derivation]
  Let  $\X$ be an $\mathcal{M}$-adhesive category and 
  $(\X, \R)$ a left-linear DPO rewriting system. 
  Given $G, H \in \X$, a \emph{derivation}
  $\der{D}$ with source $G$ and target $H$, written
  $\der{D}: G \Mapsto H$, is defined as a sequence
  $\{\dder{D}_i\}_{i=0}^n$ of direct derivations such that
  \begin{enumerate}
  \item $\dder{D}_i : G_i \Mapsto G_{i+1}$ is a direct derivation for
    every index $i$;
  \item $G_0=G$ and $G_{n+1}=H$.
  \end{enumerate}
  Moreover, we have an \emph{empty derivation} $G : G \Mapsto G$ for each $G \in \X$.
  %
  We will denote by $\lgh(\der{D})$ the \emph{length} of derivation $\der{D}$.
 %
  \full{We will call the number $n+1$ the \emph{length} of the derivation,
  denoted by $\lgh(\der{D})$. We will also say that an empty
  derivation has length $0$.}

 Given a derivation $\der{D}=\{\dder{D}_i\}_{i=0}^n$, we define $r(\der{D})  = \{\rho_i\}_{i=0}^n$ as the sequence of 
 rules such that every $\dder{D}_i$ applies rule $\rho_i\in \R$.  
%  Moreover, if every $\dder{D}_i$ applies the rule $\rho_i\in R$, then
 % we can define an associated sequence of rules as $r(\der{D})$ as
 % $\{\rho_i\}_{i=0}^n$.
\end{definition}

Derivations naturally compose: given $\der{D}: G \Mapsto H$ and $\der{E}: H \Mapsto F$ we can consider their composition $\der{D} \cdot \der{E}: G \to F$, defined in the obvious way.

% \todo[inline]{P: se non impatta sul resto forse sarebbe forse piu' carino definire:\\
%   - for each $G \in \X$, $G : G \Mapsto G$ is a derivation\\  
%   - for each direct derivation $\dder{D}: G \Mapsto H$ and derivation $\der{E} : H \Mapsto F$ we have that $\dder{D}; \der{E} : G \Mapsto F$ is a derivation
% }

\rem{Suppongo questo serva quando poi si considerano le permutazioni consistenti, spostare? }{
\begin{remark}
  \label{rem:func}
  Consider a derivation $\der{D}$ in a left-linear DPO rewriting
  system $(\X, \R)$. We can take the subcategory $\Delta(\der{D})$ of
  $\X$ given by the arrows appearing in $\der{D}$. This subcategory
  comes equipped with an inclusion functor
  $I(\der{D})\colon \Delta(\der{D})\to \X$. Moreover, we can further
  define $\Deltamin(\der{D})$ as the subcategory of $\Delta(\der{D})$
  containing only the bottom row of the derivation.\todo{Used?}
\end{remark} 

\noindent
\parbox{10cm}{%
  \begin{notation}
    Let $\der{D}=\{\dder{D}_i\}_{i=0}^n$ be a derivation. We will
    depict the $i^\text{th}$ element $\dder{D}_i$ of $\der{D}$ as in
    the diagram on the right. Notice that, in particular, if $\der{D}$
    is a derivation between $G$ and $H$, then $G_0=G$ and
    $G_{n+1}=H$. When $\der{D}$ has length $1$ we will suppress the
    indexes. In such case, we will also identify $\der{D}$ with its
    only element.
  \end{notation} }
\parbox{3cm}{
  $\xymatrix{L_i \ar[d]_{m_i}& K_i
    \ar[d]^{k_i}\ar@{>->}[l]_{l_i} \ar[r]^{r_i} & R_i \ar[d]^{h_i}\\
    G_{i} & \ar@{>->}[l]^{f_{i}} D_{i} \ar[r]_{g_{i}}& G_{i+1} }$
}
}

Often, we are interested in derivations only up to some notion of coherent isomorphism between them. This leads us to the following definition. 

\noindent
\parbox{8cm}{
  \begin{definition}
    Let  $\X$ be an $\mathcal{M}$-adhesive category and 
    $(\X, \R)$ a left-linear DPO rewriting system. 
    An \emph{abstraction equivalence} between two derivations $\der{D}$
    and $\der{D'}$ with the same length and
    $r(\der{D})=r(\der{D}')$, is a family of isomorphisms
    $\{\phi_X\}_{X\in \{G_i,D_i,H_i\}}$ such that the diagram on the right commutes
    for every $i\in [0, \lgh(\der{D})]$. We
    will say that $\der{D}$ are $\der{D}'$ are \emph{abstraction
      equivalent}, and use the symbol $\der{D}\equiv_a \der{D}'$, if there exists an abstraction equivalence between
    them.
  \end{definition}
}
\parbox{4cm}{\vspace{-1.35em}$\xymatrix@C=40pt{G'_i&D'_i \ar[r]^{g'_i}
    \ar@{>->}[l]_{f'_i}&G'_{i+1}\\ L_i \ar[u]^{m'_i} \ar[d]_{m_i}& K_i
    \ar[u]^{k'_i} \ar[d]_{k_i} \ar[r]^{r_i} \ar@{>->}[l]_{l_i}
    &R_i \ar[u]^{h'_i} \ar[d]_{h_i}\\G_i
    \ar@/_.45cm/[uu]_(.35){\phi_{G_i}}|\hole&D_i\ar@{>->}[l]^{f_i}\ar@/_.45cm/[uu]_(.35){\phi_{D_i}}|\hole
    \ar[r]_{g_i}&G_{i+1}\ar@/_.45cm/[uu]_{\phi_{G_{i+1}}}}$}



\todo{P: sopra era $X \in\Deltamin(\der{D})$, non definito nel main}


$\mathcal{M}$-adhesivity of $\X$ guarantees the essential uniqueness of
the result obtained by applying a rule to an object, as shown by the next
proposition.


\begin{restatable}{proposition}{propUnique}
  \label{prop:unique}
  Let $\X$ be a $\mathcal{M}$-adhesive category. Suppose that the two
  direct derivations $\dder{D}$ and $\dder{D}'$ below, with the same
  match and applying the same left-linear rule $\rho$ are given
  \[\xymatrix{L \ar[d]_{m}& K \ar[d]^{k}\ar@{>->}[l]_{l} \ar[r]^{r} &
      R \ar[d]^{h} & L \ar[d]_{m}& K \ar[d]^{k'}\ar@{>->}[l]_{l}
      \ar[r]^{r} & R \ar[d]^{h'}\\G & \ar@{>->}[l]^{f} D \ar[r]_{g}& H
      & G & \ar@{>->}[l]^{f'} D' \ar[r]_{g'}& H'}\]
  Then there is an abstraction equivalence between $\dder{D}$ and
  $\dder{D}'$, whose first component is $\id{G}$.
\end{restatable}

[Proof in \Cref{propUnique-proof}]


\iffalse
\subsection{Consistent permutations}

Given DPO rewriting system $(\X, \R)$,  a derivation $\der{D}$ determines a diagram
$\Delta(\der{D})$ in $\X$. Using $\mathcal{M}$-adhesivity, it can be shown  that such diagram has a colimit $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D})})$ and that, if $(\X, \R)$ is linear, then every coprojection is in $\mathcal{M}$ ( see \Cref{lem:colim} for details and a proof of these statements).


So equipped, we can introduce the notion of \emph{consistent permutation}.

\begin{definition}[Consistent permutation]
  \label{def:permcon}
  Let $\X$ be an $\mathcal{M}$-adhesive category and consider a
  left-linear DPO rewriting system $(\X, \R)$ on it.  Take two
  non-empty decorated derivations $(\der{D}, \alpha, \omega)$ and
  $(\der{D}', \alpha', \omega')$ with the same length and with
  isomorphic sources and targets.

  If $\der{D}=\{\dder{D}_i\}_{i=0}^n$ and
  $\der{D}'=\{\dder{D}'_i\}_{i=0}^n$ with associated sequence of rules
  $r(\der{D})=\{\rho_i\}_{i=0}^n$ and
  $r(\der{D}')=\{\rho'_i\}_{i=0}^n$, a \emph{consistent permutation}
  between $(\der{D}, \alpha, \omega)$ and
  $(\der{D}', \alpha', \omega')$ is a permutation
  $\sigma\colon [0,n]\to [0,n]$ such that, for every $i\in [0,n]$,
  $\rho_i=\rho'_{\sigma(i)}$ and, moreover, there exists a
  \emph{mediating isomorphism}
  $\xi_\sigma\colon \tpro{D} \to \lpro \der{D}' \rpro$ fitting in the
  following diagrams, where $m_i, m'_i, h_i$ and $h'_i$ are,
  respectively, the matches and back-matches of $\dder{D}_i$ and
  $\dder{D}'_i$.

  \[
    \xymatrix@C=30pt{\pi(G_0)\ar[r]^{\alpha} \ar[d]_{\alpha'} & G_0
      \ar[r]^{\iota_{G_0}} &\tpro{D} \ar[d]^{\xi_\sigma}& \pi(G_{n+1})
      \ar[r]^{\omega} \ar[d]_{\omega'} & G_{n+1}
      \ar@{>->}[r]^{\iota_{G_{n+1}}} &\tpro{D} \ar[d]^{\xi_\sigma}\\
      G'_0 \ar[rr]_{\iota'_{G'_0}} & &\lpro \der{D}' \rpro& G'_{n+1}
      \ar@{>->}[rr]_{\iota'_{G'_{n+1}}} & &\lpro \der{D}' \rpro\\L_i
      \ar[r]^{m_i} \ar[d]_{m'_{\sigma(i)}}& G_i \ar[r]^{\iota_{G_i}}
      &\tpro{D} \ar[d]^{\xi_\sigma} & R_i \ar[r]^{h_i}
      \ar[d]_{h'_{\sigma(i)}}& G_{i+1} \ar[r]^{\iota_{G_{i+1}}}
      &\tpro{D} \ar[d]^{\xi_\sigma} \\G'_{\sigma(i)}
      \ar[rr]_{\iota'_{G'_{\sigma(i)}}}&& \lpro \der{D}' \rpro&
      G'_{\sigma(i)+1} \ar[rr]_{\iota'_{G'_{\sigma(i)+1}}}&& \lpro
      \der{D}' \rpro}
  \]
\end{definition}

\begin{remark}
  The commutativity of the last two rectangles in \Cref{def:permcon},
  is equivalent to the commutativity of the following bigger diagram.
  \[
    \xymatrix@C=40pt{
      G_i\ar@/^1cm/[rrr]^{\iota_{G_{i}}}&D_i\ar@/^.4cm/[rr]^(.35){\iota_{D_i}}
      \ar[r]_{g_i} \ar@{>->}[l]^{f_i}&G_{i+1}
      \ar[r]_{\iota_{G_{i+1}}}&\tpro{D} \ar[dd]^{\xi_\sigma}\\ L_i
      \ar[u]^{n_i} \ar[d]_{n'_{\sigma(i)}}& K_i
      \ar[d]^{k'_{\sigma(i)}} \ar[u]_{k_i} \ar[r]^{r_i}
      \ar@{>->}[l]_{l_i} &R\ar[u]^{h_i}
      \ar[d]_{h'_{\sigma(i)}}\\G'_{\sigma(i)}\ar@/_1cm/[rrr]_{\iota'_{G'_{\sigma(i)}}}
      &D'_{\sigma(i)}\ar@{>->}[l]_{f'_{\sigma(i)}} \ar[r]^{g'_i}
      \ar@/_.4cm/[rr]_(.35){\iota'_{D'_{\sigma(i)}}}&G'_{\sigma(i)+1}
      \ar[r]^{\iota'_{G'_{\sigma{i}+1}}}& \lpro\der{D}' \rpro }
  \]
  This follows at once from the following chain of identities:
  \begin{align*}
    \xi_\sigma \circ \iota_{D_i}\circ k_i & =\xi_\sigma \circ \iota_{G_{i}} \circ f_i \\&= \xi_\sigma \circ \iota_{G_{i}}\circ m_i \circ l_i\\&=\iota_{G'_{\sigma(i)}}\circ m'_i\circ l_i\\&=\iota_{G'_{\sigma(i)}}\circ f'_{\sigma(i)}\circ k'_i\\&=\iota_{D'_\sigma(i)}\circ k_i'
  \end{align*}
\end{remark}

\begin{remark}\label{rem:coproj}
  Notice that, in particular, the previous diagram entails
  \[\xi_\sigma \circ \iota_{L_i}=\iota'_{L_{\sigma(i)}} \quad \xi_\sigma \circ \iota_{K_i}=\iota'_{K_{\sigma(i)}} \quad \xi_\sigma \circ \iota_{R_i}=\iota'_{R_{\sigma(i)}} \]
\end{remark}

The previous remark allows us to prove the following.

\begin{proposition}
  \label{prop:isouno}
  For every consistent permutation $\sigma$ between
  $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$, the
  mediating isomorphism
  $\xi_\sigma\colon \tpro{D}\to \lpro \der{D}'\rpro$ is unique.
\end{proposition}
\begin{proof} Let $\xi'_\sigma$ be another mediating isomorphism, then
  by \Cref{rem:coproj} we have
  \[\begin{split}
      \xi_\sigma \circ \iota_{L_i}&=\iota'_{L_{\sigma(i)}}\\&=\xi'_\sigma\circ \iota_{L_i}
    \end{split} \qquad \begin{split}
      \xi_\sigma \circ \iota_{K_i}&=\iota'_{K_{\sigma(i)}}\\&=\xi'_\sigma\circ \iota_{K_i}
    \end{split} \qquad \begin{split}
      \xi_\sigma \circ \iota_{R_i}&=\iota'_{R_{\sigma(i)}}\\&=\xi'_\sigma\circ \iota_{R_i}
    \end{split}\]
  
  Now, notice that
  \begin{align*}
    \xi_\sigma \circ \iota_{G_0} & =\iota'_{G'_0}\circ \alpha'\circ \alpha^{-1} \\&=\xi'_\sigma \circ \iota_{G_0}
  \end{align*}
  
  If $\lgh(\der{D})=0$ this is enough to conclude, otherwise we are going to prove by induction that, for every $i\in [0, \lgh(\der{D})-1]$
  \[
    \xi_\sigma \circ \iota_{G_i}=\xi'_\sigma\circ \iota_{G_i}
  \]
  
  \smallskip \noindent $i=0$. This is simply the result obtained before.
  
  \smallskip \noindent $i >0$. If $i>0$, we know that there is a pushout square
  \[\xymatrix{K_{i-1}\ar[r]^{r_{i-1}} \ar[d]_{k_{i-1}}& R_{i-1} \ar[d]^{h_{i-1}}\\ D_{i-1} \ar[r]_{g_{i-1}}& G_i}\]
  By \Cref{rem:coproj} and the induction hypothesis we know that
  \[\begin{split}
      \xi_\sigma \circ \iota_{G_i}\circ h_{i-1}&=  \xi_\sigma\circ \iota_{R_{i-1}}\\&=\iota'_{R_{\sigma(i-1)}}\\&=\xi'_{\sigma}\circ \iota_{R_{i-1}}\\&=\xi'_{\sigma} \circ \iota_{G_i}\circ h_{i-1}\\&
    \end{split} \qquad
    \begin{split}
      \xi_\sigma \circ \iota_{G_i}\circ g_{i-1}&=\xi_{\sigma}\circ \iota_{D_{i-1}}\\&=\xi_{\sigma}\circ \iota_{G_{i-1}} \circ f_{i-1}\\&=\xi'_{\sigma}\circ \iota_{G_{i-1}} \circ f_{i-1}\\&=\xi'_{\sigma}\circ \iota_{D_{i-1}} \\&=\xi'_{\sigma}\circ \iota_{G_{i}} \circ g_{i-1}
    \end{split}
  \]
  
  Since $\xi_\sigma \circ \iota_{D_i}$ must be $\xi_\sigma \circ \iota_{G_i}\circ f_i$, we also have
  \[\xi_\sigma \circ \iota_{D_i}=\xi'_\sigma \circ \iota_{D_i}\]
  and the thesis follows.
\end{proof}


\begin{remark}
  \label{rem:inversa}
  Let $\sigma\colon [0,n]\to [0,n]$ be a consistent permutation
  between $(\der{D},\alpha, \omega)$ and
  $(\der{D}', \alpha', \omega')$, then its inverse $\sigma^{-1}$ is a
  consistent permutation between $(\der{D}', \alpha', \omega')$ and
  $(\der{D},\alpha, \omega)$. Indeed, it is enough to consider, as
  mediating isomorphism, the inverse $\xi^{-1}_\sigma$ of
  $\xi_\sigma$.
\end{remark}

\begin{remark}
  \label{rem:comp}
  Consistent permutations can be composed. Indeed, given decorated
  derivations $(\der{D}, \alpha, \omega)$,
  $(\der{D}', \alpha', \omega')$ and
  $(\der{\hat{D}}, \hat{\alpha}, \hat{\omega})$ all of length $n$, if
  $\sigma$ is a consistent permutation between the first two and
  $\tau$ one between the second and the third, then we have diagrams
  \[
    \xymatrix@C=18pt{ & G_0 \ar[rr]^{\iota_{G_0}} &&\tpro{D}
      \ar[d]^{\xi_\sigma}& & G_{n} \ar@{>->}[rr]^{\iota_{ G_{n}}}
      &&\tpro{D} \ar[d]^{\xi_\sigma} \\ \pi(G_0)
      \ar@/_.2cm/[dr]_{\hat{\alpha}}\ar@/^.2cm/[ur]^{\alpha}
      \ar[r]^{\alpha'} &G'_0 \ar[rr]^{\iota'_{G'_0}} &&\lpro \der{D}'
      \rpro \ar[d]^{\xi_{\tau}}&\pi({
        G_{n}})\ar@/_.2cm/[dr]_{\hat{\omega}}\ar@/^.2cm/[ur]^{\omega}
      \ar[r]^{\omega'} & { G'_{n}} \ar@{>->}[rr]^{\iota'_{{ G'_{n}}}}
      && \lpro \der{D}' \rpro \ar[d]^{\xi_{\tau}}\\ &\hat{G}_0
      \ar[rr]_{\hat{\iota}_{\hat{G}_0}}&& \lpro \hat{\der{D}}\rpro &&
      \hat{G}_n \ar@{>->}[rr]_{\hat{\iota}_{\hat{G}_n}}&& \lpro
      \hat{\der{D}} \rpro \\& G_i \ar[rr]^{\iota_{G_i}} &&\tpro{D}
      \ar[d]^{\xi_\sigma}& & G_{i+1} \ar[rr]^{\iota_{G_{i+1}}}
      &&\tpro{D} \ar[d]^{\xi_\sigma} \\ L_i
      \ar@/_.2cm/[dr]_{\hat{m}_{\tau(\sigma(i))}}\ar@/^.2cm/[ur]^{m_i}
      \ar[r]^{m'_{\sigma(i)}} &G'_{\sigma(i)}
      \ar[rr]^{\iota'_{G'_{\sigma(i)}}} &&\lpro \der{D}' \rpro
      \ar[d]^{\xi_{\tau}}&R_i
      \ar@/_.2cm/[dr]_{\hat{h}_{\tau(\sigma(i))}}\ar@/^.2cm/[ur]^{h_i}
      \ar[r]^{h'_{\sigma(i)}} & G'_{\sigma(i)+1}
      \ar[rr]^{\iota'_{G'_{\sigma(i)+1}}} && \lpro \der{D}' \rpro
      \ar[d]^{\xi_{\tau}}\\ &\hat{G}_{\tau(\sigma(i))}
      \ar[rr]_-{\hat{\iota}_{\hat{G}_{\tau(\sigma(i))}}}&& \lpro
      \hat{\der{D}}\rpro && \hat{G}_{\tau(\sigma(i))+1}
      \ar[rr]_-{\hat{\iota}_{\hat{G}_{\tau(\sigma(i))+1}}}&& \lpro
      \hat{\der{D}} \rpro }\] We deduce at once that
  $\tau\circ \sigma$ is a consistent permutation with mediating
  isomorphism given by $\xi_{\tau} \circ \xi_\sigma$.
\end{remark}

\begin{remark} \label{rem:abscons}Let $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ be two abstraction equivalent decorated derivations of length $n$. Then the identity permutation $\id{[0,n-1]}\colon [0,n-1]\to [0,n-1]$ is a consistent permutation between them. In such a case we can take as $\xi_{\id{[0,n-1]}}\colon \tpro{D}\to \lpro \der{D}'\rpro$ simply the isomorphism induced by any abstraction equivalence $\{\phi_X\}_{X\in \Delta(X)}$.

  In particular, given a decorated derivation $(\der{D}, \alpha, \omega)$ with source $G$ and target $H$ and two isomorphisms, $\phi\colon G'\to G$ $\psi\colon H\to H'$ be two isomorphisms, we know, by \Cref{rem:absequi}, that \[(\der{D}, \alpha, \omega)\equiv_a (\phi*\der{D}, \phi^{-1}\circ \alpha, \omega ) \qquad (\der{D}, \alpha, \omega)\equiv_a (\der{D}*\psi, \alpha, \psi \circ \omega )\]
  In these cases, if the cocones $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D})})$, $(\lpro \phi *\der{D} \rpro, \{\iota'_X\}_{X\in \Delta(\phi *\der{D})})$ and $(\lpro \der{D}*\psi \rpro, \{\iota'_X\}_{X\in \Delta(\der{D}*\psi)})$ are colimiting, we can take as mediating isomorphisms, respectively, the unique arrows $\Gamma^{\phi} \colon \tpro{D}\to \lpro \phi*\der{D} \rpro$ and $\Gamma_\psi\colon \tpro{D}\to \lpro \der{D}*\psi \rpro$  such that, for every $X\in \Deltamin(\der{D})$:
  \[\Gamma^\phi \circ \iota_X:=\begin{cases}
      \iota'_{G'}\circ \phi^{-1} & X=G              \\
      \iota'_X                   & \text{otherwise}
    \end{cases} \qquad \Gamma_\psi \circ \iota_X:=\begin{cases}
      \hat{\iota}_{H'}\circ \psi & X=H              \\
      \hat{\iota}_X              & \text{otherwise}
    \end{cases}\]
\end{remark}


\begin{remark}\label{ex:empty}
  If $\der{D}$ and $\der{D}'$ are empty, then the converse also holds. If $\id{\emptyset}$ is a consistent permutation, then a mediating isomorphism provides an abstraction equivalence.
\end{remark}

\begin{example}\todo{identità consistente non implica astrazione}Notice that the \Cref{ex:empty} cannot, in general, be generalized to non-empty derivations. A counterexample is the following one.
\end{example}


\begin{remark}\label{rem:dett}
  Let $(\der{D}, \alpha, \omega)$ be the composite $(\der{D}_1, \alpha_1, \omega_1)\cdot (\der{D}_2, \alpha_2, \omega_2)$ of two derivation of length $l_1$ and $l_2$. Suppose that:
  \[r(\der{D}_1)=\{\rho_{1,i}\}_{i=0}^{l_1-1} \quad r(\der{D}_2)=\{\rho_{2,i}\}_{i=0}^{l_2-1} \quad  r(\der{D})=\{\rho_{i}\}_{i=0}^{l_1+l_2-1}\]
  and let  $G_{1,0}, G_{2,0}$ and $G_{0}$ be the sources of $\der{D}_1$, $\der{D}_2$,  and $\der{D}$.  Denote, also by $G_{1,i+1}, G_{2,i+1}$ and $G_{i+1}$ are the results of the application of, respectively, $\rho_{1,i}, \rho_{2,i}, \rho_i$ to $G_{1,i}, G_{2,i}$ and $G_{i}$  in the corresponding derivation.
  
  Then we always have arrows $q_1\colon \lpro \der{D}_1\rpro \to \tpro{D}$, $q_2\colon \lpro \der{D}_2\rpro \to \tpro{D}$ such that:
  \begin{itemize}
  \item
    $q_1\circ \iota_{G_{1,0}}\circ \alpha_1 = \iota_{G_{0}}\circ
    \alpha$ and, for every $i\in [0, l_1-1]$
    \[q_1\circ \iota_{1, G_{1,i}}=\iota_{G_{i}}\]
  \item
    $q_2\circ \iota_{G_{2,l_2}}\circ \omega_2 =
    \iota_{G_{l_1+l_2}}\circ \omega$ and, for every
    $i\in [l_1+1, l_1+l_2]$
    \[q_2\circ \iota_{2, G_{2,i}}=\iota_{G_{i+l_1}}\]
  \end{itemize}
  
  Indeed, we have three cases:
  \begin{itemize}
  \item $\lgh(\der{D}_1)=0$. Then $(\der{D}, \alpha, \omega)$ is
    $(\der{D}_2, \alpha_2\circ \omega_1^{-1}\circ \alpha_1, \omega_2)$
    thus we can take as $q_2$ the identity on $\lpro
    \der{D}_2\rpro$. In this case $\iota_{1,G_{1,0}}$ is an
    isomorphism, so that the only possible choice for $q_1$ is
    $\iota_{G_0}\circ \alpha_2\circ \omega^{-1}_1 \circ
    \iota^{-1}_{1,G_{1,0}}$
  \item $\lgh(\der{D}_1)\neq 0$ and $\lgh(\der{D}_2)=0$ . Hence
    $(\der{D}, \alpha, \omega)$ is
    $(\der{D}_1, \alpha_1, \omega_1 \circ \alpha^{-1}_2\circ
    \omega_2)$. We can define $q_1$ as $\id{\lpro \der{D}_1\rpro}$,
    while, since $\iota_{2,G_{2,0}}$ is an isomorphism, $q_2$ must be
    $\iota_{G_{l_1+l_2}}\circ \omega_1 \circ \alpha^{-1}_2 \circ
    \iota^{-1}_{2,G_{2,0}}$.
  \item $\lgh(\der{D}_1)\neq 0$ and $\lgh(\der{D}_2)\neq 0$. In this
    case we have that $(\der{D}, \alpha, \omega)$ is
    $(\der{D}_1*\omega_1^{-1}\cdot \alpha_2*\der{D}_2, \alpha_1,
    \omega_2)$. By the second point of \Cref{lem:colim} and by
    \Cref{rem:abscons} we get the following diagram, in which the
    central square is a pushout:
    \[\xymatrix@C=40pt{&&G_{2,0} \ar@/_.3cm/[dl]_{\alpha^{-1}_2}
        \ar@/^.3cm/[dr]^{\iota_{2, G_{2,0}}}\\&\pi(G_{2,0})
        \ar[dr]^{\iota_{G_{l_1}}}\ar[r]^-{\iota'_{2, \pi(G_{2,0})}}
        \ar@{>->}[d]_-{\iota'_{1, \pi(G_{1,l_1})}} & \lpro
        \alpha_2*\der{D}_2 \rpro \ar@{>->}[d]^{p_2} &\tproi{D}{2}
        \ar[l]_-{\Gamma^{\alpha_2}} \ar@{>.>}@/^.2cm/[dl]^{q_2}\\
        G_{1,l_1} \ar@/^.3cm/[ur]^{\omega^{-1}_1}
        \ar@{>->}@/_.3cm/[dr]_{\iota_{1, G_{1, l_1}}}& \lpro
        \der{D}_1*\omega_1^{-1} \rpro \ar[r]_{p_1}& \tpro{D} \\
        &\tproi{D}{1} \ar[u]^{\Gamma_{\omega^{-1}_1}}
        \ar@{.>}@/_.2cm/[ur]_{q_1}}\] Let us define $q_1$ as
    $p_1\circ \Gamma_{\omega^{-1}_1}$ and $q_2$ as
    $p_2\circ \Gamma^{\alpha_2}$. Then, for every $i\in [0,l_1-1]$ and
    $j\in [l_1+1, l_1+l_2]$
    \[\begin{split}
        q_1\circ \iota_{1, G_{1,i}}&=p_1\circ
        \Gamma_{\omega^{-1}_1}\circ \iota_{1, G_{1,i}}\\&=p_1\circ
        \iota'_{1, G_{1,i}} \\&=\iota_{G_{i}}
      \end{split} \qquad \begin{split} q_2\circ \iota_{2,
          G_{2,j}}&=p_2\circ \Gamma^{\alpha_2}\circ \iota_{2,
          G_{2,j}}\\&=p_2\circ \iota'_{2, G_{2,j}}
        \\&=\iota_{G_{j+l_1}}
      \end{split}\] Moreover, we also have:
    \begin{align*}
      q_1\circ \iota_{G_{1,0}}\circ \alpha_1 & = p_1\circ \Gamma_{\omega^{-1}_1}\circ \iota_{G_{1,0}}\circ \alpha_1 \\&=p_1\circ \iota'_{1, G_{1,0}} \circ \alpha_1 \\&= \iota_{G_{0}}\circ \alpha
    \end{align*}
    and
    \begin{align*}
      q_2\circ \iota_{G_{2,l_2}}\circ \omega_2 & = p_2\circ \Gamma^{\alpha_2}\circ \iota_{G_{2,l_2}}\circ \omega_2 \\&=p_2\circ \iota'_{1, G_{2,l_2}} \circ \omega_2 \\&= \iota_{G_{l_1+l_2}}\circ \omega
    \end{align*}
  \end{itemize}

  It is worth noticing that, for every $i\in [0,l_1-1]$ and
  $j\in [l_1+1, l_1+l_2]$ the previous equalities also entail that,
  \[\begin{split}q_1\circ \iota_{1, D_{1,i}}&=\iota_{D_{i}}\\q_2\circ \iota_{2, D_{2,j}}&=\iota_{D_{j+l_1}} 	\\q_1\circ \iota_{1, R_{1,i-1}}&=\iota_{R_{i-1}} \\
      q_2\circ \iota_{2, R_{2,j-1}}&=\iota_{R_{j+l_1-1}}
    \end{split} \qquad
    \begin{split} q_1\circ \iota_{1, L_{1,i}}&=\iota_{L_{i}}
      \\q_2\circ \iota_{2, L_{2,j}}&=\iota_{L_{j+l_1}}\\ q_1\circ
      \iota_{1, K_{1,i}}&=\iota_{K_{i}}\\q_2\circ \iota_{2,
        K_{2,j}}&=\iota_{K_{j+l_1}}\end{split}\]
\end{remark}

We can now turn our attention to the case in which a consistent
permutation between two composite derivations is given.

\begin{lemma}[Restriction Lemma]\label{prop:uniqu}
  Let $\sigma\colon [0,n]\to [0,n]$ be a consistent permutations
  between $(\der{D}, \alpha, \omega)$ and
  $(\der{D}', \alpha', \omega')$ and suppose that
  \[(\der{D}, \alpha, \omega)=(\der{D}_1, \alpha_1, \omega_1) \cdot (\der{D}_2, \alpha_2, \omega_2) \qquad (\der{D}', \alpha', \omega')=(\der{D}'_1, \alpha'_1, \omega'_1) \cdot (\der{D}'_2, \alpha'_2, \omega'_2) \]
  
  Let $l_1$ be the length of $\der{D}_1$, and suppose that there exists a consistent permutation $\tau:[0,l_1-1]\to [0, l_1-1]$.  If $q_1\colon \lpro \der{D}_1\rpro \to \lpro \der{D}\rpro$  and $q'_1\colon \lpro \der{D}'_1\rpro \to \lpro \der{D}'\rpro$ are the canonical arrows defined above, then the following hold true:
  \begin{enumerate}
  \item  if $l_1=0$, then the following diagram commutes:
    \[\xymatrix{\lpro \der{D}_1\rpro \ar[r]^{\xi_\tau} \ar[d]_{q_1}& \lpro \der{D}'_1 \ar[d]^{q'_1}\rpro\\ \lpro \der{D}\rpro \ar[r]_{\xi_\sigma} & \lpro \der{D}'\rpro } \]
    % \[\xi_\sigma \circ q_1 \circ \iota_{1, G_{1,0}} = q'_1\circ \xi_{\tau} \circ  \iota_{1, G_{1,0}}\]
  \item if $l_1\neq 0$, so that $G_{1,0}=G_0$, then \[\xi_\sigma \circ \iota_{G_0} = q'_1\circ \xi_{\tau} \circ  \iota_{1, G_{1,0}}\]
  \end{enumerate}

  Moreover, let $E_{\sigma, \tau}$ be the set
  \[E_{\sigma, \tau}:=\{i\in  [0, l_1-1] \mid \sigma(j)=\tau(j) \text{ for every } j \leq i \}\]
  then also the following hold true:
  \begin{enumerate}
    \setcounter{enumi}{2}
  \item  if $E_{\sigma, \tau}\neq \emptyset$,  for every index $i\in [0, \max(E_{\sigma, \tau})]$ we have
    \[\xi_\sigma \circ \iota_{G_i}=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_i}\]
  \item if $l_1-1\in E_{\sigma, \tau}$ and $l_2=0$ so that  $G_{l_1}=G_{1, l_1}$, then
    \[\xi_\sigma \circ \iota_{G_{l_1}}=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}}\]
  \item if $l_1-1\in E_{\sigma, \tau}$ and $l_2\neq 0$, so that $G_{l_1}=\pi(G_{2,0})$, then
    \[\xi_\sigma \circ \iota_{G_{l_1}}=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}}\circ \omega_1 \]
  \item if $l_1-1\in E_{\sigma, \tau}$, then the following diagram commutes:
    \[\xymatrix{\lpro \der{D}_1\rpro \ar[r]^{\xi_\tau} \ar[d]_{q_1}& \lpro \der{D}'_1 \ar[d]^{q'_1}\rpro\\ \lpro \der{D}\rpro \ar[r]_{\xi_\sigma} & \lpro \der{D}'\rpro } \]
  \end{enumerate}
\end{lemma}
\begin{proof}\begin{enumerate}
  \item Recall that, in this case \[q_1=\iota_{G_0}\circ \alpha_2\circ \omega^{-1}_1 \circ \iota^{-1}_{1,G_{1,0}} \qquad q'_1=\iota'_{G'_0}\circ \alpha'_2\circ (\omega'_1)^{-1} \circ (\iota'_{1,G'_{1,0}})^{-1}\]
    
    If we compute we have
    \begin{align*}
      \xi_\sigma \circ q_1 & =\xi_\sigma \circ \iota_{G_0}\circ \alpha_2\circ \omega^{-1}_1 \circ \iota^{-1}_{1,G_{1,0}} \\&=\iota'_{G'_0}\circ \alpha'\circ \alpha^{-1}\circ \alpha_2\circ \omega^{-1}_1\circ \iota^{-1}_{1,G_{1,0}}
    \end{align*}
    Now, since $l_1=0$ we also have that
    \[\alpha=\alpha_2\circ \omega_1^{-1}\circ \alpha_1 \qquad \alpha'=\alpha'_2\circ (\omega'_1)^{-1}\circ \alpha'_1\]
    therefore, using \Cref{rem:empty,ex:empty}
    \begin{align*}
      \alpha'\circ \alpha^{-1} & =\alpha'_2\circ (\omega'_1)^{-1}\circ \alpha'_1\circ \alpha^{-1}_1\circ \omega_1\circ \alpha^{-1}_2 \\&=\alpha'_2\circ (\omega'_1)^{-1}\circ \omega'_1\circ \omega^{-1}_1\circ \omega_1\circ \alpha^{-1}_2\\&=\alpha'_2\circ \alpha^{-1}_2
    \end{align*}
    Hence, again by \Cref{rem:empty,ex:empty}:
    \begin{align*}
      \xi_\sigma \circ q_1 & =\iota'_{G'_0}\circ \alpha'\circ \alpha^{-1}\circ \alpha_2\circ \omega^{-1}_1\circ \iota^{-1}_{1,G_{1,0}} \\&=\iota'_{G'_0}\circ \alpha'_2\circ \alpha^{-1}_2\circ \alpha_2\circ \omega^{-1}_1\circ \iota^{-1}_{1,G_{1,0}}\\&=\iota'_{G'_0}\circ \alpha'_2\circ \omega^{-1}_1\circ \iota^{-1}_{1,G_{1,0}}\\&=\iota'_{G'_0}\circ \alpha'_2\circ (\omega'_1)^{-1} \circ  \omega'_1\circ \omega^{-1}_1\circ \iota^{-1}_{1,G_{1,0}}\\&=\iota'_{G_0}\circ \alpha'_2\circ (\omega'_1)^{-1} \circ \alpha'_1\circ \alpha^{-1}_1\circ \iota^{-1}_{1,G_{1,0}}\\&=\iota'_{G'_0}\circ \alpha'_2\circ (\omega'_1)^{-1} \circ (\iota'_{1,G_{1,0}})^{-1}\circ \iota'_{1,G'_{1,0}}\circ \alpha'_1\circ \alpha^{-1}_1\circ \iota^{-1}_{1,G_{1,0}}\\&=q'_1\circ \iota'_{1,G'_{1,0}}\circ \alpha'_1\circ \alpha^{-1}_1\circ \iota^{-1}_{1,G_{1,0}}\\&=q'_1\circ \xi_{\tau}
    \end{align*}
                              
    
    
  \item Start noticing that
    \[\xi_\sigma \circ \iota_{G_0}=\iota'_{G'_0}\circ \alpha'\circ \alpha^{-1} \qquad \xi_{\tau} \circ \iota_{1,G_{1,0}}= \iota'_{1, G'_{1,0}} \circ \alpha'_1\circ \alpha^{-1}_1\]
    Therefore:
    \begin{align*}
      q'_1\circ \xi_{\tau} \circ \iota_{1, G_{1,0}} & =q'_1 \circ \iota'_{1, G'_{1,0}} \circ \alpha'_1\circ \alpha^{-1}_1 \\ &= \iota'_{G'_{0}}\circ \alpha' \circ \alpha^{-1}_1
    \end{align*}
    By hypothesis $\lgh(\der{D}_1) \neq 0$, thus $\alpha_1=\alpha$ and we can conclude.
    
  \item  From $E_{\sigma, \tau}\neq \emptyset$ we deduce that $l_1\neq 0$ and that $0\in E_{\sigma, \tau}$.   We proceed by induction on $i\in [0,\max(E_{\sigma, \tau})]$.
    
    \smallskip \noindent  If $i=0$ the thesis follows from point $1$.
    
    \smallskip \noindent If $i>0$, we proceed as in the proof of \Cref{prop:isouno} considering the pushout square
    \[\xymatrix{K_{i-1}\ar[r]^{r_{i-1}} \ar[d]_{k_{i-1}}& R_{i-1} \ar[d]^{h_{i-1}}\\ D_{i-1} \ar[r]_{g_{i-1}}& G_i}\]
    Since $i$ belongs to $E_{\sigma, \tau}$, then $i-1\in E_{\sigma, \tau}$ too. By definition, $i\leq l_1-1$, so that, using \Cref{rem:coproj} we have
    \[\begin{split}
        \xi_\sigma \circ \iota_{G_i}\circ h_{i-1}&=  \xi_\sigma\circ \iota_{R_{i-1}}\\&=\iota'_{R'_{\sigma(i-1)}}\\&=\iota'_{R'_{\tau(i-1)}}\\&=q'_1\circ \iota'_{1, R'_{1,\tau(i-1)}}\\&=q'_1\circ \xi_{\tau}\circ \iota_{1, R_{i-1}}\\&=q'_1\circ \xi_{\tau} \circ \iota_{1, G_{1,i}}\circ h_{1, i-1}\\&=q'_1\circ \xi_\tau \circ \iota_{1, G_i} \circ h_{i-1}
      \end{split} \]
    
    \Cref{rem:dett} and the induction hypothesis give us
    \begin{align*}
      \xi_\sigma \circ \iota_{G_i}\circ g_{i-1} & =\xi_{\sigma}\circ \iota_{D_{i-1}} \\&=\xi_{\sigma}\circ \iota_{G_{i-1}} \circ f_{i-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{i-1}} \circ f_{i-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{i-1}} \circ f_{1, i-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, D_{i-1}}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_i}\circ g_{1, i-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_i}\circ g_{i-1}
    \end{align*}
    and the thesis now follows.
  \item Since $l_1-1\in E_{\sigma, \tau}$ we have $l_1\neq 0$ and $E_{\sigma, \tau}=[0,l_1-1]$.  We can start with the pushout
    \[\xymatrix{K_{l_1-1}\ar[r]^{r_{l_1-1}} \ar[d]_{k_{l_1-1}}& R_{i-1} \ar[d]^{h_{l_1-1}}\\ D_{l_1-1} \ar[r]_{g_{l_1-1}}& G_{l_1}}\]
    By \Cref{def:conc}, we have
    \[h_{l_1-1}=h_{1, l_1} \qquad g_{l_1-1}=g_{1,l_1}\]
    which, since $q'_1=\id{\lpro \der{D}'_1\rpro}$, in turn, implies that
    \[\iota'_{R_{\tau(l_1-1)}}=q'_1\circ \iota'_{1, R'_{1,\tau(l_1-1)}}\]
    We can thus repeat the same argument of the previous point to deduce
    \begin{align*}
      \xi_\sigma \circ \iota_{G_{l_1}}\circ h_{l_1-1}&=  \xi_\sigma\circ \iota_{R_{l_1-1}}\\&=\iota'_{R'_{\sigma(l_1-1)}}\\&=\iota'_{R'_{\tau(l_1-1)}}\\&=q'_1\circ \iota'_{1, R'_{1,\tau(l_1-1)}}\\&=q'_1\circ \xi_{\tau}\circ \iota_{1, R_{l_1-1}}\\&=q'_1\circ \xi_{\tau} \circ \iota_{1, G_{1,l_1}}\circ h_{1, l_1-1}\\&=q'_1\circ \xi_\tau \circ \iota_{1, G_{l_1}} \circ h_{l_1-1}
    \end{align*}
    
    By hypothesis $l_1-1\in E_{\sigma, \tau}$, so that pint $3$ of this lemma to get
    \[\xi_\sigma \circ \iota_{G_{l_1-1}}=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1-1}}\]
    
    From this the thesis follows after a brief computation:
    \begin{align*}
      \xi_\sigma \circ \iota_{G_{l_1}}\circ g_{l_1-1} & =\xi_{\sigma}\circ \iota_{D_{l_1-1}} \\&=\xi_{\sigma}\circ \iota_{G_{l_1-1}} \circ f_{l_1-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1-1}} \circ f_{l_1-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}-1} \circ f_{1, l_1-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, D_{l_1-1}}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}}\circ g_{1, l_1-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}}\circ g_{l_1-1}
    \end{align*}
    
  \item In this case, we can consider the following diagram, in which the inner rectangle and the outer border are pushouts
    \[\xymatrix@C=35pt{K_{1,l_1-1}\ar[r]^{r_{1,l_1-1}} \ar[d]_{k_{1,l_1-1}}& R_{i-1} \ar[d]_{h_{1,l_1-1}} \ar@/^.3cm/[ddr]^{h_{l_1-1}}\\ D_{1,l_1-1} \ar[r]_{g_{1,l_1-1}} \ar@/_.3cm/[drr]_{g_{l_1-1}}& G_{1,l_1} \ar[dr]^{\omega_1^{-1}}\\ &&\pi(G_{2,0})}\]
    
    
    \[	\xi_\sigma \circ \iota_{G_{l_1}}=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}}\circ \omega_1\]
    We can start noticing that
    \[q'_1\circ \iota'_{1, G'_{1,l_1}}=\iota'_{G'_{l_1}} \circ \omega_1^{-1} \]
    Therefore
    \begin{align*}q'_1\circ \iota'_{1, R'_{1,l_1}} & =q'_1\circ \iota'_{1, G'_{1,l_1}}\circ  h'_{1, l_1} \\&=q'_1\circ \iota'_{1, G'_{1,l_1}}\circ \omega_1 \circ  h'_{ l_1}\\&= \iota'_{G'_{l_1}}\circ h'_{l_1}\\&=\iota'_{R'_{l_1-1}}
    \end{align*}
                              
    The argument now proceeds almost verbatim like the one of the previous two point.
    On the one hand we have
    \begin{align*}
      \xi_\sigma \circ \iota_{G_{l_1}}\circ h_{l_1-1}&=  \xi_\sigma\circ \iota_{R_{l_1-1}}\\&=\iota'_{R'_{\sigma(l_1-1)}}\\&=\iota'_{R'_{\tau(l_1-1)}}\\&=q'_1\circ \iota'_{1, R'_{1,\tau(l_1-1)}}\\&=q'_1\circ \xi_{\tau}\circ \iota_{1, R_{l_1-1}}\\&=q'_1\circ \xi_{\tau} \circ \iota_{1, G_{1,l_1}}\circ h_{1, l_1-1}\\&=q'_1\circ \xi_\tau \circ \iota_{1, G_{1, l_1}} \circ \omega_1 \circ  h_{l_1-1}			\end{align*}
    On the other hand, by point $3$ of this lemma we have
    \begin{align*}
      \xi_\sigma \circ \iota_{G_{l_1}}\circ g_{l_1-1} & =\xi_{\sigma}\circ \iota_{D_{l_1-1}} \\&=\xi_{\sigma}\circ \iota_{G_{l_1-1}} \circ f_{l_1-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}} \circ f_{l_1-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}} \circ f_{1, {l_1}-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, D_{{l_1}-1}}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}}\circ g_{1, l_1-1}\\&=q'_1 \circ \xi_{\tau} \circ \iota_{1, G_{l_1}}\circ \omega_1\circ g_{l_1-1}
    \end{align*}

  \item  The thesis follows from points $3$ and $4$ if $l_2=0$, from $3$ and $5$ if $l_2\neq 0$.	\qedhere
  \end{enumerate}
\end{proof}

We are now ready to prove the central result of this section.
\begin{lemma}\label{lem:impo}
  Let $(\X,R)$ be a left-linear DPO rewriting system and let also
  $(\der{D}_1, \alpha_1, \omega_1)$, $(\der{D}_2, \alpha_2, \omega_2)$
  be two composable decorated derivations of length, respectively,
  $l_1$ and $l_2$. Suppose that
  $\sigma:[0, l_1+l_2-1]\to [0, l_1+l_2-1]$ is a consistent
  permutation between
  $(\der{D}_1, \alpha_1, \omega_1)\cdot (\der{D}_2, \alpha_2,
  \omega_2)$ and
  $(\der{D}'_1, \alpha'_1, \omega'_1)\cdot (\der{D}'_2, \alpha'_2,
  \omega'_2)$ for some other two composable decorated derivations
  $(\der{D}_1, \alpha_1, \omega_1)$ and
  $(\der{D}_2, \alpha_2, \omega_2)$.  If
  $\tau:[0,l_1-1]\to [0, l_1-1]$ is a consistent permutation between
  $(\der{D}_1, \alpha_1, \omega_1)$ and
  $(\der{D}'_1, \alpha'_1, \omega'_1)$. Suppose that the set
  \[D_{\sigma, \tau}:=\{i\in [0, l_1-1]\mid \sigma(i)\neq \tau(i)\}\]
  is non-empty and let $j$ be its minimum. Let also $r(\der{D}_1)$ be $\{\rho_i\}_{i=0}^{l_1-1}$. Then the following hold true:
  \begin{enumerate}
  \item if $j=0$, then the rule $\rho_0$ is not consuming;
  \item if $j\neq 0$ then the rule $\rho_{j-1}$ is not consuming.
  \end{enumerate}
\end{lemma}
\begin{remark}\label{rem:minmax}It is worth to notice that the hypothesis $D_{\sigma, \tau} \neq \emptyset$ entails $l_1\neq 0$. Moreover, if $j\neq 0$, then $j-1$ is the maximum of $E_{\sigma, \tau}$.
\end{remark}

\begin{proof}
  \begin{enumerate}
  \item Let $k$ be $\sigma^{-1}(\tau(0))$ and notice that, since
    $\sigma(0)\neq \tau(0)$, then $0< k$.  By the second point of
    \Cref{prop:uniqu} we can consider the diagram
    \[\xymatrix@C=40pt{&& L_0 \ar[d]_{m'_{\tau(0)}}
        \ar@/^.2cm/[dr]^{m_{k}} \ar@/_.4cm/[dll]_{m_{0}} \\G_{0}
        \ar@/^.2cm/[drrr]^(.4){\iota_{G_0}}|(.67)\hole
        \ar[d]_{\iota_{1,G_{1,0}}}& &G'_{\tau(0)}
        \ar[d]^(.45){\iota'_{G'_{\tau(0)}}} & G_{k}
        \ar[d]^{\iota_{G_k}}\\ \lpro\der{D}_1 \rpro
        \ar[r]_{\xi_{\tau}} &\lpro \der{D}'_1\rpro \ar[r]_{q'_1} &
        \lpro \der{D'}\rpro & \tpro{D} \ar[l]^{\xi_{\sigma}}}\] From
    \Cref{cor:ele}, we can conclude that there exists
    $c\colon L_0\to D_0$ such that $f_0\circ c=m_0$. We thus have the
    solid part of the commutative diagram below.
    \[\xymatrix{L_0 \ar@/^.3cm/[drr]^{\id{L_0}} \ar@{.>}[dr]_{t}
        \ar@/_.3cm/[ddr]_{c}\\ & K_0 \ar[d]_{k_0}\ar@{>->}[r]^{l_0}&
        L_0 \ar[d]^{m_0} \\& D_0 \ar@{>->}[r]_{f_0} & G_0} \]
    The internal square is an $\mathcal{M}$-pushout and thus a
    pullback, by \Cref{prop:pbpoad}, so that we have the existence of
    the dotted $t\colon L_0\to K_0$. Therefore $\id{L_0}=l_0\circ t$,
    proving that $l_0$ is an epimorphism. The thesis now follows from
    \Cref{cor:rego}.
  \item Let $k$ be $\sigma^{-1}(\tau(j-1))$ and notice that
    $\rho_{j-1}=\rho_k$. We have already noticed in \Cref{rem:minmax}
    that $j-1$ is the maximum of $E_{\sigma, \tau}$.  Hence, by the
    third point of \Cref{prop:uniqu} we have
    \[\xymatrix@C=40pt{&& L_{j-1} \ar[d]_{m'_{\tau({j-1})}}
        \ar@/^.2cm/[dr]^{m_{k}} \ar@/_.4cm/[dll]_{m_{{j-1}}}
        \\G_{1,{j-1}}
        \ar@/^.2cm/[drrr]^(.4){\iota_{G_{j-1}}}|(.67)\hole
        \ar[d]_{\iota_{1,G_{1,j-1}}}& &G'_{\tau({j-1})}
        \ar[d]^{\iota'_{G'_{\tau({j-1})}}} & G_{k}
        \ar[d]^{\iota_{G_k}}\\ \lpro\der{D}_1 \rpro
        \ar[r]_{\xi_{\tau}} &\lpro \der{D}'_1\rpro \ar[r]_{q'_1} &
        \lpro \der{D'}\rpro & \tpro{D} \ar[l]^{\xi_{\sigma}}}\]
    Let
    $a$ be $\min(j-1, k)$, by \Cref{cor:ele}, there exists
    $c\colon L_{j-1}\to D_a$ such that $f_a\circ c=m_a$. As before
    this yields the solid part of the following diagram, in which the
    square is an $\mathcal{M}$-pushout.
    \[\xymatrix{L_{j-1} \ar@/^.3cm/[drr]^{\id{L_{j-1}}}
        \ar@{.>}[dr]_{t} \ar@/_.3cm/[ddr]_{c}\\ & K_{j-1}
        \ar[d]_{k_a}\ar@{>->}[r]^{l_{j-1}}& L_{j-1} \ar[d]^{m_a} \\&
        D_a \ar@{>->}[r]_{f_a} & G_a} \]
    The existence of the dotted $t\colon L_{j-1}\to K_{j-1}$ follows
    from \Cref{prop:pbpoad} and we can conclude. \qedhere
  \end{enumerate}
\end{proof}


\begin{corollary}[Uniqueness of consistent
  permutation]\label{cor:unique}
  Let $(\X,\R)$ be a consuming left-linear DPO rewriting system. Then,
  for every two decorated derivations $(\der{D}, \alpha, \omega)$ and
  $(\der{D}', \alpha', \omega')$, there exists at most one consistent
  permutation between them.
\end{corollary}
\begin{proof}
  Let
  $\sigma, \tau: [0, \lgh(\der{D})-1]\rightrightarrows [0,
  \lgh(\der{D})-1]$ be two consistent permutations. Let $H$ and $H'$
  be, respectively, the target of $\der{D}$ and $\der{D}'$. Take two
  isomorphisms $\gamma:\pi(H)\to \gamma$, $\gamma':\pi(H')\to H'$,
  then, according to \Cref{def:conc}:
  \begin{align*}(\der{D}, \alpha, \omega) & =(\der{D}, \alpha,
    \omega)\cdot (\der{D}_2, \gamma, \gamma) \\(\der{D}', \alpha',
    \omega')&=(\der{D}', \alpha', \omega')\cdot (\der{D}'_2, \gamma',
    \gamma')
  \end{align*}
  where $\der{D}_2$ and $\der{D}'_2$ are the empty derivation on $H$
  and $H'$. Since $(\X, \R)$ is consuming, then \Cref{lem:impo}
  entails $D_{\sigma, \tau}=\emptyset$, from which the thesis follows.
\end{proof}



\begin{lemma}\label{lem:presuffix} Let $(\X, \R)$ be a consuming
  left-linear DPO rewriting system.  Let also
  $(\der{D}_1, \alpha_1, \omega_1)$, $(\der{D}_2, \alpha_2, \omega_2)$
  be two composable decorated derivations of length, respectively,
  $l_1$ and $l_2$. Suppose that
  $\sigma\colon [0, l_1+l_2-1]\to [0, l_1+l_2-1]$ is a consistent
  permutation between
  $(\der{D}_1, \alpha_1, \omega_1)\cdot (\der{D}_2, \alpha_2,
  \omega_2)$ and
  $(\der{D}'_1, \alpha'_1, \omega'_1)\cdot (\der{D}'_2, \alpha'_2,
  \omega'_2)$ for some other two composable decorated derivations
  $(\der{D}_1, \alpha_1, \omega_1)$ and
  $(\der{D}_2, \alpha_2, \omega_2)$.  If
  $\tau\colon [0,l_1-1]\to [0, l_1-1]$ is a consistent permutation
  between $(\der{D_1}, \alpha_1, \omega_1)$ and
  $(\der{D}'_1, \alpha'_1, \omega'_1)$. Then the following hold true:
  \begin{enumerate}
  \item suppose that $l_1$ and $l_2$ are different from $0$ and
    consider the following two pushout squares given by
    \Cref{rem:dett}:
    \[\xymatrix@C=45pt@R=30pt{\pi(G_{2,0}) \ar@{>->}[d]_{\iota_{1,
            G_{1,n+1}} \circ \omega_1}\ar[r]^{\iota_{2, G_{2,0}} \circ
          \alpha_2}& \lpro \der{D}_2 \rpro \ar@{>->}[d]^{q_2} &
        \pi(G'_{2,0}) \ar@{>->}[d]_{\iota'_{1, G'_{1,n+1}} \circ
          \omega'_1} \ar[r]^{\iota'_{2, G'_{2,0}} \circ \alpha'_2}&
        \lpro \der{D}'_2 \rpro \ar@{>->}[d]^{q'_2} \\ \lpro \der{D}_1
        \rpro \ar[r]_{q_1} & \tpro{D} & \lpro \der{D}'_1\rpro
        \ar[r]_{q'_1} & \lpro \der{D}'\rpro }\] then, for every
    $i\in [0, l_2]$ there exists a unique
    $\zeta_i\colon G_{2,i}\to \lpro \der{D}_2\rpro $ fitting in the
    diagram below
    \[\xymatrix@R=35pt{G_{2,i} \ar[r]^{\iota_{2,G_{2,i}}} \ar@{.>}[d]_{\zeta_i}&\lpro \der{D}_2 \rpro \ar@{>->}[r]^{q_2}& \tpro{D} \ar[d]^{\xi_{\sigma}} \\
        \lpro \der{D}'_2 \rpro \ar@{>->}[rr]_{q'_2}&& \lpro
        \der{D}'\rpro }\]
  \item the permutation
    \[\varrho\colon [0,l_2-1]\to [0, l_2-1] \qquad i \mapsto
      \sigma(i+l_1)-l_1\] is a consistent one.
  \end{enumerate}
\end{lemma}

\begin{proof}\begin{enumerate}
  \item We can start noticing that by \Cref{lem:impo},
    $\sigma(i)=\tau(i)$ for every $i\in [0, l_1-1]$. By the second
    point of \Cref{prop:uniqu} we can deduce that
    \[\xi_\sigma \circ \iota_{G_{i}}=\]Let us prove the existence of
    $\zeta_i$ by induction on $i\in [0, l_2]$.

    \smallskip \noindent $i=0$. We already know that $G_{l_1}$ and
    $G'_{l_1}$ are both equal to $\pi(G_{2,0})$.  Moreover, we also
    know that
    \begin{align*}
      q_2\circ \iota_{2, G_{2,0}}=\iota_{G_{l_1}} \circ \alpha^{-1}_2 \qquad
    \end{align*}

    Thus we have a diagram
    \[\xymatrix{&G_{2,0} \\
        G_{l_1} \\
        G'_{2,0}&}\]

    Moreover, $\pi(mj$
    \begin{align*}
      \xi_\sigma \circ p_2\circ \iota_{2, G_{2,0}} & =\xi_\sigma \circ \iota_{G_{n+1}}\circ \alpha^{-1}_2 \\&g
    \end{align*}

    \smallskip \noindent $i>0$.


    The uniqueness half of the thesis follows at once since $p'_2$ is
    in $\mathcal{M}$.

  \item Let us split the cases.

    \smallskip \noindent $l_1=0$. then $\varrho=\sigma$ and there is
    nothing to proof.

    \smallskip \noindent $l_2=0$ and $l_1\neq0$. Then
    $\varrho=\id{\emptyset}$ and

    \smallskip \noindent $l_1\neq0$ and $l_2\neq 0$.
    \[\xymatrix{xy code}\]

    Consistency now follows at once. \qedhere
  \end{enumerate}
\end{proof}


Finally, we can show that consistent permutations between composable abstract derivations yield a consistent permutation between the composites.

\begin{lemma}\label{lem:sum} Let $(\der{D}, \alpha, \omega)$
  and $(\der{D}', \alpha', \omega')$ be two abstract decorated
  derivations such that
  \[(\der{D}, \alpha, \omega)=(\der{D}_1, \alpha_1,
    \omega_1)\cdot (\der{D}_2, \alpha_2, \omega_2) \qquad
    (\der{D}', \alpha', \omega')=(\der{D}'_1, \alpha'_1,
    \omega'_1)\cdot (\der{D}'_2, \alpha'_2, \omega'_2)\] Given
  a consistent permutation
  $\sigma\colon [0, \lgh(\der{D}_1)-1]\to [0,
  \lgh(\der{D}_1)-1]$ between
  $(\der{D}_1, \alpha_1, \omega_1)$ and
  $(\der{D}'_1, \alpha'_1, \omega'_1)$ and another
  $\tau\colon [0, \lgh(\der{D}_2)-1]\to [0,
  \lgh(\der{D}_2)-1]$ between
  $(\der{D}_2, \alpha_2, \omega_2)$ and
  $(\der{D}'_2, \alpha'_2, \omega'_2)$, then
  \[\sigma+\tau\colon[0, \lgh(\der{D})-1]\to[0,
    \lgh(\der{D})-1] \quad i \mapsto \begin{cases}
      \sigma(i)                               & i < \lgh(\der{D}_1)   \\
      \lgh(\der{D}_1)+\tau(i-\lgh(\der{D}_1)) & i\geq
      \lgh(\der{D}_1)
    \end{cases}\] is a consistent permutation between
  $(\der{D}, \alpha, \omega)$ and
  $(\der{D}', \alpha', \omega')$.
\end{lemma}

\begin{proof}
  Let us start fixing some notation. Given $X_1\in \Delta(\der{D}_1)$,
  $X_2\in \Delta(\der{D}_2)$, $X'_1\in \Delta(\der{D}'_1)$,
  $X'_2\in \Delta(\der{D}'_2)$, we will denote their coprojections
  into, respectively, $\lpro \der{D}_1\rpro$, $\lpro \der{D}'_2\rpro$,
  $\lpro \der{D}'_1\rpro$, $\lpro \der{D}'_2\rpro$ by
  $\iota_{1, X_1}\colon X_1\to \lpro\der{D}_1\rpro$,
  $\iota_{1, X_2}\colon X_2\to \lpro\der{D}_1\rpro$,
  $\iota'_{1, X'_1}\colon X'_1\to \lpro\der{D}'_1\rpro$ and
  $\iota'_{2, X'_2}\colon X'_2\to \lpro\der{D}_1\rpro$. Similarly,
  given $X\in \Delta(\der{D})$ and $\X'\in \Delta(\der{D}')$ we will
  use $\iota_X\colon X\to \tpro{D}$ and
  $\iota'_{X'}\colon X'\to \lpro \der{D}' \rpro$ for the
  coprojections.

  Now that these preliminaries matters have been addressed, we will proceed with the rest of the proof.. We split the proof in three cases.
  \begin{itemize}
  \item $\lgh(\der{D}_1)=0$. Thus $\lgh(\der{D}'_1)=0$ too  and we have
    \begin{align*}
      (\der{D}, \alpha, \omega) & =(\der{D}_2, \alpha_2\circ \omega_1^{-1}\circ \alpha_1, \omega_2) \\ (\der{D}', \alpha', \omega')&=(\der{D}'_2, \alpha'_2\circ (\omega'_1)^{-1}\circ \alpha'_1, \omega'_2)
    \end{align*}
    Moreover, in this case $\sigma$ must be $\id{\emptyset}$ and $\sigma+\tau$ must be equal to $\tau$. The thesis now follows from the commutativity of the following diagram.
    \[\xymatrix@C=35pt{& G_{1,0}\ar[dd]^{\xi_{\id{\emptyset}}} \ar[dr]^{\omega^{-1}_1}&&G_{2,0}\ar[r]^-{\iota_{2, G_{2,0}}} & \lpro \der{D}_2\rpro \ar[dd]^{\xi_{\tau}}\\\pi(G_{1,0})  \ar[ur]^{\alpha_1} \ar[dr]_{\alpha'_1}&& \pi(G_{2,0}) \ar[ur]^{\alpha_2} \ar[dr]_{\alpha'_2}\\& G'_{1,0} \ar[ur]_{(\omega'_1)^{-1}}&&G'_{2,0} \ar[r]_-{\iota'_{2, G_{2,0}}}& \lpro \der{D}'_2\rpro}\]

  \item $\lgh(\der{D}_2)=0$.  As before this implies that also $\lgh(\der{D}'_2)$ is $0$.  Applying \Cref{def:conc} we get
    \begin{align*}
      (\der{D}, \alpha, \omega) & =(\der{D}_1, \alpha_1, \omega_1 \circ (\alpha_2)^{-1}\circ \omega_2) \\ (\der{D}', \alpha', \omega')&=(\der{D}'_1, \alpha'_1, \omega'_1 \circ (\alpha'_2)^{-1}\circ \omega'_2)
    \end{align*}
    Since $\der{D}_2$ is empty, then $\tau=\id{\emptyset}$ and
    $\sigma+\tau=\sigma$. Let $n$ be $\lg(\der{D}_1)$, as before the
    thesis follows from the diagram below.
    \[\xymatrix@C=35pt{& G_{2,0}\ar[dd]^{\xi_{\id{\emptyset}}}
        \ar[dr]^{\alpha^{-1}_2}&&G_{1,n}\ar@{>->}[r]^-{\iota_{1,
            G_{1,n}}} & \lpro \der{D}_2\rpro
        \ar[dd]^{\xi_{\sigma}}\\\pi(G_{2,0}) \ar[ur]^{\omega_2}
        \ar[dr]_{\omega'_2}&& \pi(G_{1,n}) \ar[ur]^{\omega_1}
        \ar[dr]_{\omega'_1}\\& G'_{2,0}
        \ar[ur]_{(\alpha'_1)^{-1}}&&G'_{1,n} \ar@{>->}[r]_-{\iota'_{1,
            G_{1,n}}}& \lpro \der{D}'_2\rpro}\]

  \item $\lgh(\der{D}_1)\neq0$ and $\lgh(\der{D}_2)\neq 0$. Thus
    $\der{D}'_1$ and $\der{D}'_2$ are non-empty too. In this case we
    have:
    \begin{align*}
      (\der{D}, \alpha, \omega)    & =(\der{D}_1*\omega_1^{-1}\cdot \alpha_2*\der{D}_2, \alpha_1, \omega_2)         \\
      (\der{D}', \alpha', \omega') & =(\der{D}'_1*(\omega'_1)^{-1}\cdot \alpha'_2*\der{D}'_2, \alpha'_1, \omega'_2)
    \end{align*}

    Let us assume that $\der{D}_1$, $\der{D}'_1$, $\der{D}_2$ and
    $\der{D}'_2$ are given by
    \[\der{D}_1=\{\dder{D}_{1,i}\}_{i=0}^n \quad
      \der{D}'_1=\{\dder{D}'_{1,i}\}_{i=0}^n \quad
      \der{D}_2=\{\dder{D}_{2,i}\}_{i=0}^t \quad
      \der{D}_2'=\{\dder{D}'_{2,i}\}_{i=0}^t\] By definition of
    consistent permutation, the rule applied by $\dder{D}_{1,i}$ and
    the one applied in $\dder{D}_{2,i}$ must coincide with,
    respectively, the one applied in $\dder{D}'_{1,i}$ and the one
    applied $\dder{D}'_{2,1}$. Let $\dder{D}_{1,i}$,
    $\dder{D}'_{1,i}$, $\dder{D}_{2,i}$ and $\dder{D}'_{2,i}$ be
    given, by the following four diagrams.
    \[\xymatrix{L_{1,i} \ar[d]_{m_{1, i}}& K_{1,i} \ar[d]_{k_{1, i}}
        \ar[r]^{r_{1,i}} \ar@{>->}[l]_{l_{1,i}} & R_{1,i}\ar[d]^{h_{1,
            i}} &L_{1,i} \ar[d]_{m'_{1, i}}& K_{1,i} \ar[d]_{k'_{1,
            i}} \ar[r]^{r_{1,i}} \ar@{>->}[l]_{l_{1,i}} &
        R_{1,i}\ar[d]^{h'_{1, i}} \\G_{1,i} & D_{1,i} \ar[r]_{g_{1,i}}
        \ar@{>->}[l]^{f_{1,i}} & G_{1,i+1} & G'_{1,i} &
        D'_{1,i}\ar[r]_{g'_{1,i}} \ar@{>->}[l]^{f'_{1,i}} &
        G'_{1,i+1}}\]
    \[\xymatrix{L_{2,i} \ar[d]_{m_{2, i}}& K_{2,i} \ar[d]_{k_{2, i}}
        \ar[r]^{r_{2,i}} \ar@{>->}[l]_{l_{2,i}} & R_{2,i}\ar[d]^{h_{2,
            i}} &L_{2,i} \ar[d]_{m'_{2, i}}& K_{2,i} \ar[d]_{k'_{2,
            i}} \ar[r]^{r_{2,i}} \ar@{>->}[l]_{l_{2,i}} &
        R_{2,i}\ar[d]^{h'_{2, i}} \\G_{2,i} & D_{2,i} \ar[r]_{g_{2,i}}
        \ar@{>->}[l]^{f_{2,i}} & G_{2,i+1} & G'_{2,i} &
        D'_{2,i}\ar[r]_{g'_{2,i}} \ar@{>->}[l]^{f'_{2,i}} &
        G'_{2,i+1}}\]

    % Let $(\lpro \der{D}_1*(\omega_1)^{-1}\rpro, \{j_X\}_{X\in \Delta( \der{D}_1*(\omega_1)^{-1})})$, $(\lpro \der{D}'_1*(\omega'_1)^{-1}\rpro, \{j'_X\}_{X\in \Delta( \der{D}'_1*(\omega'_1)^{-1})})$, $(\lpro \der{D}_1*(\omega_1)^{-1}\rpro, \{j_X\}_{X\in \Delta( \der{D}_1*(\omega_1)^{-1})})$ and $(\lpro \der{D}'_1*(\omega'_1)^{-1}\rpro, \{j'_X\}_{X\in \Delta( \der{D}'_1*(\omega'_1)^{-1})})$ be colimiting cocones. 
    By \Cref{rem:dett} we get the following diagram, in which the two solid squares are pushouts:
    \[\xymatrix@C=45pt@R=30pt{\pi(G_{2,0}) \ar@/^.4cm/[rrr]^{\id{\pi(G_{2,0})}}\ar@{>->}[d]_{\iota_{1, G_{1,n+1}} \circ \omega_1}\ar[r]_{\iota_{2, G_{2,0}} \circ \alpha_2}& \lpro \der{D}_2 \rpro \ar@{>->}[d]^{q_2}\ar[r]_{\xi_\tau} & \lpro \der{D}'_2 \rpro \ar@{>->}[d]_{q'_2} &\pi(G'_{2,0}) \ar@{>->}[d]^{\iota'_{1, G'_{1,n+1}} \circ \omega'_1} \ar[l]^{\iota'_{2, G'_{2,0}} \circ \alpha'_2}\\ \lpro \der{D}_1 \rpro \ar@/_.4cm/[rrr]_{\xi_\sigma} \ar[r]^{q_1} & \tpro{D} \ar@{.>}[r]^{\xi_{\sigma+\tau}} & \lpro \der{D}'\rpro & \lpro \der{D}'_1\rpro  \ar[l]_{q'_1}}\]

    Moreover, we can point out that, for every index $i\in [0,n+t+2]$ we have
    
    \[\iota_{G_i}=\begin{cases}q_1\circ \iota_{1, G_{1,i}}                & i \leq n \\
        q_1\circ \iota_{1, G_{1, i}}\circ \omega_1 & i=n+1    \\
        q_2\circ \iota_{2, G_{2,i-(n+1)}}          & i > n+1
      \end{cases} \qquad \iota'_{G'_i}=\begin{cases}q'_1\circ \iota'_{1, G'_{1,i}}                 & i \leq n \\
        q'_1\circ \iota'_{1, G'_{1, i}}\circ \omega'_1 & i=n+1    \\
        q'_2\circ \iota'_{2, G'_{2,i-(n+1)}}           & i > n+1
      \end{cases}\]
    
    Now, on the one hand, the existence of the dotted arrow $\xi_{\sigma+\tau}\colon \tpro{D}\to \lpro \der{D}'\rpro$ in the diagram above follows from the following computation:
    \begin{align*}
      q'_1\circ \xi_\sigma \circ \iota_{1, G_{1,n+1}} \circ \omega_1 & =q'_1\circ \iota'_{1,G'_{1, n+1}} \circ \omega'_1 \\&= q'_2 \circ \iota'_{2, G'_{2,0}} \circ \alpha'_2\\&=q'_2\circ \xi_\tau \circ \iota_{2, G_{2,0}} \circ \alpha_2
    \end{align*}
    On the other hand, we can repeat the same computation for $\xi^{-1}_\sigma$ and $\xi^{-1}_\tau$ to get
    \begin{align*}
      q_1\circ \xi^{-1}_\sigma \circ \iota'_{1, G'_{1,n+1}} \circ \omega'_1 & =q_1\circ \iota_{1,G_{1, n+1}} \circ \omega_1 \\&= q_2 \circ \iota_{2, G_{2,0}} \circ \alpha_2\\&=q_2\circ \xi^{-1}_\tau \circ \iota'_{2, G'_{2,0}} \circ \alpha'_2
    \end{align*}
    Hence there exists a $\psi\colon \lpro \der{D}'\rpro \to \tpro{D}$ such that:
    \[\psi \circ q'_1=q_1\circ \xi^{-1}_\sigma \qquad \psi \circ q'_2=q_2\circ \xi^{-1}_\tau\]
    Furthermore, the computations below show that $\psi$ is the inverse of $\xi_\sigma$.
    \[\begin{split}
        \psi \circ \xi_{\sigma+\tau}\circ  q_1&=\psi \circ q'_1\circ \xi_\sigma \\&=q_1\circ \xi^{-1}_{\sigma}\circ \xi_\sigma\\&=q_1\\\\
        \xi_{\sigma+\tau}\circ \psi \circ q'_1&=\xi_{\sigma+\tau}\circ q_1\circ \xi^{-1}_\sigma \\&=q'_1\circ \xi_{\sigma}\circ \xi^{-1}_\sigma\\&=q'_1
      \end{split}\qquad \begin{split}
        \psi \circ \xi_{\sigma+\tau}\circ  q_2&=\psi \circ q'_2\circ \xi_\tau \\&=q_2\circ \xi^{-1}_{\tau}\circ \xi_\tau\\&=q_2\\ \\ 	\xi_{\sigma+\tau}\circ \psi \circ q'_2&=\xi_{\sigma+\tau}\circ q_2\circ \xi^{-1}_\tau \\&=q'_2\circ \xi_{\tau}\circ \xi^{-1}_\tau\\&=q'_2
      \end{split}
    \]
    To conclude we have to show that $\xi_{\sigma+\tau}$ fits in the
    diagrams of \Cref{def:permcon}. For the first two diagrams we
    have:
    \begin{align*}
      \xi_{\sigma+\tau} \circ \iota_{G_{0}}\circ \alpha & =\xi_{\sigma+\tau} \circ q_1 \circ \iota_{1,G_{1,0}}\circ \alpha_1 \\&=q_1'\circ \xi_\sigma \circ  \iota_{1,G_{1,0}} \alpha_1\\&=q'_1\circ \iota'_{1, G'_{1,0}}\circ \alpha'_1\\&=\iota'_{G'_0}\circ \alpha'
    \end{align*}
    and
    \begin{align*}
      \xi_{\sigma+\tau} \circ \iota_{G_{n+t+2}}\circ \omega & =\xi_{\sigma+\tau} \circ q_2 \circ \iota_{2,G_{2,t+1}}\circ \omega_2 \\&=q'_2\circ \xi_\tau \circ  \iota_{2,G_{2,t+1}} \omega_2\\&=q'_2\circ \iota'_{2, G'_{2,t+1}}\circ \omega'_2\\&=\iota'_{G'_{n+t+2}}\circ \omega'
    \end{align*}

    Let $i$ be an index in $[0, n+t+1]$, we proceed splitting the cases.
    \begin{itemize}
    \item $i$ is in $[0,n]$. Then we have
      \begin{align*}
        \xi_{\sigma+\tau}\circ \iota_{G_i} \circ m_i & = \xi_{\sigma+\tau} \circ q_1\circ \iota_{1, G_{1,i}}\circ m_{1,i} \\&=q'_1 \circ \xi_\sigma \circ \iota_{1, G_{1,i}}\circ m_{1,i}\\&= q'_1\circ \iota'_{1, G'_{1,\sigma(i)}}\circ m'_{1,\sigma(i)}\\&=\iota'_{G'_{\sigma(i)}}\circ m'_{\sigma(i)}
      \end{align*}
      Now, suppose that $i\neq n$, then
      \begin{align*}
        \xi_{\sigma+\tau}\circ \iota_{G_{i+1}} \circ h_i & = \xi_{\sigma+\tau} \circ q_1\circ \iota_{1, G_{1,{i+1}}}\circ h_{1,i} \\&=q'_1\circ \xi_\sigma \circ \iota_{1, G_{1,{i+1}}}\circ h_{1,i}\\&= q'_1\circ \iota'_{1, G'_{1,\sigma(i)+1}}\circ h'_{1,\sigma(i)}
      \end{align*}
      and we have two subcases. If $\sigma(i)\neq n$, then \[h'_{1, \sigma(i)}=h'_{\sigma(i)} \qquad q'_1\circ \iota'_{1, G'_{1,\sigma(i)+1}}=
        \iota'_{G'_{\sigma(i)+1}}\]
      and we can conclude. Otherwise, we have
      \begin{align*}q'_1\circ \iota'_{1, G'_{1,n+1}}\circ h'_{1,n} & =q'_1 \circ \iota'_{1,G'_{1,n+1}} \circ \omega'_1\circ (\omega')^{-1}_1 \circ h'_{1,n} \\&=\iota'_{G'_{n+1}}\circ h'_n
      \end{align*}
      yielding again the wanted equality
      \[\xi_{\sigma+\tau}\circ \iota_{G_{i+1}} \circ h_i=\iota'_{G'_{\sigma(i)+1}}\circ h'_{\sigma(i)}\]
      Finally, if $i=n$ we get
      \begin{align*}
        \xi_{\sigma+\tau}\circ \iota_{G_{n+1}} \circ h_n & = \xi_{\sigma+\tau} \circ \iota_{\pi(G_{1,n+1})} \circ \omega^{-1}_1\circ h_{1,n} \\&= \xi_{\sigma+\tau} \circ q_1\circ \iota_{1, G_{1,n+1}} \circ \omega_1 \circ \omega^{-1}_1 \circ h_{1,n}\\&=q'_1 \circ \xi_\sigma \circ \iota_{1, G_{1,n+1}} \circ h_{1,n}\\&=q'_1\circ \iota'_{1, G_{1,\sigma(n)+1}} \circ h'_{1,\sigma(n)}
      \end{align*}
      We have again two cases. If $\sigma(n)\neq n$ then we can conclude at once since
      \[h'_{1, \sigma(n)}=h'_{\sigma(n)} \qquad q'_1\circ \iota'_{1, G'_{1,\sigma(n)+1}}=
        \iota'_{G'_{\sigma(n)+1}}\]
      While, if $\sigma(n)=n$, then we can use the identities
      \[(\omega'_1)^{-1}\circ h'_{1, n}=h'_{n} \qquad q'_1\circ \iota'_{1, G'_{1, n+1}}=
        \iota'_{G'_{n+1}}\circ (\omega'_1)^{-1}\]
      to get
      \begin{align*}
        \xi_{\sigma+\tau}\circ \iota_{G_{n+1}} \circ h_n & = q'_1\circ \iota'_{1, G_{1,n+1}} \circ h'_{1,n} \\&=\iota'_{G'_{n+1}}\circ (\omega'_1)^{-1}\circ h'_{1,n}\\&=\iota'_{G'_{n+1}} h'_{n}
      \end{align*}
    \item $i$ is in $[n+1, n+t+1]$- We proceed  similarly to the point above. First of all we have
      \begin{align*}
        \xi_{\sigma+\tau}\circ \iota_{G_{i+1}} \circ h_i & = \xi_{\sigma+\tau} \circ q_2\circ \iota_{1, G_{2,i-n}}\circ h_{2,i-(n+1)} \\&=q'_2 \circ \xi_\tau \circ \iota_{2, G_{2,i-n}}\circ h_{2,i-(n+1)}\\&= q'_2\circ \iota'_{2, G'_{2,\tau(i-n)}}\circ h'_{2,\tau(i-(n+1))}\\&=\iota'_{G'_{\tau(i-n)}}\circ h'_{n+1+\tau(i-(n+1))}
      \end{align*}
      Next, supposing that $i\neq n+1$:
      \begin{align*}
        \xi_{\sigma+\tau}\circ \iota_{G_{i}} \circ m_i & = \xi_{\sigma+\tau} \circ q_2\circ \iota_{2, G_{2,i-(n+1)}}\circ m_{2,i-(n+1)} \\&=q'_2\circ \xi_\tau \circ \iota_{2, G_{2,{i-(n+1)}}}\circ m_{2,i-(n+1)}\\&= q'_2\circ \iota'_{2, G'_{2,\tau(i-(n+1))}}\circ m'_{2,\tau(i-(n+1))}
      \end{align*}
      and we have again two possibilities. If $\tau(i-(n+1))\neq 0$, then the thesis follows from the equalities \[m'_{2, \tau(i-(n+1))}=m'_{(\sigma+\tau)(i)} \qquad q'_2\circ \iota'_{2, G'_{2,\tau(i-(n+1))}}=
        \iota'_{G'_{(\sigma+\tau)(i)}}\]
      Suppose, instead, that $\tau(i-(n+1))= 0$, then we have
      \begin{align*} q'_2\circ \iota'_{2, G'_{2,0}}\circ m'_{2,0} & =q'_2 \circ \iota'_{2,G'_{2,0}} \circ \alpha'_2 \circ \alpha'^{-1}_2 \circ m'_{2,0} \\&=q'_1\circ \iota'_{1, G'_{1, n+1}}\circ \omega'_1\circ \alpha'^{-1}_2 \circ m'_{2,0}\\&=\iota'_{G'_{n+1}}\circ m'_{n+1}
      \end{align*}
      allowing us to conclude again.
      
      We are left with the case $i=n+1$. Let us compute
      \begin{align*}
        \xi_{\sigma+\tau}\circ \iota_{G_{n+1}} \circ m_{n+1} & = \xi_{\sigma+\tau} \circ \iota_{\pi(G_{2,0})} \circ (\alpha'_2)^{-1}\circ m_{2,0} \\&=\xi_{\sigma+\tau} \circ q_1\circ \iota_{1, G_{1,n+1}} \circ \omega_1 \circ (\alpha'_2)^{-1}\circ m_{2,0}\\&=\xi_{\sigma+\tau} \circ q'_2 \circ \iota'_{2,G'_{2,0}} \circ \alpha'_2 \circ (\alpha'_2)^{-1}\circ m_{2,0} \\&=q'_2 \circ \xi_\tau \circ \iota_{2, G_{2,0}} \circ m_{2,0}\\&=q'_2\circ \iota'_{2, G_{2,\tau(0)}} \circ m'_{2,\tau(0)}
      \end{align*}
      We have again two cases. If $\tau(0)\neq 0$ then $(\sigma+\tau)(i)\neq n+1$ and we can conclude at once since
      \[m'_{2, \tau(0)}=m'_{(\sigma+\tau)(n+1)} \qquad q'_2\circ \iota'_{2, G'_{2,\tau(0)}}=
        \iota'_{G'_{(\sigma+\tau)(0)}}\]
      If $\tau(0)=0$, so that  $(\sigma+\tau)(0)= n+1$ we appeal to the equalities
      \[(\alpha')^{-1}_2\circ m'_{2, 0}=m'_{n+1} \qquad q'_2\circ \iota'_{2, G'_{2, 0}}=
        \iota'_{G'_{n+1}}\circ (\alpha'_2)^{-1}\]
      to get
      \begin{align*}
        \xi_{\sigma+\tau}\circ \iota_{G_{n+1}} \circ m_{n+1} & = q'_2\circ \iota'_{2, G_{2,\tau(0)}} \circ m'_{2,\tau(0)} \\&=	\iota'_{G'_{n+1}}\circ (\alpha'_2)^{-1}\circ m'_{2,0}\\&=\iota'_{G'_{n+1}}\circ  m'_{n+1}
      \end{align*}
    \end{itemize}
    The thesis now follows at once.	 \qedhere
  \end{itemize} \end{proof}
\fi




\section{Independence in rewriting}
\label{sec:equi}

In this section we discuss the notion of independence between
consecutive rewriting steps, a fundamental ingredient of the rewriting
theory, which comes into play when viewing a sequence of steps as a
concurrent computation. We observe that moving from linear to
left-linear rules leads to the failure of various basic properties of
the classical notion of independence used in the linear setting and we
single out a framework in which these can be re-established, possibly
in a weakened form.


\subsection{Sequentially independent and switchable derivations }\label{subsec:switch}



In the DPO approach the canonical notion of independence is that of sequential independence.
%recalled below.

\begin{definition}[Sequential independence]
  \label{de:sequential-independence}
  Let $\X$ be an $\mathcal{M}$-adhesive category 
  and $(\X, \R)$ a left-linear DPO rewriting system. 
  Let also
  $\der{D}=\{\dder{D}_i\}_{i=0}^1$ be a derivation of length $2$, with
  $\dder{D}_i$ using rule $\rho_i = (l_i,r_i)$.  An \emph{independence
    pair} between $\dder{D}_0$ and $\dder{D}_1$, is a pair of arrows
  $i_0\colon R_0\to D_1$ and $i_1\colon L_1\to D_0$ such that the
  following diagram commutes
  \[\xymatrix@C=15pt{L_0 \ar[d]_{m_0}&& K_0
      \ar[d]_{k_0}\ar@{>->}[ll]_{l_0} \ar[r]^{r_0} & R_0
      \ar@{.>}@/^.35cm/[drrr]|(.3)\hole_(.4){i_0}
      \ar[dr]|(.3)\hole_{h_0} && L_1 \ar@{.>}@/_.35cm/[dlll]^(.4){i_1}
      \ar[dl]|(.3)\hole^{m_1}& K_1 \ar[d]^{k_1}\ar@{>->}[l]_{l_1}
      \ar[rr]^{r_1} && R_1 \ar[d]^{h_1}\\G_0 && \ar@{>->}[ll]^{f_0}
      D_0 \ar[rr]_{g_0}&& G_1 && \ar@{>->}[ll]^{f_1} D_1
      \ar[rr]_{g_1}&& G_2}\] In this case we say that $\dder{D}_0$ and
  $\dder{D}_1$ are
  % \emph{weakly sequentially independent} if an independence pair
  % exists. If such independence pair is unique we will say that
  % $\dder{D}$ and $\dder{D'}$ are
  \emph{sequentially independent} and write $\dder{D}_0 \seqind \dder{D}_1$.
\end{definition}

Intuitively, the existence of the independence pair
captures the possibility of switching the application of the two rules:
$f_0 \circ i_1$ is a match for $\rho_1$ in $G_0$ and the
existence of $i_0 : R_0 \to D_1$ indicates that $\rho_1$ does not delete
items in the image of $K_0$ and thus $\rho_0$ can be applied after
$\rho_1$.

More precisely, let us formalise what it means for a derivation being the switch of another.

% We want to be able to to switch the application of two rules used by two consecutive weakly independent direct derivations.
% This leads us to the following definition.

\begin{definition}[Switch]
  \label{def:switch}
  Let $\X$ be an $\mathcal{M}$-adhesive category 
  and $(\X, \R)$ a left-linear DPO rewriting system. 
  Let also
  $\der{D}=\{\dder{D}_i\}_{i=0}^1$ be a derivation of length $2$ made
  by two sequentially independent derivations $\dder{D}_0$,
  $\dder{D}_1$, with independence pair $(i_0, i_1)$, as in the diagram
  on the left below. A \emph{switch} of $\der{D}$ along $(i_0,i_1)$ is
  a derivation $\der{E}=\{\dder{E}_i\}_{i=0}^1$, between the same objects and using the same rules
  in reverse order, as in the diagram on the right below, 
  \[
    \def\objectstyle{\scriptstyle}\def\labelstyle{\scriptstyle}
    \xymatrix@C=1.1mm@R=8mm{
      {L_0} \ar[d]_{m_0}
      & & {K_0} \ar@{>->}[ll]_{l_0} \ar[rr]^{r_0} \ar[d]_{k_0}
      & & {R_0} \ar[drr]|(.35)\hole_(.6){h_0}  \ar@/^.22cm/[drrrrrr]|(.3)\hole^(.75){i_0}
      & & & & 
      % 
      {L_1}\ar[dll]|(.35)\hole^(.6){m_1} \ar@/_.22cm/_(.75){i_1}[dllllll]
      & & {K_1} \ar@{>->}[ll]_{l_1} \ar[rr]^{r_1} \ar[d]^{k_1}
      & & {R_1} \ar[d]^{h_1} \\
      % 
      % 
      {G_0}
      & & {D_0} \ar@{>->}[ll]^{f_0} \ar[rrrr]_{g_0}
      & & & & {G_1} & &
      & &  {D_1} \ar@{>->}[llll]^{f_1} \ar[rr]_{g_1}
      & & {G_2}
    }
    % 
    \xymatrix@C=1.1mm@R=8mm{
      {L_1} \ar[d]_{m_0'}
      & & {K_1} \ar@{>->}[ll]_{l_1} \ar[rr]^{r_1} \ar[d]_{k_0'}
      & & {R_1} \ar[drr]|(.35)\hole_(.6){h_0'}  \ar@/^.22cm/@{.>}^(.75){i_0'}|(.3)\hole[drrrrrr]
      & & & & 
      % 
      {L_0}\ar[dll]|(.35)\hole^(.6){m_1'} \ar@/_.22cm/@{.>}_(.75){i_1'}[dllllll] 
      & & {K_0} \ar@{>->}[ll]_{l_0} \ar[rr]^{r_0} \ar[d]^{k_1'}
      & & {R_0} \ar[d]^{h_1'} \\
      % 
      % 
      {G_0}
      & & {D_0'} \ar@{>->}[ll]^{f_0'} \ar[rrrr]_{g_0'}
      & & & & {G'_1} & &
      & &  {D_1'} \ar@{>->}[llll]^{f_1'} \ar[rr]_{g_1'}
      & & {G_2}  }
    %
  \]
  such that there is an independence pair $(i_0', i_1')$ between
  $\dder{E}_0$ and $\dder{E}_1$ and 
  \begin{center}   
    $m_0=f_0' \circ i_1'$
    \qquad $h_1=g_1' \circ i_0'$
    \qquad $m_0'= f_0 \circ i_1$
    \qquad $h_1'= g_{1}\circ i_0$.
  \end{center}


  If a switch of $\dder{D}_0$ and $\dder{D}_1$ exists we will say that
  they are \emph{switchable}.

  % \[
  %   \xymatrix@C=7pt{L_0 \ar[d]_{m_0}&& K_0
  %     \ar[d]_{k_0}\ar@{>->}[ll]_{l_0} \ar[r]^{r_0} & R_0
  %     \ar@/^.35cm/[drrr]|(.3)\hole_(.4){i_0} \ar[dr]|(.3)\hole_{h_0}
  %     && L_1 \ar@/_.35cm/[dlll]^(.4){i_1} \ar[dl]|(.3)\hole^{m_1}& K_1
  %     \ar[d]^{k_1}\ar@{>->}[l]_{l_1} \ar[rr]^{r_1} && R_1
  %     \ar[d]^{h_1}\\G_0 && \ar@{>->}[ll]^{f_0} D_0 \ar[rr]_{g_0}&& G_1
  %     && \ar@{>->}[ll]^{f_1} D_1 \ar[rr]_{g_1}&& G_2}\]

  % Take another derivation $\der{E}=\{\dder{E}_i\}_{i=0}^1$ as below
  % \[\xymatrix@C=18pt{L_{\der{E},0} \ar[d]_{m_{\der{E},0}}&&
  %     K_{\der{E},0}
  %     \ar[d]_{k_{\der{E},0}}\ar@{>->}[ll]_{l_{\der{E},0}}
  %     \ar[r]^{r_{\der{E},0}} & R_{\der{E},0} \ar[dr]_{h_{\der{E},0}}
  %     && L_{\der{E},1} \ar[dl]^{m_{\der{E},1}}& K_{\der{E},1}
  %     \ar[d]^{k_{\der{E},1}}\ar@{>->}[l]_{l_{\der{E},1}}
  %     \ar[rr]^{r_{\der{E},1}} && R_{\der{E},1}
  %     \ar[d]^{h_{\der{E},1}}\\G_{0} && \ar@{>->}[ll]^{f_{\der{E},0}}
  %     D_{\der{E},0} \ar[rr]_{g_{\der{E},0}}&& G_{\der{E},1} &&
  %     \ar@{>->}[ll]^{f_{\der{E},1}} D_{\der{E},1}
  %     \ar[rr]_{g_{\der{E},1}}&& G_{2}}\] We say that $\der{E}$ is a
  % \emph{switch} of $\dder{D}_0$ and $\dder{D}_1$ along $(i_1, i_2)$ if
  % \begin{enumerate}
  % \item $\dder{E}_0$ applies the rule used by $\dder{D}_1$ and
  %   $\dder{E}_1$ the one used by $\dder{D}_0$, so that
  %   \[(l_{\der{E},0}, r_{\der{E},0})=(l_1,r_1) \qquad (l_{\der{E},1},
  %     r_{\der{E},1})=(l_0,r_0)\]
  % \item there exists an independence pair $(j_0, j_1)$ between
  %   $\dder{E}_0$ and $\dder{E}_1$ such that
  %   \[ m_0=f_{\der{E},0} \circ j_1 \qquad h_1=g_{\der{E},1} \circ
  %     j_0\]
  % \item $m_{\der{E},0}= f_0\circ i_1$ and
  %   $h_{\der{E},1}= g_{1}\circ i_0$.
  % \end{enumerate}

  % If a switch of $\dder{D}_0$ and $\dder{D}_1$ exists we will say that
  % they are \emph{switchable}.
\end{definition}

It can be shown that switches along the same independence pair are unique up to abstraction
equivalence (see Proposition~\ref{thm:switch_uni}).

\begin{example}
  \label{ex:seq-ind}
  Consider a rewriting system in $\cat{Graph}$, the category of
  directed graphs and graph morphisms, which is adhesive. The set of
  rules $\R = \{ \rho_0, \rho_1, \rho_2\}$ consists of three rules as
  depicted in Fig.~\ref{fi:rules}, where numbers are used to represent
  the mappings from the interface to the left- and right-hand
  sides. Rules $\rho_0$ and $\rho_1$ are linear: $\rho_0$ generates a
  new node, while $\rho_1$ creates an edge. Instead, $\rho_2$ is
  left-linear but not linear, as it ``merges'' two nodes.


\todo{Se inseriamo le figure in fusione.tex si risparmia dello spazio}
  \begin{figure}
    \input{Figure/rules.tex}
    
    \caption{Rules of the rewriting system of the running example.}
    \label{fi:rules}
  \end{figure}
  
  A derivation $\der{D}$ consisting of three steps $\dder{D}_0$,
  $\dder{D}_1$, and $\dder{D}_2$, each applying the corresponding rule
  $\rho_i$, is depicted in in Fig.~\ref{fi:derD}. The second and third
  steps $\dder{D}_1$ and $\dder{D}_2$ are clearly sequential
  independent, via an independence pairs that map nodes consistently
  with their numbering.\todo{P: having names for the graphs would
    probably help}
  
  \begin{figure}
    \input{Figure/derD.tex}
    \caption{The derivation $\der{D}$.}
    \label{fi:derD}
  \end{figure}

  The independence pair can be used to construct a switch $\der{E}$, as
  depicted in Fig.~\ref{fi:derE}.
  \begin{figure}
    \input{Figure/derE.tex}
    \caption{The derivation $\der{E}$.}
    \label{fi:derE}
  \end{figure}
\end{example}


As already mentioned, for linear rewriting systems, when viewing
derivations as concurrent computations, it is canonical to identify
derivations which are equal ``up to switching''. The same notion can
be given for left-linear rewriting systems by relying on notion of
switch.


We first need to recall some concept and notations regarding permutations. 

\begin{definition}
	A \emph{permutation} on
	$\interval[0]{n}$ is a bijection
	$\sigma : \interval[0]{n} \to \interval[0]{n}$. We call it a
	\emph{transposition} when there are $i, j \in \interval{n}$,
	$i \neq j$ such that $\sigma(i)=j$, $\sigma(j) = i$ and
	$\sigma(k) = k$ otherwise. Such a transposition is normally denoted as
	$\transp{i}[j]$.
	
Given a permutation $\perm$ on $\interval[0]{n}$,  an \emph{inversion} for $\sigma$ is a pair $(i,j)$ such that $i<j$ and $\sigma(j)< \sigma(i)$. The set of inversions
of $\perm$ will be denoted by $\inv{\sigma}$.
\end{definition}

\begin{remark}
	Clearly, a permutation $\perm$ is the identity if and only if $\inv{\perm}=\emptyset$.
\end{remark}

% Now, if $\perm \neq id$ there is at least an inversion of the kind
% $(i,i+1)$.  Then we have that $\perm = \transp{i}; \perm'$
% with $|\inv{\perm'}| = |\inv{\perm}| -1$. Hence we can inductively
% express $\perm$ as a (minimal length) composition of adjacent
% transpositions.


We also need to introduce the notion of \emph{switching sequences}.


\begin{definition}
\todo{A: ma questa definizione va tolta, no?}
Consider derivations $\der{D}_i$ for $i \in \interval[0]{n}$
	related by switches
	\begin{center}
		$\der{D}_0 \shift{\nu_1} \der{D}_1 \shift{\nu_2} \ldots \shift{\nu_n}
		\der{D}_n$
	\end{center}
	It will be referred as a \emph{switching sequence}.  
\end{definition}

Switch equivalence is now defined as the equivalence relating derivations which can be obatained one from another by a sequence of switches. Moreover, intermediate graphs can be taken up to isomorphism.\todo{P: da scrivere meglio e fare}

\begin{definition}[Switch equivalence]
  \label{de:switch-equivalence}
  Let $(\X, \R)$ be a left-linear DPO rewriting system.  Let also
  $\der{D}, \der{E} : G \Mapsto H$ be derivations with the same
  length, $\der{D}=\{\dder{D}_{i}\}_{i=0}^n$ and
  $\der{E}=\{\dder{E}_{i}\}_{i=0}^n$. If
  $\dder{D}_i \cdot \dder{D}_{i+1}$ is a switch of
  $\dder{E}_i \cdot \dder{E}_{i+1}$ for some $i \in [0,n-1]$ we write
  $\der{D} \shift{\transp{i}} \der{E}$. 
  
  A \emph{switching sequence} is  a sequence $\{\der{D}_{k}\}_{i=0}^m$ of derivations such that 
  \[\der{D}_0 \shift{\transp{i_1}} \der{D}_1 \shift{\transp{i_2}} \ldots \shift{\transp{i_m}}
  \der{D}_m\]
 In such case, we will often denote by $\nu_{k}$ the transposition $\transp{i_k}$. Given $k \leq h$,
 we denote by $\nu_{k,h}$ the composition
 $\nu_h \circ \nu_{h-1} \circ \ldots \nu_k$. We will say that the
 switching sequence consists of inversions if for all
 $k \in \interval[0]{m}$ the transposition $\nu_k$ is an inversion for
 $\nu_{1,m}$.
  
  We will say that two derivations $\der{D}, \der{E}:G\Mapsto H$ are \emph{switch
    equivalent} if there is a switching sequence, possibly empty, $\{\der{D}_{k}\}_{k=0}^m$ such that
      \[\der{D}\equiv_a \der{D}_0 \shift{\transp{i_1}} \der{D}_1 \shift{\transp{i_2}} \ldots \shift{\transp{i_m}}
    \der{D}_m\equiv _a \der{E}\]
\end{definition}

\begin{remark}\label{rem:abst}
	The possibility of an empty switching sequence assures that two abstraction equivalent derivations are switch equivalent.
\end{remark}


\subsection{Church-Rosser: Relating sequential indepedence and switchability}\label{subsec:CR}


The fact that sequential indepedence implies switchability always
holds for linear rules (see \Cref{prop:equi}). The result is so
indispensable that it is not even stated, in the sense that
in the literature switchability is not introduced axiomatically as in
Definition~\ref{def:switch}, but it is based on the explicit
construction of a switch.

Unfortunately, for left-linear rewriting systems
sequential independence does not imply switchability (while the
converse implication clearly holds), as shown by the next example.

\full{
  \begin{remark}
    \label{rem:fact}
    Notice that, since $f_0'$ is in $\mathcal{M}$, there is
    at most one $i_0' \colon L_0\to D_0'$ such that
    $m_0=f_0' \circ i_0'$. Moreover, we already know that
    there is at most one $i_1' \colon R_1\to D_1'$ such that
    $m_1'=f_1' \circ i_1'$, therefore, the
    independence pair $(i_1',i_0')$ between the components of a switch is
    uniquely determined.
  \end{remark}
}

\begin{example}
  \label{ex:diff1}
  Given two posets $(P, \leq)$ and $(Q, \leq)$, define
  $(P, \leq)\oplus(Q,\leq)$ as the poset whose underlying set is
  the disjoint union $P+Q$ and in which every element of $Q$ is
  greater than every element of $P$, while elements of $P$ and $Q$ are
  compared using the original orders.

  Take now the set $S:=\{a,b,c\}$ and endow it with the smallest order
  such that $a\leq b$ and $a\leq c$.  Take also the set $\mathbb{N}$
  ordered by $\geq$, so that $0$ is its maximum.  Let $\X$ be the
  category associated to the order
  $(S, \leq)\oplus (\mathbb{N}, \geq)$, which by \Cref{rem:iso} is
  $\mathsf{Iso(\X)}$-adhesive. Notice that in this category the arrows
  $(a,b)\colon a\to b$ and $(a,c)\colon a\to c$ do not have a pushout
  because $b$ and $c$ do not have a supremum.  Consider a rewriting
  system whose set of rules $\R$ contains the following two rules
  \[\xymatrix{a & a \ar[r]^{(a, 0)} \ar[l]_{\id{a}} & 0 & a & a
      \ar[r]^{(a, b)} \ar[l]_{\id{a}} & b }\]
  We can then consider the  derivation
  $\der{D}=\{\dder{D}_i\}_{i=0}^1$ of length $2$ below
  \[
    \xymatrix@C=30pt{a \ar[d]_{m_0}&& a \ar[d]_{k_0}\ar[ll]_{\id{a}}
      \ar[r]^{(a,0)} & 0 \ar@/^.35cm/[drrr]|(.315)\hole_(.45){\id{0}}
      \ar[dr]|(.3)\hole_{\id{0}} && a \ar@/_.35cm/[dlll]^(.45){(a,c)}
      \ar[dl]|(.3)\hole^{(a,0)}& a \ar[d]^{(a,0)}\ar@{>->}[l]_{\id{a}}
      \ar[rr]^{(a,b)} && b \ar[d]^{(b,0)}\\c &&
      \ar@{>->}[ll]^{\id{c}} c \ar[rr]_{(c,0)}&& 0 &&
      \ar@{>->}[ll]^{\id{0}} 0 \ar[rr]_{\id{0}}&& 0}\]

  \noindent
  \parbox{10cm}{ \hspace{15pt} Notice that the two
    direct derivations are sequential independent.
    %
    On the other hand, the rule
    applied by $\dder{D}_1$ cannot be applied to $c$. In fact, the
    unique morphism $a\to c$ is $(a,c)$, thus we get the diagram
    aside. But $b$ and $c$ do not have a supremum in the poset
    underlying $\X$, thus we do not get a direct derivation from
    $c$.}  \parbox{3cm}{
    \vspace{-.3cm}$\xymatrix{a \ar[d]_{(a,c)}& a
      \ar[d]_{(a,c)}\ar@{>->}[l]_{\id{a}} \ar[r]^{(a,b)} & b \\c
      & c \ar[l]^{\id{c}} }$}  
\end{example}

\iffalse 

Switches along the same independence pair are unique up to abstraction
equivalence (see Proposition~\ref{thm:switch_uni}).

\begin{example}
  \label{ex:seq-ind}
  Consider a rewriting system in $\cat{Graph}$, the category of
  directed graphs and graph morphisms, which is adhesive. The set of
  rules $\R = \{ \rho_0, \rho_1, \rho_2\}$ consists of three rules as
  depicted in Fig.~\ref{fi:rules}, where numbers are used to represent
  the mappings from the interface to the left- and right-hand
  sides. Rules $\rho_0$ and $\rho_1$ are linear: $\rho_0$ generates a
  new node, while $\rho_1$ delete an edge. Instead, $\rho_2$ is non
  linear as it ``merge'' two nodes.

  \begin{figure}
    \input{Figure/rules.tex}
    
    \caption{Rules of the rewriting system grammar of the example.}
    \label{fi:rules}
  \end{figure}
  
  A derivation $\der{D}$ consisting of three steps $\der{D}_0$,
  $\der{D}_1$, and $\der{D}_2$, each applying the corresponding rule
  $\rho_i$ ,is depicted in in Fig.~\ref{fi:derD}. The second and third
  steps $\der{D}_1$ and $\der{D}_2$ are clearly sequential
  independent, via an independence pairs that map nodes consistently
  with their numbering.\todo{P: having names for the graphs would
    probably help}
  
  \begin{figure}
    \input{Figure/derD.tex}
    \caption{The derivation $\der{D}$.}
    \label{fi:derD}
  \end{figure}

  The category $\cat{Graph}$ is strong enforcing by the result in ...  Thus,
  sequential independence ensure the existence of a switch $\der{E}$,
  depicted in Fig.~\ref{fi:derE}.
  \begin{figure}
    \input{Figure/derE.tex}
    \caption{The derivation $\der{E}$.}
    \label{fi:derE}
  \end{figure}
\end{example}
\fi 

The conditions guaranteeing switchability are inspired
by the notion of \emph{canonical filler}
\cite{heindel2009category}.

\begin{definition}[strong independence pair]
  \label{def:filler}
  Let $\X$ be an $\mathcal{M}$-adhesive category 
  and $(\X, \R)$ a left-linear DPO rewriting system. 
  Let also $(i_0, i_1)$ be an independence pair between two direct
  derivations $\dder{D}_0$, $\dder{D}_1$
  as in the solid part of the diagram below
  \[
    \xymatrix@C=18pt{L_0 \ar[d]_{m_0}&& K_0
      \ar[d]_{k_0}\ar@{>->}[ll]_{l_0} \ar[r]^{r_0} \ar@{.>}@/^.20cm/[ddrr]|(.32)\hole|(.57)\hole_(.7){u_0} & R_0
      \ar@/^.35cm/[drrr]|(.3)\hole^(.2){i_0} \ar[dr]|(.3)\hole_{h_0}
      && L_1 \ar@/_.35cm/[dlll]_(.2){i_1} \ar[dl]|(.3)\hole^{m_1}& K_1
      \ar[d]^{k_1}\ar@{>->}[l]_{l_1} \ar[rr]^{r_1} \ar@{.>}@/_.20cm/[ddll]|(.32)\hole|(.57)\hole^(.7){u_1} && R_1 \ar[d]^{h_1} \\
      %
      G_0 &&
      \ar@{>->}[ll]^{f_0} D_0 \ar[rr]_(.3){g_0}&& G_1 &&
      \ar@{>->}[ll]^(.3){f_1} D_1 \ar[rr]_{g_1}&& G_2\\
      %
      & & & & P \ar@/^.3cm/@{>.>}[ull]^{p_0} \ar@/_.3cm/@{.>}[urr]_{p_1}
    }
  \]

  Consider the pullback of $g_0$ and $f_1$, getting $p_i : P \to D_i$
  ($i \in \{0,1\}$) and the mediating arrows $u_0\colon K_0\to P$ and
  $u_1\colon K_1\to P$ into the pullback object (see \Cref{prop:tec} for details). 
  % given by \Cref{prop:tec} .
  %
  We will say that $(i_0, i_1)$ is a \emph{strong independence pair} if
  the first two squares depicted  
  below are pushouts and if the pushout of $r_1 : K_1 \to R_1$ and $u_1 : K_1 \to P$ exists.
  \[
    \xymatrix{
      K_0 \ar[r]^{r_0} \ar[d]_{u_0}& R_0 \ar[d]^{i_0} & K_1
      \ar@{>->}[r]^{l_1} \ar[d]_{u_1}& L_1 \ar[d]^{i_1}
       &K_1 \ar[r]^{r_1} \ar[d]_{u_1}& R_1\ar@{.>}[d]^{j_0}
      \\
      %
      P \ar[r]_{p_1} & D_1 &P \ar[r]_{p_0} & D_0
       & P \ar@{.>}[r]_{q_1} & Q_1
    }
  \]
\end{definition}


% \begin{definition}[strong independence pair]\label{def:filler}
%   Let $(i_0, i_1)$ be an independence pair between two direct
%   derivations $\dder{D}_0$, $\dder{D}_1$ in $(\X, \R)$ be a
%   left-linear DPO rewriting system with $\X$ $\mathcal{M}$-adhesive.
%   \[
%     \xymatrix@C=15pt{L_0 \ar[d]_{m_0}&& K_0
%       \ar[d]_{k_0}\ar@{>->}[ll]_{l_0} \ar[r]^{r_0} & R_0
%       \ar@/^.35cm/[drrr]|(.3)\hole_(.4){i_0} \ar[dr]|(.3)\hole_{h_0}
%       && L_1 \ar@/_.35cm/[dlll]^(.4){i_1} \ar[dl]|(.3)\hole^{m_1}& K_1
%       \ar[d]^{k_1}\ar@{>->}[l]_{l_1} \ar[rr]^{r_1} && R_1 \ar[d]^{h_1}
%       && P \ar@{>->}[rr]^{p_0} \ar[d]_{p_1}&& D_0\ar[d]^{g_0}\\G_0 &&
%       \ar@{>->}[ll]^{f_0} D_0 \ar[rr]_{g_0}&& G_1 &&
%       \ar@{>->}[ll]^{f_1} D_1 \ar[rr]_{g_1}&& G_2 && D_1
%       \ar@{>->}[rr]_{f_1} && G_1}
%   \]

%   Let also the right square above be a pullback. Let
%   $u_0\colon K_0\to P$ and $u_1\colon K_1\to P$ be the arrows of
%   \Cref{prop:tec}, we will say that $(i_0, i_1)$ is a \emph{strong
%     independence pair} if the first and second square below are
%   pushouts and if the third square exists and it is a pushout too.
%   \[\xymatrix{K_0 \ar[r]^{r_0} \ar[d]_{u_0}& R_0 \ar[d]^{i_0} & K_1
%       \ar@{>->}[r]^{l_1} \ar[d]_{u_1}& L_1 \ar[d]^{i_1}&K_1
%       \ar[r]^{r_1} \ar[d]_{u_1}& R_1\ar@{.>}[d]^{j_0} \\ P
%       \ar[r]_{p_1} & D_1 &P \ar[r]_{p_0} & D_0&P \ar@{.>}[r]_{q_1} &
%       Q_1}\]
% \end{definition}


We can now prove a Local Church-Rosser Theorem for strong independence pairs.


\begin{restatable}[Local Church-Rosser Theorem]{theorem}{thmChurch}
  \label{thm:church}
  Let $(i_0, i_1)$ be a strong independence pair
  between $\dder{D}_0$ and $\dder{D}_1$. Then $\dder{D}_0$ and
  $\dder{D}_1$ are switchable.
\end{restatable}
[Proof in \Cref{thmChurch-proof}]



\todo[inline]{Forse non introdurrei neppure la classe dei strong enforcing, tanto usiamo solo i well switching, o no?}

\todo[inline]{Io invece la introdurrei proprio come punto teorico che mi sembra parecchio importante: qua li condizioni mi garantiscono che gli independence pair implicano la scambiabilità? [DC]}

The correspondence between sequential independence and switchability
is fundamental.  A very large class of DPO rewriting systems -- along the
lines of \cite{baldan2011adhesivity} -- can be identified where all
independence pairs are strong for left-linear rewriting systems. The details are in 
\Cref{app:fill}. Here it is important only to observe that such class includes $\cat{Set}$ and it is closed by comma and functor category constructions. 
As such, it includes essentially all categories (e.g., presheaves over set) that are typically considered for modelling purposes.



%\rem{Non introdurrei una classe, come detto sopra}{
\begin{definition}[Strong Enforcing rewriting systems]A left-linear DPO rewriting system is \emph{strong enforcing} if every independence pair between two direct derivations is strong.
\end{definition}

\begin{example}
  \label{ex:diff2}
  In light of \Cref{thm:church}, \Cref{ex:diff1} provides an example
  of an independence pair which is not strong, and thus of a non strong enforcing
  adhesive rewriting system. Instead the category $\cat{Graph}$ is
  strong enforcing by the result in ....
\end{example}

\begin{remark}
  By \Cref{thm:church} the existence of a strong independence pair
  entails switchability which, in turn, entails weak sequential
  independence by construction. Strong Enforcing rewriting systems are exactly
  those rewriting systems in which these three notions coincide.
\end{remark}
%}



%\rem{Questo e' quanto gia' asserito sopra, mettere in appendice e riferire}

As a sanity check not that a source of strong enforcing left-linear DPO rewriting systems is given by the linear ones, as shown by the following proposition.

\begin{restatable}{proposition}{propEqui}
  \label{prop:equi}
  Every linear DPO rewriting system $(\X, \R)$ is strong enforcing.
\end{restatable}
[Proof in \Cref{propEqui-proof}]

\subsection{Well-switching rewriting systems}\label{subsec:verytame}

Even if we work in a setting where sequential independence ensures switchability, when dealing with left-linear rules there is a further -- and possibly more serious -- issue, i.e., the fact that there can be more than one independence pairs between the same derivations. This can hinder the core idea of using sequential independence as a basis of a theory of concurrency for rewriting systems, since exchanges performed using different independence pairs may lead to derivations that are not abstraction equivalent, and thus one would equate computations that 
should definitively be taken apart, as shown in the example below.

\begin{example}
  Consider the derivation $\der{E}$ from Example~\ref{ex:seq-ind}.
  %
  The last two steps are sequential independent but one easily sees
  that there are two distinct indepedence pair, as the left-hand side
  of $\rho_1$ can be mapped either to node $1$ or to node
  $2$.\todo{Sarebbe bello dire di quale grafo} Correspondingly, there
  are two switches of $\der{E}$: one is the derivation $\der{D}$ in
  Figure~\ref{fi:derD} we started from, the other is the derivation
  $\der{D}'$ in Figure~\ref{fi:derD1}.
  
  \begin{figure}
    \input{Figure/derD1.tex}
    \caption{The derivation $\der{D}'$.}
    \label{fi:derD1}
  \end{figure}
  
  As a consequence, $\der{D}$ and $\der{D}'$ are switch equivalent, but
  this is not acceptable when viewing equivalence classes of
  derivations as concurrent computations: in $\der{D}$ the first two
  steps are not sequential independent, while in $\der{D}'$ they are,
  intuitively because in $\der{D}$ rule $\rho_1$ uses the node
  generated by $\rho_0$, while in $\der{D}'$ rule $\rho_1$ uses the
  node which was in the initial graph. From the technical point of
  view, the property of being switch equivalent is not closed by
  prefix, something which prevents to derive a sensible concurrent
  sematics: if we limit to the first two steps, derivations
  $\der{D}_0; \der{D}_1$ and $\der{D}_0'; \der{D}_1'$ are not switch
  equivalent while $\der{D}$ and $\der{D}'$ would be
\end{example} 

Moreover, limiting sequential independence to the case in which the independence
pair is unique (as suggested in~ ...) brings to the same problems.

For these reasons we support the idea that a theory of rewriting for
left-linear rules in adhesive categories should be developed for
systems where uniqueness of the independence pair is always ensured.


%\subsubsection{Graphical rewriting systems}\label{subsubsec:graphical}


\begin{definition}[well switching rewriting systems]
A left-linear DPO rewriting system $(\X, \R)$ is \emph{well switching} if it is strong enforcing and, for every derivation $\der{D}:=\{\dder{D}_{i}\}_{i=0}^1$, there is at most one independence paire between $\dder{D}_0$ and $\dder{D}_1$.
\end{definition}

The previous definition might sound restrictive. However, it is immediate to see that linear rewriting systems are all well switching (see Proposition~\ref{pr:weak}).
%
Moreover, we next introduce a class of rewriting systems, comprising
all the ones used in concrete modelling applications of DPO rewriting
(e.g., in the encoding of process calculi ..., ...) are \todo{INSERIRE ESEMPI QUI}
actually well switching.

\begin{definition}
Let $\mathcal{G}=(V, E, s, t)$ be a finite directed acyclic graph, we define the \emph{depth} of a vertex $v\in V$ in the following way:
\[\dph(v)=\begin{cases}
0 & \text{there is no $e\in E$ such that $t(e)=v$}\\
m+1 &\text{where } m=\min\{\dph(s(e)) \mid e\in E \text{ such that } t(e)=v \} 
\end{cases}\]
\end{definition}


\begin{remark}
Since $\mathcal{G}$ is acyclic and finite, then $\dph(v)$ is a natural number.
\end{remark}

\begin{definition}[Node-merging graphical rewriting systems]\todo{inserire referenze qui}
Let $\mathcal{G}=(V, E, s, t)$ be a directed acyclic graph, the category  $\gph{G}$ of \emph{$\mathcal{G}$-graphs} is the category $\Set^{\G}$, where $\G$ is the free category over $\mathcal{G}$. A \emph{node-merging graphical rewriting systems} is a left-linear DPO-rewriting system $(\gph{G}, \R)$ such that, for every rule $(l,r)$, with $l\colon K\to L$ and $r\colon K\to R$  in $\R$, the following hold true:
\begin{enumerate}
	\item for every $v\in V$ and $x\in L(v)$, there exists a vertex $w$ with depth $0$ and an arrow $p\colon w\to v$ (i.e.~a path in $\mathcal{G}$) such that  $x$ belongs to the image of $L(p)\colon L(w)\to L(v)$.
	\item $r\colon K\to R$ is mono on vertices of depth $0$: for every $v\in V$ such that $\dph(v)=0$, the component $r_v:K(v)\to R(v)$ is mono.
\end{enumerate}
\end{definition}

\begin{remark}\label{rem:po}
	Notice that $\gph{G}$ is adhesive and that pushouts are computed componentwise, thus if $g\colon F\to G$ is the pushout of $r\colon K\to R$, then $g_v\colon F(v)\to G(v)$ is mono for every $v$ with depth $0$.
\end{remark}

\begin{example}
\todo{esempi (no idea)}
\end{example}

\begin{restatable}{lemma}{lemVTame}
  All node-merging graphical rewriting systems are well switching.
\end{restatable}

[Proof in \Cref{lemVTame}]


\begin{example}[E-graphs]
  Consider the category $\cat{EGraphs}$, where objects are (directed)
  graphs endowed with an equivalence over nodes and arrows are graph
  morphisms which preserve the equivalence, as considered in~\cite{},
  closely related to Egg graphs~\cite{WNW:egg}. Formally,
  $\cat{EGraphs}$ can be seen as the subcategory of the presheaf
  $[E \rightrightarrows V \to Q, \cat{Set}]$ where objects are
  constrained to have the component $Q$ surjective. Explicitly, an
  e-graph $G = \langle s_G, t_G, q_G \rangle$ where
  $s_G, t_G: E_G \rightrightarrows V_G$ provides the graphical
  structure, while the surjective function $q_G : V_G \to Q_G$ maps
  each node to the corresponding equivalence class.
  
  A morphims in $\cat{EGraph}$ is mono if the components over $E$
  and $V$ are mono, i.e., if it is mono as a morphism in
  $\cat{Graph}$. It is \emph{regular mono} if also the component on
  $Q$ is mono, i.e. if it reflects equivalence classes besides
  preserving them.

  \todo[inline]{$\cat{EGraph}$ is quasi-adhesive and well switching}  
\end{example}

\subsection{Switch equivalence via consistent permutations} \label{subsec:perm}


Given DPO rewriting system $(\X, \R)$,  a derivation $\der{D}$ determines a diagram
$\Delta(\der{D})$ in $\X$. Using $\mathcal{M}$-adhesivity, it can be shown that such diagram 
has a colimit $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D})})$ and that, if $(\X, \R)$ is linear,
then every coprojection is in $\mathcal{M}$ (see \Cref{lem:colim} for details and a proof of these statements).

\begin{definition}[Consistent permutation]
	\label{def:permcon}
	Let $\X$ be an $\mathcal{M}$-adhesive category and consider a
	left-linear DPO rewriting system $(\X, \R)$ on it.  Take two
	non-empty decorated derivations $(\der{D}, \alpha, \omega)$ and
	$(\der{D}', \alpha', \omega')$ with the same length and with
	isomorphic sources and targets.
	
	A \emph{consistent} permutation between two derivations $\der{D}=\{\dder{D}_i\}_{i=0}^n$ and
	$\der{D}'=\{\dder{D}'_i\}_{i=0}^n$ with associated sequence of rules
	$r(\der{D})=\{\rho_i\}_{i=0}^n$ is a permutation
	$\sigma\colon [0,n]\to [0,n]$ such that, for every $i\in [0,n]$,
	$\rho_i=\rho'_{\sigma(i)}$ and, moreover, there exists a
	\emph{mediating isomorphism}
	$\xi_\sigma\colon \tpro{D} \to \lpro \der{D}' \rpro$ fitting in the
	following diagrams, where $m_i, m'_i, h_i$ and $h'_i$ are,
	respectively, the matches and back-matches of $\dder{D}_i$ and
	$\dder{D}'_i$
	
	\[
	\xymatrix{
		G_0 \ar[r]^{\iota'_{G'_0}} \ar[d]_{\iota_{G_0}}& \lpro \der{D}' \rpro &L_i\ar[r]^{m_i} \ar[d]_{m'_{\sigma(i)}}& G_i \ar[r]^{\iota_{G_i}}
		&\tpro{D} \ar[d]^{\xi_\sigma} & R_i \ar[r]^{h_i}
		\ar[d]_{h'_{\sigma(i)}}& G_{i+1} \ar[r]^{\iota_{G_{i+1}}}
		&\tpro{D} \ar[d]^{\xi_\sigma} \\\tpro{D} \ar[ur]_{\xi_\sigma}&&G'_{\sigma(i)}
		\ar[rr]_{\iota'_{G'_{\sigma(i)}}}&& \lpro \der{D}' \rpro&
		G'_{\sigma(i)+1} \ar[rr]_{\iota'_{G'_{\sigma(i)+1}}}&& \lpro
		\der{D}' \rpro}
	\]
\end{definition}


\begin{remark}\label{rem:abs}
	Let $\der{D}$ and $(\der{E}, \alpha', \omega')$ be two abstraction equivalent derivations of length $n$. Then the identity permutation $\id{[0,n-1]}\colon [0,n-1]\to [0,n-1]$ is a consistent permutation between them. In such a case we can take as $\xi_{\id{[0,n-1]}}\colon \tpro{D}\to \lpro \der{D}'\rpro$ simply the isomorphism induced by any abstraction equivalence.
\end{remark}

\begin{remark}\label{rem:compo}
	It is immediate to see that consistent permutations $\sigma$ and $\tau$ compose: as mediating isomorphism it is enough to take the composite of $\xi_{\sigma}$ and $\xi_\tau$. Similarly, $\xi^{-1}_{\sigma}$ witnesses that $\sigma^{-1}$ is a consistent permutation whenever $\sigma$ is so.
\end{remark}
In a linear rewriting system the converse also holds.

\begin{restatable}{proposition}{lemIde}\label{lem:ide}
	Let $\der{D}$ and $\der{D}'$ be two derivations in a linear DPO-rewriting system $(\X, \R)$ with the same length $l$. If $\id{[0,l-1]}:[0,l-1]\to [0,l-1]$ is a consistent permutation, then $\der{D}$ and $\der{D}'$ are abstraction equivalent.  
\end{restatable}
[Proof in \Cref{lemide-proof}]


\begin{restatable}{proposition}{propcoswitch}\label{prop:coswitch}
Let $\der{D}$ and $\der{E}$ be two switch equivalent derivations, then there exists a consistent permutation between them.
\end{restatable}	
[Proof in \Cref{propcoswitch-proof}]

In the linear case, the existence of a consistent permutation it is enough to characterize switch equivalence. \todo{FORSE QUA METTEREI DEI POINTER A QUALCHE LAVORO PASSATO?}


\begin{restatable}{theorem}{thmcoswitch}
Let $\X$ be an $\mathcal{M}$-adhesive category and 
$\der{D}$ and $\der{D}'$ be two derivations in a linear DPO-rewriting system $(\X, \R)$. 
Then the following are equivalent:
\begin{enumerate}
	\item $\der{D}$ and $\der{D}'$ are switch equivalent;
	\item there exists a consistent permutation $\sigma\colon [0,\lgh(\der{D})-1]\to [0,\lgh(\der{D})-1]$ between them.
\end{enumerate}
\end{restatable}
[Proof in \Cref{thmswitch-proof}]


\begin{example}
  The result above fails when considering left-linear
  derivations. This is readily seen by considering derivations
  $\der{D}$ in Fig.~\ref{fi:derD} and $\der{D}'$ in
  Fig.~\ref{fi:derD1}. We already observed that
  $\der{D} \not\equiv_a \der{D}'$\todo{P: osservato?}
  %
  Still, it is easy to see that they are related by a consistent
  permutation, which is the identity on productions. The colimit of
  both derivations is a single node with a self loop, i.e., the
  terminal object in $\cat{Graph}$, hence all commutation requirements
  are trivially satisfied.
\end{example}


\subsection{A canonical form for  switch equivalences}
\label{subsec:canonical}

The characterisation of switch equivalence based on consistent permutations is the key to
derive some simple but fundamental properties for linear rewriting systems, namely
\begin{enumerate}
\item \emph{confluence of switching}: when transforming derivation
  sequences into equivalent ones by switching independent steps, the
  result not depends on the order in which switchings are applied, but
  only on the resulting permutation;
  
\item \emph{globality of independence}: if two independent steps are
  moved forward or backward due to the application of switchings to a
  derivation, they remain independent.
\end{enumerate}


In particular, the two properties allows one to obtain a \emph{canonical form} for switching sequences: whenever two derivation sequences are switch equivalence via some permutation $\sigma$, then each one can be obtained from the other by applying switchings to pairs of rule applications which $\sigma$ reverses (the so-called inversions).\todo{P: un po' di questi discorsi sono copiati nell'intro, ridurre}

The failure of the characterisation of switch equivalence via
consistent permutations for left-linear rules leads to the
question asking whether the properties above hold.

In this section we show that actually much of the theory can be retained: confluence of switching still holds, while globality of independence holds in a weak form, conceptually linked to the fact that fusions introduce a form of disjunctive causality. Finally, a canonical form for switching sequences can also be recovered.

We start by proving two lemmas dealing with derivations of length
$3$. Despite being technical, these lemma are the fundamental building blocks for showing properties (1) and (2) above.

The first lemma capture the essence of the confluence of
switchings. It shows that if we have a derivation consisting of three
rewriting steps, say $r_0\, r_1\, r_2$ and we switch them leading to the
sequence $r_2\, r_1\, r_0$, we obtain the same resulting derivation,
independently from the order of the switchings.


\begin{restatable}[confluence of switchings]{lemma}{lemSwitchConfluence}
  \label{lem:switch-confluence}
  Let $\X$ be an $\mathcal{M}$-adhesive category and $(\X,\R)$ a
  left-linear DPO rewriting system.
  % 
  Consider a derivation $\der{D}=\{\dder{D}_i\}_{i=0}^2$ and suppose
  that $(i_0,i_1)$ is a strong independence pair between $\dder{D}_0$
  and $\dder{D}_1$, $(a_0,a_1)$ one between $\dder{D}_1$ and
  $\dder{D}_2$ and $(e_0, e_1)$ one between $\dder{D}_0$ and
  $S_{a_0,a_1}(\dder{D}_2)$.\todo{P: non e' meglio qui limitarci a well switching, cosi' da evitare riferimenti a strong pairs?}
\end{restatable}

[Proof~\ref{lemSwitchConfluence-proof}]


The next technical lemma is at the core of globality for independence. It shows that if we have a derivation consisting of three
rewriting steps, say $r_0\, r_1\, r_2$ where $r_0$ and $r_1$ are independent, then if we switch $r_2$ to the first position, 
obtaining a derivation $r_2\, r_0\, r_1$, the steps $r_0$ and $r_1$ are still independent.

Instead, if in $r_0\, r_1\, r_2$ we have $r_1$ and $r_2$ are
independent, and we switch $r_0$ to the last position, obtaining a
derivation $r_1\, r_2\, r_0$, the steps $r_1$ and $r_2$ could be no
longer independent, unless an additional condition is
satisfied. Intuitively this is due to the fact that, dealing with
left-linear rewriting systems introduces disjunctive forms of
causality. Hence, if in $r_0\, r_1\, r_2$ we have that $r_0, r_1$ are
disjunctive causes of $r_2$, at least one of the two is needed to
enable the application of $r_2$ and this explain why in
$r_1\, r_2\, r_0$ we have that $r_1$ and $r_2$ are no longer
independent.

\begin{example}
  Consider the rewriting system used as running example (rules in
  Fig.~\ref{fi:rules}. Assume to add rules $\rho_3$ and $\rho_4$ as
  depicted in Fig.~\ref{fi:rules-cas}. Consider the derivation
  $\der{F}$ in Fig.~\ref{fi:derF}. Observe that rule $\rho_4$ to be
  applied needs a self loop on node $12$. This can be generated either
  by $\rho_3$ or $\rho_1$ merging nodes $1$ and $2$, hence at least
  one of them must precede the application of $\rho_4$. Indeed, in $\der{E}$ it can be easily seen that the second and third step applying $\rho_1$ and $\rho_3$ are independent. However, we could switch twice the application of $\rho_3$, bringing it in the last position, obtaining a derivation $\der{F}'$ (see {\color{red} DA FINIRE, se ci sta}), where the applications of  $\rho_1$ and $\rho_3$ are no longer independent.
   
  \begin{figure}
    \input{Figure/rules-cas.tex}    
    \caption{Additional rules.}
    \label{fi:rules-cas}
  \end{figure}

  \begin{figure}
    \input{Figure/derF.tex}    
    \caption{A derivation $\der{F}$.} 
    \label{fi:derF}
  \end{figure}
\end{example}

\begin{restatable}[Globality of independence]{lemma}{lemIndepGlobalLeft}
  \label{lem:indep-global-left}
  Let $\X$ be an $\mathcal{M}$-adhesive category and
  $(\X,\R)$ a left-linear DPO rewriting system.
  Consider a derivation
  $\der{D}=\{\dder{D}_i\}_{i=0}^2$ and suppose that $(i_0,i_1)$ is a
  strong independence pair between $\dder{D}_0$ and $\dder{D}_1$,
  $(a_0,a_1)$ one between $\dder{D}_1$ and $\dder{D}_2$ and
  $(e_0, e_1)$ one between $\dder{D}_0$ and
  $S_{a_0,a_1}(\dder{D}_2)$. Then the following properties hold true.
  \begin{enumerate}
  \item
    \label{lem:indep-global-left:1}
    $S_{e_0,e_1}(\dder{D}_0)$ and $S_{a_0,a_1}(\dder{D}_1)$ are
    sequentially independent.
    
  \item
    \label{lem:indep-global-left:2}
    If $S_{i_0, i_1}(\dder{D}_0)\seqind \dder{D}_2$ with a
    strong independence pair $(\alpha_0, \alpha_1)$, then
    $S_{i_0,i_1}(\dder{D}_1)$ and $S_{\alpha_0, \alpha_1}(\dder{D}_2)$
    are  sequentially independent.
  \end{enumerate}
\end{restatable}

\todo{P: anche qui sopra mi limiterei a well switching, cos\i' da evitare riferimenti a strong e se si riesce anche alle indepdencen pairs}
  %

[Proof~\ref{lemIndepGlobalLeft-proof}]

The lemmas above open the way to the key result of this section establishing a canonical form for
switching derivations.

The first result shows that whenever equating two derivation sequences by performing a sequence of switching, we can just limit ourselves to ``useless shwitching'' which invert the order of steps which in the target derivation has to be reversed, i.e., we can limit ourserrvels to inversions.

\begin{restatable}[no need of useless switchings]{theorem}{thNoNeed}
  \label{th:no-need}
  Let $\der{D}$ and $\der{D}'$ be derivation sequences. If $\der{D} \shifteq \der{D}'$ then there is a switching sequence consisting only of inversions
  \begin{center}
    $\der{D} = \der{D}_0 \shift{\nu_1} \der{D}_1 \shift{\nu_2} \ldots
    \shift{\nu_n} \der{D}_n=\der{D}'$
  \end{center}
\end{restatable}

[Proof~\ref{thNoNeed-proof}]

While in the case of linear rewriting systems inversion can be
performed in any order, this is no longer true for left-linear
rewriting systems.\todo{P: counter example} Still, we can identify a
canonical form for switching derivations.


\begin{restatable}[canonical form]{corollary}{coCanonical}
  \label{co:canonical}
  Let $\der{D}$ and $\der{D}'$ be derivation sequences. If
  $\der{D} \shifteq[\sigma]\der{D}'$ then there is a switching sequence
  \begin{center}
    $\der{D} = \der{D}_0 \shift{\nu_1} \der{D}_1 \shift{\nu_2} \ldots
    \shift{\nu_n} \der{D}_n=\der{D}'$
  \end{center}
  where for each $i \in \interval{n}$ the transpostion $\nu_i  = \transp{k}$ is such that 
  $k = \max \{ j \mid \transp{j} \in \inv{\nu_{i,n}}\}$.\todo{P: $\nu_{i,n} = \sigma \circ \nu_{1,i}$, giusto? forse e' piu' carino}
\end{restatable}

[Proof~\ref{coCanonical-proof}]

\iffalse
	\begin{corollary} Given a strong enforcing  left-linear DPO rewriting system  $(\X,\R)$ with $\X$ an $\mathcal{M}$-adhesive category and a decorated derivation $(\der{D}, \alpha, \omega)$ with $\der{D}=\{\dder{D}_i\}_{i=0}^2$. Then the following are true:
		\begin{enumerate}
			\item suppose that $(a_1,a_2)$ and $(e_0,e_1)$ are independence pairs witnessing  $\dder{D}_1\updownarrow_! \dder{D}_2$ and $\dder{D}_0\updownarrow_! S_{a_1,a_2}(\dder{D}_2)$ respectively, if $\dder{D}_0\updownarrow_!\dder{D}_1$, then $S_{e_0,e_1}(\dder{D}_0)\updownarrow_!S_{a_2,a_2}(\dder{D}_1)$;
			\item
		\end{enumerate}
	\end{corollary}

	\todo{ripulire le ipotesi: serve scambiabilitÃ  propria tra 1 e 2}
	\todo{sistemare il fatto che qua utilizziamo derivazioni di 3 passi}
	\begin{proof}
		\begin{enumerate}
			\item Let $(i_1,i_2)$ be the unique independence pair between $\dder{D}_0$ and $\dder{D}_1$.  By tameness and \Cref{lem:indep-global-left} we know that $S_{e_0,e_1}(\dder{D}_0)\updownarrow S_{a_1,a_2}(\dder{D}_1)$. Let $(\alpha_1, \alpha_2)$ be the independence pair constructed in the proof of \Cref{lem:indep-global-left}. Take another independence pair $(\beta_1, \beta_2)$,  by \Cref{rem:weak} we already know that $\beta_1=\alpha_1$. Let also $\der{E}$ be the derivation $S_{e_0, e_1}(S_{a_1, a_2}(\der{D}_2))\cdot S_{e_0, e_1}(\dder{D}_0) \cdot S_{a_1, a_2}(\der{D}_1)$. Let $\sigma\colon [0,2]\to [0,2]$ be the cycle $(0,1,2)$. By \Cref{lem:consperm} we know that $\sigma$ is a consistent permutation between $(\der{D}, \alpha, \omega)$ and $(\der{E}, \alpha, \omega)$. In particular, we have
			      \begin{align*}
				      \iota_{\der{E}, G_0}\circ f_0\circ  i_1 & =\xi_\sigma \circ 	\iota_{\der{D}, G_0}\circ f_0\circ  i_1 \\&= \xi_\sigma \circ 	\iota_{\der{D}, D_0}\circ  i_1\\ &= \xi_\sigma \circ \iota_{\der{D}, G_1} \circ g_0\circ  i_1 \\&=\xi_\sigma \circ \iota_{\der{D}, G_1}\circ m_1\\ &=  \iota_{\der{E}, G'_2}\circ y_1\circ b_1\\&= \iota_{\der{E}, G'_2}\circ z'_1\circ \beta_2\\&= \iota_{\der{E}, Q_5}\circ \beta_2
			      \end{align*}
			      Using	\Cref{rem:pbsalva} we can deduce the existence of a unique arrow $\beta'_2\colon L_1\to P_3$ fitting in the diagram below
			      \[\xymatrix@C=30pt{L_1  \ar@/^.3cm/[drr]^{\beta_2} \ar@/_.3cm/[ddr]_{i_1}\ar@{.>}[dr]^{\beta'_2}\\& P_3 \ar[r]^{n_1}  \ar[d]_{u_0}& Q_5 \ar[d]^{\iota_{\dder{E}, Q_5}}\\
				      &D_0 \ar[r]_{\iota_{\dder{E}, G_0}}& \tpro{E}}\]
			      If we further compute, we get
			      \begin{align*}
				      y_1\circ u_1\circ \beta'_2 & =z'_1\circ n_1\circ \beta'_2= \\&= z'_1\circ \beta_2 \\&=y_1\circ b_1
			      \end{align*}
			      Thus $(u_1\circ \beta'_2, b_2)$ is an independence pair between $S_{a_1, a_2}(\der{D}_2)$ and $S_{a_1, a_2}(\der{D}_1)$ therefore, by hypothesis $u_1\circ \beta'_2=b_1$. But this implies that $\beta'_2$ and $\alpha'_2$ are equal, giving us the thesis.

			      \todo{ripulire le ipotesi: serve scambiabilitÃ  propria tra 1 e 2}
			      \todo{sistemare il fatto che qua utilizziamo derivazioni di 3 passi}

			\item \qedhere
		\end{enumerate}
	\end{proof}


	\todo{mettere esempio del perchÃ© fallisce nell'altra direziome}
	\todo{anche una breve intro}

	\begin{lemma}\label{lem:iig2}Let $(\X,\R)$ be a left-linear DPO rewriting system with $\X$ an $\mathcal{M}$-adhesive category. For every derivation $\der{D}=\{\dder{D}_i\}_{i=0}^2$, if $(i_0,i_1)$ is a strong independence pair between $\dder{D}_0$ and $\dder{D}_1$, $(a_1,a_2)$ one between $\dder{D}_1$ and $\dder{D}_2$ and $\dder{D}_0\updownarrow S_{a_1,a_2}(\dder{D}_2)$ with strong independence pair $(e_0,e_1)$, then $S_{e_0,e_1}(\dder{D}_0)$ and $S_{a_1,a_2}(\dder{D}_1)$ are weakly sequentially independent.
	\end{lemma}
	\begin{proof} As in the proof of \Cref{lem:indep-global-left}, \Cref{def:filler,def:switch} yield to us some diagrams.  First of all, let $(v,v')$ be the filler between $\dder{D}_0$ and $\dder{D}_1$ associated to $(i_1, i_2)$, then we have
		\[\xymatrix{&&R_0 \ar@/_1cm/[ddrr]_(.35){i_0}|(.7)\hole \ar[dr]^{h_0}&& L_1\ar@/^1cm/[ddll]^(.35){i_1}  \ar[dl]_{m_1}\\&K_0\ar[dr]^{k_0}\ar[dl]_{l_0} \ar@/_.8cm/[ddrr]|(.36)\hole^(.65){v}\ar[ur]^{r_0}&& G_1 && K_1 \ar@/^.8cm/[ddll]|(.36)\hole_(.65){v'}\ar[dl]_{k_1}\ar[lu]_{l_1} \ar[dr]^{r_1}\\L_0 \ar@/_.8cm/[ddrr]_(.2){j_0}|(.31)\hole|(.81)\hole \ar[dr]^(.4){m_0}|(.61)\hole && D_0 \ar[dl]|(.4)\hole_(.65){f_0}\ar[ur]|(.5)\hole^(.7){g_0}&&D_1 \ar[dr]|(.4)\hole^(.65){g_1} \ar[ul]|(.5)\hole_(.65){f_1}&&R_1\ar@/^.8cm/[ddll]^(.2){j_1}|(.31)\hole|(.81)\hole\ar[dl]_{h_1}\\&G_0 &&P_1\ar[dr]_{q_1} \ar[dl]^{q_0}\ar[ur]^(.4){p_1}\ar[ul]_(.4){p_0}&&G_2\\L_1 \ar@/^.8cm/[uurr]^(.2){i_1} \ar[ur]_(.35){f_0\circ i_1}|(.61)\hole&&Q_0 \ar[ul]|(.4)\hole_(.65){s_0}\ar[dr]|(.5)\hole^(.65){t_0} &&Q_1\ar[ur]|(.4)\hole^(.65){t_1} \ar[dl]|(.5)\hole_(.65){s_1} && R_0  \ar[ul]^(.35){g_1\circ i_0}|(.61)\hole\ar@/_.8cm/[uull]_(.2){i_0}\\&K_1 \ar[ur]_{q_0\circ v'} \ar[dr]_{r_1} \ar[ul]^{l_1}\ar@/^.8cm/[uurr]_(.65){v'}&&G'_1&& K_0 \ar[ur]_{r_0} \ar[ul]^{q_1\circ v} \ar[dl]^{l_0} \ar@/_.8cm/[uull]^(.65){v}\\&& R_1 \ar[ur]_{\hspace{-5pt}s_1\circ j_1}\ar@/^1cm/[uurr]^(.25){j_1}&& L_0 \ar[ul]^{t_0\circ j_0\hspace{-5pt}} \ar@/_1cm/[uull]_(.25){j_0} |(.69)\hole }\]

		Secondly, the filler $(u,u')$ induced by $(a_1, a_2)$ between $\dder{D}_1$ and $\dder{D}_2$ yields:
		\[
			\xymatrix{&&R_1 \ar@/_1cm/[ddrr]_(.35){a_1}|(.7)\hole \ar[dr]^{h_1}&& L_2\ar@/^1cm/[ddll]^(.35){a_2}  \ar[dl]_{m_2}\\&K_1\ar[dr]^{k_1}\ar[dl]_{l_1} \ar@/_.8cm/[ddrr]|(.36)\hole^(.65){u}\ar[ur]^{r_1}&& G_2 && K_2 \ar@/^.8cm/[ddll]|(.36)\hole_(.65){u'}\ar[dl]_{k_2}\ar[lu]_{l_2} \ar[dr]^{r_2}\\L_1 \ar@/_.8cm/[ddrr]_(.2){b_1}|(.31)\hole|(.81)\hole \ar[dr]^(.4){m_1}|(.61)\hole && D_1 \ar[dl]|(.4)\hole_(.65){f_1}\ar[ur]|(.5)\hole^(.7){g_1}&&D_2 \ar[dr]|(.4)\hole^(.65){g_2} \ar[ul]|(.5)\hole_(.65){f_2}&&R_2\ar@/^.8cm/[ddll]^(.2){b_2}|(.31)\hole|(.81)\hole\ar[dl]_{h_2}\\&G_1 &&P_2\ar[dr]_{d_2} \ar[dl]^{d_1}\ar[ur]^(.4){c_2}\ar[ul]_(.4){c_1}&&G_2\\L_2 \ar@/^.8cm/[uurr]^(.2){a_2} \ar[ur]_(.35){f_1\circ a_2}|(.61)\hole&&Q_2 \ar[ul]|(.4)\hole_(.65){x_1}\ar[dr]|(.5)\hole^(.65){y_1} &&Q_3\ar[ur]|(.4)\hole^(.65){y_2} \ar[dl]|(.5)\hole_(.65){x_2} && R_1  \ar[ul]^(.35){g_2\circ a_1}|(.61)\hole\ar@/_.8cm/[uull]_(.2){a_1}\\&K_2 \ar[ur]_{d_1\circ u'} \ar[dr]_{r_2} \ar[ul]^{l_2}\ar@/^.8cm/[uurr]_(.65){u'}&&G'_2&& K_1 \ar[ur]_{r_1} \ar[ul]^{d_2\circ u} \ar[dl]^{l_1} \ar@/_.8cm/[uull]^(.65){u}\\&& R_2 \ar[ur]_{\hspace{-5pt}x_2\circ b_2}\ar@/^1cm/[uurr]^(.25){b_2}&& L_1 \ar[ul]^{y_1\circ b_1\hspace{-5pt}} \ar@/_1cm/[uull]_(.25){b_1} |(.69)\hole }\]

		Finally, the filler $(w,w')$  between $\dder{D}_0$ and $S_{u,u'}(\dder{D}_2)$ given by $(e_0, e_1)$ provides us with:
		\[\xymatrix{&&R_0 \ar@/_1cm/[ddrr]_(.35){e_0}|(.7)\hole \ar[dr]^{h_0}&& L_2\ar@/^1cm/[ddll]^(.35){e_1}  \ar[dl]_{f_1\circ a_2}\\&K_0\ar[dr]^{k_0}\ar[dl]_{l_0} \ar@/_.8cm/[ddrr]|(.36)\hole^(.65){w}\ar[ur]^{r_0}&& G_1 && K_2 \ar@/^.8cm/[ddll]|(.36)\hole_(.65){w'}\ar[dl]_{d_1\circ u'\hspace{-5pt}}\ar[lu]_{l_2} \ar[dr]^{r_2}\\L_0 \ar@/_.8cm/[ddrr]_(.2){o_0}|(.31)\hole|(.81)\hole \ar[dr]^(.4){m_0}|(.61)\hole && D_0 \ar[dl]|(.4)\hole_(.65){f_0}\ar[ur]|(.5)\hole^(.7){g_0}&&Q_2 \ar[dr]|(.4)\hole^(.65){y_1} \ar[ul]|(.5)\hole_(.65){x_1}&&R_2\ar@/^.8cm/[ddll]^(.2){o_1}|(.31)\hole|(.81)\hole\ar[dl]_(.35){x_2\circ b_2}\\&G_0 &&P_3\ar[dr]_{n_1} \ar[dl]^{n_0}\ar[ur]^(.4){u_1}\ar[ul]_(.4){u_0}&&G'_2\\L_2 \ar@/^.8cm/[uurr]^(.2){e_1} \ar[ur]_(.35){f_0\circ e_1}|(.61)\hole&&Q_4 \ar[ul]|(.4)\hole_(.65){z_0}\ar[dr]|(.5)\hole^(.65){z'_0} &&Q_5\ar[ur]|(.4)\hole^(.65){z'_1} \ar[dl]|(.5)\hole_(.65){z_1} && R_0  \ar[ul]^(.35){y_1\circ e_0}|(.61)\hole\ar@/_.8cm/[uull]_(.2){e_0}\\&K_2 \ar[ur]_{n_0\circ w'} \ar[dr]_{r_2} \ar[ul]^{l_2}\ar@/^.8cm/[uurr]_(.65){w'}&&G'_1&& K_0 \ar[ur]_{r_0} \ar[ul]^{n_1\circ w} \ar[dl]^{l_0} \ar@/_.8cm/[uull]^(.65){w}\\&& R_2 \ar[ur]_{\hspace{-4pt}z_1\circ o_1}\ar@/^1cm/[uurr]^(.25){o_1}&& L_0 \ar[ul]^{z'_0\circ o_0\hspace{-5pt}} \ar@/_1cm/[uull]_(.25){o_0} |(.69)\hole }\]

		We have to construct the two dotted arrows in the diagram below.
		\[\xymatrix@C=15pt{L_0 \ar[d]_{z'_0\circ o_0}&& K_0 \ar[d]_{n_1\circ w}\ar[ll]_{l_0} \ar[r]^{r_0} & R_0 \ar@{.>}@/^.35cm/[drrr]_(.4){\alpha_1}|(.285)\hole \ar[dr]|(.28)\hole_{y_1\circ e_0} && L_1 \ar@{.>}@/_.35cm/[dlll]^(.4){\alpha_2} \ar[dl]|(.28)\hole^{y_1\circ b_1}& K_1 \ar[d]^{d_2\circ u}\ar[l]_{l_1} \ar[rr]^{r_1} && R_1 \ar[d]^{g_2\circ a_1}\\G'_1 && \ar[ll]^{z_1} Q_5 \ar[rr]_{z'_1}&& G'_2  && \ar[ll]^{x_2} Q_3 \ar[rr]_{y_2}&& G_2}\]

		Consider the arrows $i_0\colon R_0\to D_1$ and $e_0\colon R_0\to Q_2$. An easy computation shows that
		\begin{align*}
			f_1\circ i_0 & = h_0 \\&=x_1\circ e_0
		\end{align*}
		entailing the existence of  the dotted $\alpha'_1\colon R_0\to P_2$ in the diagram
		\[\xymatrix{R_0 \ar@{.>}[dr]^{\alpha'_1} \ar@/^.3cm/[drr]^{i_0} \ar@/_.3cm/[ddr]_{e_0}\\ &P_2 \ar[r]^{c_2} \ar[d]_{d_1}& D_1 \ar[d]^{f_1}\\ &Q_2\ar[r]_{x_1} & G_1}\]
		If we define $\alpha_1\colon R_0\to Q_3$ as $d_2\circ \alpha'_1$, then we easily get that
		\begin{align*}
			x_2\circ \alpha_1 & =x_2\circ d_2\circ \alpha'_1 \\&= y_1\circ d_1\circ \alpha'_1\\&=y_1\circ e_0
		\end{align*}

		For $\alpha_2$, we proceed similarly. First consider  $i_1\colon L_1\to D_0$ and $b_1\colon L_1 \to Q_2$ and notice that
		\begin{align*}
			g_0\circ i_1 & = m_1 \\&= x_1 \circ b_1
		\end{align*}
		implying the existence of $\alpha'_2\colon L_1\to P_3$ fitting in the diagram below.
		\[\xymatrix{L_1 \ar@{.>}[dr]^{\alpha'_2} \ar@/^.3cm/[drr]^{i_1} \ar@/_.3cm/[ddr]_{b_1}\\ &P_3 \ar[r]^{u_0} \ar[d]_{u_1}& D_0 \ar[d]^{g_0}\\ &Q_2\ar[r]_{x_1} & G_1}\]
		Let $\alpha_2\colon L_1\to Q_5$ be $n_1\circ \alpha'_2$, then
		\begin{align*}
			z'_1 \circ \alpha_2 & = z'_1 \circ n_1\circ \alpha'_2 \\&=y_1\circ u_1\circ \alpha'_2\\&=y_1\circ b_1
		\end{align*}
		The thesis now follows.
	\end{proof}
\fi





\section{Conclusions and further work}
\todo{VERY NICE CONCLUSIONS}

\bibliography{bibliog.bib}


\appendix
\section{Properties of $\mathcal{M}$-adhesive categories}\label{app:ade}

This first appendix is devoted to the proofs of some well-known results about $\mathcal{M}$-adhesive categories.

Observe that our notion of $\mathcal{M}$-adhesivity follows
\cite{ehrig2012,ehrig2014adhesive} and is different from the one of
\cite{azzi2019essence}. What is called $\mathcal{M}$-adhesivity in
that paper corresponds to our strict
$\mathcal{M}$-adhesivity. Moreover, in \cite{azzi2019essence} the
class $\mathcal{M}$ is assumed to be only stable under
pullbacks. However, if $\mathcal{M}$ contains all split monos, then
stability under pushouts can be deduced from the other
axioms~\cite[Prop.~$5.1.21$]{castelnovo2023thesis}.



\subsection{Some results on $\mathcal{A}$-stable and $\mathcal{A}$-Van Kampen squares}
We will start proving some general results regarding $\mathcal{A}$-Van Kampen and $\mathcal{A}$-stable squares. Let us begin recalling some classical results about  about pullbacks and pushouts\cite{mac2013categories}.

\noindent 
\parbox{10.5cm}{\begin{lemma}\label{lem:popb1} \label{lem:pb1} \label{lem:po1}
Let $\X$ be a category, and consider the diagram  aside, then the following are true:
	\begin{enumerate}
		\item if the right square is a pullback, then the whole rectangle is a pullback if and only if the left square is one;
		\item if the left square is a pushout, 	then the whole rectangle is a pushout if and only if the right square is one.
	\end{enumerate}
\end{lemma}}
\parbox{4cm}{$\xymatrix{X \ar[d]_{a} \ar[r]^{f}& \ar[r]^{g} Y \ar[d]^{b}& Z \ar[d]^{c}\\ A \ar[r]_{h}& B \ar[r]_{k}& C}$}\\

The following proposition establishes a key property of $\mathcal{A}$-Van Kampen squares with a mono as a side: they are not only pushouts, but also pullbacks \cite{ehrig2004adhesive,behr2022fundamentals,lack2005adhesive}.

\noindent 
\parbox{11.5cm}{\begin{proposition}\label{prop:pbpo} Let $\mathcal{A}$ be a class of arrows stable under pushouts and containing all the isomorphisms.  If $m\colon A\to C$ is mono and belongs to $\mathcal{A}$, then every $\mathcal{A}$-Van Kampen square
	is also a pullback square and $n$ is a monomorphism.
\end{proposition}}
\parbox{2cm}{\vspace{1.5ex}$\xymatrix{A\ar[r]^{g} \ar[d]_{m} & B \ar[d]^{n} \\ C \ar[r]_{f}  & D}$}

\full{ 
\begin{proof}
	We can start considering the cube below and noticing that $n$, being the pushout of $m\in \mathcal{M}$, belongs to $\mathcal{A}$ too.
	\[\xymatrix@C=13pt@R=13pt{&A\ar[dd]|\hole_(.65){\id{A}}\ar[rr]^{g} \ar[dl]_{\id{A}} && B \ar[dd]^{\id{B}} \ar[dl]_{\id{B}} \\ A  \ar[dd]_{m}\ar[rr]^(.65){g} & & B \ar[dd]_(.3){n}\\&A\ar[rr]|\hole^(.65){g} \ar[dl]^{m} && B \ar[dl]^{n} \\C \ar[rr]_{f} & & D}\]
	By construction the top face of the cube is a pushout and the back one a pullback. The left face is a pullback because $m$ is mono. Thus the $\mathcal{A}$-Van Kampen property yields that the front and the right faces are pullbacks.
\end{proof}}

The previous proposition, now, allows us to establish the following result.

\noindent \parbox{7.4cm}{
\begin{lemma}\label{lem:varie}Let $\mathcal{A}$ be a class of arrows stable under pullbacks, pushouts and containing all isomorphisms.  Suppose that, the left square below is $\mathcal{A}$-Van Kampen, while the vertical faces in the right cube are pullbacks. 	Supppose, moreover that $m\colon A\to C$ and $d\colon D'\to D$ are mono and that $d$ belongs to $\mathcal{A}$. Then $d\leq n$ if and only if $c \leq m$.
\end{lemma}}
	\parbox{6cm}{$\xymatrix@C=10pt@R=10pt{&&&&&A'\ar[dd]|\hole_(.65){a}\ar[rr]^{g'} \ar[dl]_{m'} && B' \ar[dd]^{b} \ar[dl]_{n'} \\ A \ar[dd]_{m}\ar[rr]^{g}&&B\ar[dd]^{n}&&C'  \ar[dd]_{c}\ar[rr]^(.7){f'} & & D' \ar[dd]_(.3){d}\\&&&&&A\ar[rr]|\hole^(.65){g} \ar[dl]^{m} && B \ar[dl]^{n} \\C\ar[rr]_{f} &&D&&C \ar[rr]_{f} & & D}$}

\noindent 
\parbox{11cm}{\begin{remark}
	Recall that, given two monos $m:M\to X$ and $n:N\to X$ with the same codomain, $m\leq n$ means that there exists a, necessarily unique and necessarily mono, $k:M\to N$ fitting in the triangle aside.	
	
	\hspace{15pt}Notice, moreover, that  if $m\leq n$ and $n\leq m$, then the arrow $k:M\to N$ is an isomorphism.
\end{remark}}
\parbox{4cm}{$\xymatrix@C=15pt{M\ar@{.>}[rr]^{k}  \ar[dr]_{m}&& N \ar[dl]^{n}\\ & X}$}\\

\full{ 
\begin{remark}
	Notice that, since $d$ is a mono and the vertical faces are pullbacks, then $a, b$ and $c$ are monomorphisms too. Moreover, $n$ is mono by \Cref{prop:pbpo}, so that even $m'$ and $n'$ are monos.
\end{remark}

\begin{proof}
	$(\Rightarrow)$ By hypothesis there exists $k:D'\to B$ such that $n\circ k = d$. By \Cref{prop:pbpo}, the bottom face of the cube is a pullback. Thus there exists a unique $h:C'\to A$ as in the diagram below, implying the thesis.
	\[\xymatrix@C=40pt{C'  \ar[d]^{h}\ar[r]^{f'} \ar@/_.5cm/[dd]_{c}& D' \ar@/^.5cm/[dd]^{d}\ar[d]_{k}\\ A \ar[d]^{m} \ar[r]^{g} & B \ar[d]_{n} \\  C \ar[r]_f & D}\]

	\smallskip \noindent
	$(\Leftarrow)$ Let $h:C\to A$ be such that $c=m\circ h$. By the $\mathcal{A}$-Van Kampen property the top face of the given cube is a pushout. Thus the dotted $k:D'\to B$ in the following diagram exists.
	\[\xymatrix@C=40pt{A' \ar@/_.5cm/[dd]_{a} \ar[d]^{m'} \ar[r]^{g'} & B' \ar[d]_{n'} \ar@/^.5cm/[dd]^{b} \\  C' \ar[d]^{h} \ar[r]_{f'} & D' \ar@{.>}[d]_{k}\\ A \ar[r]_g& B }\]
	Moreover, by construction we have
	\begin{align*}
		n\circ k \circ n' & = n\circ b=d\circ n'                                  \\
		n\circ k \circ f' & = n\circ g\circ h=f\circ m\circ h=f\circ c= d\circ f'
	\end{align*}
	We can therefore conclude that $n\circ k =d$.
\end{proof}}

Finally, we can show that $\mathcal{A}$-stable pushouts enjoy a kind of \emph{pullback-pushout decomposition} property.

\noindent 
\parbox{10cm}{
\begin{proposition}\label{prop:stab}Let $\X$ be a category and $\mathcal{A}$ a class of arrows stable under pullbacks. Suppose that, in the diagram below, the whole rectangle is an $\mathcal{A}$-stable pushout and the right square a pullback. If the arrow $k$ is in $\mathcal{A}$ and it is a monomorphism,  then both squares are pushouts.
\end{proposition}}
\parbox{4cm}{\vspace{-.3cm}
	$\xymatrix{X \ar[d]_{a} \ar[r]^{f}& \ar[r]^{g} Y \ar[d]^{b}& Z \ar[d]^{c}\\ A \ar[r]_{h}& B \ar[r]_{k}& C}$}

\full{ 
\begin{proof}
	We can begin noticing that $g$, being the pullback of $k$, is mono and in $\mathcal{A}$ too. Thus we can build the cube below, in which all the vertical faces are pullbacks, entailing that all the vertical arrows are in $\mathcal{A}$.
	\[\xymatrix@C=20pt@R=10pt{ & &X\ar[dl]_{f} \ar[ddd]^(.333333){\id{X}}|(.666666)\hole\ar[rrr]^{a} &&&A \ar[ddd]^{\id{A}} \ar[dl]^{h}\\& Y\ar[dl]_{\id{Y}} \ar[ddd]|(.333333)\hole_{\id{Y}} &&&B \ar[ddd]^{\id{B}} \ar[dl]_{\id{B}} \\Y \ar[ddd]_{g} \ar[rrr]^{b}&&& B\ar[ddd]^{k}\\&&X \ar[rrr]|(.34)\hole^{a}|(.67)\hole \ar[dl]_{f}&&& A \ar[dl]^{h}\\ & Y  \ar[dl]_{g}&&& B \ar[dl]^{k}\\ Z\ar[rrr]_{c} &&& C}\]
	By hypothesis the face is an $\mathcal{A}$-stable pushout and so its top one is a pushout. Using \Cref{lem:po1} we can conclude that the right half of the rectangle with which we have started is a pushout too.
\end{proof}}

\subsection{Useful properties of $\mathcal{M}$-adhesive categories}

\full{ 
We can begin with an observation about decomposition.

\begin{proposition}
  \label{prop:deco}Let $\mathcal{A}$ be a class of arrows stable under
  pullbacks. For every arrow $f\colon X\to Y$ and monomorphism
  $m\colon Y\to Z$, if $m\circ f \in\mathcal{A}$ then
  $f\in \mathcal{A}$.
\end{proposition}
\begin{proof}
  Take the diagram
  \[\xymatrix{X \ar[d]_{\id{X}}\ar[r]^{f}& Y \ar[r]^{\id{Y}}  \ar[d]_{\id{Y}}& Y \ar[d]^{m}\\
		X \ar[r]_{f}& Y \ar[r]_{m} & Z}\]
	Since $m$ is mono the right square is a pullback, while the left square is a pullback by construction. By \Cref{lem:pb1} the whole rectangle is a pullback and the thesis follows.
\end{proof}
\begin{corollary}
  \label{cor:deco}
	In every $\mathcal{M}$-adhesive category $\X$, the class $\mathcal{M}$ is closed under decomposition.
\end{corollary}}


We are now going to apply the results of the previous section to $\mathcal{M}$-adhesive categories in order to establish some \emph{high-level replacement properties} \cite{ehrig2004adhesive,ehrig2014adhesive,ehrig2006fundamentals}.  
A first important  result which can be immediately established, with the aid of \Cref{prop:pbpo}, is the following one.

\begin{proposition}
	\label{prop:pbpoad}
	Let $\X$ be an $\mathcal{M}$-adhesive category. Then
	$\mathcal{M}$-pushouts are pullbacks.
\end{proposition}

From \Cref{prop:pbpoad}, in turn, we can derive the following corollaries.
\begin{corollary}\label{cor:rego}
	In a $\mathcal{M}$-adhesive category $\X$, every $m\in\mathcal{M}$ is a regular mono.
\end{corollary}
\full{ 
\begin{proof}
	Let $m$ be an element of $\mathcal{M}$ and consider its pushout along itself.
	\[\xymatrix{X\ar@{>->}[r]^m \ar@{>->}[d]_m& Y\ar@{>->}[d]^{f}\\Y \ar@{>->}[r]_g & Z}\]
	By \Cref{prop:pbpoad} this square is a pullback, proving that $m$ is the equalizer of the arrows $f,g\colon Y\rightrightarrows Z$.
\end{proof}}

The following result now follows at once noticing that a regular monomorphism which is also epic is automatically an isomorphism.

\begin{corollary}\label{prop:bal}
	If $\X$ is an $\mathcal{M}$-adhesive categories, then every epimorphisms in $\mathcal{M}$ is an isomorphisms. In particular, every adhesive category $\X$ is \emph{balanced}: if a morphism is monic and epic, then it is an isomorphism.
\end{corollary}

\noindent 
\parbox{10cm}{\begin{lemma}[$\mathcal{M}$-pushout-pullback decomposition]\label{lem:popb} Let $\X$ be an $\mathcal{M}$-adhesive category  and suppose that, in the diagram on the right, the whole rectangle is a pushout and the right square a pullback.	Then the following statements hold true:
\parbox{13cm}	{\begin{enumerate}
		\item if $a$ belongs to $\mathcal{M}$ and $k$ is a mono,  then both squares are pushouts and pullbacks;
		\item if $f$ and $k $ are in  $\mathcal{M}$, then both squares are pushouts and pullbacks.
	\end{enumerate}}
\end{lemma}}
\parbox{4cm}{\vspace{-1cm}
	$\xymatrix{X \ar[d]_{a} \ar[r]^{f}& \ar[r]^{g} Y \ar[d]^{b}& Z \ar[d]^{c}\\ A \ar[r]_{h}& B \ar[r]_{k}& C}$}\\


\full{ 
\begin{proof}		\begin{enumerate}
		\item By \Cref{prop:stab}, it follows that both squares are pushouts, thus the thesis follows from \Cref{prop:pbpoad}.
		\item By hypothesis, $g$ is the pullback of an arrow in $\mathcal{M}$, thus it belongs to it. But then $g\circ f\in \mathcal{M}$ too  and the whole rectangle is a $\mathcal{M}$-pushout. Therefore, by \Cref{prop:pbpoad} a pullback, so that its left half is a pullback too, by \Cref{prop:pbpo}. Moreover $k\circ h$ is in $\mathcal{M}$ as the pushout of $g\circ f$ and, by \Cref{cor:deco}, we also know that $h\in \mathcal{M}$.

		      Using \Cref{lem:po1}, it is enough to show that the left half of the original rectangle is a pushout. We can build the following cube:
		      \[\xymatrix@C=20pt@R=10pt{ & &X\ar@{>->}[dl]_{f} \ar[ddd]^(.333333){\id{X}}|(.666666)\hole\ar[rrr]^{a} &&&A \ar[ddd]^{\id{A}} \ar@{>->}[dl]^{h}\\& Y\ar[dl]_{\id{Y}} \ar[ddd]|(.333333)\hole_{\id{Y}} &&&B \ar[ddd]^{\id{B}} \ar[dl]_{\id{B}} \\Y \ar@{>->}[ddd]_{g} \ar[rrr]^{b}&&& B\ar@{>->}[ddd]^{k}\\&&X \ar[rrr]|(.34)\hole^{a}|(.67)\hole \ar@{>->}[dl]_{f}&&& A \ar@{>->}[dl]^{h}\\ & Y \ar[rrr]|(.67)\hole^{b} \ar@{>->}[dl]_{g}&&& B \ar@{>->}[dl]^{k}\\ Z\ar[rrr]_{c} &&& C}\]
		      Its vertical faces are all pullbacks and all the vertical arrows are in $\mathcal{M}$, hence the top face is a pushout and we can conclude. \qedhere
	\end{enumerate}
\end{proof}}



Let us turn our attention to pushout complements.

\noindent
\parbox{11cm}{
	\begin{definition}[Pushout complement]
		Let $f\colon X\to Y$ and $g\colon Y\to Z$ be two composable arrows in a category $\X$. A \emph{pushout complement} for the pair $(f,g)$ is a pair $(h,k)$ with $h\colon X\to W$ and $k\colon W\to Z$ such that the square below commutes and it is a pushout.
	\end{definition}} \quad
\parbox{4cm}{\vspace{.1cm}
	$\xymatrix{X \ar[r]^{f} \ar[d]_{h}& Y \ar[d]^{g} \\ W \ar[r]_{k}& Z}$}\\

\iffalse
	\begin{example}
		In a generic category $\X$, pushout complements may not exist: in $\Set$ the arrows $?_{2}\colon \emptyset \to 2$ and $!_2\colon 2\to 1$ do not have a pushout complement.

		Moreover, composable arrows $f\colon X\to Y$ and $g\colon Y\to Z$ may have  pushout complements which are non-isomorphic: for instance, in $\Set$ the two squares below are both pushouts.

		\[\xymatrix{2 \ar[r]^{!_2} \ar[d]_{\id{2}}& 1 \ar[d]^{\id{1}} & 2 \ar[r]^{!_2} \ar[d]_{!_2}& 1 \ar[d]^{\id{1}}\\ 2 \ar[r]_{!_2}& 1 & 1 \ar[r]_{\id{1}}& 1}\]
	\end{example}
\fi

Working in an $\mathcal{M}$-adhesive category we can amend the second defect.

\noindent
\parbox{8.5cm}{
	\begin{lemma}\label{lem:radj}
		Let $f\colon X \to Y$ be an arrow in an $\mathcal{M}$-adhesive category $\X$ and suppose that the left square aside is a pushout while the  right one is a pullback, with $ m\colon M \rightarrowtail X$ and $n\colon N \rightarrowtail Y$ in $\mathcal{M}$.
		Then $n\leq k$ if and only if $p_2\leq m$.
	\end{lemma}}
\parbox{3cm}{\vspace{-2ex}
	$\xymatrix{M \ar@{>->}[d]_{m}\ar[r]^{h}& Q \ar@{>->}[d]^{k} & P \ar[r]^{p_1} \ar@{>->}[d]_{p_2}& N \ar@{>->}[d]^{n}\\X\ar[r]_{f}&Y &X \ar[r]_f&Y}$}

\full{ 
\begin{proof}
	We start pulling back $n$ along $k$ and then pulling back the resulting arrow along $h$, getting the following two pullbacks square:
	\[\xymatrix{B \ar@{>->}[d]_{b}\ar@{>->}[r]^{s}& N \ar@{>->}[d]^{n} & A \ar[r]^{r} \ar@{>->}[d]_{a}& B \ar@{>->}[d]^{b}\\Q\ar@{>->}[r]_{k}&Y &M \ar[r]_h&Q\\}\]
	Notice that
	\[
		f\circ m\circ a=k\circ h\circ a=k\circ b\circ r=n\circ s\circ r\]

	Thus there exists a unique $t\colon A\to P$ as in the diagram
	\[\xymatrix{A \ar@{>->}[d]_{a} \ar@{.>}[dr]^{t}\ar[r]^{r} &B \ar@{>->}@/^.2cm/[dr]^{s} \\ M \ar@{>->}@/_.2cm/[dr]_{m}&P\ar[r]^{p_1}  \ar@{>->}[d]_{p_2}& N \ar@{>->}[d]^{n}\\ &X \ar[r]_{f} & Y}\]
	We can then consider the cube below, in which the front, right and back faces are pullbacks.
	\[\xymatrix@C=15pt@R=15pt{&A\ar@{>->}[dd]|\hole_(.65){a}\ar[rr]^{r} \ar[dl]_{t} && B \ar@{>->}[dd]^{b} \ar[dl]_{s} \\ P  \ar@{>->}[dd]_{p_2}\ar[rr]^(.7){p_1} & & N \ar@{>->}[dd]_(.3){n}\\&M\ar[rr]|\hole^(.65){h} \ar@{>->}[dl]^{m} && Q \ar@{>->}[dl]^{k} \\X \ar[rr]_{f} & & Y}\]
	We can notice that the left square is a pullback too. To see this it is enough to apply \Cref{lem:pb1} to the diagram
	\[\xymatrix{A  \ar@/^.4cm/[rr]^{s\circ r}\ar@{>->}[d]_{a} \ar[r]_{t}& \ar[r]_{p_1} P \ar@{>->}[d]^{p_2}& N \ar[d]^{c}\\ M \ar@/_.4cm/[rr]_{k\circ h}\ar@{>->}[r]^{m}& X \ar[r]^{f}& Y}\]

	The thesis now follows immediately from \Cref{lem:varie}. \qedhere
\end{proof}
}
\noindent
\parbox{10cm}{
	\begin{corollary}[Uniqueness of pushouts complements]\label{lem:pocomp}
		Let $\X$ be a $\mathcal{M}$-adhesive category. Given $m\colon X\mto Y$ in $\mathcal{M}$ and $f\colon Y\to Z$, let $(h_1, k_1)$ and $(h_2, k_2)$ be the pushout complements of $m$  and $f$ depicted aside. Then there exists a unique isomorphism $\phi\colon W_1\to W_2$ making the diagram on the right commutative.
	\end{corollary}}
\parbox{3cm}{\vspace{1em}$\xymatrix{&X \ar@{>->}[r]^{m} \ar[d]_{h_1} \ar@/_.3cm/[dl]_{h_2}& Y \ar[d]^{f} \\ W_2 \ar@{>->}@/_.4cm/[rr]_{k_2} &W_1 \ar@{.>}[l]_{\phi} \ar@{>->}[r]^{k_1} & Z }$}

\full{ 
\begin{proof}
	Consider the two pushout squares
	\[\xymatrix{M \ar[r]^{h_1}\ar@{>->}[d]_{m}& W_1 \ar@{>->}[d]^{k_1} & M \ar@{>->}[d]_{m} \ar[r]^{h_1}& W_2 \ar@{>->}[d]^{k_2}\\Y\ar[r]_{f}&Z &Y \ar[r]_{f}&Z}\]
	Since $\mathcal{M}$ is in $\mathcal{M}$, \cref{prop:pbpoad} guarantees that they are both pullbacks.
	Since $m\leq m$, by \Cref{lem:radj} we get that now entails that $k_1\leq k_2$ and $k_2\leq k_1$. Thus there exists an isomorphism $\phi\colon W_1\to W_2$ such that $k_1=k_2\circ \phi$. To see that $h_2=\phi\circ h_1$, we can compute:
	\[
		k_2\circ \phi \circ h_1  = k_1\circ h_1= n\circ m= k_2\circ h_2\]

	The claim now follows since $k_2$ is a monomorphism.
\end{proof}}



\section{$\mathcal{M}$-adhesivity is not enough}\label{app:fill}
In \Cref{sec:ade} we introduced the notion of strong enforcing left-linear DPO rewriting system, a class that contains, for instance, all the linear rewriting systems. This result can be further refined: in a\cite{baldan2011adhesivity} a class  $\mathbb{B}$ of (quasi)adhesive category is defined for which the local Church-Rosser Theorem holds for left-linear DPO rewriting system. In our language, this means that every left-linear DPO rewriting system based on a category in $\mathbb{B}$ is strong enforcing. This section is devoted to repropose, and slightly generalize, the results of \cite{baldan2011adhesivity} to our context.

\noindent
\parbox{10.4cm}{
	\begin{definition}Let $\mathcal{M}$ be a class of monos in a category $\X$, closed under composition, containing all isomorphisms and stable under pullbacks and pushouts. Suppose that the  diagram on the right 	is given and the whole rectangle is a pushout. We say that $\X$ satisfies:
		\parbox{14cm}{\begin{itemize}
				\item the \emph{$\mathcal{M}$-mixed decomposition} property if, whenever $k$ belongs to $\mathcal{M}$ and the right half of the previous diagram is a pullback, then the left one is a pushout.
				\item the \emph{$\mathcal{M}$-pushout decomposition} property if whenever $a, b$ and $c$ belongs to $\mathcal{M}$ and the right half of the diagram above is a pushout, then its left half is a pushout too.
			\end{itemize}}
	\end{definition}} \parbox{3cm}{\vspace{-2cm}$\xymatrix{X \ar[d]_{a} \ar[r]^{f}& \ar[r]^{g} Y \ar[d]^{b}& Z \ar[d]^{c}\\ A \ar[r]_{h}& B \ar[r]_{k}& C}$}\\

The class of categories of type $\mathbb{B}$ is closed under the same constructions of \Cref{cor:slice,thm:functors}. This can be deduced at once from the fact that in such categories pullbacks and pushouts are computed componentwise.

\begin{lemma}\label{lem:closed} Let $\X$ be a category satisfying the $\mathcal{M}$-mixed and $\mathcal{M}$-pushout decomposition properties, then the following hold true:
	\begin{enumerate}
		\item  for every object $X$, $\X/X$ satisfies  the $\mathcal{M}/X$-mixed and the $\mathcal{M}/X$-pushout decomposition properties, while $X/\mathcal{M}$-adhesive satisfies their $X/\mathcal{M}$ variants, where
		\[\mathcal{M}/X:=\{m\in \mathcal{A}(\X/X) \mid m\in \mathcal{M} \}
		\qquad X/\mathcal{M}:=\{m\in \mathcal{A}(X/\X) \mid m\in
		\mathcal{M} \}
		\]
		\item  for every small
		category $\Y$, the category $\X^\Y$ satisfies the 
		$\mathcal{M}^{\Y}$-mixed and the $\mathcal{M}^{\Y}$-pushout decomposition properties , where
		\[\mathcal{M}^{\Y}:=\{\eta \in \mathcal{A}(\X^\Y) \mid \eta_Y \in
		\mathcal{M} \text{ for every } Y\in \Y\}\]
	\end{enumerate}
\end{lemma}

The following result shows that the mixed and pushout decomposition properties guarantee that every independence pair is strong.

\begin{theorem}\label{thm:good1}Let $\X$ be an $\mathcal{M}$-adhesive category with all pushouts and satisfying the $\mathcal{M}$-mixed and the $\mathcal{M}$-pushout decomposition properties. Then every left-linear DPO rewriting system on $\X$ is strong enforcing.
\end{theorem}
\begin{proof}
	Consider the derivation $\der{D}=\{\dder{D}_i\}_{i=0}^1$, made by two weakly sequentially independent derivations, depicted below.
	\[\xymatrix@C=15pt{L_0 \ar[d]_{m_0}&& K_0 \ar[d]_{k_0}\ar@{>->}[ll]_{l_0} \ar[r]^{r_0} & R_0 \ar@/^.35cm/[drrr]|(.3)\hole_(.4){i_0} \ar[dr]|(.3)\hole_{h_0} && L_1 \ar@/_.35cm/[dlll]^(.4){i_1} \ar[dl]|(.3)\hole^{m_1}& K_1 \ar[d]^{k_1}\ar@{>->}[l]_{l_1} \ar[rr]^{r_1} && R_1 \ar[d]^{h_1} \\G_0 && \ar@{>->}[ll]^{f_0} D_0 \ar[rr]_{g_0}&& G_1  && \ar@{>->}[ll]^{f_1} D_1 \ar[rr]_{g_1}&& G_2 }\]

	We have to show that $(i_0, i_1)$ is a strong independence pair. Now, by hypothesis $\X$ has all pushouts, thus the only thing to show is that the squares below are pushouts (the third one is the usual pullback of $f_1\colon D_1\mto G_0$ along $g_0\colon D_0\to G_1$).
	\[\xymatrix{K_0 \ar[r]^{r_0}  \ar[d]_{u_0}& R_0 \ar[d]^{i_0} & K_1 \ar@{>->}[r]^{l_1}  \ar[d]_{u_1}& L_1 \ar[d]^{i_1}&P \ar@{>->}[r]^{p_0} \ar[d]_{p_1}& D_0\ar[d]^{g_0} \\ P \ar[r]_{p_1} & D_1 &P \ar[r]_{p_0}  & D_0&D_1 \ar@{>->}[r]_{f_1} & G_1}\]

	To see this, consider the following two diagrams.
	\[\xymatrix{K_0 \ar@/^.4cm/[rr]^{k_0} \ar[d]_{r_0} \ar[r]_{u_0}& \ar@{>->}[r]_{p_0} P \ar[d]_{p_1}& D_0 \ar[d]^{g_0}&K_1 \ar@/^.4cm/[rr]^{k_1} \ar@{>->}[d]_{l_1} \ar[r]_{u_1}& \ar[r]_{p_1} P \ar@{>->}[d]_{p_0}& D_1 \ar@{>->}[d]^{f_1}\\ R_0 \ar@/_.4cm/[rr]_{h_0}  \ar[r]^{i_0}& D_1 \ar@{>->}[r]^{f_1}& G_1 &L_1 \ar@/_.4cm/[rr]_{m_1}  \ar[r]^{i_1}& D_0 \ar[r]^{g_0}& G_1}\]

	The thesis now follows from the $\mathcal{M}$-mixed and the $\mathcal{M}$-pushout decomposition property.
\end{proof}

Our next step is to identify sufficient conditions for a category $\X$ to satisfy the mixed and $\mathcal{M}$-pushout decomposition properties.

\begin{definition} 
	Let $\X$ be an  $\mathcal{M}$-adhesive category, the pair $(\X, \mathcal{M})$ is of \emph{type $\mathbb{B}$} if:
	\begin{enumerate}
		\item every arrow in $\mathcal{M}$ is a coproduct coprojection;
		\item $\X$ has all pushouts;
		\item $\X$ has strict initial objects and, for every object $X$, the arrow $?_X\colon 0\to X $ belongs to $\mathcal{M}$;
		\item all pushouts are $\mathcal{M}$-stable.
	\end{enumerate}
\end{definition}

\begin{remark}
	It is worth to examine more closely conditions $1$ and $3$ of the above definition.
	\smallskip 
	\begin{itemize}
	\parbox{10.3cm}{\item Let $m_0\colon X_0 \rightarrowtail Y$ be an arrow in $\mathcal{M}$, the first condition means that there exists $m_1\colon X_1\to Y$ such that $(Y, \{m_i\}_{i=0}^1)$ is a coproduct. This, together with property $3$, entails that every coprojection in a coproduct is in $\mathcal{M}$. This follows since, any coproduct $(X_1+X_2, \{\iota_{X_i}\}_{i=0}^1)$ fits in a pushout diagram as the one aside.}
	  \parbox{3cm}{\vspace{-0em}$\xymatrix@C=25pt{0  \ar@{>->}[r]^-{?_{X_1}} \ar@{>->}[d]^{?_{X_2}}& X_1 \ar@{>->}[d]^{\iota_{X_1}}\\ X_2 \ar@{>->}[r]_-{\iota_{X_2}} & X_1+X_2}$}
		
	\smallskip 	\noindent 
	\parbox{13.5cm}{\item $\X$ has strict initial objects if it has initial objects and every arrow $f:X\to 0$ is an isomorphism. Notice that if initial objects are strict, then $?_X\colon 0\to X$ is mono for every $X$: indeed for every pair $f,g\colon Y\rightrightarrows 0$ then, by strictness, $Y$ is initial and so $f=g$.}
	\end{itemize} 
\end{remark}

\begin{example}
The category $\Set$ of sets and functions, with its class of monos, is of type $\mathbb{B}$. Similarly, the category $\textbf{Inj}$ of sets and injective functions is quasiadhesive and, with its class of regular monos, of type $\mathbb{B}$. 
\end{example}

Categories of type $\mathbb{B}$ satisfy a property resembling \emph{extensivity} \cite{carboni1993introduction}.

\noindent
\parbox{10cm}{\begin{proposition}\label{prop:ext}
Let $(\X, \mathcal{M})$ be a pair of type $\mathbb{B}$. Then for every diagram as the one aside, in which the bottom row is a coproduct cocone and the vertical arrows are in $\mathcal{M}$, the top row is a coproduct if and only if the two squares are pullbacks.
\end{proposition}}
\parbox{2cm}{\vspace{-.4em}$\xymatrix{A\ar[r]^-{f} \ar@{>->}[d]_{r}& C  \ar@{>->}[d]_{s}& B \ar@{>->}[d]^{t}\ar[l]_-{g}\\X  \ar[r]_-{\iota_X}& X+Y & Y \ar[l]^-{\iota_Y}}$}

\noindent 
\parbox{4cm}{$\xymatrix@C=10pt@R=10pt{&I\ar@{>->}[dd]|\hole_(.65){a}\ar[rr]^{k} \ar[dl]_{h} && B \ar@{>->}[dd]^{t} \ar[dl]_{g} \\ A  \ar@{>->}[dd]_{r}\ar[rr]^(.7){f} & & C \ar@{>->}[dd]_(.3){s}\\&0\ar@{>->}[rr]|\hole^(.65){?_Y} \ar@{>->}[dl]^{?_X} && Y \ar@{>->}[dl]^{\iota_Y} \\X \ar@{>->}[rr]_{\iota_X} & & X+Y}$}
 \parbox{10cm}{\begin{proof}
Consider the cube aside, in which the back faces are pullbacks. The bottom faces is an $\mathcal{M}$-Van Kampen pushout, thus the top face is a pushout if and only if the front faces are pullbacks. By strictness of $0$, $a\colon I\to 0$ is an isomorphism, so that $I$ is initial, therefore the $\mathcal{M}$-Van Kampen condition reduces to the request that $(C, \{f,g\})$ is a coproduct cocone if and only if the front faces are pullbacks, as claimed.
\end{proof}}

The previous result entails the following one, needed to show that  in any pair $(\X, \mathcal{M})$ of type $\mathbb{B}$, the category $\X$ satisfies the $\mathcal{M}$-mixed and $\mathcal{M}$-pushout decomposition properties.

\noindent
\parbox{10.7cm}{\begin{proposition}\label{prop:po2}
		Let $(\X, \mathcal{M})$ be a pair of type $\mathbb{B}$, and suppose that the square on the right is an $\mathcal{M}$ pullback. Then there exists $E\in \X$, $e\colon E\mto C$ in $\mathcal{M}$, $\phi:E\to B_1$ such that $(C, \{m, e\})$ is a coproduct and $g=f+\phi$. Moreover, such a square is a pushout if and only if $\phi$ is an isomorphism.
\end{proposition}} \parbox{3cm}{\vspace{-.2cm}$\xymatrix{A  \ar[r]^{f} \ar@{>->}[d]_{m}& B_0 \ar@{>->}[d]^{\iota_{B_{0}}}\\ C\ar[r]_-{g} & B_0+B_1}$}
\iffalse 
\begin{proof}
		Pulling back $\iota_{B_0}\colon B_0\to B_0\to B_1$ and $\iota_{B_1}\colon B_1\to B_0 + B_1$ we get the diagram below and the thesis follows from \Cref{prop:ext}. The same diagram allows us to deduce $g=f+\phi$.	
	\parbox{5.2cm}{$\xymatrix{A\ar[r]^-{m} \ar@{>->}[d]_{r}& C  \ar@{>->}[d]_{g}& E \ar@{>->}[d]^{\phi}\ar[l]_-{e}\\B_0  \ar[r]_-{\iota_{B_0}}& B_0+B_1 & B_1 \ar[l]^-{\iota_{B_1}} \\ A & B_0 \\C & B_0+E\\ &&B_0+B_1}$}\parbox{8.8cm}{\vspace{-4.1cm}Let us show the second half of the thesis.
	
	$(\Rightarrow)$ It is immediate to show that the inner square in the second diagram on the left is a pushout. Thus we get the existence of the dotted isomorphism $\varphi\colon B_0+E\to B_0+B_1$.}
		
		\parbox{5cm}{aaaaaaaaaaaaaaaaaaa}
\end{proof}	



\noindent
\parbox{10.7cm}{\begin{corollary}\label{cor:po2}
Let $\X$ be an $\mathcal{M}$-adhesive category of type $\mathbb{B}$, and suppose that the square on the right is an $\mathcal{M}$ pullback. Then there exists $E\in \X$, $e\colon E\mto C$ in $\mathcal{M}$, $\phi:E\to B_1$ such that $(C, \{m, e\})$ is a coproduct and $g=f+\phi$. 
\end{corollary}} \parbox{3cm}{\vspace{-.5cm}$\xymatrix{A  \ar[r]^{f} \ar@{>->}[d]_{m}& B \ar@{>->}[d]^{\iota_{B_{0}}}\\ C\ar[r]_-{g} & B_0+B_1}$}

\noindent 
\parbox{9.5cm}{\begin{proof}	$(1\Rightarrow 2)$ 
	
	\smallskip \noindent $(2\Rightarrow 1)$
\end{proof}}

\fi 

\begin{lemma}\label{lem:prop} Let $(\X, \mathcal{M})$ be a pair of type $\mathbb{B}$, then $\X$ satisfies the $\mathcal{M}$-mixed and $\mathcal{M}$-pushout decomposition properties.
\end{lemma}
\begin{proof}$\mathcal{M}$-mixed decomposition property. This follows at once from \Cref{prop:stab}.
	
	\smallskip \noindent
	\parbox{3cm}{$\xymatrix{X \ar[r]^f \ar@{>->}[d]_{\iota_X}& Y\ar[r]^g \ar@{>->}[d]^{\iota_Y} & Z\ar@{>->}[d]^{\iota_Z}\\X+A  \ar@/_.4cm/[rr]_{(g\circ f) + (\varphi \circ \phi)}\ar[r]^{f+\phi}& Y+B \ar[r]^{g+\varphi}& Z+C}$} \qquad \qquad  \qquad   \qquad \parbox{8cm}{ $\mathcal{M}$-pushout-decomposition property. Using \Cref{prop:ext,prop:po2} and the fact that arrows in $\mathcal{M}$ are coproduct coprojections, we can reduce to prove our for diagrams as the one on the left. By hypothesis and \Cref{prop:po2} $\varphi$ and $\varphi\circ \phi$ are both isomorphisms. therefore $\phi$ is an isomorphism too and we can conclude again using \Cref{prop:po2}.\qedhere 
}
	
		
\end{proof}


\begin{definition} Let $\X$ be an $\mathcal{M}$-adhesive category, we say that the pair $(\X, \mathcal{M})$ is of \emph{type $\mathbb{B}^+$} if (at least) one of the following holds true:
	\begin{enumerate}
		\item $(\X, \mathcal{M})$ is of type $\mathbb{B}$;
	\item $\X$ is $\Y/Y$ and $\mathcal{M}=\mathcal{N}/Y$for some $(\Y, \mathcal{N})$ of type $\mathbb{B}^+$ and $Y\in \Y$;
 	\item $\X$ is $Y/\Y$ and $\mathcal{M}=Y/\mathcal{N}$for some $(\Y, \mathcal{N})$ of type $\mathbb{B}^+$ and $Y\in \Y$:
 	\item $\X$ is $\Y^{\A}$ and $\mathcal{M}=\mathcal{N}^{\mathcal{A}}$ for some category category $\A$ and $(\Y, \mathcal{N})$ of type $\mathbb{B}^+$.
	\end{enumerate}
\end{definition}
\begin{example}
	The pair $(\mathbf{Graph}, \mon(\mathbf{Graph}))$ made by the topos of graphs and its class of mons is of type $\mathbb{B}^+$  but not of type $\mathbb{B}$. Indeed not every monomorphism of graphs is a coproduct coprojection.
\end{example}

From \Cref{lem:closed,lem:prop} we can now deduce at once the following.
\begin{corollary}
	For every $(\X, \mathcal{M})$ of type $\mathbb{B}^+$, the category $\X$ has the $\mathcal{M}$-mixed and $\mathcal{M}$-pushout decomposition properties.
\end{corollary}

Using \Cref{thm:good1} we finally get the main result of our appendix.
\begin{corollary}
Let $(\X, \mathcal{M})$ be a pair of type $\mathbb{B}^+$, then every left-linear DPO-rewriting system is strong enforcing.
\end{corollary}



\section{Omitted proofs}

In this appendix we will provide the proofs of the main results of this paper. 



\subsection{Proofs for \Cref{sec:ade}}


\propUnique*

\label{propUnique-proof}
\begin{proof}
  Both pairs $(k, f)$ and $(k', f')$ are pushout complements of $l$
  and $n$, thus, \Cref{lem:pocomp} yields an isomorphism
  $\phi_D\colon D\to D'$. Computing we have
  \[
    g'\circ \phi_D \circ k= g' \circ k'=h'\circ r
  \]

  \noindent
  \parbox{3cm}{
    $\xymatrix{K \ar@/^.4cm/[rr]^{k'}\ar[d]_{r} \ar[r]_{k}&
      \ar[r]_{\phi_D} D \ar[d]^{g}& D' \ar[d]^{g'}\\ R
      \ar@/_.4cm/[rr]_{h'} \ar[r]^{h}& H \ar[r]^{\phi_H}& H'}$}
  \hfill
  \parbox{10cm}{ \hspace{15pt}Hence, we have another
    $\phi_H\colon H\to H'$. To see that $\phi_H$ is an isomorphism,
    consider the diagram aside. By hypothesis the whole rectangle and
    its left half are pushouts, therefore, by \Cref{lem:po1} its right
    square is a pushout too. The claim now follows from the fact that
    the pushout of an isomorphism is an isomorphism. \qedhere }
\end{proof}


\subsection{Proofs for \Cref{sec:equi}}

This section is devoted to provide further details and proof for the concepts introduced in \Cref{sec:equi}.

\subsubsection{Proofs for \Cref{subsec:switch}}


Consider a switch $\der{E}=\{\dder{E}_i\}_{i=0}^1$ for $\dder{D}_0$
and $\dder{D}_1$, then by definition $\dder{E}_0$ and $\dder{E}_1$ are
sequentially independent. We can then wonder if they are switchable.

\begin{proposition}
  \label{prop:switch}
  Let $\der{D}=\{\dder{D}_i\}_{i=0}^1$ be a derivation and suppose
  that $\der{E}=\{\dder{E}_i\}_{i=0}^1$ is a switch for it. Then
  $\der{D}$ is a switch for $\dder{E}_0$ and $\dder{E}_1$ along
  $(j_0, j_1)$.
\end{proposition}

\begin{proof}
    The first point of \Cref{def:switch} is obviously satisfied. The
    second one follows at once since $m_{\der{E},0}= f_0\circ i_1$ and $h_{\der{E},1}= g_{1}\circ i_0$.    Finally, the third point holds because we already know that $m_{\der{E},0}= f_0\circ i_1$ and $h_{\der{E},1}= g_{1}\circ i_0$.
\end{proof}

\begin{lemma}[Uniqueness of switches]
  \label{thm:switch_uni}
  Let $\der{D}=\{\dder{D}_{i}\}_{i=0}^1$ be a derivation and suppose
  that both $\der{E}=\{\dder{E}_i\}_{i=0}^1$ and
  $\der{F}=\{\dder{F}_i\}_{i=0}^1$ are switches of $\dder{D}_0$ and
  $\dder{D}_1$. Then $\der{E}$ and $\der{F}$ are abstraction
  equivalent.
\end{lemma}

\begin{proof}
    By definition of switch we know that $\der{E}_0$ and $\der{F}_0$ have the same match $f_0\circ i_1$ and that $\der{E}_1$ and $\der{F}_1$ have the same comatch $g_1\circ i_0$. Thus we can build the solid part of the diagram below.
    \[\xymatrix@C=22pt{G_{0} && \ar@{>->}[ll]_{f_{\der{F},0}} D_{\der{F},0} \ar[rr]^{g_{\der{F},0}}&& G_{\der{F},1} && \ar@{>->}[ll]_{f_{\der{F},1}} D_{\der{F},1} \ar[rr]^{g_{\der{F},1}}&& G_{2}\\L_1 \ar[d]^{f_0\circ i_1} \ar[u]_{f_0\circ i_1}&& K_{1} \ar[d]^{k_{\der{E},0}} \ar[u]_{k_{\der{F},0}}\ar@{>->}[ll]_{l_1} \ar[r]^{r_1} & R_{1} \ar@/^.35cm/[drrr]|(.3)\hole_(.4){j_0} \ar[dr]|(.3)\hole_{h_{\der{E},0}} \ar@/_.35cm/[urrr]|(.3)\hole^(.4){a_0} \ar[ur]|(.3)\hole^{h_{\der{F},0}}& &L_{0} \ar@/_.35cm/[dlll]^(.4){j_1} \ar[dl]|(.3)\hole^{m_{\der{E},1}} \ar@/^.35cm/[ulll]_(.4){a_1} \ar[ul]|(.3)\hole_{m_{\der{F},1}}& K_{0} \ar[d]_{k_{\der{E},1}} \ar[u]^{k_{\der{F},1}}\ar@{>->}[l]_{l_{0}} \ar[rr]^{r_0} && R_{0} \ar[d]_{g_1\circ i_0} \ar[u]^{g_1\circ i_0}\\ \ar@/^.5cm/[uu]^{\id{G_0}} G_{0} && \ar[ll]^{f_{\der{E},0}} D_{\der{E},0} \ar@{.>}@/^.5cm/[uu]^(.33){\phi_{0}}|\hole \ar[rr]_{g_{\der{E},0}}&& G_{\der{E},1} \ar@{.>}[uu]^(.76){\psi_1}|(.45)\hole |(.55)\hole&& \ar@{>->}[ll]^{f_{\der{E},1}} D_{\der{E},1} \ar@{.>}@/_.5cm/[uu]_(.33){\phi_{1}}|\hole\ar[rr]_{g_{\der{E},1}}&& G_{2}\ar@{.>}@/_.5cm/[uu]_{\psi_2}}\]
    Now, by \Cref{prop:unique} we get $\phi_0\colon D_{\der{E},0}\to D_{\der{F},0}$ and $\psi_1 \colon G_{\der{E},1}\to G_{\der{F},1}$ such that
    \[\xymatrix{G_{0} & \ar@{>->}[l]_{f_{\der{F},0}} D_{\der{F},0} \ar[r]^{g_{\der{F},0}}& G_{\der{F},1} \\L_1 \ar[d]^{f_0\circ i_1} \ar[u]_{f_0\circ i_1}& K_{1} \ar[d]^{k_{\der{E},0}} \ar[u]_{k_{\der{F},0}}\ar[l]_{l_1} \ar[r]^{r_1} & R_{1}  \ar[d]_{h_{\der{E},0}}  \ar[u]^{h_{\der{F},0}}\\ \ar@/^.5cm/[uu]^{\id{G_0}} G_{0} & \ar@{>->}[l]^{f_{\der{E},0}} D_{\der{E},0} \ar@/^.5cm/[uu]^(.33){\phi_{0}}|\hole \ar[r]_{g_{\der{E},0}}& G_{\der{E},1} \ar@/_.5cm/[uu]_{\psi_1}}\]
    commutes. But then we have
    \[
      f_{\der{F},0}\circ \phi_0\circ j_1=f_{\der{E},0} \circ j_1=m_0=f_{\der{F},0}\circ a_1\]
    which entails $a_1= \phi_0\circ j_1$. This, in turn, gives us that
    \[\psi\circ m_{\der{E},1}=\psi \circ g_{\der{E},0}\circ j_1=g_{\der{F},0}\circ \phi_0\circ j_1=g_{\der{F},0}\circ a_1=m_{\der{F},1}\]
    
    Now, the square
    \[\xymatrix@C=30pt{K_0 \ar[d]_{k_{\der{E,1}}} \ar@{>->}[r]^{l_0}& L_0 \ar[d]^{\psi_1\circ m_{\der{E},1}} \\D_{\der{E},1} \ar@{>->}[r]_{\psi_1\circ f_{\der{E},1}}& G_{\der{F}, 1}} \]
    is a pushout and $\psi_1\circ m_{\der{E},1}=m_{\der{F},1}$, thus, by \Cref{prop:unique} there are $\phi_1\colon D_{\der{E},1}\to D_{\der{F},1}$ and $\psi_2\colon G_2\to G_2$ fitting in the diagram below
    \[\xymatrix{G_{\der{F},1} & \ar@{>->}[l]_{f_{\der{F},1}} D_{\der{F},1} \ar[r]^{g_{\der{F},1}}& G_2 \\L_0 \ar[d]^{m_{\der{E},1}} \ar[u]_{m_{\der{F},1}}& K_{1} \ar[d]^{m_{\der{E},1}} \ar[u]_{m_{\der{F},1}}\ar[l]_{l_1} \ar[r]^{r_1} & R_{1}  \ar[d]_{g_1\circ i_0}  \ar[u]^{g_1\circ i_0}\\ \ar@/^.5cm/[uu]^{\psi_1} G_{\der{E},1} & \ar@{>->}[l]^{f_{\der{E},1}} D_{\der{E},1} \ar@/^.5cm/[uu]^(.33){\phi_{1}}|\hole \ar[r]_{g_{\der{E},1}}& G_2 \ar@/_.5cm/[uu]_{\psi_2}}\]
    To conclude, it is now enough to notice that
    \[f_{\der{F},1} \circ \phi_1\circ j_0=\psi_1\circ f_{\der{E},1}\circ j_0=\psi_1\circ h_{\der{E,0}}=h_{\der{F},0}=f_{\der{F},1}\circ a_0\]
    allowing us to deduce $ \phi_1\circ j_0=a_0$.
    \qedhere
\end{proof}


\begin{proposition}
	\label{prop:tec}
	Let $(i_0, i_1)$ be an independence pair between two direct
	derivations $\dder{D}_0$ and $\dder{D}_1$ in a left-linear
	DPO rewriting system $(\X,\R)$. Consider the pullback of
	$f_1\colon D_1\mto G_1$ along $g_0\colon D_0\to G_1$ (first
	square below), then there exist the arrows
	$u_1\colon K_1\to P$ and $u_0\colon K_0\to P$ fitting in the
	central and right square. Moreover, the right one is always
	a pullback.
	\[\xymatrix{P \ar@{>->}[r]^{p_0} \ar[d]_{p_1} & D_0
		\ar[d]^{g_0}& K_0 \ar[r]^{r_0} \ar@{.>}[d]_{u_0}& R_0
		\ar[d]^{i_0} & K_1 \ar@{>->}[r]^{l_1} \ar@{.>}[d]_{u_1}&
		L_1 \ar[d]^{i_1}\\ D_1 \ar@{>->}[r]_{f_1} &G_1 &P
		\ar[r]_{p_1} & D_1 &P \ar[r]_{p_0} & D_0}
	\]
\end{proposition}

\begin{proof}
	We start noticing that
	\[
	f_1\circ i_0\circ r_0=h_0\circ r_0=g_0\circ k_0 \qquad
	g_0\circ i_1\circ l_1=m_1\circ l_1= f_1 \circ k_1
	\]
	Thus there exists the dotted $u_0\colon K_0\to P$,
	$u_1\colon K_1\to P$ in the diagram
	\[\xymatrix{K_0 \ar[d]_{r_0}
		\ar@{.>}[r]_{u_0}\ar@/^.4cm/[rr]^{k_0} &P
		\ar@{>->}[r]_{p_0} \ar[d]_{p_1}& D_0 \ar[d]^{g_0}&K_1
		\ar@{>->}[d]_{l_1}
		\ar@{.>}[r]_{u_1}\ar@/^.4cm/[rr]^{k_1} &P \ar[r]_{p_1}
		\ar@{>->}[d]_{p_0}& D_1 \ar@{>->}[d]^{f_1}\\R_0
		\ar@/_.4cm/[rr]_{h_0}\ar[r]^{i_0}& D_1
		\ar@{>->}[r]^{f_1}& G_1&L_1
		\ar@/_.4cm/[rr]_{m_1}\ar[r]^{i_1}& D_0 \ar[r]^{g_0}&
		G_1}\]
	By \Cref{prop:pbpoad,lem:pb1} we get that the left half of
	the second rectangle is a pullback.
	\qedhere
\end{proof}

There is another
useful properties of weakly sequentially independent direct
derivations which is worth mentioning.

\noindent
\parbox{9.5cm}
{\begin{proposition}\label{lem:cose}Let
    $\der{D}=\{\dder{D}_i\}_{i=0}^1$ be a derivation, and suppose
    that $(i_0, i_1)$ is an independence pair between $\dder{D}_0$
    and $\der{D}_1$.  If $\der{E}=\{\dder{E}_i\}_{i=0}^1$ is a
    switch of $\der{D}$ along $(i_0, i_1)$, then there exists
    $q_0\colon P\to D_{\der{E},0}$ in the diagram
    below \end{proposition}}
\parbox{4cm}{$\xymatrix{D_{\der{E},0} \ar@{>->}[d]_{f_{\der{E},0}}&P
    \ar@{.>}[l]_{q_0} \ar[r]^{p_1} \ar@{>->}[d]_{p_0}& D_1
    \ar@{>->}[d]^{f_1}\\ G_{0}&D_0 \ar@{>->}[l]^{f_0}\ar[r]_{g_0}&
    G_1}$}

\begin{proof}
  Consider the arrow $u_1\colon K_1\to P$ obtained using
  \Cref{prop:tec}. It fits in the diagram:
  \[\xymatrix{K_1 \ar[r]^{u_1} \ar@{>->}[d]_{l_1}&P
      \ar[r]^{\id{P}}\ar@{>->}[d]_{p_0}& P\ar@{>->}[d]^{p_0}\\L_1
      \ar[d]_{\id{L_1}}\ar[r]^{i_1}&D_0 \ar[r]^{\id{D_0}}
      \ar[d]_{\id{D_0}}& D_{0} \ar@{>->}[d]^{f_0}\\
      L_1\ar[r]^{i_1} \ar@/_.4cm/[rr]_{m_{\der{E},0}}&D_0
      \ar@{>->}[r]^{f_0}&G_0}\]

  Since $f_0$ is a monomorphism, every square in the above diagram
  is a pullback. Thus the whole right square is a pullback too.
  Applying \Cref{lem:radj} to the pair of squares below now gives
  us the wanted $q_0\colon P\to D_{\der{E},0}$.
  \[\xymatrix{K_1 \ar@{>->}[d]_{l_1}\ar[r]^{k_{\der{E},0}}&
      D_{\der{E},0} \ar@{>->}[d]^{f_{\der{E},0}} & K_1 \ar[r]^{u}
      \ar@{>->}[d]_{l_1}& P \ar@{>->}[d]^{f_0\circ
        p_0}\\L_1\ar[r]_{m_{\der{E},0}}&G_0 &L_1
      \ar[r]_{m_{\der{E},0}}&G_0} \]
\end{proof}

\subsubsection{Proofs for \Cref{subsec:CR}}

To prove the Local Church-Rosser Theorem, let us begin deducing some properties from the existence of a strong independence pair. 

\begin{remark}\label{rem:deco} 
	Let $(i_0, i_1)$ be a strong
	independence pair between the direct derivations $\dder{D}_0$ and
	$\dder{D}_1$. We can then build the solid part of the diagram
	below.
	\[\xymatrix{&&R_0 \ar@/_1cm/[ddrr]_(.35){i_0}|(.7)\hole
		\ar[dr]^{h_0}&& L_1\ar@/^1cm/[ddll]^(.35){i_1}
		\ar[dl]_{m_1}\\&K_0\ar[dr]^{k_0}\ar@{>->}[dl]_{l_0}
		\ar@/_.8cm/[ddrr]^(.65){u_0}\ar[ur]^{r_0}&& G_1 && K_1
		\ar@/^.8cm/[ddll]_(.65){u_1}\ar[dl]_{k_1}\ar@{>->}[lu]_{l_1}
		\ar[dr]^{r_1}\\L_0 \ar[dr]^{m_0}
		\ar@{.>}@/_.8cm/[ddrr]_{j_1}&& D_0
		\ar@{>->}[dl]|(.42)\hole_(.64){f_0}\ar[ur]|(.48)\hole^(.7){g_1}&&D_1
		\ar[dr]|(.42)\hole^(.65){g_1}
		\ar@{>->}[ul]|(.48)\hole_(.7){f_1}&&R_1\ar@/^.8cm/[ddll]^{j_0}\ar[dl]^{h_1}\\&G_0
		&&P\ar[dr]^{q_1}
		\ar@{>.>}[dl]_{q_0}\ar[ur]^(.4){p_1}\ar@{>->}[ul]_(.4){p_0}&&G_2\\&&Q_0
		\ar@{>->}@{>.>}[ul]_{a_0} &&Q_1\ar@{.>}[ur]^{b_1}}
	\]
	
	Let us complete this diagram defining the dotted arrows. To get
	$j_1\colon L_0\to Q_0$ and $q_0\colon P\to Q_0$ it is enough to
	take a pushout of $l_0$ along $u_0$, which exists since
	$l_0\in \mathcal{M}$. Moreover, the existence of the wanted
	$a_0\colon Q_0\to G_0$ and $b_1\colon Q_1\to G_2$ follows from
	\[
	f_0\circ p_0 \circ u_0 = f_0\circ k_0 = m_0\circ l_0 \qquad
	g_1\circ p_1\circ u_1 = g_1\circ k_1=h_1\circ r_1
	\]
	
	\noindent
	\parbox{5.5cm}{\hspace{15pt}We can prove some other properties of
		the arrows appearing in the diagram above. The four rectangles
		aside are pushouts and their left halves are pushouts
		too. Therefore, by \Cref{lem:po1}, also their right halves are
		pushouts.  Moreover, that $q_0$ and $a_0$ are pushouts of,
		respectively $l_0$ and $p_0$, thus they are elements of
		$\mathcal{M}$. By \Cref{prop:pbpoad} the left halves of the
		first and third rectangles are pullbacks too.}  \parbox{3.5cm}{
		$\xymatrix{K_0 \ar@/^.4cm/[rr]^{k_0}\ar[d]_{r_0}\ar[r]_{u_0}
			&P\ar[d]^{p_1} \ar@{>->}[r]_{p_0} & D_0 \ar[d]^{g_0}&K_1
			\ar@/^.4cm/[rr]^{k_1}\ar@{>->}[d]_{l_1}\ar[r]_{u_1}
			&P\ar@{>->}[d]^{p_0} \ar[r]_{p_1} & D_1 \ar@{>->}[d]^{f_1}\\
			R_0 \ar@/_.4cm/[rr]_{h_0} \ar[r]^{i_0}&D_1 \ar@{>->}[r]^{f_1}
			& G_1&L_1 \ar@/_.4cm/[rr]_{m_1} \ar[r]^{i_1}&D_0\ar[r]^{g_0} &
			G_1}$
		$\xymatrix{K_0
			\ar@/^.4cm/[rr]^{k_0}\ar@{>->}[d]_{l_0}\ar[r]_{u_0}
			&P\ar@{>->}[d]^{q_0} \ar@{>->}[r]_{p_0} & D_0
			\ar@{>->}[d]^{f_0}&K_1
			\ar@/^.4cm/[rr]^{k_1}\ar[d]_{r_1}\ar[r]_{u_1}
			&P\ar[d]^{q_1} \ar[r]_{p_1} & D_1 \ar[d]^{g_1}\\
			L_0 \ar@/_.4cm/[rr]_{m_0} \ar[r]^{j_1}&Q_0 \ar@{>->}[r]^{a_0}
			& G_0&R_1 \ar@/_.4cm/[rr]_{h_1} \ar[r]^{j_0}&Q_1 \ar[r]^{b_1}
			& G_2}$}
\end{remark}


\thmChurch*
\label{thmChurch-proof}

\begin{proof}

  Let us begin considering the diagram
  built in \Cref{rem:deco}:
  \[\xymatrix{&&R_0
      \ar@/_1cm/[ddrr]_(.35){i_0}|(.7)\hole \ar[dr]^{h_0}&&
      L_1\ar@/^1cm/[ddll]^(.35){i_1}
      \ar[dl]_{m_1}\\&K_0\ar[dr]^{k_0}\ar@{>->}[dl]_{l_0}
      \ar@/_.8cm/[ddrr]^(.65){u_0}\ar[ur]^{r_0}&& G_1 && K_1
      \ar@/^.8cm/[ddll]_(.65){u_1}\ar[dl]_{k_1}\ar@{>->}[lu]_{l_1}
      \ar[dr]^{r_1}\\L_0 \ar[dr]^{m_0} \ar@{>}@/_.8cm/[ddrr]_{j_1}&& D_0
      \ar@{>->}[dl]|(.42)\hole_(.64){f_0}\ar[ur]|(.48)\hole^(.7){g_1}&&D_1
      \ar[dr]|(.42)\hole^(.65){g_1}
      \ar@{>->}[ul]|(.48)\hole_(.7){f_1}&&R_1\ar@/^.8cm/[ddll]^{j_0}\ar[dl]^{h_1}\\&G_0
      &&P\ar[dr]^{q_1}
      \ar@{>->}[dl]_{q_0}\ar[ur]^(.4){p_1}\ar@{>->}[ul]_(.4){p_0}&&G_2\\&&Q_0
      \ar@{>->}@{>->}[ul]_{a_0} \ar@{.>}[dr]_{b_0} &&Q_1\ar[ur]^{b_1}
      \ar@{>.>}[dl]^{a_1} \\ &&&H_1 }\] Since $q_0\colon P\to Q_0$ is in
  $\mathcal{M}$, we can take its pushout along $q_1$ to get the dotted
  arrows $a_1\colon Q_1\to H_1$ and $q_0\colon Q_0\to H_1$. But then,
  since the composite of two pushout squares is a pushout, the diagram
  below is a derivation.
  \[\xymatrix@C=15pt{L_1 \ar[d]_{f_0 \circ i_1}&& K_1
      \ar[d]_{q_0\circ u_1}\ar@{>->}[ll]_{l_1} \ar[r]^{r_1} & R_1
      \ar@/^.35cm/[drrr]|(.3)\hole_(.4){j_0} \ar[dr]|(.3)\hole_{a_1\circ
        j_0} && L_0 \ar@/_.35cm/[dlll]^(.4){j_1} \ar[dl]|(.3)\hole^{b_0\circ
        j_1}& K_1 \ar[d]^{q_1\circ u_0}\ar@{>->}[l]_{l_0} \ar[rr]^{r_0} && R_0
      \ar[d]^{g_1\circ i_0} \\G_0 && \ar@{>->}[ll]^{a_0} D_0 \ar[rr]_{b_0}&&
      G_1 && \ar@{>->}[ll]^{a_1} D_1 \ar[rr]_{b_1}&& G_2}\] It is immediate
  now to see that it is a switch of $\dder{D}_0$ and $\dder{D}_1$ along
  $(i_0, i_1)$.
\end{proof}

\begin{remark}
	\label{rem:church}
	It is worth to point out that, by
	\Cref{prop:switch,thm:switch_uni}, the derivation we obtain from
	\Cref{thm:church} is made by two switchable derivations which will
	give back the starting derivation (up to abstraction equivalence),
	if switched again.
	
	Moreover, by \Cref{prop:pbpoad}, the first square below is a
	pullback, therefore, by \cref{rem:deco} the last three squares
	witness that $(j_0, j_1)$ is a strong independence pair too.
	\[
	\xymatrix{P\ar[r]^{q_1} \ar@{>->}[d]_{q_0}&Q_1
		\ar@{>->}[d]^{a_1}&K_1 \ar[r]^{r_1} \ar[d]_{u_1}& R_1
		\ar[d]^{j_0} & K_0 \ar@{>->}[r]^{l_0} \ar[d]_{u_0}& L_0
		\ar[d]^{j_1}&K_0 \ar[r]^{r_0} \ar[d]_{u_0}& R_0\ar[d]^{i_0} \\
		Q_ 0\ar[r]_{b_0}&H_1&P \ar[r]_{q_1} & Q_1 &P \ar[r]_{q_0} &
		Q_0&P \ar[r]_{p_1} & D_1}
	\]
\end{remark}


\propEqui*
\label{propEqui-proof}

\begin{proof}
  Suppose that $\X$ is $\mathcal{M}$-adhesive and let $(i_0, i_1)$ be
  an independence pair as below.
  \[
    \xymatrix@C=15pt{L_0 \ar[d]_{m_0}&& K_0
      \ar[d]_{k_0}\ar@{>->}[ll]_{l_0} \ar@{>->}[r]^{r_0} & R_0
      \ar@/^.35cm/[drrr]|(.3)\hole_(.4){i_0} \ar[dr]|(.3)\hole_{h_0}
      && L_1 \ar@/_.35cm/[dlll]^(.4){i_1} \ar[dl]|(.3)\hole^{m_1}& K_1
      \ar[d]^{k_1}\ar@{>->}[l]_{l_1} \ar@{>->}[rr]^{r_1} && R_1
      \ar[d]^{h_1} \\G_0 && \ar@{>->}[ll]^{f_0} D_0
      \ar@{>->}[rr]_{g_0}&& G_1 && \ar@{>->}[ll]^{f_1} D_1
      \ar@{>->}[rr]_{g_1}&& G_2}\]

  Since $(\X, \R)$ is linear, then $r_1\colon K_1\to R_1$ belongs to
  $\mathcal{M}$, thus it admits a pushout along $u_1\colon K_1\to P$,
  as desired. Moreover, let us consider the two rectangles below.
  \[
    \xymatrix{K_0 \ar@/^.4cm/[rr]^{k_0}\ar@{>->}[d]_{r_0}\ar[r]_{u_0}
      &P\ar@{>->}[d]^{p_1} \ar@{>->}[r]_{p_0} & D_0
      \ar@{>->}[d]^{f_0}& K_1
      \ar@/^.4cm/[rr]^{k_1}\ar@{>->}[d]_{l_1}\ar[r]_{u_1}
      &P\ar@{>->}[d]^{p_0} \ar@{>->}[r]_{p_1} & D_1
      \ar@{>->}[d]^{f_1}\\ R_0 \ar@/_.4cm/[rr]_{h_0} \ar[r]^{i_0}&D_1
      \ar@{>->}[r]^{f_1} & G_1& L_1 \ar@/_.4cm/[rr]_{m_1}
      \ar[r]^{i_1}&D_0 \ar@{>->}[r]^{g_0} & G_1} \] By hypothesis
  $r_0$ and $l_1$ are in $\mathcal{M}$, thus $f_1$ and $g_0$ belong to
  it too. The first point of \Cref{lem:popb} yields the thesis.
\end{proof}

\begin{remark}\label{rem:fill} Let $\der{D}=\{\dder{D}_i\}_{i=0}^n$ be a derivation and $(i_0, i_1)$ a strong independence pair between $\dder{D}_0$ and $\dder{D}_1$. Let also $\{\der{E}_{i}\}_{i=0}^1$ be a switch for them along $(i_0, i_1)$. Since, by \Cref{thm:switch_uni}, all switches are abstraction equivalent, we get the diagram below.
	
	\[\xymatrix{&&R_0 \ar@/_1cm/[ddrr]_(.35){i_0}|(.7)\hole
		\ar[dr]^{h_0}&& L_1\ar@/^1cm/[ddll]^(.35){i_1}
		\ar[dl]_{m_1}\\&K_0\ar[dr]^{k_0}\ar@{>->}[dl]_{l_0}
		\ar@/_.8cm/[ddrr]|(.36)\hole^(.65){u_0}\ar[ur]^{r_0}&& G_1 &&
		K_1
		\ar@/^.8cm/[ddll]|(.36)\hole_(.65){u_1}\ar[dl]_{k_1}\ar@{>->}[lu]_{l_1}
		\ar[dr]^{r_1}\\L_0
		\ar@/_.8cm/[ddrr]_(.2){i'_0}|(.31)\hole|(.81)\hole
		\ar[dr]^(.4){m_0}|(.61)\hole && D_0
		\ar@{>->}[dl]|(.4)\hole_(.65){f_0}\ar[ur]|(.5)\hole^(.7){g_0}&&D_1
		\ar[dr]|(.4)\hole^(.65){g_1}
		\ar@{>->}[ul]|(.5)\hole_(.65){f_1}&&R_1\ar@/^.8cm/[ddll]^(.2){i'_1}|(.31)\hole|(.81)\hole\ar[dl]_{h_1}|(.6)\hole\\&G_0
		&&P_1\ar[dr]_{q_1}	\ar@{>->}[dl]^{q_0}\ar[ur]^(.4){p_1}\ar@{>->}[ul]_(.4){p_0}&&G_2\\L_1	\ar@/^.8cm/[uurr]^(.2){i_1} \ar[ur]_(.35){m'_0}|(.61)\hole && D'_0	\ar@{>->}[ul]|(.4)\hole_(.65){f'_0}\ar[dr]|(.5)\hole^(.65){g'_0}	&&D'_1\ar[ur]|(.4)\hole^(.65){g'_1} \ar@{>->}[dl]|(.5)\hole_(.65){f'_1}	&& R_0 \ar[ul]^(.35){h'_1}|(.61)\hole\ar@/_.8cm/[uull]_(.2){i_0}\\ &K_1	\ar[ur]_{k'_0} \ar[dr]_{r_1}	\ar@{>->}[ul]^{l_1}\ar@/^.8cm/[uurr]_(.65){u_1}&&G'_1&& K_0\ar[ur]_{r_0} \ar[ul]^{k'_1} \ar@{>->}[dl]^{l_0} \ar@/_.8cm/[uull]^(.65){u_0}\\&& R_1	\ar[ur]_{h'_0}\ar@/^1cm/[uurr]^(.25){i'_1}&& L_0 \ar[ul]^{m'_1} \ar@/_1cm/[uull]_(.25){i'_0} |(.69)\hole }\] 

\end{remark}


\subsubsection{Proofs for \Cref{subsec:verytame}}

\begin{proposition}
	\label{pr:weak}
	Let $(\X, \R)$ be a linear DPO rewriting system. Then it is well switching.
\end{proposition}
\begin{proof}
	
	Let $(i_0, i_1)$ and $(i'_0, i'_1)$ be independence pairs for the
	direct derivations $\dder{D}$ and $\dder{D}'$. Notice that, by
	definition, we have
	\[
	f_1\circ i_0=h_0=f_1\circ i'_0 \qquad g_0\circ i_1=m_1= g_0\circ i'_1
	\]
	
	The arrow $f_1\colon D\to G_1$ is the pushout of
	$l_1\colon K_1\mto L_1$, thus it is in $\mathcal{M}$ implying
	$i_0=i'_0$. If, moreover, we suppose that the rule $\rho$ applied in
	$\dder{D}$ is linear, then $g_0\colon D_0\to G_1$ is in
	$\mathcal{M}$ too entailing $i'_1=i'_1$, too.
\end{proof}



\lemVTame*
\label{lemVTame}


\begin{proof}
	Every node-merging graphical rewriting system is strong enforcing because $\gph{G}$ is in the class $\mathbb{B}^+$ defined in \Cref{app:fill}.  Consider the following diagram 
	\[\xymatrix@R=25pt@C=30pt{L_0 \ar[d]_{m_0}&& K_0
		\ar[d]_{k_0}\ar@{>->}[ll]_{l_0} \ar[r]^{r_0} & R_0
		\ar@<-.5ex>@/^.35cm/[drrr]|(.23)\hole|(.34)\hole_(.4){i_0} 	\ar@<.5ex>@/^.35cm/[drrr]^(.2){j_0}|(.31)\hole |(.4)\hole
		\ar[dr]|(.3)\hole_{h_0} && L_1 \ar@<.5ex>@/_.35cm/[dlll]^(.4){i_1} \ar@<-.5ex>@/_.35cm/[dlll]_(.2){j_1}
		\ar[dl]|(.3)\hole^{m_1}& K_1 \ar[d]^{k_1}\ar@{>->}[l]_{l_1}
		\ar[rr]^{r_1} && R_1 \ar[d]^{h_1}\\G_0 && \ar@{>->}[ll]^{f_0}
		D_0 \ar[rr]_{g_0}&& G_1 && \ar@{>->}[ll]^{f_1} D_1
		\ar[rr]_{g_1}&& G_2}\] 
	
	Since $f_1$ is mono then $i_0=j_0$. For every $v$ with depth $0$ we have
	\[g_{0,v}\circ i_{1,v}=h_{0,v}=g_{0,v}\circ j_{1,v}\]
	which entails $i_{1,v}=j_{1,v}$. Let now $v$ be a vertex with depth greater than $0$, and take $x\in L_1(v)$. By definition, we have $p:w\to v$ and $y\in L_{1}(w)$  such that $\dph(w)=0$ and $L(p)(y)=x$. By naturality have:
	\[i_{1,v}(x)=i_{1,v}(L(p)(y))=L(p)(i_{1, w}(y))=L(p)(j_{1, w}(y))=j_{1,v}(L(p)(y))=j_{1,v}(x)\]
	From this we can deduce that $i_{1,v}=j_{1,v}$ as wanted.
\end{proof}

\subsubsection{Proofs for \Cref{subsec:perm}}

\begin{lemma}\label{lem:colim}
	Let $\X$ be an $\mathcal{M}$-adhesive category and $(\X, \R)$ a
	left-linear DPO rewriting system over it. The following properties
	hold true.
	\begin{enumerate}
		\item  If $\der{D}$ is a derivation from $G$ to $H$, then the diagram $\Delta(\der{D})$ has a colimit $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D})})$ such that $\iota_H$ belongs to $\mathcal{M}$. Moreover, if $(\X, \R)$ is linear, then every coprojection $\iota_X$ belongs to $\mathcal{M}$.
		
		\parbox{10cm}{
		\item Let $\der{D}$ be the concatenation of two derivations $\der{D}_1=\{\dder{D}_{1,i}\}_{i=0}^{n_1}$ between $G$ and $H$ and $\der{D}_2=\{\dder{D}_{2,j}\}_{j=0}^{n_2}$ between $H$ and $T$,  then the colimiting cocone $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D})})$ exists too and there is a pushout square as the one aside
		where $(\tproi{D}{1}, \{\iota_{1, X}\}_{X\in \Delta(\der{D}_1)})$ and $(\tproi{D}{2}, \{\iota_{2, X}\}_{X\in \Delta(\der{D}_2)})$ are the colimiting cocone for $\Delta(\der{D}_1)$ and $\Delta(\der{D}_2)$, respectively.} 
		\parbox{3cm}{\vspace{-.5cm}
		$\xymatrix{H\ar[r]^-{\iota_{2, H}} \ar@{>->}[d]_-{\iota_{1, H}} & \tproi{D}{2} \ar[d]^{p_2}\\  \tproi{D}{1} \ar[r]_{p_1}& \tpro{D}}$}
	\end{enumerate}
\end{lemma}
\begin{remark}\label{rem:cof}
	Let $I:\Deltamin(\dder{D})\to \Delta(\dder{D})$ be the inclusion functor. It is immediate to see that such functor is \emph{final} \cite{mac2013categories}. This means that for every functor $F\colon \Delta(\dder{D})\to \Y$ we have:
	\begin{enumerate}
		\item if  $(C, \{c_X\}_{X\in \Deltamin(\dder{D})})$ is colimiting for $F\circ I$, then there exists a colimiting cocone $(D, \{d_X\}_{X\in \Delta(\dder{D})})$ for $F$;
		\item $(C, \{c_X\}_{X\in \Deltamin(\dder{D})})$ and $(D, \{d_X\}_{X\in \Delta(\dder{D})})$ are colimiting for, repsectively, $F\circ I$ and $F$, then the canonical arrow $\phi\colon C\to D$ induced by $(D, \{d_X\}_{X\in \Deltamin(\dder{D})})$ is an isomorphism.
	\end{enumerate}
\end{remark}

\begin{proof}
	\begin{enumerate}
		\item Let us proceed by induction on the length of $\der{D}$.
		
		
		\smallskip \noindent
		$\lgh(\dder{D})=0$. then the
		$\tpro{\dder{D}}$ is simply $(G, \{\id{G}\})$ and
		$\id{G}\in \mathcal{M}$.¸
		
		\smallskip \noindent
		$\lgh(\dder{D})=1$. Suppose that $\dder{D}$
		has as its single component the derivation
		\[\xymatrix{L \ar[d]_{m}& K \ar[d]^{k}\ar@{>->}[l]_{l} \ar[r]^{r} & R \ar[d]^{h} \\G& \ar@{>->}[l]^{f} D \ar[r]_{g}& H  \\}\]
	
		\parbox{11cm}{The arrow $f$ is  the pushout of $l$ and so it is in in $\mathcal{M}$. We can thus consider the $\mathcal{M}$-pushout square depicted on the right.
		Since $p\in \mathcal{M}$, and $q$ is in it if $(\X, \R)$ is linear. The thesis follows immediately from \Cref{rem:cof}.}
		\parbox{2cm}{
			$\xymatrix{D \ar@{>->}[d]_{f} \ar[r]^{g} & H \ar@{>->}[d]^{p} \\G \ar[r]_{q}& P }$}
		
		\smallskip \noindent
	\parbox{9cm}{$\lgh(\dder{D})\geq 2$. Let $\der{D}$ be
		$\{\dder{D}_i\}_{i=0}^n$ with $n\geq 1$. Let also $\der{D}'$ be
		$\{\dder{D}_i\}^{n-1}_{i=0}$ and $\rho_n=(l_n, r_n)$ be the rule
		applied in $\dder{D}_n$. The pushout of $l_n$ is the arrow
		$f_n\colon D_n\to G_n$ is in $\mathcal{M}$ and, by inductive
		hypothesis, $\iota_{G_{n}}\colon G_{n}\to \lpro \der{D}'\rpro$ is
		in $\mathcal{M}$ too. Thus, we can consider the diagram aside,
		having a pushout as its lower half.

\smallskip \noindent 
\parbox{13.45cm} {\hspace{15pt}
		Notice that, as in the point above, the arrow $q\colon H\to P$ is the pushout of an element in $\mathcal{M}$, and, silimarly, $p$ is so if $(\X, \R)$ is linear.Therefore it is enough to show that the diagram so constructed provides a colimiting cocone for $\Delta(\der{D})$.}}
		\parbox{4cm}{\vspace{-1.5cm}$\xymatrix@R=15pt{L_n \ar[d]_{m_{n}}& K_{n} \ar[d]^{k_{n}}\ar@{>->}[l]_{l_{n}} \ar[r]^{r_{n}} & R_{n} \ar[d]^{h_n} \\G_{n} \ar@{>->}[d]_{\iota'_{G_{n}}}& \ar@{>->}[l]^{f_n} D_n \ar[r]_{g_n}& H  \ar@{>->}[d]^{q}\\ \lpro \der{D}' \ar[rr]_{p}\rpro && P}$}
		
		Let $(C, \{c_X\}_{X\in \Delta(\der{D})})$ be a cocone, since $\Delta(\der{D}')$ is a subdiagram of $\Delta(\der{D})$, we get another cocone $(c, \{c_X\}_{X\in \Delta(\der{D}')})$ which induces an arrow $c'\colon \lpro \der{D}' \rpro \to C$ such that
		\[
		c'\circ \iota_{G_n} \circ f_n  =c_{G_n} \circ f_n = c_{D_n}= c_{H}\circ g_n\]
		
		Therefore the arrows $c'$ and $c_H$ induce a morphism $c\colon P\to C$ and the thesis follows.
		
		\item As a first step, notice that
		$(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D}_1)})$ and
		$(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D}_2)})$ are cocone on,
		respectively, $\Delta(\der{D}_1)$ and $\Delta(\der{D}_2)$. Hence,
		there exist two arrows $p_1\colon \tproi{D}{1}\to \tpro{D}$,
		$p_2\colon \tproi{D}{2}\to \tpro{D}$ such that, for every
		$X\in \Delta(\der{D}_1)$ and $Y\in \Delta(\der{D}_2)$
		\[p_1\circ \iota_{1, X} = \iota_X \qquad p_2\circ \iota_{2, Y}=\iota_{2,Y}\]
	\parbox{10cm}{In particular, this entails the commutativity of the square on the right.		Let us now show that the square above is a pushout. Take two arrows $a\colon \tproi{D}{1}\to C$, $b\colon \tproi{D}{2}\to C$ such that  \[a\circ \iota_{1, H}=b\circ \iota_{2, H}\].}
		\parbox{2cm}{\vspace{-1.1cm}$\xymatrix{H \ar[dr]^{\iota_H} \ar[r]^-{\iota_{2, H}} \ar@{>->}[d]_-{\iota_{1, H}} & \tproi{D}{2} \ar[d]^{p_2}\\  \tproi{D}{1} \ar[r]_{p_1}& \tpro{D}}$}
		
			We can use the previous equality to define a cocone $(C, \{c_X\}_{X\in \Delta(\der{D})})$ putting:
		\[c_X:=\begin{cases}
			a\circ \iota_{1, X} & X\in \Delta(\der{D}_1) \\
			b\circ \iota_{2, X} & X\in \Delta(\der{D}_2)
		\end{cases}\]
		
		
		From this, we can deduce at once the existence of a unique $c\colon \tpro{D}\to C$ such that
		$c\circ \iota_X = c_X$. By construction, for every $X\in  \Delta(\der{D}_1)$ and $Y\in  \Delta(\der{D}_2)$ we have
		\begin{align*}
			c\circ p_1 \circ \iota_{1,X}&=c\circ \iota_{X}=c_X =a\circ \iota_{1,X}=a\circ p_1\circ \iota_{1,X}\\
			c\circ p_2 \circ \iota_{2,Y}&=c\circ \iota_{Y}=c_Y =b\circ \iota_{2,Y}=b\circ p_2\circ \iota_{2,Y}
		\end{align*}
		Therefore $c\circ p_1=a$ and $c\circ p_2 = b$.
		
		For uniqueness, suppose that $c'\colon \tpro{D}\to C$ is such that $c'\circ p_1=a$ and $c'\circ p_2 = b$.
		Then, for every $X\in \Delta(\der{D})$ we have
		\[	c'\circ \iota_X  = \begin{cases}
			c'\circ p_1\circ \iota_{1, X} & X\in \Delta(\der{D}_1) \\
			c'\circ p_2\circ \iota_{2, X} & X\in \Delta(\der{D}_2)
		\end{cases} =\begin{cases}
			a\circ \iota_{1, X} & X\in \Delta(\der{D}_1) \\
			b\circ \iota_{2, X} & X\in \Delta(\der{D}_2)
		\end{cases}=c_X=c\circ \iota_X\]
		showing that $c'=c$ as wanted.	 \qedhere
	\end{enumerate}
\end{proof}

\noindent 
\parbox{8cm}{
\begin{corollary}
	\label{cor:colim}
	Let $\der{D}=\{\dder{D}_i\}_{i=0}^n$ a derivation of length $n+1$
	and fix an index $j\in[0,n]$. Define $\der{D}^j_1:=\{\dder{D}_i\}_{i=0}^{j-1}$, 
	$\der{D}^j_2=\{\dder{D}_j\}$ and 
	$\der{D}^j_3:=\{\dder{D}_i\}_{i=j+1}^n$, 	with the convention that
	$\der{D}^0_1$ and $\der{D}^n_3$ are the empty derivation on,
	respectively, $G_0$ and $G_n$. Then the square aside is a pushout
	and a pullback, where the two arrows $p_1\colon \lpro\der{D}^j_1 \rpro\to \tpro{D}$,
	$p_2\colon \lpro \der{D}^j_3\rpro \to \tpro{D}$ are induced by the
	cocones $(\tpro{D}, \{\iota_{X}\}_{X\in \Delta(\der{D}^j_1)})$ and
	$(\tpro{D},\{\iota_{X}\}_{X\in \Delta(\der{D}^j_3)})$, respectively.
\end{corollary}}
\parbox{4cm}{\vspace{-.5cm}$\xymatrix@C=30pt{D_{j} \ar[ddrr]^{\iota_{D_j}}
	\ar[r]^{g_j}\ar@{>->}[d]_{f_j}& G_{j+1}
	\ar[ddr]^{\iota_{G_{j+1}}}
	\ar[r]^-{\iota_{3, G_{j+1}}} & \lpro \der{D}^j_3\rpro \ar[dd]^{p_2} \\
	G_j\ar[drr]_{\iota_{G_{j}}} \ar@{>->}[d]_{\iota_{1,G_j}}\\ \lpro
	\der{D}^j_1 \rpro \ar[rr]_{p_1} &&\tpro{D} }$}


\begin{remark}
	If $\der{D}$ is empty then $\der{D}^j_1, \der{D}^j_2$ and
	$\der{D}^j_3$ are empty too.
\end{remark}

\noindent 
\parbox{5cm}{\vspace{1em}$
\xymatrix@C=30pt@R=15pt{D_{j} \ar[r]^{g_j}\ar@{>->}[d]_{f_j}& G_{j+1}
	\ar[r]^-{\iota_{3,G_{j+1}}} \ar[d]_{\iota_{2, G_{j+1}}}
	\ar@/^.5cm/[dd]^{\iota_{1,2, G_{j+1}}}& \lpro \der{D}^j_3\rpro
	\ar[dd]^{p_2} \\ G_j \ar[r]^{\iota_{2,
			G_j}}\ar@{>->}[d]_{\iota_{1,G_j}} & \lpro \der{D}^j_2\rpro
	\ar[d]_a\\ \lpro \der{D}^j_1 \rpro \ar@/_.4cm/[rr]_{p_1}
	\ar[r]^b &\lpro \der{D}^j_1\cdot \der{D}^j_2 \rpro
	\ar[r]^c&\tpro{D} }$}\qquad  \qquad
\parbox{7.5cm}{\begin{proof}
	We can notice that
	$\der{D}=\der{D}^j_1\cdot \der{D}^j_2 \cdot \der{D}^j_3$. By the
	first and the second point of \Cref{lem:colim} then we get the
	 diagram on the left, in which all squares are $\mathcal{M}$-pushouts. Applying \Cref{lem:po1} twice we get that the whole square is an
	$\mathcal{M}$-pushout. Then the thesis follows from
	\Cref{prop:pbpoad}.
\end{proof}}

\begin{corollary}
	\label{cor:ele}
	Let $\der{D}=\{\dder{D}_{i}\}_{i=0}^n$ be a derivation between $G$
	and $H$. Let $j$ and $k$ be two indexes less or equal than $n+1$ and
	suppose that $j< k$.  Consider two arrows $a\colon T\to G_j$,
	$b\colon T\to G_k$. If $\iota_{G_j}\circ a = \iota_{G_k}\circ b$,
	then there exist a unique arrow $c\colon T\to D_j $ such
	that \[f_j\circ c = a\qquad \iota_{D_j}\circ c =\iota_{G_k}\circ b\]
\end{corollary}
\begin{lemma}\label{lem:idevero}
	Let $\der{D}=\{\dder{D}_{i}\}_{i=0}^n$ and $\der{D}'=\{\dder{D}'_i\}_{i=0}^n$ be two non-empty derivations in a linear DPO-rewriting system $(\X, \R)$ . Let  $\sigma:[0,n-1]\to [0,n-1]$  is a consistent permutation and suppose that the set 
	\[E_{\sigma}=\{i\in [0,n-1]\mid \sigma(i)=i\}\]
	is non empty with maximum $k$. Then $\{\dder{D}_i\}_{i=0}^k$ and $\{\der{D}'_i\}_{i=0}^k$ are abstraction equivalent.  
\end{lemma}

\begin{proof}We construct are going to construct by induction on $i\in [0,n]$ an abstraction equivalence such that, for every $i$, $\iota'_{G'_{i+1}}\circ \phi_{G_{i+1}}=\xi_{\id{[0,n]}}\circ \iota_{G_{i+1}}$.
	
	\smallskip \noindent \parbox{8.2cm}{$i=0$. We start noticing that, by consistency
		\[\iota'_{G_0}\circ m'_0=\xi_\sigma \circ \iota_{G_0}\circ m_0=\iota'_{G_0}\circ m_0\]
		By linearity and \Cref{lem:colim}, $\iota'_{G_0}$ is a mono, thus $m_0=m'_0$. By  \Cref{prop:unique} we deduce the existence of the dotted isomorphisms in the diagram aside.} \parbox{4cm}{\vspace{0ex}$\xymatrix@C=40pt{G_0&D'_0 \ar@{>->}[r]^{g'_0}
			\ar@{>->}[l]_{f'_0}&G'_{1}\\ L_0 \ar[u]^{m'_0} \ar[d]_{m_0}& K_0
			\ar[u]^{k'_0} \ar[d]_{k_0} \ar@{>->}[r]^{r_0} \ar@{>->}[l]_{l_0}
			&R_0\ar[u]^{h'_0} \ar[d]_{h_0}\\G_0
			\ar@/_.45cm/[uu]_(.35){\id{G_0}}|\hole& D_0 \ar@{>->}[l]^{f_0}  \ar@{.>}@/_.45cm/[uu]_(.35){\phi_{D_0}}|\hole
			\ar@{>->}[r]_{g_0}& G_{1}\ar@{.>}@/_.45cm/[uu]_{\phi_{G_1}}}$}
	
	Now, if we compute we have
	\begin{align*}
		&\iota'_{G'_1}\circ \phi_{G_1}\circ g_0=\iota'_{G'_1}\circ g'_0\circ \phi_{D_0}=\iota'_{D_0}\circ \phi_{D_0}=\iota'_{G_0}\circ f'_0\circ \phi_{D_0}\\=&\iota'_{G_0}\circ f_0=\xi_{\sigma} \circ \iota_{G_0}\circ  f_0=\xi_{\sigma} \circ \iota_{D_0}=\xi_{\sigma} \circ \iota_{G_1}\circ g_0 
	\end{align*}
	This now entails that $\iota'_{G'_1}\circ \phi_{G_1}=\xi_{\id{[0,n]}}\circ \iota_{G_1}$.
	
	
	\smallskip  \noindent \parbox{7.5cm}{$i>0$. By the inductive hypothesis there exists an isomorphism $\phi_{G_{i}}\colon G_{i}\to G'_i$ such that $\phi_{G_{i}}\circ h_{i-1}=h'_{i-1}$. Now, as before we have
		\[\iota'_{G'_{i}}\circ m'_{i}=\xi_{\sigma}\circ \iota_{G_i}\circ m_{i}=\iota'_{G'_{i}}\circ \phi_{G_{i}} \circ m_i \]
		By linearity $\iota'_{G'_{i}}$ is mono, thus $m'_i=\phi_{G_{i}} \circ m_i$ and \Cref{prop:unique} yields again the dotted part of the diagram aside.}
	\parbox{4cm}{\vspace{-2em}$\xymatrix@C=40pt{G_i&D'_i \ar@{>->}[r]^{g'_i}
			\ar@{>->}[l]_{f'_i}&G'_{i+1}\\ L_i \ar[u]^{m'_i} \ar[d]_{m_i}& K_i
			\ar[u]^{k'_i} \ar[d]_{k_i} \ar@{>->}[r]^{r_i} \ar@{>->}[l]_{l_i}
			&R_i\ar[u]^{h'_i} \ar[d]_{h_i}\\G_i
			\ar@/_.45cm/[uu]_(.35){\phi_{G_i}}|\hole& D_i \ar@{>->}[l]^{f_i}  \ar@{.>}@/_.45cm/[uu]_(.35){\phi_{D_i}}|\hole
			\ar@{>->}[r]_{g_i}& G_{i+1}\ar@{.>}@/_.45cm/[uu]_{\phi_{G_{i+1}}}}$}
	
	To conclude, it is now enough to notice that
	\begin{align*}
		&\iota'_{G'_{i+1}}\circ \phi_{G_{i+1}}\circ g_i=\iota'_{G'_{i+1}}\circ g'_i\circ \phi_{D_{i}}=\iota'_{D_{i}}\circ \phi_{D_{i}}=\iota'_{G_i}\circ f'_i\circ \phi_{D_{i}} \\=&\iota'_{G'_{i}}\circ \phi_{G_{i}}\circ f_i=\xi_{\sigma}\circ \iota_{G_{i}}\circ f_i=\xi_{\sigma}\circ \iota_{D_{i}}=\xi_{\sigma}\circ \iota_{G_{i+1}}\circ g_i
	\end{align*}
	Which, 	since $G_{i+1}$ is obtained pushing $r_{i}$ along $k_{i}$ gives us the thesis 
\end{proof}

From \Cref{lem:idevero} we can deduce at once the following.

\lemIde*
\label{lemide-proof}
\begin{proof}
	If $\der{D}$ and $\der{D}'$ are empty then the thesis follows at once since an abstraction equivalence is just an isomorphism. Otherwise, if $\der{D}$ and $\der{D}'$ are non-empty the thesis follows from \Cref{lem:idevero}.
	
	
	\iffalse 
	We construct by induction on $i\in [0,n]$ an abstraction equivalence such that, for every $i$, $\iota'_{G'_{i+1}}\circ \phi_{G_{i+1}}=\xi_{\id{[0,n]}}\circ \iota_{G_{i+1}}$.
	
	\smallskip \noindent \parbox{8cm}{$i=0$. We start noticing that, by consistency
		\[\iota'_{G_0}\circ m'_0=\xi_\sigma \circ \iota_{G_0}\circ m_0=\iota'_{G_0}\circ m_0\]
		By linearity and \Cref{lem:colim} $\iota'_{G_0}$ is a mono, thus $m_0=m'_0$. By  \Cref{prop:unique} we deduce the existence of the dotted isomorphisms in the diagram aside.} \parbox{4cm}{\vspace{0em}$\xymatrix@C=40pt{G_0&D'_0 \ar@{>->}[r]^{g'_0}
			\ar@{>->}[l]_{f'_0}&G'_{1}\\ L_0 \ar[u]^{m'_0} \ar[d]_{m_0}& K_0
			\ar[u]^{k'_0} \ar[d]_{k_0} \ar@{>->}[r]^{r_0} \ar@{>->}[l]_{l_0}
			&R_0\ar[u]^{h'_0} \ar[d]_{h_0}\\G_0
			\ar@/_.45cm/[uu]_(.35){\id{G_0}}|\hole& D_0 \ar@{>->}[l]^{f_0}  \ar@{.>}@/_.45cm/[uu]_(.35){\phi_{D_0}}|\hole
			\ar@{>->}[r]_{g_0}& G_{1}\ar@{.>}@/_.45cm/[uu]_{\phi_{G_1}}}$}
	
	Now, if we compute we have
	\begin{align*}
		&\iota'_{G'_1}\circ \phi_{G_1}\circ g_0=\iota'_{G'_1}\circ g'_0\circ \phi_{D_0}=\iota'_{D_0}\circ \phi_{D_0}=\iota'_{G_0}\circ f'_0\circ \phi_{D_0}=\iota'_{G_0}\circ f_0\\=&\xi_{\id{[0,n]}} \circ \iota_{G_0}\circ  f_0=\xi_{\id{[0,n]}} \circ \iota_{D_0}=\xi_{\id{[0,n]}} \circ \iota_{G_1}\circ g_0 
	\end{align*}
	This now entails that $\iota'_{G'_1}\circ \phi_{G_1}=\xi_{\id{[0,n]}}\circ \iota_{G_1}$.
	
	
	\smallskip  \noindent \parbox{7.5cm}{$i>0$. By the inductive hypothesis there exists an isomorphism $\phi_{G_{i}}\colon G_{i}\to G'_i$ such that $\phi_{G_{i}}\circ h_{i-1}=h'_{i-1}$. Now, as before we have
		\[\iota'_{G'_{i}}\circ m'_{i}=\xi_{\id{[0,n]}}\circ \iota_{G_i}\circ m_{i}=\iota'_{G'_{i}}\circ \phi_{G_{i}} \circ m_i \]
		By linearity $\iota'_{G'_{i}}$ is mono, thus $m'_i=\phi_{G_{i}} \circ m_i$ and \Cref{prop:unique} yields again the dotted part of the diagram aside.}
	\parbox{4cm}{\vspace{-2em}$\xymatrix@C=40pt{G_i&D'_i \ar@{>->}[r]^{g'_i}
			\ar@{>->}[l]_{f'_i}&G'_{i+1}\\ L_i \ar[u]^{m'_i} \ar[d]_{m_i}& K_i
			\ar[u]^{k'_i} \ar[d]_{k_i} \ar@{>->}[r]^{r_i} \ar@{>->}[l]_{l_i}
			&R_i\ar[u]^{h'_i} \ar[d]_{h_i}\\G_i
			\ar@/_.45cm/[uu]_(.35){\phi_{G_i}}|\hole& D_i \ar@{>->}[l]^{f_i}  \ar@{.>}@/_.45cm/[uu]_(.35){\phi_{D_i}}|\hole
			\ar@{>->}[r]_{g_i}& G_{i+1}\ar@{.>}@/_.45cm/[uu]_{\phi_{G_{i+1}}}}$}
	
	To conclude, it is now enough to notice that
	\begin{align*}
		&\iota'_{G'_{i+1}}\circ \phi_{G_{i+1}}\circ g_i=\iota'_{G'_{i+1}}\circ g'_i\circ \phi_{D_{i}}=\iota'_{D_{i}}\circ \phi_{D_{i}}=\iota'_{G_i}\circ f'_i\circ \phi_{D_{i}} =\iota'_{G'_{i}}\circ \phi_{G_{i}}\circ f_i\\=&\xi_{\id{[0,n]}}\circ \iota_{G_{i}}\circ f_i=\xi_{\id{[0,n]}}\circ \iota_{D_{i}}=\xi_{\id{[0,n]}}\circ \iota_{G_{i+1}}\circ g_i
	\end{align*}
	Which, 	since $G_{i}$ is obtained pushing $r_{i-1}$ along $k_{i-1}$ gives us the thesis 
\fi 
\end{proof}


\begin{lemma}\label{lem:coswap}
Let $(\X, \R)$ be a strong enforcing rewriting system and $(i_0, i_1)$ an independence pair between $\dder{D}_{0}$ and $\dder{D}_1$, let also $\der{E}=\{\dder{E}_i\}_{i=0}^1$  be a switch of them along $(i_0, i_1)$. Then the transposition $(1,2):[0,1]\to [0,1]$ is a consistent permutation.
\end{lemma}
\begin{proof}
	Let $(\tpro{D}, \{\iota_{X}\}_{X\in \delta(\der{D})})$ and $(\tpro{E}, \{\iota'_{X}\}_{X\in \delta(\der{E})})$ be the colimiting cocones of $\Delta(\der{D})$ and $\Delta(\der{E})$. Using the notation of \Cref{rem:fill} we have
	\[\begin{split}
&\iota'_{G_2}\circ g_1\circ p_1= \iota'_{G_2}\circ g'_1\circ q_1=\iota'_{D'_1}\circ q_1\\=&\iota'_{G'_1}\circ f'_1\circ 	q_1=\iota'_{G'_1}\circ g'_0\circ q_0=\iota'_{D'_0}\circ q_0\\=&\iota'_{G_0}\circ f'_0\circ q_0=\iota'_{G_0}\circ f_0\circ p_0
	\end{split} \qquad \begin{split}
	&\iota_{G_2}\circ g'_1\circ q_1= \iota_{G_2}\circ g_1\circ p_1=\iota_{D_1}\circ p_1\\=&\iota_{G_1}\circ f_1\circ 	q_1=\iota_{G_1}\circ g_0\circ p_0=\iota_{D_0}\circ p_0\\=&\iota_{G_0}\circ f_0\circ p_0=\iota_{G_0}\circ f'_0\circ q_0
	\end{split}\]

	Thus there exist $\phi_{G_1}\colon G_1\to \tpro{E}$ and $\psi_{G'_1}\colon G'_1\to \tpro{D}$ fitting in the diagrams below.
	
	\[\xymatrix{P \ar[d]_{p_1} \ar@{>->}[r]^{p_0}& D_0 \ar@{>->}[dr]^{f_0} \ar[d]^{g_1} && P \ar[d]_{q_1} \ar@{>->}[r]^{q_0}& D'_0 \ar@{>->}[dr]^{f'_0} \ar[d]^{g'_1} \\D_1 \ar[dr]_{g_1} \ar@{>->}[r]_{f_1}&G_1  \ar@{.>}[dr]_{\phi_{G_1}}& G_0 \ar[d]^{\iota'_{G_0}} & D'_1 \ar[dr]_{g'_1} \ar@{>->}[r]_{f'_1}&G'_1  \ar@{.>}[dr]_{\psi_{G'_1}}& G_0 \ar[d]^{\iota_{G_0}}\\ & G_2 \ar[r]_{\iota'_{G_2}} & \tpro{E} && G_2 \ar[r]_{\iota_{G_2}} & \tpro{D}}\]
	In this way we get two morphisms $\xi_{(1,2)}\colon \tpro{D}\to \tpro{E}$ and $\xi'_{(1,2)}\colon \tpro{E}\to \tpro{D}$ such that
	\[\begin{split}
		\xi_{(1,2)}\circ \iota_{G_0}&=\iota'_{G_0}\\
		\xi_{(1,2)}\circ \iota'_{G_0}&=\iota_{G_0}
	\end{split} \quad \begin{split}\xi_{(1,2)}\circ \iota_{G_1}&=\phi_{G_1}\\ \xi_{(1,2)}\circ \iota'_{G_1}&=\psi_{G_1}
	\end{split} \quad\begin{split}
		\xi_{(1,2)}\circ \iota_{G_2}&=\iota'_{G_2}\\
		\xi_{(1,2)}\circ \iota'_{G_2}&=\iota_{G_2}
	\end{split}  \]
	
	It is immediate to see that these two morphism are one the inverse of the other. We have
\begin{align*}		\xi_{(1,2)}\circ \iota_{G_0}\circ m_0&= \iota'_{G_0}\circ m_0=\iota'_{G'_0}\circ f'_0
	\circ i'_0=\iota'_{D'_0}\circ i'_0=	\iota'_{G'_1}\circ g'_0\circ i'_0=\iota'_{G'_1}\circ m'_1\\
			\xi_{(1,2)}\circ \iota_{G_0}\circ m_0&= \iota'_{G_0}\circ m_0=\iota'_{G'_0}\circ f'_0
	\circ i'_0=\iota'_{D'_0}\circ i'_0=	\iota'_{G'_1}\circ g'_0\circ i'_0=\iota'_{G'_1}\circ m'_1
\end{align*}
	These two computations gives us consistency.
\end{proof}



\cref{lem:coswap}, together with \Cref{lem:colim}, gives us at once the following two results.

\begin{corollary}\label{cor:coswap}
Let $\der{D}$ and $\der{E}$ be two derivations such that $\der{D} \shift{\transp{i}} \der{E}$, then the transposition $(i,i+1):[0,\lgh{\der{D}}-1] \to [0,\lgh{\der{D}}-1] $ is a consistent permutation.
\end{corollary}


\propcoswitch*
\label{propcoswitch-proof}
\begin{proof}
	Let $\{\der{D}_{i}\}_{k=0}^m$ be a switching sequence such that 
	    \[\der{D}\equiv_a \der{D}_0 \shift{\transp{i_1}} \der{D}_1 \shift{\transp{i_2}} \ldots \shift{\transp{i_m}}
	\der{D}_m\equiv _a \der{E}\]
By \Cref{rem:abs,rem:compo} it is enough to find a consistent permutation between $\der{D}_0$ and $\der{D}_m$, but this follows at once from \Cref{rem:compo,cor:coswap}.
\end{proof}




\begin{lemma}
	Let $\der{D}$ and $\der{D}$ be two derivations in a linear rewriting system $(\X, \R)$. Suppose that a consistent permutation $\sigma:[0, \lgh(\der{D})-1]\to [0, \lgh(\der{D})-1]$ between them is given. If $i\in [0, \lgh(\der{D})-1]$ is the smallest index such that $\transp{i}$ is an inversion for $\sigma$, then the direct derivations $\dder{D}_i$ and $\dder{D}_{i+1}$ are sequentially independent.
\end{lemma}
\begin{proof}
	Let us start with the diagram below
	  \[\xymatrix@C=15pt{L_i \ar[d]_{m_i}&& K_i
		\ar[d]_{k_i}\ar@{>->}[ll]_{l_i} \ar@{>->}[r]^{r_i} & R_i
		\ar@{.>}@/^.35cm/[drrr]|(.3)\hole_(.4){j_0}
		\ar[dr]|(.3)\hole_{h_i} && L_{i+1} \ar@{.>}@/_.4cm/[dlll]^(.4){j_1}
		\ar[dl]|(.3)\hole^{m_{i+1}}& K_{i+1} \ar[d]^{k_{i+1}}\ar@{>->}[l]_{l_{i+1}}
		\ar@{>->}[rr]^{r_{i+1}} && R_{i+1} \ar[d]^{h_{i+1}}\\G_i && \ar@{>->}[ll]^{f_i}
		D_i \ar@{>->}[rr]_{g_i}&& G_{i+1} && \ar@{>->}[ll]^{f_{i+1}} D_{i+1}\ar@{>->}[rr]_{g_{i+1}}&& G_{i+2}}\]
	\parbox{9cm}{Notice that $\sigma$ restrict to the identity $[0, i-1]\to [0,i-1]$, which remains consistent. In particular, there exists an isomorphism $\phi_{i}\colon G_i\to G'_i$ such that the square on the right commutes.}
	\parbox{3cm}{\vspace{-.5cm}$\xymatrix{G_i \ar[d]_{\iota_{G_i}}\ar@/^.4cm/[rr]^{\phi_{G_i}}& L_0  \ar[l]^{m_i}\ar[r]_{m'_{i}} & G'_{i} \ar[d]^{\iota'_{G'_i}}\\ \tpro{D} \ar[rr]_{\xi_\sigma} & &\lpro\der{D}'\rpro  }$}
	
	
	
	
	By consistency we have the following equations:
	\[\begin{split}
		\iota_{G'_\sigma(i+1)}\circ m'_{\sigma(i+1)} =\xi_{\sigma}\circ \iota_{\sigma(i)}
	\end{split}\]
\end{proof}

\begin{remark}\label{rem:salvavita}
	Before proceeding further, it is worth to point out the following fact about inversions.
\end{remark}
\thmcoswitch*
\label{thmswitch-proof}
\begin{proof}$(1\Rightarrow 2)$ This follows from \Cref{rem:abs,prop:coswitch}.

\smallskip \noindent $(2\Rightarrow 1)$ We proceed by induction
\end{proof}

\subsubsection{Proofs for \cref{subsec:canonical}}


\lemSwitchConfluence*
\label{lemSwitchConfluence-proof}

\begin{proof}
NOTES ON THE FUNDAMENTAL LEMMA WE NEED

Everything is well switching, so that sequential independence coincides with switchability and we do not have ambiguity in the choice of an independence pair


We start with the following situation.
\[\xymatrix@C=15pt{L_0\ar[d]_{m_0}&& K_0 \ar[d]_{k_0}\ar[ll]_{l_0} \ar[r]^{r_0} & R_0 \ar@/^.35cm/[drrr]_(.4){i_0}|(.285)\hole \ar[dr]|(.28)\hole_{h_0} && L_1 \ar@/_.35cm/[dlll]^(.4){i_1} \ar[dl]|(.28)\hole^{m_1}& K_1 \ar[d]^{k_1}\ar[l]_{l_1} \ar[r]^{r_1} & R_1 \ar[dr]|(.28)\hole_{h_1} \ar@/^.35cm/[drrr]_(.4){j_0}|(.285)\hole  && L_2 \ar@/_.35cm/[dlll]^(.4){j_1} \ar[dl]|(.28)\hole^{m_2}& K_2 \ar[d]^{k_2}\ar[l]_{l_2} \ar[rr]^{r_2} && R_2 \ar[d]^{h_2} \\G_0 && \ar[ll]^{f_0} D_0 \ar[rr]_{g_0}&& G_1  && \ar[ll]^{f_1} D_1 \ar[rr]_{g_1}&& G_2 && \ar[ll]^{f_2} D_2 \ar[rr]_{g_2}&& G_3 }\]

We can do two things:

FIRST SEQUENCE OF SWITCHINGS:

Switch the first two


\[\xymatrix@C=15pt{L_1\ar[d]_{f_0\circ i_1}&& K_1 \ar[d]_{k'_1}\ar[ll]_{l_1} \ar[r]^{r_1} & R_1 \ar@/^.35cm/[drrr]_(.4){a_0}|(.285)\hole \ar[dr]|(.28)\hole_{h'_1} && L_0 \ar@/_.35cm/[dlll]^(.4){a_1} \ar[dl]|(.28)\hole^{m'_0}& K_0 \ar[d]^{k'_0}\ar[l]_{l_0} \ar[r]^{r_0} & R_0 \ar[dr]|(.28)\hole_{g_1\circ j_0} \ar@/^.35cm/[drrr]_(.4){b_0}|(.285)\hole  && L_2 \ar@/_.35cm/[dlll]^(.4){b_1} \ar[dl]|(.28)\hole^{m_2}& K_2 \ar[d]^{k_2}\ar[l]_{l_2} \ar[rr]^{r_2} && R_2 \ar[d]^{h_2} \\G_0 && \ar[ll]^{f'_0} D'_0 \ar[rr]_{g'_0}&& G'_1  && \ar[ll]^{f'_1} D'_1 \ar[rr]_{g'_1}&& G_2 && \ar[ll]^{f_2} D_2 \ar[rr]_{g_2}&& G_3 }\]

Moreover, we know that
\[m_0=f'_0\circ a_1 \qquad h_1=g'_1\circ a_0\]

Switch second and third
\[\xymatrix@C=15pt{L_1\ar[d]_{f_0\circ i_1}&& K_1 \ar[d]_{k'_1}\ar[ll]_{l_1} \ar[r]^{r_1} & R_1 \ar@/^.35cm/[drrr]_(.4){c_0}|(.285)\hole \ar[dr]|(.28)\hole_{h'_1} && L_2 \ar@/_.35cm/[dlll]^(.4){c_1} \ar[dl]|(.28)\hole^{f'_1\circ b_1}& K_2 \ar[d]^{k'_2}\ar[l]_{l_2} \ar[r]^{r_2} & R_2 \ar[dr]|(.28)\hole_{h'_2} \ar@/^.35cm/[drrr]_(.4){d_0}|(.285)\hole  && L_0 \ar@/_.35cm/[dlll]^(.4){d_1} \ar[dl]|(.28)\hole^{\hat{m}_0}& K_0 \ar[d]^{\hat{k}_0}\ar[l]_{l_0} \ar[rr]^{r_0} && R_0 \ar[d]^{g_2\circ b_0} \\G_0 && \ar[ll]^{f'_0} D'_0 \ar[rr]_{g'_0}&& G'_1  && \ar[ll]^{\hat{f}_1} \hat{D}_1 \ar[rr]_{\hat{g}_1}&& G'_2 && \ar[ll]^{f'_2} D'_2 \ar[rr]_{g'_2}&& G_3 }\]
And we know that
\[m'_0=\hat{f}_1\circ d_1 \qquad h_2=g'_2\circ d_0\]
\todo{qua abbiamo usato il secondo lemma dei tre passi (quello condizionale)}Since the rewriting system is well switching and using the three steps lemmas we can characterize $c_0\colon R_1\to \hat{D}_1$ and $c_1\colon L_2\to D'_0$ as the unique arrows fitting in the diagrams
\[\xymatrix@R=15pt@C=15pt{&&R_1 \ar@/_1.2cm/[dddl]_(.4){a_0}|(.63)\hole\ar[dl]^{j_0}\ar[dd]^{c'_0} \ar@{.>}[dr]^{c_0}\\&D_2 \ar[dl]^(.4){f_2}&&\hat{D}_1 \ar[dr]^{\hat{g}_1}\\G_2 && P\ar[dr]_{p_4} \ar[ur]_{p_3}\ar[dl]^{p_1} \ar[ul]^{p_2}&&G'_2\\& D'_1 \ar[ul]^{g'_1}&&D'_2 \ar[ur]_{f'_2}}\]

\[\xymatrix@R=15pt@C=15pt{&&L_2 \ar[dl]^{j_1} \ar@/_1.2cm/[dddl]_(.4){z_1}|(.63)\hole\ar[dd]^{c'_1} \ar@{.>}[dr]^{c_1}\\&D_1 \ar[dl]^(.4){f_1}&&D'_0 \ar[dr]^{g'_0}\\G_1 && Q\ar[dr]_{q_4} \ar[ur]_{q_3}\ar[dl]^{q_1} \ar[ul]_{q_2}&&G'_1\\& D_0 \ar[ul]^{g_0}&&D'_1 \ar[ur]_{f'_1}}\]


Switch first and second
\[\xymatrix@C=15pt{L_2\ar[d]_{f'_0\circ c_1}&& K_2 \ar[d]_{\hat{k}_2}\ar[ll]_{l_2} \ar[r]^{r_2} & R_2 \ar@/^.35cm/[drrr]_(.4){e_0}|(.285)\hole \ar[dr]|(.28)\hole_{\hat{h}_2} && L_1 \ar@/_.35cm/[dlll]^(.4){e_1} \ar[dl]|(.28)\hole^{\hat{m}_1}& K_1 \ar[d]^{\hat{k}_1}\ar[l]_{l_1} \ar[r]^{r_1} & R_1 \ar@/^.35cm/[drrr]_(.4){t_0} \ar[dr]|(.28)\hole_{\hat{g}_1\circ c_0}   && L_0  \ar[dl]|(.28)\hole^{\hat{m}_0} \ar@/_.35cm/[dlll]^(.4){t_1}& K_0 \ar[d]^{\hat{k}_0}\ar[l]_{l_0} \ar[rr]^{r_0} && R_0 \ar[d]^{g_2\circ b_0} \\G_0 && \ar[ll]^{\hat{f}_0} \hat{D}_0 \ar[rr]_{\hat{g}_0}&& \hat{G}_1  && \ar[ll]^{\tilde{f}_1} \tilde{D}_1 \ar[rr]_{\tilde{g}_1}&& G'_2 && \ar[ll]^{f'_2} D'_2 \ar[rr]_{g'_2}&& G_3 }\]
Moreover
\[f_0\circ i_1=\hat{f}_0\circ e_1 \qquad h'_2=\tilde{g}_1\circ e_0\]
and $(t_0, t_1)$ is characterized using again well switchingness and the first $3$-steps Lemma as the unique arrows fitting in:
\[\xymatrix{&R_1 \ar[dl]_{a_0} \ar@{.>}[dr]^{t_0} \ar@/^.4cm/[dd]|\hole^(.6){c_0}\ar[d]_{t'_0}\\ D'_1 \ar[d]_{g'_1}&P\ar[d]_{p_3} \ar[r]^{p_4} \ar[l]_{p_1}&D'_2\ar[d]^{f'_2}\\G'_1&\hat{D}_1 \ar[l]^{\hat{f}_1}\ar[r]_{\hat{g}_1}& G'_2}\]



\[\xymatrix@R=15pt@C=15pt{&&L_ 0\ar[dl]^{a_1} \ar@/_1.2cm/[dddl]_(.4){d_1}|(.63)\hole\ar[dd]^{t'_1} \ar@{.>}[dr]^{t_1}\\&D'_0 \ar[dl]^(.4){g'_0}&&\tilde{D}_1 \ar[dr]^{\tilde{f}_1}\\G'_1 && S\ar[dr]_{s_4} \ar[ur]_{s_3}\ar[dl]^{s_1} \ar[ul]_{s_2}&&\hat{G}_1\\& \hat{D}_1 \ar[ul]^{\hat{f}_1}&&\hat{D}_0 \ar[ur]_{\hat{g}_0}}\]


SECOND SEQUENCE OF SWITCHINGS:

Switch third and second


\[\xymatrix@C=15pt{L_0\ar[d]_{m_0}&& K_0 \ar[d]_{k_0}\ar[ll]_{l_0} \ar[r]^{r_0} & R_0 \ar@/^.35cm/[drrr]_(.4){z_0}|(.285)\hole \ar[dr]|(.28)\hole_{h_0} && L_2 \ar@/_.35cm/[dlll]^(.4){z_1} \ar[dl]|(.28)\hole^{f_1\circ j_1}& K_2 \ar[d]^{\check{k}_2}\ar[l]_{l_2} \ar[r]^{r_2} & R_2 \ar[dr]|(.28)\hole_{\check{h}_2} \ar@/^.35cm/[drrr]_(.4){w_0}|(.285)\hole  && L_1 \ar@/_.35cm/[dlll]^(.4){w_1} \ar[dl]|(.28)\hole^{\check{m}_1}& K_1 \ar[d]^{\check{k}_1}\ar[l]_{l_1} \ar[rr]^{r_1} && R_1\ar[d]^{g_2\circ j_0} \\G_0 && \ar[ll]^{f_0} D_0 \ar[rr]_{g_0}&& G_1  && \ar[ll]^{\check{f}_1} \check{D}_1 \ar[rr]_{\check{g}_1}&& \check{G}_2 && \ar[ll]^{\check{f}_2} \check{D}_2 \ar[rr]_{\check{g}_2}&& G_3 }\]
Moreover
\[m_1=\check{f}_1\circ w_1 \qquad h_2=\check{g}_2\circ w_0\]

Switch second and first
\[\xymatrix@C=15pt{L_2\ar[d]_{f_0\circ z_1}&& K_2 \ar[d]_{\mathring{k}_2}\ar[ll]_{l_2} \ar[r]^{r_2} & R_2 \ar@/^.35cm/[drrr]_(.4){y_0}|(.285)\hole \ar[dr]|(.28)\hole_{\mathring{h}_2} && L_0 \ar@/_.35cm/[dlll]^(.4){y_1} \ar[dl]|(.28)\hole^{\check{m}_0}& K_0 \ar[d]^{\check{k}_0}\ar[l]_{l_0} \ar[r]^{r_0} & R_0 \ar[dr]|(.28)\hole_{\check{g}_1\circ z_0} \ar@/^.35cm/[drrr]_(.4){x_0}|(.285)\hole  && L_1 \ar@/_.35cm/[dlll]^(.4){x_1} \ar[dl]|(.28)\hole^{\check{m}_1}& K_1 \ar[d]^{\check{k}_1}\ar[l]_{l_1} \ar[rr]^{r_1} && R_1\ar[d]^{g_2\circ j_0} \\G_0 && \ar[ll]^{\check{f}_0} \check{D}_0 \ar[rr]_{\check{g}_0}&& \check{G}_1  && \ar[ll]^{\mathring{f}_1} \mathring{D}_1 \ar[rr]_{\mathring{g}_1}&& \check{G}_2 && \ar[ll]^{\check{f}_2} \check{D}_2 \ar[rr]_{\check{g}_2}&& G_3 }\]
As before we have
\[m_0=\check{f}_0\circ y_1 \qquad \check{h}_2=\mathring{g}_1\circ y_0\]
The really important thing to notice is that, by well switchingness we have
\begin{align*}
	f_0'\circ c_1 & =f'_0\circ q_3\circ c'_1 \\&=f_0\circ q_1\circ c'_1\\&=f_0\circ z_1
\end{align*}

\todo{GOOD! i primi match sono uguali, ora giochiamoci il primo lemma dei tre passi}

Switch second and third
\[\xymatrix@C=15pt{L_2\ar[d]_{f_0\circ z_1}&& K_2 \ar[d]_{\mathring{k}_2}\ar[ll]_{l_2} \ar[r]^{r_2} & R_2 \ar@/^.35cm/[drrr]_(.4){v_0}|(.285)\hole \ar[dr]|(.28)\hole_{\mathring{h}_2} && L_1 \ar@/_.35cm/[dlll]^(.4){v_1} \ar[dl]|(.28)\hole^{\mathring{f}_1 \circ x_1}& K_1 \ar[d]^{\mathring{k}_1}\ar[l]_{l_1} \ar[r]^{r_1} & R_1 \ar@/^.35cm/[drrr]_(.4){u_0}|(.285)\hole\ar[dr]_{\check{h}_1}   && L_0 \ar@/_.35cm/[dlll]^(.4){u_1} \ar[dl]^{\mathring{m}_0}& K_0 \ar[d]^{\mathring{k}_0}\ar[l]_{l_0} \ar[rr]^{r_0} && R_0\ar[d]^{\check{g}_2\circ x_0} \\G_0 && \ar[ll]^{\check{f}_0} \check{D}_0 \ar[rr]_{\check{g}_0}&& \check{G}_1  && \ar[ll]^{\bar{f}_1} \bar{D}_1 \ar[rr]_{\bar{g}_1}&& \bar{G}_2 && \ar[ll]^{\bar{f}_2} \bar{D}_2 \ar[rr]_{\bar{g}_2}&& G_3 }\]

\[\xymatrix@R=15pt@C=15pt{&&R_1 \ar@/_1.2cm/[dddl]_(.4){a_0}|(.63)\hole\ar[dl]^{j_0}\ar[dd]^{c'_0} \ar@{.>}[dr]^{c_0}\\&D_2 \ar[dl]^(.4){f_2}&&\hat{D}_1 \ar[dr]^{\hat{g}_1}\\G_2 && P\ar[dr]_{p_4} \ar[ur]_{p_3}\ar[dl]^{p_1} \ar[ul]^{p_2}&&G'_2\\& D'_1 \ar[ul]^{g'_1}&&D'_2 \ar[ur]_{f'_2}}\]

\[\xymatrix@R=15pt@C=15pt{&&L_1 \ar[dl]^{w_1} \ar@/_1.2cm/[dddl]_(.4){i_1}|(.63)\hole\ar[dd]^{v'_1} \ar@{.>}[dr]^{v_1}\\&\check{D}_1 \ar[dl]^(.4){\check{f}_1}&&\check{D}_0 \ar[dr]^{g'_0}\\G_1 && \check{Q}\ar[dr]_{\check{q}_4} \ar[ur]_{\check{q}_3}\ar[dl]^{\check{q}_1} \ar[ul]_{\check{q}_2}&&\check{G}_1\\& D_0 \ar[ul]^{g_0}&&\mathring{D}_1 \ar[ur]_{\check{f}_1}}\]




HUGE DIAGRAM


\[\xymatrix@C=15pt{
	& K_1 \ar[d]^{\hat{k}_1}\ar[l]_{l_1} \ar[r]^{r_1} & R_1 \ar@/^.35cm/[drrr]_(.4){t_0} \ar[dr]|(.28)\hole_{\hat{g}_1\circ c_0}   && L_0  \ar[dl]|(.28)\hole^{\hat{m}_0} \ar@/_.35cm/[dlll]^(.4){t_1}& K_0 \ar[d]^{\hat{k}_0}\ar[l]_{l_0} \ar[rr]^{r_0} && R_0 \ar[d]^{g_2\circ b_0} \\G_0 && \ar[ll]^{\hat{f}_0} \hat{D}_0 \ar[rr]_{\hat{g}_0}&& \hat{G}_1  && \ar[ll]^{\tilde{f}_1} \tilde{D}_1 \ar[rr]_{\tilde{g}_1}&& G'_2 && \ar[ll]^{f'_2} D'_2 \ar[rr]_{g'_2}&& G_3 \\
	L_2\ar[d]_{f_0\circ z_1} \ar[u]^{f'_0\circ c_1}&& K_2 \ar[d]_{\mathring{k}_2}\ar[ll]_{l_2} \ar[r]^{r_2} & R_2 \ar@/_.35cm/[urrr]^(.4){e_0}|(.285)\hole \ar[ur]|(.28)\hole^{\hat{h}_2} \ar@/^.35cm/[drrr]_(.4){v_0}|(.285)\hole \ar[dr]|(.28)\hole_{\mathring{h}_2} && L_1 \ar@/^.35cm/[ulll]_(.4){e_1} \ar[ul]|(.28)\hole_{\hat{m}_1} \ar@/_.35cm/[dlll]^(.4){v_1} \ar[dl]|(.28)\hole^{\mathring{f}_1 \circ x_1}& K_1 \ar[d]^{\mathring{k}_1}\ar[l]_{l_1} \ar[r]^{r_1} & R_1 \ar@/^.35cm/[drrr]_(.4){u_0}|(.285)\hole\ar[dr]_{\check{h}_1}   && L_0 \ar@/_.35cm/[dlll]^(.4){u_1} \ar[dl]^{\mathring{m}_0}& K_0 \ar[d]^{\mathring{k}_0}\ar[l]_{l_0} \ar[rr]^{r_0} && R_0\ar[d]^{\check{g}_2\circ x_0} \\G_0 && \ar[ll]^{\check{f}_0} \check{D}_0 \ar[rr]_{\check{g}_0}&& \check{G}_1  && \ar[ll]^{\bar{f}_1} \bar{D}_1 \ar[rr]_{\bar{g}_1}&& \bar{G}_2 && \ar[ll]^{\bar{f}_2} \bar{D}_2 \ar[rr]_{\bar{g}_2}&& G_3 }\]

Now, by determinism we have isomorphisms $\phi_{\check{D}_0}\colon \check{D}_0\to \hat{D}_0$ $\phi_{\check{G}_1}\colon \check{G}_1\to \hat{G}_1$
Notice that
\begin{align*}
	\hat{f}_0\circ \phi_{\check{D}_0}\circ v_1 & = \check{f}_0\circ v_1 \\&=\check{f}_0\circ \check{q}_3\circ v'_1\\&=f_0\circ \check{q}_1\circ v'_1\\&=f_0\circ i_1\\&=\hat{f}_0\circ e_1
\end{align*}

GOOD: $\phi_{\check{D}_0}$ sends $v_1$ to $e_1$, thus it respects the match of $L_1$. Automatically it sends $v_0$ to $e_0$.

CHECK THAT $\check{g}_2\circ x_0=g_2\circ j_0$

USO IL PRIMO LEMMA DEI TRE PASSI:

\[\xymatrix{&R_0 \ar[dl]_{i_0} \ar@{.>}[dr]^{x_0} \ar@/^.4cm/[dd]|\hole^(.6){j_0}\ar[d]_{x'_0}\\ D_1 \ar[d]_{g_1}&P'\ar[d]_{p'_3} \ar[r]^{p'_4} \ar[l]_{p'_1}&\check{D}_2\ar[d]^{\check{g}_2}\\G_2&D_2 \ar[l]^{f_2}\ar[r]_{g_2}& G_3}\]



\[\xymatrix@R=15pt@C=15pt{&&L_ 0\ar[dl]^{I_1} \ar@/_1.2cm/[dddl]_(.4){d_1}|(.63)\hole\ar[dd]^{t'_1} \ar@{.>}[dr]^{t_1}\\&D'_0 \ar[dl]^(.4){g'_0}&&\tilde{D}_1 \ar[dr]^{\tilde{f}_1}\\G'_1 && S\ar[dr]_{s_4} \ar[ur]_{s_3}\ar[dl]^{s_1} \ar[ul]_{s_2}&&\hat{G}_1\\& \hat{D}_1 \ar[ul]^{\hat{f}_1}&&\hat{D}_0 \ar[ur]_{\hat{g}_0}}\]
\end{proof}


\lemIndepGlobalLeft*
\label{lemIndepGlobalLeft-proof}

\begin{proof}
  As a preliminary step, we are going to use
  \Cref{def:filler,def:switch} to get some diagrams.  First of all,
  let $(v,v')$ be the filler between $\dder{D}_0$ and $\dder{D}_1$
  associated to $(i_0, i_1)$, then we have
  \[\xymatrix{&&R_0 \ar@/_1cm/[ddrr]_(.35){i_0}|(.7)\hole
  	\ar[dr]^{h_0}&& L_1\ar@/^1cm/[ddll]^(.35){i_1}
  	\ar[dl]_{m_1}\\&K_0\ar[dr]^{k_0}\ar[dl]_{l_0}
  	\ar@/_.8cm/[ddrr]|(.36)\hole^(.65){v}\ar[ur]^{r_0}&& G_1 &&
  	K_1
  	\ar@/^.8cm/[ddll]|(.36)\hole_(.65){v'}\ar[dl]_{k_1}\ar[lu]_{l_1}
  	\ar[dr]^{r_1}\\L_0
  	\ar@/_.8cm/[ddrr]_(.2){j_0}|(.31)\hole|(.81)\hole
  	\ar[dr]^(.4){m_0}|(.61)\hole && D_0
  	\ar[dl]|(.4)\hole_(.65){f_0}\ar[ur]|(.5)\hole^(.7){g_0}&&D_1
  	\ar[dr]|(.4)\hole^(.65){g_1}
  	\ar[ul]|(.5)\hole_(.65){f_1}&&R_1\ar@/^.8cm/[ddll]^(.2){j_1}|(.31)\hole|(.81)\hole\ar[dl]_{h_1}|(.6)\hole\\&G_0
  	&&P_1\ar[dr]_{q_1}
  	\ar[dl]^{q_0}\ar[ur]^(.4){p_1}\ar[ul]_(.4){p_0}&&G_2\\L_1
  	\ar@/^.8cm/[uurr]^(.2){i_1} \ar[ur]_(.35){f_0\circ
  		i_1}|(.61)\hole&&Q_0
  	\ar[ul]|(.4)\hole_(.65){s_0}\ar[dr]|(.5)\hole^(.65){t_0}
  	&&Q_1\ar[ur]|(.4)\hole^(.65){t_1} \ar[dl]|(.5)\hole_(.65){s_1}
  	&& R_0 \ar[ul]^(.35){g_1\circ
  		i_0}|(.61)\hole\ar@/_.8cm/[uull]_(.2){i_0}\\&K_1
  	\ar[ur]_{q_0\circ v'} \ar[dr]_{r_1}
  	\ar[ul]^{l_1}\ar@/^.8cm/[uurr]_(.65){v'}&&H'_1&& K_0
  	\ar[ur]_{r_0} \ar[ul]^{q_1\circ v} \ar[dl]^{l_0}
  	\ar@/_.8cm/[uull]^(.65){v}\\&& R_1
  	\ar[ur]_{\hspace{-5pt}s_1\circ
  		j_1}\ar@/^1cm/[uurr]^(.25){j_1}&& L_0 \ar[ul]^{t_0\circ
  		j_0\hspace{-5pt}} \ar@/_1cm/[uull]_(.25){j_0} |(.69)\hole
  }\]

  Secondly, the filler $(u,u')$ induced by $(a_0, a_1)$ between
  $\dder{D}_1$ and $\dder{D}_2$ yields:
  \[
    \xymatrix{&&R_1 \ar@/_1cm/[ddrr]_(.35){a_0}|(.7)\hole
      \ar[dr]^{h_1}&& L_2\ar@/^1cm/[ddll]^(.35){a_1}
      \ar[dl]_{m_2}\\&K_1\ar[dr]^{k_1}\ar[dl]_{l_1}
      \ar@/_.8cm/[ddrr]|(.36)\hole^(.65){u}\ar[ur]^{r_1}&& G_2 &&
      K_2
      \ar@/^.8cm/[ddll]|(.36)\hole_(.65){u'}\ar[dl]_{k_2}\ar[lu]_{l_2}
      \ar[dr]^{r_2}\\L_1
      \ar@/_.8cm/[ddrr]_(.2){b_0}|(.31)\hole|(.81)\hole
      \ar[dr]^(.4){m_1}|(.61)\hole && D_1
      \ar[dl]|(.4)\hole_(.65){f_1}\ar[ur]|(.5)\hole^(.7){g_1}&&D_2
      \ar[dr]|(.4)\hole^(.65){g_2}
      \ar[ul]|(.5)\hole_(.65){f_2}&&R_2\ar@/^.8cm/[ddll]^(.2){b_1}|(.31)\hole|(.81)\hole\ar[dl]_{h_2}\\&G_1
      &&P_2\ar[dr]_{d_1}
      \ar[dl]^{d_0}\ar[ur]^(.4){c_1}\ar[ul]_(.4){c_0}&&G_3\\L_2
      \ar@/^.8cm/[uurr]^(.2){a_1} \ar[ur]_(.35){f_1\circ
        a_1}|(.61)\hole&&Q_2
      \ar[ul]|(.4)\hole_(.65){x_1}\ar[dr]|(.5)\hole^(.65){y_1}
      &&Q_3\ar[ur]|(.4)\hole^(.65){y_2} \ar[dl]|(.5)\hole_(.65){x_2}
      && R_1 \ar[ul]^(.35){g_2\circ
        a_0}|(.61)\hole\ar@/_.8cm/[uull]_(.2){a_0}\\&K_2
      \ar[ur]_{d_0\circ u'} \ar[dr]_{r_2}
      \ar[ul]^{l_2}\ar@/^.8cm/[uurr]_(.65){u'}&&G'_2&& K_1
      \ar[ur]_{r_1} \ar[ul]^{d_1\circ u} \ar[dl]^{l_1}
      \ar@/_.8cm/[uull]^(.65){u}\\&& R_2
      \ar[ur]_{\hspace{-5pt}x_2\circ
        b_1}\ar@/^1cm/[uurr]^(.25){b_1}&& L_1 \ar[ul]^{y_1\circ
        b_0\hspace{-5pt}} \ar@/_1cm/[uull]_(.25){b_0} |(.69)\hole
    }\]


  Finally, the filler $(w,w')$ between $\dder{D}_0$ and
  $S_{a_0,a_1}(\dder{D}_2)$ given by $(e_0, e_1)$ provides us with:
  \[\xymatrix{&&R_0 \ar@/_1cm/[ddrr]_(.35){e_0}|(.7)\hole
      \ar[dr]^{h_0}&& L_2\ar@/^1cm/[ddll]^(.35){e_1}
      \ar[dl]_{f_1\circ a_1}\\&K_0\ar[dr]^{k_0}\ar[dl]_{l_0}
      \ar@/_.8cm/[ddrr]|(.36)\hole^(.65){w}\ar[ur]^{r_0}&& G_1 &&
      K_2 \ar@/^.8cm/[ddll]|(.36)\hole_(.65){w'}\ar[dl]_{d_0\circ
        u'\hspace{-5pt}}\ar[lu]_{l_2} \ar[dr]^{r_2}\\L_0
      \ar@/_.8cm/[ddrr]_(.2){o_0}|(.31)\hole|(.81)\hole
      \ar[dr]^(.4){m_0}|(.61)\hole && D_0
      \ar[dl]|(.4)\hole_(.65){f_0}\ar[ur]|(.5)\hole^(.7){g_0}&&Q_2
      \ar[dr]|(.4)\hole^(.65){y_1}
      \ar[ul]|(.5)\hole_(.65){x_1}&&R_2\ar@/^.8cm/[ddll]^(.2){o_1}|(.31)\hole|(.81)\hole\ar[dl]_(.35){x_2\circ
        b_1}\\&G_0 &&P_3\ar[dr]_{n_1}
      \ar[dl]^{n_0}\ar[ur]^(.4){u_1}\ar[ul]_(.4){u_0}&&G'_2\\L_2
      \ar@/^.8cm/[uurr]^(.2){e_1} \ar[ur]_(.35){f_0\circ
        e_1}|(.61)\hole&&Q_4
      \ar[ul]|(.4)\hole_(.65){z_0}\ar[dr]|(.5)\hole^(.65){z'_0}
      &&Q_5\ar[ur]|(.4)\hole^(.65){z'_1}
      \ar[dl]|(.5)\hole_(.65){z_1} && R_0 \ar[ul]^(.35){y_1\circ
        e_0}|(.61)\hole\ar@/_.8cm/[uull]_(.2){e_0}\\&K_2
      \ar[ur]_{n_0\circ w'} \ar[dr]_{r_2}
      \ar[ul]^{l_2}\ar@/^.8cm/[uurr]_(.65){w'}&&G'_1&& K_0
      \ar[ur]_{r_0} \ar[ul]^{n_1\circ w} \ar[dl]^{l_0}
      \ar@/_.8cm/[uull]^(.65){w}\\&& R_2
      \ar[ur]_{\hspace{-4pt}z_1\circ
        o_1}\ar@/^1cm/[uurr]^(.25){o_1}&& L_0 \ar[ul]^{z'_0\circ
        o_0\hspace{-5pt}} \ar@/_1cm/[uull]_(.25){o_0} |(.69)\hole
    }\]
  So equipped we can turn to the prove of our claims.
  \begin{enumerate}
  \item We have to construct the two dotted arrows in the diagram
    below.
    \[\xymatrix@C=15pt{L_0 \ar[d]_{z'_0\circ o_0}&& K_0
        \ar[d]_{n_1\circ w}\ar[ll]_{l_0} \ar[r]^{r_0} & R_0
        \ar@{.>}@/^.35cm/[drrr]_(.4){\beta_0}|(.285)\hole
        \ar[dr]|(.28)\hole_{y_1\circ e_0} && L_1
        \ar@{.>}@/_.35cm/[dlll]^(.4){\beta_1}
        \ar[dl]|(.28)\hole^{y_1\circ b_0}& K_1 \ar[d]^{d_1\circ
          u}\ar[l]_{l_1} \ar[rr]^{r_1} && R_1 \ar[d]^{g_2\circ
          a_1}\\G'_1 && \ar[ll]^{z_1} Q_5 \ar[rr]_{z'_1}&& G'_2 &&
        \ar[ll]^{x_2} Q_3 \ar[rr]_{y_2}&& G_3}\]

    Consider the arrows $i_0\colon R_0\to D_1$ and
    $e_0\colon R_0\to Q_2$. An easy computation shows that
    \begin{align*}
      f_1\circ i_0 & = h_0 \\&=x_1\circ e_0
    \end{align*}
    entailing the existence of the dotted
    $\beta'_0\colon R_0\to P_2$ in the diagram
    \[\xymatrix{R_0 \ar@{.>}[dr]^{\beta'_0} \ar@/^.3cm/[drr]^{i_0}
        \ar@/_.3cm/[ddr]_{e_0}\\ &P_2 \ar[r]^{c_1} \ar[d]_{d_0}& D_1
        \ar[d]^{f_1}\\ &Q_2\ar[r]_{x_1} & G_1}\]
    If we define $\beta_0\colon R_0\to Q_3$ as $d_1\circ \beta'_1$,
    then we easily get that
    \begin{align*}
      x_2\circ \beta_0 & =x_2\circ d_2\circ \beta'_0 \\&= y_1\circ d_0\circ \beta'_0\\&=y_1\circ e_0
    \end{align*}

    To define $\beta_1$, we proceed similarly. First consider
    $i_1\colon L_1\to D_0$ and $b_0\colon L_1 \to Q_2$ and notice
    that
    \begin{align*}
      g_0\circ i_1 & = m_1 \\&= x_1 \circ b_0
    \end{align*}
    implying the existence of $\beta'_1\colon L_1\to P_3$ fitting in
    the diagram below.
    \[\xymatrix{L_1 \ar@{.>}[dr]^{\beta'_1} \ar@/^.3cm/[drr]^{i_1}
        \ar@/_.3cm/[ddr]_{b_0}\\ &P_3 \ar[r]^{u_0} \ar[d]_{u_1}& D_0
        \ar[d]^{g_0}\\ &Q_2\ar[r]_{x_1} & G_1}\]
    Let $\beta_1\colon L_1\to Q_5$ be $n_1\circ \beta'_1$, then
    \begin{align*}
      z'_1 \circ \beta_1 & = z'_1 \circ n_1\circ \beta'_1 \\&=y_1\circ u_1\circ \beta'_1\\&=y_1\circ b_0
    \end{align*}
    Therefore, $(\beta_0, \beta_1)$ is the wanted independence pair.

  \item In addition to the three diagram above, we have a fourth one
    given by the filler $(\varphi_0, \varphi_1)$ associated to
    $(\alpha_0, \alpha_1)$.
    \[\xymatrix{&&R_0 \ar@/_1cm/[ddrr]_(.35){\alpha_0}|(.7)\hole \ar[dr]^{g_1\circ i_0}&& L_2\ar@/^1cm/[ddll]^(.35){\alpha_1}  \ar[dl]_{m_2}\\
        &K_0\ar[dr]^{\hspace{-4pt}q_1\circ v}\ar[dl]_{l_0} \ar@/_.8cm/[ddrr]|(.36)\hole^(.65){\varphi}\ar[ur]^{r_0}&& G_2 && K_2 \ar@/^.8cm/[ddll]|(.36)\hole_(.65){\varphi'}\ar[dl]_{k_2}\ar[lu]_{l_2} \ar[dr]^{r_2}\\
        L_0 \ar@/_.8cm/[ddrr]_(.2){\gamma_0}|(.31)\hole|(.81)\hole \ar[dr]^(.4){\hspace{-4pt}t_0\circ j_0}|(.61)\hole && Q_1 \ar[dl]|(.4)\hole_(.65){s_1}\ar[ur]|(.5)\hole^(.7){t_1}&&D_2 \ar[dr]|(.4)\hole^(.65){g_2} \ar[ul]|(.5)\hole_(.65){f_2}&&R_2\ar@/^.8cm/[ddll]^(.2){\gamma_1}|(.31)\hole|(.81)\hole\ar[dl]_(.35){h_2}\\&H'_1 &&P_4\ar[dr]_{\lambda_1} \ar[dl]^{\lambda_0}\ar[ur]^(.4){\zeta_1}\ar[ul]_(.4){\zeta_0}&&G_3\\
        L_2 \ar@/^.8cm/[uurr]^(.2){\alpha_1} \ar[ur]_(.35){s_1\circ
          \alpha_1}|(.61)\hole&&Q_6
        \ar[ul]|(.4)\hole_(.65){\xi_0}\ar[dr]|(.5)\hole^(.65){\xi'_0}
        &&Q_7\ar[ur]|(.4)\hole^(.65){\xi'_1}
        \ar[dl]|(.5)\hole_(.65){\xi_1} && R_0 \ar[ul]^(.35){g_2\circ
          \alpha_0}|(.61)\hole\ar@/_.8cm/[uull]_(.2){\alpha_0}\\&K_2
        \ar[ur]_{\lambda_0\circ \phi'} \ar[dr]_{r_2}
        \ar[ul]^{l_2}\ar@/^.8cm/[uurr]_(.65){\phi'}&&H'_2&& K_0
        \ar[ur]_{r_0} \ar[ul]^{\lambda_1\circ \phi} \ar[dl]^{l_0}
        \ar@/_.8cm/[uull]^(.65){\phi}\\&& R_2
        \ar[ur]_{\hspace{-4pt}\xi_1\circ
          \gamma_1}\ar@/^1cm/[uurr]^(.25){\gamma_1}&& L_0
        \ar[ul]^{\xi'_0\circ \gamma_0\hspace{-5pt}}
        \ar@/_1cm/[uull]_(.25){\gamma_0} |(.69)\hole }\]

    Our aim is to construct the dotted arrow in the following
    diagram.
    \[\xymatrix@C=15pt{L_1 \ar[d]_{f_0\circ i_0}&& K_1
        \ar[d]_{q_0\circ v'}\ar[ll]_{l_1} \ar[r]^{r_1} & R_1
        \ar@{.>}@/^.35cm/[drrr]_(.4){\epsilon_0}|(.285)\hole
        \ar[dr]|(.28)\hole_{s_1\circ j_1} && L_2
        \ar@{.>}@/_.35cm/[dlll]^(.4){\epsilon_1}
        \ar[dl]|(.28)\hole^{s_1\circ \alpha_1}& K_2
        \ar[d]^{\lambda_0\circ \phi'}\ar[l]_{l_2} \ar[rr]^{r_2} &&
        R_2 \ar[d]^{\xi_1\circ \gamma_1}\\G_0 && \ar[ll]^{s_0} Q_0
        \ar[rr]_{t_0}&& H'_1 && \ar[ll]^{\xi_0} Q_6
        \ar[rr]_{\xi'_0}&& H'_2}\]

    Let us start considering $j_1\colon R_1\to Q_1$ and
    $a_0\colon R_1\to D_2$. We have
    \begin{align*}
      f_2\circ a_0 & =h_1 \\&=t_1\circ j_1
    \end{align*}
    and thus we get an arrow $\epsilon'_0\colon R_1\to P_4$ which
    makes the diagram below commutative.
    \[\xymatrix{R_1 \ar@{.>}[dr]^{\epsilon'_0}
        \ar@/^.3cm/[drr]^{j_1} \ar@/_.3cm/[ddr]_{a_0}\\ &P_4
        \ar[r]^{\zeta_0} \ar[d]_{\zeta_1}& Q_1 \ar[d]^{t_1}\\
        &D_2\ar[r]_{f_2} & G_2}\]
    We can then define $\epsilon_0\colon R_1\to Q_6$ to be
    $\lambda_0\circ \epsilon'_0$. For such an arrow we have a chain
    of identities:
    \begin{align*}
      \xi_0\circ \epsilon_0 & =\xi_0\circ \lambda_0\circ \epsilon'_0 \\&=s_1\circ \zeta_0 \circ \epsilon'_0\\&=s_1\circ j_1
    \end{align*}

    Next, to define $\epsilon_1\colon L_2\to Q_0$ we take
    $e_1\colon L_2 \to D_0$ and $a_1\colon L_2\to D_1$. By
    definition we have $ g_0\circ e_1=f_1\circ a_1$, giving us the
    dotted arrow below
    \[\xymatrix{L_2 \ar@{.>}[dr]^{\epsilon'_1}
        \ar@/^.3cm/[drr]^{a_1} \ar@/_.3cm/[ddr]_{e_0}\\ &P_1
        \ar[r]^{p_1} \ar[d]_{p_0}& D_1 \ar[d]^{f_1}\\
        &D_0\ar[r]_{g_0} & G_1}\]
    Now, notice that
    \begin{align*}
      t_1\circ q_1\circ \epsilon'_1 & =g_1\circ p_1\circ \epsilon'_1 & =g_1\circ a_1 \\&=m_2
    \end{align*}
    Hence $(\alpha_0, q_1\circ \epsilon'_1)$ is an independence pair
    for $S_{i_0, i_1}(\dder{D}_0)$ and $\dder{D}_2$. By hypothesis
    $S_{i_0, i_1}(\dder{D}_0)\updownarrow_! \dder{D}_2$ and thus
    $q_1\circ \epsilon'_1$ must coincide with $\alpha_1$. Now, let
    $\epsilon_1\colon L_2\to Q_0$ be $q_0\circ
    \epsilon'_1$. Computing we get
    \begin{align*}
      t_0\circ \epsilon_1 & = t_0\circ q_0\circ \epsilon'_1 \\&=s_1\circ q_1\circ \epsilon'_1\\&=s_1\circ \alpha_1
    \end{align*}
    Allowing us to conclude that
    $S_{i_0,i_1}(\dder{D}_1)\updownarrow S_{\alpha_0,
      \alpha_1}(\dder{D}_2)$.  \qedhere
  \end{enumerate}
\end{proof}


We next prove some technical lemma which will be useful to show the
possibility of transforming a derivation into a switch equivalent one
by switching only step along inversions.



\begin{lemma}
  \label{le:switchA}
  Let $\der{D}_i$ for $i \in \interval[0]{n}$ be derivation sequences
  and consider a switching sequence consisting only of inversions
  \begin{center}
    $\der{D}_0 \shift{\nu_1} \der{D}_1 \shift{\nu_2} \ldots
    \shift{\nu_n} \der{D}_n$
  \end{center}
  Let $i \in \interval{n}$ be such that
  $\transp{i} \in \inv{\nu_{1,n}}$ and for all $k > i+1$ it holds
  $\nu_{1,n}(k) > \nu_{1,n}(i+1)$.  Then there is a switching sequence
  consisting only of inversions which starts with $\transp{i}$, i.e.,
  \begin{center}
    $\der{D}_0 \shift{\transp{i}} \der{D}_1' \shift{\nu_2'} \ldots
    \shift{\nu_n'} \der{D}_n$
  \end{center}
\end{lemma}

\begin{proof}
  We proceed by induction on $n$. If $n=1$, necessarily
  $\nu_1 =  \transp{i}$ and thus we are done.

  If $n>1$, let $\nu_1 = \transp{j}$.  We distinguish various case
  depending on how $\nu_1$ relates to $\transp{i}$.

  \bigskip
  \noindent
  (1) $j=i$\\
  %
  In this case there is nothing to prove: $\nu_1 = \transp{i}$, hence
  the original switching sequence is already of the desired shape.

  \bigskip
  \noindent
  (2) $j<i-1$ or $j>i-1$\\
  %
  In this case $\nu_1$ does not ``interfere'' with $\transp{i}$, i.e.,
  $i$ still satisfies the hypotheses of the lemma with respect to the
  switching sequence
  $\der{D}_1 \shift{\nu_2} \ldots \shift{\nu_n} \der{D}_n$.

  Hence we can apply the inductive hypothesis and derive the existence
  of a switching sequence
  \begin{center}
    $\der{D}_1 \shift{\transp{i}} \der{D}_2' \shift{\nu_3'} \ldots \shift{\nu_n'} \der{D}_n$
  \end{center}

  Recall that $\der{D}_0 \shift{\nu_1} \der{D}_1$ and, given the
  working assumption (ii), the switches $\nu_1$ and $\transp{i}$ can
  be done in reverse order, thus getting, as desired
  \begin{center}
    $\der{D}_0 \shift{\transp{i}} \der{D}_1' \shift{\nu_1} \ldots
    \shift{\nu_n'} \der{D}_n$
  \end{center}


  \bigskip
  \noindent
  (3) $j=i-1$, i.e., $\nu_1 = \transp{i-1}[i]$\\
  %
  In this case $\der{D}_1$ is obtained from $\der{D}_0$ by switching
  steps $i-1$ and $i$, as pictorially reported in the first two
  columns of Fig.~\ref{fi:switchA}. Since we are dealing with
  switching sequence consisting only of inversions and by hypothesis
  $\nu_{1,n}(i) > \nu_{1,n}(i+1)$, whence
  $\nu_{2,n}(i-1) > \nu_{2,n}(i+1)$, we deduce that necessarily
  $\nu_{2,n}(i) > \nu_{2,n}(i+1)$ and $\nu_{2,n}(k) > \nu_{2,n}(i+1)$
  for all $k > i+1$. Hence we can use the inductive hypothesis to
  deduce that the switching sequence from $\der{D}_1$ can start by
  switching $\transp{i}$, i.e., we obtain (see the third column in
  Fig.~\ref{fi:switchA})
  \begin{center}
    $\der{D}_1 \shift{\transp{i}} \der{D}_2' \shift{\nu_3'} \ldots
    \shift{\nu_n'} \der{D}_n$
  \end{center}

  Now, if we focus on $\der{D}_2'$ we observe that
  $\nu_{3,n}'(i-1) > \nu_{3,n}'(i)$ and
  $\nu_{3,n}'(k) > \nu_{3,n}'(i)$ for all $k > i$. Hence we can apply
  again the inductive hypothesis and get a switching sequence
    \begin{center}
    $\der{D}_2' \shift{\transp{i-1}[i]} \der{D}_3'' \shift{\nu_3''} \ldots
    \shift{\nu_n''} \der{D}_n$
  \end{center}
  as depicted in Fig.~~\ref{fi:switchA}, starting from the fourth column.

  By Lemma~\ref{lem:indep-global-left}(\ref{lem:indep-global-left:1})\todo{Check numbering} we can
  reorganize the first three switchings as

  \begin{center}
    $\der{D}_0 \shift{\transp{i}} \der{D}_1'''
    \shift{\transp{i-1}[i]} \der{D}_2'''
    \shift{\transp{i}} \der{D}_3''$
  \end{center}

  The fact that the three switchings above lead to $\der{D}_3''$ is a
  consequence of Lemma~\ref{lem:switch-confluence}.

  \bigskip

  Observe that it cannot be $j=i+1$, otherwise we would have
  $\nu_{1,n}(j+1) < \nu_{1,n}(i)$, contradicting the hypotheses. Thus
  this case does not need to be considered and the proof is completed.  
\end{proof}
 

\begin{figure}
  \centering
  \begin{tikzpicture}[font=\small]
    % Define arrow colors
    \def\colorA{green!60!black}
    \def\colorB{blue}
    \def\colorC{red!100}

    % Define the length of each line
    \def\vlen{5mm}
    \def\hlen{18mm}
    \def\gap{1mm}
    

    % First line D0 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Draw label on top of the line
    \node[above] at (0*\hlen,0) {$\der{D}_0$};
    \node[above] at (0.5*\hlen,0) {$\shift{\nu_1}$};

    % Draw the black part of the line
    \draw (0*\hlen,0) -- (0*\hlen,-2*\vlen+\gap);

    % Draw the first colored labeled arrow
    \draw[->, \colorA] (0*\hlen,-2*\vlen) -- (0*\hlen,-3*\vlen+\gap) node[midway, left] {$i-1$};
    % Draw the second colored labeled arrow
    \draw[->, \colorB] (0*\hlen,-3*\vlen) -- (0*\hlen,-4*\vlen+\gap) node[midway, left] {$i$};
    % Draw the third colored labeled arrow
    \draw[->, \colorC] (0*\hlen,-4*\vlen) -- (0*\hlen,-5*\vlen+\gap) node[midway, left] {$i+1$};
    % Draw the last black part of the line
    \draw (0*\hlen,-5*\vlen) -- (0*\hlen,-7*\vlen);
    
    % Second line D1 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Draw label on top of the line
    \node[above] at (1*\hlen,0) {$\der{D}_1$};
    \node[above] at (1.5*\hlen,0) {$\shift{\transp{i}}$};

    % Draw the black part of the line
    \draw (1*\hlen,0) -- (1*\hlen,-2*\vlen+\gap);

    % Draw the first colored labeled arrow
    \draw[->, \colorB] (1*\hlen,-2*\vlen) -- (1*\hlen,-3*\vlen+\gap) node[midway, left] {};
    % Draw the second colored labeled arrow
    \draw[->, \colorA] (1*\hlen,-3*\vlen) -- (1*\hlen,-4*\vlen+\gap) node[midway, left] {};
    % Draw the third colored labeled arrow
    \draw[->, \colorC] (1*\hlen,-4*\vlen) -- (1*\hlen,-5*\vlen+\gap) node[midway, left] {};
    % Draw the last black part of the line
    \draw (1*\hlen,-5*\vlen) -- (1*\hlen,-7*\vlen);

    % Repeat similar patterns for the third and fourth lines
    
    % Third line: d2 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \node[above] at (2*\hlen,0) {$\der{D}_2'$};
    \node[above] at (2.5*\hlen,0) {$\shift{\transp{i-1}[i]}$};
 
    \draw (2*\hlen,0) -- (2*\hlen,-2*\vlen+\gap);
    
    \draw[->, \colorB] (2*\hlen,-2*\vlen) -- (2*\hlen,-3*\vlen+\gap) node[midway, left] {};
    \draw[->, \colorC] (2*\hlen,-3*\vlen) -- (2*\hlen,-4*\vlen+\gap) node[midway, left] {};
    \draw[->, \colorA] (2*\hlen,-4*\vlen) -- (2*\hlen,-5*\vlen+\gap) node[midway, left] {};
    \draw (2*\hlen,-5*\vlen) -- (2*\hlen,-7*\vlen);

    % Fourth line %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \node[above] at (3*\hlen,0) {$\der{D}_3''$};
    \node[above] at (3.5*\hlen,0) {$\shift{\nu_3''}$};

    \draw (3*\hlen,0) -- (3*\hlen,-2*\vlen+\gap);
    \draw[->, \colorC] (3*\hlen,-2*\vlen) -- (3*\hlen,-3*\vlen+\gap) node[midway, left] {};
    \draw[->, \colorB] (3*\hlen,-3*\vlen) -- (3*\hlen,-4*\vlen+\gap) node[midway, left] {};
    \draw[->, \colorA] (3*\hlen,-4*\vlen) -- (3*\hlen,-5*\vlen+\gap) node[midway, left] {};
    \draw (3*\hlen,-5*\vlen) -- (3*\hlen,-7*\vlen);
  
    % Dots after the last line
    \draw (4*\hlen,0*\vlen) node[above] {$\dots$};

    % Last line %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \node[above] at (5*\hlen,0) {$\der{D}_n$};
    \node[above] at (4.5*\hlen,0) {$\shift{\nu_{n-1}}$};

  \end{tikzpicture}
  \caption{Picture for the proof of Lemma~\ref{le:switchingsA}}
  \label{fi:switchA}
\end{figure}


\begin{remark}
  \label{rem:switchA}
  Observe that given a switching sequence as in the lemma above
  $\der{D}_0 \shift{\nu_1} \der{D}_1 \shift{\nu_2} \ldots
  \shift{\nu_n} \der{D}_n$, if we consider the inversion with largest index:
  \begin{center}
    $k = \max \{j \mid \transp{j} \in \inv{\nu_{1,n}}\}$
  \end{center}
  then it satisfies the hypotheses of the lemma.
\end{remark}

\begin{lemma}
  \label{le:switchB}
  Let $\der{D}_i$ for $i \in \interval[0]{n}$ be derivation sequences
  and consider a switching sequence consisting only of inversions
  \begin{center}
    $\der{D}_0 \shift{\nu_1} \der{D}_1 \shift{\nu_2} \ldots
    \shift{\nu_n} \der{D}_n$
  \end{center}
  Let $i \in \interval{n}$ be such that
  $\transp{i} \in \inv{\nu_{1,n}}$ and assume that steps $i$ and $i+1$ in $\der{D}_0$ are sequential independent. Then there is a switching sequence
  consisting only of inversions which starts with $\transp{i}$, i.e.,
  \begin{center}
    $\der{D}_0 \shift{\transp{i}} \der{D}_1' \shift{\nu_2'} \ldots
    \shift{\nu_n'} \der{D}_n$
  \end{center}
\end{lemma}

\begin{proof}
  We proceed by induction on $n$. If $n=1$, necessarily
  $\nu_1 =  \transp{i}$ and thus we are done.

  If $n>1$, take $k = \max \{j \mid \transp{j} \in \inv{\nu_{1,n}}\}$, which,
  as observed in Remark~\ref{rem:switchA}, satisfies the hypotheses of
  Lemma~\ref{le:switchA}. Hence, by the mentioned lemma, we can start
  the switching sequence with the transposition $\transp{k}$, thus
  obtaining:
  \begin{center}
    $\der{D}_0 \shift{\transp{k}} \der{D}_1' \shift{\nu_2'} \ldots
    \shift{\nu_n'} \der{D}_n$
  \end{center}

  Moreover, since $\transp{i}$ is an inversion, we have that
  $\i \leq k$.  We distinguish various case depending on how $k$
  relates to $i$.

  \bigskip
  \noindent
  (i) $j=i$\\
  %
  In this case we are done: $\nu_1' = \transp{i}$, hence we obtained a
  switching sequence of the desired shape.

  \bigskip
  \noindent
  (ii) $k > i+1$\\
  %
  In this case the switching $\transp{k}$ does not ``interfere'' with
  $\transp{i}$, , as depicted in Fig.~\ref{fi:switchB1} (first two
  columns).

  Hence if we focus on
  \begin{center}
    $\der{D}_1' \shift{\nu_2'} \ldots
    \shift{\nu_n'} \der{D}_n$
  \end{center}
  we can observe that
  $\nu_{2,n}'(i)=\nu_{1,n}(i) > \nu_{1,n}(i+1)=\nu_{2,n}'(i+1)$.
  %
  Thus we can use the inductive hypothesis and obtain (see
  Fig.~\ref{fi:switchB1}, third column):
  \begin{center}
    $\der{D}_1' \shift{\transp{i}} \der{D}_2'' \shift{\nu_3''} \ldots
    \shift{\nu_n''} \der{D}_n$
  \end{center}

\begin{figure}
  \centering
  \begin{tikzpicture}[font=\small]
    % Define arrow colors
    \def\colorA{red!100}
    \def\colorB{blue}
    \def\colorC{green!60!black}
    \def\colorD{orange!60!black}

    % Define the length of each line
    \def\vlen{5mm}
    \def\hlen{20mm}
    \def\gap{1mm}
    

    % First line D0 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Draw label on top of the line
    \node[above] at (0*\hlen,0) {$\der{D}_0$};
    \node[above] at (0.5*\hlen,0) {$\shift{\transp{k}}$};

    % Draw the black part of the line
    \draw (0*\hlen,0) -- (0*\hlen,-1*\vlen+\gap);

    % Draw the first colored labeled arrow
    \draw[->, \colorA] (0*\hlen,-1*\vlen) -- (0*\hlen,-2*\vlen+\gap) node[midway, left] {$i$};
    % Draw the second colored labeled arrow
    \draw[->, \colorB] (0*\hlen,-2*\vlen) -- (0*\hlen,-3*\vlen+\gap) node[midway, left] {$i+1$};
    % Draw the second black part of the line
    \draw (0*\hlen,-3*\vlen) -- (0*\hlen,-4*\vlen+\gap);

    % Draw the third colored labeled arrow
    \draw[->, \colorC] (0*\hlen,-4*\vlen) -- (0*\hlen,-5*\vlen+\gap) node[midway, left] {$k$};
    % Draw the fourth colored labeled arrow
    \draw[->, \colorD] (0*\hlen,-5*\vlen) -- (0*\hlen,-6*\vlen+\gap) node[midway, left] {$k+1$};
    % Draw the last black part of the line
    \draw (0*\hlen,-6*\vlen) -- (0*\hlen,-7*\vlen);

    % Second line D1 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Draw label on top of the line
    \node[above] at (1*\hlen,0) {$\der{D}_1'$};
    \node[above] at (1.5*\hlen,0) {$\shift{\nu_2'}$};

    % Draw the black part of the line
    \draw (1*\hlen,0) -- (1*\hlen,-1*\vlen+\gap);

    % Draw the first colored labeled arrow
    \draw[->, \colorA] (1*\hlen,-1*\vlen) -- (1*\hlen,-2*\vlen+\gap) node[midway, left] {};
    % Draw the second colored labeled arrow
    \draw[->, \colorB] (1*\hlen,-2*\vlen) -- (1*\hlen,-3*\vlen+\gap) node[midway, left] {};
    % Draw the second black part of the line
    \draw (1*\hlen,-3*\vlen) -- (1*\hlen,-4*\vlen+\gap);

    % Draw the third colored labeled arrow
    \draw[->, \colorD] (1*\hlen,-4*\vlen) -- (1*\hlen,-5*\vlen+\gap) node[midway, left] {};
    % Draw the fourth colored labeled arrow
    \draw[->, \colorC] (1*\hlen,-5*\vlen) -- (1*\hlen,-6*\vlen+\gap) node[midway, left] {};
    % Draw the last black part of the line
    \draw (1*\hlen,-6*\vlen) -- (1*\hlen,-7*\vlen);


    % Third line D2 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Draw label on top of the line
    \node[above] at (2*\hlen,0) {$\der{D}_2''$};
    \node[above] at (2.5*\hlen,0) {$\shift{\nu_3''}$};

    % Draw the black part of the line
    \draw (2*\hlen,0) -- (2*\hlen,-1*\vlen+\gap);

    % Draw the first colored labeled arrow
    \draw[->, \colorB] (2*\hlen,-1*\vlen) -- (2*\hlen,-2*\vlen+\gap) node[midway, left] {};
    % Draw the second colored labeled arrow
    \draw[->, \colorA] (2*\hlen,-2*\vlen) -- (2*\hlen,-3*\vlen+\gap) node[midway, left] {};
    % Draw the second black part of the line
    \draw (2*\hlen,-3*\vlen) -- (2*\hlen,-4*\vlen+\gap);

    % Draw the third colored labeled arrow
    \draw[->, \colorC] (2*\hlen,-4*\vlen) -- (2*\hlen,-5*\vlen+\gap) node[midway, left] {};
    % Draw the fourth colored labeled arrow
    \draw[->, \colorD] (2*\hlen,-5*\vlen) -- (2*\hlen,-6*\vlen+\gap) node[midway, left] {};
    % Draw the last black part of the line
    \draw (2*\hlen,-6*\vlen) -- (2*\hlen,-7*\vlen);
    
    % Dots after the last line
    \draw (3*\hlen,0*\vlen) node[above] {$\dots$};

    % Last line %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \node[above] at (4*\hlen,0) {$\der{D}_n$};
    \node[above] at (3.5*\hlen,0) {$\shift{\nu_{n-1}''}$};

  \end{tikzpicture}
  \caption{Picture for the proof of Lemma~\ref{le:switchB}, item (ii)}
  \label{fi:switchB1}
\end{figure}

  
  Now, since $k>i+1$, the switchings $\transp{i}$ and $\transp{k}$ can
  be performed in reverse order and thus we obtain
  \begin{center}
    $\der{D}_0 \shift{\transp{i}} \der{D}_1'' \shift{\transp{k}}
    \der{D}_2'' \shift{\nu_3''} \ldots \shift{\nu_n''} \der{D}_n$
  \end{center}
  as desired.

  \bigskip
  \noindent
  (iii) $k = i+1$\\
  %
  The situation is depicted in Fig.~\ref{fi:switchB2}. In
  $\der{D}_1'$, by the choice of $k$ and the fact that all $\nu_i$ are
  inversions, one can deduce that $i$ satisfies the hyp[otheses of
  Lemma~\ref{le:switchA}. Hence we obatain (see Fig.~\ref{fi:switchB2}, first two coulmns):
  \begin{center}
    $\der{D}_1' \shift{\transp{i}} \der{D}_2'' \shift{\nu_2''}
    \der{D}_3'' \shift{\nu_4''} \ldots \shift{\nu_n''} \der{D}_n$
  \end{center}

  Since in $\der{D}_0$ steps in positions $i$ and $i+1$ are sequential
  independent, we can use
  Lemma~\ref{lem:indep-global-left}(\ref{lem:indep-global-left:1})\todo{Check
    numbering}, we have that the corresponding steps in positions
  $i+1$ and $i+2$ in $\der{D}_2''$ are stil sequential
  independent. Hence, we can use the inductive hypothesis on
  $\der{D}_2''$ and deduce the existence of a switching sequence where
  $\transp{i+1}[i+2]$ can be switched first, i.e., we obtain (see
  Fig.~\ref{fi:switchB2}, third coulmn):
  \begin{center}
    $\der{D}_2'' \shift{\transp{i+1}[i+2]}
    \der{D}_3''' \shift{\nu_4'''} \ldots \shift{\nu_n'''} \der{D}_n$
  \end{center}
  
  Putting things together, we obtain
  \begin{center}
    $\der{D}_0 \shift{\transp{i+1}[i+2]} \der{D}_1' \shift{\transp{i}}
    \der{D}_2'' \shift{\transp{i+1}[i+2]} \der{D}_3''' \shift{\nu_4'''}\ldots \shift{\nu_n'''} \der{D}_n$
  \end{center}
  Since we additionally know that in $\der{D}_0$ the steps $i$ and
  $i+1$ are sequentially independent, we can use
  Lemma~\ref{lem:indep-global-left}(\ref{lem:indep-global-left:2})\todo{Check numbering} to
  reorder the first three switchings, obtaining:
  \begin{center}
    $\der{D}_0 \shift{\transp{i}} \der{D}_1' \shift{\transp{i+1}[i+2]}
    \der{D}_2'' \shift{\transp{i}} \der{D}_3''' \shift{\nu_4'''}\ldots \shift{\nu_n'''} \der{D}_n$
  \end{center}
  as desired.  The fact that the three switchings above lead to
  $\der{D}_3'''$ is a consequence of Lemma~\ref{lem:switch-confluence}.
\end{proof}


\begin{figure}
  \centering
  \begin{tikzpicture}[font=\small]
    % Define arrow colors
    \def\colorA{red!100}
    \def\colorB{blue}
    \def\colorC{green!60!black}

    % Define the length of each line
    \def\vlen{5mm}
    \def\hlen{22mm}
    \def\gap{1mm}
    

    % First line D0 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Draw label on top of the line
    \node[above] at (0*\hlen,0) {$\der{D}_0$};
    \node[above] at (0.5*\hlen,0) {$\shift{\transp{i+1}[i+2]}$};

    % Draw the black part of the line
    \draw (0*\hlen,0) -- (0*\hlen,-2*\vlen+\gap);

    % Draw the first colored labeled arrow
    \draw[->, \colorA] (0*\hlen,-2*\vlen) -- (0*\hlen,-3*\vlen+\gap) node[midway, left] {$i$};
    % Draw the second colored labeled arrow
    \draw[->, \colorB] (0*\hlen,-3*\vlen) -- (0*\hlen,-4*\vlen+\gap) node[midway, left] {$k=i+1$};
    % Draw the third colored labeled arrow
    \draw[->, \colorC] (0*\hlen,-4*\vlen) -- (0*\hlen,-5*\vlen+\gap) node[midway, left] {$i+2$};
    % Draw the last black part of the line
    \draw (0*\hlen,-5*\vlen) -- (0*\hlen,-7*\vlen);
    
    % Second line D1 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Draw label on top of the line
    \node[above] at (1*\hlen,0) {$\der{D}_1'$};
    \node[above] at (1.5*\hlen,0) {$\shift{\transp{i}}$};

    % Draw the black part of the line
    \draw (1*\hlen,0) -- (1*\hlen,-2*\vlen+\gap);

    % Draw the first colored labeled arrow
    \draw[->, \colorA] (1*\hlen,-2*\vlen) -- (1*\hlen,-3*\vlen+\gap) node[midway, left] {};
    % Draw the second colored labeled arrow
    \draw[->, \colorC] (1*\hlen,-3*\vlen) -- (1*\hlen,-4*\vlen+\gap) node[midway, left] {};
    % Draw the third colored labeled arrow
    \draw[->, \colorB] (1*\hlen,-4*\vlen) -- (1*\hlen,-5*\vlen+\gap) node[midway, left] {};
    % Draw the last black part of the line
    \draw (1*\hlen,-5*\vlen) -- (1*\hlen,-7*\vlen);

    % Repeat similar patterns for the third and fourth lines
    
    % Third line: d2 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \node[above] at (2*\hlen,0) {$\der{D}_2''$};
    \node[above] at (2.5*\hlen,0) {$\shift{\transp{i+1}[i+2]}$};
 
    \draw (2*\hlen,0) -- (2*\hlen,-2*\vlen+\gap);
    
    \draw[->, \colorC] (2*\hlen,-2*\vlen) -- (2*\hlen,-3*\vlen+\gap) node[midway, left] {};
    \draw[->, \colorA] (2*\hlen,-3*\vlen) -- (2*\hlen,-4*\vlen+\gap) node[midway, left] {};
    \draw[->, \colorB] (2*\hlen,-4*\vlen) -- (2*\hlen,-5*\vlen+\gap) node[midway, left] {};
    \draw (2*\hlen,-5*\vlen) -- (2*\hlen,-7*\vlen);

    % Fourth line %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \node[above] at (3*\hlen,0) {$\der{D}_3'''$};
    \node[above] at (3.5*\hlen,0) {$\shift{\nu_3'''}$};

    \draw (3*\hlen,0) -- (3*\hlen,-2*\vlen+\gap);
    \draw[->, \colorC] (3*\hlen,-2*\vlen) -- (3*\hlen,-3*\vlen+\gap) node[midway, left] {};
    \draw[->, \colorB] (3*\hlen,-3*\vlen) -- (3*\hlen,-4*\vlen+\gap) node[midway, left] {};
    \draw[->, \colorA] (3*\hlen,-4*\vlen) -- (3*\hlen,-5*\vlen+\gap) node[midway, left] {};
    \draw (3*\hlen,-5*\vlen) -- (3*\hlen,-7*\vlen);

    % Dots after the last line
    \draw (4*\hlen,0*\vlen) node[above] {$\dots$};

    % Last line %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    \node[above] at (5*\hlen,0) {$\der{D}_n$};
    \node[above] at (4.5*\hlen,0) {$\shift{\nu_{n-1}'''}$};

  \end{tikzpicture}
  \caption{Picture for the proof of Lemma~\ref{le:switchB} (item (iii))}
  \label{fi:switchB2}
\end{figure}

The next lemma intuitively states that if we have a switching sequence
where the first switch is applied to $\transp{i}$ and the last one
reverses the same switch, then, assuming that in the middle there are
only inversions, we can strip the first and last switches.

\begin{lemma}
  \label{le:switchC}
  Let $\der{D}_i$ for $i \in \interval[0]{n+1}$ be derivation sequences
  and consider a switching sequence
  \begin{center}
    $\der{D}_0 \shift{\nu_0} \der{D}_1 \shift{\nu_1} \ldots
     \der{D}_n \shift{\nu_n} \der{D}_{n+1}$
  \end{center}
  Assume that the subsequence starting from $\der{D}_1$ consists of
  inversions and $\nu_0=\transp{i}$ while
  $\nu_n = \transp{\nu_{1,n}(i)}$.  Then there is shorter switching sequence
  consisting only of inversions:
  \begin{center}
    $\der{D}_0 \shift{\nu_2'} \der{D}_3' \shift{\nu_3'} \ldots
    \shift{\nu_{n-1}'} \der{D}_n'$
  \end{center}
\end{lemma}

\begin{proof}
  Just observe that in $\der{D}_1$ the steps of position $i$ and $i+1$
  are sequential independent and $\nu_{1,n}(i) >
  \nu_{1,n}(i+1)$. Hence we can use Lemma~\ref{le:switchB} and obtain
  a switching sequence from $\der{D}_1$ where $\transp{i}$ is
  performed first, hence we obtain:
  \begin{center}
    $\der{D}_0 \shift{\transp{i}}
    \der{D}_1 \shift{\transp{i}}
    \der{D}_2' \shift{\nu_2'} \ldots
    \shift{\nu_n'} \der{D}_{n+1}$
  \end{center}

  Now, since switchings $\transp{i}$ twice one obtains a derivation
  which is abstraction equivalent to the starting one. Hence we can
  assume without loss of generality that $\der{D}_2'$ coincides with
  $\der{D}_0$. Hence we have
  \begin{center}
    $\der{D}_0 =
    \der{D}_2' \shift{\nu_2'} \ldots
    \shift{\nu_n'} \der{D}_{n+1}$
  \end{center}
  as desired.
\end{proof}


\begin{lemma}
  \label{le:switchD}
  Let $\der{D}_i$ for $i \in \interval[0]{n+1}$ be derivation sequences
  and consider a switching sequence
  \begin{center}
    $\der{D}_0 \shift{\nu_1} \der{D}_1 \shift{\nu_2} \ldots
    \shift{\nu_n}\der{D}_n$
  \end{center}
  If the switching sequence does not consists only of inversions,
  there is a shorter switching sequence relating $\der{D}_0$ and
  $\der{D}_0$.
\end{lemma}

\begin{proof}
  Take a maximal subsequence
  $\der{D}_i \shift{\nu_{i+1}} \der{D}_{i+1} \shift{\nu_{i+2}} \ldots
  \shift{\nu_j}\der{D}_j$ consisting only of inversions.
  %
  If $i=0$ and $j=n$, there is nothing to show. Hence assume that
  $i>0$ and consider the sequence
  \begin{center}
    $\der{D}_{i-1} \shift{\nu_{i}} \der{D}_{i} \shift{\nu_{i+1}} \ldots
    \shift{\nu_j}\der{D}_j$
  \end{center}
  Then, by maximality, if $\nu_{i-1}=\transp{k}$ it must hold that
  $\nu_{j}=\transp{\nu_{i,j}(i)}$. Then, by Lemma~\ref{le:switchC},
  the switching sequence from $\der{D}_{i-1}$ to $\der{D}_{j}$ can be
  shortened by $2$:
  \begin{center}
    $\der{D}_{i-1} = \der{D}_{i+1}' \shift{\nu_{i+1}'} \ldots
    \shift{\nu_j'}\der{D}_j$
  \end{center}
  and thus the same applies to the original switching sequence.
\end{proof}



\thNoNeed*
\label{thNoNeed-proof}


\begin{proof}
  Let $\der{D} \shifteq \der{D}'$. Then there is there is a switching
  sequence
  \begin{center}
    $\der{D} = \der{D}_0 \shift{\nu_1} \der{D}_1 \shift{\nu_2} \ldots
    \shift{\nu_n} \der{D}_n=\der{D}'$
  \end{center}
  If it does not consist only of inversions, by Lemma~\ref{le:switchD}
  we can reduce its length by $2$. An inductive reasoning allows us to
  conclude.
\end{proof}


\coCanonical*
\label{coCanonical-proof}

\begin{proof}
  Immediate consequence of Theorem~\ref{th:no-need} and Lemma~\ref{le:switchA}.
\end{proof}

\end{document}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
