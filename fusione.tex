 %(query-replace-regexp "\\\\sqsubseteq^{sh}_{\\([^}]*\\)}" "\\\\shiftpre[\\1]")
% --- LNCS ---'
\documentclass{article}

\usepackage{hyperref}
\usepackage[textsize=tiny]{todonotes}
\usepackage{etex}

\usepackage[all]{xy}
\SelectTips{cm}{}
% derivations and labels
\usepackage{proof}
\newcommand{\lab}[1]{\ensuremath{\mathsf{{#1}}}}
\newcommand{\slab}[1]{\ensuremath{\scriptstyle{\mathsf{{#1}}}}}

% ``boxed'' \infer command
\newcommand{\binfer}[3][]{
  \mbox{\infer[#1]{#2}{#3}}}

% Command for labels on the left side of the rule
%       \inferL{<name>}{<post>}{<pre>}
% generates:
%             <pre>
%      <name> ------
%             <post>
%
\newlength{\myheight}
\newcommand{\inferL}[3]
  {\settoheight{\myheight}{\mbox{${#2}$}}
   \raisebox{\myheight}{{#1}}
   \makebox[1mm]{}
   \mbox{\infer{#2}{#3}}
}

\usepackage{amssymb,graphicx,epsfig,color}
%\usepackage[scriptsize]{subfigure}
\usepackage{subcaption}
\usepackage{wrapfig}

% re-stating 
%\usepackage{thm-restate}

% showing labels
%\usepackage[inline]{showlabels}

\usepackage{pgf}
\usepackage{tikz}
\usepackage{tikz-cd}
\usetikzlibrary{arrows,shapes,snakes,automata,backgrounds,petri,fit,positioning}
\tikzstyle{node}=[circle, draw=black, minimum size=1mm]
\tikzstyle{trans}=[font=\scriptsize]
\tikzstyle{lab}=[font=\small]


\newcommand{\pgfBox}{
  \begin{pgfonlayer}{background} 
    \fill[blue!2,thick,draw=black!50,rounded corners,inner sep=3mm] ([xshift=-1.5pt,yshift=-1.5pt]current bounding box.south west) rectangle ([xshift=1.5pt,yshift=1.5pt]current bounding box.north east);
  \end{pgfonlayer}
}



\newcommand{\Rrel}[1]   {\stackrel{{#1}}{\Longrightarrow}}
\newcommand{\oa}{\overline a}
\newcommand{\ob}{\overline b}
\newcommand{\oc}{\overline c}
\newcommand{\od}{\overline d}
\newcommand{\nil}{{\tt 0}}
\newcommand{\rec}{\emph{rec}}
\newcommand{\fn}[1]{{\mathtt{fn}}(#1)}
%\usepackage{latexsym}
\usepackage{stmaryrd}
\def\encodep#1{\llfloor#1\rrfloor}

\newcommand{\cat}[1]{\ensuremath{\mathbf{#1}}}

\newcommand{\dpo}{\textsc{dpo}}

% base classes of categories for adhesive and quasi adhesive case
\newcommand{\bAdh}{\ensuremath{\mathbb{B}}}
\newcommand{\bQAdh}{\ensuremath{\mathbb{QB}}}

%from pawel
\usepackage[latin1]{inputenc}
\usepackage{amsmath}

\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{enumerate}
\usepackage{xspace}
\usepackage{amsfonts}
\usepackage{mathrsfs}
\usepackage{cite}
\usepackage{float}
\usepackage{fancybox}

\usepackage{cleveref}


%\spnewtheorem*{notation}{Notation}{\bfseries}{\rmfamily}

%%%%%%%% MATHEMATICAL NOTATION %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%symbol for natural numbers
\newcommand{\nat}{\ensuremath{\mathbb{N}}}

% finite subset
\newcommand{\sfin}{\ensuremath{\subseteq_{\mathit{fin}}}}

% flattening of a multiset
\newcommand{\flt}[1]{\ensuremath{[\![{#1}]\!]}}

% compact elements
\newcommand{\compact}[1]{\ensuremath{\mathop{\mathsf{K}({#1})}}}

% principal ideal
\newcommand{\principal}[1]{\ensuremath{\mathop{\downarrow\!{#1}}}}

% ideal completion
\newcommand{\ideal}[1]{\ensuremath{\mathsf{Idl}({#1})}}

% complete prime elements
\newcommand{\pr}[1]{\ensuremath{\mathop{\mathit{pr}({#1})}}}
\newcommand{\wpr}[1]{\ensuremath{\mathop{\mathit{wpr}({#1})}}}

% irreducible elements
\newcommand{\ir}[1]{\ensuremath{\mathop{\mathit{ir}({#1})}}}

% difference of irreducible elements
\newcommand{\diff}[2]{\ensuremath{\delta({#1},{#2})}}

% immediate precedence

% abbreviation for event structure
% \newcommand{\esabbr}{event structure}
\newcommand{\esabbr}{\textsc{es}}
\newcommand{\esnabbr}{\textsc{esnb}}
\newcommand{\esnmabbr}{\textsc{esn}}
\newcommand{\eseqabbr}{\textsc{epes}}

% predecessor of an irreducible
\newcommand{\pred}[1]{\ensuremath{\mathit{p}({#1})}}

% irreducible elements in es domains
\newcommand{\esir}[2]{\ensuremath{\langle{#1}, {#2}\rangle}}

% equivalence classes [of irreducibles]
\newcommand{\eqclass}[2][]{\ensuremath{[{#2}]_{\scriptscriptstyle {#1}}}}
% union of the equivalence classes of the elements in a set
\newcommand{\eqclasscup}[2]{\ensuremath{{#2}_{\scriptscriptstyle {#1}}}}

\newcommand{\eqclassir}[1]{\ensuremath{\eqclass[\leftrightarrow^*]{#1}}}

% quotient of set wrt a relation
\newcommand{\quotient}[2]{\ensuremath{{#1}_{\scriptscriptstyle {#2}}}}

% category of event structures 
\newcommand{\es}{\ensuremath{\mathsf{ES}}}
% category of stable event structures 
\newcommand{\ses}{\ensuremath{\mathsf{sES}}}
% category of prime event structures 
\newcommand{\pes}{\ensuremath{\mathsf{pES}}}
% category of prime event structures with equivalence
\newcommand{\epes}{\ensuremath{\mathsf{epES}}}

% category of connected event structures 
\newcommand{\ces}{\ensuremath{\mathsf{cES}}}

% category of weak prime algebraic domains domains 
\newcommand{\WDom}{\ensuremath{\mathsf{wDom}}}
% category of domains
\newcommand{\Dom}{\ensuremath{\mathsf{Dom}}}
% category of prime algebraic domains
\newcommand{\PDom}{\ensuremath{\mathsf{pDom}}}


%%%%% NON BINARY CONFLICT

% category of event structures 
\newcommand{\esn}{\ensuremath{\mathsf{ES_{nb}}}}
% category of stable event structures 
\newcommand{\sesn}{\ensuremath{\mathsf{sES_n}}}

% category of connected event structures 
\newcommand{\cesn}{\ensuremath{\mathsf{cES_{nb}}}}

% category of prime event structures 
\newcommand{\pesn}{\ensuremath{\mathsf{pES_n}}}

% category of fusion domains 
\newcommand{\WDomb}{\ensuremath{\mathsf{wDom_b}}}
% category of domains
\newcommand{\Domb}{\ensuremath{\mathsf{Dom_b}}}
% category of prime algebraic domains
\newcommand{\PDomb}{\ensuremath{\mathsf{pDom_b}}}

%%%%% END NON BINARY CONFLICT


% slice category
\newcommand{\slice}[2]{\ensuremath{({#1} \downarrow {#2})}}


% event structure for a domain
\newcommand{\zev}[0]{\ensuremath{\mathcal{E}}}
\newcommand{\ev}[1]{\ensuremath{\zev({#1})}}

% from general to connected event structures
\newcommand{\zconnes}[0]{\ensuremath{\mathcal{C}}}
\newcommand{\connes}[1]{\ensuremath{\zconnes({#1})}}
% and inclusion
\newcommand{\zinces}[0]{\ensuremath{\mathcal{I}}}
\newcommand{\inces}[1]{\ensuremath{\zinces({#1})}}


% stable version
\newcommand{\zsev}[0]{\ensuremath{\mathcal{E}_S}}
\newcommand{\sev}[1]{\ensuremath{\zsev({#1})}}

% with equivalence
\newcommand{\zeveq}[0]{\ensuremath{\mathcal{E}_{eq}}}
\newcommand{\eveq}[1]{\ensuremath{\zeveq({#1})}}

% es with equivalence to es and vice
\newcommand{\zfuse}[0]{\ensuremath{\mathcal{M}}}
\newcommand{\fuse}[1]{\ensuremath{\zfuse({#1})}}
\newcommand{\zunf}[0]{\ensuremath{\zunf}}
\newcommand{\unf}[1]{\ensuremath{\mathcal{U}({#1})}}



% Winskel/Droste version
\newcommand{\zevwd}[0]{\ensuremath{\mathcal{E}_{wd}}}
\newcommand{\evwd}[1]{\ensuremath{\zevwd({#1})}}




% configurations of an event structure
\newcommand{\conf}[1]{\ensuremath{\mathit{Conf}({#1})}}
% finite configurations
\newcommand{\conff}[1]{\ensuremath{\mathit{Conf_F}({#1})}}

% product of the sets of minimal enablinsg
\newcommand{\pmin}[1]{\ensuremath{U_{#1}}}

% connectectedness of minimal enablinsg
\newcommand{\conn}[1]{\ensuremath{\stackrel{#1}{\frown}}}


% domain for an event structure or graph grammar
\newcommand{\zdom}[0]{\ensuremath{\mathcal{D}}}
\newcommand{\dom}[1]{\ensuremath{\zdom({#1})}}


\newcommand{\zdomeq}[0]{\ensuremath{\mathcal{D}_{eq}}}
\newcommand{\domeq}[1]{\ensuremath{\zdomeq({#1})}}


% partial order for a graph grammar
\newcommand{\poset}[1]{\ensuremath{\mathcal{P}({#1})}}

% stable version
\newcommand{\pdom}[1]{\ensuremath{\mathcal{D}_S({#1})}}
\newcommand{\ppdom}[0]{\ensuremath{\mathcal{D}_S}}


% powerset
\newcommand{\Pow}[1]{\ensuremath{\mathbf{2}^{#1}}}

% powerset of finite subsets
\newcommand{\Powfin}[1]{\ensuremath{\mathbf{2}_\mathit{fin}^{#1}}}

% powerset of subsets of cardinality <= 1
\newcommand{\Powone}[1]{\ensuremath{\mathbf{2}_1^{#1}}}

% integer interval
\newcommand{\interval}[2][1]{\ensuremath{[{#1},{#2}]}}

% domain interval
\newcommand{\dint}[2]{\ensuremath{[{#1},{#2}]}}

% set of intervals
\newcommand{\IntSet}[1]{\ensuremath{\mathop{\mathit{Int}({#1})}}}

% intervals to irreducibles and vice
\newcommand{\inir}{\ensuremath{\mathop{\mathit{\zeta}}}}
\newcommand{\irin}{\ensuremath{\mathop{\mathit{\iota}}}}

% permutations
\newcommand{\perm}{\sigma}

% causes
\newcommand{\causes}[1]{\ensuremath{\lfloor {#1})}}

%%% GRAPH GRAMMARS


\newcommand{\Abs}[1]{\ensuremath{\mathsf{Abs}({#1})}}
\newcommand{\tr}[1]{\ensuremath{\mathsf{Tr}({#1})}}
% fusion safe traces
\newcommand{\trs}[1]{\ensuremath{\mathsf{Tr}_s({#1})}}
%\newcommand{\graph}{\ensuremath{\mathsf{Graph}}}
\newcommand{\tgraph}[1]{\ensuremath{\mathsf{Graph}_{#1}}}
\newcommand{\can}[1]{\ensuremath{\mathsf{C}({#1})}}
% source and target of a derivation
\newcommand{\source}[1]{\ensuremath{\mathsf{s}({#1})}}
\newcommand{\target}[1]{\ensuremath{\mathsf{t}({#1})}}
\newcommand{\col}[1]{\ensuremath{\mathsf{col}({#1})}}

% left decorated trace
\newcommand{\ltrace}[1]{\ensuremath{\langle {#1}\rangle_c}}

\newcommand{\bx}[1]{\phantom{\big(}#1{\phantom{\big)}}}
\newcommand{\bxx}[1]{\,#1\,}
\newcommand{\cycl}[1]{\ensuremath{\mbox{\textcircled{\scriptsize{$#1$}}}}}
\renewcommand{\iff}{\ensuremath{\Leftrightarrow}}

%%%%GENERAL CATEGORICAL NOTATION

%identità
\newcommand{\id}[1]{\mathsf{id}_{#1}}
%codominio
\newcommand{\cod}[1]{\mathsf{cod}({#1})}
	%Variabili categorie
\def\A{\textbf {\textup{A}}}
%scheletro


\newcommand{\sk}{\mathsf{sk}_{\X}}


\def\R{\mathsf{R}}
\def\B{\textbf {\textup{B}}}
\def\C{\textbf {\textup{C}}}
\def\D{\textbf {\textup{D}}}
\def\X{\textbf {\textup{X}}}
\def\Y{\textbf {\textup{Y}}}

\newcommand{\ske}{\mathsf{sk}(\X)}
\renewcommand{\P}{\textbf {\textup{P}}}

%\derivazioni

\newcommand{\dder}[1]{\mathscr{#1}}
\newcommand{\sder}[2]{S_{i_1,i_2}(\mathscr{#1}, \mathscr{#2})}
\newcommand{\der}[1]{\underline{\dder{#1}}}
\def\dpo{\mathsf{C}^{\X}_R}
\def\gpo{\mathsf{G}^{\X}_R}
\def\dpi{[\mathsf{C}]^{\X}_R}
\def\gpi{[\mathsf{G}]^{\X}_R}

\newcommand{\ider}[1]{\mathscr{I}_{#1}}

%categorie
\def\Set{\textbf {\textup{Set}}}

%comma
\newcommand{\comma}[2]{#1\hspace{1pt} {\downarrow}\hspace{1pt} #2}
\newcommand{\cma}[2]{\mathcal{#1}\hspace{1pt} {\downarrow}\hspace{1pt} \mathcal{#2}}

%derivazioni
\newcommand{\lpro}{\langle \hspace{-1.85pt}[}
\newcommand{\rpro}{]\hspace{-1.85pt}\rangle}
\newcommand{\tpro}[1]{\lpro \der{#1}\rpro}
\newcommand{\tproi}[2]{\lpro \der{#1}_{#2}\rpro}
\newcommand{\lgt}[0]{\mathsf{length}}

%%% NEW

\usepackage{xparse}

% inversions
\newcommand{\inv}[1]{\ensuremath{inv}({#1})}

% direct shift
\newcommand{\shiftdir}[1][]{\ensuremath{\mathrel{{\rightsquigarrow}^{\mathit{sh}}_{#1}}}}

% shift preorder
\newcommand{\shiftpre}[1][]{\ensuremath{\mathrel{{\sqsubseteq}^{\mathit{sh}}_{#1}}}}

% shift equivalence
\newcommand{\shifteq}[1][]{\ensuremath{\mathrel{{\equiv}^\mathit{sh}_{#1}}}}

% transp{source}[target]: if target not specified source+1
\NewDocumentCommand{\transp}{m o}{%
  \ensuremath{({#1},%
  \IfNoValueTF{#2}%
    {{#1}+1}%
    {#2}%
    )}
}

\NewDocumentCommand{\mycommand}{o}{%
  % <code>
  \IfNoValueTF{#1}
    {code when no optional argument is passed}
    {code when the optional argument #1 is present}%
  % <code>
}
% interchange
\newcommand{\IC}[1]{\ensuremath{\mathit{IC}({#1})}}

%%%%% Ambienti matematici  %%%%%%
\newtheorem{theorem}{Theorem}[section]
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}[theorem]{Corollary}

\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem*{notation}{Notation}
\newtheorem{remark}[theorem]{Remark}
\newtheorem{example}[theorem]{Example}


\title{Switch equivalence and weak prime domains for fusions}
\author{Paolo Baldan \and Davide Castelnovo  \and  Andrea Corradini  \and Fabio Gadducci}

\begin{document}
\maketitle



\begin{abstract}
\todo{	A VERY NICE ABSTRACT}
\end{abstract}

\tableofcontents
\section{Introduction}

\todo{A VERY NICE INTRODUCTION}

\section{$\mathcal{M}$-adhesive categories}

This first section is devoted to recall the definition and the basic theory of \emph{$\mathcal{M}$-adhesive categories} \cite{azzi2019essence,ehrig2006weak,lack2005adhesive}. 

\begin{notation} 
We stipulate here some notational conventions which will be used throughout this paper. 

Given a category $\X$ we will not distinguish notationally between $\X$ and its class of objects: so that ``$X\in \X$'' means that $X$ belongs to the class of objects of $\X$.  

If $1$ is a terminal object in a category $\X$,  the unique arrow $X\to 1$ from another object $X$ will be denoted by $!_X$. Similarly, if $0$ is initial in $\X$ then $?_X$ will denote the unique arrow $0\to X$. When $\X$ is $\Set$ and $1$ is a singleton, $\delta_x$ will denote the arrow $1\to X$ with value $x\in X$.

Finally, we will use the following notation for some special classes of arrows of a category $\X$:
\begin{itemize}
	\item $\mathcal{A}(\X)$ will denote the class of all arrows of $\X$;
	\item $\mathcal{M}(\X)$ will denote the class of all monos of $\X$;
	\item $\mathcal{R}(\X)$ will denote the class of all regular monos of $\X$.
\end{itemize}
\end{notation}


\subsection{The Van Kampen condition}
The key property that $\mathcal{M}$-adhesive categories enjoy is given by  the so-called \emph{Van Kampen condition} \cite{brown1997van,johnstone2007quasitoposes,lack2005adhesive}. We will recall it and examine some of its consequences. 

\begin{definition} \index{Van Kampen square} \index{pushout!- square} \index{pushout!Van Kampen -|see{Van Kampen square}}Let $\X$ be a category  and consider the two diagrams below
	\[\xymatrix@C=10pt@R=10pt{&&&&&A'\ar[dd]|\hole_(.65){a}\ar[rr]^{f'} \ar[dl]_{m'} && B' \ar[dd]^{b} \ar[dl]_{n'} \\ A \ar[dd]_{m}\ar[rr]^{f}&&B\ar[dd]^{n}&&C'  \ar[dd]_{c}\ar[rr]^(.7){g'} & & D' \ar[dd]_(.3){d}\\&&&&&A\ar[rr]|\hole^(.65){f} \ar[dl]^{m} && B \ar[dl]^{n} \\C\ar[rr]_{g} &&D&&C \ar[rr]_{g} & & D}\]
	We say that the left square is a \emph{Van Kampen square} if:
	\begin{enumerate}
		\item it is a pushout square;
		\item whenever the right cube has pullbacks as back and left faces, then its top face is a pushout if and only if the front and right faces are pullbacks.
	\end{enumerate}
	
	Pushout squares which enjoy the ``if'' half of this condition are called \emph{stable}.
\end{definition}


\begin{example}\label{ex:iso}
	In any category $\X$, a square as the one below on the left, in which $m$ is an isomorphism, is Van Kampen. Notice that, in this situation, $n$ must be an isomorphism too.
		\[\xymatrix@C=10pt@R=10pt{&&&&&A'\ar[dd]|\hole_(.65){a}\ar[rr]^{f'} \ar[dl]_{m'} && B' \ar[dd]^{b} \ar[dl]_{n'} \\ A \ar[dd]_{m}\ar[rr]^{f}&&B\ar[dd]^{n}&&C'  \ar[dd]_{c}\ar[rr]^(.7){g'} & & D' \ar[dd]_(.3){d}\\&&&&&A\ar[rr]|\hole^(.65){f} \ar[dl]^{m} && B \ar[dl]^{n} \\C\ar[rr]_{g} &&D&&C \ar[rr]_{g} & & D}\]
		
	Take a cube as the one above and suppose that its back faces are pullbacks. In particular we know that also $m'$ is an isomorphism.
	
	\smallskip \noindent 
	$(\Rightarrow)$ Suppose that the top face is a pushout, thus $n'$ is an isomorphism and the right square is a pullback. The thesis for the front face follows at once since $m', n', m$ and $m$ are isomorphisms and the back face a pullback.
	
	\smallskip \noindent 
	$(\Leftarrow)$ If all the vertical faces are pullbacks, then $m'$ and $n'$ are isomorphisms and this entails at once that the top face is a pushout.
\end{example}

Before proceeding further, we recall this classical result about pullbacks.

\begin{lemma}\label{lem:pb1}
	Let $\X$ be a category, and consider the following diagram 	in which the right square is a pullback.
	\[\xymatrix{X \ar[d]_{a} \ar[r]^{f}& \ar[r]^{g} Y \ar[d]^{b}& Z \ar[d]^{c}\\ A \ar[r]_{h}& B \ar[r]_{k}& C}\]
	Then the whole rectangle is a pullback if and only if the left square is one.
\end{lemma}

The previous result can be dualised to get an analogous lemma for pushouts.

\begin{lemma}\label{lem:po1}
	Let $\X$ be a category, and consider the following diagram 	in which the left square is a pushout.
	\[\xymatrix{X \ar[d]_{a} \ar[r]^{f}& \ar[r]^{g} Y \ar[d]^{b}& Z \ar[d]^{c}\\ A \ar[r]_{h}& B \ar[r]_{k}& C}\]
	Then the whole rectangle is a pushout if and only if the right square is one.
\end{lemma}

The following proposition establishes a key property of Van Kampen squares with a mono as a side: they are not only pushouts, but also pullbacks.
\begin{proposition}\label{prop:pbpo} Let $m\colon A\to C$ be a monomorphism in a category $\X$. Then every Van Kampen square
	\[\xymatrix{A\ar[r]^{g} \ar[d]_{m} & B \ar[d]^{n} \\ C \ar[r]_{f}  & D}\]
	is also a pullback square and $n$ is a monomorphism.
\end{proposition}
\begin{proof} Take the following cube:
	\[\xymatrix@C=13pt@R=13pt{&A\ar[dd]|\hole_(.65){\id{A}}\ar[rr]^{g} \ar[dl]_{\id{A}} && B \ar[dd]^{\id{B}} \ar[dl]_{\id{B}} \\ A  \ar[dd]_{m}\ar[rr]^(.65){g} & & B \ar[dd]_(.3){n}\\&A\ar[rr]|\hole^(.65){g} \ar[dl]^{m} && B \ar[dl]^{n} \\C \ar[rr]_{f} & & D}\]
	By construction the top face of the cube is a pushout and the back one a pullback. The left face is a pullback because $m$ is mono. Thus the Van Kampen property yields that the front and the right faces are pullbacks and the thesis follows. \qedhere 
\end{proof}

The previous proposition, in turn, allows us to establish the following results.
\begin{lemma}\label{lem:varie} Let $m:X\to Y$ be a monomorphism in a category $\X$ and suppose that the left square below is Van Kampen, while all the vertical faces in the right cube are pullbacks.
		\[\xymatrix@C=10pt@R=10pt{&&&&&A'\ar[dd]|\hole_(.65){a}\ar[rr]^{f'} \ar[dl]_{m'} && B' \ar[dd]^{b} \ar[dl]_{n'} \\ A \ar[dd]_{m}\ar[rr]^{f}&&B\ar[dd]^{n}&&C'  \ar[dd]_{c}\ar[rr]^(.7){g'} & & D' \ar[dd]_(.3){d}\\&&&&&A\ar[rr]|\hole^(.65){f} \ar[dl]^{m} && B \ar[dl]^{n} \\C\ar[rr]_{g} &&D&&C \ar[rr]_{g} & & D}\]
Supppose, moreover that $d:D'\to D$ is mono, then $d\leq n$ if and only if $c \leq m$.
\end{lemma}
\begin{remark}
	Recall that, given two monos $m:M\to X$ and $n:N\to X$ with the same codomain, $m\leq n$ means that there exists a, necessarily unique, $k:M\to N$ fitting in the triangle below:
	\[\xymatrix{M\ar@{.>}[rr]^{k}  \ar[dr]_{m}&& N \ar[dl]^{n}\\ & X}\]
	Notice that, if $m\leq n$ and $n\leq m$, then the arrow $k:M\to N$ is an isomorphism.  
\end{remark}
\begin{remark}
	Notice that, since $d$ is a mono and the front face a pullback, then $c$ is a monomorphism too.
\end{remark}

\begin{proof}
	$(\Rightarrow)$ By hypothesis there exists $k:D'\to B$ such that $n\circ k = d$. By \Cref{prop:pbpo}, the bottom face of the cube is a pullback, thus there exists a unique $h:C'\to A$ as in the diagram below. 
	In particular, this implies the thesis.
		\[\xymatrix@C=40pt{C'  \ar@{.>}[dr]^{h}\ar[r]^{g'} \ar@/_.3cm/[ddr]_{c}& D' \ar@/_.3cm/[ddr]|(.45)\hole_(.7){d}\ar@/^.3cm/[dr]^{k}\\ & A \ar[d]_{m} \ar[r]^{f} & B \ar[d]^{n} \\ & C \ar[r]_g & D}\]
	
	\smallskip \noindent 
	$(\Leftarrow)$ Let $h:C\to A$ be such that $c=m\circ h$. By the Van Kampen property the top face of the given cube is a pushout. Thus the dotted $k:D'\to B$ in the following diagram exists.
		\[\xymatrix@C=40pt{A' \ar@/^.3cm/[ddr]^(.8){a} \ar[d]_{m'} \ar[r]^{f'} & B' \ar[d]^{n'} \ar@/^.3cm/[ddr]^{b} \\  C' \ar@/_.3cm/[dr]_{h} \ar[r]_{g'}|(.7)\hole & D' \ar@{.>}[dr]^{k}\\ &A \ar[r]_f& B }\]
	The thesis now follows at once. \qedhere 
\end{proof}

Finally, we can show that stable pushouts enjoy a kind of \emph{pullback-pushout decomposition} property.

\begin{proposition}\label{prop:stab}Let $\X$ be a category  and suppose that, in the diagram below, the whole rectangle is a stable pushout and the right square a pullback.
	\[\xymatrix{X \ar[d]_{a} \ar[r]^{f}& \ar[r]^{g} Y \ar[d]^{b}& Z \ar[d]^{c}\\ A \ar[r]_{h}& B \ar[r]_{k}& C}\]
	If the arrow $k$ is a monomorphism,  then both squares are pushouts.
\end{proposition}

\begin{proof} We can begin noticinng that $g$, being the pullback of the monomorphism $k$, is monic too. Thus we can build the cube below, in which all the vertical faces are pullbacks.
	\[\xymatrix@C=20pt@R=10pt{ & &X\ar[dl]_{f} \ar[ddd]^(.333333){\id{X}}|(.666666)\hole\ar[rrr]^{a} &&&A \ar[ddd]^{\id{A}} \ar[dl]^{h}\\& Y\ar[dl]_{\id{Y}} \ar[ddd]|(.333333)\hole_{\id{Y}} &&&B \ar[ddd]^{\id{B}} \ar[dl]_{\id{B}} \\Y \ar[ddd]_{g} \ar[rrr]^{b}&&& B\ar[ddd]^{k}\\&&X \ar[rrr]|(.34)\hole^{a}|(.67)\hole \ar[dl]_{f}&&& A \ar[dl]^{h}\\ & Y  \ar[dl]_{g}&&& B \ar[dl]^{k}\\ Z\ar[rrr]_{c} &&& C}\]
	By hypothesis the face is a stable pushout and so its top one is a pushout. \Cref{lem:po1} now entails that the right half of the rectangle with which we have started is a pushout too. \qedhere 
\end{proof}

\subsection{$\mathcal{M}$-adhesivity}

In this section we will define the notion of $\mathcal{M}, \mathcal{N}$-adhesivity and explore some of the consequence of such a property. Let us start fixing some terminology.

\begin{definition}\
	Let $\mathcal{M}$  be a class of arrows of a category $\X$. We say that  $\mathcal{M}$ is
	\begin{itemize}
		\item 
		\emph{stable under pushouts (pullbacks)} if for every pushout (pullbacks) square 
		\[\xymatrix{A\ar[r]^f  \ar[d]_{m}& B \ar[d]^n \\ C \ar[r]_g & D}\]
		if $m \in \mathcal{M}$ ($n\in \mathcal{M}$) then $n \in \mathcal{M}$ ($m \in \mathcal{M}$);
		\item \emph{closed under composition} if $g, f\in \mathcal{M}$ implies $g\circ f\in \mathcal{M}$ whenever $g$ and $f$ are composable;
		\item \emph{closed under decomposition} if $g\circ f\in \mathcal{M}$ and $g\in \mathcal{M}$ implies $f\in \mathcal{M}$.
	\end{itemize}
\end{definition}

\begin{remark}Clearly, ``decomposition'' corresponds to ``left cancellation'', but we prefer to stick to the name commonly used in literature.
\end{remark}

We are now ready to give the definition of $\mathcal{M}$-adhesive category	
\begin{definition}[\cite{azzi2019essence,heindel2009category}]
	Let $\X$ be a category and consider a subclass $\mathcal{M}$ of the class $\mathcal{M}(\X)$ of monomorphisms such that:
	\begin{enumerate}
		\item $\mathcal{M}$ contains all isomorphisms and is closed under composition;
		\item $\mathcal{M}$ is stable under pullbacks and pushouts.
	\end{enumerate}
	We say that $\X$ is \emph{$\mathcal{M}$-adhesive} if
	\begin{enumerate}
		\item for every $m\colon X\to Y$ in $\mathcal{M}$ and $g\colon Z\to Y$, a pullback square
		\[\xymatrix{P\ar[r]^p \ar[d]_{n}& X \ar[d]^{m}\\ Z \ar[r]_g& Y}\]
		exists, such pullbacks will be called \emph{$\mathcal{M}$-pullbacks};
		\item for every $m\colon X\to Y$ in $\mathcal{M}$ and $n\colon X\to Z$, a pushout square
		\[\xymatrix{X \ar[r]^n \ar[d]_{m}& Z \ar[d]^{q}\\ Y\ar[r]_p &Q}\]
		exists, such pushouts  will be called \emph{$\mathcal{M}$-pushouts}; 
		\item  $\mathcal{M}$-pushouts are Van Kampen squares.
	\end{enumerate}
\end{definition}


\begin{remark}\label{rem:diff}Our notion of $\mathcal{M}$-adhesivity is slightly different from the one of \cite{azzi2019essence}: in that paper, $\mathcal{M}$ is assumed to be only stable under pullbacks. Notice, however, that if $\mathcal{M}$ contains all split monos, then stability under pushouts can be deduced from the other axioms \cite[Prop.~$5.1.21$]{castelnovo2023thesis}.
\end{remark}


\begin{remark}\label{rem:salva} 
	\emph{Adhesivity} and \emph{quasiadhesivity} as defined in \cite{lack2005adhesive,garner2012axioms}  coincide with  $\mathcal{A}(\X) $-adhesivity and $\mathcal{R}(\X)$-adhesivity, respectively. 
\end{remark}

A first result we can prove regards closure under decomposition of $\mathcal{M}$.

\begin{proposition}\label{prop:deco}Let  $\mathcal{M}$ be a class of monomorphisms containing all isomorphisms and stable under pullbacks. For every arrow $f: X\to Y$ and monomorphism $m: Y\to Z$, if $m\circ f \in\mathcal{M}$ then $f\in \mathcal{M}$.
\end{proposition}
\begin{proof}Take the diagram
	\[\xymatrix{X \ar[d]_{\id{X}}\ar[r]^{f}& Y \ar[r]^{\id{Y}}  \ar[d]_{\id{Y}}& Y \ar[d]^{m}\\
		X \ar[r]_{f}& Y \ar[r]_{m} & Z}\]
	Since $m$ is mono the right square is a pullback, the thesis now follows from \Cref{lem:pb1}.
\end{proof}
\begin{corollary}\label{cor:deco}
	In every $\mathcal{M}$-adhesive category $\X$, the class $\mathcal{M}$ is closed under decomposition.
\end{corollary}

Another result which can be immediately established, with the aid of \Cref{prop:pbpo}, is the following one.
\begin{proposition}\label{prop:pbpoad}
	Let $\X$ be an $\mathcal{M}$-adhesive category. Then $\mathcal{M}$-pushouts are also pullback squares.
\end{proposition}

From \Cref{prop:pbpoad}, in turn, we can derive the following corollaries.
\begin{corollary}\label{cor:rego}
	In a $\mathcal{M}$-adhesive category $\X$, every $m\in\mathcal{M}$ is a regular mono.
\end{corollary}
\begin{proof}
Let $m$ be an element of $\mathcal{M}$ and consider its pushout along itself.
\[\xymatrix{X\ar[r]^m \ar[d]_m& Y\ar[d]^{f}\\Y \ar[r]_g & Z}\]
By \Cref{prop:pbpoad} this square is a pullback, proving that $m$ is the equalizer of the arrows $f,g\colon Y\rightrightarrows Z$. \qedhere 
\end{proof}

The following result now follows at once noticing that a regular monomorphism which is also epic is automatically an isomorphism.

\begin{corollary}\label{prop:bal}
If $\X$ is an $\mathcal{M}$-adhesive categories, then every epimorphisms in $\mathcal{M}$ is an isomorphisms. In particular, every adhesive category $\X$ is \emph{balanced}: if a morphism is monic and epic, then it is an isomorphism.
\end{corollary}


$\mathcal{M}$-adhesivity is well-behaved with respect to  the comma construction \cite{mac2013categories}, as shown by the following theorem.
\begin{theorem}[\cite{CastelnovoGM22,ehrig2006fundamentals,lack2005adhesive}]\label{lem:comma}
	Let $\A$ and $\B$ be respectively an $\mathcal{M}$-adhesive and an $\mathcal{M}'$-adhesive category. Let also $L:\A\rightarrow \C$ be a functor that preserves $\mathcal{M}$-pushouts, and  $R:\B\rightarrow \C$ be a functor which preserves pullbacks.Then $\comma{L}{R}$ is $\cma{M}{M'}$-adhesive, where 
	\[
	\cma{M}{M}':=\{(h,k)\in \mathcal{A}(\comma{L}{R}) \mid h\in \mathcal{M}, k\in \mathcal{M}'\}\]
\end{theorem}

In particular, we can apply this result to slices over and under a given object.

\begin{corollary}\label{cor:slice}
	Let  $X$ be an object of an $\mathcal{M}$-adhesive category $\X$. Then  $\X/X$ and $X/\X$ are, respectively, is $\mathcal{M}/X$- and $X/\mathcal{M}$-adhesive, where
	\[\mathcal{M}/X:=\{m\in  \mathcal{A}(\X/X) \mid m\in \mathcal{M} \} \qquad X/\mathcal{M}:=\{m\in  \mathcal{A}(X/\X) \mid m\in \mathcal{M} \}\]
\end{corollary}


Another categorical construction which preserves $\mathcal{M}$-adhesivity property is the formation of the category of functors.

\begin{theorem}[\cite{CastelnovoGM22,ehrig2006fundamentals,lack2005adhesive}]\label{thm:functors}
If $\X$ is an $\mathcal{M}$-adhesive category, then for every small category $\Y$, the category $\X^\Y$  of functors $\Y\to \X$ is $\mathcal{M}^{\Y}$-adhesive, where
\[\mathcal{M}^{\Y}:=\{\eta \in \mathcal{A}(\X^\Y) \mid \eta_Y \in \mathcal{M} \text{ for every } Y\in \Y\}\]
\end{theorem}

We can list various examples of $\mathcal{M}$-adhesive categories (see \cite{castelnovo2023thesis,CastelnovoGM22,lack2006toposes}).

\begin{example}\todo{Topos, ipergrafi e grafi}
\end{example}


\begin{example}\todo{GRAFI GERARCHICI}
\end{example}

\begin{example}\todo{term graph}
\end{example}

We end this section proving two properties of $\mathcal{M}$-adhesive categories:  $\mathcal{M}$-pushout-pullback decomposition and uniqueness of pushouts complements.


\begin{lemma}[$\mathcal{M}$-pushout-pullback decomposition]\label{lem:popb} Let $\X$ be an $\mathcal{M}$-adhesive category  and suppose that, in the diagram below, the whole rectangle is a pushout and the right square a pullback.
\[\xymatrix{X \ar[d]_{a} \ar[r]^{f}& \ar[r]^{g} Y \ar[d]^{b}& Z \ar[d]^{c}\\ A \ar[r]_{h}& B \ar[r]_{k}& C}\]
	Then the following statements hold true:
	\begin{enumerate}
\item if $a$ belongs to $\mathcal{M}$ and $k$ is a monomorphism,  then both squares are pushouts and pullbacks;
\item if $f$ and $k $ are in  $\mathcal{M}$, then both squares are pushouts and pullbacks.
	\end{enumerate}
\end{lemma}
\begin{proof}
\begin{enumerate}
	\item By \Cref{prop:stab}, it follows that both squares are pushouts. On the other hand, \Cref{prop:pbpoad} entails that the whole rectangle is a pullback, thus the thesis follows from \Cref{lem:pb1}.
	\item By hypothesis, $g$ is the pullback of an arrow in $\mathcal{M}$, thus belongs to it. But then $g\circ f\in \mathcal{M}$ too  and the whole rectangle is a $\mathcal{M}$-pushout. Therefore, by \Cref{prop:pbpoad} a pullback, so that its left half is a pullback too, by \Cref{prop:pbpo}. Moreover $k\circ h$ is in $\mathcal{M}$ as the pushout of $g\circ f$ and, by \Cref{cor:deco}, we also know that $h\in \mathcal{M}$.  
	
	Using \Cref{lem:po1}, it is enough to show that the left half of the original rectangle is a pushout. We can build the same cube of the previous point:
	\[\xymatrix@C=20pt@R=10pt{ & &X\ar[dl]_{f} \ar[ddd]^(.333333){\id{X}}|(.666666)\hole\ar[rrr]^{a} &&&A \ar[ddd]^{\id{A}} \ar[dl]^{h}\\& Y\ar[dl]_{\id{Y}} \ar[ddd]|(.333333)\hole_{\id{Y}} &&&B \ar[ddd]^{\id{B}} \ar[dl]_{\id{B}} \\Y \ar[ddd]_{g} \ar[rrr]^{b}&&& B\ar[ddd]^{k}\\&&X \ar[rrr]|(.34)\hole^{a}|(.67)\hole \ar[dl]_{f}&&& A \ar[dl]^{h}\\ & Y \ar[rrr]|(.67)\hole^{b} \ar[dl]_{g}&&& B \ar[dl]^{k}\\ Z\ar[rrr]_{c} &&& C}\]
	Its vertical faces are all pullbacks, those the top one is a pushout and we can conclude. \qedhere 
\end{enumerate}
\end{proof}

Let us turn our attention to pushout complements.

\begin{definition}
Let $f:X\to Y$ and $g:Y\to Z$ ba two composable arrows in a category $\X$. A \emph{pushout complement} for the pair $(f,g)$ is a pair $(h,k)$ with $h:X\to W$ and $k:W\to Z$ such that the square below commutes and it is a pushout.
\[\xymatrix{X \ar[r]^{f} \ar[d]_{h}& Y \ar[d]^{g} \\ W \ar[r]_{k}& Z}\]
\end{definition}

\begin{example}
	In a generic category $\X$, pushout complements may not exist: in the  the category of $\Set$ the arrows $?_{2}:\emptyset \to 2$ and $!_2:2\to 1$ do not have a pushout complement.
	
	Moreover, composable arrows $f:X\to Y$ and $g:Y\to Z$ may have  pushout complements which are non-isomorphic: for instance, in $\Set$ the two squares below are both pushouts.
	
	\[\xymatrix{2 \ar[r]^{!_2} \ar[d]_{\id{2}}& 1 \ar[d]^{\id{1}} & 2 \ar[r]^{!_2} \ar[d]_{!_2}& 1 \ar[d]^{\id{1}}\\ 2 \ar[r]_{!_2}& 1 & 1 \ar[r]_{\id{1}}& 1}\]
\end{example}

Working in an $\mathcal{M}$-adhesive category we can amend the second defect. 

\begin{lemma}[Uniqueness of pushouts complements]\label{lem:pocomp}
Let $\X$ be a $\mathcal{M}$-adhesive category. Given $m:X\to Y$ in $\mathcal{M}$ and $n:Y\to Z$, let $(h_1, k_1)$ and $(h_2, k_2)$ be pushout complements of $m$  and $n$ and $W_1=\cod{h_1}$, $W_2=\cod{h_2}$. Then there exists a unique isomorphism $f:W_1\to W_2$ making the following diagram commutative.
\[\xymatrix{&X \ar[r]^{m} \ar[d]_{h_1} \ar@/_.3cm/[ddl]_{h_2}& Y \ar[d]^{n} \\ &W_1 \ar@{.>}[dl]^{f} \ar[r]_{k_1} & Z \\ W_2 \ar@/_.3cm/[urr]_{k_2}}\]
 
\end{lemma}
\begin{proof}
	$k_1$ and $k_2$, being the pushout of $m$, are elements of $\mathcal{M}$ and thus are monomorphisms. In particular, $k_2$ is a monomorphism and this  entails at once the uniqueness of $f$.  Moreover, notice that the squares
	\[\xymatrix{X \ar[r]^{m} \ar[d]_{h_1}& Y \ar[d]^{n}& X \ar[d]_{h_2}\ar[r]^{m} & Y \ar[d]^{n}\\ W_1 \ar[r]_{k_1} & Z & W_2 \ar[r]_{k_2}& Z}\]
	are $\mathcal{M}$-pushouts and thus Van Kampen.
	
To prove the existence of the wanted $f$, we can start observing that $k_1$ and $k_2$, being the pushout of $m$, are elements of $\mathcal{M}$, so that we can consider the pullback square
	\[\xymatrix{P\ar[r]^{p_1}  \ar[d]_{p_2}& W_1 \ar[d]^{k_1}\\ W_2 \ar[r]_{k_2} & Z}\]
	Since $k_1\circ h_1=k_2\circ h_2$, there exists a unique $g: X\to P$ such that
	\[p_1\circ g=h_1 \qquad p_2\circ g = h_2\]
	We can then build the cubes
	\[\xymatrix@C=13pt@R=13pt{&X\ar[dd]|\hole_(.65){\id{X}}\ar[rr]^{g} \ar[dl]_{\id{X}} && P \ar[dd]^{p_1} \ar[dl]_{p_2} & &X\ar[dd]|\hole_(.65){\id{X}}\ar[rr]^{g} \ar[dl]_{\id{X}} && P \ar[dd]^{p_2} \ar[dl]_{p_1}\\ X  \ar[dd]_{m}\ar[rr]^(.65){h_2} & & W_2 \ar[dd]_(.3){k_2}& &  X  \ar[dd]_{m}\ar[rr]^(.65){h_1} & & W_1 \ar[dd]_(.3){k_1}\\&X\ar[rr]|\hole^(.65){h_1} \ar[dl]^{m} && W_1 \ar[dl]^{k_1} & &X\ar[rr]|\hole^(.65){h_2} \ar[dl]^{m} && W_2 \ar[dl]^{k_2}\\Y \ar[rr]_{n} & & Z & &Y \ar[rr]_{n} & & Z}\]
	
	Now, in both cubes the front and left faces are pullbacks, thus, by \Cref{lem:pb1}, their back face is a pullback too. Since $m\leq m$, \Cref{lem:varie} now entails that $k_1\leq k_2$ and $k_2\leq k_1$. Thus there exists an isomorphism $f:W_1\circ W_2$ such that $k_1=k_2\circ f$. To see that $h_2=f\circ h_1$, we can compute:
	\begin{align*}
		k_2\circ f \circ h_1 & = k_1\circ h_1\\&= n\circ m\\&= k_2\circ h_2
	\end{align*}
	The claim now follows since $k_2$ is a monomoprhism. \qedhere 
\end{proof}


\section{Double pushout rewriting and derivations}
\todo{A VERY NICE INTRODUCTION}

\subsection{Left-linear DPO-rewriting systems}
We are now going to study rewriting systems in $\mathcal{M}, \mathcal{N}$-adhesive categories.

\begin{definition}[\cite{habel2012mathcal,heindel2009category}]
	Let $\X$ be a $\mathcal{M}$-adhesive category, a  \emph{left $\mathcal{M}$-linear} rule $\rho$ is a pair $(l,r)$ of arrows with the same domain, such that $l$ belongs to $\mathcal{M}$.  The rule $\rho$ is said to be \emph{$\mathcal{M}$-linear} if $r\in \mathcal{M}$ too. A rule $\rho$ is said to be \emph{consuming} if $l$ is not an isomorphism. We will represent a rule $\rho$ as a span 
	\[\xymatrix{L & K\ar[l]_{l} \ar[r]^{r} & R}\]
$L$ is the \emph{left-hand side}, $R$ is the \emph{right-hand side} and $K$ the \emph{glueing object}. 


A \emph{left-linear DPO-rewriting system} is a pair $(\X, \R)$ where $\X$ is a $\mathcal{M}$-adhesive category and $R$ is a set of left $\mathcal{M}$-linear rules. $(\X, \R)$ will be called \emph{linear} if every rule in $R$ is so.

Given  two objects $G$ and $H$ and a rule $\rho=(l,r)$ in $R$, a \emph{direct derivation $\mathscr{D}$ from $G$ to $H$ via $\rho$}, is a diagram as the one below, in which both squares are pushouts. 
	\[\xymatrix{L \ar[d]_{n}& K \ar[d]^{k}\ar[l]_{l} \ar[r]^{r} & R \ar[d]^{h}\\G & \ar[l]^{f} D \ar[r]_{g}& H}\]
	The arrow $n$ is called the \emph{match} of the derivation, while $h$ is its \emph{back-match}.
	We will denote a direct derivation $\dder{D}$ between $G$ and $H$ as $\dder{D}:G\Mapsto H$.
\end{definition}

\begin{example}\todo{
esempi di	derivazione}
\end{example}

\begin{example}\label{exa:conc} Let  $\dder{D}:G\Mapsto H$ be the direct derivation 
		\[\xymatrix{L \ar[d]_{n}& K \ar[d]^{k}\ar[l]_{l} \ar[r]^{r} & R \ar[d]^{h}\\G & \ar[l]^{f} D \ar[r]_{g}& H}\]
	If $\phi:G\to G'$ and $\psi:H\to H'$ are two isomorphisms, 	we can consider the direct derivation	$\phi * \dder{D}*\psi : G'\Mapsto H'$ given by the following diagram.
	\[\xymatrix{L \ar[d]_{\phi \circ n}& K \ar[d]^{k}\ar[l]_{l} \ar[r]^{r} & R \ar[d]^{\psi \circ h}\\G' & \ar[l]^{\phi \circ f} D \ar[r]_{\psi \circ g}& H}\]
\end{example}

$\mathcal{M}$-adhesivity of $\X$ guarantess the essential uniqueness of the result obtained rewriting an object, as shown by the next proposition.

\begin{proposition}\label{prop:unique} Let $\X$  be a $\mathcal{M}$-adhesive category. Suppose that the two direct derivations $\mathscr{D}$ and $\mathscr{D'}$ below, with the same match and applying the same left $\mathcal{M}$-linear rule $\rho$ are given.
	\[\xymatrix{L \ar[d]_{n}& K \ar[d]^{k}\ar[l]_{l} \ar[r]^{r} & R \ar[d]^{h} & L \ar[d]_{n}& K \ar[d]^{k'}\ar[l]_{l} \ar[r]^{r} & R \ar[d]^{h'}\\G & \ar[l]^{f} D \ar[r]_{g}& H & G & \ar[l]^{f'} D' \ar[r]_{g'}& H'}\]
Then there exist isomorphisms $t:D\to D'$ and $s:H\to H'$ as in the following diagram.
	\[\xymatrix@C=40pt@R=10pt{ &&&R\ar[dddr]^{h'} \ar[dddl]_{h}|(.67)\hole\\&&K \ar[dl]_{l} \ar[ur]^{r}\ar[dddr]^{k'} \ar[dddl]_{k}\\&L \ar[dddl]_{n}\\&&H \ar@{.>}[rr]^{s} && H'\\ & D \ar[ur]^{g} \ar@{.>}[rr]^{t} \ar[dl]_{f}&& D' \ar[ur]_{g'}\ar@/^.4cm/[dlll]^{f'}\\ G}\]
\end{proposition}
\begin{proof}
	By construction, the pairs $(k, f)$ and $(k', f')$ are pushout complements of $l$ and $n$. Thus, the existence of the isomorphism $t:D\to D'$ follows from \Cref{lem:pocomp}. Now, computing we have
	\begin{align*}
		g'\circ t \circ k &= g' \circ k'\\&=h'\circ r
	\end{align*}
	Hence, we have the dotted $s:H\to H'$. To see that $s$ is an isomorphism, consider the diagram 
	\[\xymatrix{K  \ar@/^.4cm/[rr]^{k'}\ar[d]_{r} \ar[r]_{k}& \ar[r]_{t} D \ar[d]^{g}& D' \ar[d]^{g'}\\ R \ar@/_.4cm/[rr]_{h'} \ar[r]^{h}& H \ar[r]^{s}& H'}\]
	By hypothesis the whole rectangle and its left half are pushouts, therefore, by \Cref{lem:po1} its right square is a pushout too. The claim now follows from the fact that the pushout of an isomorphism is an isomorphism. \qed
\end{proof}

If we look to direct derivations as transitions, it is natural to consider them as edges in a direct graph. Taking objects as vertices objects led us to the following definition \cite{heindel2009category}.

\begin{definition}
	Let $(\X, \R)$ be a left-linear DPO-rewrityng system, with $\X$ $\mathcal{M}$-adhesive. The \emph{DPO-derivation graph} of $(\X, \R)$ is the (large)  directed graph $\gpo$ having as vertices the objects of $\X$ and in which an edge between $G$ and $H$ is a direct derivation $\dder{D}:G\Mapsto H$.	A \emph{derivation} $\der{D}$ between two objects $G$ and $H$ is a path between them in $\gpo$.
\end{definition}

\begin{remark}
We can spell out more explicitly what  a derivation $\dder{D}$ betwee nis.  An \emph{empty derivation} starting and ending in $G$ is just $G$ itself.  A \emph{non-empty derivation} $\dder{D}$ is a sequence $\{\dder{D}_i\}_{i=0}^n$ of direct derivations such that:
\begin{enumerate}
	\item for every index $i$, $\dder{D}_i$ is a direct derivation $G_i \Mapsto G_{i+1}$;
	\item $G_0=G$ and $G_{n+1}=H$.
\end{enumerate}

We will call the number $n+1$ the \emph{length} of the derivation, denoted by $\lgt(\der{D})$. We will also say that an empty derivation has length $0$. 

Moreover,  if every $\dder{D}_i$ applies the rule $\rho_i\in R$, then we can define an associated sequence of rules as $r(\der{D})$ as $\{\rho_i\}_{i=0}^n$.
\end{remark}
	
\begin{notation}Let $\der{D}=\{\dder{D}_i\}_{i=0}^n$ be a derivation. We will depict the $i^\text{th}$ element $\dder{D}_i$ of $\der{D}$ as in the following diagram.  
	\[\xymatrix{L_i \ar[d]_{m_i}& K_i \ar[d]^{k_i}\ar[l]_{l_i} \ar[r]^{r_i} & R_i \ar[d]^{h_i} \\G_{i} & \ar[l]^{f_{i}} D_{i} \ar[r]_{g_{i}}& G_{i+1} }\]
	Notice that, in particular, if $\der{D}:G\to H$, then $G_0=G$ and $G_{n+1}=H$. When $\der{D}$ has length $1$ we will suppress the indexes. In such case, we will also identify $\der{D}$ with its only element. 
\end{notation} 

\begin{example}\todo{esempi di derivazione}
\end{example}

\begin{definition}
	The \emph{DPO-derivation category} $\dpo$ of a left-linear DPO-rewriting system $(\X, \R)$ is the category in which arrows between $G$ and $H$ are given by, possibly empty, derivations. Composition is concatenation of paths in $\gpo$ and identities are given by empty derivations.
\end{definition} 	
\begin{remark}
	More explicitly, given $\der{D}=\{\dder{D}\}_{i=0}^n$ between $G$ and $H$ and $\der{D}'=\{\dder{D}'_i\}_{i=0}^m$, their concatenation $\der{D}\cdot\der{D}'$ is the derivation $\{\dder{E}_i\}_{i=0}^{m+n+1}$ in which
	\[\dder{E}_i:=\begin{cases}
		\dder{D}_i & i \leq n\\
		\dder{D}'_{i-(n+1)} & n< i 
	\end{cases}\]	
\end{remark}

 \Cref{exa:conc} allows us to compose derivations with isomorphisms.

\begin{definition} Given a left-linear DPO-rewriting system $(\X, \R)$ and aderivation $\der{D}=\{\dder{D}_{i}\}_{i=0}^n$ between $G$ and $H$, the derivation $\phi *\der{D} * \psi$ between $G'$ and $H'$ is defined as
	\[\phi *\der{D} * \psi := \{\phi* \dder{D}_0*\id{G_1}\}\cdot \{\dder{D}_i\}_{i=1}^{n-1} \cdot \{\id{G_n}*\dder{D}_n*\psi\}\] 
	
\end{definition}

\begin{notation} In the following, we will use the notation $\phi *\dder{D}$, $\phi*\der{D}$ and $\dder{D}*\psi$, $\der{D}*\psi$ for the cases in which, respectively, $\psi=\id{H}$ and $\phi=\id{G}$. In particular
	\[\phi *\der{D} * \psi = \{\phi* \dder{D}_0\}\cdot \{\dder{D}_i\}_{i=1}^{n-1} \cdot \{\dder{D}_n*\psi\}\] 
\end{notation}

We are often interested in an object of $\X$ only up to isomorphism. It is then useful to consider a version of $\gpo$ in which vertices are classes of isomorphism of object of $\X$. In order to do so, some preliminary work is needed.

\begin{definition}\cite{mac2013categories}
Let $\X$ be a category, we say that  $\X$ is \emph{skeletal} if, for every two objects $X$ and $Y$, the existence of an isomorphism $\phi:X\to Y$ entails $X=Y$. A \emph{skeleton} for a category $\X$ is a full subcategory $\ske$ which is skeletal and such that the inclusion functor $\ske\to \X$ is an equivalence. 
\end{definition}

\begin{remark}
By definition the inclusion $\ske \to \X$ is an equivalence. In particular, this mean that, for every objects $X$ of $\X$ there exists $\pi(X)$ in $\ske$ and an isomorphism $\phi_X: \pi(X) \to X$.
\end{remark}

\begin{proposition}\label{prop:ske}
	Every category $\X$ has a skeleton. 
\end{proposition}
\begin{proof}
	For every object $X\in \X$, pick a single representative $\pi(X)$ of its isomorphism class. Let $\ske$ be the full subcategory given by these objects. By definition $\ske$ is skeletal and the inclusion functor is full, faithful and essentially surjective.\qedhere 
\end{proof}
\begin{remark}
	The proof of \Cref{prop:ske} relies on the axiom of choice for classes.
	\end{remark}
\begin{remark}
	It is possible to proof that every two skeleta of a given category $\X$ are isomorphic (not only equivalent). For the remaining of this paper we assume that a skeleton $\ske$ of $\X$ and a functor $\pi:\X\to \ske$ are chosen once and for all.
\end{remark}

\begin{definition}
	Let $(\X, \R)$ be a left-linear DPO-rewriting system, a \emph{decorated derivation} between two objects $G$ and $H$ is a triple $(\der{D}, \alpha, \omega)$, where $\der{D}$ is a derivation between $G$ and $H$, and $\alpha:\pi(G)\to G$ and $\omega:\pi(H)\to H$ are isomorphisms.
\end{definition}

\begin{remark}A decorated derivation $(\der{D}, \alpha, \omega)$ with $\der{D}$ empty is just a span
	\[\xymatrix{G & \pi(G) \ar[r]^{\omega} \ar[l]_{\alpha} & G}\]
	in which both $\omega$ and $\alpha$ are isomorphisms.
\end{remark}

As we are interested in objects only up to isomorphism, so we are interested in (decorated) derivations only up to some notion of coherent isomorphism between them.

\begin{definition}
	Let $\dder{D}:G\Mapsto H$ and $\dder{D}':G'\Mapsto H'$ be two direct derivations given by the following two diagrams
	\[\xymatrix{L \ar[d]_{n}& K \ar[d]^{k}\ar[l]_{l} \ar[r]^{r} & R \ar[d]^{h} & L \ar[d]_{n'}& K \ar[d]^{k'}\ar[l]_{l} \ar[r]^{r} & R \ar[d]^{h'}\\G & \ar[l]^{f} D \ar[r]_{g}& H & G' & \ar[l]^{f'} D' \ar[r]_{g'}& H'}\]
	An \emph{abstraction equivalence} $\phi:\dder{D}\to \dder{D}'$ is a triple $(\phi_1, \phi_2, \phi_3)$ of isomorphism fitting in the diagram below.
	\[\xymatrix@C=40pt@R=10pt{ &&&R\ar[dddr]^{h'} \ar[dddl]_{h}|(.67)\hole\\&&K \ar[dl]_{l} \ar[ur]^{r}\ar[dddr]^{k'} \ar[dddl]_{k}|(.67)\hole\\&L\ar[dddr]^(.4){n'} \ar[dddl]_(.4){n}\\&&H \ar[rr]^{\phi_3} && H'\\ & D \ar[ur]_(.7){g} \ar[rr]^{\phi_2} \ar[dl]_{f}&& D' \ar[ur]_{g'}\ar[dl]^{f'}\\ G \ar[rr]_{\phi_1} && G'}\]

Given two decorated derivations $(\der{D}, \alpha, \omega)$, $(\der{D}', \alpha', \omega')$ with  $\der{D}=\{\dder{D}_i\}_{i=0}^n$, $\der{D}'=\{\dder{D}'_i\}_{i=0}^n$ such that $\dder{D}_i:G_i\Mapsto G_{i+1}$ and $\dder{D}'_i:G'_i\Mapsto G'_{i+1}$, we will say that $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ are \emph{abstraction equivalent}, if  $r(\der{D})=r(\der{D'})$  and there exists a family $\{\phi^i\}_{i=0}^n$ of abstraction equivalences $\phi^i$ between $\dder{D}_i$ and  $\dder{D}'_i$ such that, for every index $i$, $\phi^i_3=\phi^{i+1}_1$ and  the following diagrams commute.
\[\xymatrix{&\pi(G_0) \ar[dr]^{\alpha'} \ar[dl]_{\alpha}&&& \pi(G_{n+1}) \ar[dr]^{\omega'} \ar[dl]_{\omega}\\ G_0 \ar[rr]_{\phi^0_1} && G'_0 &G_{n+1} \ar[rr]_{\phi^n_3} && G'_{n+1} } \]

	In such situation we will say that $ (\der{D}, \alpha, \omega)$ and  $(\der{D}', \alpha', \omega')$ are \emph{abstraction equivalent}. We will use $\equiv^a$ to denote the resulting equivalence relation, while  $[\der{D}, \alpha, \omega]_a$ will denote the equivalence class of  $(\der{D}, \alpha, \omega)$, called an \emph{abstract decorated derivation}. 
\end{definition}
\begin{remark}\label{rem:res} \Cref{prop:unique} can be restated as saying that, given two direct derivations $\dder{D}$ and $\dder{D'}$ with the same match, there exists an abstract equivalence between them whose first component is an identity.
\end{remark}

\begin{definition}
Let $(\der{D}, \alpha, \omega)$ be a decorated derivation between $G$ and $H$ and $(\der{D}', \alpha', \omega')$ one between $H'$ and $K$. If $H$ and $H'$ are isomorphic, so that $\pi(H)=\pi(H')$, we define the  \emph{composite decorated derivation}  $(\der{D}, \alpha, \omega)\cdot (\der{D}', \alpha', \omega')$ as $((\der{D}* \omega^{-1}) \cdot ((\alpha')^{-1} *\der{D}'), \alpha, \omega')$.
\end{definition}

\begin{remark}\label{rem:lgt}
	Given two composable decorated derivations $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$  such that $\der{D}$ and $\der{D}'$ have  length $n$ and $m$, respectively, then $(\der{D}* \omega^{-1}) \cdot ((\alpha')^{-1} *\der{D}')$ has length $n+m$.
\end{remark}


The next proposition justifies the use of decorations, guaranteeing that concatenation of abstract decorated derivations is weel-defined.
\begin{proposition}
	Given a decorated derivation $(\der{D}, \alpha, \omega)$  between $G$ and $H$ and  another one $(\der{E}, \beta, \xi)$ between $E$ and $K$ with $\pi(H)=\pi(E)$. If  $(\der{D}', \alpha', \omega')$ and $(\der{E}', \beta', \xi')$ are two other decorated derivations such that
	$[\der{D}, \alpha, \omega]_a = [\der{D}', \alpha', \omega']_a$ and $[\der{D}, \beta, \xi]_a=[\der{E}', \beta', \xi']_a$, then
	\[[(\der{D}, \alpha, \omega)\cdot (\der{E}, \beta, \xi)]_a=[(\der{D}', \alpha', \omega')\cdot (\der{E}', \beta', \xi')]_a\]
\end{proposition}

\begin{proof}
	To fix the notation, let $\der{D}$, $\der{D}'$, $\der{E}$ and $\der{E}'$ be given by
	\[\der{D}=\{\dder{D}_i\}_{i=0}^n \quad \der{D}'=\{\dder{D}'_i\}_{i=0}^n \quad \der{E}=\{\dder{E}_i\}_{i=0}^m \quad \der{E}'=\{\dder{E}'_i\}_{i=0}^m\]
	Let also $\{\phi^i\}_{i=0}^n$ and $\{\varphi^i\}_{i=0}^m$ be families of abstract equivalences between $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ and between $(\der{E}, \beta, \xi)$ and $(\der{E}', \beta', \xi')$, respectively. For every $i\in [0, n+m-1]$ define 
	\[\psi^{i}:=\begin{cases}
		\phi^i & i< n\\
		(\phi^n_1, \phi^n_2, \id{\pi(H)}) & i=n\\
		(\id{\pi(E)}, \varphi^{0}_2, \varphi^{0}_3) & i=n+1\\
		\varphi^{i-n+1} & i>n+1
	\end{cases}\] 
Notice suppose that $h_n:R_n\to H, h_n:R_n\to H'$ are the back-matches of $\der{D}_n$ and $\der{D}'_n$ and that the following diagram is given
	\[\xymatrix@C=40pt@R=10pt{ &&&R_n\ar[dddr]^{h'_n} \ar[dddl]_{h_n}|(.67)\hole\\&&K_n \ar[dl]_{l_n} \ar[ur]^{r_n}\ar[dddr]^{k'_n} \ar[dddl]_{k_n}|(.67)\hole\\&L_n\ar[dddr]^(.4){m'_n} \ar[dddl]_(.4){m_n}\\&&H \ar[rr]^{\phi^n_3} && H'\\ & D_n \ar[ur]_(.7){g_n} \ar[rr]^{\phi^n_2} \ar[dl]_{f_n}&& D'_n \ar[ur]_{g'_n}\ar[dl]^{f'_n}\\ G_{n} \ar[rr]_{\phi^n_1} && G'_n}\]
Then we have
\begin{align*} 
	\id{\pi(H)}\circ \omega^{-1} \circ h_n&=(\omega')^{-1}\circ \phi^n_3 \circ \omega \circ \omega^{-1} \circ h_n\\&=(\omega')^{-1}\circ \phi^n_3  \circ h_n\\&=(\omega')^{-1}  \circ h'_n
\end{align*} 
and 
\begin{align*} \id{\pi(H)}\circ \omega^{-1} \circ g_n  &=(\omega')^{-1}\circ \phi^n_3 \circ \omega \circ \omega^{-1}\circ g_n\\&=(\omega')^{-1}\circ \phi^n_3\circ g'_n\\&=(\omega')^{-1}\circ g'_n\circ \phi^n_2\end{align*}
Therefore $\psi^n$ is an abstract equivalence between $\dder{D}_n*\omega^{-1}$ and $\dder{D}_n'*(\omega')^{-1}$.

Similarly, if $\hat{m}_0:\hat{L}_0\to E, \hat{m}'_0:L'_0\to E'$ the matches of $\der{E}_0$, $\der{E}'_0$, we can consider the diagram
\[\xymatrix@C=40pt@R=10pt{ &&&\hat{R}_0\ar[dddr]^{\hat{h}'_0} \ar[dddl]_{\hat{h}_0}|(.67)\hole\\&&\hat{K}_0 \ar[dl]_{\hat{l}_0} \ar[ur]^{\hat{r}_0}\ar[dddr]^{k'_0} \ar[dddl]_{\hat{k}_0}|(.67)\hole\\&\hat{L}_n\ar[dddr]^(.4){\hat{m}'_0} \ar[dddl]_(.4){\hat{m}_0}\\&&\hat{G}_1 \ar[rr]^{\varphi^0_3} && \hat{G}'_1\\ & \hat{D}_0 \ar[ur]_(.7){\hat{g}_0} \ar[rr]^{\varphi^0_2} \ar[dl]_{\hat{f}_0}&& \hat{D}'_0 \ar[ur]_{\hat{g}'_0}\ar[dl]^{\hat{f}'_0}\\ E \ar[rr]_{\varphi^0_1} && E'}\]
and computing we get
\begin{align*}
	\id{\pi(E)}\circ \alpha^{-1} \circ \hat{m}_0&=(\alpha')^{-1}\circ \varphi^0_1 \circ \alpha \circ \alpha^{-1} \circ \hat{m}_0\\&=(\alpha')^{-1}\circ \varphi^0_1  \circ \hat{m}_0\\&=(\alpha')^{-1}\circ \hat{m}'_n
\end{align*}
together with
\begin{align*} \id{\pi(E)}\circ \alpha^{-1}\circ \hat{f}_0  &=(\alpha')^{-1}\circ \varphi^0_1 \circ \alpha \circ \alpha^{-1}\circ \hat{f}_0\\&=(\alpha')^{-1}\circ \varphi^0_1\circ \hat{f}_0\\&=(\alpha')^{-1}\circ \hat{f}'_0\circ \varphi^0_2\end{align*}
The previous two identities show that $\psi^{n+1}$ is an abstract equivalence between $\dder{E}_0$ and $\dder{E}'_0$. By hypothesis $\pi(H)=\pi(E)$ and, moreover, we have
	\[\begin{split}
		\psi^{0}_1\circ \alpha &= \phi^0_1\circ \alpha \\&= \alpha'
	\end{split}\qquad \begin{split}
	\psi^{n+m-1}_3\circ \xi &=\varphi^m_3\circ \xi \\&= \xi'
	\end{split}\]
Therefore the thesis now follows.	\qedhere 
\end{proof}

\begin{definition}
	Let $(\X, \R)$ be a left-linear DPO-rewrityng system, with $\X$ an $\mathcal{M}$-adhesive category. The  category $\dpi$ is defined as follows:
	\begin{itemize}
		\item objects are isomorphism classes of objects of $\X$;
		\item a non-identity arrow $[G]\to [H]$ is an equivalence class $[\der{D}, \alpha, \omega]_a$ of a decorated derivation between $G'$ and $H'$ for some $G'$ and $H'$ such that $\pi(G')=G$ and $\pi(H')=H$;
		\item composition is concatenation of abstract decorated derivations;
		\item identities are added formally.
	\end{itemize}
\end{definition}


\subsection{Consistent permutations}

Given a left-linear DPO-rewriting system $(\X, \R)$,  a derivation $\der{D}$  determines a diagram $\Delta(\der{D})$ in $\X$. We can then wonder if such a diagram has a colimit. Clealry if $\der{D}$ is the empty derivation then a colimit for $\Delta(\der{D})$ amount to an initial object in $\X$. If $\der{D}$ is non-empty we can use the following result.

\begin{lemma}\label{lem:colim}
	Let $\X$ be an $\mathcal{M}$-adhesive category and $(\X, \R)$ a left-linear DPO-rewriting system over it. The following hold true:
	\begin{enumerate}
		\item if $\der{D}$ is a derivation of length one, whose unique element is given by the following diagram
	\[\xymatrix{L \ar[d]_{m}& K \ar[d]^{k}\ar[l]_{l} \ar[r]^{r} & R \ar[d]^{h} \\G & \ar[l]^{f} D \ar[r]_{g}& H }\]	
		then the colimiting cocone $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D})})$ exists and  fits in the diagram below, where the bottom face is a pushout;
		\[\xymatrix@R=10pt{&K\ar[dd]^{k}\ar[rr]^{r} \ar[dl]_{l} && R \ar[dd]^{h} \\ L  \ar[dd]_{m} \\&D\ar[rr]^{g} \ar[dl]_{f} && H \ar[dl]^{\iota_H} \\G \ar[rr]_{\iota_G} & & \tpro{D}}\]
		\item  for every non-empty derivation $\der{D}$ from $G$ to $H$, the diagram $\Delta(\der{D})$ has a colimit $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D})})$ such that $\iota_H$ belong to $\mathcal{M}$;
		\item let $\der{D}$ be the concatenation $\der{D}_1\cdot \der{D}_2$ of two derivations $\der{D}_1=\{\dder{D}_{1,i}\}_{i=0}^{n_1}$ between $G$ and $H$ and $\der{D}_2=\{\dder{D}_{2,j}\}_{j=0}^{n_2}$ between $H$ and $T$,  then the colimiting cocone $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D})})$ exists too and there is a pushout square
		\[\xymatrix{H\ar[r]^-{\iota_{2, H}} \ar[d]_-{\iota_{1, H}} & \tproi{D}{2} \ar[d]^{p_2}\\  \tproi{D}{1} \ar[r]_{p_1}& \tpro{D}}\]
		where $(\tproi{D}{1}, \{\iota_{1, X}\}_{X\in \Delta(\der{D}_1)})$ and $(\tproi{D}{2}, \{\iota_{2, X}\}_{X\in \Delta(\der{D}_2)})$ are the colimiting cocone for $\Delta(\der{D}_1)$ and $\Delta(\der{D}_2)$, respectively;
		\item given a non-empty derivation $\der{D}=\{\dder{D}\}_{i=0}^n$ between $G$ and $H$, for every $j\in n+1$ different from $0$ the following diagram is a pushout
		\[\xymatrix@C=30pt{D_{j} \ar[r]^{g_j}\ar[d]_{f_j}& G_{j+1} \ar[r]^-{\hat{\iota}_{G_{j+1}}} \ar@/^.3cm/[ddl]^{\iota'_{G_j}} & \lpro \der{\hat{D}}\rpro \ar[dd]^{p_2} \\ G_j \ar[d]_{\iota'_{G_j}}\\ \lpro \der{D}' \rpro \ar[rr]_{p_1}  &&\tpro{D} }\] 
		where $\der{\hat{D}}=\{\dder{D}_i\}_{i=j+1}^n$, $\der{D}'=\{\dder{D}_i\}_{i=0}^j$ and $p_1:\lpro\der{D}' \rpro\to \tpro{D}$ and $p_2:\lpro \der{\hat{D}}\rpro \to \tpro{D}$ are the arrows induced by the cocones, $(\tpro{D}, \{\iota_{X}\}_{X\in \Delta(\der{D}')})$ and $(\tpro{D}, \{\iota_{X}\}_{X\in \Delta(\der{D}')})$, respectively.
	\end{enumerate}
\end{lemma}
\begin{remark}\label{rem:zero}
There is a version of point $4$ of \Cref{lem:colim} for $j=0$ which follows directly from points $1$ and $3$. Indeed, $\der{D}=\der{D}_1 \cdot \der{D}_2$ where $\der{D}_1=\{\dder{D}_0\}$ and $\der{D}_2=\{\dder{D}_i\}_{i=1}^n$. By point $1$ and $3$ of \Cref{lem:colim}, the two halves of the rectangle below are pushouts. By \Cref{lem:po1} the whole diagram is then a pushout too.
	\[\xymatrix@C=30pt{D_{0} \ar[r]^{g_0}\ar[d]_{f_0}& G_{1} \ar[d]^{\iota_{1, G_1}} \ar[r]^-{\iota_{2,G_{1}}} & \lpro \der{D}_2\rpro \ar[d]^{p_2} \\ G \ar[r]_{\iota_{1,G}}& \lpro \der{D}_1 \rpro \ar[r]_{p_1}  &\tpro{D} }\]
Notice that this entails that the square below is also a pushout. 
\[\xymatrix@C=25pt{D_0\ar[r]^-{\iota_{2, D_0}}  \ar[d]_{\iota_{1, D_0}}&  \lpro \der{D}_1 \rpro\ar[d]^{p_2}\\ \lpro \der{D}_1 \rpro \ar[r]_{p_1}  &\tpro{D} }\]
\end{remark}

\begin{proof}\begin{enumerate}
		\item We can start noticing that $f$, being the pushout of $l$ is in $\mathcal{M}$ and thus it admits a pushout along $g$, giving us the diagram 
		\[\xymatrix{L \ar[d]_{m}& K \ar[d]^{k}\ar[l]_{l} \ar[r]^{r} & R \ar[d]^{h} \\G \ar@/_.2cm/[dr]_{q}& \ar[l]^{f} D \ar[r]_{g}& H  \ar@/^.2cm/[dl]^{p}\\ & P}\]
		Clearly, precomposing $p$ and $q$ with the arrows appearing in $\dder{D}$, we can extend the pushout $(P, p, q)$, to a cocone $(P, \{j_X\}_{X\in \Delta(\der{D})})$ on $\Delta(\der{D})$. Let $(C, \{c_X\}_{X\in \Delta(\der{D})})$ be another cocone, for $\Delta(\der{D})$, in particular we have
		\begin{align*}
			c_H\circ g & = c_D \\&= c_G\circ f
		\end{align*}
		Hence, there exists a unique $c:P\to C$ such that $c\circ q= c_G$ and $c\circ p =c_H$. But these identities are enough to deduce that $(P, \{j_X\}_{X\in \Delta(\der{D})})$  is colimiting.
		\item Let us proceed by induction.
		\begin{itemize}
			\item  If $n=0$, then the claim follows immediately from point $1$, noticing that $\iota_H$ is the pushout of $f$ and thus an element of $\mathcal{M}$.
			\item Let $\der{D}$ be $\{\dder{D}_i\}_{i=0}^n$ and suppose that $n\geq 1$. Let also $\der{D}'$ be $\{\dder{D}_i\}^{n-1}_{i=0}$ and $\rho_n=(l_n, r_n)$ be the rule applied in $\dder{D}_n$. The pushout of $l_n$ is the arrow $f_n:D_n\to G_n$ is in $\mathcal{M}$ and, by inductive hypothesis, $\iota_{G_{n}}:G_{n}\to \lpro \der{D}'\rpro$ is in $\mathcal{M}$ too. Thus, we can consider the diagram below, having a pushout as its lower half.
			\[\xymatrix{L_n \ar[d]_{m_{n}}& K_{n} \ar[d]^{k_{n}}\ar[l]_{l_{n}} \ar[r]^{r_{n}} & R_{n} \ar[d]^{h_n} \\G_{n} \ar[d]_{\iota'_{G_{n}}}& \ar[l]^{f_n} D_n \ar[r]_{g_n}& H  \ar[d]^{q}\\ \lpro \der{D}' \ar[rr]_{p}\rpro && P}\] 
			Notice that, as in the point above, the arrow $q:H\to P$ is the pushout of an element in $\mathcal{M}$, therefore it is enough to show that the diagram so constructed provides a colimiting cocone for $\Delta(\der{D})$.
			
			Let $(C, \{c_X\}_{X\in \Delta(\der{D})})$ be a cocone, since $\Delta(\der{D}')$ is a subdiagram of $\Delta(\der{D})$, we get another cocone $(c, \{c_X\}_{X\in \Delta(\der{D}')})$ which induces an arrow $c':\lpro \der{D}' \rpro \to C$ such that
			\begin{align*}
				c'\circ \iota_{G_n} \circ f_n &=c_{G_n} \circ f_n\\&= c_{D_n}\\&= c_{H}\circ g_n
			\end{align*}
			Therefore the arrows $c'$ and $c_H$ induce a morphism $c:P\to C$ and the thesis now follows at once.
		\end{itemize}
		\item  As a first step, notice that $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D}_1)})$ and $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D}_2)})$ are cocone on, respectively, $\Delta(\der{D}_1)$ and $\Delta(\der{D}_2)$. Hence, there exist two arrows $p_1:\tproi{D}{1}\to \tpro{D}$, $p_2:\tproi{D}{2}\to \tpro{D}$ such that, for every $X\in  \Delta(\der{D}_1)$ and $Y\in  \Delta(\der{D}_2)$
		\[p_1\circ \iota_{1, X} = \iota_X \qquad p_2\circ \iota_{2, Y}=\iota_{2,Y}\]
		In particular, this entails the commutativity of the square
				\[\xymatrix{H \ar[dr]^{\iota_H} \ar[r]^-{\iota_{2, H}} \ar[d]_-{\iota_{1, H}} & \tproi{D}{2} \ar[d]^{p_2}\\  \tproi{D}{1} \ar[r]_{p_1}& \tpro{D}}\]
		
	Let us now show that the square above is a pushout. Take two arrows $a:\tproi{D}{1}\to C$, $b:\tproi{D}{2}\to C$ such that
	\[a\circ \iota_{1, H}=b\circ \iota_{2, H}\]
	We can use the previous equality to define a cocone $(C, \{c_X\}_{X\in \Delta(\der{D})})$ putting:
	\[c_X:=\begin{cases}
		a\circ \iota_{1, X} & X\in \Delta(\der{D}_1)\\
		b\circ \iota_{2, X} & X\in \Delta(\der{D}_2)
	\end{cases}\]
From this, we can deduce at once the existence of a unique $c:\tpro{D}\to C$ such that 
\[c\circ \iota_X = c_X\]
By construction, for every $X\in  \Delta(\der{D}_1)$ and $Y\in  \Delta(\der{D}_2)$ we have
\[\begin{split}
	c\circ p_1 \circ \iota_{1,X}&=c\circ \iota_{X}\\&=c_X \\&=a\circ \iota_{1,X}\\&=a\circ p_1\circ \iota_{1,X}
\end{split}\qquad \begin{split}
	c\circ p_2 \circ \iota_{2,Y}&=c\circ \iota_{Y}\\&=c_Y \\&=b\circ \iota_{2,Y}\\&=b\circ p_2\circ \iota_{2,Y}
\end{split}\]
Therefore
\[c\circ p_1=a \qquad c\circ p_2 = b\]

	For uniqueness, suppose that $c':\tpro{D}\to C$ is such that
	\[c'\circ p_1=a \qquad c'\circ p_2 = b\]
Then, for every $X\in \Delta(\der{D})$ we have
\begin{align*}
	c'\circ \iota_X &= \begin{cases}
	c'\circ p_1\circ \iota_{1, X} & X\in \Delta(\der{D}_1)\\
	c'\circ p_2\circ \iota_{2, X} & X\in \Delta(\der{D}_2)
	\end{cases}\\&=\begin{cases}
a\circ \iota_{1, X} & X\in \Delta(\der{D}_1)\\
b\circ \iota_{2, X} & X\in \Delta(\der{D}_2)
	\end{cases}\\&=c_X\\&=c\circ \iota_X
\end{align*}
showing that $c'=c$ as wanted.	

\item Let $a:\lpro \der{\hat{D}}\rpro\to C$ , $b:\lpro \der{D}' \rpro\to C$ be two arrows fitting in the diagram 
	\[\xymatrix{D_{j} \ar[ddrr]^{\iota_{D_j}}\ar[r]^{g_j}\ar[d]_{f_j}& G_{j+1} \ar[r]^{\hat{\iota}_{G_{j+1}}} & \lpro \der{\hat{D}}\rpro \ar@/^.4cm/[dddr]^{a} \ar[dd]^{p_2} \\ G_j \ar[d]_{\iota'_{G_j}}\\ \lpro \der{D}' \rpro \ar@/_.4cm/[rrrd]_{b} \ar[rr]_{p_1}  &&\tpro{D} \ar@{.>}[dr]^{c}\\ &&& C }\] 
	
	We can define a cocone $(C, \{c_X\}_{X\in \Delta(\der{D})})$ putting
		\[c_X:=\begin{cases}
		a\circ \hat{\iota}_{ X} & X\in \Delta(\der{\hat{D}})\\
		b\circ \iota'_{ X} & X\in \Delta(\der{D}')\\
		b\circ \iota'_{G_j} \circ f_j & X=D_j
	\end{cases}\]
	Thus we get a unique arrow $c:\tpro{D}\to C$ such that 
	\[c\circ \iota_X = c_X\]
	Now, for every $X\in  \Delta(\der{D}')$ and $Y\in  \Delta(\der{\hat{D}})$ we have
	\[\begin{split}
		c\circ p_1 \circ \iota'_{X}&=c\circ \iota_{X}\\&=c_X \\&=b\circ \iota'_{X}\\&=b\circ p_1\circ \iota'_{X}
	\end{split}\qquad \begin{split}
		c\circ p_2 \circ \hat{\iota}_{Y}&=c\circ \iota_{Y}\\&=c_Y \\&=a\circ \hat{\iota}_{Y}\\&=a\circ p_2\circ \hat{\iota}_{Y}
	\end{split}\]
	so that we can deduce
	\[c\circ p_1=a \qquad c\circ p_2 = b\]
	
	To see that such $c$ is unique, suppose that $c':\tpro{D}\to C$ is given such that
	\[c'\circ p_1=b \qquad c'\circ p_2 = a\]
	Then, for every $X\in \Delta(\der{D})$ we have
	\begin{align*}
		c'\circ \iota_X &= \begin{cases}
			c'\circ p_1\circ \iota'_{X} & X\in \Delta(\der{D}')\\
			c'\circ p_2\circ \hat{\iota}_{X} & X\in \Delta(\der{\hat{D}})\\
			c'\circ \iota_{D_j} & X=D_j
		\end{cases}\\&=\begin{cases}
		b\circ \iota'_{X} & X\in \Delta(\der{D}')\\
		a\circ \hat{\iota}_{X} & X\in \Delta(\der{\hat{D}})\\
		c'\circ p_1 \circ \iota'_{G_j} \circ f_j  & X=D_j
		\end{cases}\\&= \begin{cases}
		b\circ \iota'_{X} & X\in \Delta(\der{D}')\\
		a\circ \hat{\iota}_{X} & X\in \Delta(\der{\hat{D}})\\
			b\circ \iota'_{G_j} \circ f_j  & X=D_j
		\end{cases}\\&=c_X\\&=c\circ \iota_X
	\end{align*}
	allowing us to deduce that $c'=c$. \qedhere 
	\end{enumerate}
\end{proof}
\begin{corollary}\label{cor:ele}
	Let $\der{D}=\{\dder{D}_{i}\}_{i=0}^n$ be a derivation between $G$ and $H$. Let $j$ and $k$ be two indexes less or equal than $n+1$ and suppose that $j< k$.  Consider two arrows $a:T\to G_j$, $b:T\to G_k$. If $\iota_{G_j}\circ a = \iota_{G_k}\circ b$, 
	then  there exist arrow $c:T\to D_j $  such that \[f_j\circ c = a\qquad \iota_{D_j}\circ c =\iota_{G_k}\circ b\]
	\end{corollary}
\begin{proof} We split the cases.
	\begin{itemize}
		\item $j=0$. Consider $\der{D}_1:=\{\dder{D}_0\}$ and $\der{D}_2:=\{\dder{D}_i\}_{i=1}^n$.  Consider the diagram below in which, by \Cref{rem:zero}, the rectangle on the bottom right is a pushout.
		\[\xymatrix@C= 40pt{T  \ar@/_.6cm/[ddd]_{a}\ar@{.>}[d]^{t}\ar[rr]^{b}&& G_k \ar[d]_{\iota_{2, G_k}} \ar@/^.6cm/[ddd]^{\iota_{G_k}}\\D_{0} \ar[r]^{g_0}\ar[d]^{f_0}& G_{1} \ar[r]^-{\iota_{2,G_{1}}} & \lpro \der{D}_2\rpro \ar[dd]_{p_2} \\ G \ar[drr]^{\iota_G} \ar[d]^{\iota_{1,G}}\\ \lpro \der{D}_1 \rpro \ar[rr]_{p_1}  &&\tpro{D} }\] 
		Since $f_0$ and $\iota_{1,G}$ are in $\mathcal{M}$ the same rectangle is an $\mathcal{M}$-pushout and so, by \Cref{prop:pbpoad} is a pullback and the thesis follows.
		\item   $j\neq 0$. We proceed as in the point above. Using point $4$ of \Cref{lem:colim} we know that the bottom right rectangle in the diagram below is a pushout. 
			\[\xymatrix@C=30pt{T  \ar@/_.6cm/[ddd]_{a}\ar@{.>}[d]^{t}\ar[rr]^{b}&& G_k \ar[d]_{\iota_{2, G_k}} \ar@/^.6cm/[ddd]^{\iota_{G_k}}\\D_{j} \ar[r]^{g_j}\ar[d]^{f_j}& G_{j+1} \ar[r]^-{\hat{\iota}_{G_{j+1}}} & \lpro \der{\hat{D}}\rpro \ar[dd]_{p_2} \\ G_j \ar[d]^{\iota'_{G_j}} \ar[drr]^{\iota_{G_j}}\\ \lpro \der{D}' \rpro \ar[rr]_{p_1}  &&\tpro{D} }\] 
		Point $2$ of \Cref{lem:colim} entails that $\iota'_{G_j}$ is in $\mathcal{M}$, and so is $f_j$ as it is the pushout of $l_j$. Thus the rectangle we are considering is an $\mathcal{M}$-pushout and the thesis follows again from \Cref{prop:pbpoad}. \qedhere
	\end{itemize}
\end{proof}	
	
So equipped, we can introduce the notion of \emph{consistent permutation}.

\begin{definition}\label{def:permcon}
	Let $\X$ be an $\mathcal{M}$-adhesive category and consider a left-linear DPO-rewriting system $(\X, \R)$ on it.  Take two non-empty decorated derivations $(\der{D}, \alpha, \omega)$ and  $(\der{D}', \alpha', \omega')$ such that
	\begin{itemize}
		\item $\der{D}$ and $\der{D}'$ have the same length;
		\item if  $\der{D}$  is a derivation between $G$ and $H$ amd $\der{D}'$ one between $G'$ and $H'$, then $G\simeq G'$ and $H\simeq H'$.
	\end{itemize}
	 	 
	 	If $\der{D}=\{\dder{D}_i\}_{i=0}^n$ and $\der{D}'=\{\dder{D}'_i\}_{i=0}^n$ with assciated squence of rules $r(\der{D})=\{\rho_i\}_{i=0}^n$ and $r(\der{D}')=\{\rho'_i\}_{i=0}^n$, a \emph{consistent permutation} between  $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ is a permutation $\sigma:[0,n]\to [0,n]$  such that, for every $i\in [0,n]$, $\rho_i=\rho'_{\sigma(i)}$ and, moreover, there exists a \emph{mediating isomorphism} $\xi_\sigma:\tpro{D} \to \lpro \der{D}' \rpro$ fitting in the following diagrams, where $m_i, m'_i, h_i$ and $h'_i$ are, respectively, the matches and back-matches of $\dder{D}_i$ and $\dder{D}'_i$.
	\[\xymatrix{\pi(G)\ar[r]^{\alpha} \ar[d]_{\alpha'} & G \ar[r]^{\iota_{G}} &\tpro{D} \ar[d]^{\xi}&   \pi(H) \ar[r]^{\omega} \ar[d]_{\omega'} & H \ar[r]^{\iota_H} &\tpro{D} \ar[d]^{\xi}\\ G' \ar[rr]_{\iota'_{G'}} & &\lpro \der{D}' \rpro& H' \ar[rr]_{\iota'_{H'}} & &\lpro \der{D}' \rpro}\]
\[\xymatrix{L_i \ar[r]^{m_i} \ar[d]_{m'_{\sigma(i)}}& G_i \ar[r]^{\iota_{G_i}} &\tpro{D} \ar[d]^{\xi_\sigma} & R_i \ar[r]^{h_i} \ar[d]_{h'_{\sigma(i)}}& G_{i+1} \ar[r]^{\iota_{G_{i+1}}} &\tpro{D} \ar[d]^{\xi_\sigma} \\G'_{\sigma(i)} \ar[rr]_{\iota'_{G'_{\sigma(i)}}}&& \lpro \der{D}' \rpro& G'_{\sigma(i)+1} \ar[rr]_{\iota'_{G'_{\sigma(i)+1}}}&& \lpro \der{D}' \rpro}\]
\end{definition}

\begin{remark}
The commutativity of the last two rectangles in \Cref{def:permcon}, is equivalent to the commutativity of the following bigger diagram.		
\[\xymatrix@C=40pt@R=10pt{ &&&R_{i}\ar[dddr]^{h'_{\sigma(i)}} \ar[dddl]_{h_i}|(.67)\hole\\&&K_i \ar[dl]_{l_i} \ar[ur]^{r}\ar[dddr]^{k'_{\sigma(i)}} \ar[dddl]_{k_i}|(.67)\hole\\&L_i\ar[dddr]_(.6){m'_{\sigma(i)}} \ar[dddl]_{m_i}\\&&G_{i+1}  \ar@/^.3cm/[dddl]|(.35)\hole^(.7){\iota_{G_{i+1}}}&& G'_{\sigma(i)+1}\ar@/^.3cm/[dddl]^{\iota'_{G'_{\sigma(i)+1}}}\\ & D_i \ar[dd]_{\iota_{D_i}}\ar[ur]^(.6){g_i}  \ar[dl]_{f_i}&& D'_\sigma(i) \ar[dd]^{\iota'_{D'_\sigma(i)}} \ar[ur]^{g'_{\sigma(i)}}\ar[dl]_{f'_{\sigma(i)}}\\ G_i \ar@/_.3cm/[dr]_{\iota_{G_i}} && G'_{\sigma(i)}\ar@/_.3cm/[dr]^{\iota'_{G'_{\sigma(i)}}}\\& \tpro{D} \ar[rr]_{\xi_\sigma}&& \lpro \der{D}' \rpro}\]

Indeed,  to prove the commutativity of the central pentagon we can compute to get:
\begin{align*}
	\xi_\sigma \circ \iota_{D_i}\circ k_i&=\xi_\sigma \circ \iota_{G_{i}} \circ f_i\\&= \xi_\sigma \circ \iota_{G_{i}}\circ m_i \circ l_i\\&=\iota_{G'_{\sigma(i)}}\circ m'_i\circ l_i\\&=\iota_{G'_{\sigma(i)}}\circ f'_{\sigma(i)}\circ k'_i\\&=\iota_{D'_\sigma(i)}\circ k_i'
\end{align*}
\end{remark}

\begin{remark}\label{rem:coproj}
Notice that, in particular, the previous diagram entails
		\[\xi_\sigma \circ \iota_{L_i}=\iota'_{L_{\sigma(i)}} \quad \xi_\sigma \circ \iota_{K_i}=\iota'_{K_{\sigma(i)}} \quad \xi_\sigma \circ \iota_{R_i}=\iota'_{R_{\sigma(i)}} \]
\end{remark}

\begin{remark}\label{rem:inversa}
Let $\sigma:[0,n]\to [0,n]$ be a consistent permutation between $(\der{D},\alpha, \omega)$ and $(\der{D}', \alpha', \omega')$, then $\sigma^{-1}$ is a consistent permutation between $(\der{D}', \alpha', \omega')$ and $(\der{D},\alpha, \omega)$: indeed, it is enough to consider, as mediating isomorphism, the inverse $\xi^{-1}_\sigma$ of $\xi_\sigma$.
\end{remark}

\begin{remark}\label{rem:comp} Consistent permutations can be composed. Indeed, given decorated derivations $(\der{D}, \alpha, \omega)$, $(\der{D}', \alpha', \omega')$ and $(\der{\hat{D}}, \hat{\alpha}, \hat{\omega})$, if $\sigma$ is a consistent permutation between the first two and $\sigma'$ one between the second and the third, then  we have diagrams
	\[\xymatrix@C=18pt{ & G \ar[rr]^{\iota_{G}} &&\tpro{D} \ar[d]^{\xi_\sigma}&  &  H \ar[rr]^{\iota_H} &&\tpro{D} \ar[d]^{\xi_\sigma} \\ \pi(G) \ar@/_.2cm/[dr]_{\hat{\alpha}}\ar@/^.2cm/[ur]^{\alpha} \ar[r]^{\alpha'} &G' \ar[rr]^{\iota'_{G'}}  &&\lpro \der{D}'  \rpro \ar[d]^{\xi_{\sigma'}}&\pi(H)\ar@/_.2cm/[dr]_{\hat{\omega}}\ar@/^.2cm/[ur]^{\omega} \ar[r]^{\omega'} & H' \ar[rr]^{\iota'_{H'}} && \lpro \der{D}' \rpro \ar[d]^{\xi_{\sigma'}}\\ &\hat{G}  \ar[rr]_{\hat{\iota}_{\hat{G}}}&& \lpro \hat{\der{D}}\rpro  && \hat{H} \ar[rr]_{\hat{\iota}_{\hat{H}}}&& \lpro \hat{\der{D}} \rpro \\& G_i \ar[rr]^{\iota_{G_i}} &&\tpro{D} \ar[d]^{\xi_\sigma}&  &  G_i \ar[rr]^{\iota_{G_i}} &&\tpro{D} \ar[d]^{\xi_\sigma} \\ L_i \ar@/_.2cm/[dr]_{\hat{m}_{\sigma'(\sigma(i))}}\ar@/^.2cm/[ur]^{m_i} \ar[r]^{m'_{\sigma(i)}} &G'_{\sigma(i)} \ar[rr]^{\iota'_{G'_{\sigma(i)}}}  &&\lpro \der{D}'  \rpro \ar[d]^{\xi_{\sigma'}}&R_i \ar@/_.2cm/[dr]_{\hat{h}_{\sigma'(\sigma(i))}}\ar@/^.2cm/[ur]^{h_i} \ar[r]^{h'_{\sigma(i)}} & G'_{\sigma(i)} \ar[rr]^{\iota'_{G'_{\sigma(i)}}} && \lpro \der{D}' \rpro \ar[d]^{\xi_{\sigma'}}\\ &\hat{G}_{\sigma'(\sigma(i))}  \ar[rr]_-{\hat{\iota}_{\hat{G}_{\sigma'(\sigma(i))}}}&& \lpro \hat{\der{D}}\rpro  && \hat{G}_{\sigma'(\sigma(i))} \ar[rr]_-{\hat{\iota}_{\hat{G}_{\sigma'(\sigma(i))}}}&& \lpro \hat{\der{D}} \rpro	}\]
	We deduce at once that $\sigma'\circ \sigma$ is a consistent permutation with mediating isomorphism given by $\xi_{\sigma'} \circ \xi_\sigma$.
\end{remark}

\begin{example} Let $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ be two abstraction equivalent non-empty decorated derivations of length $n+1$. Then the identity permutation $\id{[0,n]}$ is a consistent permutation between them. In such a case $\xi_{\id{[0,n]}}$ is simply the isomorphism induced by any family $\{\phi^i\}_{i=0}^n$ witnessing $(\der{D}, \alpha, \omega)\equiv^a (\der{D}', \alpha', \omega')$.
\end{example}

\begin{example}\todo{esempi di cose consistenti utile per \cref{ex:contro}}
\end{example}


\begin{proposition}\label{prop:uniqu}
	Let $\sigma,\sigma':[0,n]\rightrightarrows [0,n]$ be two consistent permutations between $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$.  Then the following hold true:
	\begin{enumerate}
	\item $\xi_\sigma \circ \iota_{G_0} = \xi_{\sigma'} \circ \iota_{G_0}$;
	\item  $\xi_\sigma \circ \iota_{G_i}=\xi_{\sigma'} \circ \iota_{G_i}$ for every index $i\in [0,n]$ such that $\sigma_{|[0,i]}=\sigma'_{|[0,i]}$.
	\end{enumerate}
\end{proposition}
\begin{proof}\begin{enumerate}
		\item This follows at once noticing that both $\xi_\sigma \circ \iota_{G_0}$ and $\xi_{\sigma'} \circ \iota_{G_0}$ are equal to $\iota'_{G'_0}\circ \alpha'\circ \alpha^{-1}$.
		\item  If $\sigma(0)\neq \sigma'(0)$ there is nothing to show. Otherwise, let $j$ be the maximum of the set
		\[\{i\in [0,n]\mid \sigma_{|[0,i]}=\sigma'_{|[0,i]}\}\]
		We proceed by induction on $i\in [0,j]$. 
		\begin{itemize}
			\item If $i=0$ the thesis follows from point $1$.
			\item If $i>0$, we know that there is a pushout square
			\[\xymatrix{K_{i-1}\ar[r]^{r_{i-1}} \ar[d]_{k_{i-1}}& R_{i-1} \ar[d]^{h_{i-1}}\\ D_{i-1} \ar[r]_{g_{i-1}}& G_i}\] 
			By \Cref{rem:coproj} we know that
			\begin{align*}
				\xi_\sigma \circ \iota_{G_i}\circ h_{i-1}&=  \xi_\sigma\circ \iota_{R_{i-1}}\\&=\iota'_{R_{\sigma(i-1)}}\\&=\iota'_{R_{\sigma'(i-1)}}\\&=\xi_{\sigma'}\circ \iota_{R_{i-1}}\\&=\xi_{\sigma'} \circ \iota_{G_i}\circ h_{i-1}
			\end{align*}
			But, by the induction hypothesis we also have
			\begin{align*}
				\xi_\sigma \circ \iota_{G_i}\circ g_{i-1}&=\xi_{\sigma}\circ \iota_{D_{i-1}}\\&=\xi_{\sigma}\circ \iota_{G_{i-1}} \circ f_{i-1}\\&=\xi_{\sigma'}\circ \iota_{G_{i-1}} \circ f_{i-1}\\&=\xi_{\sigma'}\circ \iota_{D_{i-1}} \\&=\xi_{\sigma'}\circ \iota_{G_{i}} \circ g_{i-1}
			\end{align*}
			The thesis now follows.			\qed
		\end{itemize}
	\end{enumerate}
\end{proof}

Now, notice that, given a consistent permutation $\sigma$, $\xi_\sigma:\tpro{D}\to \lpro \der{D}'\rpro$, we already know, by \Cref{rem:coproj} that
\[\xi_\sigma \circ \iota_{L_i}=\iota'_{L_{\sigma(i)}} \quad \xi_\sigma \circ \iota_{K_i}=\iota'_{K_{\sigma(i)}} \quad \xi_\sigma \circ \iota_{R_i}=\iota'_{R_{\sigma(i)}} \]
	Moreover, for $\xi_\sigma \circ \iota_{D_i}$ must be $\xi_\sigma \circ \iota_{G_i}\circ f_i$. Thus it is enough to define $\xi_{\sigma} \circ \iota_{G_i}$ for every $i\in [0, n]$. But then \Cref{prop:uniqu} entails the following.
\begin{corollary} Given a consistent permutation $\sigma$ between  $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$, the mediating isomorphism $\xi_\sigma:\tpro{D}\to \lpro \der{D}'\rpro$ is unique.
\end{corollary}


\begin{proposition}\label{prop:sum}
\todo{il caso in cui sigma si decomponga come due permu}
\end{proposition}
\begin{proof}
	contenuto...\qedhere 
\end{proof}

We are now ready to prove the central result of this section. 

\begin{lemma} Let $(\X,R)$ be a left-linear DPO-rewriting system. Consider two consistent permutation $\sigma,\sigma':[0,n]\rightrightarrows [0,n]$ between $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$. Suppose that $\sigma\neq \sigma'$ and let $j$ be the minimum index such that $\sigma(j)\neq \sigma'(j)$. Let also $r(\der{D})$ be $\{\rho_i\}_{i=0}^n$. Then the following hold true:
	\begin{enumerate}
		\item if $j=0$, then the rule $\rho_0$ is not consuming;
		\item if $j\neq 0$ then the rule $\rho_{j-1}$ is not consuming.
	\end{enumerate}
\end{lemma}
\begin{proof}\begin{enumerate}
		\item Let $k$ be $\sigma^{-1}(\sigma'(0))$ and notice that, since $\sigma(0)\neq \sigma'(0)$, then $0< k$.  By  the first point of  \Cref{prop:uniqu} we can consider the diagram
		\[\xymatrix@C=40pt{& L_0 \ar[d]_{m'_{\sigma'(0)}} \ar@/^.2cm/[dr]^{m_{k}} \ar@/_.2cm/[dl]_{m_{0}} \\G_{0} \ar@/_.2cm/[drr]_(.3){\iota_{G_0}}|(.515)\hole \ar[d]_{\iota_{G_0}}& G'_{\sigma'(0)} \ar[d]^{\iota_{G'_{\sigma'(0)}}} & G_{k} \ar[d]^{\iota_{G_k}}\\ \tpro{D} \ar[r]_{\xi_{\sigma'}} & \lpro \der{D'}\rpro & \tpro{D} \ar[l]^{\xi_{\sigma}}}\]
	From \Cref{cor:ele}, we can conclude that there exists $c:L_0\to D_0$ such that $f_0\circ c=m_0$. We thus have the solid part of the commutative diagram below.
		\[\xymatrix{L_0 \ar@/^.3cm/[drr]^{\id{L_0}} \ar@{.>}[dr]_{t} \ar@/_.3cm/[ddr]_{c}\\ & K_0 \ar[d]_{k_0}\ar[r]^{l_0}& L_0 \ar[d]^{m_0} \\& D_0 \ar[r]_{f_0} & G_0} \]
		The internal square is an $\mathcal{M}$-pushout and thus a pullback, by \Cref{prop:pbpoad}, so that we have the existence of the dotted $t:L_0\to K_0$. Therefore $\id{L_0}=l_0\circ t$, proving that $l_0$ is an epimorphism. The thesis now follows from \Cref{cor:rego}.  
		\item  Let $k$ be $\sigma^{-1}(\sigma'(j-1))$ and notice that $\rho_{j-1}=\rho_k$. By definition of $j$, $\sigma_{|[0,j-1]}=\sigma'_{|[0,j-1]}$, thus the second point of \Cref{prop:unique} yields the diagram
			\[\xymatrix@C=40pt{& L_{j-1} \ar[d]_{m'_{\sigma'(j-1)}} \ar@/^.2cm/[dr]^{m_{k}} \ar@/_.2cm/[dl]_{m_{j-1}} \\G_{j-1} \ar@/_.2cm/[drr]_(.3){\iota_{G_{j-1}}}|(.515)\hole \ar[d]_{\iota_{G_{j-1}}}& G'_{\sigma'(j-1)} \ar[d]^{\iota_{G'_{\sigma'(j-1)}}} & G_{k} \ar[d]^{\iota_{G_k}}\\ \tpro{D} \ar[r]_{\xi_{\sigma'}} & \lpro \der{D'}\rpro & \tpro{D} \ar[l]^{\xi_{\sigma}}}\]
			Let $a$ be $\min(j-1, k)$, by \Cref{cor:ele},  there exists $c:L_{j-1}\to D_a$ such that $f_a\circ c=m_a$. As before this yields the solid part of the following diagram
			\[\xymatrix{L_{j-1} \ar@/^.3cm/[drr]^{\id{L_{j-1}}} \ar@{.>}[dr]_{t} \ar@/_.3cm/[ddr]_{c}\\ & K_{j-1} \ar[d]_{k_a}\ar[r]^{l_{j-1}}& L_{j-1} \ar[d]^{m_a} \\& D_a \ar[r]_{f_a} & G_a} \]
			The existence of the dotted $t:L_{j-1}\to K_{j-1}$ follows from  \Cref{prop:pbpoad} and we can conclude. \qed
	\end{enumerate}
\end{proof}

\begin{corollary}\label{cor:unique}
Let $(\X,R)$ ba left-linear DPO-rewriting system and suppose that every rule in $R$ is consuming. For every two non-empty decorated derivations $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$, there exists at most one consistent permutation between them.
\end{corollary}


\begin{corollary}\label{cor:dec}
	\todo{prefisso e suffisso}
\end{corollary}
\begin{proof}
	contenuto...\qedhere 
\end{proof}

\section{Shift equivalence and traces}
\todo{A VERY NICE INTRO}

\subsection{Sequentially independent and switchable derivations}
\todo{A VERY NICE INTRO}

\begin{definition}  Let $(\X, \R)$ be a left-linear DPO-rewriting system with $\X$ an $\mathcal{M}$-adhesive category. Let also $\dder{D}:G\Mapsto H$ and $\dder{D'}:H\Mapsto T$ be the two direct derivations depicted below.

\[\xymatrix{L \ar[d]_{n}& K \ar[d]^{k}\ar[l]_{l} \ar[r]^{r} & R \ar[d]^{h} & L' \ar[d]_{n'}& K' \ar[d]^{k'}\ar[l]_{l'} \ar[r]^{r'} & R' \ar[d]^{h'}\\G & \ar[l]^{f} D \ar[r]_{g}& H & H & \ar[l]^{f'} D' \ar[r]_{g'}& T}\]

An \emph{independence pair} between $\dder{D}$ and $\dder{D'}$, is a pair of  arrows $i_1:R\to D'$ and $i_2:L'\to D$ such that the following diagram commutes.

\[\xymatrix@C=15pt{L \ar[d]_{n}&& K \ar[d]_{k}\ar[ll]_{l} \ar[r]^{r} & R \ar@/^.35cm/@{.>}[drrr]|(.3)\hole_(.4){i_1} \ar[dr]|(.3)\hole_{h} && L' \ar@/_.35cm/@{.>}[dlll]^(.4){i_2} \ar[dl]|(.3)\hole^{n'}& K' \ar[d]^{k'}\ar[l]_{l'} \ar[rr]^{r'} && R' \ar[d]^{h'}\\G && \ar[ll]^{f} D \ar[rr]_{g}&& H  && \ar[ll]^{f'} D' \ar[rr]_{g'}&& T}\]
We will say that $\dder{D}$ and $\dder{D'}$ are \emph{weakly sequentially independent} if an independence pair exists. If such independence pair is unique we will say that $\dder{D}$ and $\dder{D'}$ are \emph{sequentially independent}.
\end{definition}

\begin{example}
	\todo{sequential independence}
\end{example}
\begin{example}
	\todo{sequential independence che serva anche per es successivo}
\end{example}

\begin{remark}\label{rem:weak} Let $(i_1, i_2)$ and $(j_1, j_2)$ be independence pairs for the direct derivations $\dder{D}$ and $\dder{D'}$. Notice that, by definition, we have
	\begin{align*}f'\circ i_1&=h\\&=f'\circ j_1
	\end{align*}
	On the other hand, 
	 $f':D'\to H$ is  the pushout of $l':K'\to L'$ and so it is in $\mathcal{M}$, implying $j_1=i_1$. If, moreover, we suppose that the rule $\rho$ applied in $\dder{D}$ is linear, then $g:D\to H$ is in $\mathcal{M}$ too, hence, from the equation
	 \begin{align*}
	 g\circ i_2&=h \\&= g\circ j_2
	 \end{align*}
we can deduce that $i_2=j_2$, too.

Summing up, if $(\X, \R)$ is a linear DPO-rewriting system, then sequential independence and weak sequential independence coincide. 
\end{remark}



When working with linear rewriting systems, (weakly) sequential independent direct derivations can be switched, producing two new (weakly) sequential independent direct derivations between the same objects \cite[Thm.~$7.7$]{lack2005adhesive} . This is no more the case if the rules are only left-linear, as shown by the next example.

\begin{example}\label{ex:difficile}
	\todo{pensare ad un esempio in cui l'indipendenza non basta }
\end{example}

To fix this problem, we adapt the notion of \emph{canonical filler} from \cite{heindel2009category}.

\begin{definition}\label{def:filler}
Let $(\X, \R)$ be a left-linear DPO-rewriting system with $\X$ $\mathcal{M}$-adhesive. Let also $\dder{D}:G\Mapsto H$ and $\dder{D}':H\Mapsto T$ be the two derivations depicted below.
\[\xymatrix{L \ar[d]_{n}& K \ar[d]^{k}\ar[l]_{l} \ar[r]^{r} & R \ar[d]^{h} & L' \ar[d]_{n'}& K' \ar[d]^{k'}\ar[l]_{l'} \ar[r]^{r'} & R' \ar[d]^{h'}\\G & \ar[l]^{f} D \ar[r]_{g}& H & H & \ar[l]^{f'} D' \ar[r]_{g'}& T}\]
Since $f'$ is in $\mathcal{M}$, we can moreover consider a pullback square
\[\xymatrix{P \ar[r]^{p} \ar[d]_{p'}& D\ar[d]^{g} \\ D' \ar[r]_{f'} & H}\]

A \emph{filler} between $\dder{D}$ and $\dder{D}'$ is  given by a pair of arrows $u:K\to P$ and $u':K'\to P$ satisfying the following conditions
\begin{enumerate}
	\item $p\circ u = k$, $p'\circ u' = k'$ and there exists a pushout square
\[\xymatrix{K' \ar[r]^{r'} \ar[d]_{u'}& R'\ar@{.>}[d]^{j'} \\ P \ar@{.>}[r]_{q'} & Q'}\]
	\item  there exist arrows $i_1:R\to D'$, $i_2:L'\to D$ satisfying $f'\circ i_1=h$, $g\circ i_2=n'$ and such that the following squares are pushouts
\[\xymatrix{K \ar[r]^{r} \ar[d]_{u}& R \ar@{.>}[d]^{i_1} &K' \ar[r]^{l'} \ar[d]_{u'}& L'\ar@{.>}[d]^{i_2} \\P \ar[r]_{p'}& D' & P \ar[r]_{p} & D}\]
\end{enumerate}
\end{definition}

\begin{remark}\label{rem:deco} Let $\dder{D}$ and $\dder{D'}$ be two switchable direct derivations. Then the existence of a filler allows us to build the solid part of the diagram below.
	\[\xymatrix{&&R \ar@/_1cm/[ddrr]_(.35){i_1}|(.7)\hole  \ar[dr]^{h}&& L'\ar@/^1cm/[ddll]^(.35){i_2}  \ar[dl]_{n'}\\&K\ar[dr]^{k}\ar[dl]_{l} \ar@/_.8cm/[ddrr]^(.65){u}\ar[ur]^{r}&& H && K' \ar@/^.8cm/[ddll]_(.65){u'}\ar[dl]_{k'}\ar[lu]_{l'} \ar[dr]^{r'}\\L \ar[dr]_{n} \ar@{.>}@/_.8cm/[ddrr]_{j}&& D \ar[dl]|(.42)\hole_(.64){f}\ar[ur]|(.48)\hole^(.7){g}&&D' \ar[dr]|(.42)\hole^(.65){g'} \ar[ul]|(.48)\hole_(.7){f'}&&R'\ar@/^.8cm/[ddll]^{j'}\ar[dl]^{h'}\\&G &&P\ar[dr]^{q'} \ar@{.>}[dl]_{q}\ar[ur]^(.4){p'}\ar[ul]_(.4){p}&&T\\&&Q \ar@{.>}[ul]_{s} &&Q'\ar@{.>}[ur]^{t}}\]
	
	Let us complete this diagram defining the dotted arrows. We can start noticing that, since $l\in \mathcal{M}$, there exists a pushout square 
	\[\xymatrix{K \ar[r]^{l} \ar[d]_{u}& L\ar[d]^{j} \\ P \ar[r]_{q} & Q}\]
	Moreover, the existence of the wanted $s:Q\to G$ and $t:Q'\to T$ follows from the following equalities
	\[\begin{split}
		f\circ p \circ u &= f\circ k \\&= n\circ l
	\end{split} \qquad \begin{split}
		g'\circ p'\circ u' &= g'\circ k'\\&=h'\circ r'
	\end{split}\]
	
	We can prove some other properties of the arrows appearing in the diagram above. The three rectangles below are pushouts and their left halves are pushouts too. Therefore, by \Cref{lem:po1}, also their right halves are pushouts.
	\[\xymatrix{K \ar@/^.4cm/[rr]^{u}\ar[d]_{r}\ar[r]_{u} &P\ar[d]^{p'} \ar[r]_{p} & D \ar[d]^{g}&K' \ar@/^.4cm/[rr]^{k'}\ar[d]_{l'}\ar[r]_{u'} &P\ar[d]^{p} \ar[r]_{p'} & D' \ar[d]^{f'}\\  R \ar@/_.4cm/[rr]_{h} \ar[r]^{i_1}&D' \ar[r]^{f'} & H&L' \ar@/_.4cm/[rr]_{n'} \ar[r]^{i_2}&D \ar[r]^{g} & H}\]
	\[ \xymatrix{K \ar@/^.4cm/[rr]^{k}\ar[d]_{l}\ar[r]_{u} &P\ar[d]^{q} \ar[r]_{p} & D \ar[d]^{f}&K' \ar@/^.4cm/[rr]^{k'}\ar[d]_{r'}\ar[r]_{u'} &P\ar[d]^{q'} \ar[r]_{p'} & D' \ar[d]^{g'}\\ L \ar@/_.4cm/[rr]_{n} \ar[r]^{j}&Q \ar[r]^{s} & G&R' \ar@/_.4cm/[rr]_{h'} \ar[r]^{j'}&Q' \ar[r]^{t} & T}\]
	
	Notice, moreover, that $p, q$ are the pushouts of $l'$ and $l$, respectively, thus they  are elements of $\mathcal{M}$. By \Cref{prop:pbpoad} the squares
	\[\xymatrix{P\ar[r]^{p} \ar[d]_{p'} & D \ar[d]^{g}& P \ar[r]^{p} \ar[d]_{q} &D\ar[d]^{f}\\ D' \ar[r]_{f'} & H & Q \ar[r]_{s}& G}\]
	are pullbacks too.
\end{remark}


Notice that if there is a filler between  $\dder{D}$ and $\dder{D}'$ are switchable, then they are weakly sequentially independent: indeed, if a filler between them exists, then $(i_1, i_2)$ is an independence pair. On the other hand, \Cref{ex:difficile} shows that not every independence pair arises in this way.

\begin{definition} Let  $\dder{D}:H\Mapsto H$, $\dder{D}':H\Mapsto T$ be two direct derivations in a left-linear DPO-rewriting system  $(\X, \R)$. An independence pair $(i_1, i_2)$ between $\dder{D}$ and $\dder{D}'$ is \emph{good} if there exists a filler $(u,u')$ between them such that  the squares below are pushouts.\[\xymatrix{K \ar[r]^{r} \ar[d]_{u}& R \ar[d]^{i_1} &K' \ar[r]^{l'} \ar[d]_{u'}& L'\ar[d]^{i_2} \\P \ar[r]_{p'}& D' & P \ar[r]_{p} & D}\]
	
We will say that $\dder{D}$ and $\dder{D}'$ are \emph{switchable} if a good independence pair between them exists. If such a pair is unique, we will say that $\dder{D}$ and $\dder{D}'$ are \emph{uniquely switchable}. We will use the notation $\dder{D}\updownarrow \dder{D'}$ to mean that $\dder{D}$ and $\dder{D}'$ are switchable, while $\dder{D}\updownarrow_! \dder{D'}$ will denote that they are uniquely so.


If every independence pair is good we will say that $(\X, \R)$ is \emph{tame}.
\end{definition}

\begin{remark}\label{rem:unic} Given a good independence pair $(i_1, i_2)$ between $\dder{D}$ and $\dder{D}'$, there is a unique filler  such that $(u,u')$ such that 
	\[\xymatrix{K \ar[r]^{r} \ar[d]_{u}& R \ar[d]^{i_1} &K' \ar[r]^{l'} \ar[d]_{u'}& L'\ar[d]^{i_2} \\P \ar[r]_{p'}& D' & P \ar[r]_{p} & D}\]
	are pushouts. Indeed, for every other filler $(v,v')$, it must be that
	\[\begin{split}
		p\circ u &=k \\&= p\circ v
	\end{split}\qquad \begin{split}
	p\circ u' &= i_2\circ l' \\&= p\circ v'
	\end{split}\]
	Since the arrow $p:P\to D$, which is the pullback of $f'$, is in $\mathcal{M}$ we conclude that $(u,u')=(v,v')$.
\end{remark}

\begin{remark}Clearly in a tame left-linear DPO-rewriting system two direct derivations are sequentially independent if and only if they are unquely switchable.
\end{remark}

A source of tame left-linear DPO-rewriting systems is given by the linear ones, as shown by the following proposition.

\begin{proposition}\label{prop:equi}Every linear DPO-rewriting system $(\X, \R)$ is tame.
 \end{proposition}
\begin{proof} Suppose that $\X$ is $\mathcal{M}$-adhesive and let $(i_1, i_2)$ be an independence pair between $\dder{D}:G\Mapsto H$ and $\dder{D}':H\Mapsto T$. We have a diagram
	\[\xymatrix@C=15pt{L \ar[d]_{n}&& K \ar[d]_{k}\ar[ll]_{l} \ar[r]^{r} & R \ar@/^.35cm/[drrr]|(.3)\hole_(.4){i_1} \ar[dr]|(.3)\hole_{h} && L' \ar@/_.35cm/[dlll]^(.4){i_2} \ar[dl]|(.3)\hole^{n'}& K' \ar[d]^{k'}\ar[l]_{l'} \ar[rr]^{r'} && R' \ar[d]^{h'}\\G && \ar[ll]^{f} D \ar[rr]_{g}&& H  && \ar[ll]^{f'} D' \ar[rr]_{g'}&& T}\]
Pulling back $g$ along $f'$, we get another diagram 
	\[\xymatrix{&&R \ar@/_1cm/[ddrr]_(.35){i_1}|(.7)\hole \ar[dr]^{h}&& L'\ar@/^1cm/[ddll]^(.35){i_2}  \ar[dl]_{n'}\\&K\ar[dr]^{k}\ar[dl]_{l} \ar@{.>}@/_.8cm/[ddrr]^(.65){u}\ar[ur]^{r}&& H && K' \ar@{.>}@/^.8cm/[ddll]_(.65){u'}\ar[dl]_{k'}\ar[lu]_{l'} \ar[dr]^{r'}\\L \ar[dr]_{n} && D \ar[dl]|(.42)\hole_(.64){f}\ar[ur]|(.48)\hole^(.7){g}&&D' \ar[dr]|(.42)\hole^(.65){g'} \ar[ul]|(.48)\hole_(.7){f'}&&R'\ar[dl]^{h'}\\&G &&P\ar[ur]^(.4){p'}\ar[ul]_(.4){p}&&T}\] 
Now, if we compute we get
\[\begin{split}
	f'\circ i_1\circ r &= h\circ r \\&= g\circ k
\end{split}\qquad \begin{split}
g\circ i_2\circ l' &= n'\circ l'\\&=f'\circ k'
\end{split}\]
Therefore the two dotted arrows $u:K\to P$ and $u':K'\to P$ exist. We have to show that they satisfy the two conditions in the definition of a filler. 
\begin{enumerate}
	\item  By construction $p\circ u = k$ and $p'\circ u'=k'$. Since $(\X, \R)$ is linear, then $r':K'\to R'$ belongs to $\mathcal{M}$, thus it admits a pushout along $u':K'\to P$, as wanted.
	\item Take the following two rectangles
\[\xymatrix{K \ar@/^.4cm/[rr]^{u}\ar[d]_{r}\ar[r]_{u} &P\ar[d]^{p'} \ar[r]_{p} & D \ar[d]^{f}&K' \ar@/^.4cm/[rr]^{k'}\ar[d]_{l'}\ar[r]_{u'} &P\ar[d]^{p} \ar[r]_{p'} & D' \ar[d]^{f'}\\  R \ar@/_.4cm/[rr]_{h} \ar[r]^{i_1}&D' \ar[r]^{f'} & H&L' \ar@/_.4cm/[rr]_{n'} \ar[r]^{i_2}&D \ar[r]^{g} & H}\]
	By hypothesis $r$ and $l'$ are in $\mathcal{M}$, thus $f'$ and $g$ belong to it too. The first point of \Cref{lem:popb}  yields the thesis. \qedhere 
\end{enumerate}
\end{proof}

\begin{remark} \cite{baldan2011adhesivity} identifies a large class of (quasi)adhesive categories with the property that every left linear DPO-rewriting system on them is tame. We adapt these results to our context in \Cref{app:fill}. 
\end{remark}

We are now going to justify the choice of the name for the relation $\updownarrow$, showing that two switchable direct derivations $\dder{D}$ and $\dder{D'}$ can be actually switched. 

Let $(i_1, i_2)$ be a good independence pair and consider the following diagram: the solid part exists by the definition of a filler, while the two new dotted arrows $v:Q\to J$ and $v':Q'\to J$ are obtained  as the pushout of $q:P\to Q$, which is in $\mathcal{M}$ by \Cref{rem:deco}, along $q':P\to Q'$.
	\[\xymatrix{&&R \ar@/_1cm/[ddrr]_(.35){i_1}|(.7)\hole \ar[dr]^{h}&& L'\ar@/^1cm/[ddll]^(.35){i_2}  \ar[dl]_{n'}\\&K\ar[dr]^{k}\ar[dl]_{l} \ar@/_.8cm/[ddrr]^(.65){u}\ar[ur]^{r}&& H && K' \ar@/^.8cm/[ddll]_(.65){u'}\ar[dl]_{k'}\ar[lu]_{l'} \ar[dr]^{r'}\\L \ar[dr]_{n} \ar@/_.8cm/[ddrr]_{j}&& D \ar[dl]|(.42)\hole_(.64){f}\ar[ur]|(.48)\hole^(.7){g}&&D' \ar[dr]|(.42)\hole^(.65){g'} \ar[ul]|(.48)\hole_(.7){f'}&&R'\ar@/^.8cm/[ddll]^{j'}\ar[dl]^{h'}\\&G &&P\ar[dr]^{q'} \ar[dl]_{q}\ar[ur]^(.4){p'}\ar[ul]_(.4){p}&&T\\&&Q \ar[ul]_{s}\ar@{.>}[dr]_{v} &&Q'\ar[ur]^{t} \ar@{.>}[dl]^{v'}\\&&&J}\]
	
	Since, by \Cref{rem:deco}, all the curved rectangles are pushouts, as well as the bottom square, we can state the following definition.
\begin{definition}\label{def:switch}
	Let $(\X,R)$ be a left-linear DPO-rewriting system and suppose that $\X$ is $\mathcal{M}$-adhesive. Given a good independence pair $(i_1, i_2)$ between $\dder{D}:G\Mapsto H$ and $\dder{D}':H\Mapsto T$, if $(u,u')$ is the associate filler, we define other two direct derivations $S_{i_1,i_2}(\dder{D}'):G\Mapsto J$ and $S_{i_1,i_2}(\dder{D}):J\Mapsto T$ as follows:
		\[\xymatrix{L' \ar[d]_{f\circ i_2}& \ar[l]_{l'}K'\ar[d]_{q\circ u'} \ar[r]^{r'} & R' \ar[d]_{v'\circ j'} & L \ar[d]_{v\circ j} & \ar[l]_{l}K \ar[d]^{q'\circ u}\ar[r]^{r}& R \ar[d]^{g'\circ i_1}\\
		G &\ar[l]^{s} Q \ar[r]_{v}& J&J & \ar[l]^{v'}Q' \ar[r]_{t} & T}\]
	The \emph{switching} $\sder{D}{D'}$ of $\dder{D}$ and $\dder{D'}$ is the derivation $S_{i_1,i_2}(\dder{D}')\cdot S_{i_1,i_2}(\dder{D})$.
\end{definition}

\begin{remark}\label{rem:pbsalva}
Let $(i_1,i_2)$ be a good independence pair between the derivation $\dder{D}:G\Mapsto H$ and $\dder{D}':H\Mapsto T$.  Let also $\der{\hat{D}}$ be the derivation consisting only in $S_{i_1,i_2}(\dder{D})$. We have a diagram 
\[\xymatrix{P\ar[r]^{q}  \ar[d]_{p}& Q \ar[r]^{v} \ar[d]^{s}& J \ar[r]^{\hat{\iota}_J}& \lpro \der{\hat{D}} \rpro \ar[d]^{\hat{p}}  \\D	\ar[r]_{f} &G \ar[rr]_{\iota_{G}}&& \lpro S_{i_1, i_2}(\dder{D}, \dder{D}')\rpro}\]
By \Cref{rem:zero,rem:deco}, its two halves are pullbacks and so, by \Cref{lem:pb1} the whole rectangle is a pullback too. Moreover, notice that
\begin{align*}
	\hat{\iota}_J\circ v \circ q &= \hat{\iota}_J\circ v'\circ q'\\&= \hat{\iota}_{Q'}\circ q'
\end{align*}
which entails that the rectangle below is a pullback too.
\[\xymatrix{P\ar[r]^{q'}  \ar[d]_{p}& Q' \ar[r]^{\hat{\iota}_{Q'}}& \lpro \der{\hat{D}} \rpro \ar[d]^{\hat{p}}  \\D	\ar[r]_{f} &G \ar[r]_-{\iota_{G}}& \lpro S_{i_1, i_2}(\dder{D}, \dder{D}')\rpro}\]
\end{remark}

\begin{remark}\label{rem:indip}Notice that $(j', j)$ is an independence pair for $S_{i_1,i_2}(\dder{D}')$ and $S_{i_1,i_2}(\dder{D})$. This is witnessed by the following diagram, commutative by construction.
	\[\xymatrix@C=15pt{L' \ar[d]_{f\circ i_2}&& K' \ar[d]_{q\circ u'}\ar[ll]_{l'} \ar[r]^{r'} & R' \ar@/^.35cm/[drrr]_(.4){j'}|(.285)\hole \ar[dr]|(.28)\hole_{v'\circ j'} && L \ar@/_.35cm/[dlll]^(.4){j} \ar[dl]|(.28)\hole^{v\circ j}& K \ar[d]^{q'\circ u}\ar[l]_{l} \ar[rr]^{r} && R \ar[d]^{g'\circ i_1}\\G && \ar[ll]^{s} Q \ar[rr]_{v}&& J  && \ar[ll]^{v'} Q' \ar[rr]_{t}&& T}\]
\end{remark} 
 
\begin{proposition}\label{prop:fil}Let $(\X, \R)$ be a left-linear DPO-rewriting system with $\X$ an $\mathcal{M}$-adhesive category. Then every filler between two direct derivations $\dder{D}:G\Mapsto H$ and $\dder{D}':H\Mapsto T$ is a filler also for $S_{u,u'}(\dder{D'}):G\Mapsto J$ and $S_{u,u'}(\dder{D}): J\Mapsto H$. In particular, if $\dder{D}\updownarrow \dder{D}'$, then $S_{u,u'}(\dder{D}')\updownarrow S_{u,u'}(\dder{D})$.
\end{proposition}
\begin{remark}\label{rem:locCR}
\todo{questo è Church-Rosser}
\end{remark}
\begin{proof}By definition of filler, we have two pushout square
		\[\xymatrix{K \ar[r]^{l} \ar[d]_{u}& L \ar[d]^{j} & K' \ar[r]^{r'} \ar[d]_{u'} & R' \ar[d]^{j'}\\ P \ar[r]_q & Q & P \ar[r]_{q'} & Q'}\]
		In particular, $q$ is an arrow of $\mathcal{M}$, therefore, by \Cref{prop:pbpoad}, the square below is a pullback.
		\[\xymatrix{P \ar[r]^{q} \ar[d]_{q'}& Q\ar[d]^{v}\\ Q' \ar[r]_{v'} & J}\]
		To prove our claim, it is now enough to show that $(u',u)$ is a filler between $S_{u,u'}(\dder{D}')$ and $S_{u, u'}(\dder{D})$.
		\begin{enumerate}
			\item As for the first  point of \Cref{def:filler}, the only non obvious part is the existence of a pushout of $u$ along $r$. But, since $(u,u')$ is a filler between $\dder{D}$ and $\dder{D'}$, we know that such a pushout exists: it is enough to take the square
			\[\xymatrix{K \ar[r]^{r} \ar[d]_{u}& R \ar[d]^{i_1} \\P \ar[r]_{p'}& D'}\]
			\item For the second point, notice that the arrows $j$ and $j'$ fit in the squares
	\[\xymatrix{K' \ar[r]^{r'} \ar[d]_{u'}& R' \ar[d]^{j'} &K \ar[r]^{l} \ar[d]_{u}& L\ar[d]^{j} \\P \ar[r]_{q}& Q& P \ar[r]_{q'} & Q'}\] 
		\end{enumerate}
		
By \Cref{rem:indip} we know that $(j,j')$ is an independence pair. The results above now implies that $(j,j')$ is good.
\end{proof}

The previous remark allow us to further switch the direct derivation $S_{i_1,i_2}(\dder{D})$ and $S_{i_2,i_2}(\dder{D}')$. The following lemma guarantees us that, in this way, we get back a derivation which is abstraction equivalent to $\dder{D}\cdot \dder{D}'$.

\todo{introdurre decorazione}

\begin{lemma}\label{lem:rev}
	Let $\dder{D}:G\Mapsto H$ and $\dder{D}':H\Mapsto T$ be two direct derivations in a left-linear DPO-rewriting system $(\X, \R)$ and let $(i_1,i_2)$ be a good independence pair between them. Then $S_{j',j}(S_{i_1,i_2}(\dder{D}, \dder{D'}))$ is abstraction equivalent to $\dder{D}\cdot \dder{D}'$. 
\end{lemma}
\begin{proof}Let $(u,u')$ be the filler associated to $(i_1, i_2)$. By \Cref{prop:fil}, $(u', u)$ is a filler between $S_{i_1,i_2}(\dder{D}')$ and $S_{i_1,i_2}(\dder{D})$. Thus we have a diagram as the one below.
		\[\xymatrix{&&R' \ar@/_1cm/[ddrr]_(.35){j'}|(.7)\hole \ar[dr]^{v'\circ j'}&& L \ar@/^1cm/[ddll]^(.35){j}  \ar[dl]_{v\circ j}\\&K'\ar[dr]^{q\circ u'}\ar[dl]_{l'} \ar@/_.8cm/[ddrr]^(.65){u'}\ar[ur]^{r'}&& J && K \ar@/^.8cm/[ddll]_(.65){u}\ar[dl]_{q'\circ u}\ar[lu]_{l} \ar[dr]^{r}\\L' \ar[dr]^{f\circ i_2} \ar@/_.8cm/[ddrr]_{c_2}&& Q \ar[dl]|(.42)\hole_(.64){s}\ar[ur]|(.48)\hole^(.7){v}&&Q' \ar[dr]|(.42)\hole_(.65){t} \ar[ul]|(.48)\hole_(.7){v'}&&R\ar@/^.8cm/[ddll]^{c_1}\ar[dl]_{g'\circ i_1}\\&G &&P\ar[dr]^{e} \ar[dl]_{e'}\ar[ur]^(.4){q'}\ar[ul]_(.4){q}&&T\\&&E' \ar[ul]_{a}\ar[dr]_{w'} &&E\ar[ur]^{b} \ar[dl]^{w}\\&&&F}\]
	
	Now, to ease the notation, let $S_{j',j}(S_{i_1,i_2}(\dder{D}, \dder{D'}))$ be $\dder{E}_0\cdot \dder{E}_1$, then $\dder{E}_0$ and $\dder{E}_1$ are the direct derivations given by the diagrams
	\[\xymatrix{L \ar[d]_{s\circ j}& K\ar[l]_{l} \ar[r]^{r} \ar[d]_{e'\circ u} & R \ar[d]_{w\circ c_1} & L' \ar[d]^{w'\circ c_2}& K' \ar[d]^{e\circ u'} \ar[r]^{r'} \ar[l]_{l'}& R' \ar[d]^{t\circ j'}\\G & E' \ar[l]^{a}  \ar[r]_{w'}& F & F & E \ar[l]^{w} \ar[r]_{b} & R}\]
	
	Notice, moreover, that, since the squares
	\[\xymatrix{K' \ar[d]_{u'} \ar[r]^{l'}& L' \ar[d]^{c_2} & K \ar[r]^{r}\ar[d]_{u} & R \ar[d]^{c_1}\\ P \ar[r]_{e'} & E' & P\ar[r]_e & E}\]
	are pushouts, we have isomorphisms  $\phi': D\to E'$, $\phi:D'\to E$ making the following diagrams commutative.
	\[\xymatrix{K' \ar[d]_{u'} \ar[r]^{l'}& L'\ar[d]^{i_2}  \ar@/^.2cm/[dr]^{c_2} & &K \ar[r]^{r}\ar[d]_{u} & R \ar[d]^{i_1} \ar@/^.2cm/[dr]^{c_1}\\ P \ar@/_.4cm/[rr]_{e'}\ar[r]^{p} & D\ar@{.>}[r]^{\phi'} &E'& P\ar@/_.4cm/[rr]_{e}\ar[r]^{p'} & D'\ar@{.>}[r]^{\phi}& E}\]
	In particular, we have
	\[\begin{split}
		a\circ \phi' \circ i_2&=a \circ c_2\\&=f\circ i_2\\&
	\end{split}\quad \begin{split}
	a\circ \phi' \circ p'&=a \circ e'\\&=s\circ q\\&=f\circ p
	\end{split}\quad \begin{split}
	b\circ \phi \circ i_1&=b \circ c_1\\&=g'\circ i_1\\&
	\end{split}\quad \begin{split}
	b\circ \phi \circ p&=b \circ e\\&=t\circ q'\\&=g'\circ p'
	\end{split} \]
	and this shows that 
	\[a\circ \phi'=f \qquad b\circ \phi = g'\]
	Now, since $\phi'$ is an isomorphism and by \Cref{prop:pbpoad}, the two halves of the rectangle
	\[\xymatrix{K\ar[r]^{\id{K}} \ar[d]_{(\phi')^{-1} \circ e' \circ u}&K\ar[d]_{e'\circ u} \ar[r]^{l} & L \ar[d]^{s\circ j} \\D\ar[r]_{\phi'} & E' \ar[r]_{a}&G}\]
	are pullbacks. Thus the whole diagram is a pullback. But, by construction $s\circ j =n$ and we have already proved that $a\circ \phi'=f$. We then conclude that ther exists an isomorphism $\zeta:K\to K$ which makes the diagram below commutative
	\[\xymatrix{K \ar@{.>}[r]_{\zeta}\ar@/^.4cm/[rr]^{l}  \ar@/_.5cm/[dr]_{(\phi')^{-1} \circ e' \circ u}& K \ar[r]_{l} \ar[d]_{n} & L \ar[d]^{n} \\ & D \ar[r]_{f} & G}\]
	The commutativity of the upper triangle entails $l\circ \zeta=l$. Since $l$ is an element of $\mathcal{M}$  we can deduce that. $\zeta=\id{K}$. From this, we conclude that
	\[e'\circ u = \phi' \circ k\]
	
	As a next step, notice the existence of $\phi$ and $\phi'$, together with \Cref{rem:deco}, entails  the existence of a third isomorphism $\psi:H\to F$ fitting in the diagram below.
	\[\xymatrix{P  \ar[d]^{p'}\ar@/_.4cm/[dd]_{e}\ar@/^.4cm/[rr]^{e'} \ar[r]_{p} & D \ar[d]^{g} \ar[r]_{\phi'} & E'\ar[d]^{w'}\\D' \ar[d]^{\phi} \ar[r]_{f'} & H\ar@{.>}[r]^{\psi} & F \\E \ar@/_.4cm/[urr]_{w}}\]
Now, if we compute, we get
\begin{align*}
	\psi^{-1}\circ w\circ c_1&=f'\circ \phi^{-1}\circ c_1\\&=f'\circ i_1\\&=h
\end{align*}
	Summing up, we have just build the diagram below.	
	\[\xymatrix@C=40pt@R=10pt{ &&&R\ar[dddr]^{w\circ c_1} \ar[dddl]_{h}|(.67)\hole\\&&K \ar[dl]_{l} \ar[ur]^{r}\ar[dddr]^{e'\circ u} \ar[dddl]_{k}|(.67)\hole\\&L\ar[dddr]^(.4){s\circ j} \ar[dddl]_(.4){n}\\&&H \ar[rr]^{\psi} && F\\ & D \ar[ur]_(.7){g} \ar[rr]^{\phi'} \ar[dl]_{f}&& E' \ar[ur]_{w'}\ar[dl]^{a}\\ G \ar[rr]_{\id{G}} && G}\]

Next, we already know that
\[t\circ j'= h' \quad w\circ \phi = \psi \circ f' \quad b\circ \phi = g'\]
If we compute further, we also get
\[\begin{split}
	\psi^{-1}\circ w'\circ c_2 &= g\circ (\phi')^{-1}\circ c_2\\&=g\circ i_2\\&=n'
\end{split}\qquad \begin{split}
\phi^{-1}\circ e \circ u'&=p'\circ u'\\&= k'\\&
\end{split}\]
These equations allow us to conclude that the following diagram commutes.
	\[\xymatrix@C=40pt@R=10pt{ &&&R'\ar[dddr]^{t\circ j'} \ar[dddl]_{h'}|(.67)\hole\\&&K' \ar[dl]_{l'} \ar[ur]^{r}\ar[dddr]^{e\circ u'} \ar[dddl]_{k}|(.67)\hole\\&L'\ar[dddr]^(.4){w'\circ c_2} \ar[dddl]_(.4){n'}\\&&T \ar[rr]^{\id{T}} && T\\ & D' \ar[ur]_(.7){g'} \ar[rr]^{\phi} \ar[dl]_{f'}&& E \ar[ur]_{b}\ar[dl]^{w}\\ H \ar[rr]_{\psi} && F}\]

Putting together the two diagrams above we get the thesis. \qedhere 
\end{proof}


Our next step is to relate derivations which are equal ``up to switching''.

\begin{definition} Let $(\X, \R)$ be a left-linear DPO-rewriting system. Given two direct derivations $\dder{D}:G\Mapsto H$ and $\dder{D}':H\Mapsto T$, we say that  $\dder{D}$ and $\dder{D}'$ are \emph{properly switchable} if $\dder{D}\updownarrow_! \dder{D'}$ and $S_{i_1,i_2}(\dder{D}')\updownarrow_!S_{i_1,i_2}(\dder{D})$, where $(i_2,i_2)$ is a good independencepair betwwen $\dder{D}$ and $\dder{D}'$. In such a case, we will write $\dder{D}\Updownarrow\dder{D}'$. 
	
Take two derivations $\der{D}=\{\dder{D}_{i}\}_{i=0}^n$ and $\der{D}'=\{\dder{D}'_{i}\}_{i=0}^n$ with the same length and between the same $G_0$ and $G_n$. We say that $\der{D}'$ is \emph{obtained by a proper switch from $\der{D}$} if there exists an index $j < n$ such that
	\begin{enumerate}
\item for every $i\notin \{j, j+1\} $, $\dder{D}_i=\dder{D}'_i$;
\item $\dder{D}_j \Updownarrow \dder{D}_{j+1}$;		
\item $\dder{D}'_j\cdot \dder{D}'_{j+1} = S_{i_1,i_2}(\dder{D}, \dder{D}')$.
	\end{enumerate}
	In such a case, we will write $\der{D}\rightsquigarrow_j \der{D}'$ to denote that $\der{D}'$ is obtained by a proper switch between $\dder{D}_j$ and $\dder{D}_{j+1}$. 
	
	We will say that $\der{D}$ is \emph{switch equivalent} to $\der{D}'$, if there exists a sequence, $\{\der{D}_i\}_{i=0}^n$ of derivations such that
	\begin{enumerate}
		\item $\der{D}_0=\der{D}$ and $\der{D}_n=\der{D}'$;
		\item for every $i< n$, $\der{D}_{i+1}$ is obtained by a proper switch from $\der{D}_i$.
	\end{enumerate}
	
	We will write $\der{D} \equiv^s \der{D}'$ to denote that $\der{D}$ is switch equivalent to $\der{D}'$.
\end{definition}


\begin{example}
	\todo{il punto due sopra è necessario}
\end{example}

We can now prove some properties of switch equivalence.
\begin{lemma}\todo{Def. 3 della bozza di Andrea }Let $(\X, \R)$ be a left-linear DPO-rewriting system. Then the following hold true: 
	\begin{enumerate}
		\item 
		\item 
		\item 
		\item 
	\end{enumerate}
\end{lemma}
\begin{proof}\begin{enumerate}
		\item 
		\item 
		\item 
		\item \qedhere 
	\end{enumerate}
\end{proof}


\begin{example}\todo{esempio sul perché weakly independence non è invertibile}
\end{example}



\begin{lemma}\label{lem:consperm} Let $(\X, \R)$ be a left-linear DPO-rewriting system $(\X, \R)$. Then the following hold true
	\begin{enumerate}
		\item If $\dder{D}$ and $\dder{D'}$ are two direct derivations such that $\dder{D}\updownarrow \dder{D'}$, then for every filler $(u,u')$ between them, the function
		\[\tau:2\to2 \qquad x \mapsto \begin{cases}
			1 & x=0\\
			0 & x=1
		\end{cases}\]
		defines a consistent permutation between $\dder{D}\cdot \dder{D}'$ and $\sder{D}{D'}$;
		\item if $\der{D}$ and $\der{D}'$ are two switch equivalent derivation, then there exists a consistent permutation between them.
	\end{enumerate}
\end{lemma}
\begin{proof}
	\begin{enumerate}
		\item 
		\item \qedhere 
	\end{enumerate}
\end{proof}
 This, together with ???
\begin{corollary}
	\todo{unicità}
\end{corollary}

\begin{example}\label{ex:contro}\todo{permutazione consistente non implica scambiabilità}
\end{example}

\subsection{Proper switchability is global}
\todo{intro}


\begin{lemma}\label{lem:iig1}Let $(\X,\R)$ be a left-linear DPO-rewriting system with $\X$ an $\mathcal{M}$-adhesive category. Consider a derivation $\der{D}=\{\dder{D}_i\}_{i=0}^2$. If $(i_0,i_1)$ is a good independence pair between $\dder{D}_0$ and $\dder{D}_1$, $(a_1,a_2)$ one between $\dder{D}_1$ and $\dder{D}_2$ and $\dder{D}_0\updownarrow S_{a_1,a_2}(\dder{D}_2)$ with good independence pair $(e_0,e_1)$, then $S_{e_0,e_1}(\dder{D}_0)$ and $S_{a_1,a_2}(\dder{D}_1)$ are weakly sequentially independent.
\end{lemma}
\begin{proof} We can use \Cref{def:filler,def:switch} to get some diagrams.  First of all, let $(v,v')$ be the filler between $\dder{D}_0$ and $\dder{D}_1$ associated to $(i_1, i_2)$, then we have
			\[\xymatrix{&&R_0 \ar@/_1cm/[ddrr]_(.35){i_0}|(.7)\hole \ar[dr]^{h_0}&& L_1\ar@/^1cm/[ddll]^(.35){i_1}  \ar[dl]_{m_1}\\&K_0\ar[dr]^{k_0}\ar[dl]_{l_0} \ar@/_.8cm/[ddrr]|(.36)\hole^(.65){v}\ar[ur]^{r_0}&& G_1 && K_1 \ar@/^.8cm/[ddll]|(.36)\hole_(.65){v'}\ar[dl]_{k_1}\ar[lu]_{l_1} \ar[dr]^{r_1}\\L_0 \ar@/_.8cm/[ddrr]_(.2){j_0}|(.31)\hole|(.81)\hole \ar[dr]^(.4){m_0}|(.61)\hole && D_0 \ar[dl]|(.4)\hole_(.65){f_0}\ar[ur]|(.5)\hole^(.7){g_0}&&D_1 \ar[dr]|(.4)\hole^(.65){g_1} \ar[ul]|(.5)\hole_(.65){f_1}&&R_1\ar@/^.8cm/[ddll]^(.2){j_1}|(.31)\hole|(.81)\hole\ar[dl]_{h_1}\\&G_0 &&P_1\ar[dr]_{q_1} \ar[dl]^{q_0}\ar[ur]^(.4){p_1}\ar[ul]_(.4){p_0}&&G_2\\L_1 \ar@/^.8cm/[uurr]^(.2){i_1} \ar[ur]_(.35){f_0\circ i_1}|(.61)\hole&&Q_0 \ar[ul]|(.4)\hole_(.65){s_0}\ar[dr]|(.5)\hole^(.65){t_0} &&Q_1\ar[ur]|(.4)\hole^(.65){t_1} \ar[dl]|(.5)\hole_(.65){s_1} && R_0  \ar[ul]^(.35){g_1\circ i_0}|(.61)\hole\ar@/_.8cm/[uull]_(.2){i_0}\\&K_1 \ar[ur]_{q_0\circ v'} \ar[dr]_{r_1} \ar[ul]^{l_1}\ar@/^.8cm/[uurr]_(.65){v'}&&G'_1&& K_0 \ar[ur]_{r_0} \ar[ul]^{q_1\circ v} \ar[dl]^{l_0} \ar@/_.8cm/[uull]^(.65){v}\\&& R_1 \ar[ur]_{\hspace{-5pt}s_1\circ j_1}\ar@/^1cm/[uurr]^(.25){j_1}&& L_0 \ar[ul]^{t_0\circ j_0\hspace{-5pt}} \ar@/_1cm/[uull]_(.25){j_0} |(.69)\hole }\]
	
	Secondly, the filler $(u,u')$ induced by $(a_1, a_2)$ between $\dder{D}_1$ and $\dder{D}_2$ yields:
\[
			\xymatrix{&&R_1 \ar@/_1cm/[ddrr]_(.35){a_1}|(.7)\hole \ar[dr]^{h_1}&& L_2\ar@/^1cm/[ddll]^(.35){a_2}  \ar[dl]_{m_2}\\&K_1\ar[dr]^{k_1}\ar[dl]_{l_1} \ar@/_.8cm/[ddrr]|(.36)\hole^(.65){u}\ar[ur]^{r_1}&& G_2 && K_2 \ar@/^.8cm/[ddll]|(.36)\hole_(.65){u'}\ar[dl]_{k_2}\ar[lu]_{l_2} \ar[dr]^{r_2}\\L_1 \ar@/_.8cm/[ddrr]_(.2){b_1}|(.31)\hole|(.81)\hole \ar[dr]^(.4){m_1}|(.61)\hole && D_1 \ar[dl]|(.4)\hole_(.65){f_1}\ar[ur]|(.5)\hole^(.7){g_1}&&D_2 \ar[dr]|(.4)\hole^(.65){g_2} \ar[ul]|(.5)\hole_(.65){f_2}&&R_2\ar@/^.8cm/[ddll]^(.2){b_2}|(.31)\hole|(.81)\hole\ar[dl]_{h_2}\\&G_1 &&P_2\ar[dr]_{d_2} \ar[dl]^{d_1}\ar[ur]^(.4){c_2}\ar[ul]_(.4){c_1}&&G_2\\L_2 \ar@/^.8cm/[uurr]^(.2){a_2} \ar[ur]_(.35){f_1\circ a_2}|(.61)\hole&&Q_2 \ar[ul]|(.4)\hole_(.65){x_1}\ar[dr]|(.5)\hole^(.65){y_1} &&Q_3\ar[ur]|(.4)\hole^(.65){y_2} \ar[dl]|(.5)\hole_(.65){x_2} && R_1  \ar[ul]^(.35){g_2\circ a_1}|(.61)\hole\ar@/_.8cm/[uull]_(.2){a_1}\\&K_2 \ar[ur]_{d_1\circ u'} \ar[dr]_{r_2} \ar[ul]^{l_2}\ar@/^.8cm/[uurr]_(.65){u'}&&G'_2&& K_1 \ar[ur]_{r_1} \ar[ul]^{d_2\circ u} \ar[dl]^{l_1} \ar@/_.8cm/[uull]^(.65){u}\\&& R_2 \ar[ur]_{\hspace{-5pt}x_2\circ b_2}\ar@/^1cm/[uurr]^(.25){b_2}&& L_1 \ar[ul]^{y_1\circ b_1\hspace{-5pt}} \ar@/_1cm/[uull]_(.25){b_1} |(.69)\hole }\]
			
	Finally, the filler $(w,w')$  between $\dder{D}_0$ and $S_{u,u'}(\dder{D}_2)$ given by $(e_0, e_1)$ provides us with:
			\[\xymatrix{&&R_0 \ar@/_1cm/[ddrr]_(.35){e_0}|(.7)\hole \ar[dr]^{h_0}&& L_2\ar@/^1cm/[ddll]^(.35){e_1}  \ar[dl]_{f_1\circ a_2}\\&K_0\ar[dr]^{k_0}\ar[dl]_{l_0} \ar@/_.8cm/[ddrr]|(.36)\hole^(.65){w}\ar[ur]^{r_0}&& G_1 && K_2 \ar@/^.8cm/[ddll]|(.36)\hole_(.65){w'}\ar[dl]_{d_1\circ u'\hspace{-5pt}}\ar[lu]_{l_2} \ar[dr]^{r_2}\\L_0 \ar@/_.8cm/[ddrr]_(.2){o_0}|(.31)\hole|(.81)\hole \ar[dr]^(.4){m_0}|(.61)\hole && D_0 \ar[dl]|(.4)\hole_(.65){f_0}\ar[ur]|(.5)\hole^(.7){g_0}&&Q_2 \ar[dr]|(.4)\hole^(.65){y_1} \ar[ul]|(.5)\hole_(.65){x_1}&&R_2\ar@/^.8cm/[ddll]^(.2){o_1}|(.31)\hole|(.81)\hole\ar[dl]_(.35){x_2\circ b_2}\\&G_0 &&P_3\ar[dr]_{n_1} \ar[dl]^{n_0}\ar[ur]^(.4){u_1}\ar[ul]_(.4){u_0}&&G'_2\\L_2 \ar@/^.8cm/[uurr]^(.2){e_1} \ar[ur]_(.35){f_0\circ e_1}|(.61)\hole&&Q_4 \ar[ul]|(.4)\hole_(.65){z_0}\ar[dr]|(.5)\hole^(.65){z'_0} &&Q_5\ar[ur]|(.4)\hole^(.65){z'_1} \ar[dl]|(.5)\hole_(.65){z_1} && R_0  \ar[ul]^(.35){y_1\circ e_0}|(.61)\hole\ar@/_.8cm/[uull]_(.2){e_0}\\&K_2 \ar[ur]_{n_0\circ w'} \ar[dr]_{r_2} \ar[ul]^{l_2}\ar@/^.8cm/[uurr]_(.65){w'}&&G'_1&& K_0 \ar[ur]_{r_0} \ar[ul]^{n_1\circ w} \ar[dl]^{l_0} \ar@/_.8cm/[uull]^(.65){w}\\&& R_2 \ar[ur]_{\hspace{-4pt}z_1\circ o_1}\ar@/^1cm/[uurr]^(.25){o_1}&& L_0 \ar[ul]^{z'_0\circ o_0\hspace{-5pt}} \ar@/_1cm/[uull]_(.25){o_0} |(.69)\hole }\]
	
	We have to construct the two dotted arrows in the diagram below.
			\[\xymatrix@C=15pt{L_. \ar[d]_{z'_0\circ o_0}&& K_0 \ar[d]_{n_1\circ w}\ar[ll]_{l_0} \ar[r]^{r_0} & R_0 \ar@{.>}@/^.35cm/[drrr]_(.4){\alpha_1}|(.285)\hole \ar[dr]|(.28)\hole_{y_1\circ e_0} && L_1 \ar@{.>}@/_.35cm/[dlll]^(.4){\alpha_2} \ar[dl]|(.28)\hole^{y_1\circ b_1}& K_1 \ar[d]^{d_2\circ u}\ar[l]_{l_1} \ar[rr]^{r_1} && R_1 \ar[d]^{g_2\circ a_1}\\G'_1 && \ar[ll]^{z_1} Q_5 \ar[rr]_{z'_1}&& G'_2  && \ar[ll]^{x_2} Q_3 \ar[rr]_{y_2}&& G_2}\]
			
		Consider the arrows $i_0:R_0\to D_1$ and $e_0:R_0\to Q_2$. An easy computation shows that
			\begin{align*}
				f_1\circ i_0&= h_0\\&=x_1\circ e_0
			\end{align*}
			entailing the existence of  the dotted $\alpha'_1:R_0\to P_2$ in the diagram
			\[\xymatrix{R_0 \ar@{.>}[dr]^{\alpha'_1} \ar@/^.3cm/[drr]^{i_0} \ar@/_.3cm/[ddr]_{e_0}\\ &P_2 \ar[r]^{c_2} \ar[d]_{d_1}& D_1 \ar[d]^{f_1}\\ &Q_2\ar[r]_{x_1} & G_1}\]
			If we define $\alpha_1:R_0\to Q_3$ as $d_2\circ \alpha'_1$, then we easily get that 
		\begin{align*}
			x_2\circ \alpha_1&=x_2\circ d_2\circ \alpha'_1\\&= y_1\circ d_1\circ \alpha'_1\\&=y_1\circ e_0
		\end{align*}
		
		For $\alpha_2$, we proceed similarly. First consider  $i_1:L_1\to D_0$ and $b_1: L_1 \to Q_2$ and notice that
		\begin{align*}
			g_0\circ i_1&= m_1 \\&= x_1 \circ b_1
		\end{align*}
			implying the existence of $\alpha'_2:L_1\to P_3$ fitting in the diagram below.
			\[\xymatrix{L_1 \ar@{.>}[dr]^{\alpha'_2} \ar@/^.3cm/[drr]^{i_1} \ar@/_.3cm/[ddr]_{b_1}\\ &P_3 \ar[r]^{u_0} \ar[d]_{u_1}& D_0 \ar[d]^{g_0}\\ &Q_2\ar[r]_{x_1} & G_1}\] 
			Let $\alpha_2:L_1\to Q_5$ be $n_1\circ \alpha'_2$, then
			\begin{align*}
				z'_1 \circ \alpha_2 & = z'_1 \circ n_1\circ \alpha'_2\\&=y_1\circ u_1\circ \alpha'_2\\&=y_1\circ b_1
			\end{align*}
			The thesis now follows. \qed
\end{proof}

\begin{corollary} Given a tame  left-linear DPO-rewriting system  $(\X,\R)$ with $\X$ an $\mathcal{M}$-adhesive category and a decorated derivation $(\der{D}, \alpha, \omega)$ with $\der{D}=\{\dder{D}_i\}_{i=0}^2$. Then the following are true: 
	\begin{enumerate}
		\item suppose that $(a_1,a_2)$ and $(e_0,e_1)$ are independence pairs witnessing  $\dder{D}_1\updownarrow_! \dder{D}_2$ and $\dder{D}_0\updownarrow_! S_{a_1,a_2}(\dder{D}_2)$ respectively, if $\dder{D}_0\updownarrow_!\dder{D}_1$, then $S_{e_0,e_1}(\dder{D}_0)\updownarrow_!S_{a_2,a_2}(\dder{D}_1)$;
		\item 
	\end{enumerate}
\end{corollary}

\todo{ripulire le ipotesi: serve scambiabilità propria tra 1 e 2}
\todo{sistemare il fatto che qua utilizziamo derivazioni di 3 passi}
\begin{proof}
	\begin{enumerate}
		\item Let $(i_1,i_2)$ be the unique independence pair between $\dder{D}_0$ and $\dder{D}_1$.  By tameness and \Cref{lem:iig1} we know that $S_{e_0,e_1}(\dder{D}_0)\updownarrow S_{a_1,a_2}(\dder{D}_1)$. Let $(\alpha_1, \alpha_2)$ be the independence pair constructed in the proof of \Cref{lem:iig1}. Take another independence pair $(\beta_1, \beta_2)$,  by \Cref{rem:weak} we already know that $\beta_1=\alpha_1$. Let also $\der{E}$ be the derivation $S_{e_0, e_1}(S_{a_1, a_2}(\der{D}_2))\cdot S_{e_0, e_1}(\dder{D}_0) \cdot S_{a_1, a_2}(\der{D}_1)$. Let $\sigma:[0,2]\to [0,2]$ be the cycle $(0,1,2)$. By \Cref{lem:consperm} we know that $\sigma$ is a consistent permutation between $(\der{D}, \alpha, \omega)$ and $(\der{E}, \alpha, \omega)$. In particular, we have
		\begin{align*}
			\iota_{\der{E}, G_0}\circ f_0\circ  i_1 &=\xi_\sigma \circ 	\iota_{\der{D}, G_0}\circ f_0\circ  i_1 \\&= \xi_\sigma \circ 	\iota_{\der{D}, D_0}\circ  i_1\\ &= \xi_\sigma \circ \iota_{\der{D}, G_1} \circ g_0\circ  i_1 \\&=\xi_\sigma \circ \iota_{\der{D}, G_1}\circ m_1\\ &=  \iota_{\der{E}, G'_2}\circ y_1\circ b_1\\&= \iota_{\der{E}, G'_2}\circ z'_1\circ \beta_2\\&= \iota_{\der{E}, Q_5}\circ \beta_2 
		\end{align*}
		Using	\Cref{rem:pbsalva} we can deduce the existence of a unique arrow $\beta'_2:L_1\to P_3$ fitting in the diagram below
		\[\xymatrix@C=30pt{L_1  \ar@/^.3cm/[drr]^{\beta_2} \ar@/_.3cm/[ddr]_{i_1}\ar@{.>}[dr]^{\beta'_2}\\& P_3 \ar[r]^{n_1}  \ar[d]_{u_0}& Q_5 \ar[d]^{\iota_{\dder{E}, Q_5}}\\
		&D_0 \ar[r]_{\iota_{\dder{E}, G_0}}& \tpro{E}}\]
		If we further compute, we get
		\begin{align*}
			y_1\circ u_1\circ \beta'_2&=z'_1\circ n_1\circ \beta'_2=\\&= z'_1\circ \beta_2 \\&=y_1\circ b_1
		\end{align*}
		Thus $(u_1\circ \beta'_2, b_2)$ is an independence pair between $S_{a_1, a_2}(\der{D}_2)$ and $S_{a_1, a_2}(\der{D}_1)$ therefore, by hypothesis $u_1\circ \beta'_2=b_1$. But this implies that $\beta'_2$ and $\alpha'_2$ are equal, giving us the thesis.
		
\todo{ripulire le ipotesi: serve scambiabilità propria tra 1 e 2}
\todo{sistemare il fatto che qua utilizziamo derivazioni di 3 passi}
		
		\item \qedhere 
	\end{enumerate}
\end{proof}
 
 We need another lemma, similar to \Cref{lem:iig1}.
\begin{lemma}\label{lem:iig2}\todo{nell'altro senso}
\end{lemma}
\begin{proof}
 \todo{fare} \qedhere 
\end{proof}

\begin{corollary}
\todo{passare a $\updownarrow_!$ e $\Updownarrow$}
\end{corollary}

\begin{corollary}[Invariance under immediate shift]\label{cor:ius}
	contenuto...
\end{corollary}

\todo{ricopiare tutta l'induzione di Andrea}
\subsection{Concatenable traces}
\begin{lemma}
	\todo{abstract equivalence and switch }
\end{lemma}
\begin{proof}
	contenuto...
\end{proof}
\begin{definition}
	\todo{tracce}
\end{definition}

Before moving forward, we will prove some other useful properties of the switch equivalence relation.

\begin{lemma}
	\todo{lemma 19}
\end{lemma}
\begin{proof}
	contenuto...
\end{proof}


\begin{theorem}
	\todo{preordine}
\end{theorem}
\begin{proof}
	contenuto...
\end{proof}


\section{ Domains for DPO-rewriting}

\subsection{weak domains}

\subsection{From adhesive grammars to weak domains}

\section{Conclusions and further work}
\todo{VERY NICE CONCLUSIONS}

\bibliographystyle{plain}
\bibliography{bibliog.bib}


\appendix
\section{On permutations}\label{app:perm}
\todo{inserire risutati sulle permutazione che abbiamo usato}


\section{A note on fillers and sequential independence}\label{app:fill}
 In \Cref{prop:equi} we proved that, in the linear case, the existence of an indpendence pair between two derivation is equivalent to that of a filler between them. This result can be further refined: in a\cite{baldan2011adhesivity} a class  $\mathbb{B}$ of (quasi)adhesive category is defined for which the local Church-Rosser Theorem holds even for left-linear DPO-rewriting system. In our language, and given \Cref{prop:fil} and \Cref{rem:locCR}, this amount to prove that, for elements of $\mathbb{B}$, every independence pair induces a filler. 

\begin{definition}Let $\X$ be a category, we say that $\X$ satisfies
	\begin{itemize}
		\item the \emph{mixed decomposition} property if for every diagram
		\[\xymatrix{X \ar[d]_{a} \ar[r]^{f}& \ar[r]^{g} Y \ar[d]^{b}& Z \ar[d]^{c}\\ A \ar[r]_{h}& B \ar[r]_{k}& C}\]
		whose outer boundary is a pushout and in which $k$ is a monomorphisms, 
		\item the \emph{pushout decomposition} property
	\end{itemize}
\end{definition}

\begin{lemma}
	contenuto...
\end{lemma}
\begin{proof}
	contenuto...\qedhere 
\end{proof}

\begin{corollary}
	contenuto...
\end{corollary}

The following result shows that the mixed and pushout decomposition properties guarantee that every independence pair gives rise to a filler.

\begin{theorem}
	\todo{filler e classe B+}
\end{theorem}
\begin{proof}\qedhere 
\end{proof}

Our next step is to identify sufficient conditions for a category $\X$ to satisfy the mixed and pushout decomposition properties.

\begin{definition}
	\todo{classe B e class B+}
\end{definition}

\begin{example}
\todo{esempi}
\end{example}

\begin{example}
	\todo{esempi}
\end{example}

\begin{proposition}
	\todo{da B a B+}
\end{proposition}
\begin{proof}
	contenuto... \qedhere 
\end{proof}
\begin{lemma}\todo{due proprietà classe B}
\end{lemma}
\begin{proof}
	\qedhere 
\end{proof}

\begin{corollary}
	\todo{due proprietà classe B+}
\end{corollary}

\begin{corollary}
	\todo{filler e classe B+}
\end{corollary}



\end{document}
