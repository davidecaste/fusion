\documentclass[a4paper]{article}
\usepackage{hyperref}
\usepackage[textsize=tiny]{todonotes}
%\usepackage{etex}
\usepackage[all]{xy}
\SelectTips{cm}{}
% derivations and labels
\usepackage{proof}
\newcommand{\lab}[1]{\ensuremath{\mathsf{{#1}}}}
\newcommand{\slab}[1]{\ensuremath{\scriptstyle{\mathsf{{#1}}}}}

%frecce
\newcommand{\mor}{\mathsf{Mor}}
\newcommand{\mon}{\mathsf{Mono}}
\newcommand{\reg}{\mathsf{Reg}}

% ``boxed'' \infer command
\newcommand{\binfer}[3][]{
  \mbox{\infer[#1]{#2}{#3}}}

% Command for labels on the left side of the rule
%       \inferL{<name>}{<post>}{<pre>}
% generates:
%             <pre>
%      <name> ------
%             <post>
%
\newlength{\myheight}
\newcommand{\inferL}[3]
  {\settoheight{\myheight}{\mbox{${#2}$}}
   \raisebox{\myheight}{{#1}}
   \makebox[1mm]{}
   \mbox{\infer{#2}{#3}}
}

\usepackage{amssymb,graphicx,epsfig,color}
%\usepackage[scriptsize]{subfigure}
\usepackage{subcaption}
\usepackage{wrapfig}

% re-stating 
%\usepackage{thm-restate}

% showing labels
%\usepackage[inline]{showlabels}

\usepackage{pgf}
\usepackage{tikz}
\usepackage{tikz-cd}
\usetikzlibrary{arrows,shapes,snakes,automata,backgrounds,petri,fit,positioning}
\tikzstyle{node}=[circle, draw=black, minimum size=1mm]
\tikzstyle{trans}=[font=\scriptsize]
\tikzstyle{lab}=[font=\small]


\newcommand{\pgfBox}{
  \begin{pgfonlayer}{background} 
    \fill[blue!2,thick,draw=black!50,rounded corners,inner sep=3mm] ([xshift=-1.5pt,yshift=-1.5pt]current bounding box.south west) rectangle ([xshift=1.5pt,yshift=1.5pt]current bounding box.north east);
  \end{pgfonlayer}
}
\usepackage{scalerel}
\newcommand{\smallmin}{\scaleobj{0.6}{-}}
\newcommand{\Deltamin}{\Delta^{\hspace{-1pt}\downarrow\hspace{-1pt}}}
\newcommand{\Rrel}[1]   {\stackrel{{#1}}{\Longrightarrow}}
\newcommand{\oa}{\overline a}
\newcommand{\ob}{\overline b}
\newcommand{\oc}{\overline c}
\newcommand{\od}{\overline d}
\newcommand{\rec}{\emph{rec}}
\newcommand{\fn}[1]{{\mathtt{fn}}(#1)}
%\usepackage{latexsym}
\usepackage{stmaryrd}
\def\encodep#1{\llfloor#1\rrfloor}

\newcommand{\cat}[1]{\ensuremath{\mathbf{#1}}}

\newcommand{\dpo}{\textsc{dpo}}

% base classes of categories for adhesive and quasi adhesive case
\newcommand{\bAdh}{\ensuremath{\mathbb{B}}}
\newcommand{\bQAdh}{\ensuremath{\mathbb{QB}}}

%from pawel
\usepackage[latin1]{inputenc}
\usepackage{amsmath}

\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{enumerate}
\usepackage{xspace}
\usepackage{amsfonts}
\usepackage{mathrsfs}
\usepackage{cite}
\usepackage{float}
\usepackage{fancybox}

\usepackage{cleveref}


%\spnewtheorem*{notation}{Notation}{\bfseries}{\rmfamily}

%%%%%%%% MATHEMATICAL NOTATION %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%symbol for natural numbers
\newcommand{\nat}{\ensuremath{\mathbb{N}}}

% finite subset
\newcommand{\sfin}{\ensuremath{\subseteq_{\mathit{fin}}}}

% flattening of a multiset
\newcommand{\flt}[1]{\ensuremath{[\![{#1}]\!]}}

% compact elements
\newcommand{\compact}[1]{\ensuremath{\mathop{\mathsf{K}({#1})}}}

% principal ideal
\newcommand{\principal}[1]{\ensuremath{\mathop{\downarrow\!{#1}}}}

% ideal completion
\newcommand{\ideal}[1]{\ensuremath{\mathsf{Idl}({#1})}}

% complete prime elements
\newcommand{\pr}[1]{\ensuremath{\mathop{\mathit{pr}({#1})}}}
\newcommand{\wpr}[1]{\ensuremath{\mathop{\mathit{wpr}({#1})}}}

% irreducible elements
\newcommand{\ir}[1]{\ensuremath{\mathop{\mathit{ir}({#1})}}}

% difference of irreducible elements
\newcommand{\diff}[2]{\ensuremath{\delta({#1},{#2})}}

% immediate precedence

% abbreviation for event structure
% \newcommand{\esabbr}{event structure}
\newcommand{\esabbr}{\textsc{es}}
\newcommand{\esnabbr}{\textsc{esnb}}
\newcommand{\esnmabbr}{\textsc{esn}}
\newcommand{\eseqabbr}{\textsc{epes}}

% predecessor of an irreducible
\newcommand{\pred}[1]{\ensuremath{\mathit{p}({#1})}}

% irreducible elements in es domains
\newcommand{\esir}[2]{\ensuremath{\langle{#1}, {#2}\rangle}}

% equivalence classes [of irreducibles]
\newcommand{\eqclass}[2][]{\ensuremath{[{#2}]_{\scriptscriptstyle {#1}}}}
% union of the equivalence classes of the elements in a set
\newcommand{\eqclasscup}[2]{\ensuremath{{#2}_{\scriptscriptstyle {#1}}}}

\newcommand{\eqclassir}[1]{\ensuremath{\eqclass[\leftrightarrow^*]{#1}}}

% quotient of set wrt a relation
\newcommand{\quotient}[2]{\ensuremath{{#1}_{\scriptscriptstyle {#2}}}}

% category of event structures 
\newcommand{\es}{\ensuremath{\mathsf{ES}}}
% category of stable event structures 
\newcommand{\ses}{\ensuremath{\mathsf{sES}}}
% category of prime event structures 
\newcommand{\pes}{\ensuremath{\mathsf{pES}}}
% category of prime event structures with equivalence
\newcommand{\epes}{\ensuremath{\mathsf{epES}}}

% category of connected event structures 
\newcommand{\ces}{\ensuremath{\mathsf{cES}}}

% category of weak prime algebraic domains domains 
\newcommand{\WDom}{\ensuremath{\mathsf{wDom}}}
% category of domains
\newcommand{\Dom}{\ensuremath{\mathsf{Dom}}}
% category of prime algebraic domains
\newcommand{\PDom}{\ensuremath{\mathsf{pDom}}}


%%%%% NON BINARY CONFLICT

% category of event structures 
\newcommand{\esn}{\ensuremath{\mathsf{ES_{nb}}}}
% category of stable event structures 
\newcommand{\sesn}{\ensuremath{\mathsf{sES_n}}}

% category of connected event structures 
\newcommand{\cesn}{\ensuremath{\mathsf{cES_{nb}}}}

% category of prime event structures 
\newcommand{\pesn}{\ensuremath{\mathsf{pES_n}}}

% category of fusion domains 
\newcommand{\WDomb}{\ensuremath{\mathsf{wDom_b}}}
% category of domains
\newcommand{\Domb}{\ensuremath{\mathsf{Dom_b}}}
% category of prime algebraic domains
\newcommand{\PDomb}{\ensuremath{\mathsf{pDom_b}}}

%%%%% END NON BINARY CONFLICT


% slice category
\newcommand{\slice}[2]{\ensuremath{({#1} \downarrow {#2})}}


% event structure for a domain
\newcommand{\zev}[0]{\ensuremath{\mathcal{E}}}
\newcommand{\ev}[1]{\ensuremath{\zev({#1})}}

% from general to connected event structures
\newcommand{\zconnes}[0]{\ensuremath{\mathcal{C}}}
\newcommand{\connes}[1]{\ensuremath{\zconnes({#1})}}
% and inclusion
\newcommand{\zinces}[0]{\ensuremath{\mathcal{I}}}
\newcommand{\inces}[1]{\ensuremath{\zinces({#1})}}


% stable version
\newcommand{\zsev}[0]{\ensuremath{\mathcal{E}_S}}
\newcommand{\sev}[1]{\ensuremath{\zsev({#1})}}

% with equivalence
\newcommand{\zeveq}[0]{\ensuremath{\mathcal{E}_{eq}}}
\newcommand{\eveq}[1]{\ensuremath{\zeveq({#1})}}

% es with equivalence to es and vice
\newcommand{\zfuse}[0]{\ensuremath{\mathcal{M}}}
\newcommand{\fuse}[1]{\ensuremath{\zfuse({#1})}}
\newcommand{\zunf}[0]{\ensuremath{\zunf}}
\newcommand{\unf}[1]{\ensuremath{\mathcal{U}({#1})}}



% Winskel/Droste version
\newcommand{\zevwd}[0]{\ensuremath{\mathcal{E}_{wd}}}
\newcommand{\evwd}[1]{\ensuremath{\zevwd({#1})}}




% configurations of an event structure
\newcommand{\conf}[1]{\ensuremath{\mathit{Conf}({#1})}}
% finite configurations
\newcommand{\conff}[1]{\ensuremath{\mathit{Conf_F}({#1})}}

% product of the sets of minimal enablinsg
\newcommand{\pmin}[1]{\ensuremath{U_{#1}}}

% connectectedness of minimal enablinsg
\newcommand{\conn}[1]{\ensuremath{\stackrel{#1}{\frown}}}


% domain for an event structure or graph grammar
\newcommand{\zdom}[0]{\ensuremath{\mathcal{D}}}
\newcommand{\dom}[1]{\ensuremath{\zdom({#1})}}


\newcommand{\zdomeq}[0]{\ensuremath{\mathcal{D}_{eq}}}
\newcommand{\domeq}[1]{\ensuremath{\zdomeq({#1})}}


% partial order for a graph grammar
\newcommand{\poset}[1]{\ensuremath{\mathcal{P}({#1})}}

% stable version
\newcommand{\pdom}[1]{\ensuremath{\mathcal{D}_S({#1})}}
\newcommand{\ppdom}[0]{\ensuremath{\mathcal{D}_S}}


% powerset
\newcommand{\Pow}[1]{\ensuremath{\mathbf{2}^{#1}}}

% powerset of finite subsets
\newcommand{\Powfin}[1]{\ensuremath{\mathbf{2}_\mathit{fin}^{#1}}}

% powerset of subsets of cardinality <= 1
\newcommand{\Powone}[1]{\ensuremath{\mathbf{2}_1^{#1}}}

% integer interval
\newcommand{\interval}[2][1]{\ensuremath{[{#1},{#2}]}}

% domain interval
\newcommand{\dint}[2]{\ensuremath{[{#1},{#2}]}}

% set of intervals
\newcommand{\IntSet}[1]{\ensuremath{\mathop{\mathit{Int}({#1})}}}

% intervals to irreducibles and vice
\newcommand{\inir}{\ensuremath{\mathop{\mathit{\zeta}}}}
\newcommand{\irin}{\ensuremath{\mathop{\mathit{\iota}}}}

% permutations
\newcommand{\perm}{\sigma}

% causes
\newcommand{\causes}[1]{\ensuremath{\lfloor {#1})}}

%%% GRAPH GRAMMARS


\newcommand{\Abs}[1]{\ensuremath{\mathsf{Abs}({#1})}}
\newcommand{\tr}[1]{\ensuremath{\mathsf{Tr}({#1})}}
% fusion safe traces
\newcommand{\trs}[1]{\ensuremath{\mathsf{Tr}_s({#1})}}
%\newcommand{\graph}{\ensuremath{\mathsf{Graph}}}
\newcommand{\tgraph}[1]{\ensuremath{\mathsf{Graph}_{#1}}}
\newcommand{\can}[1]{\ensuremath{\mathsf{C}({#1})}}
% source and target of a derivation
\newcommand{\source}[1]{\ensuremath{\mathsf{s}({#1})}}
\newcommand{\target}[1]{\ensuremath{\mathsf{t}({#1})}}
\newcommand{\col}[1]{\ensuremath{\mathsf{col}({#1})}}

% left decorated trace
\newcommand{\ltrace}[1]{\ensuremath{\langle {#1}\rangle_c}}

\newcommand{\bx}[1]{\phantom{\big(}#1{\phantom{\big)}}}
\newcommand{\bxx}[1]{\,#1\,}
\newcommand{\cycl}[1]{\ensuremath{\mbox{\textcircled{\scriptsize{$#1$}}}}}
\renewcommand{\iff}{\ensuremath{\Leftrightarrow}}

%%%%GENERAL CATEGORICAL NOTATION

%identitÃ 
\newcommand{\id}[1]{\mathsf{id}_{#1}}
%codominio
\newcommand{\cod}[1]{\mathsf{cod}({#1})}
	%Variabili categorie
\def\A{\textbf {\textup{A}}}
%mono
\newcommand{\mto}[0]{\scalebox{1}{$\rightarrowtail$}}


\newcommand{\sk}{\mathsf{sk}_{\X}}


\def\R{\mathsf{R}}
\def\B{\textbf {\textup{B}}}
\def\C{\textbf {\textup{C}}}
\def\D{\textbf {\textup{D}}}
\def\X{\textbf {\textup{X}}}
\def\Y{\textbf {\textup{Y}}}

\newcommand{\ske}{\mathsf{sk}(\X)}
\renewcommand{\P}{\textbf {\textup{P}}}

%\derivazioni

\newcommand{\dder}[1]{\mathscr{#1}}
\newcommand{\sder}[2]{S_{i_1,i_2}(\mathscr{#1}, \mathscr{#2})}
\newcommand{\der}[1]{\underline{\dder{#1}}}
\def\dpo{\mathsf{C}^{\X}_R}
\def\gpo{\mathsf{G}^{\X}_R}
\def\dpi{[\mathsf{C}]^{\X}_R}
\def\gpi{[\mathsf{G}]^{\X}_R}

\newcommand{\ider}[1]{\mathscr{I}_{#1}}

%categorie
\def\Set{\textbf {\textup{Set}}}

%comma
\newcommand{\comma}[2]{#1\hspace{1pt} {\downarrow}\hspace{1pt} #2}
\newcommand{\cma}[2]{\mathcal{#1}\hspace{1pt} {\downarrow}\hspace{1pt} \mathcal{#2}}

%derivazioni
\newcommand{\lpro}{\langle \hspace{-1.85pt}[}
\newcommand{\rpro}{]\hspace{-1.85pt}\rangle}
\newcommand{\tpro}[1]{\lpro \der{#1}\rpro}
\newcommand{\tproi}[2]{\lpro \der{#1}_{#2}\rpro}
\newcommand{\lgh}[0]{\mathsf{lg}}

%%% NEW

\usepackage{xparse}

% inversions
\newcommand{\inv}[1]{\ensuremath{inv}({#1})}

% direct shift
\newcommand{\shiftdir}[1][]{\ensuremath{\mathrel{{\rightsquigarrow}^{\mathit{sh}}_{#1}}}}

% shift preorder
\newcommand{\shiftpre}[1][]{\ensuremath{\mathrel{{\sqsubseteq}^{\mathit{sh}}_{#1}}}}

% shift equivalence
\newcommand{\shifteq}[1][]{\ensuremath{\mathrel{{\equiv}^\mathit{sh}_{#1}}}}

% transp{source}[target]: if target not specified source+1
\NewDocumentCommand{\transp}{m o}{%
  \ensuremath{({#1},%
  \IfNoValueTF{#2}%
    {{#1}+1}%
    {#2}%
    )}
}

\NewDocumentCommand{\mycommand}{o}{%
  % <code>
  \IfNoValueTF{#1}
    {code when no optional argument is passed}
    {code when the optional argument #1 is present}%
  % <code>
}
% interchange
\newcommand{\IC}[1]{\ensuremath{\mathit{IC}({#1})}}

%%%%% Ambienti matematici  %%%%%%
\newtheorem{theorem}{Theorem}[section]
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}[theorem]{Corollary}

\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem*{notation}{Notation}
\newtheorem{remark}[theorem]{Remark}
\newtheorem{example}[theorem]{Example}


\title{Switch equivalence and weak prime domains for fusions}
\author{Paolo Baldan\and Davide Castelnovo\and  Andrea Corradini\and Fabio Gadducci}

\begin{document}
\maketitle



\begin{abstract}
\todo{	A VERY NICE ABSTRACT}
\end{abstract}

\tableofcontents
\section{Introduction}

\todo{A VERY NICE INTRODUCTION}

SOME IDEAS (BADLY WRITTEN, JUST TO START TO PUT IDEAS IN ORDER)

Graph-like structures are used in uncountably many setting for representing the dynamics of software systems: the graph represents the entities in the states and their relations, while rewriting steps, modifying the graph, model computational steps which produce state changes.

Rewriting over graph-like structures is elegantly captured by
DPO-rewriting over adhesive categories and their
variants~\cite{lack2005adhesive,ehrig2006weak}.  This has been largely
studied for so-called linear rewriting rules. Roughly speaking, with
linear rules a rewriting step can express the fact that some entities
in the current state are removed, some other are needed for the
rewriting step to occur but preserved and some new entities are
generated.

The computation described by a rewriting system can be naturally
interpreted as a distributed computation and a notion of independence
between rewriting steps naturally emerges. When different rules are
applied at ``distinct'' parts of the state, possibly overlapping on
preserved items, the rewriting steps can be naturally deemed as
independent and their application can occur in any order and possibly
concurrently. This phenomenon is formally captured by the so-called
Church-Rosser theorem of DPO rewriting and shift equivalence over derivations~\cite{CMREHL:AAGT}. This represent the basis for
viewing sequences of rewriting in the DPO approach as concurrent
computations and derive corresponding concurrent semantics. Derivation
traces can be quotiented by an equivalence relation which identifies
sequences of rewritings which differs only for the order of
independent steps, leading to so-called derivation traces. In turn,
the dependencies this setting can be captured by a classical structure
in concurrency theory, the so-called prime event structures~\cite{NPW:PNES} where
dependencies are reduced to causality and conflict~\cite{Handbook,Bal:PhD,Sch:RRSG}.


In some situations linear rules are not sufficiently expressive for capturing the dynamic of a system. This is the case when  a computational step is required not only to consume, preserve and generated, but also ``merge'' parts of the state. This happens, e.g.,
in nominal calculi where, as a result of name passing,
the received name is identified with a local one at the
receiver~\cite{CVY:ESSPE,Gad07} or in the modelling of bonding in biological/chemical processes~\cite{PUY:MBPE}.
 add EGGS, something about string diagrams?

Technically, describing fusions, in the DPO jargon, requires to move from linear to left-linear rewriting rules. While left-linear rules have been considered in various instances (mainly for graph rewriting( and some results concerning the corresponding rewriting theory have been put forward, to the best of our knowledge the phenomena arising when rewriting with left-linear rules in the general setting of adhesive categories (which capture most ``applications'') have not been systematically explored.

Here we perform this exploration by observing that a number of basic
properties of rewriting which play a role in the corresponding
rewriting and concurrency theory need a deep rethinking for
left-linear rules and we propose solutions for the problems which
arise.

Firstly, Church-Rosser theorem does not work out of the box: the
independence condition for adhesive categories does not extend
smoothly to left-linear rules, i.e., existence of an independence pair
does not ensure the possibility of switching two derivation and a
refined notion, involving the concept of a so-called filler has to be
introduced. The problem was identified already
in~\cite{baldan2011adhesivity} where a suitable subclass of adhesive
categories is identified where independence as induced by a filler
coincide with independence as induced by an independence pair.

Having a notion of independence between computation steps sits at the core of the possibility of viewing an execution trace as a concurrent computation. This is obtained by considering traces up to an equivalence that identifies traces differing only for the order of independent steps (e.g., interchange law~\cite{Mes92} in term rewriting, shift
equivalence~\cite{CMREHL:AAGT} in graph rewriting or permutation
equivalence~\cite{JJL80} in $\lambda$-calculus). While for linear rewriting systems this works smoothly, for left-linear ones one has to face the problem that if two rewriting steps $r_a r_b$ are independent, if we switch $r_a$ after $r_a$ and then switch it back we can obtain a computation which is not the original one, making the theory of derivation traces inconsistent. In order to solve this problem, we work in a subclass of adhesive categories where derivation steps can be switched in an ``essentially unique way''. We also identify a large class of adhesive categories, arising as presheaves, where the condition is automatically satisfied. [this solves also the previous problem, right?]


Additionally, a central property for linear rewriting systems is the fact that independence of two rewriting steps is a global notion, independently of the context in which the rewritings take place. This is at the basis of the possibility of capturing the dependencies between rewriting steps in terms of two basic relations, causality and conflict, investigated in~~\cite{Handbook,Bal:PhD,Sch:RRSG}.

This fails for left-linear rules where, as observed
in~\cite{baldan2017domains}, for graph rewriting, the possibility of
merging parts of the state leads to a sort of disjunctive causality,
i.e., a rewriting step, say $r_c$ can be enabled by two different
rewriting steps $r_a$ and $r_b$, in a way that in a derivation
$r_a r_b r_c$ steps $r_b$ and $r_c$ are independent since the presence
of $r_a$ in the past is sufficient for enabling $r_a$, while in
$r_b r_c r_a$ , the steps $r_b$ and $r_c$ are not independent. The
paper shows that for left-linear rewriting systems a special form of
globality of independence can be recovered.


The concurrent semantics of linear graph rewriting systems over
adhesive categories can be captured by prime event structures and
prime algebraic domains. The idea consists in considering a partially
ordered domain, where elements are concurrent computations
(derivations up to shift equivalence), and the order relates two
computations when the latter is an extension of the former.
%
Events are then identified with computations consisting of a rewriting
step with all its causes. This is generalised to adhesive categories
in~\cite{heindel2009category}. [IS THIS IN TOBIAS?]

In~\cite{baldan2017domains} it is observed for graph rewriting systems that the presence of fusions, the same event can be enabled by different minimal sets of events, i.e., a central property of the domain of configuration, namely stability, fails. This prevents the identification of a proper notion of causality and makes prime event structures and prime domains inadequate to represent computations with fusions. It is argued that the right class of structures capturing the concurrent behaviour in the presence of fusion are connected event structures and weak prime algebraic domains.
%
An event is still a computation that cannot be decomposed
as the join of other computations, hence, in order theoretical terms,
it is an irreducible.
%
However, due to unstability, irreducibles are not necessarily primes:
two different irreducibles can represent the same computation step
with different minimal enablings.  In~\cite{baldan2017domains} this
is worked out for DPO rewriting systems over graphs. However the proof
relies on a wrong characterisation of independence which fails for non
linear rules. Here we rework in depth the result and extend it to DPO
rewriting over a large class of adhesive categories.

\section{$\mathcal{M}$-adhesive categories}

This first section is devoted to recall the definition and the basic theory of \emph{$\mathcal{M}$-adhesive categories} \cite{azzi2019essence,ehrig2012,ehrig2014adhesive,lack2005adhesive}. 

\begin{notation} 
We stipulate here some notational conventions which will be used throughout this paper. 
\begin{itemize}\item 
	Given a category $\X$ we will not distinguish notationally between $\X$ and its class of objects: so that ``$X\in \X$'' means that $X$ belongs to the class of objects of $\X$.  
	\item 
	If $1$ is a terminal object in a category $\X$,  the unique arrow $X\to 1$ from another object $X$ will be denoted by $!_X$. Similarly, if $0$ is initial in $\X$ then $?_X$ will denote the unique arrow $0\to X$. %When $\X$ is $\Set$ and $1$ is a singleton, $\delta_x$ will denote the arrow $1\to X$ with value $x\in X$.
	\item  $\mor(\X)$, $\mon(\X)$ and $\reg(\X)$ will denote the class of all arrows, monos and regular monos of $\X$, respectively.
	
	\item Given an integer $n\in \mathbb{Z}$, $[0,n]$ will denote the set
	\[[0,n]:=\{x\in \mathbb{N}\mid x\leq n\}\]
	Indeed, if $n<0$, then $[0,n]=\emptyset$.
\end{itemize}
\end{notation}


\subsection{The Van Kampen property}
The key property that $\mathcal{M}$-adhesive categories enjoy is given by  the so-called \emph{Van Kampen condition} \cite{brown1997van,johnstone2007quasitoposes,lack2005adhesive}. We will recall it and examine some of its consequences. First of all we need to recall some terminology and facts regarding subclasses of $\mor(\X)$.

\begin{definition}
	Let $\X$ be a category and $\mathcal{A}$ a  subclass of $\mor(\X)$. We say that  $\mathcal{A}$ is
	\begin{itemize}
		\item 
		\emph{stable under pushouts (pullbacks)} if for every pushout (pullbacks) square 
		\[\xymatrix{A\ar[r]^f  \ar[d]_{m}& B \ar[d]^n \\ C \ar[r]_g & D}\]
		if $m \in \mathcal{A}$ ($n\in \mathcal{A}$) then $n \in \mathcal{A}$ ($m \in \mathcal{A}$);
		\item \emph{closed under composition} if $g, f\in \mathcal{A}$ implies $g\circ f\in \mathcal{A}$ whenever $g$ and $f$ are composable;
		\item \emph{closed under decomposition} if $g\circ f, g\in \mathcal{A}$ implies $f\in \mathcal{A}$.
	\end{itemize}
\end{definition}

\begin{remark}In the previous definition, ``decomposition'' corresponds to ``left cancellation'', but we prefer to stick to the name commonly used in literature (see e.g.~\cite{habel2012mathcal}).
\end{remark}


So equipped, we can introduce the notion of \emph{$\mathcal{A}$-Van Kampen square}.
\begin{definition}[Van Kampen property] Let $\X$ be a category  and consider the two diagrams below
	\[\xymatrix@C=10pt@R=10pt{&&&&&A'\ar[dd]|\hole_(.65){a}\ar[rr]^{f'} \ar[dl]_{m'} && B' \ar[dd]^{b} \ar[dl]_{n'} \\ A \ar[dd]_{m}\ar[rr]^{f}&&B\ar[dd]^{n}&&C'  \ar[dd]_{c}\ar[rr]^(.7){g'} & & D' \ar[dd]_(.3){d}\\&&&&&A\ar[rr]|\hole^(.65){f} \ar[dl]^{m} && B \ar[dl]^{n} \\C\ar[rr]_{g} &&D&&C \ar[rr]_{g} & & D}\]
	
	Given  a class of arrows $\mathcal{A}\subseteq \mor(\X)$, we say that the left square \emph{has the Van Kampen property relatively to $\mathcal{A}$}, or that it  is a \emph{$\mathcal{A}$-Van Kampen square} if:
	\begin{enumerate}
		\item is a pushout square;
		\item 	whenever the right cube has pullbacks as back and left faces and the vertical arrows belong to $\mathcal{A}$, then its top face is a pushout if and only if the front and right faces are pullbacks.
	\end{enumerate}
	Pushout squares which enjoy the ``if'' half of the second point of the condition above are called \emph{$\mathcal{A}$-stable}. 
	
We will call a $\mor(\X)$-Van Kampen ($\mor(\X)$-stable) square simply a \emph{Van Kampen} (\emph{stable}) square.
\end{definition}

Before proceeding further, we recall this classical result about pullbacks.

\begin{lemma}\label{lem:pb1}
	Let $\X$ be a category, and consider the following diagram 	in which the right square is a pullback.
	\[\xymatrix{X \ar[d]_{a} \ar[r]^{f}& \ar[r]^{g} Y \ar[d]^{b}& Z \ar[d]^{c}\\ A \ar[r]_{h}& B \ar[r]_{k}& C}\]
	Then the whole rectangle is a pullback if and only if the left square is one.
\end{lemma}

The previous result can be dualised to get an analogous lemma for pushouts.

\begin{lemma}\label{lem:po1}
	Let $\X$ be a category, and consider the following diagram 	in which the left square is a pushout.
	\[\xymatrix{X \ar[d]_{a} \ar[r]^{f}& \ar[r]^{g} Y \ar[d]^{b}& Z \ar[d]^{c}\\ A \ar[r]_{h}& B \ar[r]_{k}& C}\]
	Then the whole rectangle is a pushout if and only if the right square is one.
\end{lemma}

The following proposition establishes a key property of $\mathcal{A}$-Van Kampen squares with a mono as a side: they are not only pushouts, but also pullbacks.
\begin{proposition}\label{prop:pbpo} Let $\mathcal{A}$ be a class of arrows stable under pushouts and containing all the isomorphisms.  If $m\colon A\to C$ is mono and belongs to $\mathcal{A}$, then every $\mathcal{A}$-Van Kampen square
	\[\xymatrix{A\ar[r]^{g} \ar[d]_{m} & B \ar[d]^{n} \\ C \ar[r]_{f}  & D}\]
	is also a pullback square and $n$ is a monomorphism.
\end{proposition}
\begin{proof} We can start considering the cube below and noticing that $n$, being the pushout of $m\in \mathcal{M}$, belongs to $\mathcal{A}$ too.
	\[\xymatrix@C=13pt@R=13pt{&A\ar[dd]|\hole_(.65){\id{A}}\ar[rr]^{g} \ar[dl]_{\id{A}} && B \ar[dd]^{\id{B}} \ar[dl]_{\id{B}} \\ A  \ar[dd]_{m}\ar[rr]^(.65){g} & & B \ar[dd]_(.3){n}\\&A\ar[rr]|\hole^(.65){g} \ar[dl]^{m} && B \ar[dl]^{n} \\C \ar[rr]_{f} & & D}\]
	By construction the top face of the cube is a pushout and the back one a pullback. The left face is a pullback because $m$ is mono. Thus the $\mathcal{A}$-Van Kampen property yields that the front and the right faces are pullbacks. 
\end{proof}

The previous proposition, in turn, allows us to establish the following results.
\begin{lemma}\label{lem:varie}Let $\mathcal{A}$ be a class of arrows stable under pullbacks, pushouts and containing all isomorphisms.  Suppose that, the left square below is $\mathcal{A}$-Van Kampen, while the vertical faces in the right cube are pullbacks.
		\[\xymatrix@C=10pt@R=10pt{&&&&&A'\ar[dd]|\hole_(.65){a}\ar[rr]^{g'} \ar[dl]_{m'} && B' \ar[dd]^{b} \ar[dl]_{n'} \\ A \ar[dd]_{m}\ar[rr]^{g}&&B\ar[dd]^{n}&&C'  \ar[dd]_{c}\ar[rr]^(.7){f'} & & D' \ar[dd]_(.3){d}\\&&&&&A\ar[rr]|\hole^(.65){g} \ar[dl]^{m} && B \ar[dl]^{n} \\C\ar[rr]_{f} &&D&&C \ar[rr]_{f} & & D}\]
Supppose, moreover that $m:A\to C$ and $d:D'\to D$ are mono and that $d$ belongs to $\mathcal{A}$. Then $d\leq n$ if and only if $c \leq m$.
\end{lemma}

\begin{remark}
	Recall that, given two monos $m:M\to X$ and $n:N\to X$ with the same codomain, $m\leq n$ means that there exists a, necessarily unique and necessarily mono, $k:M\to N$ fitting in the triangle below:
	\[\xymatrix{M\ar[rr]^{k}  \ar[dr]_{m}&& N \ar[dl]^{n}\\ & X}\]
	Notice that, if $m\leq n$ and $n\leq m$, then the arrow $k:M\to N$ is an isomorphism.  
\end{remark}
\begin{remark}
	Notice that, since $d$ is a mono and the vertical faces are pullbacks, then $a, b$ and $c$ are monomorphisms too. Moreover, $n$ is mono by \Cref{prop:pbpo}, so that even $m'$ and $n'$ are monos.
\end{remark}

\begin{proof}
	$(\Rightarrow)$ By hypothesis there exists $k:D'\to B$ such that $n\circ k = d$. By \Cref{prop:pbpo}, the bottom face of the cube is a pullback. Thus there exists a unique $h:C'\to A$ as in the diagram below, implying the thesis.
		\[\xymatrix@C=40pt{C'  \ar[d]^{h}\ar[r]^{f'} \ar@/_.5cm/[dd]_{c}& D' \ar@/^.5cm/[dd]^{d}\ar[d]_{k}\\ A \ar[d]^{m} \ar[r]^{g} & B \ar[d]_{n} \\  C \ar[r]_f & D}\]
	
	\smallskip \noindent 
	$(\Leftarrow)$ Let $h:C\to A$ be such that $c=m\circ h$. By the $\mathcal{A}$-Van Kampen property the top face of the given cube is a pushout. Thus the dotted $k:D'\to B$ in the following diagram exists.
		\[\xymatrix@C=40pt{A' \ar@/_.5cm/[dd]_{a} \ar[d]^{m'} \ar[r]^{g'} & B' \ar[d]_{n'} \ar@/^.5cm/[dd]^{b} \\  C' \ar[d]^{h} \ar[r]_{f'} & D' \ar@{.>}[d]_{k}\\ A \ar[r]_g& B }\]
Moreover, by construction we have
\[\begin{split}
n\circ k \circ n' &= n\circ b\\&=d\circ n'\\&\\&
\end{split} \qquad \begin{split}
n\circ k \circ f' &= n\circ g\circ h\\&=f\circ m\circ h\\&=f\circ c\\&= d\circ f' \end{split}\]
We can therefore conclude that $n\circ k =d$. \qedhere 
\end{proof}

Finally, we can show that $\mathcal{A}$-stable pushouts enjoy a kind of \emph{pullback-pushout decomposition} property.

\begin{proposition}\label{prop:stab}Let $\X$ be a category and $\mathcal{A}$ a class of arrows stable under pullbacks. Suppose that, in the diagram below, the whole rectangle is an $\mathcal{A}$-stable pushout and the right square a pullback.
	\[\xymatrix{X \ar[d]_{a} \ar[r]^{f}& \ar[r]^{g} Y \ar[d]^{b}& Z \ar[d]^{c}\\ A \ar[r]_{h}& B \ar[r]_{k}& C}\]
	If the arrow $k$ is in $\mathcal{A}$ and it is a monomorphism,  then both squares are pushouts.
\end{proposition}

\begin{proof} We can begin noticing that $g$, being the pullback of $k$, is mono and in $\mathcal{A}$ too. Thus we can build the cube below, in which all the vertical faces are pullbacks, entailing that all the vertical arrows are in $\mathcal{A}$.
	\[\xymatrix@C=20pt@R=10pt{ & &X\ar[dl]_{f} \ar[ddd]^(.333333){\id{X}}|(.666666)\hole\ar[rrr]^{a} &&&A \ar[ddd]^{\id{A}} \ar[dl]^{h}\\& Y\ar[dl]_{\id{Y}} \ar[ddd]|(.333333)\hole_{\id{Y}} &&&B \ar[ddd]^{\id{B}} \ar[dl]_{\id{B}} \\Y \ar[ddd]_{g} \ar[rrr]^{b}&&& B\ar[ddd]^{k}\\&&X \ar[rrr]|(.34)\hole^{a}|(.67)\hole \ar[dl]_{f}&&& A \ar[dl]^{h}\\ & Y  \ar[dl]_{g}&&& B \ar[dl]^{k}\\ Z\ar[rrr]_{c} &&& C}\]
	By hypothesis the face is an $\mathcal{A}$-stable pushout and so its top one is a pushout. Using \Cref{lem:po1} we can conclude that the right half of the rectangle with which we have started is a pushout too. \qedhere 
\end{proof}

\subsection{$\mathcal{M}$-adhesivity}

In this section we will define the notion of $\mathcal{M}$-adhesivity \cite{azzi2019essence,ehrig2012,ehrig2014adhesive,heindel2009category,lack2005adhesive} and explore some of the consequence of such a property. 

\begin{definition}[$\mathcal{M}$-adhesive category]
	Let $\X$ be a category and consider a subclass $\mathcal{M}$ of the class $\mon(\X)$ of monomorphisms such that:
	\begin{enumerate}
		\item $\mathcal{M}$ contains all isomorphisms and is closed under composition;
		\item $\mathcal{M}$ is stable under pullbacks and pushouts.
	\end{enumerate} 
	We will use $m\colon X\mto Y$ to denote that an arrow $m\colon X\to Y$ belongs to $\mathcal{M}$. $\X$ is said to be \emph{$\mathcal{M}$-adhesive} if
	\begin{enumerate}
		\item for every $m\colon X\mto Y$ in $\mathcal{M}$ and $g\colon Z\to Y$, a pullback square
		\[\xymatrix{P\ar[r]^p \ar@{>->}[d]_{n}& X \ar@{>->}[d]^{m}\\ Z \ar[r]_g& Y}\]
		exists, such pullbacks will be called \emph{$\mathcal{M}$-pullbacks};
		\item for every $m\colon X\mto Y$ in $\mathcal{M}$ and $f\colon X\to Z$, a pushout square
		\[\xymatrix{X \ar[r]^f \ar@{>->}[d]_{m}& Z \ar[d]^{q}\\ Y\ar[r]_p &Q}\]
		exists, such pushouts  will be called \emph{$\mathcal{M}$-pushouts}; 
		\item  $\mathcal{M}$-pushouts are $\mathcal{M}$-Van Kampen squares.
	\end{enumerate}
	
A category $\X$ is said to be \emph{strictly $\mathcal{M}$-adhesive} if $\mathcal{M}$-pushouts are Van Kampen squares.	
\end{definition}

\begin{remark}\label{rem:diff}Our notion of $\mathcal{M}$-adhesivity follows \cite{ehrig2012,ehrig2014adhesive} and is different from the one of \cite{azzi2019essence}. What is called $\mathcal{M}$-adhesivity in that paper corresponds to our strict $\mathcal{M}$-adhesivity. Moreover, in \cite{azzi2019essence} the class $\mathcal{M}$ is assumed to be only stable under pullbacks. However, if $\mathcal{M}$ contains all split monos, then stability under pushouts can be deduced from the other axioms \cite[Prop.~$5.1.21$]{castelnovo2023thesis}.
\end{remark}


\begin{remark}\label{rem:salva} 
	\emph{Adhesivity} and \emph{quasiadhesivity} as defined in \cite{lack2005adhesive,garner2012axioms}  coincide with  strict $\mon(\X) $-adhesivity and strict $\reg(\X)$-adhesivity, respectively. 
\end{remark}

A first result we can prove regards closure under decomposition of $\mathcal{M}$.

\begin{proposition}\label{prop:deco}Let  $\mathcal{A}$ be a class of arrows stable under pullbacks. For every arrow $f\colon X\to Y$ and monomorphism $m\colon Y\to Z$, if $m\circ f \in\mathcal{A}$ then $f\in \mathcal{A}$.
\end{proposition}
\begin{proof}Take the diagram
	\[\xymatrix{X \ar[d]_{\id{X}}\ar[r]^{f}& Y \ar[r]^{\id{Y}}  \ar[d]_{\id{Y}}& Y \ar[d]^{m}\\
		X \ar[r]_{f}& Y \ar[r]_{m} & Z}\]
	Since $m$ is mono the right square is a pullback, while the left square is a pullback by construction. By \Cref{lem:pb1} the whole rectangle is a pullback and the thesis follows.
\end{proof}
\begin{corollary}\label{cor:deco}
	In every $\mathcal{M}$-adhesive category $\X$, the class $\mathcal{M}$ is closed under decomposition.
\end{corollary}

Another result which can be immediately established, with the aid of \Cref{prop:pbpo}, is the following one.
\begin{proposition}\label{prop:pbpoad}
	Let $\X$ be an $\mathcal{M}$-adhesive category. Then $\mathcal{M}$-pushouts are also pullback squares.
\end{proposition}

From \Cref{prop:pbpoad}, in turn, we can derive the following corollaries.
\begin{corollary}\label{cor:rego}
	In a $\mathcal{M}$-adhesive category $\X$, every $m\in\mathcal{M}$ is a regular mono.
\end{corollary}
\begin{proof}
Let $m$ be an element of $\mathcal{M}$ and consider its pushout along itself.
\[\xymatrix{X\ar@{>->}[r]^m \ar@{>->}[d]_m& Y\ar@{>->}[d]^{f}\\Y \ar@{>->}[r]_g & Z}\]
By \Cref{prop:pbpoad} this square is a pullback, proving that $m$ is the equalizer of the arrows $f,g\colon Y\rightrightarrows Z$. \qedhere 
\end{proof}

The following result now follows at once noticing that a regular monomorphism which is also epic is automatically an isomorphism.

\begin{corollary}\label{prop:bal}
If $\X$ is an $\mathcal{M}$-adhesive categories, then every epimorphisms in $\mathcal{M}$ is an isomorphisms. In particular, every adhesive category $\X$ is \emph{balanced}: if a morphism is monic and epic, then it is an isomorphism.
\end{corollary}


$\mathcal{M}$-adhesivity is well-behaved with respect to  the comma construction \cite{mac2013categories}, as shown by the following theorem.
\begin{theorem}[\cite{ehrig2006fundamentals,lack2005adhesive}]\label{lem:comma}
	Let $\A$ and $\B$ be respectively an $\mathcal{M}$-adhesive and an $\mathcal{M}'$-adhesive category. Let also $L:\A\rightarrow \C$ be a functor that preserves $\mathcal{M}$-pushouts, and  $R:\B\rightarrow \C$ be a functor which preserves pullbacks.Then $\comma{L}{R}$ is $\cma{M}{M'}$-adhesive, where 
	\[
	\cma{M}{M}':=\{(h,k)\in \mathcal{A}(\comma{L}{R}) \mid h\in \mathcal{M}, k\in \mathcal{M}'\}\]
\end{theorem}

In particular, we can apply this result to slices over and under a given object.

\begin{corollary}\label{cor:slice}
	Let  $X$ be an object of an $\mathcal{M}$-adhesive category $\X$. Then  $\X/X$ and $X/\X$ are, respectively, is $\mathcal{M}/X$- and $X/\mathcal{M}$-adhesive, where
	\[\mathcal{M}/X:=\{m\in  \mathcal{A}(\X/X) \mid m\in \mathcal{M} \} \qquad X/\mathcal{M}:=\{m\in  \mathcal{A}(X/\X) \mid m\in \mathcal{M} \}\]
\end{corollary}


Another categorical construction which preserves $\mathcal{M}$-adhesivity property is the formation of the category of functors.

\begin{theorem}[\cite{ehrig2006fundamentals,lack2005adhesive}]\label{thm:functors}
If $\X$ is an $\mathcal{M}$-adhesive category, then for every small category $\Y$, the category $\X^\Y$  of functors $\Y\to \X$ is $\mathcal{M}^{\Y}$-adhesive, where
\[\mathcal{M}^{\Y}:=\{\eta \in \mathcal{A}(\X^\Y) \mid \eta_Y \in \mathcal{M} \text{ for every } Y\in \Y\}\]
\end{theorem}

We can list various examples of $\mathcal{M}$-adhesive categories (see \cite{castelnovo2023thesis,CastelnovoGM22,lack2006toposes}).

\begin{example}\todo{Topos, ipergrafi e grafi}
\end{example}

\begin{example}
	\todo{grafi semplici}
\end{example}


\begin{example}\todo{GRAFI GERARCHICI}
\end{example}

\begin{example}\todo{term graph}
\end{example}

We end this section proving two properties of $\mathcal{M}$-adhesive categories:  $\mathcal{M}$-pushout-pullback decomposition and uniqueness of pushouts complements.


\begin{lemma}[$\mathcal{M}$-pushout-pullback decomposition]\label{lem:popb} Let $\X$ be an $\mathcal{M}$-adhesive category  and suppose that, in the diagram below, the whole rectangle is a pushout and the right square a pullback.
\[\xymatrix{X \ar[d]_{a} \ar[r]^{f}& \ar[r]^{g} Y \ar[d]^{b}& Z \ar[d]^{c}\\ A \ar[r]_{h}& B \ar[r]_{k}& C}\]
	Then the following statements hold true:
	\begin{enumerate}
\item if $a$ belongs to $\mathcal{M}$ and $k$ is a monomorphism,  then both squares are pushouts and pullbacks;
\item if $f$ and $k $ are in  $\mathcal{M}$, then both squares are pushouts and pullbacks.
	\end{enumerate}
\end{lemma}
\begin{proof}
\begin{enumerate}
	\item By \Cref{prop:stab}, it follows that both squares are pushouts, thus the thesis follows from \Cref{prop:pbpoad}.
	\item By hypothesis, $g$ is the pullback of an arrow in $\mathcal{M}$, thus it belongs to it. But then $g\circ f\in \mathcal{M}$ too  and the whole rectangle is a $\mathcal{M}$-pushout. Therefore, by \Cref{prop:pbpoad} a pullback, so that its left half is a pullback too, by \Cref{prop:pbpo}. Moreover $k\circ h$ is in $\mathcal{M}$ as the pushout of $g\circ f$ and, by \Cref{cor:deco}, we also know that $h\in \mathcal{M}$.  
	
	Using \Cref{lem:po1}, it is enough to show that the left half of the original rectangle is a pushout. We can build the following cube:
	\[\xymatrix@C=20pt@R=10pt{ & &X\ar@{>->}[dl]_{f} \ar[ddd]^(.333333){\id{X}}|(.666666)\hole\ar[rrr]^{a} &&&A \ar[ddd]^{\id{A}} \ar@{>->}[dl]^{h}\\& Y\ar[dl]_{\id{Y}} \ar[ddd]|(.333333)\hole_{\id{Y}} &&&B \ar[ddd]^{\id{B}} \ar[dl]_{\id{B}} \\Y \ar@{>->}[ddd]_{g} \ar[rrr]^{b}&&& B\ar@{>->}[ddd]^{k}\\&&X \ar[rrr]|(.34)\hole^{a}|(.67)\hole \ar@{>->}[dl]_{f}&&& A \ar@{>->}[dl]^{h}\\ & Y \ar[rrr]|(.67)\hole^{b} \ar@{>->}[dl]_{g}&&& B \ar@{>->}[dl]^{k}\\ Z\ar[rrr]_{c} &&& C}\]
	Its vertical faces are all pullbacks and all the vertical arrows are in $\mathcal{M}$, hence the top face is a pushout and we can conclude. \qedhere 
\end{enumerate}
\end{proof}

Let us turn our attention to pushout complements.

\begin{definition}[Pushout complement]
Let $f\colon X\to Y$ and $g\colon Y\to Z$ ba two composable arrows in a category $\X$. A \emph{pushout complement} for the pair $(f,g)$ is a pair $(h,k)$ with $h\colon X\to W$ and $k\colon W\to Z$ such that the square below commutes and it is a pushout.
\[\xymatrix{X \ar[r]^{f} \ar[d]_{h}& Y \ar[d]^{g} \\ W \ar[r]_{k}& Z}\]
\end{definition}

\begin{example}
	In a generic category $\X$, pushout complements may not exist: in $\Set$ the arrows $?_{2}\colon \emptyset \to 2$ and $!_2\colon 2\to 1$ do not have a pushout complement.
	
	Moreover, composable arrows $f\colon X\to Y$ and $g\colon Y\to Z$ may have  pushout complements which are non-isomorphic: for instance, in $\Set$ the two squares below are both pushouts.
	
	\[\xymatrix{2 \ar[r]^{!_2} \ar[d]_{\id{2}}& 1 \ar[d]^{\id{1}} & 2 \ar[r]^{!_2} \ar[d]_{!_2}& 1 \ar[d]^{\id{1}}\\ 2 \ar[r]_{!_2}& 1 & 1 \ar[r]_{\id{1}}& 1}\]
\end{example}

Working in an $\mathcal{M}$-adhesive category we can amend the second defect. 

\begin{lemma}[Uniqueness of pushouts complements]\label{lem:pocomp} 
Let $\X$ be a $\mathcal{M}$-adhesive category. Given $m\colon X\mto Y$ in $\mathcal{M}$ and $n\colon Y\to Z$, let $(h_1, k_1)$ and $(h_2, k_2)$ be pushout complements of $m$  and $n$ and $W_1=\cod{h_1}$, $W_2=\cod{h_2}$. Then there exists a unique isomorphism $f\colon W_1\to W_2$ making the following diagram commutative.
\[\xymatrix{&X \ar@{>->}[r]^{m} \ar[d]_{h_1} \ar@/_.3cm/[ddl]_{h_2}& Y \ar[d]^{n} \\ &W_1 \ar@{.>}[dl]^{f} \ar@{>->}[r]_{k_1} & Z \\ W_2 \ar@{>->}@/_.3cm/[urr]_{k_2}}\]
 
\end{lemma}
\begin{proof} By hypothesis
	$k_1$ and $k_2$, being the pushout of $m$, are elements of $\mathcal{M}$ and therefore are monomorphisms. In particular, $k_2$ is a monomorphism and this  entails at once the uniqueness of $f$.  Moreover, notice that the squares
	\[\xymatrix{X \ar@{>->}[r]^{m} \ar[d]_{h_1}& Y \ar[d]^{n}& X \ar[d]_{h_2}\ar@{>->}[r]^{m} & Y \ar[d]^{n}\\ W_1 \ar@{>->}[r]_{k_1} & Z & W_2 \ar@{>->}[r]_{k_2}& Z}\]
	are $\mathcal{M}$-pushouts and thus $\mathcal{M}$-Van Kampen.
	
Now, take the $\mathcal{M}$-pullback square
	\[\xymatrix{P\ar[r]^{p_1}  \ar[d]_{p_2}& W_1 \ar@{>->}[d]^{k_1}\\ W_2 \ar@{>->}[r]_{k_2} & Z}\]
	Since $k_1\circ h_1=k_2\circ h_2$, there exists a unique $g\colon X\to P$ fitting in
	\[\xymatrix{X \ar@/^.3cm/[drr]^{h_1} \ar@{.>}[dr]^{g} \ar@/_.3cm/[ddr]_{h_2}\\ &P\ar[r]^{p_1}  \ar[d]_{p_2}& W_1 \ar@{>->}[d]^{k_1}\\ &W_2 \ar@{>->}[r]_{k_2} & Z}\]
	We can then build the cubes
	\[\xymatrix@C=13pt@R=13pt{&X\ar[dd]|\hole_(.65){\id{X}}\ar[rr]^{g} \ar[dl]_{\id{X}} && P \ar[dd]^{p_1} \ar[dl]_{p_2} & &X\ar[dd]|\hole_(.65){\id{X}}\ar[rr]^{g} \ar[dl]_{\id{X}} && P \ar[dd]^{p_2} \ar[dl]_{p_1}\\ X  \ar@{>->}[dd]_{m}\ar[rr]^(.65){h_2} & & W_2 \ar@{>->}[dd]_(.3){k_2}& &  X  \ar@{>->}[dd]_{m}\ar[rr]^(.65){h_1} & & W_1 \ar@{>->}[dd]_(.3){k_1}\\&X\ar[rr]|\hole^(.65){h_1} \ar@{>->}[dl]^{m} && W_1 \ar@{>->}[dl]^{k_1} & &X\ar[rr]|\hole^(.65){h_2} \ar@{>->}[dl]^{m} && W_2 \ar@{>->}[dl]^{k_2}\\Y \ar[rr]_{n} & & Z & &Y \ar[rr]_{n} & & Z}\]
	
	Now, in both cubes the front and left faces are pullbacks, thus, by \Cref{lem:pb1}, their back face is a pullback too. Since $m\leq m$, \Cref{lem:varie} now entails that $k_1\leq k_2$ and $k_2\leq k_1$. Thus there exists an isomorphism $f\colon W_1\to W_2$ such that $k_1=k_2\circ f$. To see that $h_2=f\circ h_1$, we can compute:
	\begin{align*}
		k_2\circ f \circ h_1 & = k_1\circ h_1\\&= n\circ m\\&= k_2\circ h_2
	\end{align*}
	The claim now follows since $k_2$ is a monomorphism. \qedhere 
\end{proof}


\section{DPO rewriting and derivations}

$\mathcal{M}$-adhesive categories are the right context in which to perform abstract rewriting using the so-called ``douple pushout approach'' (DPO). We will recall the basic definitions and properties of this approach to abstract rewriting. 

\subsection{Left-linear DPO-rewriting systems}
We are now going to study rewriting systems in $\mathcal{M}, \mathcal{N}$-adhesive categories.

\begin{definition}[\cite{habel2012mathcal,heindel2009category}]
	Let $\X$ be a $\mathcal{M}$-adhesive category, a  \emph{left $\mathcal{M}$-linear} rule $\rho$ is a pair $(l,r)$ of arrows with the same domain, such that $l$ belongs to $\mathcal{M}$.  The rule $\rho$ is said to be \emph{$\mathcal{M}$-linear} if $r\in \mathcal{M}$ too. A rule $\rho$ is said to be \emph{consuming} if $l$ is not an isomorphism. We will represent a rule $\rho$ as a span 
	\[\xymatrix{L & K\ar[l]_{l} \ar[r]^{r} & R}\]
$L$ is the \emph{left-hand side}, $R$ is the \emph{right-hand side} and $K$ the \emph{glueing object}. 


A \emph{left-linear DPO-rewriting system} is a pair $(\X, \R)$ where $\X$ is a $\mathcal{M}$-adhesive category and $R$ is a set of left $\mathcal{M}$-linear rules. $(\X, \R)$ will be called \emph{linear} if every rule in $R$ is $\mathcal{M}$-linear.

Given  two objects $G$ and $H$ and a rule $\rho=(l,r)$ in $\R$, a \emph{direct derivation $\mathscr{D}$ from $G$ to $H$ applying the rule $\rho$}, is a diagram as the one below, in which both squares are pushouts. 
	\[\xymatrix{L \ar[d]_{n}& K \ar[d]^{k}\ar[l]_{l} \ar[r]^{r} & R \ar[d]^{h}\\G & \ar[l]^{f} D \ar[r]_{g}& H}\]
	The arrow $n$ is called the \emph{match} of the derivation, while $h$ is its \emph{back-match}.
	We will denote a direct derivation $\dder{D}$ between $G$ and $H$ as $\dder{D}\colon G\Mapsto H$. 
\end{definition}

\begin{example}\todo{
esempi di	derivazione}
\end{example}

\begin{remark}\label{exa:conc} Let  $\dder{D}\colon G\Mapsto H$ be the direct derivation 
		\[\xymatrix{L \ar[d]_{n}& K \ar[d]^{k}\ar[l]_{l} \ar[r]^{r} & R \ar[d]^{h}\\G & \ar[l]^{f} D \ar[r]_{g}& H}\]
	If $\phi\colon G'\to G$ and $\psi\colon H\to H'$ are two isomorphisms, 	we can consider the direct derivation	$\phi * \dder{D}*\psi \colon G'\Mapsto H'$ given by the following diagram.
	\[\xymatrix{L \ar[d]_{\phi^{-1} \circ n}& K \ar[d]^{k}\ar[l]_{l} \ar[r]^{r} & R \ar[d]^{\psi \circ h}\\G' & \ar[l]^{\phi^{-1} \circ f} D \ar[r]_{\psi \circ g}& H'}\]
	
	In particular, we will use $\phi*\dder{D}$ and $\dder{D}*\psi$  to denote $\phi*\dder{D}*\id{H}$ and $\id{G}*\dder{D}*\psi$.
\end{remark}

$\mathcal{M}$-adhesivity of $\X$ guarantes the essential uniqueness of the result obtained rewriting an object, as shown by the next proposition.

\begin{proposition}\label{prop:unique} Let $\X$  be a $\mathcal{M}$-adhesive category. Suppose that the two direct derivations $\mathscr{D}$ and $\mathscr{D'}$ below, with the same match and applying the same left $\mathcal{M}$-linear rule $\rho$ are given.
	\[\xymatrix{L \ar[d]_{m}& K \ar[d]^{k}\ar@{>->}[l]_{l} \ar[r]^{r} & R \ar[d]^{h} & L \ar[d]_{m}& K \ar[d]^{k'}\ar@{>->}[l]_{l} \ar[r]^{r} & R \ar[d]^{h'}\\G & \ar@{>->}[l]^{f} D \ar[r]_{g}& H & G & \ar@{>->}[l]^{f'} D' \ar[r]_{g'}& H'}\]
Then there exist isomorphisms $t\colon D\to D'$ and $s\colon H\to H'$ as in the following diagram.
\[\xymatrix@C=40pt{&&D' \ar[r]^{g'} \ar@{>->}@/_.45cm/[dll]_{f'}&H'\\G & L \ar[l]_{m} & K \ar[u]_{k'} \ar[d]^{k}\ar[r]^{r} \ar@{>->}[l]_{l} &R\ar[u]^{h'} \ar[d]_{h}\\&&D\ar@{>->}@/^.45cm/[ull]^{f}\ar@/^.4cm/@{.>}[uu]^(.4){t}|\hole \ar[r]_{g}&H\ar@/_.4cm/@{.>}[uu]_{s}}\]
\end{proposition}
\begin{proof}
	By construction, the pairs $(k, f)$ and $(k', f')$ are pushout complements of $l$ and $n$. Thus, the existence of the isomorphism $t\colon D\to D'$ follows from \Cref{lem:pocomp}. Now, computing we have
	\begin{align*}
		g'\circ t \circ k &= g' \circ k'\\&=h'\circ r
	\end{align*}
	Hence, we have the wanted $s\colon H\to H'$. To see that $s$ is an isomorphism, consider the diagram 
	\[\xymatrix{K  \ar@/^.4cm/[rr]^{k'}\ar[d]_{r} \ar[r]_{k}& \ar[r]_{t} D \ar[d]^{g}& D' \ar[d]^{g'}\\ R \ar@/_.4cm/[rr]_{h'} \ar[r]^{h}& H \ar[r]^{s}& H'}\]
	By hypothesis the whole rectangle and its left half are pushouts, therefore, by \Cref{lem:po1} its right square is a pushout too. The claim now follows from the fact that the pushout of an isomorphism is an isomorphism.
\end{proof}

If we look to direct derivations as transitions, it is natural to consider them as edges in a direct graph. Taking objects as vertices objects led us to the following definition \cite{heindel2009category}.

\begin{definition}
	Let $(\X, \R)$ be a DPO-rewrityng system, with $\X$ $\mathcal{M}$-adhesive. The \emph{DPO-derivation graph} of $(\X, \R)$ is the (large)  directed graph $\gpo$ having as vertices the objects of $\X$ and in which an edge between $G$ and $H$ is a direct derivation $\dder{D}\colon G\Mapsto H$.	A \emph{derivation} $\der{D}$ between two objects $G$ and $H$ is a path between them in $\gpo$. The \emph{source} and \emph{target} of $\der{D}$ are, respectively, $G$ and $H$.
\end{definition}

\begin{remark}
We can spell out more explicitly what  a derivation $\dder{D}$ is.  An \emph{empty derivation} starting and ending in $G$ is just $G$ itself.  A \emph{non-empty derivation} $\dder{D}$ is a sequence $\{\dder{D}_i\}_{i=0}^n$ of direct derivations such that:
\begin{enumerate}
	\item for every index $i$, $\dder{D}_i$ is a direct derivation $G_i \Mapsto G_{i+1}$;
	\item $G_0=G$ and $G_{n+1}=H$.
\end{enumerate}

We will call the number $n+1$ the \emph{length} of the derivation, denoted by $\lgh(\der{D})$. We will also say that an empty derivation has length $0$. 

Moreover,  if every $\dder{D}_i$ applies the rule $\rho_i\in R$, then we can define an associated sequence of rules as $r(\der{D})$ as $\{\rho_i\}_{i=0}^n$.
\end{remark}

\begin{remark}\label{rem:func}
	Consider a derivation $\der{D}$ in a DPO-rewriting system $(\X, \R)$. We can take the subcategory $\Delta(\der{D})$ of $\X$ given by the arrows appearing in $\der{D}$. This subcategory comes equipped with an inclusion functor $I(\der{D})\colon \Delta(\der{D})\to \X$. Moreover, we can further define $\Deltamin(\der{D})$ as the subcategory of $\Delta(\der{D})$ containing only the bottom row of the derivation.
\end{remark}
	
\begin{notation}Let $\der{D}=\{\dder{D}_i\}_{i=0}^n$ be a derivation. We will depict the $i^\text{th}$ element $\dder{D}_i$ of $\der{D}$ as in the following diagram.  
	\[\xymatrix{L_i \ar[d]_{m_i}& K_i \ar[d]^{k_i}\ar[l]_{l_i} \ar[r]^{r_i} & R_i \ar[d]^{h_i} \\G_{i} & \ar[l]^{f_{i}} D_{i} \ar[r]_{g_{i}}& G_{i+1} }\]
	Notice that, in particular, if $\der{D}\colon G\to H$, then $G_0=G$ and $G_{n+1}=H$. When $\der{D}$ has length $1$ we will suppress the indexes. In such case, we will also identify $\der{D}$ with its only element. 
\end{notation} 

\begin{example}\todo{esempi di derivazione}
\end{example}

\begin{definition}
	The \emph{DPO-derivation category} $\dpo$ of a DPO-rewriting system $(\X, \R)$ is the category in which arrows between $G$ and $H$ are given by, possibly empty, derivations. Composition is concatenation of paths in $\gpo$ and identities are given by empty derivations.
\end{definition} 	
\begin{remark}
	More explicitly, given $\der{D}=\{\dder{D}\}_{i=0}^n$ between $G$ and $H$ and $\der{D}'=\{\dder{D}'_i\}_{i=0}^m$, their concatenation $\der{D}\cdot\der{D}'$ is the derivation $\{\dder{E}_i\}_{i=0}^{m+n+1}$ in which
	\[\dder{E}_i:=\begin{cases}
		\dder{D}_i & i \leq n\\
		\dder{D}'_{i-(n+1)} & n< i 
	\end{cases}\]	

Notice, moreover that, $\der{D}\cdot \der{D'}$ is equal to $\der{D}'$ if $\der{D}$ is empty, while it coincides with $\der{D}$ if $\der{D}'$ has length zero.
\end{remark}

 \Cref{exa:conc} allows us to compose derivations with isomorphisms.

\begin{definition} Let $(\X, \R)$ be a a left-linear DPO-rewriting system. Given a derivation $\der{D}=\{\dder{D}_{i}\}_{i=0}^n$ between $G$ and $H$ and isomorphisms $\phi\colon G\to G'$, $\psi\colon H\to H'$, the derivations  $\phi*\der{D}$ and $\der{D}*\psi$ are defined as
	\[\phi *\der{D} := \begin{cases}
		G' & \lgh(\der{D})=0\\ 
		\{\phi* \dder{D}_0\}\cdot \{\dder{D}_i\}_{i=1}^{n}  & \lgh(\der{D})\neq 0
	\end{cases}\] 
	\[\der{D}*\psi := \begin{cases}
		H' & \lgh(\der{D})=0\\ 
		 \{\dder{D}_i\}_{i=0}^{n-1} \cdot \{\dder{D}_n*\psi\} & \lgh(\der{D})\neq 0
	\end{cases}\] 

	Moreover, if $\lgh(\der{D})>0$,  we define the derivation $\phi *\der{D} * \psi$ as
	\[\phi *\der{D} * \psi = \{\phi* \dder{D}_0\}\cdot \{\dder{D}_i\}_{i=1}^{n-1} \cdot \{\dder{D}_n*\psi\}\] 
\end{definition}

\begin{remark}
When $\der{D}$ consists only in the direct derivation $\dder{D}$, then $\phi*\der{D}*\psi$ is the derivation of length one whose unique element is $\phi*\dder{D}*\psi$.
\end{remark}

We are often interested in an object of $\X$ only up to isomorphism. It is therefore useful to consider a version of $\gpo$ in which vertices are classes of isomorphism of object of $\X$. In order to do so, some preliminary work is needed.

\begin{definition}\cite{mac2013categories}
Let $\X$ be a category, we say that  $\X$ is \emph{skeletal} if, for every two objects $X$ and $Y$, the existence of an isomorphism $\phi\colon X\to Y$ entails $X=Y$. A \emph{skeleton} for a category $\X$ is a full subcategory $\ske$ which is skeletal and such that the inclusion functor $\ske\to \X$ is an equivalence. 
\end{definition}

\begin{remark}
By definition the inclusion $\ske \to \X$ is an equivalence. In particular, this mean that, for every objects $X$ of $\X$ there exists $\pi(X)$ in $\ske$ and an isomorphism $\phi_X\colon \pi(X) \to X$.
\end{remark}

\begin{proposition}\label{prop:ske}
	Every category $\X$ has a skeleton. 
\end{proposition}
\begin{proof}
	For every object $X\in \X$, pick a single representative $\pi(X)$ of its isomorphism class. Let $\ske$ be the full subcategory given by these objects. By definition $\ske$ is skeletal and the inclusion functor is full, faithful and essentially surjective.\qedhere 
\end{proof}
\begin{remark}
	The proof of \Cref{prop:ske} relies on the axiom of choice for classes.
	\end{remark}
\begin{remark}
	It is possible to proof that every two skeleta of a given category $\X$ are isomorphic (not only equivalent). For the remaining of this paper we assume that a skeleton $\ske$ of $\X$ and a functor $\pi\colon \X\to \ske$ are chosen once and for all.
\end{remark}

\begin{definition}
	Let $(\X, \R)$ be a DPO-rewriting system, a \emph{decorated derivation} between two objects $G$ and $H$ is a triple $(\der{D}, \alpha, \omega)$, where $\der{D}$ is a derivation between $G$ and $H$, and $\alpha\colon \pi(G)\to G$ and $\omega\colon \pi(H)\to H$ are isomorphisms.
\end{definition}

\begin{notation}
	We will extend the use of the words length, source and target to decorated derivations in the obvious way, forgetting the decorations $\alpha$ and $\omega$.
\end{notation}

\begin{example}A decorated derivation $(\der{D}, \alpha, \omega)$ with $\der{D}$ empty is just a span
	\[\xymatrix{G & \pi(G) \ar[r]^-{\omega} \ar[l]_-{\alpha} & G}\]
	in which both $\omega$ and $\alpha$ are isomorphisms.
\end{example}

As we are interested in objects only up to isomorphism, so we are interested in (decorated) derivations only up to some notion of coherent isomorphism between them. This is done with the help of \Cref{rem:func}.

\begin{definition}Let $(\X, \R)$ be a DPO-rewriting system,  an \emph{abstraction equivalence} between two derivations $\der{D}$ and $\der{D'}$ with the same length and such that $r(\der{D})=r(\der{D}')$, is a family of isomorphisms $\{\phi_X\}_{X\in \Deltamin(\der{D})}$ such that, for every $i\in [0, \lgh(\der{D})]$ the following diagram commutes
	\[\xymatrix@C=40pt{G'_i&D'_i \ar[r]^{g'_i} \ar[l]_{f'_i}&G'_{i+1}\\  L_i \ar[u]^{n'_i} \ar[d]_{n_i}& K_i \ar[u]^{k'_i} \ar[d]_{k_i} \ar[r]^{r_i} \ar[l]_{l_i} &R\ar[u]^{h'_i} \ar[d]_{h_i}\\G_i \ar@/_.45cm/[uu]_(.35){\phi_{G_i}}|\hole&D_i\ar[l]^{f_i}\ar@/_.45cm/[uu]_(.35){\phi_{D_i}}|\hole \ar[r]_{g_i}&G_{i+1}\ar@/_.45cm/[uu]_{\phi_{H_i}}}\]

Given two decorated derivations $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$, we say that they are \emph{abstraction equivalent}, if $\lgh(\der{D})=\lgh(\der{D}')$, $r(\der{D})=r(\der{D'})$, and there exists an of abstraction equivalence between $\der{D}$ and  $\der{D}$ such that the triangles below commute.
\[\xymatrix@C=15pt{&\pi(G_0) \ar[dr]^{\alpha'} \ar[dl]_{\alpha}&&& \pi(G_{n+1}) \ar[dr]^{\omega'} \ar[dl]_{\omega}\\ G_0 \ar[rr]_{\phi_{G_0}} && G'_0 &G_{n+1} \ar[rr]_{\phi_{G_{n+1}}} && G'_{n+1} } \]
We will use $\equiv^a$ to denote the resulting relation.
\end{definition}

\begin{remark}\label{rem:equi}
	It is immediate to see that $\equiv^a$ is an equivalence relation. Indeed $(\der{D}, \alpha, \omega)$ is abstract equivalent to itself via the abstract equivalence with the identities as components. Furthermore, if  $\{\phi_X\}_{X\in \Deltamin(\der{D})}$  witnesses $(\der{D}, \alpha, \omega)\equiv_a (\der{D}', \alpha', \omega')$, then considering $\{\phi^{-1}_X\}_{X\in \Deltamin(\der{D})}$ shows $(\der{D}', \alpha', \omega)\equiv_a (\der{D}, \alpha, \omega)$. Finally, transitivity is assured composing abstract equivalences. 
	
	We will denote by $[\der{D}, \alpha, \omega]_a$ is just the equivalence class of  $(\der{D}, \alpha, \omega)$.
	 Such equivalence classes will be called  \emph{abstract decorated derivation}.  
\end{remark}

\begin{remark}\label{rem:empty}
Let $(\der{D},\alpha, \omega)$ be an empty derivation from an object $G$ and  $(\der{D}',\alpha', \omega')$ a another empty one from $G'$.  If $(\der{D},\alpha, \omega)\equiv_a(\der{D}',\alpha', \omega')$ then an abstraction equivalence between $\der{D}$ and $\der{D}'$ is just an isomorphism $\phi\colon G\to G'$, so that $\pi(G)=\pi(G')$. Moreover, such isomorphism must fit in the diagrams below.
\[\xymatrix@C=15pt{&\pi(G) \ar[dr]^{\alpha'} \ar[dl]_{\alpha}&&& \pi(G) \ar[dr]^{\omega'} \ar[dl]_{\omega}\\ G\ar[rr]_{\phi} && G' &G \ar[rr]_{\phi} && G' } \]
In particular, these two triangles imply that
\begin{align*}
	\alpha'\circ \alpha^{-1}&=\phi \\&=\omega'\circ \omega^{-1}
\end{align*}
\end{remark}

\begin{remark}\label{rem:res} \Cref{prop:unique} can be restated as saying that, given two direct derivations $\dder{D}$ and $\dder{D'}$ with the same match, there exists an abstract equivalence between them whose first component is an identity.
\end{remark}

\begin{remark}\label{rem:absequi}
	Let $\der{D}$ be a derivation with source $G$ and target $H$. Let also $\phi\colon G'\to G$ and $\psi\colon H\to H'$ be two isomorphisms. Then for every $X\in \Deltamin(\der{D})$ we can define 
	\[\varphi_X:=\begin{cases}
		\phi^{-1} & X=G\\
		\id{X} & \text{otherwise}
	\end{cases} \qquad \varphi'_X:=\begin{cases}
	\psi & X=H\\
	\id{X} & \text{otherwise}
	\end{cases}\]
It is immediate to see that the family $\{\varphi_X\}_{X\in \Deltamin(\der{D})}$ is an abstraction equivalence between $\der{D}$ and $\phi *\der{D}$, while $\{\varphi'_X\}_{X\in \Deltamin(\der{D})}$ is one between $\der{D}$ and $\der{D}*\psi$.
\end{remark}

\begin{definition}\label{def:conc}
Let $(\der{D}, \alpha, \omega)$ be a decorated derivation between $G$ and $H$ and $(\der{D}', \alpha', \omega')$ one between $H'$ and $K$. If $H$ and $H'$ are isomorphic, so that $\pi(H)=\pi(H')$, we define the  \emph{composite decorated derivation} putting
\[(\der{D}, \alpha, \omega)\cdot (\der{D}', \alpha', \omega'):=\begin{cases}
(\der{D}', \alpha'\circ \omega^{-1}\circ \alpha, \omega')	&\lgh(\der{D})=0 \\
	(\der{D}, \alpha, \omega \circ (\alpha')^{-1}\circ \omega')&\lgh(\der{D}')=0 \text{ and } \lgh(\der{D})\neq 0\\
(\der{D}*\omega^{-1}\cdot \alpha'*\der{D'}, \alpha, \omega')	&\text{otherwise}
\end{cases}\]
\end{definition}


\begin{remark}\label{rem:lgt}
	Let $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ two composable decorated derivations   such that $\lgh(\der{D})=n$ and $\lgh(\der{D}')=m$.	 Then $(\der{D}*\omega^{-1}\cdot \alpha'*\der{D'}, \alpha, \omega')$ has length $n+m$.
\end{remark}

The next proposition justifies the use of decorations, guaranteeing that concatenation of abstract decorated derivations is well-defined.
\begin{lemma}\label{lem:conc}
	Given a decorated derivation $(\der{D}, \alpha, \omega)$  between $G$ and $H$ and  another one $(\der{E}, \beta, \xi)$ between $E$ and $K$ with $\pi(H)=\pi(E)$. If  $(\der{D}', \alpha', \omega')$ and $(\der{E}', \beta', \xi')$ are two other decorated derivations such that
	\[[\der{D}, \alpha, \omega]_a = [\der{D}', \alpha', \omega']_a \qquad [\der{D}, \beta, \xi]_a=[\der{E}', \beta', \xi']_a\]
	Then
	\[[(\der{D}, \alpha, \omega)\cdot (\der{E}, \beta, \xi)]_a=[(\der{D}', \alpha', \omega')\cdot (\der{E}', \beta', \xi')]_a\]
\end{lemma}

\begin{proof} Take two abstraction equivalences $\{\phi_X\}_{X\in \Deltamin(\der{D})}$ and $\{\varphi_X\}_{X\in \Deltamin(\der{D})}$ between $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ and between $(\der{E}, \beta, \xi)$ and $(\der{E}', \beta', \xi')$, respectively. To fix the notation, suppose that goes from $G'$ to $H'$ and $(\der{E}', \beta', \xi')$ from $E'$ to $K'$. We have three cases.
	
\begin{itemize}
	\item $\lgh(\der{D})=0$. Then, $\lgh(\der{D}')$ is $0$ too. By \Cref{def:conc} we have
	\begin{align*}
	(\der{D}, \alpha, \omega)\cdot (\der{E}, \beta, \xi)&=(\der{E}, \beta\circ \omega^{-1}\circ \alpha, \xi)\\
		(\der{D}', \alpha', \omega')\cdot (\der{E}', \beta', \xi')&=(\der{E}', \beta'\circ (\omega')^{-1}\circ \alpha', \xi')
	\end{align*}
 Now, notice that $G$ and $H$ must coincide. Moreover, by \Cref{rem:empty} we also know that $\pi(G)=\pi(G')$ too. The same \Cref{rem:empty} entails that the inner squares of the following diagram are commutative, so that the whole rectangle commutes too.
 \[\xymatrix@C=35pt{\pi(G) \ar[r]^{\alpha} \ar[d]_{\id{\pi(G)}}& G  \ar[d]_{\phi_G}\ar[r]^-{\omega^{-1}} & \pi(G) \ar[d]_{\id{\pi(G)}} \ar[r]^{\beta}& E \ar[d]^{\varphi_E}\\\pi(G') \ar[r]_{\alpha'}& G' \ar[r]_-{(\omega')^{-1}} & \pi(G') \ar[r]_{\beta'} & E'}\]
 
 We can  then conclude that $\{\varphi_X\}_{X\in \Deltamin(\der{D})}$ witnesses the fact that $(\der{E}, \beta\circ \omega^{-1}\circ \alpha, \xi)$ is abstraction equivalent to $(\der{E}', \beta'\circ (\omega')^{-1}\circ \alpha', \xi')$.

\item $\lgh(\der{D})\neq 0$ and $\lgh(\der{E})= 0$. As in the point above, we get that also $\der{E}'$  is an empty derivation, thus we have
\begin{align*}
	(\der{D}, \alpha, \omega)\cdot (\der{E}, \beta, \xi)&=(\der{D},  \alpha, \omega \circ \beta^{-1}\circ \xi)\\
	(\der{D}', \alpha', \omega')\cdot (\der{E}', \beta', \xi')&=(\der{D}',  \alpha', \omega' \circ (\beta')^{-1}\circ \xi')
\end{align*}
In this case we have that $E=K$ and that $\pi(E)=\pi(E')$. From \Cref{rem:empty} we deduce that the diagram below commutes.
\[\xymatrix@C=35pt{\pi(E) \ar[r]^{\xi} \ar[d]_{\id{\pi(E)}}& E  \ar[d]_{\varphi_E}\ar[r]^-{\beta^{-1}} & \pi(E) \ar[d]_{\id{\pi(E)}} \ar[r]^{\omega}& H \ar[d]^{\phi_H}\\\pi(E') \ar[r]_{\xi'}& E' \ar[r]_-{(\beta')^{-1}} & \pi(E') \ar[r]_{\omega'} & H'}\]
The thesis now follows at once.
	\item $\lgh(\der{D})\neq 0$ and $\lgh(\der{E})\neq 0$. In this case we have
	\begin{align*}
		(\der{D}, \alpha, \omega)\cdot (\der{E}, \beta, \xi)&=(\der{D}*\omega^{-1}\cdot \beta*\der{E}, \alpha, \xi)\\
		(\der{D}', \alpha', \omega')\cdot (\der{E}', \beta', \xi')&=(\der{D}'*(\omega')^{-1}\cdot \beta'*\der{E'}, \alpha', \xi')
	\end{align*}
 To fix the notation, suppose that $\der{D}$, $\der{D}'$, $\der{E}$ and $\der{E}'$ are given by
	\[\der{D}=\{\dder{D}_i\}_{i=0}^n \quad \der{D}'=\{\dder{D}'_i\}_{i=0}^n \quad \der{E}=\{\dder{E}_i\}_{i=0}^t \quad \der{E}'=\{\dder{E}'_i\}_{i=0}^t\]
	Moreover, noticing that the rule applied by $\dder{D}_i$ and the one applied in $\mathcal{E}_i$  must coincide with, respectively, the one applied in $\dder{D}'_i$ and the one applied $\dder{E}'_i$. We will also assume that $\dder{D}_i$, $\dder{D}'_i$, $\dder{E}_i$ and $\dder{E}'_i$ are given, respectively, by the following four diagrams. 
	\[\xymatrix{L_{\der{D},i} \ar[d]_{m_{\der{D}, i}}& K_{\der{D},i} \ar[d]_{k_{\der{D}, i}} \ar[r]^{r_{\der{D},i}} \ar[l]_{l_{\der{D},i}} & R_{\der{D},i}\ar[d]^{h_{\der{D}, i}} &L_{\der{E},i} \ar[d]_{m_{\der{E}, i}}& K_{\der{E},i} \ar[d]_{k_{\der{E}, i}} \ar[r]^{r_{\der{E},i}} \ar[l]_{l_{\der{E},i}} & R_{\der{E},i}\ar[d]^{h_{\der{E}, i}} \\G_i & D_i \ar[r]_{g_{\der{D},i}} \ar[l]^{f_{\der{D},i}} & G_{i+1} & E_i & F_i\ar[r]_{g_{\der{E},i}} \ar[l]^{f_{\der{E},i}}  & E_{i+1}}\]
	\[\xymatrix{L_{\der{D},i} \ar[d]_{m_{\der{D}', i}}& K_{\der{D},i} \ar[d]_{k_{\der{D}', i}} \ar[r]^{r_{\der{D},i}} \ar[l]_{l_{\der{D},i}} & R_{\der{D},i}\ar[d]^{h_{\der{D}', i}} &L_{\der{E},i} \ar[d]_{m_{\der{E}', i}}& K_{\der{E},i} \ar[d]_{k_{\der{E}', i}} \ar[r]^{r_{\der{E},i}} \ar[l]_{l_{\der{E},i}} & R_{\der{E},i}\ar[d]^{h_{\der{E}', i}} \\G'_i & D'_i \ar[r]_{g_{\der{D}',i}} \ar[l]^{f_{\der{D}',i}} & G'_{i+1} & E'_i & F'_i\ar[r]_{g_{\der{E}',i}} \ar[l]^{f_{\der{E}',i}}  & E'_{i+1}}\]
	
Now, for every $X\in \Deltamin(\der{D}*\omega^{-1}\cdot \beta*\der{E})$ we can define
\[\psi_X:=\begin{cases}
	\phi_X & X\in  \Deltamin(\der{D})\text{ and } X\neq H\\\varphi_X & X\in  \Deltamin(\der{E}) \text{ and } X\neq E\\\id{\pi(H)}& X=\pi(H)\end{cases}\]
Notice that, since $\psi_G=\phi_G$ and $\psi_K=\varphi_K$ we have at once  the commutativity of the triangles
\[\xymatrix@C=15pt{&\pi(G) \ar[dr]^{\alpha'} \ar[dl]_{\alpha}&&& \pi(K) \ar[dr]^{\xi'} \ar[dl]_{\xi}\\ G\ar[rr]_{\psi_G} && G' &K \ar[rr]_{\psi_K} && K' } \]


To show that $\{\psi_X\}_{\Deltamin(\der{D}*\omega^{-1}\cdot \beta*\der{E})}$ is an abstraction equivalence, it is now enough to prove the commutativity of the diagrams
	\[\xymatrix@C=45pt@R=15pt{G'_n&D'_n \ar[r]^-{(\omega')^{-1}\circ g_{\der{D}',n}} \ar@/_.2cm/[dr]_(.6){g_{\der{D}',n}} \ar[l]_{f_{\der{D}',n}}&\pi(H') \\&&H' \ar[u]^{(\omega')^{-1}}\\  L_{\der{D}, n} \ar[uu]^{m_{\der{D}',n}} \ar[dd]_{m_{\der{D},n}}& K_{\der{D}, n} \ar[uu]^{k_{\der{D}',n}} \ar[dd]_{k_{\der{D},n}} \ar[r]^{r_{\der{D},n}} \ar[l]_{l_{\der{D},n}} &R_{\der{D}, n}\ar[u]^{h_{\der{D}',n}} \ar[d]_{h_{\der{D},n}}\\&&H \ar[d]_{\omega^{-1}}\\G_n \ar@/_.7cm/[uuuu]_(.35){\phi_{G_n}}|\hole&D_n\ar[l]^{f_{\der{D},n}}\ar@/_.7cm/[uuuu]_(.35){\phi_{D_n}}|\hole \ar@/^.2cm/[ur]^(.6){g_{\der{D},n}}\ar[r]_{\omega^{-1}\circ g_{\der{D},n}}&\pi(H)\ar@/_.7cm/[uuuu]_{\id{\pi(H)}}\\ \pi(E')&F'_0 \ar[l]_-{(\beta')^{-1}\circ f_{\der{E}',0}} \ar@/^.2cm/[dl]^(.6){f_{\der{E}',0}} \ar[r]^{g_{\der{E}',0}}&E'_1 \\E' \ar[u]_{(\beta')^{-1}}&& \\  L_{\der{E}, 0} \ar[u]_{m_{\der{E}', 0}} \ar[d]^{m_{\der{E}, 0}}& K_{\der{E}, 0} \ar[uu]_{k_{\der{E}', 0}} \ar[dd]^{k_{\der{E}, i}} \ar[r]^{r_{\der{E},0}} \ar[l]_{l_{\der{E},0}} &R_{\der{E}, 0}\ar[uu]_{h_{\der{E}',0}} \ar[dd]^{h_{\der{E},0}}\\E \ar[d]^{\beta^{-1}}&& \\\pi(E) \ar@/^.7cm/[uuuu]^{\id{\pi(E)}}&F_0\ar[l]^{\beta^{-1}\circ f_{\der{E},0}}\ar@/^.7cm/[uuuu]^(.35){\varphi_{F_0}}|\hole \ar@/_.2cm/[ul]_(.6){f_{\der{E},0}}\ar[r]_{g_{\der{E},0}}&E_1\ar@/^.7cm/[uuuu]^(.35){\varphi_{E_1}}|\hole}\]
		
To see this, in turn, it is enough to show that	the squares
\[\xymatrix{&R_{\der{D}, n} \ar[d]_{h_{\der{D}, n}}\ar[r]^{h_{\der{D}', n}} & H' \ar[d]^{(\omega')^{-1}} &L_{\der{E}, 0} \ar[d]_{m_{\der{E}, 0}}\ar[r]^{m_{\der{E}', 0}}& E' \ar[d]^{(\beta')^{-1}}\\&H\ar[r]_{\omega^{-1}} &\pi(H)&E \ar[r]_{\beta^{-1}} & \pi(E)\\D_n \ar[rr]^{\phi_{D_n}} \ar[d]_{g_{\der{D}, n}}&&D'_n \ar[d]^{g_{\der{D}', n}}&F_0 \ar[d]_{f_{\der{E}, 0}} \ar[rr]^{\varphi_{F_0}} && F_0' \ar[d]^{f_{\der{E}', 0}}\\H \ar[r]_-{\omega^{-1}} &\pi(H)&H' \ar[l]^-{(\omega')^{-1}}  &E \ar[r]_-{\beta^{-1}} & \pi(E) & E' \ar[l]^-{(\beta')^{-1}}}\]
are commutative. For the first ones, we have
	\begin{align*} 
	\omega^{-1} \circ h_{\der{D}, n}&=\id{\pi(H)}\circ \omega^{-1} \circ h_{\der{D}, n} \\&=(\omega')^{-1}\circ \phi_H \circ \omega \circ \omega^{-1} \circ h_{\der{D}, n}\\&=(\omega')^{-1}\circ \phi_H  \circ h_{\der{D}, n}\\&=(\omega')^{-1}  \circ h_{\der{D}', n}
\end{align*} 
and
\begin{align*} 
	\beta^{-1} \circ m_{\der{E}, 0}&=\id{\pi(E)}\circ \beta^{-1} \circ m_{\der{E}, 0}\\&=(\beta')^{-1}\circ \varphi_{E} \circ \beta \circ \beta^{-1} \circ m_{\der{E}, 0}\\&=(\beta')^{-1}\circ \varphi_{E}  \circ m_{\der{E}, 0}\\&=(\beta')^{-1}  \circ m_{\der{E}', 0}
\end{align*} 

The commutativity of the second row of diagrams follows from
\begin{align*}
 \omega^{-1} \circ g_{\der{D}, n}&=\id{\pi(H)}\circ \omega^{-1} \circ g_{\der{D}, n}\\&=(\omega')^{-1}\circ \phi_H \circ \omega\circ \omega^{-1} \circ g_{\der{D}, n}\\&=(\omega')^{-1}\circ \phi_H  \circ g_{\der{D}, n}\\&= (\omega')^{-1} \circ g_{\der{D}', n}\circ \phi_{D_n}
r\end{align*}
and
\begin{align*}
	\beta^{-1} \circ f_{\der{E}, 0}&=\id{\pi(E)}\circ \beta^{-1} \circ f_{\der{E}, 0}\\&=(\beta')^{-1}\circ \varphi_E \circ \beta\circ \beta^{-1} \circ f_{\der{E}, 0}\\&=(\beta')^{-1}\circ \varphi_E  \circ f_{\der{E}, 0}\\&= (\beta')^{-1} \circ f_{\der{E}', n}\circ \varphi_{F_0}
\end{align*}
 The thesis now follows.	\qedhere 
\end{itemize}	
\end{proof}

\begin{definition}
	Let $(\X, \R)$ be a DPO-rewrityng system, with $\X$ an $\mathcal{M}$-adhesive category. The  category $\dpi$ is defined as follows:
	\begin{itemize}
		\item objects are isomorphism classes of objects of $\X$;
		\item an arrow $[G]\to [H]$ is an equivalence class $[\der{D}, \alpha, \omega]_a$ of a decorated derivation between $G'$ and $H'$ for some $G'$ and $H'$ such that $\pi(G')=G$ and $\pi(H')=H$;
		\item composition is concatenation of abstract decorated derivations;
		\item the identity on $[G]$ is $[G, \alpha, \alpha]_a$, where $\alpha$ is any isomorphism $\pi(G)\to G$.	\end{itemize}
\end{definition}


\subsection{Consistent permutations}

Given DPO-rewriting system $(\X, \R)$,  we have already noted in \Cref{rem:func} that a derivation $\der{D}$  determines a diagram $\Delta(\der{D})$ in $\X$. We can then wonder if such a diagram has a colimit. Clearly if $\der{D}$ is the empty derivation $G$ then a colimit for $\Delta(\der{D})$ is simply the object $G$. More generally, we have the following result.

\begin{lemma}\label{lem:colim}
	Let $\X$ be an $\mathcal{M}$-adhesive category and $(\X, \R)$ a left-linear DPO-rewriting system over it. The following properties hold true.
	\begin{enumerate}
		\item  If $\der{D}$ is a derivation from $G$ to $H$, then the diagram $\Delta(\der{D})$ has a colimit $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D})})$ such that $\iota_H$ belongs to $\mathcal{M}$.
		\item Let $\der{D}$ be the concatenation $\der{D}_1\cdot \der{D}_2$ of two derivations $\der{D}_1=\{\dder{D}_{1,i}\}_{i=0}^{n_1}$ between $G$ and $H$ and $\der{D}_2=\{\dder{D}_{2,j}\}_{j=0}^{n_2}$ between $H$ and $T$,  then the colimiting cocone $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D})})$ exists too and there is a pushout square
		\[\xymatrix{H\ar[r]^-{\iota_{2, H}} \ar@{>->}[d]_-{\iota_{1, H}} & \tproi{D}{2} \ar[d]^{p_2}\\  \tproi{D}{1} \ar[r]_{p_1}& \tpro{D}}\]
		where $(\tproi{D}{1}, \{\iota_{1, X}\}_{X\in \Delta(\der{D}_1)})$ and $(\tproi{D}{2}, \{\iota_{2, X}\}_{X\in \Delta(\der{D}_2)})$ are the colimiting cocone for $\Delta(\der{D}_1)$ and $\Delta(\der{D}_2)$, respectively.
	\end{enumerate}
\end{lemma}
\begin{remark}\label{rem:cof}
Let $I:\Deltamin(\dder{D})\to \Delta(\dder{D})$ be the inclusion functor. It is immediate to see that such functor is \emph{final} \cite{mac2013categories}. This means that for every functor $F\colon \Delta(\dder{D})\to \Y$ we have:
\begin{enumerate}
	\item if  $(C, \{c_X\}_{X\in \Deltamin(\dder{D})})$ is colimiting for $F\circ I$, then there exists a colimiting cocone $(D, \{d_X\}_{X\in \Delta(\dder{D})})$ for $F$;
	\item $(C, \{c_X\}_{X\in \Deltamin(\dder{D})})$ and $(D, \{d_X\}_{X\in \Delta(\dder{D})})$ are colimiting for, repsectively, $F\circ I$ and $F$, then the canonical arrow $\phi\colon C\to D$ induced by $(D, \{d_X\}_{X\in \Deltamin(\dder{D})})$ is an isomorphism.
\end{enumerate}
\end{remark}

\begin{proof}\begin{enumerate}
		\item Let us proceed by induction on the length of $\der{D}$.

	
	\smallskip \noindent $\lgh(\dder{D})=0$. then the $\tpro{\dder{D}}$ is simply $(G, \{\id{G}\})$ and $\id{G}\in \mathcal{M}$.¸
	
	\smallskip \noindent$\lgh(\dder{D})=1$. Suppose that $\dder{D}$ has as its single component the derivation
			\[\xymatrix{L \ar[d]_{m}& K \ar[d]^{k}\ar@{>->}[l]_{l} \ar[r]^{r} & R \ar[d]^{h} \\G& \ar@{>->}[l]^{f} D \ar[r]_{g}& H  \\}\]
			The arrow $f$ is  the pushout of $l$ and so it is in in $\mathcal{M}$. We can thus consider the $\mathcal{M}$-pushout square
			\[\xymatrix{D \ar@{>->}[d]_{f} \ar[r]^{g} & H \ar@{>->}[d]^{p} \\G \ar[r]_{q}& P }\]
			Since $p\in \mathcal{M}$, the thesis follows immediately from \Cref{rem:cof}. 
	
	\smallskip \noindent$\lgh(\dder{D})\geq 2$. Let $\der{D}$ be $\{\dder{D}_i\}_{i=0}^n$ with $n\geq 1$. Let also $\der{D}'$ be $\{\dder{D}_i\}^{n-1}_{i=0}$ and $\rho_n=(l_n, r_n)$ be the rule applied in $\dder{D}_n$. The pushout of $l_n$ is the arrow $f_n\colon D_n\to G_n$ is in $\mathcal{M}$ and, by inductive hypothesis, $\iota_{G_{n}}\colon G_{n}\to \lpro \der{D}'\rpro$ is in $\mathcal{M}$ too. Thus, we can consider the diagram below, having a pushout as its lower half.
			\[\xymatrix{L_n \ar[d]_{m_{n}}& K_{n} \ar[d]^{k_{n}}\ar@{>->}[l]_{l_{n}} \ar[r]^{r_{n}} & R_{n} \ar[d]^{h_n} \\G_{n} \ar@{>->}[d]_{\iota'_{G_{n}}}& \ar@{>->}[l]^{f_n} D_n \ar[r]_{g_n}& H  \ar@{>->}[d]^{q}\\ \lpro \der{D}' \ar[rr]_{p}\rpro && P}\] 
			Notice that, as in the point above, the arrow $q\colon H\to P$ is the pushout of an element in $\mathcal{M}$, therefore it is enough to show that the diagram so constructed provides a colimiting cocone for $\Delta(\der{D})$.
			
			Let $(C, \{c_X\}_{X\in \Delta(\der{D})})$ be a cocone, since $\Delta(\der{D}')$ is a subdiagram of $\Delta(\der{D})$, we get another cocone $(c, \{c_X\}_{X\in \Delta(\der{D}')})$ which induces an arrow $c'\colon \lpro \der{D}' \rpro \to C$ such that
			\begin{align*}
				c'\circ \iota_{G_n} \circ f_n &=c_{G_n} \circ f_n\\&= c_{D_n}\\&= c_{H}\circ g_n
			\end{align*}
			Therefore the arrows $c'$ and $c_H$ induce a morphism $c\colon P\to C$ and the thesis now follows at once.
		
		\item  As a first step, notice that $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D}_1)})$ and $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D}_2)})$ are cocone on, respectively, $\Delta(\der{D}_1)$ and $\Delta(\der{D}_2)$. Hence, there exist two arrows $p_1\colon \tproi{D}{1}\to \tpro{D}$, $p_2\colon \tproi{D}{2}\to \tpro{D}$ such that, for every $X\in  \Delta(\der{D}_1)$ and $Y\in  \Delta(\der{D}_2)$
		\[p_1\circ \iota_{1, X} = \iota_X \qquad p_2\circ \iota_{2, Y}=\iota_{2,Y}\]
		In particular, this entails the commutativity of the square
				\[\xymatrix{H \ar[dr]^{\iota_H} \ar[r]^-{\iota_{2, H}} \ar@{>->}[d]_-{\iota_{1, H}} & \tproi{D}{2} \ar[d]^{p_2}\\  \tproi{D}{1} \ar[r]_{p_1}& \tpro{D}}\]
		
	Let us now show that the square above is a pushout. Take two arrows $a\colon \tproi{D}{1}\to C$, $b\colon \tproi{D}{2}\to C$ such that
	\[a\circ \iota_{1, H}=b\circ \iota_{2, H}\]
	We can use the previous equality to define a cocone $(C, \{c_X\}_{X\in \Delta(\der{D})})$ putting:
	\[c_X:=\begin{cases}
		a\circ \iota_{1, X} & X\in \Delta(\der{D}_1)\\
		b\circ \iota_{2, X} & X\in \Delta(\der{D}_2)
	\end{cases}\]
From this, we can deduce at once the existence of a unique $c\colon \tpro{D}\to C$ such that 
\[c\circ \iota_X = c_X\]
By construction, for every $X\in  \Delta(\der{D}_1)$ and $Y\in  \Delta(\der{D}_2)$ we have
\[\begin{split}
	c\circ p_1 \circ \iota_{1,X}&=c\circ \iota_{X}\\&=c_X \\&=a\circ \iota_{1,X}\\&=a\circ p_1\circ \iota_{1,X}
\end{split}\qquad \begin{split}
	c\circ p_2 \circ \iota_{2,Y}&=c\circ \iota_{Y}\\&=c_Y \\&=b\circ \iota_{2,Y}\\&=b\circ p_2\circ \iota_{2,Y}
\end{split}\]
Therefore
\[c\circ p_1=a \qquad c\circ p_2 = b\]

	For uniqueness, suppose that $c'\colon \tpro{D}\to C$ is such that
	\[c'\circ p_1=a \qquad c'\circ p_2 = b\]
Then, for every $X\in \Delta(\der{D})$ we have
\begin{align*}
	c'\circ \iota_X &= \begin{cases}
	c'\circ p_1\circ \iota_{1, X} & X\in \Delta(\der{D}_1)\\
	c'\circ p_2\circ \iota_{2, X} & X\in \Delta(\der{D}_2)
	\end{cases}\\&=\begin{cases}
a\circ \iota_{1, X} & X\in \Delta(\der{D}_1)\\
b\circ \iota_{2, X} & X\in \Delta(\der{D}_2)
	\end{cases}\\&=c_X\\&=c\circ \iota_X
\end{align*}
showing that $c'=c$ as wanted.	 \qedhere 
	\end{enumerate}
\end{proof}

\begin{corollary}\label{cor:colim}
Let $\der{D}=\{\dder{D}_i\}_{i=0}^n$ a derivation of length $n+1$ and fix an index $j\in[0,n]$. Define
\[\der{D}^j_1:=\{\dder{D}_i\}_{i=0}^{j-1} \qquad  \der{D}^j_2=\{\dder{D}_j\} \qquad \der{D}^j_3:=\{\dder{D}_i\}_{i=j+1}^n\]
with the convention that $\der{D}^0_1$ and $\der{D}^n_3$ are the empty derivation on, respectively, $G_0$ and $G_n$. Then the square below is a pushout and a pullback
\[\xymatrix@C=30pt{D_{j} \ar[ddrr]^{\iota_{D_j}} \ar[r]^{g_j}\ar@{>->}[d]_{f_j}& G_{j+1} \ar[ddr]^{\iota_{G_{j+1}}} \ar[r]^-{\iota_{3, G_{j+1}}} & \lpro \der{D}^j_3\rpro \ar[dd]^{p_2} \\ G_j\ar[drr]_{\iota_{G_{j}}} \ar@{>->}[d]_{\iota_{1,G_j}}\\ \lpro \der{D}^j_1 \rpro \ar[rr]_{p_1}  &&\tpro{D} }\] 
Where the two arrows $p_1\colon \lpro\der{D}^j_1 \rpro\to \tpro{D}$, $p_2\colon \lpro \der{D}^j_3\rpro \to \tpro{D}$ are induced by the cocones $(\tpro{D}, \{\iota_{X}\}_{X\in \Delta(\der{D}^j_1)})$ and $(\tpro{D}, \{\iota_{X}\}_{X\in \Delta(\der{D}^j_3)})$, respectively.
\end{corollary}
\begin{remark}
If $\der{D}$ is empty then $\der{D}^j_1, \der{D}^j_2$ and $\der{D}^j_3$ are empty too.
\end{remark}
\begin{proof}
We can notice that $\der{D}=\der{D}^j_1\cdot \der{D}^j_2 \cdot \der{D}^j_3$. By the first and the second point of \Cref{lem:colim} then we get the following diagram, in which all squares are $\mathcal{M}$-pushouts.

\[\xymatrix@C=30pt{D_{j}  \ar[r]^{g_j}\ar@{>->}[d]_{f_j}& G_{j+1}  \ar[r]^-{\iota_{3,G_{j+1}}} \ar[d]_{\iota_{2, G_{j+1}}}  \ar@/^.5cm/[dd]^{\iota_{1,2, G_{j+1}}}& \lpro \der{D}^j_3\rpro \ar[dd]^{p_2} \\ G_j \ar[r]^{\iota_{2, G_j}}\ar@{>->}[d]_{\iota_{1,G_j}} & \lpro \der{D}^j_2\rpro \ar[d]_a\\ \lpro \der{D}^j_1 \rpro \ar@/_.4cm/[rr]_{p_1} \ar[r]^b &\lpro \der{D}^j_1\cdot \der{D}^j_2 \rpro \ar[r]^c&\tpro{D} }\] 
Applying \Cref{lem:po1} twice we get that the whole square is an $\mathcal{M}$-pushout. Then the thesis follows from \Cref{prop:pbpoad}.
\end{proof}

\begin{remark}\label{rem:zero1} In particular, considering $j=0$ or $j=n$, we get that the following two squares are $\mathcal{M}$-pushouts and, thus, pullbacks.
	\[\xymatrix{D_0 \ar[r]^-{\iota_{3, D_0}} \ar@{>->}[d]_{f_0}& \lpro \der{D}^0_3 \rpro \ar@{>->}[d]^{p_2} &D_n \ar@{>->}[d]_{\iota_{1, D_n}}\ar[r]^{g_n}& G_n \ar@{>->}[d]^{\iota_{G_n}}\\ G \ar[r]_{\iota_G}& \tpro{D} & \lpro \der{D}^n_1 \rpro \ar[r]_{p_1}  & \tpro{D}}\]
\end{remark}

\begin{corollary}\label{cor:ele}
	Let $\der{D}=\{\dder{D}_{i}\}_{i=0}^n$ be a derivation between $G$ and $H$. Let $j$ and $k$ be two indexes less or equal than $n+1$ and suppose that $j< k$.  Consider two arrows $a\colon T\to G_j$, $b\colon T\to G_k$. If $\iota_{G_j}\circ a = \iota_{G_k}\circ b$, 
	then  there exist a unique arrow $c\colon T\to D_j $  such that \[f_j\circ c = a\qquad \iota_{D_j}\circ c =\iota_{G_k}\circ b\]
	\end{corollary}
\begin{proof} Consider the diagram
			\[\xymatrix@C=34pt{T  \ar@/_.6cm/[dd]_{a}\ar@{.>}[d]^{c}\ar[rr]^{b}&& G_k \ar[d]_{\iota_{3, G_k}} \ar@/^.6cm/[ddd]^{\iota_{G_k}}\\D_{j} \ar[r]^{g_j} \ar[ddrr]^{\iota_{D_j}}\ar@{>->}[d]^{f_j}& G_{j+1} \ar[r]^-{\iota_{3,G_{j+1}}} \ar[ddr]^{\iota_{G_{j+1}}} & \lpro \der{D}^j_3\rpro \ar[dd]_(.6){p_2} \\ G_j \ar@{>->}[d]_{\iota_{1,G_j}} \ar[drr]_{\iota_{G_j}}\\ \lpro \der{D}^j_1 \rpro \ar[rr]_{p_1}  &&\tpro{D} }\] 
			Thanks to \Cref{cor:colim} we know that the bottom right rectangle in the diagram above is a pullback and the thesis follows at once.
\end{proof}	
	
	
So equipped, we can introduce the notion of \emph{consistent permutation}.

\begin{definition}[Consistent permutation]\label{def:permcon}
	Let $\X$ be an $\mathcal{M}$-adhesive category and consider a left-linear DPO-rewriting system $(\X, \R)$ on it.  Take two non-empty decorated derivations $(\der{D}, \alpha, \omega)$ and  $(\der{D}', \alpha', \omega')$ with the same length and with isomorphic sources and targets.
	 	 
	 	If $\der{D}=\{\dder{D}_i\}_{i=0}^n$ and $\der{D}'=\{\dder{D}'_i\}_{i=0}^n$ with assciated sequence of rules $r(\der{D})=\{\rho_i\}_{i=0}^n$ and $r(\der{D}')=\{\rho'_i\}_{i=0}^n$, a \emph{consistent permutation} between  $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ is a permutation $\sigma\colon [0,n]\to [0,n]$  such that, for every $i\in [0,n]$, $\rho_i=\rho'_{\sigma(i)}$ and, moreover, there exists a \emph{mediating isomorphism} $\xi_\sigma\colon \tpro{D} \to \lpro \der{D}' \rpro$ fitting in the following diagrams, where $m_i, m'_i, h_i$ and $h'_i$ are, respectively, the matches and back-matches of $\dder{D}_i$ and $\dder{D}'_i$.
	\[\xymatrix@C=30pt{\pi(G_0)\ar[r]^{\alpha} \ar[d]_{\alpha'} & G_0 \ar[r]^{\iota_{G_0}} &\tpro{D} \ar[d]^{\xi_\sigma}&   \pi(G_{n+1}) \ar[r]^{\omega} \ar[d]_{\omega'} & G_{n+1} \ar@{>->}[r]^{\iota_{G_{n+1}}} &\tpro{D} \ar[d]^{\xi_\sigma}\\ G'_0 \ar[rr]_{\iota'_{G'_0}} & &\lpro \der{D}' \rpro& G'_{n+1} \ar@{>->}[rr]_{\iota'_{G'_{n+1}}} & &\lpro \der{D}' \rpro\\L_i \ar[r]^{m_i} \ar[d]_{m'_{\sigma(i)}}& G_i \ar[r]^{\iota_{G_i}} &\tpro{D} \ar[d]^{\xi_\sigma} & R_i \ar[r]^{h_i} \ar[d]_{h'_{\sigma(i)}}& G_{i+1} \ar[r]^{\iota_{G_{i+1}}} &\tpro{D} \ar[d]^{\xi_\sigma} \\G'_{\sigma(i)} \ar[rr]_{\iota'_{G'_{\sigma(i)}}}&& \lpro \der{D}' \rpro& G'_{\sigma(i)+1} \ar[rr]_{\iota'_{G'_{\sigma(i)+1}}}&& \lpro \der{D}' \rpro}\]
\end{definition}

\begin{remark}
The commutativity of the last two rectangles in \Cref{def:permcon}, is equivalent to the commutativity of the following bigger diagram.		
\[\xymatrix@C=40pt{G_i\ar@/^1cm/[rrr]^{\iota_{G_{i}}}&D_i\ar@/^.4cm/[rr]^(.35){\iota_{D_i}} \ar[r]_{g_i} \ar@{>->}[l]^{f_i}&G_{i+1} \ar[r]_{\iota_{G_{i+1}}}&\tpro{D} \ar[dd]^{\xi_\sigma}\\  L_i \ar[u]^{n_i} \ar[d]_{n'_{\sigma(i)}}& K_i \ar[d]^{k'_{\sigma(i)}} \ar[u]_{k_i} \ar[r]^{r_i} \ar@{>->}[l]_{l_i} &R\ar[u]^{h_i} \ar[d]_{h'_{\sigma(i)}}\\G'_{\sigma(i)}\ar@/_1cm/[rrr]_{\iota'_{G'_{\sigma(i)}}} &D'_{\sigma(i)}\ar@{>->}[l]_{f'_{\sigma(i)}} \ar[r]^{g'_i} \ar@/_.4cm/[rr]_(.35){\iota'_{D'_{\sigma(i)}}}&G'_{\sigma(i)+1} \ar[r]^{\iota'_{G'_{\sigma{i}+1}}}& \lpro\der{D}' \rpro }\]
This follows at once from the following chain of identities::
\begin{align*}
	\xi_\sigma \circ \iota_{D_i}\circ k_i&=\xi_\sigma \circ \iota_{G_{i}} \circ f_i\\&= \xi_\sigma \circ \iota_{G_{i}}\circ m_i \circ l_i\\&=\iota_{G'_{\sigma(i)}}\circ m'_i\circ l_i\\&=\iota_{G'_{\sigma(i)}}\circ f'_{\sigma(i)}\circ k'_i\\&=\iota_{D'_\sigma(i)}\circ k_i'
\end{align*}
\end{remark}

\begin{remark}\label{rem:coproj}
Notice that, in particular, the previous diagram entails
		\[\xi_\sigma \circ \iota_{L_i}=\iota'_{L_{\sigma(i)}} \quad \xi_\sigma \circ \iota_{K_i}=\iota'_{K_{\sigma(i)}} \quad \xi_\sigma \circ \iota_{R_i}=\iota'_{R_{\sigma(i)}} \]
\end{remark}

\begin{remark}\label{rem:inversa}
Let $\sigma\colon [0,n]\to [0,n]$ be a consistent permutation between $(\der{D},\alpha, \omega)$ and $(\der{D}', \alpha', \omega')$, then its inverse $\sigma^{-1}$ is a consistent permutation between $(\der{D}', \alpha', \omega')$ and $(\der{D},\alpha, \omega)$. Indeed, it is enough to consider, as mediating isomorphism, the inverse $\xi^{-1}_\sigma$ of $\xi_\sigma$.
\end{remark}

\begin{remark}\label{rem:comp} Consistent permutations can be composed. Indeed, given decorated derivations $(\der{D}, \alpha, \omega)$, $(\der{D}', \alpha', \omega')$ and $(\der{\hat{D}}, \hat{\alpha}, \hat{\omega})$ all of length $n$, if $\sigma$ is a consistent permutation between the first two and $\tau$ one between the second and the third, then  we have diagrams
	\[\xymatrix@C=18pt{ & G_0 \ar[rr]^{\iota_{G_0}} &&\tpro{D} \ar[d]^{\xi_\sigma}&  &  G_{n} \ar@{>->}[rr]^{\iota_{ G_{n}}} &&\tpro{D} \ar[d]^{\xi_\sigma} \\ \pi(G_0) \ar@/_.2cm/[dr]_{\hat{\alpha}}\ar@/^.2cm/[ur]^{\alpha} \ar[r]^{\alpha'} &G'_0 \ar[rr]^{\iota'_{G'_0}}  &&\lpro \der{D}'  \rpro \ar[d]^{\xi_{\tau}}&\pi({ G_{n}})\ar@/_.2cm/[dr]_{\hat{\omega}}\ar@/^.2cm/[ur]^{\omega} \ar[r]^{\omega'} & { G'_{n}} \ar@{>->}[rr]^{\iota'_{{ G'_{n}}}} && \lpro \der{D}' \rpro \ar[d]^{\xi_{\tau}}\\ &\hat{G}_0  \ar[rr]_{\hat{\iota}_{\hat{G}_0}}&& \lpro \hat{\der{D}}\rpro  && \hat{G}_n \ar@{>->}[rr]_{\hat{\iota}_{\hat{G}_n}}&& \lpro \hat{\der{D}} \rpro \\& G_i \ar[rr]^{\iota_{G_i}} &&\tpro{D} \ar[d]^{\xi_\sigma}&  &  G_i \ar[rr]^{\iota_{G_i}} &&\tpro{D} \ar[d]^{\xi_\sigma} \\ L_i \ar@/_.2cm/[dr]_{\hat{m}_{\tau(\sigma(i))}}\ar@/^.2cm/[ur]^{m_i} \ar[r]^{m'_{\sigma(i)}} &G'_{\sigma(i)} \ar[rr]^{\iota'_{G'_{\sigma(i)}}}  &&\lpro \der{D}'  \rpro \ar[d]^{\xi_{\tau}}&R_i \ar@/_.2cm/[dr]_{\hat{h}_{\tau(\sigma(i))}}\ar@/^.2cm/[ur]^{h_i} \ar[r]^{h'_{\sigma(i)}} & G'_{\sigma(i)} \ar[rr]^{\iota'_{G'_{\sigma(i)}}} && \lpro \der{D}' \rpro \ar[d]^{\xi_{\tau}}\\ &\hat{G}_{\tau(\sigma(i))}  \ar[rr]_-{\hat{\iota}_{\hat{G}_{\tau(\sigma(i))}}}&& \lpro \hat{\der{D}}\rpro  && \hat{G}_{\tau(\sigma(i))} \ar[rr]_-{\hat{\iota}_{\hat{G}_{\tau(\sigma(i))}}}&& \lpro \hat{\der{D}} \rpro	}\]
	We deduce at once that $\tau\circ \sigma$ is a consistent permutation with mediating isomorphism given by $\xi_{\tau} \circ \xi_\sigma$.
\end{remark}

\begin{remark} \label{ex:abscons}Let $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ be two abstraction equivalent non-empty decorated derivations of length $n+1$. Then the identity permutation $\id{[0,n]}\colon [0,n]\to [0,n]$ is a consistent permutation between them. In such a case we can take as $\xi_{\id{[0,n]}}\colon \tpro{D}\to \lpro \der{D}'\rpro$ simply the isomorphism induced by any abstraction equivalence $\{\phi_X\}_{X\in \Delta(X)}$.
	
Given a decorated derivation $(\der{D}, \alpha, \omega)$ with source $G$ and target $H$ and two isomorphisms, $\phi\colon G'\to G$ $\psi\colon H\to H'$ be two isomorphisms, we know, by \Cref{rem:absequi}, that \[(\der{D}, \alpha, \omega)\equiv_a (\phi*\der{D}, \phi^{-1}\circ \alpha, \omega ) \qquad (\der{D}, \alpha, \omega)\equiv_a (\der{D}*\psi, \alpha, \psi \circ \omega )\]
In these cases, if $(\tpro{D}, \{\iota_X\}_{X\in \Delta(\der{D})})$, $(\lpro \phi *\der{D} \rpro, \{\iota'_X\}_{X\in \Delta(\der{D})})$ and $(\lpro \der{D}*\psi \rpro, \{\iota'_X\}_{X\in \Delta(\der{D})})$ are colimiting cocones, we can take as mediating isomorphisms, respectively, the unique arrows $\Gamma^{\phi} \colon \tpro{D}\to \lpro \phi*\der{D} \rpro$ and $\Gamma_\psi\colon \tpro{D}\to \lpro \der{D}*\psi \rpro$  such that, for every $X\in \Deltamin(\der{D})$:
\[\Gamma^\phi \circ \iota_X:=\begin{cases}
\iota'_{G'}\circ \phi^{-1}  & X=G'\\
\iota'_X & \text{otherwise}
\end{cases} \qquad \Gamma_\psi \circ \iota_X:=\begin{cases}
\hat{\iota}_{H'}\circ \psi  & X=H'\\
\hat{\iota}_X & \text{otherwise}
\end{cases}\]
\end{remark}

\begin{remark}\label{ex:empty}
	If $\der{D}$ and $\der{D}'$ are empty, then the converse also holds. If $\id{\emptyset}$ is a consistent permutation, then a mediating isomorphism provides an abstraction equivalence.
\end{remark}

\begin{example}\todo{identità consistente non implica astrazione}Notice that the \Cref{ex:empty} cannot, in general, be generalized to non-empty derivations. A counterexample si the following one.
\end{example}

\begin{proposition}\label{prop:uniqu}
	Let $\sigma,\tau\colon [0,n]\rightrightarrows [0,n]$ be two consistent permutations between $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$.  Then the following hold true:
	\begin{enumerate}
	\item $\xi_\sigma \circ \iota_{G_0} = \xi_{\tau} \circ \iota_{G_0}$;
	\item  $\xi_\sigma \circ \iota_{G_i}=\xi_{\tau} \circ \iota_{G_i}$ for every index $i\in [0,n]$ such that $\sigma_{|[0,i]}=\tau_{|[0,i]}$.
	\end{enumerate}
\end{proposition}
\begin{proof}\begin{enumerate}
		\item This follows at once noticing that both $\xi_\sigma \circ \iota_{G_0}$ and $\xi_{\tau} \circ \iota_{G_0}$ are equal to $\iota'_{G'_0}\circ \alpha'\circ \alpha^{-1}$.
		\item  If $\sigma(0)\neq \tau(0)$ there is nothing to show. Otherwise, let $j$ be the maximum of the set
		\[\{i\in [0,n]\mid \sigma_{|[0,i]}=\tau_{|[0,i]}\}\]
		We proceed by induction on $i\in [0,j]$. 
		\begin{itemize}
			\item If $i=0$ the thesis follows from point $1$.
			\item If $i>0$, we know that there is a pushout square
			\[\xymatrix{K_{i-1}\ar[r]^{r_{i-1}} \ar[d]_{k_{i-1}}& R_{i-1} \ar[d]^{h_{i-1}}\\ D_{i-1} \ar[r]_{g_{i-1}}& G_i}\] 
			By \Cref{rem:coproj} we know that
			\begin{align*}
				\xi_\sigma \circ \iota_{G_i}\circ h_{i-1}&=  \xi_\sigma\circ \iota_{R_{i-1}}\\&=\iota'_{R_{\sigma(i-1)}}\\&=\iota'_{R_{\tau(i-1)}}\\&=\xi_{\tau}\circ \iota_{R_{i-1}}\\&=\xi_{\tau} \circ \iota_{G_i}\circ h_{i-1}
			\end{align*}
			But, by the induction hypothesis we also have
			\begin{align*}
				\xi_\sigma \circ \iota_{G_i}\circ g_{i-1}&=\xi_{\sigma}\circ \iota_{D_{i-1}}\\&=\xi_{\sigma}\circ \iota_{G_{i-1}} \circ f_{i-1}\\&=\xi_{\tau}\circ \iota_{G_{i-1}} \circ f_{i-1}\\&=\xi_{\tau}\circ \iota_{D_{i-1}} \\&=\xi_{\tau}\circ \iota_{G_{i}} \circ g_{i-1}
			\end{align*}
			The thesis now follows.			\qedhere
		\end{itemize}
	\end{enumerate}
\end{proof}

Now, notice that, given a consistent permutation $\sigma\colon [0,n]\to[0,n]$, we already know, by \Cref{rem:coproj} that
\[\xi_\sigma \circ \iota_{L_i}=\iota'_{L_{\sigma(i)}} \quad \xi_\sigma \circ \iota_{K_i}=\iota'_{K_{\sigma(i)}} \quad \xi_\sigma \circ \iota_{R_i}=\iota'_{R_{\sigma(i)}} \]
	Moreover, $\xi_\sigma \circ \iota_{D_i}$ must be $\xi_\sigma \circ \iota_{G_i}\circ f_i$. Thus $\xi_\sigma$ is uniquely determined by $\xi_{\sigma} \circ \iota_{G_i}$ for every $i\in [0, n]$. In particular,  \Cref{prop:uniqu} entails the following.
\begin{corollary} For every consistent permutation $\sigma$ between  $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$, the mediating isomorphism $\xi_\sigma\colon \tpro{D}\to \lpro \der{D}'\rpro$ is unique.
\end{corollary}

We are now ready to prove the central result of this section. 

\begin{lemma} Let $(\X,R)$ be a left-linear DPO-rewriting system. Consider two consistent permutation $\sigma,\tau\colon [0,n]\rightrightarrows [0,n]$ between $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$. Suppose that $\sigma\neq \tau$ and let $j$ be the minimum index such that $\sigma(j)\neq \tau(j)$. Let also $r(\der{D})$ be $\{\rho_i\}_{i=0}^n$. Then the following hold true:
	\begin{enumerate}
		\item if $j=0$, then the rule $\rho_0$ is not consuming;
		\item if $j\neq 0$ then the rule $\rho_{j-1}$ is not consuming.
	\end{enumerate}
\end{lemma}
\begin{proof}\begin{enumerate}
		\item Let $k$ be $\sigma^{-1}(\tau(0))$ and notice that, since $\sigma(0)\neq \tau(0)$, then $0< k$.  By  the first point of  \Cref{prop:uniqu} we can consider the diagram
		\[\xymatrix@C=40pt{& L_0 \ar[d]_{m'_{\tau(0)}} \ar@/^.2cm/[dr]^{m_{k}} \ar@/_.2cm/[dl]_{m_{0}} \\G_{0} \ar@/_.2cm/[drr]_(.3){\iota_{G_0}}|(.515)\hole \ar[d]_{\iota_{G_0}}& G'_{\tau(0)} \ar[d]^{\iota_{G'_{\tau(0)}}} & G_{k} \ar[d]^{\iota_{G_k}}\\ \tpro{D} \ar[r]_{\xi_{\tau}} & \lpro \der{D'}\rpro & \tpro{D} \ar[l]^{\xi_{\sigma}}}\]
	From \Cref{cor:ele}, we can conclude that there exists $c\colon L_0\to D_0$ such that $f_0\circ c=m_0$. We thus have the solid part of the commutative diagram below.
		\[\xymatrix{L_0 \ar@/^.3cm/[drr]^{\id{L_0}} \ar@{.>}[dr]_{t} \ar@/_.3cm/[ddr]_{c}\\ & K_0 \ar[d]_{k_0}\ar@{>->}[r]^{l_0}& L_0 \ar[d]^{m_0} \\& D_0 \ar@{>->}[r]_{f_0} & G_0} \]
		The internal square is an $\mathcal{M}$-pushout and thus a pullback, by \Cref{prop:pbpoad}, so that we have the existence of the dotted $t\colon L_0\to K_0$. Therefore $\id{L_0}=l_0\circ t$, proving that $l_0$ is an epimorphism. The thesis now follows from \Cref{cor:rego}.  
		\item  Let $k$ be $\sigma^{-1}(\tau(j-1))$ and notice that $\rho_{j-1}=\rho_k$. By definition of $j$, $\sigma_{|[0,j-1]}=\tau_{|[0,j-1]}$, thus the second point of \Cref{prop:unique} yields the diagram
			\[\xymatrix@C=40pt{& L_{j-1} \ar[d]_{m'_{\tau(j-1)}} \ar@/^.2cm/[dr]^{m_{k}} \ar@/_.2cm/[dl]_{m_{j-1}} \\G_{j-1} \ar@/_.2cm/[drr]_(.3){\iota_{G_{j-1}}}|(.515)\hole \ar[d]_{\iota_{G_{j-1}}}& G'_{\tau(j-1)} \ar[d]^{\iota_{G'_{\tau(j-1)}}} & G_{k} \ar[d]^{\iota_{G_k}}\\ \tpro{D} \ar[r]_{\xi_{\tau}} & \lpro \der{D'}\rpro & \tpro{D} \ar[l]^{\xi_{\sigma}}}\]
			Let $a$ be $\min(j-1, k)$, by \Cref{cor:ele},  there exists $c\colon L_{j-1}\to D_a$ such that $f_a\circ c=m_a$. As before this yields the solid part of the following diagram
			\[\xymatrix{L_{j-1} \ar@/^.3cm/[drr]^{\id{L_{j-1}}} \ar@{.>}[dr]_{t} \ar@/_.3cm/[ddr]_{c}\\ & K_{j-1} \ar[d]_{k_a}\ar@{>->}[r]^{l_{j-1}}& L_{j-1} \ar[d]^{m_a} \\& D_a \ar@{>->}[r]_{f_a} & G_a} \]
			The existence of the dotted $t\colon L_{j-1}\to K_{j-1}$ follows from  \Cref{prop:pbpoad} and we can conclude. \qedhere
	\end{enumerate}
\end{proof}

\begin{corollary}[Uniqueness of consistent permutation]\label{cor:unique}
Let $(\X,R)$ ba left-linear DPO-rewriting system and suppose that every rule in $R$ is consuming. For every two non-empty decorated derivations $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$, there exists at most one consistent permutation between them.
\end{corollary}

We end this section proving two rather technical result about consistent permutations between composite decorated derivations.

\begin{proposition}\label{prop:sum} Let $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$ be two abstract decorated derivations such that
	\[(\der{D}, \alpha, \omega)=(\der{D}_1, \alpha_1, \omega_1)\cdot (\der{D}_2, \alpha_2, \omega_2) \qquad (\der{D}', \alpha', \omega')=(\der{D}'_1, \alpha'_1, \omega'_1)\cdot (\der{D}'_2, \alpha'_2, \omega'_2)\]
	Given a consistent permutation $\sigma\colon [0, \lgh(\der{D}_1)-1]\to [0, \lgh(\der{D}_1)-1]$ between  $(\der{D}_1, \alpha_1, \omega_1)$ and $(\der{D}'_1, \alpha'_1, \omega'_1)$ and another $\tau:[0, \lgh(\der{D}_2)-1]\to [0, \lgh(\der{D}_2)-1]$ between $(\der{D}_2, \alpha_2, \omega_2)$ and $(\der{D}'_2, \alpha'_2, \omega'_2)$, then 
	\[\sigma+\tau\colon[0, \lgh(\der{D})-1]\to[0, \lgh(\der{D})-1] \quad i \mapsto \begin{cases}
		\sigma(i) & i < \lgh(\der{D}_1)\\
		\lgh(\der{D}_1)+\tau(i-\lgh(\der{D}_1)) &   i\geq \lgh(\der{D}_1) 
	\end{cases}\]
	is a consistent permutation between $(\der{D}, \alpha, \omega)$ and $(\der{D}', \alpha', \omega')$.
\end{proposition}
\begin{proof}
	Let us start fixing some notation. Given $X_1\in \Delta(\der{D}_1)$, $X_2\in \Delta(\der{D}_2)$, $X'_1\in \Delta(\der{D}'_1)$, $X'_2\in \Delta(\der{D}'_2)$, we will denote their coprojections into, respectively, $\lpro \der{D}_1\rpro$, $\lpro \der{D}'_2\rpro$, $\lpro \der{D}'_1\rpro$, $\lpro \der{D}'_2\rpro$ by
	$\iota_{1, X_1}\colon X_1\to \lpro\der{D}_1\rpro$, $\iota_{1, X_2}\colon X_2\to \lpro\der{D}_1\rpro$, $\iota'_{1, X'_1}\colon X'_1\to \lpro\der{D}'_1\rpro$ and $\iota'_{2, X'_2}\colon X'_2\to \lpro\der{D}_1\rpro$. Similarly, given $X\in \Delta(\der{D})$ and $\X'\in \Delta(\der{D}')$ we will use $\iota_X:X\to \tpro{D}$ and $\iota'_{X'}:X'\to \lpro \der{D}' \rpro$ for the coprojections.
	
	Now that these preliminaries matters have been addressed, we will proceed with the rest of the proof.. We split the proof in three cases.
	
	\smallskip \noindent $\lgh(\der{D}_1)=0$. Thus $\lgh(\der{D}'_1)=0$ too  and we have
		\begin{align*}
			(\der{D}, \alpha, \omega)&=(\der{D}_2, \alpha_2\circ \omega_1^{-1}\circ \alpha_1, \omega_2) \\ (\der{D}', \alpha', \omega')&=(\der{D}'_2, \alpha'_2\circ (\omega'_1)^{-1}\circ \alpha'_1, \omega'_2)
		\end{align*}
		Moreover, in this case $\sigma$ must be $\id{\emptyset}$ and $\sigma+\tau$ must be equal to $\tau$. The thesis now follows from the commutativity of the following diagram.
		\[\xymatrix@C=35pt{& G_{1,0}\ar[dd]^{\xi_{\id{\emptyset}}} \ar[dr]^{\omega^{-1}_1}&&G_{2,0}\ar[r]^-{\iota_{2, G_{2,0}}} & \lpro \der{D}_2\rpro \ar[dd]^{\xi_{\tau}}\\\pi(G_{1,0})  \ar[ur]^{\alpha_1} \ar[dr]_{\alpha'_1}&& \pi(G_{2,0}) \ar[ur]^{\alpha_2} \ar[dr]_{\alpha'_2}\\& G'_{1,0} \ar[ur]_{(\omega'_1)^{-1}}&&G'_{2,0} \ar[r]_-{\iota'_{2, G_{2,0}}}& \lpro \der{D}'_2\rpro}\]
		
	\smallskip \noindent$\lgh(\der{D}_2)=0$.  As before this implies that also $\lgh(\der{D}'_2)$ is $0$.  Applying \Cref{def:conc} we get 
		\begin{align*}
			(\der{D}, \alpha, \omega)&=(\der{D}_1, \alpha_1, \omega_1 \circ (\alpha_2)^{-1}\circ \omega_2) \\ (\der{D}', \alpha', \omega')&=(\der{D}'_1, \alpha'_1, \omega'_1 \circ (\alpha'_2)^{-1}\circ \omega'_2)
		\end{align*}
		Since $\der{D}_2$ is empty, then $\tau=\id{\emptyset}$ and $\sigma+\tau=\sigma$. Let $n$ be $\lg(\der{D}_1)$, as before the thesis follows from the diagram below.
		\[\xymatrix@C=35pt{& G_{2,0}\ar[dd]^{\xi_{\id{\emptyset}}} \ar[dr]^{\alpha^{-1}_2}&&G_{1,n}\ar@{>->}[r]^-{\iota_{1, G_{1,n}}} & \lpro \der{D}_2\rpro \ar[dd]^{\xi_{\sigma_1}}\\\pi(G_{2,0})  \ar[ur]^{\omega_2} \ar[dr]_{\omega'_2}&& \pi(G_{1,n}) \ar[ur]^{\omega_1} \ar[dr]_{\omega'_1}\\& G'_{2,0} \ar[ur]_{(\alpha'_1)^{-1}}&&G'_{1,n} \ar@{>->}[r]_-{\iota'_{1, G_{1,n}}}& \lpro \der{D}'_2\rpro}\]
	
	\smallskip \noindent $\lgh(\der{D}_1)\neq0$ and $\lgh(\der{D}_2)\neq 0$. Thus $\der{D}'_1$ and $\der{D}'_2$ are non-empty too. In this case we have:
		\begin{align*}
			(\der{D}, \alpha, \omega)&=(\der{D}_1*\omega_1^{-1}\cdot \alpha_2*\der{D}_2, \alpha_1, \omega_2)\\
			(\der{D}', \alpha', \omega')&=(\der{D}'_1*(\omega'_1)^{-1}\cdot \alpha'_2*\der{D}'_2, \alpha'_1, \omega'_2)
		\end{align*}
		
		
		Let us assume that $\der{D}_1$, $\der{D}'_1$, $\der{D}_2$ and $\der{D}'_2$ are given by
		\[\der{D}_1=\{\dder{D}_{1,i}\}_{i=0}^n \quad \der{D}'_1=\{\dder{D}'_{1,i}\}_{i=0}^n \quad \der{D}_2=\{\dder{D}_{2,i}\}_{i=0}^t \quad \der{D}_2'=\{\dder{D}'_{2,i}\}_{i=0}^t\]
		By definition of consistent permutation, the rule applied by $\dder{D}_{1,i}$ and the one applied in $\dder{D}_{2,i}$  must coincide with, respectively, the one applied in $\dder{D}'_{1,i}$ and the one applied $\dder{D}'_{2,1}$. Let $\dder{D}_{1,i}$, $\dder{D}'_{1,i}$, $\dder{D}_{2,i}$ and $\dder{D}'_{2,i}$ be given, by the following four diagrams. 
		\[\xymatrix{L_{1,i} \ar[d]_{m_{1, i}}& K_{1,i} \ar[d]_{k_{1, i}} \ar[r]^{r_{1,i}} \ar@{>->}[l]_{l_{1,i}} & R_{1,i}\ar[d]^{h_{1, i}} &L_{1,i} \ar[d]_{m'_{1, i}}& K_{1,i} \ar[d]_{k'_{1, i}} \ar[r]^{r_{1,i}} \ar@{>->}[l]_{l_{1,i}} & R_{1,i}\ar[d]^{h'_{1, i}} \\G_{1,i} & D_{1,i} \ar[r]_{g_{1,i}} \ar@{>->}[l]^{f_{1,i}} & G_{1,i+1} & G'_{1,i} & D'_{1,i}\ar[r]_{g'_{1,i}} \ar@{>->}[l]^{f'_{1,i}}  & G'_{1,i+1}}\]		
		\[\xymatrix{L_{2,i} \ar[d]_{m_{2, i}}& K_{2,i} \ar[d]_{k_{2, i}} \ar[r]^{r_{2,i}} \ar@{>->}[l]_{l_{2,i}} & R_{2,i}\ar[d]^{h_{2, i}} &L_{2,i} \ar[d]_{m'_{2, i}}& K_{2,i} \ar[d]_{k'_{2, i}} \ar[r]^{r_{2,i}} \ar@{>->}[l]_{l_{2,i}} & R_{2,i}\ar[d]^{h'_{2, i}} \\G_{2,i} & D_{2,i} \ar[r]_{g_{2,i}} \ar@{>->}[l]^{f_{2,i}} & G_{2,i+1} & G'_{2,i} & D'_{2,i}\ar[r]_{g'_{2,i}} \ar@{>->}[l]^{f'_{2,i}}  & G'_{2,i+1}}\] 
		
		%Let $(\lpro \der{D}_1*(\omega_1)^{-1}\rpro, \{j_X\}_{X\in \Delta( \der{D}_1*(\omega_1)^{-1})})$, $(\lpro \der{D}'_1*(\omega'_1)^{-1}\rpro, \{j'_X\}_{X\in \Delta( \der{D}'_1*(\omega'_1)^{-1})})$, $(\lpro \der{D}_1*(\omega_1)^{-1}\rpro, \{j_X\}_{X\in \Delta( \der{D}_1*(\omega_1)^{-1})})$ and $(\lpro \der{D}'_1*(\omega'_1)^{-1}\rpro, \{j'_X\}_{X\in \Delta( \der{D}'_1*(\omega'_1)^{-1})})$ be colimiting cocones. 
		By the second point of \Cref{lem:colim} and by \Cref{ex:abscons} we get the following diagram, in which the two solid squares are pushouts:
		\[\xymatrix@C=45pt@R=30pt{\pi(G_{2,0}) \ar@/^.4cm/[rrr]^{\id{\pi(G_{2,0})}}\ar@{>->}[d]_{\iota_{1, G_{1,n+1}} \circ \omega_1}\ar[r]_{\iota_{2, G_{2,0}} \circ \alpha_2}& \lpro \der{D}_2 \rpro \ar@{>->}[d]^{p_2}\ar[r]_{\xi_\tau} & \lpro \der{D}'_2 \rpro \ar@{>->}[d]_{p'_2} &\pi(G'_{2,0}) \ar@{>->}[d]^{\iota'_{1, G'_{1,n+1}} \circ \omega'_1} \ar[l]^{\iota'_{2, G'_{2,0}} \circ \alpha'_2}\\ \lpro \der{D}_1 \rpro \ar@/_.4cm/[rrr]_{\xi_\sigma} \ar[r]^{p_1} & \tpro{D} \ar@{.>}[r]^{\xi_{\sigma+\tau}} & \lpro \der{D}'\rpro & \lpro \der{D}'_1\rpro  \ar[l]_{p'_1}}\]

Moreover, we can pont out that, for every index $i\in [0,n+t+2]$ we have

\[\iota_{G_i}=\begin{cases}p_1\circ \iota_{1, G_{1,i}} & i \leq n\\
	p_1\circ \iota_{1, G_{1, i}}\circ \omega_1& i=n+1\\
p_2\circ \iota_{2, G_{2,i-(n+1)}} & i > n+1 
\end{cases} \qquad \iota'_{G'_i}=\begin{cases}p'_1\circ \iota'_{1, G'_{1,i}} & i \leq n\\
p'_1\circ \iota'_{1, G'_{1, i}}\circ \omega'_1& i=n+1\\
p'_2\circ \iota'_{2, G'_{2,i-(n+1)}} & i > n+1 
\end{cases}\]

Now, on the one hand, the existence of the dotted arrow $\xi_{\sigma+\tau}\colon \tpro{D}\to \lpro \der{D}'\rpro$ in the diagram above follows from the following computation:
	\begin{align*}
		p'_1\circ \xi_\sigma \circ \iota_{1, G_{1,n+1}} \circ \omega_1&=p'_1\circ \iota'_{1,G'_{1, n+1}} \circ \omega'_1\\&= p'_2 \circ \iota'_{2, G'_{2,0}} \circ \alpha'_2\\&=p'_2\circ \xi_\tau \circ \iota_{2, G_{2,0}} \circ \alpha_2
	\end{align*} 
On the other hand, we can repeat the same computation for $\xi^{-1}_\sigma$ and $\xi^{-1}_\tau$ to get
\begin{align*}
	p_1\circ \xi^{-1}_\sigma \circ \iota'_{1, G'_{1,n+1}} \circ \omega'_1&=p_1\circ \iota_{1,G_{1, n+1}} \circ \omega_1\\&= p_2 \circ \iota_{2, G_{2,0}} \circ \alpha_2\\&=p_2\circ \xi^{-1}_\tau \circ \iota'_{2, G'_{2,0}} \circ \alpha'_2
\end{align*} 
Hence there exists a $\psi\colon \lpro \der{D}'\rpro \to \tpro{D}$ such that:
\[\psi \circ p'_1=p_1\circ \xi^{-1}_\sigma \qquad \psi \circ p'_2=p_2\circ \xi^{-1}_\tau\]
Furthermore, the computations below show that $\psi$ is the inverse of $\xi_\sigma$.
\[\begin{split}
	\psi \circ \xi_{\sigma+\tau}\circ  p_1&=\psi \circ p'_1\circ \xi_\sigma \\&=p_1\circ \xi^{-1}_{\sigma}\circ \xi_\sigma\\&=p_1\\\\
	\xi_{\sigma+\tau}\circ \psi \circ p'_1&=\xi_{\sigma+\tau}\circ p_1\circ \xi^{-1}_\sigma \\&=p'_1\circ \xi_{\sigma}\circ \xi^{-1}_\sigma\\&=p'_1
\end{split}\qquad \begin{split}
	\psi \circ \xi_{\sigma+\tau}\circ  p_2&=\psi \circ p'_2\circ \xi_\tau \\&=p_2\circ \xi^{-1}_{\tau}\circ \xi_\tau\\&=p_2\\ \\ 	\xi_{\sigma+\tau}\circ \psi \circ p'_2&=\xi_{\sigma+\tau}\circ p_2\circ \xi^{-1}_\tau \\&=p'_2\circ \xi_{\tau}\circ \xi^{-1}_\tau\\&=p'_2
\end{split}\]
To conclude we have to show that $\xi_{\sigma+\tau}$ fits in the diagrams of \Cref{def:permcon}. For the first two diagrams we have:
\begin{align*}
	\xi_{\sigma+\tau} \circ \iota_{G_{0}}\circ \alpha&=\xi_{\sigma+\tau} \circ p_1 \circ \iota_{1,G_{1,0}}\circ \alpha_1\\&=p_1'\circ \xi_\sigma \circ  \iota_{1,G_{1,0}} \alpha_1\\&=p'_1\circ \iota'_{1, G'_{1,0}}\circ \alpha'_1\\&=\iota'_{G'_0}\circ \alpha'
\end{align*} 
and
 \begin{align*}
\xi_{\sigma+\tau} \circ \iota_{G_{n+t+2}}\circ \omega&=\xi_{\sigma+\tau} \circ p_2 \circ \iota_{2,G_{2,t+1}}\circ \omega_2\\&=p'_2\circ \xi_\tau \circ  \iota_{2,G_{2,t+1}} \omega_2\\&=p'_2\circ \iota'_{2, G'_{2,t+1}}\circ \omega'_2\\&=\iota'_{G'_{n+t+2}}\circ \omega'
\end{align*}  

Let $i$ be an index in $[0, n+t+1]$, we proceed splitting the cases.
\begin{itemize}
	\item $i$ is in $[0,n]$. Then we have
	\begin{align*}
		\xi_{\sigma+\tau}\circ \iota_{G_i} \circ m_i &= \xi_{\sigma+\tau} \circ p_1\circ \iota_{1, G_{1,i}}\circ m_{1,i}\\&=p'_1 \circ \xi_\sigma \circ \iota_{1, G_{1,i}}\circ m_{1,i}\\&= p'_1\circ \iota'_{1, G'_{1,\sigma(i)}}\circ m'_{1,\sigma(i)}\\&=\iota'_{G'_{\sigma(i)}}\circ m'_{\sigma(i)}
	\end{align*}
	Now, suppose that $i\neq n$, then 
	\begin{align*}
		\xi_{\sigma+\tau}\circ \iota_{G_{i+1}} \circ h_i &= \xi_{\sigma+\tau} \circ p_1\circ \iota_{1, G_{1,{i+1}}}\circ h_{1,i}\\&=p'_1\circ \xi_\sigma \circ \iota_{1, G_{1,{i+1}}}\circ h_{1,i}\\&= p'_1\circ \iota'_{1, G'_{1,\sigma(i)+1}}\circ h'_{1,\sigma(i)}
	\end{align*}
	and we have two subcases. If $\sigma(i)\neq n$, then \[h'_{1, \sigma(i)}=h'_{\sigma(i)} \qquad p'_1\circ \iota'_{1, G'_{1,\sigma(i)+1}}=
	\iota'_{G'_{\sigma(i)+1}}\] 
	and we can conclude. Otherwise, we have
	\begin{align*}p'_1\circ \iota'_{1, G'_{1,n+1}}\circ h'_{1,n}&=p'_1 \circ \iota'_{1,G'_{1,n+1}} \circ \omega'_1\circ (\omega')^{-1}_1 \circ h'_{1,n}\\&=\iota'_{G'_{n+1}}\circ h'_n
	\end{align*}
yielding again the wanted equality
	\[\xi_{\sigma+\tau}\circ \iota_{G_{i+1}} \circ h_i=\iota'_{G'_{\sigma(i)+1}}\circ h'_{\sigma(i)}\]
	Finally, if $i=n$ we get
	\begin{align*}
		\xi_{\sigma+\tau}\circ \iota_{G_{n+1}} \circ h_n &= \xi_{\sigma+\tau} \circ \iota_{\pi(G_{1,n+1})} \circ \omega^{-1}_1\circ h_{1,n}\\&= \xi_{\sigma+\tau} \circ p_1\circ \iota_{1, G_{1,n+1}} \circ \omega_1 \circ \omega^{-1}_1 \circ h_{1,n}\\&=p'_1 \circ \xi_\sigma \circ \iota_{1, G_{1,n+1}} \circ h_{1,n}\\&=p'_1\circ \iota'_{1, G_{1,\sigma(n)+1}} \circ h'_{1,\sigma(n)}
	\end{align*}
	We have again two cases. If $\sigma(n)\neq n$ then we can conclude at once since 
	\[h'_{1, \sigma(n)}=h'_{\sigma(n)} \qquad p'_1\circ \iota'_{1, G'_{1,\sigma(n)+1}}=
	\iota'_{G'_{\sigma(n)+1}}\] 
	While, if $\sigma(n)=n$, then we can use the identities
		\[(\omega'_1)^{-1}\circ h'_{1, n}=h'_{n} \qquad p'_1\circ \iota'_{1, G'_{1, n+1}}=
	\iota'_{G'_{n+1}}\circ (\omega'_1)^{-1}\] 
	to get
		\begin{align*}
		\xi_{\sigma+\tau}\circ \iota_{G_{n+1}} \circ h_n &= p'_1\circ \iota'_{1, G_{1,n+1}} \circ h'_{1,n}\\&=\iota'_{G'_{n+1}}\circ (\omega'_1)^{-1}\circ h'_{1,n}\\&=\iota'_{G'_{n+1}} h'_{n}
	\end{align*}
	\item $i$ is in $[n+1, n+t+1]$- We proceed  similarly to the point above. First of all we have
	\begin{align*}
		\xi_{\sigma+\tau}\circ \iota_{G_{i+1}} \circ h_i &= \xi_{\sigma+\tau} \circ p_2\circ \iota_{1, G_{2,i-n}}\circ h_{2,i-(n+1)}\\&=p'_2 \circ \xi_\tau \circ \iota_{2, G_{2,i-n}}\circ h_{2,i-(n+1)}\\&= p'_2\circ \iota'_{2, G'_{2,\tau(i-n)}}\circ h'_{2,\tau(i-(n+1))}\\&=\iota'_{G'_{\tau(i-n)}}\circ h'_{n+1+\tau(i-(n+1))}
	\end{align*}
	Next, supposing that $i\neq n+1$:	
	\begin{align*}
		\xi_{\sigma+\tau}\circ \iota_{G_{i}} \circ m_i &= \xi_{\sigma+\tau} \circ p_2\circ \iota_{2, G_{2,i-(n+1)}}\circ m_{2,i-(n+1)}\\&=p'_2\circ \xi_\tau \circ \iota_{2, G_{2,{i-(n+1)}}}\circ m_{2,i-(n+1)}\\&= p'_2\circ \iota'_{2, G'_{2,\tau(i-(n+1))}}\circ m'_{2,\tau(i-(n+1))}
	\end{align*}
	and we have again two possibilities. If $\tau(i-(n+1))\neq 0$, then the thesis follows from the equalities \[m'_{2, \tau(i-(n+1))}=m'_{(\sigma+\tau)(i)} \qquad p'_2\circ \iota'_{2, G'_{2,\tau(i-(n+1))}}=
	\iota'_{G'_{(\sigma+\tau)(i)}}\] 
	Suppose, instead, that $\tau(i-(n+1))= 0$, then we have
	\begin{align*} p'_2\circ \iota'_{2, G'_{2,0}}\circ m'_{2,0}&=p'_2 \circ \iota'_{2,G'_{2,0}} \circ \alpha'_2 \circ \alpha'^{-1}_2 \circ m'_{2,0}\\&=p'_1\circ \iota'_{1, G'_{1, n+1}}\circ \omega'_1\circ \alpha'^{-1}_2 \circ m'_{2,0}\\&=\iota'_{G'_{n+1}}\circ m'_{n+1}
	\end{align*}
allowing us to conclude again.	

	We are left with the case $i=n+1$. Let us compute
	\begin{align*}
		\xi_{\sigma+\tau}\circ \iota_{G_{n+1}} \circ m_{n+1} &= \xi_{\sigma+\tau} \circ \iota_{\pi(G_{2,0})} \circ (\alpha'_2)^{-1}\circ m_{2,0}\\&=\xi_{\sigma+\tau} \circ p_1\circ \iota_{1, G_{1,n+1}} \circ \omega_1 \circ (\alpha'_2)^{-1}\circ m_{2,0}\\&=\xi_{\sigma+\tau} \circ p'_2 \circ \iota'_{2,G'_{2,0}} \circ \alpha'_2 \circ (\alpha'_2)^{-1}\circ m_{2,0} \\&=p'_2 \circ \xi_\tau \circ \iota_{2, G_{2,0}} \circ m_{2,0}\\&=p'_2\circ \iota'_{2, G_{2,\tau(0)}} \circ m'_{2,\tau(0)}
	\end{align*}
	We have again two cases. If $\tau(0)\neq 0$ then $(\sigma+\tau)(i)\neq n+1$ and we can conclude at once since 
	\[m'_{2, \tau(0)}=m'_{(\sigma+\tau)(n+1)} \qquad p'_2\circ \iota'_{2, G'_{2,\tau(0)}}=
	\iota'_{G'_{(\sigma+\tau)(0)}}\] 
If $\tau(0)=0$, so that  $(\sigma+\tau)(0)= n+1$ we appeal to the equalities
	\[(\alpha')^{-1}_2\circ m'_{2, 0}=m'_{n+1} \qquad p'_2\circ \iota'_{2, G'_{2, 0}}=
	\iota'_{G'_{n+1}}\circ (\alpha'_2)^{-1}\] 
	to get
	\begin{align*}
		\xi_{\sigma+\tau}\circ \iota_{G_{n+1}} \circ m_{n+1} &= p'_2\circ \iota'_{2, G_{2,\tau(0)}} \circ m'_{2,\tau(0)}\\&=	\iota'_{G'_{n+1}}\circ (\alpha'_2)^{-1}\circ m'_{2,0}\\&=\iota'_{G'_{n+1}}\circ  m'_{n+1}
	\end{align*}
\end{itemize}
6The thesis now follows at once.	
\end{proof}

\begin{corollary}\label{cor:presuffix} Let $(\X, \R)$ be a consuming left linear DPO-rewriting system.  Let also $(\der{D}_1, \alpha_1, \omega_1)$, $(\der{D}_2, \alpha_2, \omega_2)$ be two composable decorated derivations of length, respectively, $l_1$ and $l_2$. Suppose that $\sigma:[0, l_1+l_2-1]\to [0, l_1+l_2-1]$ is a consistent permutation between $(\der{D}_1, \alpha_1, \omega_1)\cdot (\der{D}_2, \alpha_2, \omega_2)$ and $(\der{D}'_1, \alpha'_1, \omega'_1)\cdot (\der{D}'_2, \alpha'_2, \omega'_2)$ for some other two composable decorated derivations $(\der{D}_1, \alpha_1, \omega_1)$ and $(\der{D}_2, \alpha_2, \omega_2)$.  If $\tau:[0,l_1-1]\to [0, l_1-1]$ is a consistent permutation between $(\der{D_1}, \alpha_1, \omega_1)$ and $(\der{D}'_1, \alpha'_1, \omega'_1)$, then:
	\begin{enumerate}
		\item the permutation
		\[\varrho:[0,l_2-1]\to [0, l_2-1] \qquad i \mapsto \sigma(i+l_1)-l_1\]
		is a consistent one;
		\item for every $i\in [0,l_1-1]$, $\sigma(i)=\tau(i)$.
	\end{enumerate}
\end{corollary}
\begin{proof}\begin{enumerate}
		\item 
		\item By \Cref{prop:sum} and the previous point $\tau + \varrho$ is a consistent permutation between   $(\der{D}_1, \alpha_1, \omega_1)\cdot (\der{D}_2, \alpha_2, \omega_2)$ and $(\der{D}'_1, \alpha'_1, \omega'_1)\cdot (\der{D}'_2, \alpha'_2, \omega'_2)$. Hence, by \Cref{cor:unique} we have
		\[\tau+\varrho=\sigma\]
		From which the thesis follows.\qedhere 
	\end{enumerate}
\end{proof}


\section{Switch equivalence and traces}
\todo{A VERY NICE INTRO}

\subsection{Sequentially independent and switchable derivations}
\todo{A VERY NICE INTRO}

\begin{definition}  Let $(\X, \R)$ be a left-linear DPO-rewriting system with $\X$ an $\mathcal{M}$-adhesive category. Let also $\dder{D}\colon G\Mapsto H$ and $\dder{D'}\colon H\Mapsto T$ be the two direct derivations depicted below.

\[\xymatrix{L \ar[d]_{n}& K \ar[d]^{k}\ar[l]_{l} \ar[r]^{r} & R \ar[d]^{h} & L' \ar[d]_{n'}& K' \ar[d]^{k'}\ar[l]_{l'} \ar[r]^{r'} & R' \ar[d]^{h'}\\G & \ar[l]^{f} D \ar[r]_{g}& H & H & \ar[l]^{f'} D' \ar[r]_{g'}& T}\]

An \emph{independence pair} between $\dder{D}$ and $\dder{D'}$, is a pair of  arrows $i_1\colon R\to D'$ and $i_2\colon L'\to D$ such that the following diagram commutes.

\[\xymatrix@C=15pt{L \ar[d]_{n}&& K \ar[d]_{k}\ar[ll]_{l} \ar[r]^{r} & R \ar@/^.35cm/@{.>}[drrr]|(.3)\hole_(.4){i_1} \ar[dr]|(.3)\hole_{h} && L' \ar@/_.35cm/@{.>}[dlll]^(.4){i_2} \ar[dl]|(.3)\hole^{n'}& K' \ar[d]^{k'}\ar[l]_{l'} \ar[rr]^{r'} && R' \ar[d]^{h'}\\G && \ar[ll]^{f} D \ar[rr]_{g}&& H  && \ar[ll]^{f'} D' \ar[rr]_{g'}&& T}\]
We will say that $\dder{D}$ and $\dder{D'}$ are \emph{weakly sequentially independent} if an independence pair exists. If such independence pair is unique we will say that $\dder{D}$ and $\dder{D'}$ are \emph{sequentially independent}.
\end{definition}

\begin{example}
	\todo{sequential independence}
\end{example}
\begin{example}
	\todo{sequential independence che serva anche per es successivo}
\end{example}

\begin{remark}\label{rem:weak} Let $(i_1, i_2)$ and $(j_1, j_2)$ be independence pairs for the direct derivations $\dder{D}$ and $\dder{D'}$. Notice that, by definition, we have
	\begin{align*}f'\circ i_1&=h\\&=f'\circ j_1
	\end{align*}
	On the other hand, 
	 $f'\colon D'\to H$ is  the pushout of $l'\colon K'\to L'$ and so it is in $\mathcal{M}$, implying $j_1=i_1$. If, moreover, we suppose that the rule $\rho$ applied in $\dder{D}$ is linear, then $g\colon D\to H$ is in $\mathcal{M}$ too, hence, from the equation
	 \begin{align*}
	 g\circ i_2&=h \\&= g\circ j_2
	 \end{align*}
we can deduce that $i_2=j_2$, too.

Summing up, if $(\X, \R)$ is a linear DPO-rewriting system, then sequential independence and weak sequential independence coincide. 
\end{remark}



When working with linear rewriting systems, (weakly) sequential independent direct derivations can be switched, producing two new (weakly) sequential independent direct derivations between the same objects \cite[Thm.~$7.7$]{lack2005adhesive} . This is no more the case if the rules are only left-linear, as shown by the next example.

\begin{example}\label{ex:difficile}
	\todo{pensare ad un esempio in cui l'indipendenza non basta }
\end{example}

To fix this problem, we adapt the notion of \emph{canonical filler} from \cite{heindel2009category}.

\begin{definition}\label{def:filler}
Let $(\X, \R)$ be a left-linear DPO-rewriting system with $\X$ $\mathcal{M}$-adhesive. Let also $\dder{D}\colon G\Mapsto H$ and $\dder{D}'\colon H\Mapsto T$ be the two derivations depicted below.
\[\xymatrix{L \ar[d]_{n}& K \ar[d]^{k}\ar[l]_{l} \ar[r]^{r} & R \ar[d]^{h} & L' \ar[d]_{n'}& K' \ar[d]^{k'}\ar[l]_{l'} \ar[r]^{r'} & R' \ar[d]^{h'}\\G & \ar[l]^{f} D \ar[r]_{g}& H & H & \ar[l]^{f'} D' \ar[r]_{g'}& T}\]
Since $f'$ is in $\mathcal{M}$, we can moreover consider a pullback square
\[\xymatrix{P \ar[r]^{p} \ar[d]_{p'}& D\ar[d]^{g} \\ D' \ar[r]_{f'} & H}\]

A \emph{filler} between $\dder{D}$ and $\dder{D}'$ is  given by a pair of arrows $u\colon K\to P$ and $u'\colon K'\to P$ satisfying the following conditions
\begin{enumerate}
	\item $p\circ u = k$, $p'\circ u' = k'$ and there exists a pushout square
\[\xymatrix{K' \ar[r]^{r'} \ar[d]_{u'}& R'\ar@{.>}[d]^{j'} \\ P \ar@{.>}[r]_{q'} & Q'}\]
	\item  there exist arrows $i_1\colon R\to D'$, $i_2\colon L'\to D$ satisfying $f'\circ i_1=h$, $g\circ i_2=n'$ and such that the following squares are pushouts
\[\xymatrix{K \ar[r]^{r} \ar[d]_{u}& R \ar@{.>}[d]^{i_1} &K' \ar[r]^{l'} \ar[d]_{u'}& L'\ar@{.>}[d]^{i_2} \\P \ar[r]_{p'}& D' & P \ar[r]_{p} & D}\]
\end{enumerate}
\end{definition}

\begin{remark}\label{rem:deco} Let $\dder{D}$ and $\dder{D'}$ be two switchable direct derivations. Then the existence of a filler allows us to build the solid part of the diagram below.
	\[\xymatrix{&&R \ar@/_1cm/[ddrr]_(.35){i_1}|(.7)\hole  \ar[dr]^{h}&& L'\ar@/^1cm/[ddll]^(.35){i_2}  \ar[dl]_{n'}\\&K\ar[dr]^{k}\ar[dl]_{l} \ar@/_.8cm/[ddrr]^(.65){u}\ar[ur]^{r}&& H && K' \ar@/^.8cm/[ddll]_(.65){u'}\ar[dl]_{k'}\ar[lu]_{l'} \ar[dr]^{r'}\\L \ar[dr]_{n} \ar@{.>}@/_.8cm/[ddrr]_{j}&& D \ar[dl]|(.42)\hole_(.64){f}\ar[ur]|(.48)\hole^(.7){g}&&D' \ar[dr]|(.42)\hole^(.65){g'} \ar[ul]|(.48)\hole_(.7){f'}&&R'\ar@/^.8cm/[ddll]^{j'}\ar[dl]^{h'}\\&G &&P\ar[dr]^{q'} \ar@{.>}[dl]_{q}\ar[ur]^(.4){p'}\ar[ul]_(.4){p}&&T\\&&Q \ar@{.>}[ul]_{s} &&Q'\ar@{.>}[ur]^{t}}\]
	
	Let us complete this diagram defining the dotted arrows. We can start noticing that, since $l\in \mathcal{M}$, there exists a pushout square 
	\[\xymatrix{K \ar[r]^{l} \ar[d]_{u}& L\ar[d]^{j} \\ P \ar[r]_{q} & Q}\]
	Moreover, the existence of the wanted $s\colon Q\to G$ and $t\colon Q'\to T$ follows from the following equalities
	\[\begin{split}
		f\circ p \circ u &= f\circ k \\&= n\circ l
	\end{split} \qquad \begin{split}
		g'\circ p'\circ u' &= g'\circ k'\\&=h'\circ r'
	\end{split}\]
	
	We can prove some other properties of the arrows appearing in the diagram above. The three rectangles below are pushouts and their left halves are pushouts too. Therefore, by \Cref{lem:po1}, also their right halves are pushouts.
	\[\xymatrix{K \ar@/^.4cm/[rr]^{u}\ar[d]_{r}\ar[r]_{u} &P\ar[d]^{p'} \ar[r]_{p} & D \ar[d]^{g}&K' \ar@/^.4cm/[rr]^{k'}\ar[d]_{l'}\ar[r]_{u'} &P\ar[d]^{p} \ar[r]_{p'} & D' \ar[d]^{f'}\\  R \ar@/_.4cm/[rr]_{h} \ar[r]^{i_1}&D' \ar[r]^{f'} & H&L' \ar@/_.4cm/[rr]_{n'} \ar[r]^{i_2}&D \ar[r]^{g} & H}\]
	\[ \xymatrix{K \ar@/^.4cm/[rr]^{k}\ar[d]_{l}\ar[r]_{u} &P\ar[d]^{q} \ar[r]_{p} & D \ar[d]^{f}&K' \ar@/^.4cm/[rr]^{k'}\ar[d]_{r'}\ar[r]_{u'} &P\ar[d]^{q'} \ar[r]_{p'} & D' \ar[d]^{g'}\\ L \ar@/_.4cm/[rr]_{n} \ar[r]^{j}&Q \ar[r]^{s} & G&R' \ar@/_.4cm/[rr]_{h'} \ar[r]^{j'}&Q' \ar[r]^{t} & T}\]
	
	Notice, moreover, that $p, q$ are the pushouts of $l'$ and $l$, respectively, thus they  are elements of $\mathcal{M}$. By \Cref{prop:pbpoad} the squares
	\[\xymatrix{P\ar[r]^{p} \ar[d]_{p'} & D \ar[d]^{g}& P \ar[r]^{p} \ar[d]_{q} &D\ar[d]^{f}\\ D' \ar[r]_{f'} & H & Q \ar[r]_{s}& G}\]
	are pullbacks too.
\end{remark}


Notice that if there is a filler between  $\dder{D}$ and $\dder{D}'$ are switchable, then they are weakly sequentially independent: indeed, if a filler between them exists, then $(i_1, i_2)$ is an independence pair. On the other hand, \Cref{ex:difficile} shows that not every independence pair arises in this way.

\begin{definition} Let  $\dder{D}\colon H\Mapsto H$, $\dder{D}'\colon H\Mapsto T$ be two direct derivations in a left-linear DPO-rewriting system  $(\X, \R)$. An independence pair $(i_1, i_2)$ between $\dder{D}$ and $\dder{D}'$ is \emph{good} if there exists a filler $(u,u')$ between them such that  the squares below are pushouts.\[\xymatrix{K \ar[r]^{r} \ar[d]_{u}& R \ar[d]^{i_1} &K' \ar[r]^{l'} \ar[d]_{u'}& L'\ar[d]^{i_2} \\P \ar[r]_{p'}& D' & P \ar[r]_{p} & D}\]
	
We will say that $\dder{D}$ and $\dder{D}'$ are \emph{switchable} if a good independence pair between them exists. If such a pair is unique, we will say that $\dder{D}$ and $\dder{D}'$ are \emph{uniquely switchable}. We will use the notation $\dder{D}\updownarrow \dder{D'}$ to mean that $\dder{D}$ and $\dder{D}'$ are switchable, while $\dder{D}\updownarrow_! \dder{D'}$ will denote that they are uniquely so.


If every independence pair is good we will say that $(\X, \R)$ is \emph{tame}.
\end{definition}

\begin{remark}\label{rem:unic} Given a good independence pair $(i_1, i_2)$ between $\dder{D}$ and $\dder{D}'$, there is a unique filler  such that $(u,u')$ such that 
	\[\xymatrix{K \ar[r]^{r} \ar[d]_{u}& R \ar[d]^{i_1} &K' \ar[r]^{l'} \ar[d]_{u'}& L'\ar[d]^{i_2} \\P \ar[r]_{p'}& D' & P \ar[r]_{p} & D}\]
	are pushouts. Indeed, for every other filler $(v,v')$, it must be that
	\[\begin{split}
		p\circ u &=k \\&= p\circ v
	\end{split}\qquad \begin{split}
	p\circ u' &= i_2\circ l' \\&= p\circ v'
	\end{split}\]
	Since the arrow $p\colon P\to D$, which is the pullback of $f'$, is in $\mathcal{M}$ we conclude that $(u,u')=(v,v')$.
\end{remark}

\begin{remark}
  Clearly in a tame left-linear DPO-rewriting system two direct derivations are sequentially independent if and only if they are unquely switchable.
\end{remark}

A source of tame left-linear DPO-rewriting systems is given by the linear ones, as shown by the following proposition.

\begin{proposition}\label{prop:equi}Every linear DPO-rewriting system $(\X, \R)$ is tame.
 \end{proposition}
\begin{proof} Suppose that $\X$ is $\mathcal{M}$-adhesive and let $(i_1, i_2)$ be an independence pair between $\dder{D}\colon G\Mapsto H$ and $\dder{D}'\colon H\Mapsto T$. We have a diagram
	\[\xymatrix@C=15pt{L \ar[d]_{n}&& K \ar[d]_{k}\ar[ll]_{l} \ar[r]^{r} & R \ar@/^.35cm/[drrr]|(.3)\hole_(.4){i_1} \ar[dr]|(.3)\hole_{h} && L' \ar@/_.35cm/[dlll]^(.4){i_2} \ar[dl]|(.3)\hole^{n'}& K' \ar[d]^{k'}\ar[l]_{l'} \ar[rr]^{r'} && R' \ar[d]^{h'}\\G && \ar[ll]^{f} D \ar[rr]_{g}&& H  && \ar[ll]^{f'} D' \ar[rr]_{g'}&& T}\]
Pulling back $g$ along $f'$, we get another diagram 
	\[\xymatrix{&&R \ar@/_1cm/[ddrr]_(.35){i_1}|(.7)\hole \ar[dr]^{h}&& L'\ar@/^1cm/[ddll]^(.35){i_2}  \ar[dl]_{n'}\\&K\ar[dr]^{k}\ar[dl]_{l} \ar@{.>}@/_.8cm/[ddrr]^(.65){u}\ar[ur]^{r}&& H && K' \ar@{.>}@/^.8cm/[ddll]_(.65){u'}\ar[dl]_{k'}\ar[lu]_{l'} \ar[dr]^{r'}\\L \ar[dr]_{n} && D \ar[dl]|(.42)\hole_(.64){f}\ar[ur]|(.48)\hole^(.7){g}&&D' \ar[dr]|(.42)\hole^(.65){g'} \ar[ul]|(.48)\hole_(.7){f'}&&R'\ar[dl]^{h'}\\&G &&P\ar[ur]^(.4){p'}\ar[ul]_(.4){p}&&T}\] 
Now, if we compute we get
\[\begin{split}
	f'\circ i_1\circ r &= h\circ r \\&= g\circ k
\end{split}\qquad \begin{split}
g\circ i_2\circ l' &= n'\circ l'\\&=f'\circ k'
\end{split}\]
Therefore the two dotted arrows $u\colon K\to P$ and $u'\colon K'\to P$ exist. We have to show that they satisfy the two conditions in the definition of a filler. 
\begin{enumerate}
	\item  By construction $p\circ u = k$ and $p'\circ u'=k'$. Since $(\X, \R)$ is linear, then $r'\colon K'\to R'$ belongs to $\mathcal{M}$, thus it admits a pushout along $u'\colon K'\to P$, as wanted.
	\item Take the following two rectangles
\[\xymatrix{K \ar@/^.4cm/[rr]^{u}\ar[d]_{r}\ar[r]_{u} &P\ar[d]^{p'} \ar[r]_{p} & D \ar[d]^{f}&K' \ar@/^.4cm/[rr]^{k'}\ar[d]_{l'}\ar[r]_{u'} &P\ar[d]^{p} \ar[r]_{p'} & D' \ar[d]^{f'}\\  R \ar@/_.4cm/[rr]_{h} \ar[r]^{i_1}&D' \ar[r]^{f'} & H&L' \ar@/_.4cm/[rr]_{n'} \ar[r]^{i_2}&D \ar[r]^{g} & H}\]
	By hypothesis $r$ and $l'$ are in $\mathcal{M}$, thus $f'$ and $g$ belong to it too. The first point of \Cref{lem:popb}  yields the thesis. \qedhere 
\end{enumerate}
\end{proof}

\begin{remark} \cite{baldan2011adhesivity} identifies a large class of (quasi)adhesive categories with the property that every left linear DPO-rewriting system on them is tame. We adapt these results to our context in \Cref{app:fill}. 
\end{remark}
\begin{definition}[Very tameneness]
	\todo{very tame}
\end{definition}

\begin{remark}
	\todo{tutto coincide con tutto}
\end{remark}


We are now going to justify the choice of the name for the relation $\updownarrow$, showing that two switchable direct derivations $\dder{D}$ and $\dder{D'}$ can be actually switched. 

Let $(i_1, i_2)$ be a good independence pair and consider the following diagram: the solid part exists by the definition of a filler, while the two new dotted arrows $v\colon Q\to J$ and $v'\colon Q'\to J$ are obtained  as the pushout of $q\colon P\to Q$, which is in $\mathcal{M}$ by \Cref{rem:deco}, along $q'\colon P\to Q'$.
	\[\xymatrix{&&R \ar@/_1cm/[ddrr]_(.35){i_1}|(.7)\hole \ar[dr]^{h}&& L'\ar@/^1cm/[ddll]^(.35){i_2}  \ar[dl]_{n'}\\&K\ar[dr]^{k}\ar[dl]_{l} \ar@/_.8cm/[ddrr]^(.65){u}\ar[ur]^{r}&& H && K' \ar@/^.8cm/[ddll]_(.65){u'}\ar[dl]_{k'}\ar[lu]_{l'} \ar[dr]^{r'}\\L \ar[dr]_{n} \ar@/_.8cm/[ddrr]_{j}&& D \ar[dl]|(.42)\hole_(.64){f}\ar[ur]|(.48)\hole^(.7){g}&&D' \ar[dr]|(.42)\hole^(.65){g'} \ar[ul]|(.48)\hole_(.7){f'}&&R'\ar@/^.8cm/[ddll]^{j'}\ar[dl]^{h'}\\&G &&P\ar[dr]^{q'} \ar[dl]_{q}\ar[ur]^(.4){p'}\ar[ul]_(.4){p}&&T\\&&Q \ar[ul]_{s}\ar@{.>}[dr]_{v} &&Q'\ar[ur]^{t} \ar@{.>}[dl]^{v'}\\&&&J}\]
	
	Since, by \Cref{rem:deco}, all the curved rectangles are pushouts, as well as the bottom square, we can state the following definition.
\begin{definition}\label{def:switch}
	Let $(\X,R)$ be a left-linear DPO-rewriting system and suppose that $\X$ is $\mathcal{M}$-adhesive. Given a good independence pair $(i_1, i_2)$ between $\dder{D}\colon G\Mapsto H$ and $\dder{D}'\colon H\Mapsto T$, if $(u,u')$ is the associate filler, we define other two direct derivations $S_{i_1,i_2}(\dder{D}')\colon G\Mapsto J$ and $S_{i_1,i_2}(\dder{D})\colon J\Mapsto T$ as follows:
		\[\xymatrix{L' \ar[d]_{f\circ i_2}& \ar[l]_{l'}K'\ar[d]_{q\circ u'} \ar[r]^{r'} & R' \ar[d]_{v'\circ j'} & L \ar[d]_{v\circ j} & \ar[l]_{l}K \ar[d]^{q'\circ u}\ar[r]^{r}& R \ar[d]^{g'\circ i_1}\\
		G &\ar[l]^{s} Q \ar[r]_{v}& J&J & \ar[l]^{v'}Q' \ar[r]_{t} & T}\]
	The \emph{switching} $\sder{D}{D'}$ of $\dder{D}$ and $\dder{D'}$ is the derivation $S_{i_1,i_2}(\dder{D}')\cdot S_{i_1,i_2}(\dder{D})$.
\end{definition}

\begin{remark}\label{rem:indip}Notice that $(j', j)$ is an independence pair for $S_{i_1,i_2}(\dder{D}')$ and $S_{i_1,i_2}(\dder{D})$. This is witnessed by the following diagram, commutative by construction.
	\[\xymatrix@C=15pt{L' \ar[d]_{f\circ i_2}&& K' \ar[d]_{q\circ u'}\ar[ll]_{l'} \ar[r]^{r'} & R' \ar@/^.35cm/[drrr]_(.4){j'}|(.285)\hole \ar[dr]|(.28)\hole_{v'\circ j'} && L \ar@/_.35cm/[dlll]^(.4){j} \ar[dl]|(.28)\hole^{v\circ j}& K \ar[d]^{q'\circ u}\ar[l]_{l} \ar[rr]^{r} && R \ar[d]^{g'\circ i_1}\\G && \ar[ll]^{s} Q \ar[rr]_{v}&& J  && \ar[ll]^{v'} Q' \ar[rr]_{t}&& T}\]
\end{remark} 
 
\begin{theorem}[Local Church-Rosser Theorem]\label{prop:fil}Let $(\X, \R)$ be a left-linear DPO-rewriting system with $\X$ an $\mathcal{M}$-adhesive category. Then every filler between two direct derivations $\dder{D}\colon G\Mapsto H$ and $\dder{D}'\colon H\Mapsto T$ is a filler also for $S_{u,u'}(\dder{D'})\colon G\Mapsto J$ and $S_{u,u'}(\dder{D})\colon J\Mapsto H$. In particular, if $\dder{D}\updownarrow \dder{D}'$, then $S_{u,u'}(\dder{D}')\updownarrow S_{u,u'}(\dder{D})$.
\end{theorem}
\begin{proof}By definition of filler, we have two pushout square
		\[\xymatrix{K \ar[r]^{l} \ar[d]_{u}& L \ar[d]^{j} & K' \ar[r]^{r'} \ar[d]_{u'} & R' \ar[d]^{j'}\\ P \ar[r]_q & Q & P \ar[r]_{q'} & Q'}\]
		In particular, $q$ is an arrow of $\mathcal{M}$, therefore, by \Cref{prop:pbpoad}, the square below is a pullback.
		\[\xymatrix{P \ar[r]^{q} \ar[d]_{q'}& Q\ar[d]^{v}\\ Q' \ar[r]_{v'} & J}\]
		To prove our claim, it is now enough to show that $(u',u)$ is a filler between $S_{u,u'}(\dder{D}')$ and $S_{u, u'}(\dder{D})$.
		\begin{enumerate}
			\item As for the first  point of \Cref{def:filler}, the only non obvious part is the existence of a pushout of $u$ along $r$. But, since $(u,u')$ is a filler between $\dder{D}$ and $\dder{D'}$, we know that such a pushout exists: it is enough to take the square
			\[\xymatrix{K \ar[r]^{r} \ar[d]_{u}& R \ar[d]^{i_1} \\P \ar[r]_{p'}& D'}\]
			\item For the second point, notice that the arrows $j$ and $j'$ fit in the squares
	\[\xymatrix{K' \ar[r]^{r'} \ar[d]_{u'}& R' \ar[d]^{j'} &K \ar[r]^{l} \ar[d]_{u}& L\ar[d]^{j} \\P \ar[r]_{q}& Q& P \ar[r]_{q'} & Q'}\] 
		\end{enumerate}
		
By \Cref{rem:indip} we know that $(j,j')$ is an independence pair. The results above now implies that $(j,j')$ is good.
\end{proof}

The previous remark allow us to further switch the direct derivation $S_{i_1,i_2}(\dder{D})$ and $S_{i_2,i_2}(\dder{D}')$. The following lemma guarantees us that, in this way, we get back a derivation which is abstraction equivalent to $\dder{D}\cdot \dder{D}'$.

\todo{introdurre decorazione}

\begin{lemma}\label{lem:rev}
	Let $\dder{D}\colon G\Mapsto H$ and $\dder{D}'\colon H\Mapsto T$ be two direct derivations in a left-linear DPO-rewriting system $(\X, \R)$ and let $(i_1,i_2)$ be a good independence pair between them. Then $S_{j',j}(S_{i_1,i_2}(\dder{D}, \dder{D'}))$ is abstraction equivalent to $\dder{D}\cdot \dder{D}'$. 
\end{lemma}
\begin{proof}Let $(u,u')$ be the filler associated to $(i_1, i_2)$. By \Cref{prop:fil}, $(u', u)$ is a filler between $S_{i_1,i_2}(\dder{D}')$ and $S_{i_1,i_2}(\dder{D})$. Thus we have a diagram as the one below.
		\[\xymatrix{&&R' \ar@/_1cm/[ddrr]_(.35){j'}|(.7)\hole \ar[dr]^{v'\circ j'}&& L \ar@/^1cm/[ddll]^(.35){j}  \ar[dl]_{v\circ j}\\&K'\ar[dr]^{q\circ u'}\ar[dl]_{l'} \ar@/_.8cm/[ddrr]^(.65){u'}\ar[ur]^{r'}&& J && K \ar@/^.8cm/[ddll]_(.65){u}\ar[dl]_{q'\circ u}\ar[lu]_{l} \ar[dr]^{r}\\L' \ar[dr]^{f\circ i_2} \ar@/_.8cm/[ddrr]_{c_2}&& Q \ar[dl]|(.42)\hole_(.64){s}\ar[ur]|(.48)\hole^(.7){v}&&Q' \ar[dr]|(.42)\hole_(.65){t} \ar[ul]|(.48)\hole_(.7){v'}&&R\ar@/^.8cm/[ddll]^{c_1}\ar[dl]_{g'\circ i_1}\\&G &&P\ar[dr]^{e} \ar[dl]_{e'}\ar[ur]^(.4){q'}\ar[ul]_(.4){q}&&T\\&&E' \ar[ul]_{a}\ar[dr]_{w'} &&E\ar[ur]^{b} \ar[dl]^{w}\\&&&F}\]
	
	Now, to ease the notation, let $S_{j',j}(S_{i_1,i_2}(\dder{D}, \dder{D'}))$ be $\dder{E}_0\cdot \dder{E}_1$, then $\dder{E}_0$ and $\dder{E}_1$ are the direct derivations given by the diagrams
	\[\xymatrix{L \ar[d]_{s\circ j}& K\ar[l]_{l} \ar[r]^{r} \ar[d]_{e'\circ u} & R \ar[d]_{w\circ c_1} & L' \ar[d]^{w'\circ c_2}& K' \ar[d]^{e\circ u'} \ar[r]^{r'} \ar[l]_{l'}& R' \ar[d]^{t\circ j'}\\G & E' \ar[l]^{a}  \ar[r]_{w'}& F & F & E \ar[l]^{w} \ar[r]_{b} & R}\]
	
	Notice, moreover, that, since the squares
	\[\xymatrix{K' \ar[d]_{u'} \ar[r]^{l'}& L' \ar[d]^{c_2} & K \ar[r]^{r}\ar[d]_{u} & R \ar[d]^{c_1}\\ P \ar[r]_{e'} & E' & P\ar[r]_e & E}\]
	are pushouts, we have isomorphisms  $\phi'\colon D\to E'$, $\phi\colon D'\to E$ making the following diagrams commutative.
	\[\xymatrix{K' \ar[d]_{u'} \ar[r]^{l'}& L'\ar[d]^{i_2}  \ar@/^.2cm/[dr]^{c_2} & &K \ar[r]^{r}\ar[d]_{u} & R \ar[d]^{i_1} \ar@/^.2cm/[dr]^{c_1}\\ P \ar@/_.4cm/[rr]_{e'}\ar[r]^{p} & D\ar@{.>}[r]^{\phi'} &E'& P\ar@/_.4cm/[rr]_{e}\ar[r]^{p'} & D'\ar@{.>}[r]^{\phi}& E}\]
	In particular, we have
	\[\begin{split}
		a\circ \phi' \circ i_2&=a \circ c_2\\&=f\circ i_2\\&
	\end{split}\quad \begin{split}
	a\circ \phi' \circ p'&=a \circ e'\\&=s\circ q\\&=f\circ p
	\end{split}\quad \begin{split}
	b\circ \phi \circ i_1&=b \circ c_1\\&=g'\circ i_1\\&
	\end{split}\quad \begin{split}
	b\circ \phi \circ p&=b \circ e\\&=t\circ q'\\&=g'\circ p'
	\end{split} \]
	and this shows that 
	\[a\circ \phi'=f \qquad b\circ \phi = g'\]
	Now, since $\phi'$ is an isomorphism and by \Cref{prop:pbpoad}, the two halves of the rectangle
	\[\xymatrix{K\ar[r]^{\id{K}} \ar[d]_{(\phi')^{-1} \circ e' \circ u}&K\ar[d]_{e'\circ u} \ar[r]^{l} & L \ar[d]^{s\circ j} \\D\ar[r]_{\phi'} & E' \ar[r]_{a}&G}\]
	are pullbacks. Thus the whole diagram is a pullback. But, by construction $s\circ j =n$ and we have already proved that $a\circ \phi'=f$. We then conclude that ther exists an isomorphism $\zeta\colon K\to K$ which makes the diagram below commutative
	\[\xymatrix{K \ar@{.>}[r]_{\zeta}\ar@/^.4cm/[rr]^{l}  \ar@/_.5cm/[dr]_{(\phi')^{-1} \circ e' \circ u}& K \ar[r]_{l} \ar[d]_{n} & L \ar[d]^{n} \\ & D \ar[r]_{f} & G}\]
	The commutativity of the upper triangle entails $l\circ \zeta=l$. Since $l$ is an element of $\mathcal{M}$  we can deduce that. $\zeta=\id{K}$. From this, we conclude that
	\[e'\circ u = \phi' \circ k\]
	
	As a next step, notice the existence of $\phi$ and $\phi'$, together with \Cref{rem:deco}, entails  the existence of a third isomorphism $\psi\colon H\to F$ fitting in the diagram below.
	\[\xymatrix{P  \ar[d]^{p'}\ar@/_.4cm/[dd]_{e}\ar@/^.4cm/[rr]^{e'} \ar[r]_{p} & D \ar[d]^{g} \ar[r]_{\phi'} & E'\ar[d]^{w'}\\D' \ar[d]^{\phi} \ar[r]_{f'} & H\ar@{.>}[r]^{\psi} & F \\E \ar@/_.4cm/[urr]_{w}}\]
Now, if we compute, we get
\begin{align*}
	\psi^{-1}\circ w\circ c_1&=f'\circ \phi^{-1}\circ c_1\\&=f'\circ i_1\\&=h
\end{align*}
	Summing up, we have just build the diagram below.	
	\[\xymatrix@C=40pt@R=10pt{ &&&R\ar[dddr]^{w\circ c_1} \ar[dddl]_{h}|(.67)\hole\\&&K \ar[dl]_{l} \ar[ur]^{r}\ar[dddr]^{e'\circ u} \ar[dddl]_{k}|(.67)\hole\\&L\ar[dddr]^(.4){s\circ j} \ar[dddl]_(.4){n}\\&&H \ar[rr]^{\psi} && F\\ & D \ar[ur]_(.7){g} \ar[rr]^{\phi'} \ar[dl]_{f}&& E' \ar[ur]_{w'}\ar[dl]^{a}\\ G \ar[rr]_{\id{G}} && G}\]

Next, we already know that
\[t\circ j'= h' \quad w\circ \phi = \psi \circ f' \quad b\circ \phi = g'\]
If we compute further, we also get
\[\begin{split}
	\psi^{-1}\circ w'\circ c_2 &= g\circ (\phi')^{-1}\circ c_2\\&=g\circ i_2\\&=n'
\end{split}\qquad \begin{split}
\phi^{-1}\circ e \circ u'&=p'\circ u'\\&= k'\\&
\end{split}\]
These equations allow us to conclude that the following diagram commutes.
	\[\xymatrix@C=40pt@R=10pt{ &&&R'\ar[dddr]^{t\circ j'} \ar[dddl]_{h'}|(.67)\hole\\&&K' \ar[dl]_{l'} \ar[ur]^{r}\ar[dddr]^{e\circ u'} \ar[dddl]_{k}|(.67)\hole\\&L'\ar[dddr]^(.4){w'\circ c_2} \ar[dddl]_(.4){n'}\\&&T \ar[rr]^{\id{T}} && T\\ & D' \ar[ur]_(.7){g'} \ar[rr]^{\phi} \ar[dl]_{f'}&& E \ar[ur]_{b}\ar[dl]^{w}\\ H \ar[rr]_{\psi} && F}\]

Putting together the two diagrams above we get the thesis. \qedhere 
\end{proof}


Our next step is to relate derivations which are equal ``up to switching''.

\begin{definition} Let $(\X, \R)$ be a left-linear DPO-rewriting system. Given two direct derivations $\dder{D}\colon G\Mapsto H$ and $\dder{D}'\colon H\Mapsto T$, we say that  $\dder{D}$ and $\dder{D}'$ are \emph{properly switchable} if $\dder{D}\updownarrow_! \dder{D'}$ and $S_{i_1,i_2}(\dder{D}')\updownarrow_!S_{i_1,i_2}(\dder{D})$, where $(i_2,i_2)$ is a good independence pair betwwen $\dder{D}$ and $\dder{D}'$. In such a case, we will write $\dder{D}\Updownarrow\dder{D}'$. 
	
Take two derivations $\der{D}=\{\dder{D}_{i}\}_{i=0}^n$ and $\der{D}'=\{\dder{D}'_{i}\}_{i=0}^n$ with the same length and between the same $G_0$ and $G_n$. We say that $\der{D}'$ is \emph{obtained by a proper switch from $\der{D}$} if there exists an index $j < n$ such that
	\begin{enumerate}
\item for every $i\notin \{j, j+1\} $, $\dder{D}_i=\dder{D}'_i$;
\item $\dder{D}_j \Updownarrow \dder{D}_{j+1}$;		
\item $\dder{D}'_j\cdot \dder{D}'_{j+1} = S_{i_1,i_2}(\dder{D}, \dder{D}')$.
	\end{enumerate}
	In such a case, we will write $\der{D}\rightsquigarrow_j \der{D}'$ to denote that $\der{D}'$ is obtained by a proper switch between $\dder{D}_j$ and $\dder{D}_{j+1}$. 
	
	We will say that $\der{D}$ is \emph{switch equivalent} to $\der{D}'$, if there exists a sequence, $\{\der{D}_i\}_{i=0}^n$ of derivations such that
	\begin{enumerate}
		\item $\der{D}_0=\der{D}$ and $\der{D}_n=\der{D}'$;
		\item for every $i< n$, $\der{D}_{i+1}$ is obtained by a proper switch from $\der{D}_i$.
	\end{enumerate}
	
	We will write $\der{D} \equiv^s \der{D}'$ to denote that $\der{D}$ is switch equivalent to $\der{D}'$.
\end{definition}


\begin{example}
	\todo{il punto due sopra Ã¨ necessario}
\end{example}

We can now prove some properties of switch equivalence.
\begin{lemma}\todo{Def. 3 della bozza di Andrea }Let $(\X, \R)$ be a left-linear DPO-rewriting system. Then the following hold true: 
	\begin{enumerate}
		\item 
		\item 
		\item 
		\item 
	\end{enumerate}
\end{lemma}
\begin{proof}\begin{enumerate}
		\item 
		\item 
		\item 
		\item \qedhere 
	\end{enumerate}
\end{proof}


\begin{example}\todo{esempio sul perchÃ© weakly independence non Ã¨ invertibile}
\end{example}



\begin{lemma}\label{lem:consperm} Let $(\X, \R)$ be a left-linear DPO-rewriting system $(\X, \R)$. Then the following hold true
	\begin{enumerate}
		\item If $\dder{D}$ and $\dder{D'}$ are two direct derivations such that $\dder{D}\updownarrow \dder{D'}$, then for every filler $(u,u')$ between them, the function
		\[\tau\colon 2\to2 \qquad x \mapsto \begin{cases}
			1 & x=0\\
			0 & x=1
		\end{cases}\]
		defines a consistent permutation between $\dder{D}\cdot \dder{D}'$ and $\sder{D}{D'}$;
		\item if $\der{D}$ and $\der{D}'$ are two switch equivalent derivation, then there exists a consistent permutation between them.
	\end{enumerate}
\end{lemma}
\begin{proof}
	\begin{enumerate}
		\item 
		\item \qedhere 
	\end{enumerate}
\end{proof}
 This, together with ???
\begin{corollary}
	\todo{unicitÃ }
\end{corollary}

\begin{example}\label{ex:contro}\todo{permutazione consistente non implica scambiabilitÃ }
\end{example}



\subsubsection{Graphical rewriting systems}\label{subsubsec:graphical}


\todo{ci sono un sacco di sistemi very tame}
\subsection{On the globality of $\Updownarrow$}
\todo{intro}


\begin{lemma}[Three steps Lemma]\label{lem:iig1}Let $(\X,\R)$ be a left-linear DPO-rewriting system with $\X$ an $\mathcal{M}$-adhesive category. Consider a derivation $\der{D}=\{\dder{D}_i\}_{i=0}^2$ and suppose that $(i_0,i_1)$ is a good independence pair between $\dder{D}_0$ and $\dder{D}_1$, $(a_0,a_1)$ one between $\dder{D}_1$ and $\dder{D}_2$ and $(e_0, e_1)$ one between $\dder{D}_0$ and $S_{a_0,a_1}(\dder{D}_2)$. Then the following properties hold true.
	\begin{enumerate}
		\item $S_{e_0,e_1}(\dder{D}_0)$ and $S_{a_0,a_1}(\dder{D}_1)$ are weakly sequentially independent.
		\item If $S_{i_0, i_1}(\dder{D}_0)\updownarrow_! \dder{D}_2$ with a good independence pair $(\alpha_0, \alpha_1)$, then  $S_{i_0,i_1}(\dder{D}_1)$ and $S_{\alpha_0, \alpha_1}(\dder{D}_2)$ are weakly sequentially independent.
	\end{enumerate}
	
\end{lemma}
\begin{proof}  As a preliminary step, we are going to use \Cref{def:filler,def:switch} to get some diagrams.  First of all, let $(v,v')$ be the filler between $\dder{D}_0$ and $\dder{D}_1$ associated to $(i_0, i_1)$, then we have
	\[\xymatrix{&&R_0 \ar@/_1cm/[ddrr]_(.35){i_0}|(.7)\hole \ar[dr]^{h_0}&& L_1\ar@/^1cm/[ddll]^(.35){i_1}  \ar[dl]_{m_1}\\&K_0\ar[dr]^{k_0}\ar[dl]_{l_0} \ar@/_.8cm/[ddrr]|(.36)\hole^(.65){v}\ar[ur]^{r_0}&& G_1 && K_1 \ar@/^.8cm/[ddll]|(.36)\hole_(.65){v'}\ar[dl]_{k_1}\ar[lu]_{l_1} \ar[dr]^{r_1}\\L_0 \ar@/_.8cm/[ddrr]_(.2){j_0}|(.31)\hole|(.81)\hole \ar[dr]^(.4){m_0}|(.61)\hole && D_0 \ar[dl]|(.4)\hole_(.65){f_0}\ar[ur]|(.5)\hole^(.7){g_0}&&D_1 \ar[dr]|(.4)\hole^(.65){g_1} \ar[ul]|(.5)\hole_(.65){f_1}&&R_1\ar@/^.8cm/[ddll]^(.2){j_1}|(.31)\hole|(.81)\hole\ar[dl]_{h_1}\\&G_0 &&P_1\ar[dr]_{q_1} \ar[dl]^{q_0}\ar[ur]^(.4){p_1}\ar[ul]_(.4){p_0}&&G_2\\L_1 \ar@/^.8cm/[uurr]^(.2){i_1} \ar[ur]_(.35){f_0\circ i_1}|(.61)\hole&&Q_0 \ar[ul]|(.4)\hole_(.65){s_0}\ar[dr]|(.5)\hole^(.65){t_0} &&Q_1\ar[ur]|(.4)\hole^(.65){t_1} \ar[dl]|(.5)\hole_(.65){s_1} && R_0  \ar[ul]^(.35){g_1\circ i_0}|(.61)\hole\ar@/_.8cm/[uull]_(.2){i_0}\\&K_1 \ar[ur]_{q_0\circ v'} \ar[dr]_{r_1} \ar[ul]^{l_1}\ar@/^.8cm/[uurr]_(.65){v'}&&H'_1&& K_0 \ar[ur]_{r_0} \ar[ul]^{q_1\circ v} \ar[dl]^{l_0} \ar@/_.8cm/[uull]^(.65){v}\\&& R_1 \ar[ur]_{\hspace{-5pt}s_1\circ j_1}\ar@/^1cm/[uurr]^(.25){j_1}&& L_0 \ar[ul]^{t_0\circ j_0\hspace{-5pt}} \ar@/_1cm/[uull]_(.25){j_0} |(.69)\hole }\]
	
	Secondly, the filler $(u,u')$ induced by $(a_0, a_1)$ between $\dder{D}_1$ and $\dder{D}_2$ yields:
	\[
	\xymatrix{&&R_1 \ar@/_1cm/[ddrr]_(.35){a_0}|(.7)\hole \ar[dr]^{h_1}&& L_2\ar@/^1cm/[ddll]^(.35){a_1}  \ar[dl]_{m_2}\\&K_1\ar[dr]^{k_1}\ar[dl]_{l_1} \ar@/_.8cm/[ddrr]|(.36)\hole^(.65){u}\ar[ur]^{r_1}&& G_2 && K_2 \ar@/^.8cm/[ddll]|(.36)\hole_(.65){u'}\ar[dl]_{k_2}\ar[lu]_{l_2} \ar[dr]^{r_2}\\L_1 \ar@/_.8cm/[ddrr]_(.2){b_0}|(.31)\hole|(.81)\hole \ar[dr]^(.4){m_1}|(.61)\hole && D_1 \ar[dl]|(.4)\hole_(.65){f_1}\ar[ur]|(.5)\hole^(.7){g_1}&&D_2 \ar[dr]|(.4)\hole^(.65){g_2} \ar[ul]|(.5)\hole_(.65){f_2}&&R_2\ar@/^.8cm/[ddll]^(.2){b_1}|(.31)\hole|(.81)\hole\ar[dl]_{h_2}\\&G_1 &&P_2\ar[dr]_{d_1} \ar[dl]^{d_0}\ar[ur]^(.4){c_1}\ar[ul]_(.4){c_0}&&G_3\\L_2 \ar@/^.8cm/[uurr]^(.2){a_1} \ar[ur]_(.35){f_1\circ a_1}|(.61)\hole&&Q_2 \ar[ul]|(.4)\hole_(.65){x_1}\ar[dr]|(.5)\hole^(.65){y_1} &&Q_3\ar[ur]|(.4)\hole^(.65){y_2} \ar[dl]|(.5)\hole_(.65){x_2} && R_1  \ar[ul]^(.35){g_2\circ a_0}|(.61)\hole\ar@/_.8cm/[uull]_(.2){a_0}\\&K_2 \ar[ur]_{d_0\circ u'} \ar[dr]_{r_2} \ar[ul]^{l_2}\ar@/^.8cm/[uurr]_(.65){u'}&&G'_2&& K_1 \ar[ur]_{r_1} \ar[ul]^{d_1\circ u} \ar[dl]^{l_1} \ar@/_.8cm/[uull]^(.65){u}\\&& R_2 \ar[ur]_{\hspace{-5pt}x_2\circ b_1}\ar@/^1cm/[uurr]^(.25){b_1}&& L_1 \ar[ul]^{y_1\circ b_0\hspace{-5pt}} \ar@/_1cm/[uull]_(.25){b_0} |(.69)\hole }\]


	Finally, the filler $(w,w')$  between $\dder{D}_0$ and $S_{a_0,a_1}(\dder{D}_2)$ given by $(e_0, e_1)$ provides us with:
\[\xymatrix{&&R_0 \ar@/_1cm/[ddrr]_(.35){e_0}|(.7)\hole \ar[dr]^{h_0}&& L_2\ar@/^1cm/[ddll]^(.35){e_1}  \ar[dl]_{f_1\circ a_1}\\&K_0\ar[dr]^{k_0}\ar[dl]_{l_0} \ar@/_.8cm/[ddrr]|(.36)\hole^(.65){w}\ar[ur]^{r_0}&& G_1 && K_2 \ar@/^.8cm/[ddll]|(.36)\hole_(.65){w'}\ar[dl]_{d_0\circ u'\hspace{-5pt}}\ar[lu]_{l_2} \ar[dr]^{r_2}\\L_0 \ar@/_.8cm/[ddrr]_(.2){o_0}|(.31)\hole|(.81)\hole \ar[dr]^(.4){m_0}|(.61)\hole && D_0 \ar[dl]|(.4)\hole_(.65){f_0}\ar[ur]|(.5)\hole^(.7){g_0}&&Q_2 \ar[dr]|(.4)\hole^(.65){y_1} \ar[ul]|(.5)\hole_(.65){x_1}&&R_2\ar@/^.8cm/[ddll]^(.2){o_1}|(.31)\hole|(.81)\hole\ar[dl]_(.35){x_2\circ b_1}\\&G_0 &&P_3\ar[dr]_{n_1} \ar[dl]^{n_0}\ar[ur]^(.4){u_1}\ar[ul]_(.4){u_0}&&G'_2\\L_2 \ar@/^.8cm/[uurr]^(.2){e_1} \ar[ur]_(.35){f_0\circ e_1}|(.61)\hole&&Q_4 \ar[ul]|(.4)\hole_(.65){z_0}\ar[dr]|(.5)\hole^(.65){z'_0} &&Q_5\ar[ur]|(.4)\hole^(.65){z'_1} \ar[dl]|(.5)\hole_(.65){z_1} && R_0  \ar[ul]^(.35){y_1\circ e_0}|(.61)\hole\ar@/_.8cm/[uull]_(.2){e_0}\\&K_2 \ar[ur]_{n_0\circ w'} \ar[dr]_{r_2} \ar[ul]^{l_2}\ar@/^.8cm/[uurr]_(.65){w'}&&G'_1&& K_0 \ar[ur]_{r_0} \ar[ul]^{n_1\circ w} \ar[dl]^{l_0} \ar@/_.8cm/[uull]^(.65){w}\\&& R_2 \ar[ur]_{\hspace{-4pt}z_1\circ o_1}\ar@/^1cm/[uurr]^(.25){o_1}&& L_0 \ar[ul]^{z'_0\circ o_0\hspace{-5pt}} \ar@/_1cm/[uull]_(.25){o_0} |(.69)\hole }\]	
So equipped we can turn to the prove of our claims.	
	\begin{enumerate}
		\item We have to construct the two dotted arrows in the diagram below.
			\[\xymatrix@C=15pt{L_0 \ar[d]_{z'_0\circ o_0}&& K_0 \ar[d]_{n_1\circ w}\ar[ll]_{l_0} \ar[r]^{r_0} & R_0 \ar@{.>}@/^.35cm/[drrr]_(.4){\beta_0}|(.285)\hole \ar[dr]|(.28)\hole_{y_1\circ e_0} && L_1 \ar@{.>}@/_.35cm/[dlll]^(.4){\beta_1} \ar[dl]|(.28)\hole^{y_1\circ b_0}& K_1 \ar[d]^{d_1\circ u}\ar[l]_{l_1} \ar[rr]^{r_1} && R_1 \ar[d]^{g_2\circ a_1}\\G'_1 && \ar[ll]^{z_1} Q_5 \ar[rr]_{z'_1}&& G'_2  && \ar[ll]^{x_2} Q_3 \ar[rr]_{y_2}&& G_3}\]
			
		Consider the arrows $i_0\colon R_0\to D_1$ and $e_0\colon R_0\to Q_2$. An easy computation shows that
			\begin{align*}
				f_1\circ i_0&= h_0\\&=x_1\circ e_0
			\end{align*}
			entailing the existence of  the dotted $\beta'_0\colon R_0\to P_2$ in the diagram
			\[\xymatrix{R_0 \ar@{.>}[dr]^{\beta'_0} \ar@/^.3cm/[drr]^{i_0} \ar@/_.3cm/[ddr]_{e_0}\\ &P_2 \ar[r]^{c_1} \ar[d]_{d_0}& D_1 \ar[d]^{f_1}\\ &Q_2\ar[r]_{x_1} & G_1}\]
			If we define $\beta_0\colon R_0\to Q_3$ as $d_1\circ \beta'_1$, then we easily get that 
		\begin{align*}
			x_2\circ \beta_0&=x_2\circ d_2\circ \beta'_0\\&= y_1\circ d_0\circ \beta'_0\\&=y_1\circ e_0
		\end{align*}
		
		To define $\beta_1$, we proceed similarly. First consider  $i_1\colon L_1\to D_0$ and $b_0\colon L_1 \to Q_2$ and notice that
		\begin{align*}
			g_0\circ i_1&= m_1 \\&= x_1 \circ b_0
		\end{align*}
			implying the existence of $\beta'_1\colon L_1\to P_3$ fitting in the diagram below.
			\[\xymatrix{L_1 \ar@{.>}[dr]^{\beta'_1} \ar@/^.3cm/[drr]^{i_1} \ar@/_.3cm/[ddr]_{b_0}\\ &P_3 \ar[r]^{u_0} \ar[d]_{u_1}& D_0 \ar[d]^{g_0}\\ &Q_2\ar[r]_{x_1} & G_1}\] 
			Let $\beta_1\colon L_1\to Q_5$ be $n_1\circ \beta'_1$, then
			\begin{align*}
				z'_1 \circ \beta_1 & = z'_1 \circ n_1\circ \beta'_1\\&=y_1\circ u_1\circ \beta'_1\\&=y_1\circ b_0
			\end{align*}
		Therefore, $(\beta_0, \beta_1)$ is the wanted independence pair.
			
\item  In addition to the three diagram above, we have a fourth one given by the filler $(\varphi_0, \varphi_1)$ associated to $(\alpha_0, \alpha_1)$. 
\[\xymatrix{&&R_0 \ar@/_1cm/[ddrr]_(.35){\alpha_0}|(.7)\hole \ar[dr]^{g_1\circ i_0}&& L_2\ar@/^1cm/[ddll]^(.35){\alpha_1}  \ar[dl]_{m_2}\\
&K_0\ar[dr]^{\hspace{-4pt}q_1\circ v}\ar[dl]_{l_0} \ar@/_.8cm/[ddrr]|(.36)\hole^(.65){\varphi}\ar[ur]^{r_0}&& G_2 && K_2 \ar@/^.8cm/[ddll]|(.36)\hole_(.65){\varphi'}\ar[dl]_{k_2}\ar[lu]_{l_2} \ar[dr]^{r_2}\\
L_0 \ar@/_.8cm/[ddrr]_(.2){\gamma_0}|(.31)\hole|(.81)\hole \ar[dr]^(.4){\hspace{-4pt}t_0\circ j_0}|(.61)\hole && Q_1 \ar[dl]|(.4)\hole_(.65){s_1}\ar[ur]|(.5)\hole^(.7){t_1}&&D_2 \ar[dr]|(.4)\hole^(.65){g_2} \ar[ul]|(.5)\hole_(.65){f_2}&&R_2\ar@/^.8cm/[ddll]^(.2){\gamma_1}|(.31)\hole|(.81)\hole\ar[dl]_(.35){h_2}\\&H'_1 &&P_4\ar[dr]_{\lambda_1} \ar[dl]^{\lambda_0}\ar[ur]^(.4){\zeta_1}\ar[ul]_(.4){\zeta_0}&&G_3\\
L_2 \ar@/^.8cm/[uurr]^(.2){\alpha_1} \ar[ur]_(.35){s_1\circ \alpha_1}|(.61)\hole&&Q_6 \ar[ul]|(.4)\hole_(.65){\xi_0}\ar[dr]|(.5)\hole^(.65){\xi'_0} &&Q_7\ar[ur]|(.4)\hole^(.65){\xi'_1} \ar[dl]|(.5)\hole_(.65){\xi_1} && R_0  \ar[ul]^(.35){g_2\circ \alpha_0}|(.61)\hole\ar@/_.8cm/[uull]_(.2){\alpha_0}\\&K_2 \ar[ur]_{\lambda_0\circ \phi'} \ar[dr]_{r_2} \ar[ul]^{l_2}\ar@/^.8cm/[uurr]_(.65){\phi'}&&H'_2&& K_0 \ar[ur]_{r_0} \ar[ul]^{\lambda_1\circ \phi} \ar[dl]^{l_0} \ar@/_.8cm/[uull]^(.65){\phi}\\&& R_2 \ar[ur]_{\hspace{-4pt}\xi_1\circ \gamma_1}\ar@/^1cm/[uurr]^(.25){\gamma_1}&& L_0 \ar[ul]^{\xi'_0\circ \gamma_0\hspace{-5pt}} \ar@/_1cm/[uull]_(.25){\gamma_0} |(.69)\hole }\]	

Our aim is to construct the dotted arrow in the following diagram.
		\[\xymatrix@C=15pt{L_1 \ar[d]_{f_0\circ i_0}&& K_1 \ar[d]_{q_0\circ v'}\ar[ll]_{l_1} \ar[r]^{r_1} & R_1 \ar@{.>}@/^.35cm/[drrr]_(.4){\epsilon_0}|(.285)\hole \ar[dr]|(.28)\hole_{s_1\circ j_1} && L_2 \ar@{.>}@/_.35cm/[dlll]^(.4){\epsilon_1} \ar[dl]|(.28)\hole^{s_1\circ \alpha_1}& K_2 \ar[d]^{\lambda_0\circ \phi'}\ar[l]_{l_2} \ar[rr]^{r_2} && R_2 \ar[d]^{\xi_1\circ \gamma_1}\\G_0 && \ar[ll]^{s_0} Q_0 \ar[rr]_{t_0}&& H'_1  && \ar[ll]^{\xi_0} Q_6 \ar[rr]_{\xi'_0}&& H'_2}\]

Let us start considering $j_1\colon R_1\to Q_1$ and $a_0\colon R_1\to D_2$. We have
\begin{align*}
	f_2\circ a_0&=h_1\\&=t_1\circ j_1
\end{align*}
and thus we get an arrow $\epsilon'_0\colon R_1\to P_4$ which makes the diagram below commutative.
			\[\xymatrix{R_1 \ar@{.>}[dr]^{\epsilon'_0} \ar@/^.3cm/[drr]^{j_1} \ar@/_.3cm/[ddr]_{a_0}\\ &P_4 \ar[r]^{\zeta_0} \ar[d]_{\zeta_1}& Q_1 \ar[d]^{t_1}\\ &D_2\ar[r]_{f_2} & G_2}\] 
We can then define $\epsilon_0\colon R_1\to Q_6$ to be $\lambda_0\circ \epsilon'_0$. For such an arrow we have a chain of identities:
\begin{align*}
	\xi_0\circ \epsilon_0&=\xi_0\circ \lambda_0\circ \epsilon'_0\\&=s_1\circ \zeta_0 \circ \epsilon'_0\\&=s_1\circ j_1
\end{align*}

Next, to define $\epsilon_1\colon L_2\to Q_0$ we take $e_1\colon L_2 \to D_0$ and $a_1\colon L_2\to D_1$. By definition we have $	g_0\circ e_1=f_1\circ a_1$, giving us the dotted arrow below
	\[\xymatrix{L_2 \ar@{.>}[dr]^{\epsilon'_1} \ar@/^.3cm/[drr]^{a_1} \ar@/_.3cm/[ddr]_{e_0}\\ &P_1 \ar[r]^{p_1} \ar[d]_{p_0}& D_1 \ar[d]^{f_1}\\ &D_0\ar[r]_{g_0} & G_1}\] 
Now, notice that 
\begin{align*}
	t_1\circ q_1\circ \epsilon'_1&=g_1\circ p_1\circ \epsilon'_1&=g_1\circ a_1\\&=m_2
\end{align*}
Hence $(\alpha_0, q_1\circ \epsilon'_1)$ is an independence pair for $S_{i_0, i_1}(\dder{D}_0)$ and $\dder{D}_2$. By hypothesis $S_{i_0, i_1}(\dder{D}_0)\updownarrow_! \dder{D}_2$ and thus $q_1\circ \epsilon'_1$ must coincide with $\alpha_1$. Now, let $\epsilon_1\colon L_2\to Q_0$ be $q_0\circ \epsilon'_1$. Computing we get
\begin{align*}
t_0\circ \epsilon_1&= t_0\circ q_0\circ \epsilon'_1\\&=s_1\circ q_1\circ \epsilon'_1\\&=s_1\circ \alpha_1
\end{align*}
Allowing us to conclude that  $S_{i_0,i_1}(\dder{D}_1)\updownarrow S_{\alpha_0, \alpha_1}(\dder{D}_2)$.
\qedhere 
			\end{enumerate}
\end{proof}


\begin{lemma}
	\todo{lemma salvavita}
\end{lemma}
\begin{proof}
	contenuto...
\end{proof}

\begin{corollary}
	contenuto...
\end{corollary}
\begin{proof}
	contenuto...
\end{proof}


\begin{corollary}
	contenuto...
\end{corollary}
\begin{proof}
	contenuto...
\end{proof}



\begin{corollary}
	contenuto...
\end{corollary}
\begin{proof}
	contenuto...
\end{proof}


\begin{corollary}[No need for useless shifts]
	contenuto...
\end{corollary}
\begin{proof}
	contenuto...
\end{proof}


\iffalse 
\begin{corollary} Given a tame  left-linear DPO-rewriting system  $(\X,\R)$ with $\X$ an $\mathcal{M}$-adhesive category and a decorated derivation $(\der{D}, \alpha, \omega)$ with $\der{D}=\{\dder{D}_i\}_{i=0}^2$. Then the following are true: 
	\begin{enumerate}
		\item suppose that $(a_1,a_2)$ and $(e_0,e_1)$ are independence pairs witnessing  $\dder{D}_1\updownarrow_! \dder{D}_2$ and $\dder{D}_0\updownarrow_! S_{a_1,a_2}(\dder{D}_2)$ respectively, if $\dder{D}_0\updownarrow_!\dder{D}_1$, then $S_{e_0,e_1}(\dder{D}_0)\updownarrow_!S_{a_2,a_2}(\dder{D}_1)$;
		\item 
	\end{enumerate}
\end{corollary}

\todo{ripulire le ipotesi: serve scambiabilitÃ  propria tra 1 e 2}
\todo{sistemare il fatto che qua utilizziamo derivazioni di 3 passi}
\begin{proof}
	\begin{enumerate}
		\item Let $(i_1,i_2)$ be the unique independence pair between $\dder{D}_0$ and $\dder{D}_1$.  By tameness and \Cref{lem:iig1} we know that $S_{e_0,e_1}(\dder{D}_0)\updownarrow S_{a_1,a_2}(\dder{D}_1)$. Let $(\alpha_1, \alpha_2)$ be the independence pair constructed in the proof of \Cref{lem:iig1}. Take another independence pair $(\beta_1, \beta_2)$,  by \Cref{rem:weak} we already know that $\beta_1=\alpha_1$. Let also $\der{E}$ be the derivation $S_{e_0, e_1}(S_{a_1, a_2}(\der{D}_2))\cdot S_{e_0, e_1}(\dder{D}_0) \cdot S_{a_1, a_2}(\der{D}_1)$. Let $\sigma\colon [0,2]\to [0,2]$ be the cycle $(0,1,2)$. By \Cref{lem:consperm} we know that $\sigma$ is a consistent permutation between $(\der{D}, \alpha, \omega)$ and $(\der{E}, \alpha, \omega)$. In particular, we have
		\begin{align*}
			\iota_{\der{E}, G_0}\circ f_0\circ  i_1 &=\xi_\sigma \circ 	\iota_{\der{D}, G_0}\circ f_0\circ  i_1 \\&= \xi_\sigma \circ 	\iota_{\der{D}, D_0}\circ  i_1\\ &= \xi_\sigma \circ \iota_{\der{D}, G_1} \circ g_0\circ  i_1 \\&=\xi_\sigma \circ \iota_{\der{D}, G_1}\circ m_1\\ &=  \iota_{\der{E}, G'_2}\circ y_1\circ b_1\\&= \iota_{\der{E}, G'_2}\circ z'_1\circ \beta_2\\&= \iota_{\der{E}, Q_5}\circ \beta_2 
		\end{align*}
		Using	\Cref{rem:pbsalva} we can deduce the existence of a unique arrow $\beta'_2\colon L_1\to P_3$ fitting in the diagram below
		\[\xymatrix@C=30pt{L_1  \ar@/^.3cm/[drr]^{\beta_2} \ar@/_.3cm/[ddr]_{i_1}\ar@{.>}[dr]^{\beta'_2}\\& P_3 \ar[r]^{n_1}  \ar[d]_{u_0}& Q_5 \ar[d]^{\iota_{\dder{E}, Q_5}}\\
		&D_0 \ar[r]_{\iota_{\dder{E}, G_0}}& \tpro{E}}\]
		If we further compute, we get
		\begin{align*}
			y_1\circ u_1\circ \beta'_2&=z'_1\circ n_1\circ \beta'_2=\\&= z'_1\circ \beta_2 \\&=y_1\circ b_1
		\end{align*}
		Thus $(u_1\circ \beta'_2, b_2)$ is an independence pair between $S_{a_1, a_2}(\der{D}_2)$ and $S_{a_1, a_2}(\der{D}_1)$ therefore, by hypothesis $u_1\circ \beta'_2=b_1$. But this implies that $\beta'_2$ and $\alpha'_2$ are equal, giving us the thesis.
		
\todo{ripulire le ipotesi: serve scambiabilitÃ  propria tra 1 e 2}
\todo{sistemare il fatto che qua utilizziamo derivazioni di 3 passi}
		
		\item \qedhere 
	\end{enumerate}
\end{proof}
 
 
 \todo{mettere esempio del perchÃ© fallisce nell'altra direziome}
 \todo{anche una breve intro}

\begin{lemma}\label{lem:iig2}Let $(\X,\R)$ be a left-linear DPO-rewriting system with $\X$ an $\mathcal{M}$-adhesive category. For every derivation $\der{D}=\{\dder{D}_i\}_{i=0}^2$, if $(i_0,i_1)$ is a good independence pair between $\dder{D}_0$ and $\dder{D}_1$, $(a_1,a_2)$ one between $\dder{D}_1$ and $\dder{D}_2$ and $\dder{D}_0\updownarrow S_{a_1,a_2}(\dder{D}_2)$ with good independence pair $(e_0,e_1)$, then $S_{e_0,e_1}(\dder{D}_0)$ and $S_{a_1,a_2}(\dder{D}_1)$ are weakly sequentially independent.
\end{lemma}
\begin{proof} As in the proof of \Cref{lem:iig1}, \Cref{def:filler,def:switch} yield to us some diagrams.  First of all, let $(v,v')$ be the filler between $\dder{D}_0$ and $\dder{D}_1$ associated to $(i_1, i_2)$, then we have
	\[\xymatrix{&&R_0 \ar@/_1cm/[ddrr]_(.35){i_0}|(.7)\hole \ar[dr]^{h_0}&& L_1\ar@/^1cm/[ddll]^(.35){i_1}  \ar[dl]_{m_1}\\&K_0\ar[dr]^{k_0}\ar[dl]_{l_0} \ar@/_.8cm/[ddrr]|(.36)\hole^(.65){v}\ar[ur]^{r_0}&& G_1 && K_1 \ar@/^.8cm/[ddll]|(.36)\hole_(.65){v'}\ar[dl]_{k_1}\ar[lu]_{l_1} \ar[dr]^{r_1}\\L_0 \ar@/_.8cm/[ddrr]_(.2){j_0}|(.31)\hole|(.81)\hole \ar[dr]^(.4){m_0}|(.61)\hole && D_0 \ar[dl]|(.4)\hole_(.65){f_0}\ar[ur]|(.5)\hole^(.7){g_0}&&D_1 \ar[dr]|(.4)\hole^(.65){g_1} \ar[ul]|(.5)\hole_(.65){f_1}&&R_1\ar@/^.8cm/[ddll]^(.2){j_1}|(.31)\hole|(.81)\hole\ar[dl]_{h_1}\\&G_0 &&P_1\ar[dr]_{q_1} \ar[dl]^{q_0}\ar[ur]^(.4){p_1}\ar[ul]_(.4){p_0}&&G_2\\L_1 \ar@/^.8cm/[uurr]^(.2){i_1} \ar[ur]_(.35){f_0\circ i_1}|(.61)\hole&&Q_0 \ar[ul]|(.4)\hole_(.65){s_0}\ar[dr]|(.5)\hole^(.65){t_0} &&Q_1\ar[ur]|(.4)\hole^(.65){t_1} \ar[dl]|(.5)\hole_(.65){s_1} && R_0  \ar[ul]^(.35){g_1\circ i_0}|(.61)\hole\ar@/_.8cm/[uull]_(.2){i_0}\\&K_1 \ar[ur]_{q_0\circ v'} \ar[dr]_{r_1} \ar[ul]^{l_1}\ar@/^.8cm/[uurr]_(.65){v'}&&G'_1&& K_0 \ar[ur]_{r_0} \ar[ul]^{q_1\circ v} \ar[dl]^{l_0} \ar@/_.8cm/[uull]^(.65){v}\\&& R_1 \ar[ur]_{\hspace{-5pt}s_1\circ j_1}\ar@/^1cm/[uurr]^(.25){j_1}&& L_0 \ar[ul]^{t_0\circ j_0\hspace{-5pt}} \ar@/_1cm/[uull]_(.25){j_0} |(.69)\hole }\]
	
	Secondly, the filler $(u,u')$ induced by $(a_1, a_2)$ between $\dder{D}_1$ and $\dder{D}_2$ yields:
	\[
	\xymatrix{&&R_1 \ar@/_1cm/[ddrr]_(.35){a_1}|(.7)\hole \ar[dr]^{h_1}&& L_2\ar@/^1cm/[ddll]^(.35){a_2}  \ar[dl]_{m_2}\\&K_1\ar[dr]^{k_1}\ar[dl]_{l_1} \ar@/_.8cm/[ddrr]|(.36)\hole^(.65){u}\ar[ur]^{r_1}&& G_2 && K_2 \ar@/^.8cm/[ddll]|(.36)\hole_(.65){u'}\ar[dl]_{k_2}\ar[lu]_{l_2} \ar[dr]^{r_2}\\L_1 \ar@/_.8cm/[ddrr]_(.2){b_1}|(.31)\hole|(.81)\hole \ar[dr]^(.4){m_1}|(.61)\hole && D_1 \ar[dl]|(.4)\hole_(.65){f_1}\ar[ur]|(.5)\hole^(.7){g_1}&&D_2 \ar[dr]|(.4)\hole^(.65){g_2} \ar[ul]|(.5)\hole_(.65){f_2}&&R_2\ar@/^.8cm/[ddll]^(.2){b_2}|(.31)\hole|(.81)\hole\ar[dl]_{h_2}\\&G_1 &&P_2\ar[dr]_{d_2} \ar[dl]^{d_1}\ar[ur]^(.4){c_2}\ar[ul]_(.4){c_1}&&G_2\\L_2 \ar@/^.8cm/[uurr]^(.2){a_2} \ar[ur]_(.35){f_1\circ a_2}|(.61)\hole&&Q_2 \ar[ul]|(.4)\hole_(.65){x_1}\ar[dr]|(.5)\hole^(.65){y_1} &&Q_3\ar[ur]|(.4)\hole^(.65){y_2} \ar[dl]|(.5)\hole_(.65){x_2} && R_1  \ar[ul]^(.35){g_2\circ a_1}|(.61)\hole\ar@/_.8cm/[uull]_(.2){a_1}\\&K_2 \ar[ur]_{d_1\circ u'} \ar[dr]_{r_2} \ar[ul]^{l_2}\ar@/^.8cm/[uurr]_(.65){u'}&&G'_2&& K_1 \ar[ur]_{r_1} \ar[ul]^{d_2\circ u} \ar[dl]^{l_1} \ar@/_.8cm/[uull]^(.65){u}\\&& R_2 \ar[ur]_{\hspace{-5pt}x_2\circ b_2}\ar@/^1cm/[uurr]^(.25){b_2}&& L_1 \ar[ul]^{y_1\circ b_1\hspace{-5pt}} \ar@/_1cm/[uull]_(.25){b_1} |(.69)\hole }\]
	
	Finally, the filler $(w,w')$  between $\dder{D}_0$ and $S_{u,u'}(\dder{D}_2)$ given by $(e_0, e_1)$ provides us with:
	\[\xymatrix{&&R_0 \ar@/_1cm/[ddrr]_(.35){e_0}|(.7)\hole \ar[dr]^{h_0}&& L_2\ar@/^1cm/[ddll]^(.35){e_1}  \ar[dl]_{f_1\circ a_2}\\&K_0\ar[dr]^{k_0}\ar[dl]_{l_0} \ar@/_.8cm/[ddrr]|(.36)\hole^(.65){w}\ar[ur]^{r_0}&& G_1 && K_2 \ar@/^.8cm/[ddll]|(.36)\hole_(.65){w'}\ar[dl]_{d_1\circ u'\hspace{-5pt}}\ar[lu]_{l_2} \ar[dr]^{r_2}\\L_0 \ar@/_.8cm/[ddrr]_(.2){o_0}|(.31)\hole|(.81)\hole \ar[dr]^(.4){m_0}|(.61)\hole && D_0 \ar[dl]|(.4)\hole_(.65){f_0}\ar[ur]|(.5)\hole^(.7){g_0}&&Q_2 \ar[dr]|(.4)\hole^(.65){y_1} \ar[ul]|(.5)\hole_(.65){x_1}&&R_2\ar@/^.8cm/[ddll]^(.2){o_1}|(.31)\hole|(.81)\hole\ar[dl]_(.35){x_2\circ b_2}\\&G_0 &&P_3\ar[dr]_{n_1} \ar[dl]^{n_0}\ar[ur]^(.4){u_1}\ar[ul]_(.4){u_0}&&G'_2\\L_2 \ar@/^.8cm/[uurr]^(.2){e_1} \ar[ur]_(.35){f_0\circ e_1}|(.61)\hole&&Q_4 \ar[ul]|(.4)\hole_(.65){z_0}\ar[dr]|(.5)\hole^(.65){z'_0} &&Q_5\ar[ur]|(.4)\hole^(.65){z'_1} \ar[dl]|(.5)\hole_(.65){z_1} && R_0  \ar[ul]^(.35){y_1\circ e_0}|(.61)\hole\ar@/_.8cm/[uull]_(.2){e_0}\\&K_2 \ar[ur]_{n_0\circ w'} \ar[dr]_{r_2} \ar[ul]^{l_2}\ar@/^.8cm/[uurr]_(.65){w'}&&G'_1&& K_0 \ar[ur]_{r_0} \ar[ul]^{n_1\circ w} \ar[dl]^{l_0} \ar@/_.8cm/[uull]^(.65){w}\\&& R_2 \ar[ur]_{\hspace{-4pt}z_1\circ o_1}\ar@/^1cm/[uurr]^(.25){o_1}&& L_0 \ar[ul]^{z'_0\circ o_0\hspace{-5pt}} \ar@/_1cm/[uull]_(.25){o_0} |(.69)\hole }\]
	
	We have to construct the two dotted arrows in the diagram below.
	\[\xymatrix@C=15pt{L_0 \ar[d]_{z'_0\circ o_0}&& K_0 \ar[d]_{n_1\circ w}\ar[ll]_{l_0} \ar[r]^{r_0} & R_0 \ar@{.>}@/^.35cm/[drrr]_(.4){\alpha_1}|(.285)\hole \ar[dr]|(.28)\hole_{y_1\circ e_0} && L_1 \ar@{.>}@/_.35cm/[dlll]^(.4){\alpha_2} \ar[dl]|(.28)\hole^{y_1\circ b_1}& K_1 \ar[d]^{d_2\circ u}\ar[l]_{l_1} \ar[rr]^{r_1} && R_1 \ar[d]^{g_2\circ a_1}\\G'_1 && \ar[ll]^{z_1} Q_5 \ar[rr]_{z'_1}&& G'_2  && \ar[ll]^{x_2} Q_3 \ar[rr]_{y_2}&& G_2}\]
	
	Consider the arrows $i_0\colon R_0\to D_1$ and $e_0\colon R_0\to Q_2$. An easy computation shows that
	\begin{align*}
		f_1\circ i_0&= h_0\\&=x_1\circ e_0
	\end{align*}
	entailing the existence of  the dotted $\alpha'_1\colon R_0\to P_2$ in the diagram
	\[\xymatrix{R_0 \ar@{.>}[dr]^{\alpha'_1} \ar@/^.3cm/[drr]^{i_0} \ar@/_.3cm/[ddr]_{e_0}\\ &P_2 \ar[r]^{c_2} \ar[d]_{d_1}& D_1 \ar[d]^{f_1}\\ &Q_2\ar[r]_{x_1} & G_1}\]
	If we define $\alpha_1\colon R_0\to Q_3$ as $d_2\circ \alpha'_1$, then we easily get that 
	\begin{align*}
		x_2\circ \alpha_1&=x_2\circ d_2\circ \alpha'_1\\&= y_1\circ d_1\circ \alpha'_1\\&=y_1\circ e_0
	\end{align*}
	
	For $\alpha_2$, we proceed similarly. First consider  $i_1\colon L_1\to D_0$ and $b_1\colon L_1 \to Q_2$ and notice that
	\begin{align*}
		g_0\circ i_1&= m_1 \\&= x_1 \circ b_1
	\end{align*}
	implying the existence of $\alpha'_2\colon L_1\to P_3$ fitting in the diagram below.
	\[\xymatrix{L_1 \ar@{.>}[dr]^{\alpha'_2} \ar@/^.3cm/[drr]^{i_1} \ar@/_.3cm/[ddr]_{b_1}\\ &P_3 \ar[r]^{u_0} \ar[d]_{u_1}& D_0 \ar[d]^{g_0}\\ &Q_2\ar[r]_{x_1} & G_1}\] 
	Let $\alpha_2\colon L_1\to Q_5$ be $n_1\circ \alpha'_2$, then
	\begin{align*}
		z'_1 \circ \alpha_2 & = z'_1 \circ n_1\circ \alpha'_2\\&=y_1\circ u_1\circ \alpha'_2\\&=y_1\circ b_1
	\end{align*}
	The thesis now follows.  
\end{proof}
\fi 


\subsection{Concatenable traces}
\begin{lemma}
	\todo{abstract equivalence and switch }
\end{lemma}
\begin{proof}
	contenuto...
\end{proof}
\begin{definition}
	\todo{tracce}
\end{definition}

Before moving forward, we will prove some other useful properties of the switch equivalence relation.

\begin{lemma}
	\todo{lemma 19}
\end{lemma}
\begin{proof}
	contenuto...
\end{proof}


\begin{theorem}
	\todo{preordine}
\end{theorem}
\begin{proof}
	contenuto...
\end{proof}


\section{ Domains for DPO-rewriting}

\subsection{weak domains}

\subsection{From adhesive grammars to weak domains}


\section{Conclusions and further work}
\todo{VERY NICE CONCLUSIONS}

\bibliographystyle{plain}
\bibliography{bibliog.bib}


\appendix


\section{A note on fillers and sequential independence}\label{app:fill}
 In \Cref{prop:equi} we proved that, in the linear case, the existence of an indpendence pair between two derivation is equivalent to that of a filler between them. This result can be further refined: in a\cite{baldan2011adhesivity} a class  $\mathbb{B}$ of (quasi)adhesive category is defined for which the local Church-Rosser Theorem holds even for left-linear DPO-rewriting system. In our language, and given \Cref{prop:fil} and \Cref{rem:locCR}, this amount to prove that, for elements of $\mathbb{B}$, every independence pair induces a filler. 

\begin{definition}Let $\X$ be a category, we say that $\X$ satisfies
	\begin{itemize}
		\item the \emph{mixed decomposition} property if for every diagram
		\[\xymatrix{X \ar[d]_{a} \ar[r]^{f}& \ar[r]^{g} Y \ar[d]^{b}& Z \ar[d]^{c}\\ A \ar[r]_{h}& B \ar[r]_{k}& C}\]
		whose outer boundary is a pushout and in which $k$ is a monomorphisms, 
		\item the \emph{pushout decomposition} property
	\end{itemize}
\end{definition}

\begin{lemma}
	contenuto...
\end{lemma}
\begin{proof}
	contenuto...\qedhere 
\end{proof}

\begin{corollary}
	contenuto...
\end{corollary}

The following result shows that the mixed and pushout decomposition properties guarantee that every independence pair gives rise to a filler.

\begin{theorem}
	\todo{filler e classe B+}
\end{theorem}
\begin{proof}\qedhere 
\end{proof}

Our next step is to identify sufficient conditions for a category $\X$ to satisfy the mixed and pushout decomposition properties.

\begin{definition}
	\todo{classe B e class B+}
\end{definition}

\begin{example}
\todo{esempi}
\end{example}

\begin{example}
	\todo{esempi}
\end{example}

\begin{proposition}
	\todo{da B a B+}
\end{proposition}
\begin{proof}
	contenuto... \qedhere 
\end{proof}
\begin{lemma}\todo{due proprietÃ  classe B}
\end{lemma}
\begin{proof}
	\qedhere 
\end{proof}

\begin{corollary}
	\todo{due proprietÃ  classe B+}
\end{corollary}

\begin{corollary}
	\todo{filler e classe B+}
\end{corollary}


\section{Rewriting systems on $\Set$.}\label{app:set}

\section{On permutations}\label{app:perm}
\todo{inserire risutati sulle permutazione che abbiamo usato}


\end{document}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
